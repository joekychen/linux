<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aha152x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>aha152x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* aha152x.c -- Adaptec AHA-152x driver</span>
<span class="cm"> * Author: Jürgen E. Fischer, fischer@norbit.de</span>
<span class="cm"> * Copyright 1993-2004 Jürgen E. Fischer</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: aha152x.c,v 2.7 2004/01/24 11:42:59 fischer Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * $Log: aha152x.c,v $</span>
<span class="cm"> * Revision 2.7  2004/01/24 11:42:59  fischer</span>
<span class="cm"> * - gather code that is not used by PCMCIA at the end</span>
<span class="cm"> * - move request_region for !PCMCIA case to detection</span>
<span class="cm"> * - migration to new scsi host api (remove legacy code)</span>
<span class="cm"> * - free host scribble before scsi_done</span>
<span class="cm"> * - fix error handling</span>
<span class="cm"> * - one isapnp device added to id_table</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.6  2003/10/30 20:52:47  fischer</span>
<span class="cm"> * - interfaces changes for kernel 2.6</span>
<span class="cm"> * - aha152x_probe_one introduced for pcmcia stub</span>
<span class="cm"> * - fixed pnpdev handling</span>
<span class="cm"> * - instead of allocation a new one, reuse command for request sense after check condition and reset</span>
<span class="cm"> * - fixes race in is_complete</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.5  2002/04/14 11:24:53  fischer</span>
<span class="cm"> * - isapnp support</span>
<span class="cm"> * - abort fixed</span>
<span class="cm"> * - 2.5 support</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.4  2000/12/16 12:53:56  fischer</span>
<span class="cm"> * - allow REQUEST SENSE to be queued</span>
<span class="cm"> * - handle shared PCI interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.3  2000/11/04 16:40:26  fischer</span>
<span class="cm"> * - handle data overruns</span>
<span class="cm"> * - extend timeout for data phases</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.2  2000/08/08 19:54:53  fischer</span>
<span class="cm"> * - minor changes</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.1  2000/05/17 16:23:17  fischer</span>
<span class="cm"> * - signature update</span>
<span class="cm"> * - fix for data out w/o scatter gather</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 2.0  1999/12/25 15:07:32  fischer</span>
<span class="cm"> * - interrupt routine completly reworked</span>
<span class="cm"> * - basic support for new eh code</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.21  1999/11/10 23:46:36  fischer</span>
<span class="cm"> * - default to synchronous operation</span>
<span class="cm"> * - synchronous negotiation fixed</span>
<span class="cm"> * - added timeout to loops</span>
<span class="cm"> * - debugging output can be controlled through procfs</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.20  1999/11/07 18:37:31  fischer</span>
<span class="cm"> * - synchronous operation works</span>
<span class="cm"> * - resid support for sg driver</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.19  1999/11/02 22:39:59  fischer</span>
<span class="cm"> * - moved leading comments to README.aha152x</span>
<span class="cm"> * - new additional module parameters</span>
<span class="cm"> * - updates for 2.3</span>
<span class="cm"> * - support for the Tripace TC1550 controller</span>
<span class="cm"> * - interrupt handling changed</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.18  1996/09/07 20:10:40  fischer</span>
<span class="cm"> * - fixed can_queue handling (multiple outstanding commands working again)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.17  1996/08/17 16:05:14  fischer</span>
<span class="cm"> * - biosparam improved</span>
<span class="cm"> * - interrupt verification</span>
<span class="cm"> * - updated documentation</span>
<span class="cm"> * - cleanups</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.16  1996/06/09 00:04:56  root</span>
<span class="cm"> * - added configuration symbols for insmod (aha152x/aha152x1)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.15  1996/04/30 14:52:06  fischer</span>
<span class="cm"> * - proc info fixed</span>
<span class="cm"> * - support for extended translation for &gt;1GB disks</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.14  1996/01/17  15:11:20  fischer</span>
<span class="cm"> * - fixed lockup in MESSAGE IN phase after reconnection</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.13  1996/01/09  02:15:53  fischer</span>
<span class="cm"> * - some cleanups</span>
<span class="cm"> * - moved request_irq behind controller initialization</span>
<span class="cm"> *   (to avoid spurious interrupts)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.12  1995/12/16  12:26:07  fischer</span>
<span class="cm"> * - barrier()s added</span>
<span class="cm"> * - configurable RESET delay added</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.11  1995/12/06  21:18:35  fischer</span>
<span class="cm"> * - some minor updates</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.10  1995/07/22  19:18:45  fischer</span>
<span class="cm"> * - support for 2 controllers</span>
<span class="cm"> * - started synchronous data transfers (not working yet)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.9  1995/03/18  09:20:24  root</span>
<span class="cm"> * - patches for PCMCIA and modules</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.8  1995/01/21  22:07:19  root</span>
<span class="cm"> * - snarf_region =&gt; request_region</span>
<span class="cm"> * - aha152x_intr interface change</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.7  1995/01/02  23:19:36  root</span>
<span class="cm"> * - updated COMMAND_SIZE to cmd_len</span>
<span class="cm"> * - changed sti() to restore_flags()</span>
<span class="cm"> * - fixed some #ifdef which generated warnings</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.6  1994/11/24  20:35:27  root</span>
<span class="cm"> * - problem with odd number of bytes in fifo fixed</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.5  1994/10/30  14:39:56  root</span>
<span class="cm"> * - abort code fixed</span>
<span class="cm"> * - debugging improved</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.4  1994/09/12  11:33:01  root</span>
<span class="cm"> * - irqaction to request_irq</span>
<span class="cm"> * - abortion updated</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.3  1994/08/04  13:53:05  root</span>
<span class="cm"> * - updates for mid-level-driver changes</span>
<span class="cm"> * - accept unexpected BUSFREE phase as error condition</span>
<span class="cm"> * - parity check now configurable</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.2  1994/07/03  12:56:36  root</span>
<span class="cm"> * - cleaned up debugging code</span>
<span class="cm"> * - more tweaking on reset delays</span>
<span class="cm"> * - updated abort/reset code (pretty untested...)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1  1994/05/28  21:18:49  root</span>
<span class="cm"> * - update for mid-level interface change (abort-reset)</span>
<span class="cm"> * - delays after resets adjusted for some slow devices</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.0  1994/03/25  12:52:00  root</span>
<span class="cm"> * - Fixed &quot;more data than expected&quot; problem</span>
<span class="cm"> * - added new BIOS signatures</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.102  1994/01/31  20:44:12  root</span>
<span class="cm"> * - minor changes in insw/outsw handling</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.101  1993/12/13  01:16:27  root</span>
<span class="cm"> * - fixed STATUS phase (non-GOOD stati were dropped sometimes;</span>
<span class="cm"> *   fixes problems with CD-ROM sector size detection &amp; media change)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.100  1993/12/10  16:58:47  root</span>
<span class="cm"> * - fix for unsuccessful selections in case of non-continuous id assignments</span>
<span class="cm"> *   on the scsi bus.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.99  1993/10/24  16:19:59  root</span>
<span class="cm"> * - fixed DATA IN (rare read errors gone)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.98  1993/10/17  12:54:44  root</span>
<span class="cm"> * - fixed some recent fixes (shame on me)</span>
<span class="cm"> * - moved initialization of scratch area to aha152x_queue</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.97  1993/10/09  18:53:53  root</span>
<span class="cm"> * - DATA IN fixed. Rarely left data in the fifo.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.96  1993/10/03  00:53:59  root</span>
<span class="cm"> * - minor changes on DATA IN</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.95  1993/09/24  10:36:01  root</span>
<span class="cm"> * - change handling of MSGI after reselection</span>
<span class="cm"> * - fixed sti/cli</span>
<span class="cm"> * - minor changes</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.94  1993/09/18  14:08:22  root</span>
<span class="cm"> * - fixed bug in multiple outstanding command code</span>
<span class="cm"> * - changed detection</span>
<span class="cm"> * - support for kernel command line configuration</span>
<span class="cm"> * - reset corrected</span>
<span class="cm"> * - changed message handling</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.93  1993/09/15  20:41:19  root</span>
<span class="cm"> * - fixed bugs with multiple outstanding commands</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.92  1993/09/13  02:46:33  root</span>
<span class="cm"> * - multiple outstanding commands work (no problems with IBM drive)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.91  1993/09/12  20:51:46  root</span>
<span class="cm"> * added multiple outstanding commands</span>
<span class="cm"> * (some problem with this $%&amp;? IBM device remain)</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.9  1993/09/12  11:11:22  root</span>
<span class="cm"> * - corrected auto-configuration</span>
<span class="cm"> * - changed the auto-configuration (added some &#39;#define&#39;s)</span>
<span class="cm"> * - added support for dis-/reconnection</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.8  1993/09/06  23:09:39  root</span>
<span class="cm"> * - added support for the drive activity light</span>
<span class="cm"> * - minor changes</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.7  1993/09/05  14:30:15  root</span>
<span class="cm"> * - improved phase detection</span>
<span class="cm"> * - now using the new snarf_region code of 0.99pl13</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.6  1993/09/02  11:01:38  root</span>
<span class="cm"> * first public release; added some signatures and biosparam()</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.5  1993/08/30  10:23:30  root</span>
<span class="cm"> * fixed timing problems with my IBM drive</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.4  1993/08/29  14:06:52  root</span>
<span class="cm"> * fixed some problems with timeouts due incomplete commands</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.3  1993/08/28  15:55:03  root</span>
<span class="cm"> * writing data works too.  mounted and worked on a dos partition</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.2  1993/08/27  22:42:07  root</span>
<span class="cm"> * reading data works.  Mounted a msdos partition.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.1  1993/08/25  13:38:30  root</span>
<span class="cm"> * first &quot;damn thing doesn&#39;t work&quot; version</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 0.0  1993/08/14  19:54:25  root</span>
<span class="cm"> * empty function bodies; detect() works.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************************</span>
<span class="cm"> </span>
<span class="cm"> see Documentation/scsi/aha152x.txt for configuration details</span>

<span class="cm"> **************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_spi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &quot;aha152x.h&quot;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">aha152x_host_list</span><span class="p">);</span>


<span class="cm">/* DEFINES */</span>

<span class="cm">/* For PCMCIA cards, always use AUTOCONF */</span>
<span class="cp">#if defined(PCMCIA) || defined(MODULE)</span>
<span class="cp">#if !defined(AUTOCONF)</span>
<span class="cp">#define AUTOCONF</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(AUTOCONF) &amp;&amp; !defined(SETUP0)</span>
<span class="cp">#error define AUTOCONF or SETUP0</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
<span class="cp">#define DEBUG_DEFAULT debug_eh</span>

<span class="cp">#define DPRINTK(when,msgs...) \</span>
<span class="cp">	do { if(HOSTDATA(shpnt)-&gt;debug &amp; (when)) printk(msgs); } while(0)</span>

<span class="cp">#define DO_LOCK(flags)	\</span>
<span class="cp">	do { \</span>
<span class="cp">		if(spin_is_locked(&amp;QLOCK)) { \</span>
<span class="cp">			DPRINTK(debug_intr, DEBUG_LEAD &quot;(%s:%d) already locked at %s:%d\n&quot;, CMDINFO(CURRENT_SC), __func__, __LINE__, QLOCKER, QLOCKERL); \</span>
<span class="cp">		} \</span>
<span class="cp">		DPRINTK(debug_locking, DEBUG_LEAD &quot;(%s:%d) locking\n&quot;, CMDINFO(CURRENT_SC), __func__, __LINE__); \</span>
<span class="cp">		spin_lock_irqsave(&amp;QLOCK,flags); \</span>
<span class="cp">		DPRINTK(debug_locking, DEBUG_LEAD &quot;(%s:%d) locked\n&quot;, CMDINFO(CURRENT_SC), __func__, __LINE__); \</span>
<span class="cp">		QLOCKER=__func__; \</span>
<span class="cp">		QLOCKERL=__LINE__; \</span>
<span class="cp">	} while(0)</span>

<span class="cp">#define DO_UNLOCK(flags)	\</span>
<span class="cp">	do { \</span>
<span class="cp">		DPRINTK(debug_locking, DEBUG_LEAD &quot;(%s:%d) unlocking (locked at %s:%d)\n&quot;, CMDINFO(CURRENT_SC), __func__, __LINE__, QLOCKER, QLOCKERL); \</span>
<span class="cp">		spin_unlock_irqrestore(&amp;QLOCK,flags); \</span>
<span class="cp">		DPRINTK(debug_locking, DEBUG_LEAD &quot;(%s:%d) unlocked\n&quot;, CMDINFO(CURRENT_SC), __func__, __LINE__); \</span>
<span class="cp">		QLOCKER=&quot;(not locked)&quot;; \</span>
<span class="cp">		QLOCKERL=0; \</span>
<span class="cp">	} while(0)</span>

<span class="cp">#else</span>
<span class="cp">#define DPRINTK(when,msgs...)</span>
<span class="cp">#define	DO_LOCK(flags)		spin_lock_irqsave(&amp;QLOCK,flags)</span>
<span class="cp">#define	DO_UNLOCK(flags)	spin_unlock_irqrestore(&amp;QLOCK,flags)</span>
<span class="cp">#endif</span>

<span class="cp">#define LEAD		&quot;(scsi%d:%d:%d) &quot;</span>
<span class="cp">#define WARN_LEAD	KERN_WARNING	LEAD</span>
<span class="cp">#define INFO_LEAD	KERN_INFO	LEAD</span>
<span class="cp">#define NOTE_LEAD	KERN_NOTICE	LEAD</span>
<span class="cp">#define ERR_LEAD	KERN_ERR	LEAD</span>
<span class="cp">#define DEBUG_LEAD	KERN_DEBUG	LEAD</span>
<span class="cp">#define CMDINFO(cmd) \</span>
<span class="cp">			(cmd) ? ((cmd)-&gt;device-&gt;host-&gt;host_no) : -1, \</span>
<span class="cp">                        (cmd) ? ((cmd)-&gt;device-&gt;id &amp; 0x0f) : -1, \</span>
<span class="cp">			(cmd) ? ((cmd)-&gt;device-&gt;lun &amp; 0x07) : -1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">CMD_INC_RESID</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">inc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DELAY_DEFAULT 1000</span>

<span class="cp">#if defined(PCMCIA)</span>
<span class="cp">#define IRQ_MIN 0</span>
<span class="cp">#define IRQ_MAX 16</span>
<span class="cp">#else</span>
<span class="cp">#define IRQ_MIN 9</span>
<span class="cp">#if defined(__PPC)</span>
<span class="cp">#define IRQ_MAX (nr_irqs-1)</span>
<span class="cp">#else</span>
<span class="cp">#define IRQ_MAX 12</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">not_issued</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>	<span class="cm">/* command not yet issued */</span>
	<span class="n">selecting</span>	<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> 	<span class="cm">/* target is beeing selected */</span>
	<span class="n">identified</span>	<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>	<span class="cm">/* IDENTIFY was sent */</span>
	<span class="n">disconnected</span>	<span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>	<span class="cm">/* target disconnected */</span>
	<span class="n">completed</span>	<span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>	<span class="cm">/* target sent COMMAND COMPLETE */</span> 
	<span class="n">aborted</span>		<span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>	<span class="cm">/* ABORT was sent */</span>
	<span class="n">resetted</span>	<span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>	<span class="cm">/* BUS DEVICE RESET was sent */</span>
	<span class="n">spiordy</span>		<span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>	<span class="cm">/* waiting for SPIORDY to raise */</span>
	<span class="n">syncneg</span>		<span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>	<span class="cm">/* synchronous negotiation in progress */</span>
	<span class="n">aborting</span>	<span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>	<span class="cm">/* ABORT is pending */</span>
	<span class="n">resetting</span>	<span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>	<span class="cm">/* BUS DEVICE RESET is pending */</span>
	<span class="n">check_condition</span> <span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>	<span class="cm">/* requesting sense after CHECK CONDITION */</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jürgen Fischer&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">AHA152X_REVID</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#if !defined(PCMCIA)</span>
<span class="cp">#if defined(MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s">&quot;base io address of controller&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span><span class="s">&quot;interrupt for controller&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">scsiid</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">scsiid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scsiid</span><span class="p">,</span><span class="s">&quot;scsi id of controller&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reconnect</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">reconnect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reconnect</span><span class="p">,</span><span class="s">&quot;allow targets to disconnect&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parity</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">parity</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">parity</span><span class="p">,</span><span class="s">&quot;use scsi parity&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sync</span><span class="p">,</span><span class="s">&quot;use synchronous transfers&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">DELAY_DEFAULT</span><span class="p">,</span> <span class="n">DELAY_DEFAULT</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span><span class="s">&quot;scsi reset delay&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">exttrans</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">exttrans</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">exttrans</span><span class="p">,</span><span class="s">&quot;use extended translation&quot;</span><span class="p">);</span>

<span class="cp">#if !defined(AHA152X_DEBUG)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aha152x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DELAY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">aha152x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aha152x</span><span class="p">,</span> <span class="s">&quot;parameters for first controller&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aha152x1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DELAY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">aha152x1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aha152x1</span><span class="p">,</span> <span class="s">&quot;parameters for second controller&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEBUG_DEFAULT</span><span class="p">,</span> <span class="n">DEBUG_DEFAULT</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;flags for driver debugging&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aha152x</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DELAY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEBUG_DEFAULT</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">aha152x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aha152x</span><span class="p">,</span> <span class="s">&quot;parameters for first controller&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aha152x1</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DELAY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEBUG_DEFAULT</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">aha152x1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aha152x1</span><span class="p">,</span> <span class="s">&quot;parameters for second controller&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !defined(AHA152X_DEBUG) */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="cp">#ifdef __ISAPNP__</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1502</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1505</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1510</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1515</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1520</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x2015</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1522</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x2215</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1530</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x3015</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x1532</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x3215</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x6360</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_DEVICE_SINGLE_END</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* ISAPNP */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* !PCMCIA */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">aha152x_driver_template</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * internal states of the host</span>
<span class="cm"> *</span>
<span class="cm"> */</span> 
<span class="k">enum</span> <span class="n">aha152x_state</span> <span class="p">{</span>
	<span class="n">idle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">unknown</span><span class="p">,</span>
	<span class="n">seldo</span><span class="p">,</span>
	<span class="n">seldi</span><span class="p">,</span>
	<span class="n">selto</span><span class="p">,</span>
	<span class="n">busfree</span><span class="p">,</span>
	<span class="n">msgo</span><span class="p">,</span>
	<span class="n">cmd</span><span class="p">,</span>
	<span class="n">msgi</span><span class="p">,</span>
	<span class="n">status</span><span class="p">,</span>
	<span class="n">datai</span><span class="p">,</span>
	<span class="n">datao</span><span class="p">,</span>
	<span class="n">parerr</span><span class="p">,</span>
	<span class="n">rsti</span><span class="p">,</span>
	<span class="n">maxstate</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * current state information of the host</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aha152x_hostdata</span> <span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">issue_SC</span><span class="p">;</span>
		<span class="cm">/* pending commands to issue */</span>

	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">current_SC</span><span class="p">;</span>
		<span class="cm">/* current command on the bus */</span>

	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">disconnected_SC</span><span class="p">;</span>
		<span class="cm">/* commands that disconnected */</span>

	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">done_SC</span><span class="p">;</span>
		<span class="cm">/* command that was completed */</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
		<span class="cm">/* host lock */</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">locker</span><span class="p">;</span>
		<span class="cm">/* which function has the lock */</span>
	<span class="kt">int</span> <span class="n">lockerl</span><span class="p">;</span>	<span class="cm">/* where did it get it */</span>

	<span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>	<span class="cm">/* current debugging setting */</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="kt">int</span>           <span class="n">total_commands</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">disconnections</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">busfree_without_any_action</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">busfree_without_old_command</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">busfree_without_new_command</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">busfree_without_done_command</span><span class="p">;</span>
	<span class="kt">int</span>	      <span class="n">busfree_with_check_condition</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">count</span><span class="p">[</span><span class="n">maxstate</span><span class="p">];</span>
	<span class="kt">int</span>           <span class="n">count_trans</span><span class="p">[</span><span class="n">maxstate</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">[</span><span class="n">maxstate</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="kt">int</span> <span class="n">commands</span><span class="p">;</span>		<span class="cm">/* current number of commands */</span>

	<span class="kt">int</span> <span class="n">reconnect</span><span class="p">;</span>		<span class="cm">/* disconnection allowed */</span>
	<span class="kt">int</span> <span class="n">parity</span><span class="p">;</span>		<span class="cm">/* parity checking enabled */</span>
	<span class="kt">int</span> <span class="n">synchronous</span><span class="p">;</span>	<span class="cm">/* synchronous transferes enabled */</span>
	<span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>		<span class="cm">/* reset out delay */</span>
	<span class="kt">int</span> <span class="n">ext_trans</span><span class="p">;</span>		<span class="cm">/* extended translation enabled */</span>

	<span class="kt">int</span> <span class="n">swint</span><span class="p">;</span> 		<span class="cm">/* software-interrupt was fired during detect() */</span>
	<span class="kt">int</span> <span class="n">service</span><span class="p">;</span>		<span class="cm">/* bh needs to be run */</span>
	<span class="kt">int</span> <span class="n">in_intr</span><span class="p">;</span>		<span class="cm">/* bh is running */</span>

	<span class="cm">/* current state,</span>
<span class="cm">	   previous state,</span>
<span class="cm">	   last state different from current state */</span>
	<span class="k">enum</span> <span class="n">aha152x_state</span> <span class="n">state</span><span class="p">,</span> <span class="n">prevstate</span><span class="p">,</span> <span class="n">laststate</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
		<span class="cm">/* reconnecting target */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">syncrate</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="cm">/* current synchronous transfer agreements */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">syncneg</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="cm">/* 0: no negotiation;</span>
<span class="cm">		 * 1: negotiation in progress;</span>
<span class="cm">		 * 2: negotiation completed</span>
<span class="cm">		 */</span>

	<span class="kt">int</span> <span class="n">cmd_i</span><span class="p">;</span>
		<span class="cm">/* number of sent bytes of current command */</span>

	<span class="kt">int</span> <span class="n">msgi_len</span><span class="p">;</span>
		<span class="cm">/* number of received message bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msgi</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
		<span class="cm">/* received message bytes */</span>

	<span class="kt">int</span> <span class="n">msgo_i</span><span class="p">,</span> <span class="n">msgo_len</span><span class="p">;</span>	
		<span class="cm">/* number of sent bytes and length of current messages */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msgo</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
		<span class="cm">/* pending messages */</span>

	<span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>
		<span class="cm">/* number of sent/received bytes in dataphase */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port1</span><span class="p">;</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnpdev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">host_list</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * host specific command extension</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aha152x_scdata</span> <span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>	<span class="cm">/* next sc in queue */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">done</span><span class="p">;</span><span class="cm">/* semaphore to block on */</span>
	<span class="k">struct</span> <span class="n">scsi_eh_save</span> <span class="n">ses</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* access macros for hostdata */</span>

<span class="cp">#define HOSTDATA(shpnt)		((struct aha152x_hostdata *) &amp;shpnt-&gt;hostdata)</span>

<span class="cp">#define HOSTNO			((shpnt)-&gt;host_no)</span>

<span class="cp">#define CURRENT_SC		(HOSTDATA(shpnt)-&gt;current_SC)</span>
<span class="cp">#define DONE_SC			(HOSTDATA(shpnt)-&gt;done_SC)</span>
<span class="cp">#define ISSUE_SC		(HOSTDATA(shpnt)-&gt;issue_SC)</span>
<span class="cp">#define DISCONNECTED_SC		(HOSTDATA(shpnt)-&gt;disconnected_SC)</span>
<span class="cp">#define QLOCK			(HOSTDATA(shpnt)-&gt;lock)</span>
<span class="cp">#define QLOCKER			(HOSTDATA(shpnt)-&gt;locker)</span>
<span class="cp">#define QLOCKERL		(HOSTDATA(shpnt)-&gt;lockerl)</span>

<span class="cp">#define STATE			(HOSTDATA(shpnt)-&gt;state)</span>
<span class="cp">#define PREVSTATE		(HOSTDATA(shpnt)-&gt;prevstate)</span>
<span class="cp">#define LASTSTATE		(HOSTDATA(shpnt)-&gt;laststate)</span>

<span class="cp">#define RECONN_TARGET		(HOSTDATA(shpnt)-&gt;target)</span>

<span class="cp">#define CMD_I			(HOSTDATA(shpnt)-&gt;cmd_i)</span>

<span class="cp">#define MSGO(i)			(HOSTDATA(shpnt)-&gt;msgo[i])</span>
<span class="cp">#define MSGO_I			(HOSTDATA(shpnt)-&gt;msgo_i)</span>
<span class="cp">#define MSGOLEN			(HOSTDATA(shpnt)-&gt;msgo_len)</span>
<span class="cp">#define ADDMSGO(x)		(MSGOLEN&lt;256 ? (void)(MSGO(MSGOLEN++)=x) : aha152x_error(shpnt,&quot;MSGO overflow&quot;))</span>

<span class="cp">#define MSGI(i)			(HOSTDATA(shpnt)-&gt;msgi[i])</span>
<span class="cp">#define MSGILEN			(HOSTDATA(shpnt)-&gt;msgi_len)</span>
<span class="cp">#define ADDMSGI(x)		(MSGILEN&lt;256 ? (void)(MSGI(MSGILEN++)=x) : aha152x_error(shpnt,&quot;MSGI overflow&quot;))</span>

<span class="cp">#define DATA_LEN		(HOSTDATA(shpnt)-&gt;data_len)</span>

<span class="cp">#define SYNCRATE		(HOSTDATA(shpnt)-&gt;syncrate[CURRENT_SC-&gt;device-&gt;id])</span>
<span class="cp">#define SYNCNEG			(HOSTDATA(shpnt)-&gt;syncneg[CURRENT_SC-&gt;device-&gt;id])</span>

<span class="cp">#define DELAY			(HOSTDATA(shpnt)-&gt;delay)</span>
<span class="cp">#define EXT_TRANS		(HOSTDATA(shpnt)-&gt;ext_trans)</span>
<span class="cp">#define TC1550			(HOSTDATA(shpnt)-&gt;tc1550)</span>
<span class="cp">#define RECONNECT		(HOSTDATA(shpnt)-&gt;reconnect)</span>
<span class="cp">#define PARITY			(HOSTDATA(shpnt)-&gt;parity)</span>
<span class="cp">#define SYNCHRONOUS		(HOSTDATA(shpnt)-&gt;synchronous)</span>

<span class="cp">#define HOSTIOPORT0		(HOSTDATA(shpnt)-&gt;io_port0)</span>
<span class="cp">#define HOSTIOPORT1		(HOSTDATA(shpnt)-&gt;io_port1)</span>

<span class="cp">#define SCDATA(SCpnt)		((struct aha152x_scdata *) (SCpnt)-&gt;host_scribble)</span>
<span class="cp">#define SCNEXT(SCpnt)		SCDATA(SCpnt)-&gt;next</span>
<span class="cp">#define SCSEM(SCpnt)		SCDATA(SCpnt)-&gt;done</span>

<span class="cp">#define SG_ADDRESS(buffer)	((char *) sg_virt((buffer)))</span>

<span class="cm">/* state handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">seldi_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">seldo_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">selto_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">busfree_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">msgo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgo_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgo_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cmd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cmd_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cmd_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">datai_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">datai_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">datai_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">datao_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">datao_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">datao_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">status_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">msgi_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgi_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">parerr_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rsti_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">is_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * driver states</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">run</span><span class="p">)(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">spio</span><span class="p">;</span>
<span class="p">}</span> <span class="n">states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;idle&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;seldo&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">seldo_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;seldi&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">seldi_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;selto&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">selto_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;busfree&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">busfree_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;msgo&quot;</span><span class="p">,</span>	<span class="n">msgo_init</span><span class="p">,</span>	<span class="n">msgo_run</span><span class="p">,</span>	<span class="n">msgo_end</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cmd&quot;</span><span class="p">,</span>	<span class="n">cmd_init</span><span class="p">,</span>	<span class="n">cmd_run</span><span class="p">,</span>	<span class="n">cmd_end</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;msgi&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">msgi_run</span><span class="p">,</span>	<span class="n">msgi_end</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;status&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">status_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;datai&quot;</span><span class="p">,</span>	<span class="n">datai_init</span><span class="p">,</span>	<span class="n">datai_run</span><span class="p">,</span>	<span class="n">datai_end</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;datao&quot;</span><span class="p">,</span>	<span class="n">datao_init</span><span class="p">,</span>	<span class="n">datao_run</span><span class="p">,</span>	<span class="n">datao_end</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;parerr&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">parerr_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rsti&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="n">rsti_run</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* setup &amp; interrupt */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">aha152x_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>

<span class="cm">/* diagnostics */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disp_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_command</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">show_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disp_enintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *  queue services:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">append_SC</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">**</span><span class="n">SC</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">new_SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">SCNEXT</span><span class="p">(</span><span class="n">new_SC</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">SC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">SC</span> <span class="o">=</span> <span class="n">new_SC</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">end</span> <span class="o">=</span> <span class="o">*</span><span class="n">SC</span><span class="p">;</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">end</span><span class="p">);</span> <span class="n">end</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="n">SCNEXT</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_SC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="nf">remove_first_SC</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">**</span> <span class="n">SC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">SC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">SC</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="o">*</span><span class="n">SC</span><span class="p">);</span>
		<span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="nf">remove_lun_SC</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">**</span> <span class="n">SC</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">SC</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="n">lun</span><span class="p">));</span>
	     <span class="n">prev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
	     <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
			<span class="n">SCNEXT</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">SC</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

		<span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="nf">remove_SC</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">**</span><span class="n">SC</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">SC</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="n">SCp</span><span class="o">!=</span><span class="n">ptr</span><span class="p">;</span>
	     <span class="n">prev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
	     <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
			<span class="n">SCNEXT</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">SC</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

		<span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">swintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irqno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">swint</span><span class="o">++</span><span class="p">;</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="nf">aha152x_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">aha152x_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">;</span>

	<span class="n">shpnt</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aha152x_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aha152x_hostdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: scsi_host_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>

	<span class="cm">/* need to have host registered before triggering any interrupt */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aha152x_host_list</span><span class="p">);</span>

	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span>   <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="n">IO_RANGE</span><span class="p">;</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">tc1550</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HOSTIOPORT0</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
		<span class="n">HOSTIOPORT1</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HOSTIOPORT0</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="o">+</span><span class="mh">0x10</span><span class="p">;</span>
		<span class="n">HOSTIOPORT1</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="o">-</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">QLOCK</span><span class="p">);</span>
	<span class="n">RECONNECT</span>   <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">reconnect</span><span class="p">;</span>
	<span class="n">SYNCHRONOUS</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">synchronous</span><span class="p">;</span>
	<span class="n">PARITY</span>      <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">DELAY</span>       <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">;</span>
	<span class="n">EXT_TRANS</span>   <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">ext_trans</span><span class="p">;</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSIID</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">scsiid</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">reconnect</span><span class="p">)</span>
		<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">AHA152X_MAXQUEUE</span><span class="p">;</span>

	<span class="cm">/* RESET OUT */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aha152x: resetting bus...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">SCSIRSTO</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>

	<span class="n">reset_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;aha152x%d%s: &quot;</span>
	       <span class="s">&quot;vital data: rev=%x, &quot;</span>
	       <span class="s">&quot;io=0x%03lx (0x%03lx/0x%03lx), &quot;</span>
	       <span class="s">&quot;irq=%d, &quot;</span>
	       <span class="s">&quot;scsiid=%d, &quot;</span>
	       <span class="s">&quot;reconnect=%s, &quot;</span>
	       <span class="s">&quot;parity=%s, &quot;</span>
	       <span class="s">&quot;synchronous=%s, &quot;</span>
	       <span class="s">&quot;delay=%d, &quot;</span>
	       <span class="s">&quot;extended translation=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">tc1550</span> <span class="o">?</span> <span class="s">&quot; (tc1550 mode)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">GETPORT</span><span class="p">(</span><span class="n">REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span>
	       <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">HOSTIOPORT0</span><span class="p">,</span> <span class="n">HOSTIOPORT1</span><span class="p">,</span>
	       <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">,</span>
	       <span class="n">RECONNECT</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	       <span class="n">PARITY</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	       <span class="n">SYNCHRONOUS</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	       <span class="n">DELAY</span><span class="p">,</span>
	       <span class="n">EXT_TRANS</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="cm">/* not expecting any interrupts */</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">swintr</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="o">|</span><span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;aha152x&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: irq %d busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">swint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x%d: trying software interrupt, &quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">SWINT</span><span class="o">|</span><span class="n">INTEN</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">swint</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TESTHI</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lost.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: irq %d possibly wrong.  &quot;</span>
				<span class="s">&quot;Please verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ok.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* clear interrupts */</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="o">|</span><span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;aha152x&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: failed to reassign irq %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: failed to add host.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">shpnt</span><span class="p">;</span>

<span class="nl">out_host_put:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aha152x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shpnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>

<span class="cp">#if !defined(PCMCIA)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pnpdev</span><span class="p">)</span>
		<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pnpdev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * setup controller to generate interrupts depending</span>
<span class="cm"> * on current state (lock has to be acquired)</span>
<span class="cm"> *</span>
<span class="cm"> */</span> 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_expected_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	
		<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">selecting</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_intr</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;expecting: (seldo) (seltimo) (seldi)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">SELTO</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="n">ENSELDO</span> <span class="o">|</span> <span class="p">(</span><span class="n">DISCONNECTED_SC</span> <span class="o">?</span> <span class="n">ENSELDI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSELTIMO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_intr</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;expecting: (phase change) (busfree) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">spiordy</span> <span class="o">?</span> <span class="s">&quot;(spiordy)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">spiordy</span><span class="p">)</span> <span class="o">?</span> <span class="n">ENSPIORDY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENPHASEMIS</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENSCSIPERR</span> <span class="o">|</span> <span class="n">ENBUSFREE</span><span class="p">);</span> 
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">STATE</span><span class="o">==</span><span class="n">seldi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_intr</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;expecting: (phase change) (identify)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENPHASEMIS</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENSCSIPERR</span> <span class="o">|</span> <span class="n">ENBUSFREE</span><span class="p">);</span> 
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_intr</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;expecting: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
			<span class="n">DISCONNECTED_SC</span> <span class="o">?</span> <span class="s">&quot;(reselection)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ISSUE_SC</span> <span class="o">?</span> <span class="s">&quot;(busfree)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="n">DISCONNECTED_SC</span> <span class="o">?</span> <span class="n">ENSELDI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span><span class="n">ISSUE_SC</span><span class="o">||</span><span class="n">DONE_SC</span><span class="p">)</span> <span class="o">?</span> <span class="n">ENBUSFREE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_intr</span><span class="p">)</span>
		<span class="n">SETBITS</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TESTHI</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> *  Queue a command and setup interrupts for a free bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_internal_queue</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">complete</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">phase</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;queue: %p; cmd_len=%d pieces=%d size=%u cmnd=&quot;</span><span class="p">,</span>
		       <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span>
		       <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">__scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span>	<span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span>	<span class="o">=</span> <span class="n">not_issued</span> <span class="o">|</span> <span class="n">phase</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span>	<span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* Ilegal status by SCSI standard */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">have_data_in</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">sent_command</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">resetting</span><span class="o">|</span><span class="n">check_condition</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">||</span> <span class="n">SCSEM</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">||</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;cannot reuse command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aha152x_scdata</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">SCNEXT</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">SCSEM</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span>		<span class="o">=</span> <span class="n">complete</span><span class="p">;</span>

	<span class="cm">/* setup scratch area</span>
<span class="cm">	   SCp.ptr              : buffer pointer</span>
<span class="cm">	   SCp.this_residual    : buffer length</span>
<span class="cm">	   SCp.buffer           : next buffer</span>
<span class="cm">	   SCp.buffers_residual : left buffers in list</span>
<span class="cm">	   SCp.phase            : current state of the command */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">resetting</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>           <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span>           <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span>           <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>              <span class="o">=</span> <span class="n">SG_ADDRESS</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span>    <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">total_commands</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Turn led on, when this is the first command. */</span>
	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">append_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_intr</span><span class="p">)</span>
		<span class="n">setup_expected_interrupts</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  queue a command</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_queue_lck</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if(*SCpnt-&gt;cmnd == REQUEST_SENSE) {</span>
<span class="c">		SCpnt-&gt;result = 0;</span>
<span class="c">		done(SCpnt);</span>

<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">aha152x_internal_queue</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">aha152x_queue</span><span class="p">)</span>


<span class="cm">/*</span>
<span class="cm"> *  </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_done</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	struct Scsi_Host *shpnt = SCpnt-&gt;host;</span>
<span class="c">	DPRINTK(debug_eh, INFO_LEAD &quot;reset_done called\n&quot;, CMDINFO(SCpnt));</span>
<span class="cp">#endif</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SCSEM</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">SCSEM</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: reset_done w/o completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Abort a command</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_abort</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_eh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DEBUG_LEAD</span> <span class="s">&quot;abort(%p)&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">show_queues</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ptr</span><span class="o">=</span><span class="n">remove_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;not yet issued - SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>

		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">)</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME:</span>
<span class="cm">	 * for current command: queue ABORT for message out and raise ATN</span>
<span class="cm">	 * for disconnected command: pseudo SC with ABORT message or ABORT on reselection?</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;cannot abort running or disconnected command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset a device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_device_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">issued</span><span class="p">,</span> <span class="n">disconnected</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_cmd_len</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_eh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;aha152x_device_reset(%p)&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">show_queues</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">==</span><span class="n">SCpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;cannot reset current device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">issued</span>       <span class="o">=</span> <span class="n">remove_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">disconnected</span> <span class="o">=</span> <span class="n">issued</span> <span class="o">&amp;&amp;</span> <span class="n">remove_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aha152x_internal_queue</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">,</span> <span class="n">resetting</span><span class="p">,</span> <span class="n">reset_done</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove command from issue queue */</span>
		<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">remove_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span>         <span class="o">=</span> <span class="n">old_cmd_len</span><span class="p">;</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">resetted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">)</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* requeue */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">issued</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">append_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">append_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="p">}</span>
	
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_hard_reset_SCs</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">**</span><span class="n">SCs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span><span class="o">=*</span><span class="n">SCs</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">SCDATA</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DEBUG_LEAD</span> <span class="s">&quot;queue corrupted at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">soft_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;disconnected command %p removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">remove_SC</span><span class="p">(</span><span class="n">SCs</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">--</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the bus</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_bus_reset_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_eh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;scsi%d: bus reset&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">show_queues</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">free_hard_reset_SCs</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">);</span>
	<span class="n">free_hard_reset_SCs</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;scsi%d: resetting bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">SCSIRSTO</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;scsi%d: bus resetted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">setup_expected_interrupts</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the bus</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_bus_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">aha152x_bus_reset_host</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Restore default values to the AIC-6260 registers and reset the fifos</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">RSTFIFO</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETRATE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear all interrupt conditions */</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT4</span><span class="p">,</span> <span class="n">SYNCERR</span> <span class="o">|</span> <span class="n">FWERR</span> <span class="o">|</span> <span class="n">FRERR</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">BRSTCNTRL</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>

	<span class="cm">/* clear SCSI fifos and transfer count */</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRCH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="p">);</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">setup_expected_interrupts</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the host (bus and controller)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aha152x_host_reset_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;scsi%d: host reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">aha152x_bus_reset_host</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;scsi%d: resetting ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">reset_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the host (bus and controller)</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_host_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">aha152x_host_reset_host</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the &quot;logical geometry&quot;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="cm">/* try default translation */</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* for disks &gt;1GB do some guessing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="cm">/* try to figure out the geometry from the partition table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsicam_bios_param</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">63</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">EXT_TRANS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				       <span class="s">&quot;aha152x: unable to verify geometry for disk with &gt;1GB.</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;         using extended translation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
				<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
				<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="mi">63</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				       <span class="s">&quot;aha152x: unable to verify geometry for disk with &gt;1GB.</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;         Using default translation. Please verify yourself.</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;         Perhaps you need to enable extended translation in the driver.</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;         See Documentation/scsi/aha152x.txt for details.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">info_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">info_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">EXT_TRANS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				       <span class="s">&quot;aha152x: current partition table is using extended translation.</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;         using it also, although it&#39;s not explicitly enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Internal done function</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">DONE_SC</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;there&#39;s already a completed command %p - will cause abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">DONE_SC</span><span class="p">);</span>

		<span class="n">DONE_SC</span> <span class="o">=</span> <span class="n">CURRENT_SC</span><span class="p">;</span>
		<span class="n">CURRENT_SC</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: done() called outside of command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">work_struct</span> <span class="n">aha152x_tq</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Run service completions on the card with interrupts enabled.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aha152x_hostdata</span> <span class="o">*</span><span class="n">hd</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aha152x_host_list</span><span class="p">,</span> <span class="n">host_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Scsi_Host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>

		<span class="n">is_complete</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irqno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rev</span><span class="p">,</span> <span class="n">dmacntrl0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read a couple of registers that are known to not be all 1&#39;s. If</span>
<span class="cm">	 * we read all 1&#39;s (-1), that means that either:</span>
<span class="cm">	 *</span>
<span class="cm">	 * a. The host adapter chip has gone bad, and we cannot control it,</span>
<span class="cm">	 *	OR</span>
<span class="cm">	 * b. The host adapter is a PCMCIA card that has been ejected</span>
<span class="cm">	 *</span>
<span class="cm">	 * In either case, we cannot do anything with the host adapter at</span>
<span class="cm">	 * this point in time. So just ignore the interrupt and return.</span>
<span class="cm">	 * In the latter case, the interrupt might actually be meant for</span>
<span class="cm">	 * someone else sharing this IRQ, and that driver will handle it.</span>
<span class="cm">	 */</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">REV</span><span class="p">);</span>
	<span class="n">dmacntrl0</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dmacntrl0</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	

	<span class="cm">/* no more interrupts from the controller, while we&#39;re busy.</span>
<span class="cm">	   INTEN is restored by the BH handler */</span>
	<span class="n">CLRBITS</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">);</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Poke the BH handler */</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aha152x_tq</span><span class="p">,</span> <span class="n">run</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aha152x_tq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * busfree phase</span>
<span class="cm"> * - handle completition/disconnection/error of current command</span>
<span class="cm"> * - start selection for next command (if any)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">busfree_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="kt">int</span> <span class="n">action</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRCH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="p">);</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
		<span class="n">action</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">syncneg</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">completed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* target sent COMMAND COMPLETE */</span>
			<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">aborted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;ABORT sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">resetted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;BUS DEVICE RESET sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">disconnected</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* target sent DISCONNECT */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;target disconnected at %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
				<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
				<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">disconnections</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">append_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="p">);</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">CURRENT_SC</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_old_command</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">DONE_SC</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
		<span class="n">action</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">(</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">check_condition</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">done_SC</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">aha152x_scdata</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">SCDATA</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if(HOSTDATA(shpnt)-&gt;debug &amp; debug_eh) {</span>
<span class="c">				printk(ERR_LEAD &quot;received sense: &quot;, CMDINFO(DONE_SC));</span>
<span class="c">				scsi_print_sense(&quot;bh&quot;, DONE_SC);</span>
<span class="c">			}</span>
<span class="cp">#endif</span>

			<span class="n">scsi_eh_restore_cmnd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">);</span>

			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">)</span>
				<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn led off */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="o">==</span><span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_with_check_condition</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			DPRINTK(debug_eh, ERR_LEAD &quot;CHECK CONDITION found\n&quot;, CMDINFO(DONE_SC));</span>
<span class="cp">#endif</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">not_issued</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">aha152x_scdata</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
				<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DONE_SC</span><span class="p">;</span>
				<span class="n">DONE_SC</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">				DPRINTK(debug_eh, ERR_LEAD &quot;requesting sense\n&quot;, CMDINFO(ptr));</span>
<span class="cp">#endif</span>

				<span class="n">sc</span> <span class="o">=</span> <span class="n">SCDATA</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
				<span class="cm">/* It was allocated in aha152x_internal_queue? */</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">);</span>
				<span class="n">scsi_eh_prep_cmnd</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ses</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

				<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">aha152x_internal_queue</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_condition</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">);</span>
				<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			} else {</span>
<span class="c">				DPRINTK(debug_eh, ERR_LEAD &quot;command not issued - CHECK CONDITION ignored\n&quot;, CMDINFO(DONE_SC));</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">DONE_SC</span> <span class="o">&amp;&amp;</span> <span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="kt">int</span> <span class="n">hostno</span><span class="o">=</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">id</span><span class="o">=</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">lun</span><span class="o">=</span><span class="n">DONE_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DONE_SC</span><span class="p">;</span>
			<span class="n">DONE_SC</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* turn led off, when no commands are in the driver */</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">)</span>
				<span class="n">SETPORT</span><span class="p">(</span><span class="n">PORTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn led off */</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">!=</span> <span class="n">reset_done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>
				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_done</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;calling scsi_done(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
                	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_done</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;scsi_done(%p) returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DONE_SC</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_done_command</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ISSUE_SC</span><span class="p">)</span>
		<span class="n">CURRENT_SC</span> <span class="o">=</span> <span class="n">remove_first_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">);</span>

	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
		<span class="n">action</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	    	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">selecting</span><span class="p">;</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;selecting target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

		<span class="cm">/* clear selection timeout */</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">SELTO</span><span class="p">);</span>

		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSIID</span><span class="p">,</span> <span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">&lt;&lt;</span> <span class="n">OID_</span><span class="p">)</span> <span class="o">|</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">PARITY</span> <span class="o">?</span> <span class="n">ENSPCHK</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">|</span> <span class="n">ENSTIMER</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">ENSELO</span> <span class="o">|</span> <span class="n">ENAUTOATNO</span> <span class="o">|</span> <span class="p">(</span><span class="n">DISCONNECTED_SC</span> <span class="o">?</span> <span class="n">ENRESELI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_new_command</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">DISCONNECTED_SC</span> <span class="o">?</span> <span class="n">ENRESELI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">action</span><span class="p">)</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_any_action</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Selection done (OUT)</span>
<span class="cm"> * - queue IDENTIFY message and SDTR to selected target for message out</span>
<span class="cm"> *   (ATN asserted automagically via ENAUTOATNO in busfree())</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">seldo_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRPHASECHG</span><span class="p">);</span>

    	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">selecting</span><span class="o">|</span><span class="n">not_issued</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">SELDO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;aha152x: passing bus free condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">CLRSELDO</span><span class="p">);</span>
	
	<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">IDENTIFY</span><span class="p">(</span><span class="n">RECONNECT</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">aborting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">ABORT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">resetting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">BUS_DEVICE_RESET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SYNCNEG</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">SYNCHRONOUS</span><span class="p">)</span> <span class="p">{</span>
    		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">syncneg</span><span class="p">;</span>
		<span class="n">MSGOLEN</span> <span class="o">+=</span> <span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MSGO</span><span class="p">(</span><span class="n">MSGOLEN</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">SYNCNEG</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* negotiation in progress */</span>
	<span class="p">}</span>

	<span class="n">SETRATE</span><span class="p">(</span><span class="n">SYNCRATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Selection timeout</span>
<span class="cm"> * - return command to mid-level with failure cause</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">selto_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRSELTIMO</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;selection timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;!CURRENT_SC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

    	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">selecting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">aborted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">SELINGO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;arbitration not won</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ARBITRATION won, but SELECTION failed */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;selection failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Selection in done</span>
<span class="cm"> * - put current command back to issue queue</span>
<span class="cm"> *   (reconnection of a disconnected nexus instead</span>
<span class="cm"> *    of successful selection out)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">seldi_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">selid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">CLRSELDI</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRPHASECHG</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">not_issued</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;command should not have been issued yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">ERR_LEAD</span> <span class="s">&quot;command requeued - reselection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

		<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">append_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ISSUE_SC</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="p">);</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">CURRENT_SC</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">DISCONNECTED_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;unexpected SELDI &quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RECONN_TARGET</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">selid</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SELID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">selid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aha152x%d: target id unknown (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">,</span> <span class="n">selid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span> <span class="o">!</span><span class="p">(</span><span class="n">selid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">));</span> <span class="n">target</span><span class="o">--</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">selid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aha152x%d: multiple targets reconnected (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">HOSTNO</span><span class="p">,</span> <span class="n">selid</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSIID</span><span class="p">,</span> <span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">&lt;&lt;</span> <span class="n">OID_</span><span class="p">)</span> <span class="o">|</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">SETRATE</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">target</span><span class="p">]);</span>

	<span class="n">RECONN_TARGET</span><span class="o">=</span><span class="n">target</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;target %d reselected (%02x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">target</span><span class="p">,</span> <span class="n">selid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * message in phase</span>
<span class="cm"> * - handle initial message after reconnection to identify</span>
<span class="cm"> *   reconnecting nexus</span>
<span class="cm"> * - queue command on DISCONNECTED_SC on DISCONNECT message</span>
<span class="cm"> * - set completed flag on COMMAND COMPLETE</span>
<span class="cm"> *   (other completition code moved to busfree_run)</span>
<span class="cm"> * - handle response to SDTR</span>
<span class="cm"> * - clear synchronous transfer agreements on BUS RESET</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: what about SAVE POINTERS, RESTORE POINTERS?</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgi_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sstat1</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">sstat1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PHASECHG</span><span class="o">|</span><span class="n">PHASEMIS</span><span class="o">|</span><span class="n">BUSFREE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sstat1</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span><span class="n">SPIORDY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgi</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;!SPIORDY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>	

		<span class="n">ADDMSGI</span><span class="p">(</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSIDAT</span><span class="p">));</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_msgi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;inbound message %02x &quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">spi_print_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">LASTSTATE</span><span class="o">!=</span><span class="n">seldi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: message in w/o current command not after reselection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">	 	 	 * Handle reselection</span>
<span class="cm">	 		 */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IDENTIFY_BASE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: target didn&#39;t identify after reselection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">CURRENT_SC</span> <span class="o">=</span> <span class="n">remove_lun_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">,</span> <span class="n">RECONN_TARGET</span><span class="p">,</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">show_queues</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x%d: no disconnected command for target %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">,</span> <span class="n">RECONN_TARGET</span><span class="p">,</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgi</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;target reconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">disconnected</span><span class="p">;</span>

			<span class="n">MSGILEN</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* next message if any */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> 

		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Message</span> <span class="o">=</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DISCONNECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RECONNECT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;target was not allowed to disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">disconnected</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">completed</span><span class="p">)</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgi</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;again COMMAND COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>

			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">completed</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MESSAGE_REJECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">SYNCNEG</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Synchronous Data Transfer Request was rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
				<span class="n">SYNCNEG</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* negotiation completed */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;inbound message (MESSAGE REJECT)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAVE_POINTERS</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESTORE_POINTERS</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EXTENDED_MESSAGE</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">MSGILEN</span><span class="o">&lt;</span><span class="mi">2</span> <span class="o">||</span> <span class="n">MSGILEN</span><span class="o">&lt;</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* not yet completed */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">EXTENDED_SDTR</span>:
				<span class="p">{</span>
					<span class="kt">long</span> <span class="n">ticks</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;SDTR message length!=3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">synchronous</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
					<span class="n">spi_print_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="n">ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">49</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">syncneg</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* negotiation in progress */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="o">||</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MESSAGE_REJECT</span><span class="p">);</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;received Synchronous Data Transfer Request invalid - rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						
						<span class="n">SYNCRATE</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ticks</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">EXTENDED_MESSAGE</span><span class="p">);</span>
						<span class="n">ADDMSGO</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
						<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">EXTENDED_SDTR</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ticks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
							<span class="n">ADDMSGO</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
							<span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

						<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>

						<span class="n">SYNCRATE</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ticks</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">MSGI</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* requested SDTR is too slow, do it asynchronously */</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Synchronous Data Transfer Request too slow - Rejecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
						<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MESSAGE_REJECT</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">SYNCNEG</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>		<span class="cm">/* negotiation completed */</span>
					<span class="n">SETRATE</span><span class="p">(</span><span class="n">SYNCRATE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">BUS_DEVICE_RESET</span>:
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

					<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
						<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncneg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>

				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">EXTENDED_MODIFY_DATA_POINTER</span>:
			<span class="k">case</span> <span class="n">EXTENDED_EXTENDED_IDENTIFY</span>:
			<span class="k">case</span> <span class="n">EXTENDED_WDTR</span>:
			<span class="nl">default:</span>
				<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MESSAGE_REJECT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">MSGILEN</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgi_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">MSGILEN</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">WARN_LEAD</span> <span class="s">&quot;target left before message completed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">MSGILEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MSGOLEN</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgi</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;msgo pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">,</span> <span class="n">P_MSGI</span> <span class="o">|</span> <span class="n">SIG_ATNO</span><span class="p">);</span>
	<span class="p">}</span> 
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * message out phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">MSGOLEN</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">syncneg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SYNCNEG</span><span class="o">==</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">SYNCRATE</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">IDENTIFY</span><span class="p">(</span><span class="n">RECONNECT</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;unexpected MESSAGE OUT phase; rejecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">ADDMSGO</span><span class="p">(</span><span class="n">MESSAGE_REJECT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_msgo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">DEBUG_LEAD</span> <span class="s">&quot;messages( &quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MSGOLEN</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">spi_print_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MSGO</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * message out phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgo_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">MSGO_I</span><span class="o">==</span><span class="n">MSGOLEN</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgo</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;messages all sent (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">MSGO_I</span><span class="p">,</span> <span class="n">MSGOLEN</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">MSGO_I</span><span class="o">&lt;</span><span class="n">MSGOLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgo</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;message byte %02x (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">MSGO</span><span class="p">(</span><span class="n">MSGO_I</span><span class="p">),</span> <span class="n">MSGO_I</span><span class="p">,</span> <span class="n">MSGOLEN</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">SPIORDY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_msgo</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;!SPIORDY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">MSGO_I</span><span class="o">==</span><span class="n">MSGOLEN</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Leave MESSAGE OUT after transfer */</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">CLRATNO</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">MSGO</span><span class="p">(</span><span class="n">MSGO_I</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IDENTIFY_BASE</span><span class="p">)</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">identified</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">MSGO</span><span class="p">(</span><span class="n">MSGO_I</span><span class="p">)</span><span class="o">==</span><span class="n">ABORT</span><span class="p">)</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">aborted</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">MSGO</span><span class="p">(</span><span class="n">MSGO_I</span><span class="p">)</span><span class="o">==</span><span class="n">BUS_DEVICE_RESET</span><span class="p">)</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">resetted</span><span class="p">;</span>

		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSIDAT</span><span class="p">,</span> <span class="n">MSGO</span><span class="p">(</span><span class="n">MSGO_I</span><span class="o">++</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgo_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">MSGO_I</span><span class="o">&lt;</span><span class="n">MSGOLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;message sent incompletely (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">MSGO_I</span><span class="p">,</span> <span class="n">MSGOLEN</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">SYNCNEG</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;Synchronous Data Transfer Request was rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">SYNCNEG</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
		
	<span class="n">MSGO_I</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MSGOLEN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * command phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">sent_command</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;command already sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DEBUG_LEAD</span> <span class="s">&quot;cmd_init: &quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">__scsi_print_command</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">CMD_I</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * command phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">CMD_I</span><span class="o">==</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_cmd</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;command already completely sent (%d/%d)&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">CMD_I</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
		<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span><span class="p">(</span><span class="n">CMD_I</span><span class="o">&lt;</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_cmd</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;command byte %02x (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">CMD_I</span><span class="p">],</span> <span class="n">CMD_I</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">SPIORDY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_cmd</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;!SPIORDY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSIDAT</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">CMD_I</span><span class="o">++</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">CMD_I</span><span class="o">&lt;</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;command sent incompletely (%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">CMD_I</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">sent_command</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * status phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span><span class="n">SPIORDY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_status</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;!SPIORDY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSIDAT</span><span class="p">);</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">debug_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DEBUG_LEAD</span> <span class="s">&quot;inbound status %02x &quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
		<span class="n">scsi_print_status</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * data in phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">datai_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">RSTFIFO</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">RSTFIFO</span><span class="o">|</span><span class="n">ENDMA</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">SCSIEN</span><span class="o">|</span><span class="n">DMAEN</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSCSIPERR</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENPHASEMIS</span> <span class="o">|</span> <span class="n">ENBUSFREE</span><span class="p">);</span>

	<span class="n">DATA_LEN</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span>
		<span class="n">DEBUG_LEAD</span> <span class="s">&quot;datai_init: request_bufflen=%d resid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">datai_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">the_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifodata</span><span class="p">,</span> <span class="n">data_count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * loop while the phase persists or the fifos are not empty</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">||</span> <span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="p">)</span> <span class="o">||</span> <span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">,</span> <span class="n">SEMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: maybe this should be done by setting up</span>
<span class="cm">		 * STCNT to trigger ENSWRAP interrupt, instead of</span>
<span class="cm">		 * polling for DFIFOFULL</span>
<span class="cm">		 */</span>
		<span class="n">the_time</span><span class="o">=</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOFULL</span><span class="o">|</span><span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">the_time</span><span class="p">))</span>
			<span class="n">barrier</span><span class="p">();</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOFULL</span><span class="o">|</span><span class="n">INTSTAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;datai timeout&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTHI</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOFULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fifodata</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">the_time</span><span class="o">=</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
			<span class="k">while</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">,</span> <span class="n">SEMPTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">the_time</span><span class="p">))</span>
				<span class="n">barrier</span><span class="p">();</span>

			<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">,</span> <span class="n">SEMPTY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;datai sempty timeout&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
				<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">fifodata</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">FIFOSTAT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="n">fifodata</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        	<span class="n">data_count</span> <span class="o">=</span> <span class="n">fifodata</span><span class="o">&gt;</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">?</span>
						<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">:</span>
						<span class="n">fifodata</span><span class="p">;</span>
				<span class="n">fifodata</span> <span class="o">-=</span> <span class="n">data_count</span><span class="p">;</span>

                        	<span class="k">if</span><span class="p">(</span><span class="n">data_count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;8bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
                                	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">ENDMA</span><span class="o">|</span><span class="n">_8BIT</span><span class="p">);</span>
                                	<span class="o">*</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DATAPORT</span><span class="p">);</span>
                                	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">--</span><span class="p">;</span>
                                	<span class="n">DATA_LEN</span><span class="o">++</span><span class="p">;</span>
                                	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">ENDMA</span><span class="p">);</span>
                        	<span class="p">}</span>
	
                        	<span class="k">if</span><span class="p">(</span><span class="n">data_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;16bit(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">data_count</span><span class="p">);</span>
                                	<span class="n">data_count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
                                	<span class="n">insw</span><span class="p">(</span><span class="n">DATAPORT</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">data_count</span><span class="p">);</span>
                                	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>           <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">;</span>
                                	<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">;</span>
                                	<span class="n">DATA_LEN</span>                      <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">;</span>
                        	<span class="p">}</span>
	
                        	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                               		<span class="cm">/* advance to next buffer */</span>
                               		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="o">--</span><span class="p">;</span>
                               		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
                               		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>           <span class="o">=</span> <span class="n">SG_ADDRESS</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
                               		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
				<span class="p">}</span> 
                	<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">fifodata</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;no buffers left for %d(%d) bytes (data overrun!?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">fifodata</span><span class="p">,</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">FIFOSTAT</span><span class="p">));</span>
                        <span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">ENDMA</span><span class="o">|</span><span class="n">_8BIT</span><span class="p">);</span>
			<span class="k">while</span><span class="p">(</span><span class="n">fifodata</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
				<span class="n">data</span><span class="o">=</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">DATAPORT</span><span class="p">);</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;data=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
				<span class="n">fifodata</span><span class="o">--</span><span class="p">;</span>
				<span class="n">DATA_LEN</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
                        <span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">ENDMA</span><span class="o">|</span><span class="n">_8BIT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">||</span>
	   <span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="p">)</span> <span class="o">||</span>
	   <span class="n">TESTLO</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">,</span> <span class="n">SEMPTY</span><span class="p">)</span> <span class="o">||</span>
	   <span class="n">GETPORT</span><span class="p">(</span><span class="n">FIFOSTAT</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	   	<span class="cm">/*</span>
<span class="cm">		 * something went wrong, if there&#39;s something left in the fifos</span>
<span class="cm">		 * or the phase didn&#39;t change</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;fifos should be empty and phase should have changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">DATA_LEN</span><span class="o">!=</span><span class="n">GETSTCNT</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span>
		       <span class="s">&quot;manual transfer count differs from automatic (count=%d;stcnt=%d;diff=%d;fifostat=%d)&quot;</span><span class="p">,</span>
		       <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">DATA_LEN</span><span class="p">,</span> <span class="n">GETSTCNT</span><span class="p">(),</span> <span class="n">GETSTCNT</span><span class="p">()</span><span class="o">-</span><span class="n">DATA_LEN</span><span class="p">,</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">FIFOSTAT</span><span class="p">));</span>
		<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">datai_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CMD_INC_RESID</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">,</span> <span class="o">-</span><span class="n">GETSTCNT</span><span class="p">());</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span>
		<span class="n">DEBUG_LEAD</span> <span class="s">&quot;datai_end: request_bufflen=%d resid=%d stcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">GETSTCNT</span><span class="p">());</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * data out phase</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">datao_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">WRITE_READ</span> <span class="o">|</span> <span class="n">RSTFIFO</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">WRITE_READ</span> <span class="o">|</span> <span class="n">ENDMA</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">SCSIEN</span><span class="o">|</span><span class="n">DMAEN</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSCSIPERR</span> <span class="o">|</span> <span class="n">ENSCSIRST</span> <span class="o">|</span> <span class="n">ENPHASEMIS</span> <span class="o">|</span> <span class="n">ENBUSFREE</span> <span class="p">);</span>

	<span class="n">DATA_LEN</span> <span class="o">=</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datao</span><span class="p">,</span>
		<span class="n">DEBUG_LEAD</span> <span class="s">&quot;datao_init: request_bufflen=%d; resid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">datao_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">the_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_count</span><span class="p">;</span>

	<span class="cm">/* until phase changes or all data sent */</span>
	<span class="k">while</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_count</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">data_count</span> <span class="o">&gt;</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">)</span>
			<span class="n">data_count</span><span class="o">=</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;datao fifo not empty (%d)&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">FIFOSTAT</span><span class="p">));</span>
			<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">data_count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span><span class="n">WRITE_READ</span><span class="o">|</span><span class="n">ENDMA</span><span class="o">|</span><span class="n">_8BIT</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">DATAPORT</span><span class="p">,</span> <span class="o">*</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">--</span><span class="p">;</span>
			<span class="n">CMD_INC_RESID</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span><span class="n">WRITE_READ</span><span class="o">|</span><span class="n">ENDMA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">data_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">outsw</span><span class="p">(</span><span class="n">DATAPORT</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">data_count</span><span class="p">);</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>           <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">;</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">;</span>
			<span class="n">CMD_INC_RESID</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">data_count</span><span class="p">);</span>
	  	<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* advance to next buffer */</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="o">--</span><span class="p">;</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>           <span class="o">=</span> <span class="n">SG_ADDRESS</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">the_time</span><span class="o">=</span><span class="n">jiffies</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="o">|</span><span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">the_time</span><span class="p">))</span>
			<span class="n">barrier</span><span class="p">();</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="o">|</span><span class="n">INTSTAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;dataout timeout&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
			<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">datao_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">TESTLO</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">DFIFOEMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">data_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">DATA_LEN</span> <span class="o">-</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">))</span> <span class="o">-</span>
		                                                    <span class="n">GETSTCNT</span><span class="p">();</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datao</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;datao: %d bytes to resend (%d written, %d transferred)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
			<span class="n">data_count</span><span class="p">,</span>
			<span class="n">DATA_LEN</span> <span class="o">-</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
			<span class="n">GETSTCNT</span><span class="p">());</span>

		<span class="n">CMD_INC_RESID</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">,</span> <span class="n">data_count</span><span class="p">);</span>

		<span class="n">data_count</span> <span class="o">-=</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">-</span>
		                             <span class="n">SG_ADDRESS</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">data_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">--</span><span class="p">;</span>
			<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data_count</span> <span class="o">-=</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">SG_ADDRESS</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span>
		                                                     <span class="n">data_count</span><span class="p">;</span>
		<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span>
		                                                     <span class="n">data_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_datao</span><span class="p">,</span> <span class="n">DEBUG_LEAD</span> <span class="s">&quot;datao_end: request_bufflen=%d; resid=%d; stcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span>
		<span class="n">GETSTCNT</span><span class="p">());</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">CLRCH1</span><span class="o">|</span><span class="n">CLRSTCNT</span><span class="p">);</span>
	<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * figure out what state we&#39;re in</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dataphase</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat0</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat1</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">);</span>

	<span class="n">PREVSTATE</span> <span class="o">=</span> <span class="n">STATE</span><span class="p">;</span>
	<span class="n">STATE</span><span class="o">=</span><span class="n">unknown</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">rsti</span><span class="p">;</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span><span class="n">SCSIRSTI</span><span class="p">);</span>
  	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">SELDI</span> <span class="o">&amp;&amp;</span> <span class="n">PREVSTATE</span><span class="o">==</span><span class="n">busfree</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">seldi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">SELDO</span> <span class="o">&amp;&amp;</span> <span class="n">CURRENT_SC</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">selecting</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">seldo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">selto</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">busfree</span><span class="p">;</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span><span class="n">BUSFREE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">STATE</span><span class="o">=</span><span class="n">parerr</span><span class="p">;</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span><span class="n">SCSIPERR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">P_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P_MSGI</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">msgi</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_MSGO</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">msgo</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_DATAO</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">datao</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_DATAI</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">datai</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_STATUS</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">status</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P_CMD</span>:	<span class="n">STATE</span><span class="o">=</span><span class="n">cmd</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dataphase</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">SELDI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">STATE</span><span class="o">!=</span><span class="n">seldi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dataphase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">INFO_LEAD</span> <span class="s">&quot;reselection missed?&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
		<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">STATE</span><span class="o">!=</span><span class="n">PREVSTATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LASTSTATE</span><span class="o">=</span><span class="n">PREVSTATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dataphase</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle parity error</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: in which phase?</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">parerr_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">));</span>
	<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_PARITY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle reset in</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rsti_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;aha152x%d: scsi reset in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">);</span>
	
	<span class="n">ptr</span><span class="o">=</span><span class="n">DISCONNECTED_SC</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">soft_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_SC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DISCONNECTED_SC</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>  <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">soft_reset</span><span class="p">)</span>
		<span class="n">done</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * bottom-half handler</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">is_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dataphase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">shpnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span>  <span class="p">{</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_intr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* aha152x_error never returns.. */</span>
		<span class="n">aha152x_error</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="s">&quot;bottom-half already running!?&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_intr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * loop while there are interrupt conditions pending</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">dataphase</span><span class="o">=</span><span class="n">update_state</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_phases</span><span class="p">,</span> <span class="n">LEAD</span> <span class="s">&quot;start %s %s(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">LASTSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * end previous state</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">PREVSTATE</span><span class="o">!=</span><span class="n">STATE</span> <span class="o">&amp;&amp;</span> <span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">end</span><span class="p">)</span>
			<span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">end</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * disable SPIO mode if previous phase used it</span>
<span class="cm">		 * and this one doesn&#39;t</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">spio</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">spio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span>
				<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">spiordy</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * accept current dataphase phase</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dataphase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">,</span> <span class="n">REQINIT</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">,</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">P_MASK</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">,</span> <span class="n">PHASECHG</span><span class="p">);</span>  
		<span class="p">}</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * enable SPIO mode if previous didn&#39;t use it</span>
<span class="cm">		 * and this one does</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">spio</span> <span class="o">&amp;&amp;</span> <span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">spio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">SETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">CH1</span><span class="o">|</span><span class="n">SPIOEN</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span>
				<span class="n">CURRENT_SC</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">|=</span> <span class="n">spiordy</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * initialize for new state</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">PREVSTATE</span><span class="o">!=</span><span class="n">STATE</span> <span class="o">&amp;&amp;</span> <span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">init</span><span class="p">)</span>
			<span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * handle current state</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">run</span><span class="p">)</span>
			<span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">run</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">ERR_LEAD</span> <span class="s">&quot;unexpected state (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">STATE</span><span class="p">);</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * setup controller to interrupt on</span>
<span class="cm">		 * the next expected condition and</span>
<span class="cm">		 * loop if it&#39;s already there</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pending</span><span class="o">=</span><span class="n">setup_expected_interrupts</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="n">STATE</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">PREVSTATE</span><span class="o">!=</span><span class="n">STATE</span><span class="p">)</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count_trans</span><span class="p">[</span><span class="n">STATE</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">[</span><span class="n">STATE</span><span class="p">]</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="o">-</span><span class="n">start</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_phases</span><span class="p">,</span> <span class="n">LEAD</span> <span class="s">&quot;end %s %s(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMDINFO</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">),</span> <span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">LASTSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable interrupts and leave bottom-half</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_intr</span><span class="o">--</span><span class="p">;</span>
	<span class="n">SETBITS</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">,</span> <span class="n">INTEN</span><span class="p">);</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * Dump the current driver status and panic</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aha152x_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">aha152x%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">show_queues</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;aha152x panic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Display registers of AIC-6260</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disp_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: %s(%s) &quot;</span><span class="p">,</span>
		<span class="n">CURRENT_SC</span> <span class="o">?</span> <span class="s">&quot;busy&quot;</span> <span class="o">:</span> <span class="s">&quot;waiting&quot;</span><span class="p">,</span>
		<span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSISEQ( &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TEMODEO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TARGET MODE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENRESELI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RESELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AUTOATNO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AUTOATNI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AUTOATNP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIRSTO &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;);&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; SCSISIG(&quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">P_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P_DATAO</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DATA OUT&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_DATAI</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DATA IN&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_CMD</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;COMMAND&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_STATUS</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;STATUS&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_MSGO</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MESSAGE OUT&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_MSGI</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MESSAGE IN&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;*invalid*&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INTSTAT (%s); &quot;</span><span class="p">,</span> <span class="n">TESTHI</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;hi&quot;</span> <span class="o">:</span> <span class="s">&quot;lo&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SSTAT( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TARGET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TARGET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELINGO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWRAP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SDONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIORDY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMADONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELTO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATNTARG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIRSTI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASEMIS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASECHG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;REQINIT &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>


	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SSTAT( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TARGET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TARGET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELINGO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWRAP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SDONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIORDY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMADONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELTO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATNTARG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIRSTI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASEMIS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASECHG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;REQINIT &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SXFRCTL0( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMAEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMAEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CH1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CH1 &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CLRSTCNT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CLRSTCNT &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIOEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SPIOEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CLRCH1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CLRCH1 &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SIGNAL( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_ATNI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ATNI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_SELI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_BSYI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BSYI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_REQI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;REQI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_ACKI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ACKI &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SELID (%02x), &quot;</span><span class="p">,</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SELID</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;STCNT (%d), &quot;</span><span class="p">,</span> <span class="n">GETSTCNT</span><span class="p">());</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SSTAT2( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SOFFSET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOFFSET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SEMPTY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SEMPTY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SFULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SFULL &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); SFCNT (%d); &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SFULL</span> <span class="o">|</span> <span class="n">SFCNT</span><span class="p">));</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT3</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSICNT (%d), OFFCNT(%d), &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SSTAT4( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SYNCERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYNCERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FWERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FWERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FRERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FRERR &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMACNTRL0( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">_8BIT</span> <span class="o">?</span> <span class="s">&quot;8BIT&quot;</span> <span class="o">:</span> <span class="s">&quot;16BIT&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMA</span> <span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">WRITE_READ</span> <span class="o">?</span> <span class="s">&quot;WRITE&quot;</span> <span class="o">:</span> <span class="s">&quot;READ&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENDMA</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENDMA &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">INTEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INTEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">RSTFIFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RSTFIFO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWINT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SWINT &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMASTAT( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATDONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ATDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">WORDRDY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WORDRDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DFIFOFULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DFIFOFULL &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DFIFOEMP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DFIFOEMP &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * display enabled interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disp_enintr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;enabled interrupts ( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELDO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELDI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELINGO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSWRAP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSDONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSPIORDY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENDMADONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENDMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELTIMO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSELTIMO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENATNTARG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENPHASEMIS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENPHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENBUSFREE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENBUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSCSIPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENSCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENPHASECHG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENPHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENREQINIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ENREQINIT &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Show the command data of a command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_command</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%p: cmnd=(&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="n">__scsi_print_command</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;); request_bufflen=%d; resid=%d; phase |&quot;</span><span class="p">,</span>
	       <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">not_issued</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;not issued|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">selecting</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;selecting|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">identified</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;identified|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">disconnected</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;disconnected|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">completed</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;completed|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">spiordy</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;spiordy|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">syncneg</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;syncneg|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">aborted</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aborted|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">resetted</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;resetted|&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">SCDATA</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;; next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;; next=(host scribble NULL)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dump the queued data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">queue status:</span><span class="se">\n</span><span class="s">issue_SC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ISSUE_SC</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
		<span class="n">show_command</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;current_SC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span>
		<span class="n">show_command</span><span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;disconnected_SC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DISCONNECTED_SC</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCDATA</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">?</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">show_command</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

	<span class="n">disp_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="n">disp_enintr</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef SPRINTF</span>
<span class="cp">#define SPRINTF(args...) pos += sprintf(pos, ## args)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_command</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;0x%08x: target=%d; lun=%d; cmnd=( &quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); resid=%d; residual=%d; buffers=%d; phase |&quot;</span><span class="p">,</span>
		<span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">ptr</span><span class="p">),</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span><span class="p">,</span>
		<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">not_issued</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;not issued|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">selecting</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;selecting|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">disconnected</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;disconnected|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">aborted</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;aborted|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">identified</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;identified|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">completed</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;completed|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">spiordy</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;spiordy|&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="n">syncneg</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;syncneg|&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;; next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: %s(%s) &quot;</span><span class="p">,</span> <span class="n">CURRENT_SC</span> <span class="o">?</span> <span class="s">&quot;on bus&quot;</span> <span class="o">:</span> <span class="s">&quot;waiting&quot;</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">STATE</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="n">PREVSTATE</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISEQ</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSISEQ( &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TEMODEO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;TARGET MODE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENRESELI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;RESELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;AUTOATNO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;AUTOATNI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENAUTOATNP</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;AUTOATNP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIRSTO &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;);&quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; SCSISIG(&quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">P_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P_DATAO</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DATA OUT&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_DATAI</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DATA IN&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_CMD</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;COMMAND&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_STATUS</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;STATUS&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_MSGO</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;MESSAGE OUT&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P_MSGI</span>:
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;MESSAGE IN&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;*invalid*&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;INTSTAT (%s); &quot;</span><span class="p">,</span> <span class="n">TESTHI</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;hi&quot;</span> <span class="o">:</span> <span class="s">&quot;lo&quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SSTAT( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TARGET</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;TARGET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELINGO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWRAP</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SDONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIORDY</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMADONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELTO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATNTARG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIRSTI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASEMIS</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;PHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;BUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASECHG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;PHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;REQINIT &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>


	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SSTAT( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TARGET</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;TARGET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELDI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELINGO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWRAP</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SDONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIORDY</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMADONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELTO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATNTARG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIRSTI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASEMIS</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;PHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;BUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PHASECHG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;PHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">REQINIT</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;REQINIT &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SXFRCTL0( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SXFRCTL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SCSIEN</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSIEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMAEN</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DMAEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CH1</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;CH1 &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CLRSTCNT</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;CLRSTCNT &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SPIOEN</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SPIOEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">CLRCH1</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;CLRCH1 &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SIGNAL( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SCSISIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_ATNI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ATNI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_SELI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_BSYI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;BSYI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_REQI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;REQI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SIG_ACKI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ACKI &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SELID(%02x), &quot;</span><span class="p">,</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SELID</span><span class="p">));</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;STCNT(%d), &quot;</span><span class="p">,</span> <span class="n">GETSTCNT</span><span class="p">());</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SSTAT2( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SOFFSET</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SOFFSET &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SEMPTY</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SEMPTY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SFULL</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SFULL &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); SFCNT (%d); &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SFULL</span> <span class="o">|</span> <span class="n">SFCNT</span><span class="p">));</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT3</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSICNT (%d), OFFCNT(%d), &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SSTAT4( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SSTAT4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SYNCERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SYNCERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FWERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;FWERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FRERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;FRERR &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DMACNTRL0( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DMACNTRL0</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">_8BIT</span> <span class="o">?</span> <span class="s">&quot;8BIT&quot;</span> <span class="o">:</span> <span class="s">&quot;16BIT&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">DMA</span> <span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">WRITE_READ</span> <span class="o">?</span> <span class="s">&quot;WRITE&quot;</span> <span class="o">:</span> <span class="s">&quot;READ&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENDMA</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENDMA &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">INTEN</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;INTEN &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">RSTFIFO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;RSTFIFO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SWINT</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SWINT &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;); &quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DMASTAT( &quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">DMASTAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ATDONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ATDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">WORDRDY</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;WORDRDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DFIFOFULL</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DFIFOFULL &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">DFIFOEMP</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DFIFOEMP &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;enabled interrupts( &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELDO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSELDO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELDI</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSELDI &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELINGO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSELINGO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSWRAP</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSWRAP &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSDONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSDONE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSPIORDY</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSPIORDY &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENDMADONE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENDMADONE &quot;</span><span class="p">);</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">SIMODE1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSELTIMO</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSELTIMO &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENATNTARG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENATNTARG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENPHASEMIS</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENPHASEMIS &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENBUSFREE</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENBUSFREE &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENSCSIPERR</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENSCSIPERR &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENPHASECHG</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENPHASECHG &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ENREQINIT</span><span class="p">)</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ENREQINIT &quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_set_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">shpnt</span> <span class="o">||</span> <span class="o">!</span><span class="n">buffer</span> <span class="o">||</span> <span class="n">length</span><span class="o">&lt;</span><span class="mi">8</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;aha152x &quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&gt;</span><span class="mi">14</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;debug &quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">;</span>

		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">14</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x%d: debugging options set to 0x%04x (were 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">,</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&gt;</span><span class="mi">13</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">total_commands</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">disconnections</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_any_action</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_old_command</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_new_command</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_done_command</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_with_check_condition</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">maxstate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count_trans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x%d: stats reseted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTNO</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef SPRINTF</span>
<span class="cp">#define SPRINTF(args...) \</span>
<span class="cp">	do { if(pos &lt; buffer + length) pos += sprintf(pos, ## args); } while(0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
		      <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">thislength</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> 
	       <span class="n">KERN_DEBUG</span> <span class="s">&quot;aha152x_proc_info: buffer=%p offset=%ld length=%d hostno=%d inout=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">inout</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">inout</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">aha152x_set_info</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="n">AHA152X_REVID</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;ioports 0x%04lx to 0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;interrupt 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;disconnection/reconnection %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">RECONNECT</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;parity checking %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PARITY</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;synchronous transfers %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SYNCHRONOUS</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%d commands currently queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SYNCHRONOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;synchronously operating targets (tick=50 ns):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
				<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;target %d: period %dT/%dns; req/ack offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span>
					<span class="p">(((</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
					<span class="p">(((</span><span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
				    <span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">syncrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
<span class="cp">#define PDEBUG(flags,txt) \</span>
<span class="cp">	if(HOSTDATA(shpnt)-&gt;debug &amp; flags) SPRINTF(&quot;(%s) &quot;, txt);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;enabled debugging options: &quot;</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> <span class="s">&quot;procinfo&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_queue</span><span class="p">,</span> <span class="s">&quot;queue&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_intr</span><span class="p">,</span> <span class="s">&quot;interrupt&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_selection</span><span class="p">,</span> <span class="s">&quot;selection&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_msgo</span><span class="p">,</span> <span class="s">&quot;message out&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_msgi</span><span class="p">,</span> <span class="s">&quot;message in&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_status</span><span class="p">,</span> <span class="s">&quot;status&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_cmd</span><span class="p">,</span> <span class="s">&quot;command&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_datai</span><span class="p">,</span> <span class="s">&quot;data in&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_datao</span><span class="p">,</span> <span class="s">&quot;data out&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_eh</span><span class="p">,</span> <span class="s">&quot;eh&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_locking</span><span class="p">,</span> <span class="s">&quot;locks&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">debug_phases</span><span class="p">,</span> <span class="s">&quot;phases&quot;</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">queue status:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DO_LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISSUE_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;not yet issued commands:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ISSUE_SC</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">get_command</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;no not yet issued commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DO_UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;current command:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">get_command</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">CURRENT_SC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;no current command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DISCONNECTED_SC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;disconnected commands:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DISCONNECTED_SC</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">SCNEXT</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">get_command</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;no disconnected commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="n">get_ports</span><span class="p">(</span><span class="n">shpnt</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

<span class="cp">#if defined(AHA152X_STAT)</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;statistics:</span><span class="se">\n</span><span class="s">&quot;</span>
	        <span class="s">&quot;total commands:               %d</span><span class="se">\n</span><span class="s">&quot;</span>
	        <span class="s">&quot;disconnections:               %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;busfree with check condition: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;busfree without old command:  %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;busfree without new command:  %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;busfree without done command: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;busfree without any action:   %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;state      &quot;</span>
		<span class="s">&quot;transitions  &quot;</span>
		<span class="s">&quot;count        &quot;</span>
		<span class="s">&quot;time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">total_commands</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">disconnections</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_with_check_condition</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_old_command</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_new_command</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_done_command</span><span class="p">,</span>
		<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busfree_without_any_action</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">maxstate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%-10s %-12d %-12d %-12ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count_trans</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;aha152x_proc_info: pos=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">thislength</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;aha152x_proc_info: length=%d thislength=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">thislength</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">thislength</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;aha152x_proc_info: output too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">thislength</span> <span class="o">=</span> <span class="n">thislength</span><span class="o">&lt;</span><span class="n">length</span> <span class="o">?</span> <span class="n">thislength</span> <span class="o">:</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">debug_procinfo</span><span class="p">,</span> <span class="n">KERN_DEBUG</span> <span class="s">&quot;aha152x_proc_info: return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thislength</span><span class="p">);</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">thislength</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">?</span> <span class="n">thislength</span> <span class="o">:</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_adjust_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">BLK_BOUNCE_HIGH</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">aha152x_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="n">AHA152X_REVID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="s">&quot;aha152x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>			<span class="o">=</span> <span class="n">aha152x_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">aha152x_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">aha152x_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">aha152x_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>		<span class="o">=</span> <span class="n">aha152x_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">aha152x_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">aha152x_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>			<span class="o">=</span> <span class="n">aha152x_adjust_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if !defined(PCMCIA)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_count</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aha152x_setup</span> <span class="n">setup</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/* possible i/o addresses for the AIC-6260; default first */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x140</span> <span class="p">};</span>

<span class="cp">#if !defined(SKIP_BIOSTEST)</span>
<span class="cm">/* possible locations for the Adaptec BIOS; defaults first */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addresses</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0xdc000</span><span class="p">,</span>		<span class="cm">/* default first */</span>
	<span class="mh">0xc8000</span><span class="p">,</span>
	<span class="mh">0xcc000</span><span class="p">,</span>
	<span class="mh">0xd0000</span><span class="p">,</span>
	<span class="mh">0xd4000</span><span class="p">,</span>
	<span class="mh">0xd8000</span><span class="p">,</span>
	<span class="mh">0xe0000</span><span class="p">,</span>
	<span class="mh">0xeb800</span><span class="p">,</span>		<span class="cm">/* VTech Platinum SMP */</span>
	<span class="mh">0xf0000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* signatures for various AIC-6[23]60 based controllers.</span>
<span class="cm">   The point in detecting signatures is to avoid useless and maybe</span>
<span class="cm">   harmful probes on ports. I&#39;m not sure that all listed boards pass</span>
<span class="cm">   auto-configuration. For those which fail the BIOS signature is</span>
<span class="cm">   obsolete, because user intervention to supply the configuration is</span>
<span class="cm">   needed anyway.  May be an information whether or not the BIOS supports</span>
<span class="cm">   extended translation could be also useful here. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">signature</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signature</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig_length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">signatures</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec AHA-1520 BIOS&quot;</span><span class="p">,</span>	<span class="mh">0x102e</span><span class="p">,</span> <span class="mi">21</span> <span class="p">},</span>
		<span class="cm">/* Adaptec 152x */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec AHA-1520B&quot;</span><span class="p">,</span>		<span class="mh">0x000b</span><span class="p">,</span> <span class="mi">17</span> <span class="p">},</span>
		<span class="cm">/* Adaptec 152x rev B */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec AHA-1520B&quot;</span><span class="p">,</span>		<span class="mh">0x0026</span><span class="p">,</span> <span class="mi">17</span> <span class="p">},</span>
		<span class="cm">/* Iomega Jaz Jet ISA (AIC6370Q) */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec ASW-B626 BIOS&quot;</span><span class="p">,</span>	<span class="mh">0x1029</span><span class="p">,</span> <span class="mi">21</span> <span class="p">},</span>
		<span class="cm">/* on-board controller */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec BIOS: ASW-B626&quot;</span><span class="p">,</span>	<span class="mh">0x000f</span><span class="p">,</span> <span class="mi">22</span> <span class="p">},</span>
		<span class="cm">/* on-board controller */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec ASW-B626 S2&quot;</span><span class="p">,</span>	<span class="mh">0x2e6c</span><span class="p">,</span> <span class="mi">19</span> <span class="p">},</span>
		<span class="cm">/* on-board controller */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec BIOS:AIC-6360&quot;</span><span class="p">,</span>	<span class="mh">0x000c</span><span class="p">,</span> <span class="mi">21</span> <span class="p">},</span>
		<span class="cm">/* on-board controller */</span>
	<span class="p">{</span> <span class="s">&quot;ScsiPro SP-360 BIOS&quot;</span><span class="p">,</span>	<span class="mh">0x2873</span><span class="p">,</span> <span class="mi">19</span> <span class="p">},</span>
		<span class="cm">/* ScsiPro-Controller  */</span>
	<span class="p">{</span> <span class="s">&quot;GA-400 LOCAL BUS SCSI BIOS&quot;</span><span class="p">,</span> <span class="mh">0x102e</span><span class="p">,</span> <span class="mi">26</span> <span class="p">},</span>
		<span class="cm">/* Gigabyte Local-Bus-SCSI */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec BIOS:AVA-282X&quot;</span><span class="p">,</span>	<span class="mh">0x000c</span><span class="p">,</span> <span class="mi">21</span> <span class="p">},</span>
		<span class="cm">/* Adaptec 282x */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec IBM Dock II SCSI&quot;</span><span class="p">,</span>   <span class="mh">0x2edd</span><span class="p">,</span> <span class="mi">24</span> <span class="p">},</span>
		<span class="cm">/* IBM Thinkpad Dock II */</span>
	<span class="p">{</span> <span class="s">&quot;Adaptec BIOS:AHA-1532P&quot;</span><span class="p">,</span>     <span class="mh">0x001c</span><span class="p">,</span> <span class="mi">22</span> <span class="p">},</span>
		<span class="cm">/* IBM Thinkpad Dock II SCSI */</span>
	<span class="p">{</span> <span class="s">&quot;DTC3520A Host Adapter BIOS&quot;</span><span class="p">,</span> <span class="mh">0x318a</span><span class="p">,</span> <span class="mi">26</span> <span class="p">},</span>
		<span class="cm">/* DTC 3520A ISA SCSI */</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* !SKIP_BIOSTEST */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Test, if port_base is valid.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aha152x_porttest</span><span class="p">(</span><span class="kt">int</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_DMACNTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* reset stack pointer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_STACK</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_DMACNTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* reset stack pointer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_STACK</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc1550_porttest</span><span class="p">(</span><span class="kt">int</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_TC_DMACNTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* reset stack pointer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_STACK</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">SETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_TC_DMACNTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* reset stack pointer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">O_TC_STACK</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">checksetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">aha152x_setup</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">!=</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ports</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">,</span> <span class="s">&quot;aha152x&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: io port 0x%x busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">aha152x_porttest</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">tc1550</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">tc1550_porttest</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">tc1550</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">release_region</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">IRQ_MIN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="n">IRQ_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">scsiid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">scsiid</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">synchronous</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">synchronous</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">ext_trans</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">ext_trans</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aha152x_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ok</span><span class="p">;</span>
<span class="cp">#if defined(AUTOCONF)</span>
	<span class="n">aha152x_config</span> <span class="n">conf</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pnpdev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">setup_count</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x: processing commandline: &quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">setup_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checksetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">aha152x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conf</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: invalid line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if defined(SETUP0)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aha152x_setup</span> <span class="n">override</span> <span class="o">=</span> <span class="n">SETUP0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">override</span><span class="p">.</span><span class="n">io_port</span> <span class="o">!=</span> <span class="n">setup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">io_port</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checksetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">override</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">aha152x: invalid override SETUP0={0x%x,%d,%d,%d,%d,%d,%d,%d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">io_port</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">scsiid</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">reconnect</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">parity</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">synchronous</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">delay</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">ext_trans</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">override</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SETUP1)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aha152x_setup</span> <span class="n">override</span> <span class="o">=</span> <span class="n">SETUP1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">override</span><span class="p">.</span><span class="n">io_port</span> <span class="o">!=</span> <span class="n">setup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">io_port</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checksetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">override</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">aha152x: invalid override SETUP1={0x%x,%d,%d,%d,%d,%d,%d,%d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">io_port</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">scsiid</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">reconnect</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">parity</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">synchronous</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">delay</span><span class="p">,</span>
				       <span class="n">override</span><span class="p">.</span><span class="n">ext_trans</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">override</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aha152x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">aha152x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">conf</span>        <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span>     <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>         <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">aha152x</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="cp">#endif</span>
	  	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>  <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>     <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="n">scsiid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="n">reconnect</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="n">parity</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">sync</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="n">exttrans</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">debug</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

          	<span class="k">if</span> <span class="p">(</span><span class="n">checksetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">]))</span>
			<span class="n">setup_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: invalid module params io=0x%x, irq=%d,scsiid=%d,reconnect=%d,parity=%d,sync=%d,delay=%d,exttrans=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">aha152x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">aha152x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">conf</span>        <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span>     <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>         <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">aha152x1</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="cp">#endif</span>
	  	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>  <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>     <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="n">scsiid</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="n">reconnect</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="n">parity</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">sync</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">delay</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	    		<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="n">exttrans</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">debug</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksetup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">]))</span>
			<span class="n">setup_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: invalid module params io=0x%x, irq=%d,scsiid=%d,reconnect=%d,parity=%d,sync=%d,delay=%d,exttrans=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span><span class="p">,</span>
			       <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">setup_count</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span> <span class="n">setup_count</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">=</span><span class="n">pnp_find_dev</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span> <span class="n">id_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="n">setup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">io_port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span>     <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>         <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">DELAY_DEFAULT</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">DEBUG_DEFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(__ISAPNP__)</span>
			<span class="n">pnpdev</span><span class="p">[</span><span class="n">setup_count</span><span class="p">]</span>            <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;aha152x: found ISAPnP adapter at io=0x%03x, irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span><span class="p">,</span> <span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">setup_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(AUTOCONF)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_count</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if !defined(SKIP_BIOSTEST)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">addresses</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ok</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">signatures</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ok</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ok</span> <span class="o">=</span> <span class="n">check_signature</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">signatures</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sig_offset</span><span class="p">,</span>
								<span class="n">signatures</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">signature</span><span class="p">,</span> <span class="n">signatures</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sig_length</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">setup_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x: BIOS test: passed, &quot;</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aha152x: &quot;</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* !SKIP_BIOSTEST */</span><span class="cp"></span>

		<span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">setup_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">setup_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">setup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">io_port</span> <span class="o">==</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">IO_RANGE</span><span class="p">,</span> <span class="s">&quot;aha152x&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: io port 0x%x busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">aha152x_porttest</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">tc1550</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">conf</span><span class="p">.</span><span class="n">cf_port</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">O_PORTA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">O_PORTB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tc1550_porttest</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">tc1550</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">conf</span><span class="p">.</span><span class="n">cf_port</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">GETPORT</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">O_TC_PORTA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">GETPORT</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">O_TC_PORTB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">IO_RANGE</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">IO_RANGE</span><span class="p">);</span>

			<span class="n">ok</span><span class="o">++</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_MIN</span> <span class="o">+</span> <span class="n">conf</span><span class="p">.</span><span class="n">cf_irq</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">cf_id</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">cf_tardisc</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span> <span class="o">=</span> <span class="o">!</span><span class="n">conf</span><span class="p">.</span><span class="n">cf_parity</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">cf_syncneg</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span> <span class="o">=</span> <span class="n">DELAY_DEFAULT</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
			<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span> <span class="o">=</span> <span class="n">DEBUG_DEFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">setup_count</span><span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;auto configuration: ok, &quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d controller(s) configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">setup_count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">setup_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">request_region</span><span class="p">(</span><span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">,</span> <span class="s">&quot;aha152x&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span> <span class="o">=</span> <span class="n">aha152x_probe_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">shpnt</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_port</span><span class="p">,</span> <span class="n">IO_RANGE</span><span class="p">);</span>
<span class="cp">#if defined(__ISAPNP__)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pnpdev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">HOSTDATA</span><span class="p">(</span><span class="n">shpnt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pnpdev</span><span class="o">=</span><span class="n">pnpdev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">pnpdev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: io port 0x%x busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_port</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#if defined(__ISAPNP__)</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">pnpdev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
			<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">pnpdev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">aha152x_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aha152x_hostdata</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aha152x_host_list</span><span class="p">,</span> <span class="n">host_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Scsi_Host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>

		<span class="n">aha152x_release</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">aha152x_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">aha152x_exit</span><span class="p">);</span>

<span class="cp">#if !defined(MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aha152x_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">setup_count</span><span class="o">&gt;=</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aha152x: you can only configure up to two controllers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">conf</span>        <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">io_port</span>     <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0x340</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">irq</span>         <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">scsiid</span>      <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">reconnect</span>   <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">parity</span>      <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">synchronous</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">delay</span>       <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">:</span> <span class="n">DELAY_DEFAULT</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">ext_trans</span>   <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(AHA152X_DEBUG)</span>
	<span class="n">setup</span><span class="p">[</span><span class="n">setup_count</span><span class="p">].</span><span class="n">debug</span>       <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">:</span> <span class="n">DEBUG_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;</span>
		       <span class="s">&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;[,&lt;DEBUG&gt;]]]]]]]]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>                                                <span class="cm">/*}*/</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;aha152x: usage: aha152x=&lt;IOBASE&gt;[,&lt;IRQ&gt;[,&lt;SCSI ID&gt;&quot;</span>
		       <span class="s">&quot;[,&lt;RECONNECT&gt;[,&lt;PARITY&gt;[,&lt;SYNCHRONOUS&gt;[,&lt;DELAY&gt;[,&lt;EXT_TRANS&gt;]]]]]]]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">setup_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;aha152x=&quot;</span><span class="p">,</span> <span class="n">aha152x_setup</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* !PCMCIA */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
