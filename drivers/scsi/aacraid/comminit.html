<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aacraid › comminit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>comminit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Adaptec AAC series RAID controller driver</span>
<span class="cm"> *	(c) Copyright 2001 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * based on the old aacraid driver that is..</span>
<span class="cm"> * Adaptec aacraid device driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2010 Adaptec, Inc.</span>
<span class="cm"> *               2010 PMC-Sierra, Inc. (aacraid@pmc-sierra.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Module Name:</span>
<span class="cm"> *  comminit.c</span>
<span class="cm"> *</span>
<span class="cm"> * Abstract: This supports the initialization of the host adapter commuication interface.</span>
<span class="cm"> *    This is a platform dependent module for the pci cyclone board.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;aacraid.h&quot;</span>

<span class="k">struct</span> <span class="n">aac_common</span> <span class="n">aac_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_mod</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_alloc_comm</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">commaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">commsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">commalign</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fibsize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">printfbufsiz</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_rrq_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_init</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aac_max_hostphysmempages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">==</span> <span class="n">AAC_COMM_MESSAGE_TYPE1</span><span class="p">)</span>
		<span class="n">host_rrq_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">can_queue</span>
			<span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">fibsize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_init</span><span class="p">)</span> <span class="o">+</span> <span class="n">commsize</span> <span class="o">+</span>
			<span class="n">commalign</span> <span class="o">+</span> <span class="n">printfbufsiz</span> <span class="o">+</span> <span class="n">host_rrq_size</span><span class="p">;</span>
 
	<span class="n">base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aacraid: unable to create mapping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_phys</span> <span class="o">=</span> <span class="n">phys</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">==</span> <span class="n">AAC_COMM_MESSAGE_TYPE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_rrq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="n">fibsize</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_rrq_pa</span> <span class="o">=</span> <span class="n">phys</span> <span class="o">+</span> <span class="n">fibsize</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">host_rrq_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_init</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="n">fibsize</span> <span class="o">+</span> <span class="n">host_rrq_size</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_pa</span> <span class="o">=</span> <span class="n">phys</span> <span class="o">+</span> <span class="n">fibsize</span> <span class="o">+</span> <span class="n">host_rrq_size</span><span class="p">;</span>

	<span class="n">init</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>

	<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitStructRevision</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ADAPTER_INIT_STRUCT_REVISION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_fib</span><span class="p">))</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitStructRevision</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ADAPTER_INIT_STRUCT_REVISION_4</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">MiniPortRevision</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">Sa_MINIPORT_REVISION</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">fsrev</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsrev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Adapter Fibs are the first thing allocated so that they</span>
<span class="cm">	 *	start page aligned</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">aif_base_va</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw_fib</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
	
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">AdapterFibsVirtualAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">AdapterFibsPhysicalAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">AdapterFibsSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fibsize</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">AdapterFibAlign</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_fib</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * number of 4k pages of host physical memory. The aacraid fw needs</span>
<span class="cm">	 * this number to be less than 4gb worth of pages. New firmware doesn&#39;t</span>
<span class="cm">	 * have any issues with the mapping system, but older Firmware did, and</span>
<span class="cm">	 * had *troubles* dealing with the math overloading past 32 bits, thus</span>
<span class="cm">	 * we must limit this field.</span>
<span class="cm">	 */</span>
	<span class="n">aac_max_hostphysmempages</span> <span class="o">=</span> <span class="n">dma_get_required_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_max_hostphysmempages</span> <span class="o">&lt;</span> <span class="n">AAC_MAX_HOSTPHYSMEMPAGES</span><span class="p">)</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">HostPhysMemPages</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aac_max_hostphysmempages</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">HostPhysMemPages</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AAC_MAX_HOSTPHYSMEMPAGES</span><span class="p">);</span>

	<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">==</span> <span class="n">AAC_COMM_MESSAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitFlags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">INITFLAGS_NEW_COMM_SUPPORTED</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: New Comm Interface enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">==</span> <span class="n">AAC_COMM_MESSAGE_TYPE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitStructRevision</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ADAPTER_INIT_STRUCT_REVISION_6</span><span class="p">);</span>
		<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitFlags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">INITFLAGS_NEW_COMM_TYPE1_SUPPORTED</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;aacraid: New Comm Interface type1 enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">InitFlags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">INITFLAGS_DRIVER_USES_UTC_TIME</span> <span class="o">|</span>
				       <span class="n">INITFLAGS_DRIVER_SUPPORTS_PM</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">MaxIoCommands</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">MaxIoSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">MaxFibSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span><span class="p">);</span>

	<span class="n">init</span><span class="o">-&gt;</span><span class="n">MaxNumAif</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_num_aif</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">HostRRQ_AddrHigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_rrq_pa</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">HostRRQ_AddrLow</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_rrq_pa</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Increment the base address by the amount already used</span>
<span class="cm">	 */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">fibsize</span> <span class="o">+</span> <span class="n">host_rrq_size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_init</span><span class="p">);</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">phys</span> <span class="o">+</span> <span class="n">fibsize</span> <span class="o">+</span> <span class="n">host_rrq_size</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_init</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Align the beginning of Headers to commalign</span>
<span class="cm">	 */</span>
	<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="n">commalign</span> <span class="o">-</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">commalign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">phys</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Fill in addresses of the Comm Area Headers and Queues</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">commaddr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">CommHeaderAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">phys</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Increment the base address by the size of the CommArea</span>
<span class="cm">	 */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">commsize</span><span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">phys</span> <span class="o">+</span> <span class="n">commsize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	 Place the Printf buffer area after the Fast I/O comm area.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">printfbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">printfbuf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">printfbufsiz</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">printfbufsiz</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">printfbufsiz</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
    
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aac_queue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aac_queue</span> <span class="o">*</span> <span class="n">q</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">numpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cmdready</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">cmdq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">qfull</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lockdata</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lockdata</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">.</span><span class="n">producer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">mem</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">.</span><span class="n">producer</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qsize</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">.</span><span class="n">consumer</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qsize</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="n">qsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_send_shutdown		-	shutdown an adapter</span>
<span class="cm"> *	@dev: Adapter to shutdown</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine will send a VM_CloseAll (shutdown) request to the adapter.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">aac_send_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_close</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">fibctx</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fibctx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibctx</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_close</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibctx</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_CloseAll</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			  <span class="n">fibctx</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_close</span><span class="p">),</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="o">-</span><span class="mi">2</span> <span class="cm">/* Timeout silently */</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibctx</span><span class="p">);</span>
	<span class="cm">/* FIB should be freed only after getting the response from the F/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_comm_init	-	Initialise FSA data structures</span>
<span class="cm"> *	@dev:	Adapter to initialise</span>
<span class="cm"> *</span>
<span class="cm"> *	Initializes the data structures that are required for the FSA commuication</span>
<span class="cm"> *	interface to operate. </span>
<span class="cm"> *	Returns</span>
<span class="cm"> *		1 - if we were able to init the commuication interface.</span>
<span class="cm"> *		0 - If there were errors initing. This is a fatal error.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_comm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hdrsize</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">NUMBER_OF_COMM_QUEUES</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">queuesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">TOTAL_QUEUE_ENTRIES</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">headers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_entry</span> <span class="o">*</span> <span class="n">queues</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_queue_block</span> <span class="o">*</span> <span class="n">comm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now allocate and initialize the zone structures used as our </span>
<span class="cm">	 *	pool of FIB context records.  The size of the zone is based</span>
<span class="cm">	 *	on the system memory size.  We also initialize the mutex used</span>
<span class="cm">	 *	to protect the zone.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fib_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Allocate the physically contiguous space for the commuication</span>
<span class="cm">	 *	queue headers. </span>
<span class="cm">	 */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">hdrsize</span> <span class="o">+</span> <span class="n">queuesize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_alloc_comm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">headers</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">QUEUE_ALIGNMENT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">queues</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_entry</span> <span class="o">*</span><span class="p">)(((</span><span class="n">ulong</span><span class="p">)</span><span class="n">headers</span><span class="p">)</span> <span class="o">+</span> <span class="n">hdrsize</span><span class="p">);</span>

	<span class="cm">/* Adapter to Host normal priority Command queue */</span> 
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormCmdQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormCmdQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HOST_NORM_CMD_ENTRIES</span><span class="p">);</span>
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">HOST_NORM_CMD_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Adapter to Host high priority command queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighCmdQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighCmdQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HOST_HIGH_CMD_ENTRIES</span><span class="p">);</span>
    
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">HOST_HIGH_CMD_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Host to adapter normal priority command queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormCmdQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormCmdQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">ADAP_NORM_CMD_ENTRIES</span><span class="p">);</span>
    
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">ADAP_NORM_CMD_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* host to adapter high priority command queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighCmdQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighCmdQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">ADAP_HIGH_CMD_ENTRIES</span><span class="p">);</span>
    
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">ADAP_HIGH_CMD_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* adapter to host normal priority response queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormRespQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormRespQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HOST_NORM_RESP_ENTRIES</span><span class="p">);</span>
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">HOST_NORM_RESP_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* adapter to host high priority response queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighRespQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighRespQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">HOST_HIGH_RESP_ENTRIES</span><span class="p">);</span>
   
	<span class="n">queues</span> <span class="o">+=</span> <span class="n">HOST_HIGH_RESP_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* host to adapter normal priority response queue */</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormRespQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormRespQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">ADAP_NORM_RESP_ENTRIES</span><span class="p">);</span>

	<span class="n">queues</span> <span class="o">+=</span> <span class="n">ADAP_NORM_RESP_ENTRIES</span><span class="p">;</span>
	<span class="n">headers</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	
	<span class="cm">/* host to adapter high priority response queue */</span> 
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighRespQueue</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">queues</span><span class="p">;</span>
	<span class="n">aac_queue_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighRespQueue</span><span class="p">],</span> <span class="n">headers</span><span class="p">,</span> <span class="n">ADAP_HIGH_RESP_ENTRIES</span><span class="p">);</span>

	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormCmdQueue</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormRespQueue</span><span class="p">].</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighCmdQueue</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighRespQueue</span><span class="p">].</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapNormRespQueue</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostNormCmdQueue</span><span class="p">].</span><span class="n">lock</span><span class="p">;</span>
	<span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">AdapHighRespQueue</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="n">comm</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">HostHighCmdQueue</span><span class="p">].</span><span class="n">lock</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="nf">aac_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">aac_sync_mode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check the preferred comm settings, defaults from template.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">management_fib_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">manage_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sync_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_fib</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span>
		<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)</span>
		<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">))</span>
			<span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">=</span> <span class="n">AAC_COMM_PRODUCER</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">aac_adapter_sync_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GET_ADAPTER_PROPERTIES</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	 		<span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00000001</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM_64</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">=</span> <span class="n">aac_sync_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_comm</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">=</span> <span class="n">AAC_COMM_MESSAGE</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM_TYPE1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* driver supports TYPE1 (Tupelo) */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">=</span> <span class="n">AAC_COMM_MESSAGE_TYPE1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM_TYPE4</span><span class="p">))</span> <span class="o">||</span>
				  <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM_TYPE3</span><span class="p">))</span> <span class="o">||</span>
				  <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">AAC_OPT_NEW_COMM_TYPE2</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/* driver doesn&#39;t support TYPE2 (Series7), TYPE3 and TYPE4 */</span>
					<span class="cm">/* switch to sync. mode */</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">=</span> <span class="n">AAC_COMM_MESSAGE_TYPE1</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">==</span> <span class="n">AAC_COMM_MESSAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aac_adapter_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aac_adapter_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
				<span class="cm">/* remap failed, go back ... */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">comm_interface</span> <span class="o">=</span> <span class="n">AAC_COMM_PRODUCER</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aac_adapter_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AAC_MIN_FOOTPRINT_SIZE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					  <span class="s">&quot;aacraid: unable to map adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">aac_adapter_sync_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GET_COMM_PREFERRED_SETTINGS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="n">status</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">status</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00000001</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	status[1] &gt;&gt; 16		maximum command size in KB</span>
<span class="cm">		 *	status[1] &amp; 0xFFFF	maximum FIB size</span>
<span class="cm">		 *	status[2] &gt;&gt; 16		maximum SG elements to driver</span>
<span class="cm">		 *	status[2] &amp; 0xFFFF	maximum SG elements from driver</span>
<span class="cm">		 *	status[3] &amp; 0xFFFF	maximum number FIBs outstanding</span>
<span class="cm">		 */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Multiple of 32 for PMC */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFE0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">-</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_num_aif</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 *	NOTE:</span>
<span class="cm">		 *	All these overrides are based on a fixed internal</span>
<span class="cm">		 *	knowledge and understanding of existing adapters,</span>
<span class="cm">		 *	acbsize should be set with caution.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acbsize</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">AAC_MAX_32BIT_SGBCOUNT</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span>
			  <span class="o">=</span> <span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)</span>
			    <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">))</span>
			     <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">AAC_NUM_IO_FIB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acbsize</span> <span class="o">==</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">81</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">-</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acbsize</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">129</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">166</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acbsize</span> <span class="o">==</span> <span class="mi">8192</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">257</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">337</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">-</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acbsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Illegal acbsize=%d ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acbsize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">numacb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numacb</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">numacb</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;numacb=%d ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numacb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Ok now init the communication subsystem</span>
<span class="cm">	 */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_queue_block</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error could not allocate comm region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aac_comm_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Initialize the list of fibs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_fib_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fib_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sync_fib_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

    

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
