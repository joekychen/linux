<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aacraid › aachba.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aachba.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Adaptec AAC series RAID controller driver</span>
<span class="cm"> *	(c) Copyright 2001 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * based on the old aacraid driver that is..</span>
<span class="cm"> * Adaptec aacraid device driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2010 Adaptec, Inc.</span>
<span class="cm"> *               2010 PMC-Sierra, Inc. (aacraid@pmc-sierra.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt; </span><span class="cm">/* For flush_kernel_dcache_page */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;aacraid.h&quot;</span>

<span class="cm">/* values for inqd_pdt: Peripheral device type in plain English */</span>
<span class="cp">#define	INQD_PDT_DA	0x00	</span><span class="cm">/* Direct-access (DISK) device */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_PROC	0x03	</span><span class="cm">/* Processor device */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_CHNGR	0x08	</span><span class="cm">/* Changer (jukebox, scsi2) */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_COMM	0x09	</span><span class="cm">/* Communication device (scsi2) */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_NOLUN2 0x1f	</span><span class="cm">/* Unknown Device (scsi2) */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_NOLUN	0x7f	</span><span class="cm">/* Logical Unit Not Present */</span><span class="cp"></span>

<span class="cp">#define	INQD_PDT_DMASK	0x1F	</span><span class="cm">/* Peripheral Device Type Mask */</span><span class="cp"></span>
<span class="cp">#define	INQD_PDT_QMASK	0xE0	</span><span class="cm">/* Peripheral Device Qualifer Mask */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	Sense codes</span>
<span class="cm"> */</span>

<span class="cp">#define SENCODE_NO_SENSE			0x00</span>
<span class="cp">#define SENCODE_END_OF_DATA			0x00</span>
<span class="cp">#define SENCODE_BECOMING_READY			0x04</span>
<span class="cp">#define SENCODE_INIT_CMD_REQUIRED		0x04</span>
<span class="cp">#define SENCODE_PARAM_LIST_LENGTH_ERROR		0x1A</span>
<span class="cp">#define SENCODE_INVALID_COMMAND			0x20</span>
<span class="cp">#define SENCODE_LBA_OUT_OF_RANGE		0x21</span>
<span class="cp">#define SENCODE_INVALID_CDB_FIELD		0x24</span>
<span class="cp">#define SENCODE_LUN_NOT_SUPPORTED		0x25</span>
<span class="cp">#define SENCODE_INVALID_PARAM_FIELD		0x26</span>
<span class="cp">#define SENCODE_PARAM_NOT_SUPPORTED		0x26</span>
<span class="cp">#define SENCODE_PARAM_VALUE_INVALID		0x26</span>
<span class="cp">#define SENCODE_RESET_OCCURRED			0x29</span>
<span class="cp">#define SENCODE_LUN_NOT_SELF_CONFIGURED_YET	0x3E</span>
<span class="cp">#define SENCODE_INQUIRY_DATA_CHANGED		0x3F</span>
<span class="cp">#define SENCODE_SAVING_PARAMS_NOT_SUPPORTED	0x39</span>
<span class="cp">#define SENCODE_DIAGNOSTIC_FAILURE		0x40</span>
<span class="cp">#define SENCODE_INTERNAL_TARGET_FAILURE		0x44</span>
<span class="cp">#define SENCODE_INVALID_MESSAGE_ERROR		0x49</span>
<span class="cp">#define SENCODE_LUN_FAILED_SELF_CONFIG		0x4c</span>
<span class="cp">#define SENCODE_OVERLAPPED_COMMAND		0x4E</span>

<span class="cm">/*</span>
<span class="cm"> *	Additional sense codes</span>
<span class="cm"> */</span>

<span class="cp">#define ASENCODE_NO_SENSE			0x00</span>
<span class="cp">#define ASENCODE_END_OF_DATA			0x05</span>
<span class="cp">#define ASENCODE_BECOMING_READY			0x01</span>
<span class="cp">#define ASENCODE_INIT_CMD_REQUIRED		0x02</span>
<span class="cp">#define ASENCODE_PARAM_LIST_LENGTH_ERROR	0x00</span>
<span class="cp">#define ASENCODE_INVALID_COMMAND		0x00</span>
<span class="cp">#define ASENCODE_LBA_OUT_OF_RANGE		0x00</span>
<span class="cp">#define ASENCODE_INVALID_CDB_FIELD		0x00</span>
<span class="cp">#define ASENCODE_LUN_NOT_SUPPORTED		0x00</span>
<span class="cp">#define ASENCODE_INVALID_PARAM_FIELD		0x00</span>
<span class="cp">#define ASENCODE_PARAM_NOT_SUPPORTED		0x01</span>
<span class="cp">#define ASENCODE_PARAM_VALUE_INVALID		0x02</span>
<span class="cp">#define ASENCODE_RESET_OCCURRED			0x00</span>
<span class="cp">#define ASENCODE_LUN_NOT_SELF_CONFIGURED_YET	0x00</span>
<span class="cp">#define ASENCODE_INQUIRY_DATA_CHANGED		0x03</span>
<span class="cp">#define ASENCODE_SAVING_PARAMS_NOT_SUPPORTED	0x00</span>
<span class="cp">#define ASENCODE_DIAGNOSTIC_FAILURE		0x80</span>
<span class="cp">#define ASENCODE_INTERNAL_TARGET_FAILURE	0x00</span>
<span class="cp">#define ASENCODE_INVALID_MESSAGE_ERROR		0x00</span>
<span class="cp">#define ASENCODE_LUN_FAILED_SELF_CONFIG		0x00</span>
<span class="cp">#define ASENCODE_OVERLAPPED_COMMAND		0x00</span>

<span class="cp">#define BYTE0(x) (unsigned char)(x)</span>
<span class="cp">#define BYTE1(x) (unsigned char)((x) &gt;&gt; 8)</span>
<span class="cp">#define BYTE2(x) (unsigned char)((x) &gt;&gt; 16)</span>
<span class="cp">#define BYTE3(x) (unsigned char)((x) &gt;&gt; 24)</span>

<span class="cm">/*------------------------------------------------------------------------------</span>
<span class="cm"> *              S T R U C T S / T Y P E D E F S</span>
<span class="cm"> *----------------------------------------------------------------------------*/</span>
<span class="cm">/* SCSI inquiry data */</span>
<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">inqd_pdt</span><span class="p">;</span>	<span class="cm">/* Peripheral qualifier | Peripheral Device Type */</span>
	<span class="n">u8</span> <span class="n">inqd_dtq</span><span class="p">;</span>	<span class="cm">/* RMB | Device Type Qualifier */</span>
	<span class="n">u8</span> <span class="n">inqd_ver</span><span class="p">;</span>	<span class="cm">/* ISO version | ECMA version | ANSI-approved version */</span>
	<span class="n">u8</span> <span class="n">inqd_rdf</span><span class="p">;</span>	<span class="cm">/* AENC | TrmIOP | Response data format */</span>
	<span class="n">u8</span> <span class="n">inqd_len</span><span class="p">;</span>	<span class="cm">/* Additional length (n-4) */</span>
	<span class="n">u8</span> <span class="n">inqd_pad1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="cm">/* Reserved - must be zero */</span>
	<span class="n">u8</span> <span class="n">inqd_pad2</span><span class="p">;</span>	<span class="cm">/* RelAdr | WBus32 | WBus16 |  Sync  | Linked |Reserved| CmdQue | SftRe */</span>
	<span class="n">u8</span> <span class="n">inqd_vid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* Vendor ID */</span>
	<span class="n">u8</span> <span class="n">inqd_pid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span><span class="cm">/* Product ID */</span>
	<span class="n">u8</span> <span class="n">inqd_prl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Product Revision Level */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *              M O D U L E   G L O B A L S</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aac_build_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmap</span><span class="o">*</span> <span class="n">sgmap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aac_build_sg64</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmap64</span><span class="o">*</span> <span class="n">psg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aac_build_sgraw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmapraw</span><span class="o">*</span> <span class="n">psg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aac_send_srb_fib</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">);</span>
<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aac_get_status_string</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *	Non dasd selection is handled entirely in aachba now</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nondasd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aac_cache</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* WCE=0 to avoid performance problems */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dacmode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">aac_msi</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">aac_commit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">startup_timeout</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">aif_timeout</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">aac_sync_mode</span><span class="p">;</span>  <span class="cm">/* Only Sync. transfer - disabled */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">aac_sync_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aac_sync_mode</span><span class="p">,</span> <span class="s">&quot;Force sync. transfer mode&quot;</span>
	<span class="s">&quot; 0=off, 1=on&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nondasd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nondasd</span><span class="p">,</span> <span class="s">&quot;Control scanning of hba for nondasd devices.&quot;</span>
	<span class="s">&quot; 0=off, 1=on&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">aac_cache</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s">&quot;Disable Queue Flush commands:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">bit 0 - Disable FUA in WRITE SCSI commands</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">bit 1 - Disable SYNCHRONIZE_CACHE SCSI command</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">bit 2 - Disable only if Battery is protecting Cache&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dacmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dacmode</span><span class="p">,</span> <span class="s">&quot;Control whether dma addressing is using 64 bit DAC.&quot;</span>
	<span class="s">&quot; 0=off, 1=on&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">aac_commit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="s">&quot;Control whether a COMMIT_CONFIG is issued to the&quot;</span>
	<span class="s">&quot; adapter for foreign arrays.</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;This is typically needed in systems that do not have a BIOS.&quot;</span>
	<span class="s">&quot; 0=off, 1=on&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="n">aac_msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="s">&quot;IRQ handling.&quot;</span>
	<span class="s">&quot; 0=PIC(default), 1=MSI, 2=MSI-X(unsupported, uses MSI)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">startup_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">startup_timeout</span><span class="p">,</span> <span class="s">&quot;The duration of time in seconds to wait for&quot;</span>
	<span class="s">&quot; adapter to have it&#39;s kernel up and</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;running. This is typically adjusted for large systems that do not&quot;</span>
	<span class="s">&quot; have a BIOS.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">aif_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aif_timeout</span><span class="p">,</span> <span class="s">&quot;The duration of time in seconds to wait for&quot;</span>
	<span class="s">&quot; applications to pick up AIFs before</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;deregistering them. This is typically adjusted for heavily burdened&quot;</span>
	<span class="s">&quot; systems.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">numacb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">numacb</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">numacb</span><span class="p">,</span> <span class="s">&quot;Request a limit to the number of adapter control&quot;</span>
	<span class="s">&quot; blocks (FIB) allocated. Valid values are 512 and down. Default is&quot;</span>
	<span class="s">&quot; to use suggestion from Firmware.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">acbsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">acbsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">acbsize</span><span class="p">,</span> <span class="s">&quot;Request a specific adapter control block (FIB)&quot;</span>
	<span class="s">&quot; size. Valid values are 512, 2048, 4096 and 8192. Default is to use&quot;</span>
	<span class="s">&quot; suggestion from Firmware.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">update_interval</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">update_interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">update_interval</span><span class="p">,</span> <span class="s">&quot;Interval in seconds between time sync&quot;</span>
	<span class="s">&quot; updates issued to adapter.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">check_interval</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">check_interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">check_interval</span><span class="p">,</span> <span class="s">&quot;Interval in seconds between adapter health&quot;</span>
	<span class="s">&quot; checks.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aac_check_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">check_reset</span><span class="p">,</span> <span class="n">aac_check_reset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">check_reset</span><span class="p">,</span> <span class="s">&quot;If adapter fails health check, reset the&quot;</span>
	<span class="s">&quot; adapter. a value of -1 forces the reset to adapters programmed to&quot;</span>
	<span class="s">&quot; ignore it.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">expose_physicals</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">expose_physicals</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">expose_physicals</span><span class="p">,</span> <span class="s">&quot;Expose physical components of the arrays.&quot;</span>
	<span class="s">&quot; -1=protect 0=off, 1=on&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aac_reset_devices</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">reset_devices</span><span class="p">,</span> <span class="n">aac_reset_devices</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset_devices</span><span class="p">,</span> <span class="s">&quot;Force an adapter reset at initialization.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">aac_wwn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">wwn</span><span class="p">,</span> <span class="n">aac_wwn</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wwn</span><span class="p">,</span> <span class="s">&quot;Select a WWN type for the arrays:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">0 - Disable</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">1 - Array Meta Data Signature (default)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\t</span><span class="s">2 - Adapter Serial Number&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aac_valid_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span><span class="n">fibptr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">scsicmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_valid_context: scsi command corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_MIDLEVEL</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">device</span> <span class="o">||</span> <span class="o">!</span><span class="n">scsi_device_online</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_valid_context: scsi device corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_get_config_status	-	check the adapter configuration</span>
<span class="cm"> *	@common: adapter to query</span>
<span class="cm"> *</span>
<span class="cm"> *	Query config status, and commit the configuration if needed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aac_get_config_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">commit_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_get_config_status</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
		<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_config_status</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_GET_CONFIG_STATUS</span><span class="p">);</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(((</span><span class="k">struct</span> <span class="n">aac_get_config_status_resp</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			    <span class="n">fibptr</span><span class="p">,</span>
			    <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_config_status</span><span class="p">),</span>
			    <span class="n">FsaNormal</span><span class="p">,</span>
			    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_get_config_status: SendFIB failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_get_config_status_resp</span> <span class="o">*</span><span class="n">reply</span>
		  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_config_status_resp</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span>
		  <span class="s">&quot;aac_get_config_status: response=%d status=%d action=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">action</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ST_OK</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CT_OK</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">action</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CFACT_PAUSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_get_config_status: Will not issue the Commit Configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Do not set XferState to zero unless receives a response from F/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="cm">/* Send a CT_COMMIT_CONFIG to enable discovery of devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">aac_commit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">commit_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">aac_commit_config</span> <span class="o">*</span> <span class="n">dinfo</span><span class="p">;</span>
			<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
			<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_commit_config</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
			<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_COMMIT_CONFIG</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
				    <span class="n">fibptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_commit_config</span><span class="p">),</span>
				    <span class="n">FsaNormal</span><span class="p">,</span>
				    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="cm">/* Do not set XferState to zero unless</span>
<span class="cm">			 * receives a response from F/W */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">aac_commit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			  <span class="s">&quot;aac_get_config_status: Foreign device configurations are being ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* FIB should be freed only after getting the response from the F/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aac_expose_phy_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">inq_data</span><span class="p">;</span>
	<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inq_data</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inq_data</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inq_data</span> <span class="o">&amp;=</span> <span class="mh">0xdf</span><span class="p">;</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_get_containers	-	list containers</span>
<span class="cm"> *	@common: adapter to probe</span>
<span class="cm"> *</span>
<span class="cm"> *	Make a list of all containers on this controller</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">aac_get_containers</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_get_container_count</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_get_container_count_resp</span> <span class="o">*</span><span class="n">dresp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maximum_num_containers</span> <span class="o">=</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_container_count</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_GET_CONTAINER_COUNT</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
		    <span class="n">fibptr</span><span class="p">,</span>
		    <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_container_count</span><span class="p">),</span>
		    <span class="n">FsaNormal</span><span class="p">,</span>
		    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dresp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_container_count_resp</span> <span class="o">*</span><span class="p">)</span><span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">maximum_num_containers</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">ContainerSwitchEntries</span><span class="p">);</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* FIB should be freed only after getting the response from the F/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maximum_num_containers</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">)</span>
		<span class="n">maximum_num_containers</span> <span class="o">=</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">;</span>
	<span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">)</span> <span class="o">*</span> <span class="n">maximum_num_containers</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsa_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span> <span class="o">=</span> <span class="n">maximum_num_containers</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">devname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">aac_probe_container</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_get_containers: SendFIB failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	If there are no more containers, then stop asking.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_container_name_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_get_name_resp</span> <span class="o">*</span> <span class="n">get_name_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">;</span>

	<span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;get_container_name_callback[cpu %d]: t = %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">get_name_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_name_resp</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="cm">/* Failure is irrelevant, using default value instead */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">get_name_reply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CT_OK</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">get_name_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">get_name_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(((</span><span class="k">struct</span> <span class="n">aac_get_name_resp</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">sp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">inq</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">d</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(((</span><span class="k">struct</span> <span class="n">inquiry_data</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">inqd_pid</span><span class="p">)];</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">sp</span><span class="o">++</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inq</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">inq</span><span class="p">.</span><span class="n">inqd_pid</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
			<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inq</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_get_container_name	-	get container name, none blocking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_get_container_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_get_name</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_name</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_READ_NAME</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(((</span><span class="k">struct</span> <span class="n">aac_get_name_resp</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
		  <span class="n">cmd_fibcontext</span><span class="p">,</span>
		  <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_name</span><span class="p">),</span>
		  <span class="n">FsaNormal</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span><span class="n">get_container_name_callback</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_get_container_name: aac_fib_send failed with status: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_probe_container_callback2</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)].</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">aac_scsi_cmd</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_aac_probe_container2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">fibptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_mount</span> <span class="o">*</span> <span class="n">dresp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_mount</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">fsa_dev_ptr</span> <span class="o">+=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">ST_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vol</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CT_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FSCS_HIDDEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* sense_key holds the current state of the spin-up */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FSCS_NOT_READY</span><span class="p">))</span>
				<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">=</span> <span class="n">NOT_READY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)</span>
				<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">=</span> <span class="n">NO_SENSE</span><span class="p">;</span>
			<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vol</span><span class="p">);</span>
			<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">size</span>
			  <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">capacity</span><span class="p">))</span> <span class="o">+</span>
			    <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">capacityhigh</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">ro</span> <span class="o">=</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FSCS_READONLY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_aac_probe_container1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_mount</span> <span class="o">*</span> <span class="n">dresp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_query_mount</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dresp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_mount</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">capacityhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ST_OK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dresp</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vol</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CT_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_aac_probe_container2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_mount</span> <span class="o">*</span><span class="p">)</span><span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_NameServe64</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FT_FILESYS</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			  <span class="n">fibptr</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_mount</span><span class="p">),</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">_aac_probe_container2</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Inherit results from VM_NameServe, if any */</span>
		<span class="n">dresp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ST_OK</span><span class="p">);</span>
		<span class="n">_aac_probe_container2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_aac_probe_container</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fibptr</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">((</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_query_mount</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>

		<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

		<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_mount</span> <span class="o">*</span><span class="p">)</span><span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_NameServe</span><span class="p">);</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
		<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FT_FILESYS</span><span class="p">);</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">callback</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			  <span class="n">fibptr</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_mount</span><span class="p">),</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">_aac_probe_container1</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Check that the command queued to the controller</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
			<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fsa_dev_ptr</span> <span class="o">+=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fsa_dev_ptr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_probe_container		-	query a logical volume</span>
<span class="cm"> *	@dev: device to query</span>
<span class="cm"> *	@cid: container identifier</span>
<span class="cm"> *</span>
<span class="cm"> *	Queries the controller about the given volume. The volume information</span>
<span class="cm"> *	is updated in the struct fsa_dev_info structure rather than returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_probe_container_callback1</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">aac_probe_container</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scsicmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsidev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scsidev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsicmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">scsidev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scsidev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span><span class="p">))</span><span class="n">aac_probe_container_callback1</span><span class="p">;</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">scsidev</span><span class="p">;</span>
	<span class="n">scsidev</span><span class="o">-&gt;</span><span class="n">sdev_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsidev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">scsidev</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_aac_probe_container</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">aac_probe_container_callback1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">scsidev</span><span class="p">)</span>
			<span class="n">schedule</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsidev</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">Status</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Local Structure to set SCSI inquiry data strings */</span>
<span class="k">struct</span> <span class="n">scsi_inq</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">vid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>         <span class="cm">/* Vendor ID */</span>
	<span class="kt">char</span> <span class="n">pid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>        <span class="cm">/* Product ID */</span>
	<span class="kt">char</span> <span class="n">prl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>         <span class="cm">/* Product Revision Level */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	InqStrCopy	-	string merge</span>
<span class="cm"> *	@a:	string to copy from</span>
<span class="cm"> *	@b:	string to copy to</span>
<span class="cm"> *</span>
<span class="cm"> *	Copy a String from one location to another</span>
<span class="cm"> *	without copying \0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inqstrcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">b</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">container_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;None&quot;</span><span class="p">,</span>
	<span class="s">&quot;Volume&quot;</span><span class="p">,</span>
	<span class="s">&quot;Mirror&quot;</span><span class="p">,</span>
	<span class="s">&quot;Stripe&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID5&quot;</span><span class="p">,</span>
	<span class="s">&quot;SSRW&quot;</span><span class="p">,</span>
	<span class="s">&quot;SSRO&quot;</span><span class="p">,</span>
	<span class="s">&quot;Morph&quot;</span><span class="p">,</span>
	<span class="s">&quot;Legacy&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID4&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID10&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID00&quot;</span><span class="p">,</span>
	<span class="s">&quot;V-MIRRORS&quot;</span><span class="p">,</span>
	<span class="s">&quot;PSEUDO R4&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID50&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID5D&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID5D0&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID1E&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID6&quot;</span><span class="p">,</span>
	<span class="s">&quot;RAID60&quot;</span><span class="p">,</span>
	<span class="s">&quot;Unknown&quot;</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span> <span class="nf">get_container_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">tindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tindex</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">container_types</span><span class="p">))</span>
		<span class="n">tindex</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">container_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">container_types</span><span class="p">[</span><span class="n">tindex</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Function: setinqstr</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments: [1] pointer to void [1] int</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Sets SCSI inquiry data strings for vendor, product</span>
<span class="cm"> * and revision level. Allows strings to be set in platform dependent</span>
<span class="cm"> * files instead of in OS dependent driver source.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setinqstr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tindex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_inq</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_inq</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="p">);</span> <span class="cm">/* cast data to scsi inq block */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;O&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">))</span>
			<span class="n">inqstrcpy</span><span class="p">(</span><span class="s">&quot;SMC&quot;</span><span class="p">,</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">c</span><span class="p">)</span>
				<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">inqstrcpy</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">,</span>
				   <span class="n">str</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">);</span>
			<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
				<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="cm">/* last six chars reserved for vol type */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)];</span>
			<span class="n">cp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inqstrcpy</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="n">cp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_driver_ident</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">aac_get_driver_ident</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">);</span>

		<span class="n">inqstrcpy</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">vname</span><span class="p">,</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">vid</span><span class="p">);</span>
		<span class="cm">/* last six chars reserved for vol type */</span>
		<span class="n">inqstrcpy</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tindex</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">container_types</span><span class="p">)){</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">findit</span> <span class="o">=</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">*</span><span class="n">findit</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="n">findit</span><span class="o">++</span><span class="p">);</span> <span class="cm">/* walk till we find a space */</span>
		<span class="cm">/* RAID is superfluous in the context of a RAID device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">findit</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;RAID&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">findit</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">findit</span> <span class="o">-</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">container_types</span><span class="p">[</span><span class="n">tindex</span><span class="p">]))</span>
		 <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="o">-&gt;</span><span class="n">prl</span><span class="p">)))</span>
			<span class="n">inqstrcpy</span> <span class="p">(</span><span class="n">container_types</span><span class="p">[</span><span class="n">tindex</span><span class="p">],</span> <span class="n">findit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">inqstrcpy</span> <span class="p">(</span><span class="s">&quot;V1.0&quot;</span><span class="p">,</span> <span class="n">str</span><span class="o">-&gt;</span><span class="n">prl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_container_serial_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_get_serial_resp</span> <span class="o">*</span> <span class="n">get_serial_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">get_serial_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_serial_resp</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="cm">/* Failure is irrelevant, using default value instead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">get_serial_reply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CT_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">sp</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="cm">/* EVPD bit set */</span>
		<span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INQD_PDT_DA</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sp</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">get_serial_reply</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">));</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_get_container_serial - get container serial, none blocking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_get_container_serial</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_get_serial</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">dinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_serial</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>

	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_CID_TO_32BITS_UID</span><span class="p">);</span>
	<span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
		  <span class="n">cmd_fibcontext</span><span class="p">,</span>
		  <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_get_serial</span><span class="p">),</span>
		  <span class="n">FsaNormal</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">get_container_serial_callback</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_get_container_serial: aac_fib_send failed with status: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Function: setinqserial</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments: [1] pointer to void [1] int</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Sets SCSI Unit Serial number.</span>
<span class="cm"> *          This is a fake. We should read a proper</span>
<span class="cm"> *          serial number from the container. &lt;SuSE&gt;But</span>
<span class="cm"> *          without docs it&#39;s quite hard to do it :-)</span>
<span class="cm"> *          So this will have to do in the meantime.&lt;/SuSE&gt;</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setinqserial</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *	This breaks array migration.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_inq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%08X%02X&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">sense_data</span> <span class="o">*</span><span class="n">sense_data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sense_key</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">sense_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">a_sense_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit_pointer</span><span class="p">,</span> <span class="n">u16</span> <span class="n">field_pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sense_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="cm">/* Sense data valid, err code 70h */</span>
	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span> <span class="cm">/* No info field */</span>
	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Segment number, always zero */</span>

	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense_key</span><span class="p">;</span>	<span class="cm">/* Sense key */</span>

	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">sense_code</span><span class="p">;</span>	<span class="cm">/* Additional sense code */</span>
	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_sense_code</span><span class="p">;</span>	<span class="cm">/* Additional sense code qualifier */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* Additional sense length */</span>

		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit_pointer</span><span class="p">;</span>
		<span class="cm">/* Illegal parameter is in the parameter block */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sense_code</span> <span class="o">==</span> <span class="n">SENCODE_INVALID_CDB_FIELD</span><span class="p">)</span>
			<span class="n">sense_buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xc0</span><span class="p">;</span><span class="cm">/* Std sense key specific field */</span>
		<span class="cm">/* Illegal parameter is in the CDB block */</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_pointer</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* MSB */</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_pointer</span><span class="p">;</span>		<span class="cm">/* LSB */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Additional sense length */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_bounds_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000LL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aacraid: Illegal lba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		  <span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="n">SENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span>
		  <span class="n">ASENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_bounds_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">io_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_read_raw_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_raw_io</span> <span class="o">*</span><span class="n">readcmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_raw_io</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff00000000LL</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IO_TYPE_READ</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">bpTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">bpComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aac_build_sgraw</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_raw_io</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentryraw</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerRawIo</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_read_block64</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_read64</span> <span class="o">*</span><span class="n">readcmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_read64</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_CtHostRead64</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">pad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aac_build_sg64</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_read64</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry64</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand64</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_read</span> <span class="o">*</span><span class="n">readcmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_read</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_CtBlockRead</span><span class="p">);</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">aac_build_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_read</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_write_raw_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fua</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_raw_io</span> <span class="o">*</span><span class="n">writecmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_raw_io</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff00000000LL</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">fua</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cache_protected</span><span class="p">))</span> <span class="o">?</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IO_TYPE_WRITE</span><span class="o">|</span><span class="n">IO_SUREWRITE</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IO_TYPE_WRITE</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">bpTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">bpComplete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aac_build_sgraw</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_raw_io</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentryraw</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerRawIo</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_write_block64</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fua</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_write64</span> <span class="o">*</span><span class="n">writecmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_write64</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_CtHostWrite64</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">pad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aac_build_sg64</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write64</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry64</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand64</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fua</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_write</span> <span class="o">*</span><span class="n">writecmd</span><span class="p">;</span>
	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_write</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_CtBlockWrite</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">lba</span><span class="o">&amp;</span><span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* -&gt;stable is not used - it did mean which type of write */</span>

	<span class="n">aac_build_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">writecmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			  <span class="n">fib</span><span class="p">,</span>
			  <span class="n">fibsize</span><span class="p">,</span>
			  <span class="n">FsaNormal</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">io_callback</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aac_srb</span> <span class="o">*</span> <span class="nf">aac_scsi_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_srb</span> <span class="o">*</span> <span class="n">srbcmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="n">flag</span> <span class="o">=</span> <span class="n">SRB_DataOut</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:
		<span class="n">flag</span> <span class="o">=</span> <span class="n">SRB_DataIn</span> <span class="o">|</span> <span class="n">SRB_DataOut</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
		<span class="n">flag</span> <span class="o">=</span> <span class="n">SRB_DataIn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_NONE</span>:
	<span class="nl">default:</span>	<span class="cm">/* shuts up some versions of gcc */</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">SRB_NoDataXfer</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srbcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_srb</span><span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fib</span><span class="p">);</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SRBF_ExecuteScsi</span><span class="p">);</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">channel</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aac_logical_to_phys</span><span class="p">(</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">cmd</span><span class="p">)));</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">id</span>       <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">lun</span>      <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">timeout</span>  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>  <span class="c1">// timeout in seconds</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">retry_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Obsolete parameter */</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">srbcmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">aac_srb_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_scsi_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_srb</span> <span class="o">*</span> <span class="n">srbcmd</span> <span class="o">=</span> <span class="n">aac_scsi_common</span><span class="p">(</span><span class="n">fib</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">aac_build_sg64</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgmap64</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Build Scatter/Gather list</span>
<span class="cm">	 */</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_srb</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span>
		 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry64</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ScsiPortCommand64</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span>
				<span class="n">fibsize</span><span class="p">,</span> <span class="n">FsaNormal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">aac_srb_callback</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_scsi_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fibsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_srb</span> <span class="o">*</span> <span class="n">srbcmd</span> <span class="o">=</span> <span class="n">aac_scsi_common</span><span class="p">(</span><span class="n">fib</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">aac_build_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgmap</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Build Scatter/Gather list</span>
<span class="cm">	 */</span>
	<span class="n">fibsize</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_srb</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbcmd</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		 <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">));</span>
	<span class="n">BUG_ON</span> <span class="p">(</span><span class="n">fibsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ScsiPortCommand</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="n">fibsize</span><span class="p">,</span> <span class="n">FsaNormal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span> <span class="n">aac_srb_callback</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_scsi_32_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">needs_dac</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_SGMAP_HOST64</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aac_scsi_32</span><span class="p">(</span><span class="n">fib</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">aac_get_adapter_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib</span><span class="o">*</span> <span class="n">fibptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_adapter_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_bus_info</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_bus_info_response</span> <span class="o">*</span><span class="n">bus_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_adapter_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="n">rcode</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">RequestAdapterInfo</span><span class="p">,</span>
			 <span class="n">fibptr</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span>
			 <span class="n">FsaNormal</span><span class="p">,</span>
			 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* First `interrupt&#39; command uses special wait */</span>
			 <span class="nb">NULL</span><span class="p">,</span>
			 <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIB should be freed only after</span>
<span class="cm">		 * getting the response from the F/W */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
			<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_SUPPLEMENT_ADAPTER_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">aac_supplement_adapter_info</span> <span class="o">*</span> <span class="n">sinfo</span><span class="p">;</span>

		<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

		<span class="n">sinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_supplement_adapter_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">sinfo</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sinfo</span><span class="p">));</span>

		<span class="n">rcode</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">RequestSupplementAdapterInfo</span><span class="p">,</span>
				 <span class="n">fibptr</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sinfo</span><span class="p">),</span>
				 <span class="n">FsaNormal</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">,</span>
				 <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sinfo</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fibptr</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fibptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * GetBusInfo</span>
<span class="cm">	 */</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">bus_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_bus_info_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bus_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus_info</span><span class="p">));</span>

	<span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_bus_info</span> <span class="o">*</span><span class="p">)</span><span class="n">bus_info</span><span class="p">;</span>

	<span class="n">command</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_Ioctl</span><span class="p">);</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">ObjType</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FT_DRIVE</span><span class="p">);</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">MethodId</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">command</span><span class="o">-&gt;</span><span class="n">CtlCmd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">GetBusInfo</span><span class="p">);</span>

	<span class="n">rcode</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
			 <span class="n">fibptr</span><span class="p">,</span>
			 <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">bus_info</span><span class="p">),</span>
			 <span class="n">FsaNormal</span><span class="p">,</span>
			 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* reasoned default */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_physicals</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bus_info</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">)</span> <span class="o">==</span> <span class="n">ST_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_physicals</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bus_info</span><span class="o">-&gt;</span><span class="n">TargetsPerBus</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_channels</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bus_info</span><span class="o">-&gt;</span><span class="n">BusCount</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">kernelrev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: kernel %d.%d-%d[%d] %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span>
			<span class="n">tmp</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">kernelbuild</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">BuildDate</span><span class="p">),</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">BuildDate</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">monitorrev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: monitor %d.%d-%d[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">,(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span><span class="n">tmp</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">monitorbuild</span><span class="p">));</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">biosrev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: bios %d.%d-%d[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">,(</span><span class="n">tmp</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span><span class="n">tmp</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">biosbuild</span><span class="p">));</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aac_get_serial_number</span><span class="p">(</span>
		  <span class="n">shost_to_class</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="p">),</span> <span class="n">buffer</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: serial %s&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">VpdInfo</span><span class="p">.</span><span class="n">Tsid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: TSID %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">VpdInfo</span><span class="p">.</span><span class="n">Tsid</span><span class="p">),</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">VpdInfo</span><span class="p">.</span><span class="n">Tsid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_check_reset</span> <span class="o">||</span> <span class="p">((</span><span class="n">aac_check_reset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
		  <span class="n">AAC_OPTION_IGNORE_RESET</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: Reset Adapter Ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cache_protected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">jbod</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">FeatureBits</span> <span class="o">&amp;</span>
		<span class="n">AAC_FEATURE_JBOD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_NONDASD</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the firmware supports ROMB RAID/SCSI mode and we are currently</span>
<span class="cm">	 * in RAID/SCSI mode, set the flag. For now if in this mode we will</span>
<span class="cm">	 * force nondasd support on. If we decide to allow the non-dasd flag</span>
<span class="cm">	 * additional changes changes will have to be made to support</span>
<span class="cm">	 * RAID/SCSI.  the function aac_scsi_cmd in this module will have to be</span>
<span class="cm">	 * changed to support the new dev-&gt;raid_scsi_mode flag instead of</span>
<span class="cm">	 * leaching off of the dev-&gt;nondasd_support flag. Also in linit.c the</span>
<span class="cm">	 * function aac_detect will have to be modified where it sets up the</span>
<span class="cm">	 * max number of channels based on the aac-&gt;nondasd_support flag only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_SCSI_MANAGED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_RAID_SCSI_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: ROMB RAID/SCSI mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nondasd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">=</span> <span class="p">(</span><span class="n">nondasd</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: Non-DASD support enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_get_required_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">needs_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">needs_dac</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_SGMAP_HOST64</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: 64bit support enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dacmode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">=</span> <span class="p">(</span><span class="n">dacmode</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* avoid problems with AAC_QUIRK_SCSI_32 controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">&amp;&amp;</span>	<span class="p">(</span><span class="n">aac_get_driver_ident</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">quirks</span>
		<span class="o">&amp;</span> <span class="n">AAC_QUIRK_SCSI_32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">jbod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">expose_physicals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s%d: 64 Bit DAC enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s%d: DMA mask set failed, 64 Bit DAC disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s%d: No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Deal with configuring for the individualized limits of each packet</span>
<span class="cm">	 * interface.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_scsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span><span class="p">)</span>
	  <span class="o">?</span> <span class="p">((</span><span class="n">aac_get_driver_ident</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_SCSI_32</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">aac_scsi_32_64</span>
				<span class="o">:</span> <span class="n">aac_scsi_64</span><span class="p">)</span>
				<span class="o">:</span> <span class="n">aac_scsi_32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">aac_bounds_64</span>
					<span class="o">:</span> <span class="n">aac_bounds_32</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_read</span> <span class="o">=</span> <span class="n">aac_read_raw_io</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_write</span> <span class="o">=</span> <span class="n">aac_write_raw_io</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_bounds</span> <span class="o">=</span> <span class="n">aac_bounds_32</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">))</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dac_support</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_read</span> <span class="o">=</span> <span class="n">aac_read_block64</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_write</span> <span class="o">=</span> <span class="n">aac_write_block64</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * 38 scatter gather elements</span>
<span class="cm">			 */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fib_size</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_fibhdr</span><span class="p">)</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_write64</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry64</span><span class="p">))</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgentry64</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_read</span> <span class="o">=</span> <span class="n">aac_read_block</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="p">.</span><span class="n">adapter_write</span> <span class="o">=</span> <span class="n">aac_write_block</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">AAC_MAX_32BIT_SGBCOUNT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_NEW_COMM_TYPE1</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">AAC_OPT_NEW_COMM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_NEW_COMM</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Worst case size that could cause sg overflow when</span>
<span class="cm">			 * we break up SG elements that are larger than 64KB.</span>
<span class="cm">			 * Would be nice if we could tell the SCSI layer what</span>
<span class="cm">			 * the maximum SG element size can be. Worst case is</span>
<span class="cm">			 * (sg_tablesize-1) 4KB elements with one 64KB</span>
<span class="cm">			 * element.</span>
<span class="cm">			 *	32bit -&gt; 468 or 238KB	64bit -&gt; 424 or 212KB</span>
<span class="cm">			 */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span>
			  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">112</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* FIB should be freed only after getting the response from the F/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
		<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">io_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_read_reply</span> <span class="o">*</span><span class="n">readreply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">fibptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nblank</span><span class="p">(</span><span class="n">dprintk</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">lba</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WRITE_6</span>:
		<span class="k">case</span> <span class="n">READ_6</span>:
			<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITE_16</span>:
		<span class="k">case</span> <span class="n">READ_16</span>:
			<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITE_12</span>:
		<span class="k">case</span> <span class="n">READ_12</span>:
			<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		  <span class="s">&quot;io_callback[cpu %d]: lba = %llu, t = %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">lba</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="n">readreply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_read_reply</span> <span class="o">*</span><span class="p">)</span><span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readreply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ST_OK</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">=</span> <span class="n">NO_SENSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_NOT_READY</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span> <span class="n">NOT_READY</span><span class="p">,</span>
		  <span class="n">SENCODE_BECOMING_READY</span><span class="p">,</span> <span class="n">ASENCODE_BECOMING_READY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;io_callback: io failed, status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readreply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		  <span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="n">SENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span>
		  <span class="n">ASENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Get block address and transfer length</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a read(6) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_16</span>:
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a read(16) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span>	<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_12</span>:
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a read(12) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a read(10) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lba</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)].</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aacraid: Illegal lba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
			  <span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="n">SENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span>
			  <span class="n">ASENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aac_read[cpu %d]: lba = %llu, t = %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">lba</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_adapter_bounds</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">scsicmd</span><span class="p">,</span><span class="n">lba</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Alocate and initialize a Fib</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_read: fib allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_adapter_read</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">,</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_read: aac_fib_send failed with status: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	For some reason, the Fib didn&#39;t queue, return QUEUE_FULL</span>
<span class="cm">	 */</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">;</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fua</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Get block address and transfer length</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span>	<span class="cm">/* 6 byte command */</span>
	<span class="p">{</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">fua</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_16</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 16 byte command */</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a write(16) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span>	<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">fua</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_12</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 12 byte command */</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a write(12) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		      <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">fua</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aachba: received a write(10) command on id %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)));</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">fua</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lba</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)].</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aacraid: Illegal lba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
			  <span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="n">SENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span>
			  <span class="n">ASENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aac_write[cpu %d]: lba = %llu, t = %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">lba</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_adapter_bounds</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">scsicmd</span><span class="p">,</span><span class="n">lba</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Allocate and initialize a Fib then setup a BlockWrite command</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* FIB temporarily unavailable,not catastrophic failure */</span>

		<span class="cm">/* scsicmd-&gt;result = DID_ERROR &lt;&lt; 16;</span>
<span class="cm">		 * scsicmd-&gt;scsi_done(scsicmd);</span>
<span class="cm">		 * return 0;</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_write: fib allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_adapter_write</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">,</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">fua</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_write: aac_fib_send failed with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	For some reason, the Fib didn&#39;t queue, return QUEUE_FULL</span>
<span class="cm">	 */</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">;</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synchronize_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span><span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_synchronize_reply</span> <span class="o">*</span><span class="n">synchronizereply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;synchronize_callback[cpu %d]: t = %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>


	<span class="n">synchronizereply</span> <span class="o">=</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">synchronizereply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CT_OK</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fibptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">sdev_id</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		     <span class="s">&quot;synchronize_callback: synchronize failed, status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">synchronizereply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		  <span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="n">SENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span>
		  <span class="n">ASENCODE_INTERNAL_TARGET_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_synchronize</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span><span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_synchronize</span> <span class="o">*</span><span class="n">synchronizecmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for all outstanding queued commands to complete to this</span>
<span class="cm">	 * specific target (block).</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">cmnd_lba</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cmnd_count</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmnd_lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">cmnd_count</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmnd_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">cmnd_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmnd_lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
				<span class="n">cmnd_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmnd_lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="n">cmnd_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmnd_lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="n">cmnd_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">cmnd_lba</span> <span class="o">+</span> <span class="n">cmnd_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lba</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">lba</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cmnd_lba</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">++</span><span class="n">active</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Yield the processor (requeue for later)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_DEVICE_BUSY</span><span class="p">;</span>

	<span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Allocate and initialize a Fib</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">aac</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>

	<span class="n">synchronizecmd</span> <span class="o">=</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">synchronizecmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
	<span class="n">synchronizecmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_FLUSH_CACHE</span><span class="p">);</span>
	<span class="n">synchronizecmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
	<span class="n">synchronizecmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span>
	     <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(((</span><span class="k">struct</span> <span class="n">aac_synchronize_reply</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
		  <span class="n">cmd_fibcontext</span><span class="p">,</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_synchronize</span><span class="p">),</span>
		  <span class="n">FsaNormal</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span><span class="n">synchronize_callback</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		<span class="s">&quot;aac_synchronize: aac_fib_send failed with status: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aac_start_stop_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span><span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span><span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_power_management</span> <span class="o">*</span><span class="n">pmcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
	      <span class="n">AAC_OPTION_POWER_MANAGEMENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				  <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Allocate and initialize a Fib</span>
<span class="cm">	 */</span>
	<span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_fibcontext</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="n">aac_fib_init</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>

	<span class="n">pmcmd</span> <span class="o">=</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">pmcmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">VM_ContainerConfig</span><span class="p">);</span>
	<span class="n">pmcmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_POWER_MANAGEMENT</span><span class="p">);</span>
	<span class="cm">/* Eject bit ignored, not relevant */</span>
	<span class="n">pmcmd</span><span class="o">-&gt;</span><span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_PM_START_UNIT</span><span class="p">)</span> <span class="o">:</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_PM_STOP_UNIT</span><span class="p">);</span>
	<span class="n">pmcmd</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sdev_id</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>
	<span class="n">pmcmd</span><span class="o">-&gt;</span><span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CT_PM_UNIT_IMMEDIATE</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now send the Fib to the adapter</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_fib_send</span><span class="p">(</span><span class="n">ContainerCommand</span><span class="p">,</span>
		  <span class="n">cmd_fibcontext</span><span class="p">,</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_power_management</span><span class="p">),</span>
		  <span class="n">FsaNormal</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">fib_callback</span><span class="p">)</span><span class="n">aac_start_stop_callback</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_scsi_cmd()		-	Process SCSI command</span>
<span class="cm"> *	@scsicmd:		SCSI command block</span>
<span class="cm"> *</span>
<span class="cm"> *	Emulate a SCSI command and queue the required request for the</span>
<span class="cm"> *	aacraid firmware.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">aac_scsi_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	If the bus, id or lun is out of range, return fail</span>
<span class="cm">	 *	Test does not apply to ID 16, the pseudo id for the controller</span>
<span class="cm">	 *	itself.</span>
<span class="cm">	 */</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">cid</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 *	If the target container doesn&#39;t exist, it may have</span>
<span class="cm">			 *	been newly created</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span>
			   <span class="n">NOT_READY</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span><span class="p">)</span> <span class="o">||</span>
					    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAI_READ_CAPACITY_16</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">INQUIRY</span>:
				<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
				<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">_aac_probe_container</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span>
							<span class="n">aac_probe_container_callback2</span><span class="p">);</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* check for physical non-dasd devices */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">||</span> <span class="n">expose_physicals</span> <span class="o">||</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">jbod</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">aac_send_srb_fib</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * else Command for the controller itself</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* only INQUIRY &amp; TUR cmnd supported for controller */</span>
		<span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Only INQUIRY &amp; TUR command supported for controller, rcvd = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		  <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">SENCODE_INVALID_COMMAND</span><span class="p">,</span>
		  <span class="n">ASENCODE_INVALID_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
			     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Handle commands here that don&#39;t really require going out to the adapter */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">inq_data</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;INQUIRY command, ID: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inquiry_data</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">aac_wwn</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">inq_data</span><span class="p">;</span>

			<span class="cm">/* EVPD bit set */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">)</span> <span class="o">?</span>
			  <span class="n">INQD_PDT_PROC</span> <span class="o">:</span> <span class="n">INQD_PDT_DA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* supported vital product data pages */</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				  <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* unit serial number page */</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">setinqserial</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				  <span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aac_wwn</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">aac_get_container_serial</span><span class="p">(</span>
						<span class="n">scsicmd</span><span class="p">);</span>
				<span class="cm">/* SLES 10 SP1 special */</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				  <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* vpd page not implemented */</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				  <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				  <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
				<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
				  <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">SENCODE_INVALID_CDB_FIELD</span><span class="p">,</span>
				  <span class="n">ASENCODE_NO_SENSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
				  <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
					<span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* claim compliance to SCSI-2 */</span>
		<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_rdf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* A response data format value of two indicates that the data shall be in the format specified in SCSI-2 */</span>
		<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_len</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="cm">/*Format for &quot;pad2&quot; is  RelAdr | WBus32 | WBus16 |  Sync  | Linked |Reserved| CmdQue | SftRe */</span>
		<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_pad2</span><span class="o">=</span> <span class="mh">0x32</span> <span class="p">;</span>	 <span class="cm">/*WBus16|Sync|CmdQue */</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Set the Vendor, Product, and Revision Level</span>
<span class="cm">		 *	see: &lt;vendor&gt;.c i.e. aac.c</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setinqstr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_vid</span><span class="p">),</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">container_types</span><span class="p">));</span>
			<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_pdt</span> <span class="o">=</span> <span class="n">INQD_PDT_PROC</span><span class="p">;</span>	<span class="cm">/* Processor device */</span>
			<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">setinqstr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_vid</span><span class="p">),</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="n">inq_data</span><span class="p">.</span><span class="n">inqd_pdt</span> <span class="o">=</span> <span class="n">INQD_PDT_DA</span><span class="p">;</span>	<span class="cm">/* Direct/random access device */</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inq_data</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">aac_get_container_name</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAI_READ_CAPACITY_16</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="n">u64</span> <span class="n">capacity</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">cp</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_len</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;READ CAPACITY_16 command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">capacity</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">alloc_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
			     <span class="o">+</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			     <span class="o">+</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>

		<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">&lt;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">))</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span>
				       <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">alloc_len</span><span class="p">);</span>

		<span class="cm">/* Do not cache partition table for arrays */</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">removable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">capacity</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">cp</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;READ CAPACITY command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mh">0x100000000ULL</span><span class="p">)</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
		<span class="cm">/* Do not cache partition table for arrays */</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">removable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
		  <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">mode_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">mode_buf_length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;MODE SENSE command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Mode data length */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Medium type - default */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Device-specific param,</span>
<span class="cm">					   bit 8: 0/1 = write enabled/protected</span>
<span class="cm">					   bit 4: 0/1 = FUA enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Block descriptor length */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* WCE */</span>
			<span class="n">mode_buf_length</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode_buf_length</span> <span class="o">&gt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
				<span class="n">mode_buf_length</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">mode_buf</span><span class="p">,</span> <span class="n">mode_buf_length</span><span class="p">);</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">mode_buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">mode_buf_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;MODE SENSE 10 byte command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Mode data length (MSB) */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Mode data length (LSB) */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Medium type - default */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Device-specific param,</span>
<span class="cm">					   bit 8: 0/1 = write enabled/protected</span>
<span class="cm">					   bit 4: 0/1 = FUA enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Block descriptor length (MSB) */</span>
		<span class="n">mode_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Block descriptor length (LSB) */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mode_buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* WCE */</span>
			<span class="n">mode_buf_length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode_buf_length</span> <span class="o">&gt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
				<span class="n">mode_buf_length</span> <span class="o">=</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">mode_buf</span><span class="p">,</span> <span class="n">mode_buf_length</span><span class="p">);</span>

		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;REQUEST SENSE command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sense_data</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sense_data</span><span class="p">));</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;LOCK command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
			<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	These commands are all No-Ops</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				<span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
			<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
				  <span class="n">NOT_READY</span><span class="p">,</span> <span class="n">SENCODE_BECOMING_READY</span><span class="p">,</span>
				  <span class="n">ASENCODE_BECOMING_READY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
			       <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
				     <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FALLTHRU */</span>
	<span class="k">case</span> <span class="n">RESERVE</span>:
	<span class="k">case</span> <span class="n">RELEASE</span>:
	<span class="k">case</span> <span class="n">REZERO_UNIT</span>:
	<span class="k">case</span> <span class="n">REASSIGN_BLOCKS</span>:
	<span class="k">case</span> <span class="n">SEEK_10</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="k">return</span> <span class="n">aac_start_stop</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="k">case</span> <span class="n">READ_12</span>:
		<span class="k">case</span> <span class="n">READ_16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 *	Hack to keep track of ordinal number of the device that</span>
<span class="cm">			 *	corresponds to a container. Needed to convert</span>
<span class="cm">			 *	containers to /dev/sd device names</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">)</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">devname</span><span class="p">,</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span>
				<span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">devname</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

			<span class="k">return</span> <span class="n">aac_read</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">WRITE_6</span>:
		<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="k">case</span> <span class="n">WRITE_12</span>:
		<span class="k">case</span> <span class="n">WRITE_16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">aac_write</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
			<span class="k">if</span> <span class="p">(((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cache_protected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					<span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Issue FIB to tell Firmware to flush it&#39;s cache */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">aac_cache</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">aac_synchronize</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="cm">/* FALLTHRU */</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 *	Unhandled commands</span>
<span class="cm">			 */</span>
			<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unhandled SCSI Command: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
			<span class="n">set_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
			  <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">SENCODE_INVALID_COMMAND</span><span class="p">,</span>
			  <span class="n">ASENCODE_INVALID_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">,</span>
				<span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">sense_data</span><span class="p">),</span>
				      <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">query_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_query_disk</span> <span class="n">qd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">;</span>

	<span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsa_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_disk</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">=</span> <span class="n">qd</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">qd</span><span class="p">.</span><span class="n">bus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">lun</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">qd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">CONTAINER_TO_ID</span><span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">);</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">lun</span> <span class="o">=</span> <span class="n">CONTAINER_TO_LUN</span><span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">qd</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">valid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qd</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">locked</span><span class="p">;</span>
	<span class="n">qd</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">deleted</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">devname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">unmapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qd</span><span class="p">.</span><span class="n">unmapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">devname</span><span class="p">,</span>
	  <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">qd</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">qd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">devname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qd</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_query_disk</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">force_delete_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_delete_disk</span> <span class="n">dd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">;</span>

	<span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsa_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_delete_disk</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Mark this container as being deleted.</span>
<span class="cm">	 */</span>
	<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Mark the container as no longer valid</span>
<span class="cm">	 */</span>
	<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">delete_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_delete_disk</span> <span class="n">dd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsa_dev_info</span> <span class="o">*</span><span class="n">fsa_dev_ptr</span><span class="p">;</span>

	<span class="n">fsa_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsa_dev_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_delete_disk</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	If the container is locked, it can not be deleted by the API.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">locked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	Mark the container as no longer being valid.</span>
<span class="cm">		 */</span>
		<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fsa_dev_ptr</span><span class="p">[</span><span class="n">dd</span><span class="p">.</span><span class="n">cnum</span><span class="p">].</span><span class="n">devname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">aac_dev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSACTL_QUERY_DISK</span>:
		<span class="k">return</span> <span class="n">query_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FSACTL_DELETE_DISK</span>:
		<span class="k">return</span> <span class="n">delete_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FSACTL_FORCE_DELETE_DISK</span>:
		<span class="k">return</span> <span class="n">force_delete_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FSACTL_GET_CONTAINERS</span>:
		<span class="k">return</span> <span class="n">aac_get_containers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * aac_srb_callback</span>
<span class="cm"> * @context: the context set in the fib - here it is scsi cmd</span>
<span class="cm"> * @fibptr: pointer to the fib</span>
<span class="cm"> *</span>
<span class="cm"> * Handles the completion of a scsi command to a non dasd device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aac_srb_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fibptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_srb_reply</span> <span class="o">*</span><span class="n">srbreply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">;</span>

	<span class="n">scsicmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac_valid_context</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">fibptr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fibptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">fibptr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">srbreply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_srb_reply</span> <span class="o">*</span><span class="p">)</span> <span class="n">fib_data</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>

	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>  <span class="cm">/* Initialize sense valid flag to false */</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Calculate resid for sg</span>
<span class="cm">	 */</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)</span>
		       <span class="o">-</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">data_xfer_length</span><span class="p">));</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/* expose physical device if expose_physicald flag is on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
	  <span class="o">&amp;&amp;</span> <span class="n">expose_physicals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">aac_expose_phy_device</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First check the fib status</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ST_OK</span><span class="p">){</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_srb_callback: srb failed, status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">sense_data_size</span><span class="p">),</span>
			    <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next check the srb status</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">srb_status</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_ERROR_RECOVERY</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_PENDING</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_SUCCESS</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_DATA_OVERRUN</span>:
		<span class="k">switch</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
		<span class="k">case</span>  <span class="n">READ_6</span>:
		<span class="k">case</span>  <span class="n">WRITE_6</span>:
		<span class="k">case</span>  <span class="n">READ_10</span>:
		<span class="k">case</span>  <span class="n">WRITE_10</span>:
		<span class="k">case</span>  <span class="n">READ_12</span>:
		<span class="k">case</span>  <span class="n">WRITE_12</span>:
		<span class="k">case</span>  <span class="n">READ_16</span>:
		<span class="k">case</span>  <span class="n">WRITE_16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">data_xfer_length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: SCSI CMD underflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: SCSI CMD Data Overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INQUIRY</span>: <span class="p">{</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_ABORTED</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_ABORT_FAILED</span>:</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Not sure about this one - but assuming the hba was trying to abort for some reason</p></td><td class="code"><div class="highlight"><pre>		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_PARITY_ERROR</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_PARITY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">MSG_PARITY_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_NO_DEVICE</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_INVALID_PATH_ID</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_INVALID_TARGET_ID</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_INVALID_LUN</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_SELECTION_TIMEOUT</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRB_STATUS_COMMAND_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_TIMEOUT</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRB_STATUS_BUSY</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRB_STATUS_BUS_RESET</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SRB_STATUS_MESSAGE_REJECTED</span>:
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">MESSAGE_REJECT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SRB_STATUS_REQUEST_FLUSHED</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_ERROR</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_INVALID_REQUEST</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_REQUEST_SENSE_FAILED</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_NO_HBA</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_UNEXPECTED_BUS_FREE</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_PHASE_SEQUENCE_FAILURE</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_BAD_SRB_BLOCK_LENGTH</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_DELAYED_RETRY</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_BAD_FUNCTION</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_NOT_STARTED</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_NOT_IN_USE</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_FORCE_ABORT</span>:
	<span class="k">case</span> <span class="n">SRB_STATUS_DOMAIN_VALIDATION_FAIL</span>:
	<span class="nl">default:</span>
<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aacraid: SRB ERROR(%u) %s scsi cmd 0x%x - scsi status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">srb_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">,</span>
			<span class="n">aac_get_status_string</span><span class="p">(</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">srb_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">),</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ATA_12</span><span class="p">)</span>
		  <span class="o">||</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ATA_16</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
						<span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
						<span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
					<span class="o">|</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">sense_data_size</span><span class="p">),</span>
			    <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_srb_callback: check condition, status = %d len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">sense_data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * OR in the scsi status (already shifted up a bit)</span>
<span class="cm">	 */</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">srbreply</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">);</span>

	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">fibptr</span><span class="p">);</span>
	<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * aac_send_scb_fib</span>
<span class="cm"> * @scsicmd: the scsi command block</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will form a FIB and fill in the aac_srb from the</span>
<span class="cm"> * scsicmd passed in.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_send_srb_fib</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fib</span><span class="o">*</span> <span class="n">cmd_fibcontext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">maximum_num_physicals</span> <span class="o">||</span>
			<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Allocate and initialize a Fib then setup a BlockWrite command</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_fibcontext</span> <span class="o">=</span> <span class="n">aac_fib_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">aac_adapter_scsi</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">,</span> <span class="n">scsicmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check that the command queued to the controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;aac_srb: aac_fib_send failed with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">aac_fib_complete</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>
	<span class="n">aac_fib_free</span><span class="p">(</span><span class="n">cmd_fibcontext</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">aac_build_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmap</span><span class="o">*</span> <span class="n">psg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Get rid of old data</p></td><td class="code"><div class="highlight"><pre>	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nseg</span><span class="p">);</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* hba wants the size to be exact */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">byte_count</span> <span class="o">-</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">byte_count</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check for command underflow */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&lt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: cmd len %08lX cmd underflow %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">byte_count</span><span class="p">,</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">byte_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">aac_build_sg64</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmap64</span><span class="o">*</span> <span class="n">psg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Get rid of old data</p></td><td class="code"><div class="highlight"><pre>	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
			<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nseg</span><span class="p">);</span>
		<span class="cm">/* hba wants the size to be exact */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">byte_count</span> <span class="o">-</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">byte_count</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check for command underflow */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&lt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: cmd len %08lX cmd underflow %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">byte_count</span><span class="p">,</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">byte_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">aac_build_sgraw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">scsicmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgmapraw</span><span class="o">*</span> <span class="n">psg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Get rid of old data</p></td><td class="code"><div class="highlight"><pre>	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">u64</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">byte_count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">psg</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nseg</span><span class="p">);</span>
		<span class="cm">/* hba wants the size to be exact */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">byte_count</span> <span class="o">-</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">));</span>
			<span class="n">psg</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">byte_count</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsicmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check for command underflow */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">byte_count</span> <span class="o">&lt;</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;aacraid: cmd len %08lX cmd underflow %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">byte_count</span><span class="p">,</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">byte_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>

<span class="k">struct</span> <span class="n">aac_srb_status_info</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">str</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">aac_srb_status_info</span> <span class="n">srb_status_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_PENDING</span><span class="p">,</span>		<span class="s">&quot;Pending Status&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_SUCCESS</span><span class="p">,</span>		<span class="s">&quot;Success&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_ABORTED</span><span class="p">,</span>		<span class="s">&quot;Aborted Command&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_ABORT_FAILED</span><span class="p">,</span>	<span class="s">&quot;Abort Failed&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_ERROR</span><span class="p">,</span>		<span class="s">&quot;Error Event&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_BUSY</span><span class="p">,</span>		<span class="s">&quot;Device Busy&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_INVALID_REQUEST</span><span class="p">,</span>	<span class="s">&quot;Invalid Request&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_INVALID_PATH_ID</span><span class="p">,</span>	<span class="s">&quot;Invalid Path ID&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_NO_DEVICE</span><span class="p">,</span>		<span class="s">&quot;No Device&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_TIMEOUT</span><span class="p">,</span>		<span class="s">&quot;Timeout&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_SELECTION_TIMEOUT</span><span class="p">,</span>	<span class="s">&quot;Selection Timeout&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_COMMAND_TIMEOUT</span><span class="p">,</span>	<span class="s">&quot;Command Timeout&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_MESSAGE_REJECTED</span><span class="p">,</span>	<span class="s">&quot;Message Rejected&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_BUS_RESET</span><span class="p">,</span>		<span class="s">&quot;Bus Reset&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_PARITY_ERROR</span><span class="p">,</span>	<span class="s">&quot;Parity Error&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_REQUEST_SENSE_FAILED</span><span class="p">,</span><span class="s">&quot;Request Sense Failed&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_NO_HBA</span><span class="p">,</span>		<span class="s">&quot;No HBA&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_DATA_OVERRUN</span><span class="p">,</span>	<span class="s">&quot;Data Overrun/Data Underrun&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_UNEXPECTED_BUS_FREE</span><span class="p">,</span><span class="s">&quot;Unexpected Bus Free&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_PHASE_SEQUENCE_FAILURE</span><span class="p">,</span><span class="s">&quot;Phase Error&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_BAD_SRB_BLOCK_LENGTH</span><span class="p">,</span><span class="s">&quot;Bad Srb Block Length&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_REQUEST_FLUSHED</span><span class="p">,</span>	<span class="s">&quot;Request Flushed&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_DELAYED_RETRY</span><span class="p">,</span>	<span class="s">&quot;Delayed Retry&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_INVALID_LUN</span><span class="p">,</span>	<span class="s">&quot;Invalid LUN&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_INVALID_TARGET_ID</span><span class="p">,</span>	<span class="s">&quot;Invalid TARGET ID&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_BAD_FUNCTION</span><span class="p">,</span>	<span class="s">&quot;Bad Function&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_ERROR_RECOVERY</span><span class="p">,</span>	<span class="s">&quot;Error Recovery&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_NOT_STARTED</span><span class="p">,</span>	<span class="s">&quot;Not Started&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_NOT_IN_USE</span><span class="p">,</span>	<span class="s">&quot;Not In Use&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_FORCE_ABORT</span><span class="p">,</span>	<span class="s">&quot;Force Abort&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">SRB_STATUS_DOMAIN_VALIDATION_FAIL</span><span class="p">,</span><span class="s">&quot;Domain Validation Failure&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span>				<span class="s">&quot;Unknown Error&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">aac_get_status_string</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">srb_status_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb_status_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">srb_status_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">;</span>

	<span class="k">return</span> <span class="s">&quot;Bad Status Code&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
