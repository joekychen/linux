<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aacraid › linit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>linit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Adaptec AAC series RAID controller driver</span>
<span class="cm"> *	(c) Copyright 2001 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * based on the old aacraid driver that is..</span>
<span class="cm"> * Adaptec aacraid device driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2010 Adaptec, Inc.</span>
<span class="cm"> *               2010 PMC-Sierra, Inc. (aacraid@pmc-sierra.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Module Name:</span>
<span class="cm"> *   linit.c</span>
<span class="cm"> *</span>
<span class="cm"> * Abstract: Linux Driver entry module for Adaptec RAID Array Controller</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>

<span class="cp">#include &quot;aacraid.h&quot;</span>

<span class="cp">#define AAC_DRIVER_VERSION		&quot;1.2-0&quot;</span>
<span class="cp">#ifndef AAC_DRIVER_BRANCH</span>
<span class="cp">#define AAC_DRIVER_BRANCH		&quot;&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#define AAC_DRIVERNAME			&quot;aacraid&quot;</span>

<span class="cp">#ifdef AAC_DRIVER_BUILD</span>
<span class="cp">#define _str(x) #x</span>
<span class="cp">#define str(x) _str(x)</span>
<span class="cp">#define AAC_DRIVER_FULL_VERSION	AAC_DRIVER_VERSION &quot;[&quot; str(AAC_DRIVER_BUILD) &quot;]&quot; AAC_DRIVER_BRANCH</span>
<span class="cp">#else</span>
<span class="cp">#define AAC_DRIVER_FULL_VERSION	AAC_DRIVER_VERSION AAC_DRIVER_BRANCH</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Red Hat Inc and Adaptec&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Dell PERC2, 2/Si, 3/Si, 3/Di, &quot;</span>
		   <span class="s">&quot;Adaptec Advanced Raid Products, &quot;</span>
		   <span class="s">&quot;HP NetRAID-4M, IBM ServeRAID &amp; ICP SCSI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">AAC_DRIVER_FULL_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">aac_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">aac_devices</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aac_cfg_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">aac_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">AAC_DRIVER_FULL_VERSION</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Because of the way Linux names scsi devices, the order in this table has</span>
<span class="cm"> * become important.  Check for on-board Raid first, add-in cards second.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The last field is used to index into aac_drivers below.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DECLARE_PCI_DEVICE_TABLE</span>
<span class="k">static</span> <span class="n">DECLARE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">aac_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#elif defined(__devinitconst)</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">aac_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">aac_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* PERC 2/Si (Iguana/PERC2Si) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Opal/PERC3Di) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* PERC 3/Si (SlimFast/PERC3Si */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00d0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Iguana FlipChip/PERC3DiF */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00d1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Viper/PERC3DiV) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00d9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Lexus/PERC3DiL) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0106</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Jaguar/PERC3DiJ) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x011b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Dagger/PERC3DiD) */</span>
	<span class="p">{</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0121</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Boxster/PERC3DiB) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0283</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0283</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span> <span class="cm">/* catapult */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0284</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0284</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span> <span class="cm">/* tomcat */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="cm">/* Adaptec 2120S (Crusader) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span> <span class="cm">/* Adaptec 2200S (Vulcan) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span> <span class="cm">/* Adaptec 2200S (Vulcan-2m) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x17aa</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span> <span class="cm">/* Legend S220 (Legend Crusader) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x17aa</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span> <span class="p">},</span> <span class="cm">/* Legend S230 (Legend Vulcan) */</span>

	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0288</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="p">},</span> <span class="cm">/* Adaptec 3230S (Harrier) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0289</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span> <span class="p">},</span> <span class="cm">/* Adaptec 3240S (Tornado) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span> <span class="p">},</span> <span class="cm">/* ASR-2020ZCR SCSI PCI-X ZCR (Skyhawk) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span> <span class="p">},</span> <span class="cm">/* ASR-2025ZCR SCSI SO-DIMM PCI-X ZCR (Terminator) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span> <span class="p">},</span> <span class="cm">/* ASR-2230S + ASR-2230SLP PCI-X (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">21</span> <span class="p">},</span> <span class="cm">/* ASR-2130S (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span> <span class="p">},</span> <span class="cm">/* AAR-2820SA (Intruder) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">23</span> <span class="p">},</span> <span class="cm">/* AAR-2620SA (Intruder) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span> <span class="p">},</span> <span class="cm">/* AAR-2420SA (Intruder) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span> <span class="p">},</span> <span class="cm">/* ICP9024RO (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">26</span> <span class="p">},</span> <span class="cm">/* ICP9014RO (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">27</span> <span class="p">},</span> <span class="cm">/* ICP9047MA (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span> <span class="p">},</span> <span class="cm">/* ICP9087MA (Lancer) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span> <span class="p">},</span> <span class="cm">/* ICP5445AU (Hurricane44) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span> <span class="p">},</span> <span class="cm">/* ICP9085LI (Marauder-X) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* ICP5085BR (Marauder-E) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span> <span class="p">},</span> <span class="cm">/* ICP9067MA (Intruder-6) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span> <span class="p">},</span> <span class="cm">/* Themisto Jupiter Platform */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span> <span class="p">},</span> <span class="cm">/* Themisto Jupiter Platform */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">34</span> <span class="p">},</span> <span class="cm">/* Callisto Jupiter Platform */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">35</span> <span class="p">},</span> <span class="cm">/* ASR-2020SA SATA PCI-X ZCR (Skyhawk) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span> <span class="p">},</span> <span class="cm">/* ASR-2025SA SATA SO-DIMM PCI-X ZCR (Terminator) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0290</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">37</span> <span class="p">},</span> <span class="cm">/* AAR-2410SA PCI SATA 4ch (Jaguar II) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0291</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">38</span> <span class="p">},</span> <span class="cm">/* CERC SATA RAID 2 PCI SATA 6ch (DellCorsair) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0292</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39</span> <span class="p">},</span> <span class="cm">/* AAR-2810SA PCI SATA 8ch (Corsair-8) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0293</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span> <span class="p">},</span> <span class="cm">/* AAR-21610SA PCI SATA 16ch (Corsair-16) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0294</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span> <span class="cm">/* ESD SO-DIMM PCI-X SATA ZCR (Prowler) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3227</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span> <span class="cm">/* AAR-2610SA PCI SATA 6ch */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0296</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">43</span> <span class="p">},</span> <span class="cm">/* ASR-2240S (SabreExpress) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0297</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span> <span class="cm">/* ASR-4005 */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x02F2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span> <span class="p">},</span> <span class="cm">/* IBM 8i (AvonPark) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x0312</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span> <span class="p">},</span> <span class="cm">/* IBM 8i (AvonPark Lite) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x9580</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* IBM 8k/8k-l8 (Aurora) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x9540</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">47</span> <span class="p">},</span> <span class="cm">/* IBM 8k/8k-l4 (Aurora Lite) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0298</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">48</span> <span class="p">},</span> <span class="cm">/* ASR-4000 (BlackBird) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0299</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">49</span> <span class="p">},</span> <span class="cm">/* ASR-4800SAS (Marauder-X) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x029a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* ASR-4805SAS (Marauder-E) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x02a2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">51</span> <span class="p">},</span> <span class="cm">/* ASR-3800 (Hurricane44) */</span>

	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">52</span> <span class="p">},</span> <span class="cm">/* Perc 320/DC*/</span>
	<span class="p">{</span> <span class="mh">0x1011</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0365</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">53</span> <span class="p">},</span> <span class="cm">/* Adaptec 5400S (Mustang)*/</span>
	<span class="p">{</span> <span class="mh">0x1011</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0364</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">54</span> <span class="p">},</span> <span class="cm">/* Adaptec 5400S (Mustang)*/</span>
	<span class="p">{</span> <span class="mh">0x1011</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x1364</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* Dell PERC2/QC */</span>
	<span class="p">{</span> <span class="mh">0x1011</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x103c</span><span class="p">,</span> <span class="mh">0x10c2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">56</span> <span class="p">},</span> <span class="cm">/* HP NetRAID-4M */</span>

	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">57</span> <span class="p">},</span> <span class="cm">/* Dell Catchall */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="mh">0x17aa</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">58</span> <span class="p">},</span> <span class="cm">/* Legend Catchall */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* Adaptec Catch All */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0286</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span> <span class="cm">/* Adaptec Rocket Catch All */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x0288</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/* Adaptec NEMER/ARK Catch All */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028b</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">62</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 6 (Tupelo) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028c</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 7 (Denali) */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028d</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 8 */</span>
	<span class="p">{</span> <span class="mh">0x9005</span><span class="p">,</span> <span class="mh">0x028f</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 9 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">aac_pci_tbl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * dmb - For now we add the number of channels to this structure.</span>
<span class="cm"> * In the future we should add a fib that reports the number of channels</span>
<span class="cm"> * for the card.  At that time we can remove the channels from here</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aac_driver_ident</span> <span class="n">aac_drivers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 2/Si (Iguana/PERC2Si) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Opal/PERC3Di) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Si (SlimFast/PERC3Si */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Iguana FlipChip/PERC3DiF */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Viper/PERC3DiV) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Lexus/PERC3DiL) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Jaguar/PERC3DiJ) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Dagger/PERC3DiD) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* PERC 3/Di (Boxster/PERC3DiB) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;catapult        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* catapult */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;tomcat          &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* tomcat */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 2120S   &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span>		      <span class="cm">/* Adaptec 2120S (Crusader) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 2200S   &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span>		      <span class="cm">/* Adaptec 2200S (Vulcan) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 2200S   &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* Adaptec 2200S (Vulcan-2m) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;Legend  &quot;</span><span class="p">,</span> <span class="s">&quot;Legend S220     &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* Legend S220 (Legend Crusader) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;Legend  &quot;</span><span class="p">,</span> <span class="s">&quot;Legend S230     &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* Legend S230 (Legend Vulcan) */</span>

	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 3230S   &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec 3230S (Harrier) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 3240S   &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec 3240S (Tornado) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2020ZCR     &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* ASR-2020ZCR SCSI PCI-X ZCR (Skyhawk) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2025ZCR     &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* ASR-2025ZCR SCSI SO-DIMM PCI-X ZCR (Terminator) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2230S PCI-X &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* ASR-2230S + ASR-2230SLP PCI-X (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2130S PCI-X &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-2130S (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2820SA      &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* AAR-2820SA (Intruder) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2620SA      &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* AAR-2620SA (Intruder) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2420SA      &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* AAR-2420SA (Intruder) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9024RO       &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* ICP9024RO (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9014RO       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP9014RO (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9047MA       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP9047MA (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9087MA       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP9087MA (Lancer) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP5445AU       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP5445AU (Hurricane44) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9085LI       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP9085LI (Marauder-X) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP5085BR       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP5085BR (Marauder-E) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ICP     &quot;</span><span class="p">,</span> <span class="s">&quot;ICP9067MA       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ICP9067MA (Intruder-6) */</span>
	<span class="p">{</span> <span class="nb">NULL</span>        <span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Themisto        &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AAC_QUIRK_SLAVE</span> <span class="p">},</span> <span class="cm">/* Jupiter Platform */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Callisto        &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_MASTER</span> <span class="p">},</span> <span class="cm">/* Jupiter Platform */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2020SA       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-2020SA SATA PCI-X ZCR (Skyhawk) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2025SA       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-2025SA SATA SO-DIMM PCI-X ZCR (Terminator) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2410SA SATA &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_17SG</span> <span class="p">},</span> <span class="cm">/* AAR-2410SA PCI SATA 4ch (Jaguar II) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;CERC SR2        &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_17SG</span> <span class="p">},</span> <span class="cm">/* CERC SATA RAID 2 PCI SATA 6ch (DellCorsair) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2810SA SATA &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_17SG</span> <span class="p">},</span> <span class="cm">/* AAR-2810SA PCI SATA 8ch (Corsair-8) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-21610SA SATA&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AAC_QUIRK_17SG</span> <span class="p">},</span> <span class="cm">/* AAR-21610SA PCI SATA 16ch (Corsair-16) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2026ZCR     &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ESD SO-DIMM PCI-X SATA ZCR (Prowler) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAR-2610SA      &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* SATA 6Ch (Bearcat) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-2240S       &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-2240S (SabreExpress) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-4005        &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-4005 */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;ServeRAID&quot;</span><span class="p">,</span><span class="s">&quot;IBM     &quot;</span><span class="p">,</span> <span class="s">&quot;ServeRAID 8i    &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* IBM 8i (AvonPark) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;ServeRAID&quot;</span><span class="p">,</span><span class="s">&quot;IBM     &quot;</span><span class="p">,</span> <span class="s">&quot;ServeRAID 8k-l8 &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* IBM 8k/8k-l8 (Aurora) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;ServeRAID&quot;</span><span class="p">,</span><span class="s">&quot;IBM     &quot;</span><span class="p">,</span> <span class="s">&quot;ServeRAID 8k-l4 &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* IBM 8k/8k-l4 (Aurora Lite) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-4000        &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-4000 (BlackBird &amp; AvonPark) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-4800SAS     &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-4800SAS (Marauder-X) */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-4805SAS     &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-4805SAS (Marauder-E) */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;ASR-3800        &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* ASR-3800 (Hurricane44) */</span>

	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERC 320/DC     &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span> <span class="cm">/* Perc 320/DC*/</span>
	<span class="p">{</span> <span class="n">aac_sa_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 5400S   &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span> <span class="cm">/* Adaptec 5400S (Mustang)*/</span>
	<span class="p">{</span> <span class="n">aac_sa_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;AAC-364         &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span> <span class="cm">/* Adaptec 5400S (Mustang)*/</span>
	<span class="p">{</span> <span class="n">aac_sa_init</span><span class="p">,</span> <span class="s">&quot;percraid&quot;</span><span class="p">,</span> <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID        &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span> <span class="cm">/* Dell PERC2/QC */</span>
	<span class="p">{</span> <span class="n">aac_sa_init</span><span class="p">,</span> <span class="s">&quot;hpnraid&quot;</span><span class="p">,</span>  <span class="s">&quot;HP      &quot;</span><span class="p">,</span> <span class="s">&quot;NetRAID         &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">AAC_QUIRK_34SG</span> <span class="p">},</span> <span class="cm">/* HP NetRAID-4M */</span>

	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;DELL    &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* Dell Catchall */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;Legend  &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AAC_QUIRK_31BIT</span> <span class="o">|</span> <span class="n">AAC_QUIRK_34SG</span> <span class="o">|</span> <span class="n">AAC_QUIRK_SCSI_32</span> <span class="p">},</span> <span class="cm">/* Legend Catchall */</span>
	<span class="p">{</span> <span class="n">aac_rx_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span>  <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec Catch All */</span>
	<span class="p">{</span> <span class="n">aac_rkt_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec Rocket Catch All */</span>
	<span class="p">{</span> <span class="n">aac_nark_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID           &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec NEMER/ARK Catch All */</span>
	<span class="p">{</span> <span class="n">aac_src_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 6 (Tupelo) */</span>
	<span class="p">{</span> <span class="n">aac_srcv_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 7 (Denali) */</span>
	<span class="p">{</span> <span class="n">aac_srcv_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Adaptec PMC Series 8 */</span>
	<span class="p">{</span> <span class="n">aac_srcv_init</span><span class="p">,</span> <span class="s">&quot;aacraid&quot;</span><span class="p">,</span> <span class="s">&quot;ADAPTEC &quot;</span><span class="p">,</span> <span class="s">&quot;RAID            &quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">}</span> <span class="cm">/* Adaptec PMC Series 9 */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_queuecommand	-	queue a SCSI command</span>
<span class="cm"> *	@cmd:		SCSI command to queue</span>
<span class="cm"> *	@done:		Function to call on command completion</span>
<span class="cm"> *</span>
<span class="cm"> *	Queues a command for execution by the associated Host Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	TODO: unify with aac_scsi_cmd().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">);</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">command</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">hw_fib_va</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">XferState</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">command</span> <span class="o">=</span> <span class="n">fib</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Already owned by Adapter */</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_LOWLEVEL</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">aac_scsi_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">aac_queuecommand</span><span class="p">)</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_info		-	Returns the host adapter name</span>
<span class="cm"> *	@shost:		Scsi host to report on</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a static string describing the device in question</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">aac_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aac_drivers</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_get_driver_ident</span>
<span class="cm"> *	@devtype: index into lookup table</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a pointer to the entry in the driver lookup table.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">aac_driver_ident</span><span class="o">*</span> <span class="nf">aac_get_driver_ident</span><span class="p">(</span><span class="kt">int</span> <span class="n">devtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">devtype</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_biosparm	-	return BIOS parameters for disk</span>
<span class="cm"> *	@sdev: The scsi device corresponding to the disk</span>
<span class="cm"> *	@bdev: the block device corresponding to the disk</span>
<span class="cm"> *	@capacity: the sector capacity of the disk</span>
<span class="cm"> *	@geom: geometry block to fill in</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the Heads/Sectors/Cylinders BIOS Disk Parameters for Disk.</span>
<span class="cm"> *	The default disk geometry is 64 heads, 32 sectors, and the appropriate</span>
<span class="cm"> *	number of cylinders so as not to exceed drive capacity.  In order for</span>
<span class="cm"> *	disks equal to or larger than 1 GB to be addressable by the BIOS</span>
<span class="cm"> *	without exceeding the BIOS limitation of 1024 cylinders, Extended</span>
<span class="cm"> *	Translation should be enabled.   With Extended Translation enabled,</span>
<span class="cm"> *	drives between 1 GB inclusive and 2 GB exclusive are given a disk</span>
<span class="cm"> *	geometry of 128 heads and 32 sectors, and drives above 2 GB inclusive</span>
<span class="cm"> *	are given a disk geometry of 255 heads and 63 sectors.  However, if</span>
<span class="cm"> *	the BIOS detects that the Extended Translation setting does not match</span>
<span class="cm"> *	the geometry in the partition table, then the translation inferred</span>
<span class="cm"> *	from the partition table will be used by the BIOS, and a warning may</span>
<span class="cm"> *	be displayed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_biosparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">geom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diskparm</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diskparm</span> <span class="o">*</span><span class="p">)</span><span class="n">geom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aac_biosparm.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Assuming extended translation is enabled - #REVISIT#</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 1 GB in 512 byte sectors */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 2 GB in 512 byte sectors */</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">cap_to_cyls</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Read the first 1024 bytes from the disk device, if the boot</span>
<span class="cm">	 *	sector partition table is valid, search for a partition table</span>
<span class="cm">	 *	entry whose end_head matches one of the standard geometry</span>
<span class="cm">	 *	translations ( 64/32, 128/32, 255/63 ).</span>
<span class="cm">	 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">scsi_bios_ptable</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xaa55</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span> <span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">saved_cylinders</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">end_head</span><span class="p">,</span> <span class="n">end_sec</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end_head</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">end_head</span><span class="p">;</span>
			<span class="n">end_sec</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">end_head</span> <span class="o">==</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">end_head</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">end_head</span> <span class="o">==</span> <span class="mi">254</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end_head</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">end_head</span><span class="p">;</span>
			<span class="n">end_sec</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">param</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">cap_to_cyls</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">end_sec</span> <span class="o">==</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">!=</span> <span class="n">saved_cylinders</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Adopting geometry: heads=%d, sectors=%d from partition table %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span> <span class="n">num</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">end_head</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">end_sec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Strange geometry: heads=%d, sectors=%d in partition table %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">end_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_sec</span><span class="p">,</span> <span class="n">num</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">((</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Using geometry: heads=%d, sectors=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">param</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_slave_configure		-	compute queue depths</span>
<span class="cm"> *	@sdev:	SCSI device we are considering</span>
<span class="cm"> *</span>
<span class="cm"> *	Selects queue depths for each target device based on the host adapter&#39;s</span>
<span class="cm"> *	total capacity and the queue depth supported by the target device.</span>
<span class="cm"> *	A queue depth of one automatically disables tagged queueing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">jbod</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">))</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">removable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">jbod</span> <span class="o">||</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inq_periph_qual</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">||</span> <span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expose_physicals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expose_physicals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">||</span> <span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">num_lsu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">num_one</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">depth</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">cid</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Firmware has an individual device recovery time typically</span>
<span class="cm">		 * of 35 seconds, give us a margin.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="o">-&gt;</span><span class="n">rq_timeout</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">45</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">45</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">;</span> <span class="o">++</span><span class="n">cid</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span>
				<span class="o">++</span><span class="n">num_lsu</span><span class="p">;</span>
		<span class="n">__shost_for_each_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">raid_scsi_mode</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">)</span>
				 <span class="o">||</span> <span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">sdev_id</span><span class="p">(</span><span class="n">dev</span><span class="p">)].</span><span class="n">valid</span><span class="p">)</span>
					<span class="o">++</span><span class="n">num_lsu</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">++</span><span class="n">num_one</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_lsu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">++</span><span class="n">num_lsu</span><span class="p">;</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">-</span> <span class="n">num_one</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_lsu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_change_queue_depth		-	alter queue depths</span>
<span class="cm"> *	@sdev:	SCSI device we are considering</span>
<span class="cm"> *	@depth:	desired queue depth</span>
<span class="cm"> *</span>
<span class="cm"> *	Alters queue depths for target device based on the host adapter&#39;s</span>
<span class="cm"> *	total capacity and the queue depth supported by the target device.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">__shost_for_each_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">))</span>
				<span class="o">++</span><span class="n">num</span><span class="p">;</span>
			<span class="o">++</span><span class="n">num</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">-</span> <span class="n">num</span><span class="p">))</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">-</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_raid_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev_channel</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONTAINER_CHANNEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span>
		  <span class="o">?</span> <span class="s">&quot;Hidden</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span>
		  <span class="p">((</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">jbod</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;JBOD</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">get_container_type</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">[</span><span class="n">sdev_id</span><span class="p">(</span><span class="n">sdev</span><span class="p">)].</span><span class="n">type</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_raid_level_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;level&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_raid_level</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">aac_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">aac_raid_level_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aac_do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Host adapter abort request (%d,%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">AAC_DRIVERNAME</span><span class="p">,</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdev_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">sdev_id</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">raw_io_64</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAI_READ_CAPACITY_16</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
		<span class="cm">/* Mark associated FIB to not complete, eh handler does this */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">);</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">hw_fib_va</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">XferState</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIB_CONTEXT_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIB_CONTEXT_FLAG_TIMED_OUT</span><span class="p">;</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_ERROR_HANDLER</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="cm">/* Mark associated FIB to not complete, eh handler does this */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">);</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">command</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">hw_fib_va</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">XferState</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">Async</span> <span class="o">|</span> <span class="n">NoResponseExpected</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIB_CONTEXT_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">((</span><span class="n">command</span> <span class="o">=</span> <span class="n">fib</span><span class="o">-&gt;</span><span class="n">callback_data</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIB_CONTEXT_FLAG_TIMED_OUT</span><span class="p">;</span>
				<span class="n">command</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_ERROR_HANDLER</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	aac_eh_reset	- Reset command handling</span>
<span class="cm"> *	@scsi_cmd:	SCSI command block causing the reset</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Mark the associated FIB to not complete, eh handler does this */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">);</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib</span> <span class="o">*</span> <span class="n">fib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">hw_fib_va</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">XferState</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIB_CONTEXT_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">fib</span><span class="o">-&gt;</span><span class="n">callback_data</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fib</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FIB_CONTEXT_FLAG_TIMED_OUT</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">AAC_OWNER_ERROR_HANDLER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Host adapter reset request. SCSI hang ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">AAC_DRIVERNAME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">aac_check_health</span><span class="p">(</span><span class="n">aac</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for all commands to complete to this specific</span>
<span class="cm">	 * target (block maximum 60 seconds).</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="o">--</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">active</span> <span class="o">=</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__shost_for_each_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">command</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">AAC_OWNER_FIRMWARE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">active</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can exit If all the commands are complete</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: SCSI bus appears hung</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AAC_DRIVERNAME</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This adapter needs a blind reset, only do so for Adapters that</span>
<span class="cm">	 * support a register, instead of a commanded, reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
	  <span class="n">AAC_OPTION_MU_RESET</span><span class="p">)</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
	  <span class="n">AAC_OPTION_DOORBELL_RESET</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	  <span class="n">aac_check_reset</span> <span class="o">&amp;&amp;</span>
	  <span class="p">((</span><span class="n">aac_check_reset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	   <span class="o">!</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
	    <span class="n">AAC_OPTION_IGNORE_RESET</span><span class="p">)))</span>
		<span class="n">aac_reset_adapter</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* Bypass wait for command quiesce */</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span> <span class="cm">/* Cause an immediate retry of the command with a ten second delay after successful tur */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_cfg_open		-	open a configuration file</span>
<span class="cm"> *	@inode: inode being opened</span>
<span class="cm"> *	@file: file handle attached</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the configuration device is opened. Does the needed</span>
<span class="cm"> *	set up on the handle and then returns</span>
<span class="cm"> *</span>
<span class="cm"> *	Bugs: This needs extending to check a given adapter is present</span>
<span class="cm"> *	so we can support hot plugging, and to ref count adapters.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_cfg_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">minor_number</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>  <span class="cm">/* BKL pushdown: nothing else protects this list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aac_devices</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">minor_number</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">aac</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	aac_cfg_ioctl		-	AAC configuration request</span>
<span class="cm"> *	@inode: inode of device</span>
<span class="cm"> *	@file: file handle</span>
<span class="cm"> *	@cmd: ioctl command code</span>
<span class="cm"> *	@arg: argument</span>
<span class="cm"> *</span>
<span class="cm"> *	Handles a configuration ioctl. Currently this involves wrapping it</span>
<span class="cm"> *	up and feeding it into the nasty windowsalike glue layer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Bugs: Needs locking against parallel ioctls lower down</span>
<span class="cm"> *	Bugs: Needs to handle hot plugging</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">aac_cfg_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">aac_do_ioctl</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">aac_compat_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSACTL_MINIPORT_REV_CHECK</span>:
	<span class="k">case</span> <span class="n">FSACTL_SENDFIB</span>:
	<span class="k">case</span> <span class="n">FSACTL_OPEN_GET_ADAPTER_FIB</span>:
	<span class="k">case</span> <span class="n">FSACTL_CLOSE_GET_ADAPTER_FIB</span>:
	<span class="k">case</span> <span class="n">FSACTL_SEND_RAW_SRB</span>:
	<span class="k">case</span> <span class="n">FSACTL_GET_PCI_INFO</span>:
	<span class="k">case</span> <span class="n">FSACTL_QUERY_DISK</span>:
	<span class="k">case</span> <span class="n">FSACTL_DELETE_DISK</span>:
	<span class="k">case</span> <span class="n">FSACTL_FORCE_DELETE_DISK</span>:
	<span class="k">case</span> <span class="n">FSACTL_GET_CONTAINERS</span>:
	<span class="k">case</span> <span class="n">FSACTL_SEND_LARGE_FIB</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">aac_do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSACTL_GET_NEXT_ADAPTER_FIB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fib_ioctl</span> <span class="n">__user</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

		<span class="n">f</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear_user</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib_ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">aac_do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aac_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aac_compat_do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">aac_compat_cfg_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">aac_compat_do_ioctl</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">aac_drivers</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">].</span><span class="n">model</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">cp</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">),</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">AdapterTypeText</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">aac_drivers</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cardtype</span><span class="p">].</span><span class="n">vname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">cdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nblank</span><span class="p">(</span><span class="n">dprintk</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;dprintk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef AAC_DETAILED_STATUS_INFO</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;AAC_DETAILED_STATUS_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_interface</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">raw_io_64</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;SAI_READ_CAPACITY_16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">jbod</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;SUPPORTED_JBOD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">SupportedOptions2</span> <span class="o">&amp;</span>
		<span class="n">AAC_OPTION_POWER_MANAGEMENT</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;SUPPORTED_POWER_MANAGEMENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;PCI_HAS_MSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_kernel_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">kernelrev</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%d-%d[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">kernelbuild</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_monitor_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">monitorrev</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%d-%d[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">monitorbuild</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_bios_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">biosrev</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d.%d-%d[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">biosbuild</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_serial_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xBAD0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%06X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">serial</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
	  <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">MfgPcbaSerialNo</span><span class="p">[</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">MfgPcbaSerialNo</span><span class="p">)</span><span class="o">-</span><span class="n">len</span><span class="p">],</span>
	  <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">MfgPcbaSerialNo</span><span class="p">),</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">supplement_adapter_info</span><span class="p">.</span><span class="n">MfgPcbaSerialNo</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_max_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_max_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_store_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">aac_reset_adapter</span><span class="p">((</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">aac_show_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="o">*</span><span class="p">)</span><span class="n">class_to_shost</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">aac_adapter_check_health</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_model</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;model&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_model</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_vendor</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vendor&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_vendor</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_flags</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;flags&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_flags</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_kernel_version</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hba_kernel_version&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_kernel_version</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_monitor_version</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hba_monitor_version&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_monitor_version</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_bios_version</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hba_bios_version&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_bios_version</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_serial_number</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;serial_number&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_serial_number</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_max_channel</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max_channel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_max_channel</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_max_id</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;max_id&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_max_id</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">aac_reset</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reset_host&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">aac_store_reset_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">aac_show_reset_adapter</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">aac_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">aac_model</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_vendor</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_flags</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_kernel_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_monitor_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_bios_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_serial_number</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_max_channel</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_max_id</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">aac_reset</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="kt">ssize_t</span> <span class="nf">aac_get_serial_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">aac_show_serial_number</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aac_serial_number</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">aac_cfg_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">aac_cfg_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>   <span class="o">=</span> <span class="n">aac_compat_cfg_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">aac_cfg_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">aac_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;AAC&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="n">AAC_DRIVERNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>				<span class="o">=</span> <span class="n">aac_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>				<span class="o">=</span> <span class="n">aac_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>			<span class="o">=</span> <span class="n">aac_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">aac_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">aac_biosparm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">aac_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">aac_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>		<span class="o">=</span> <span class="n">aac_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sdev_attrs</span>			<span class="o">=</span> <span class="n">aac_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">aac_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">aac_eh_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">AAC_NUM_IO_FIB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
<span class="cp">#if (AAC_NUM_IO_FIB &gt; 256)</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="n">AAC_NUM_IO_FIB</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">emulated</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__aac_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span> <span class="n">aac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">aif_thread</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">aac_send_shutdown</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="n">aac_adapter_disable_int</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">aac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">msi</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">aac_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">index</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">insert</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aac_devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unique_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dmamask</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">aac_sync_mode</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aac_devices</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">unique_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">insert</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">unique_id</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_disable_link_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIE_LINK_STATE_L0S</span> <span class="o">|</span> <span class="n">PCIE_LINK_STATE_L1</span> <span class="o">|</span>
			       <span class="n">PCIE_LINK_STATE_CLKPM</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the quirk31 bit is set, the adapter needs adapter</span>
<span class="cm">	 * to driver communication memory to be allocated below 2gig</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_31BIT</span><span class="p">)</span>
		<span class="n">dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dmamask</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dmamask</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_disable_pdev</span><span class="p">;</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">unique_id</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">scsi_host_ptr</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">aac_driver_template</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">;</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>

	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fib</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">+</span> <span class="n">AAC_NUM_MGT_FIB</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_host</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fib_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Map in the registers from the adapter.</span>
<span class="cm">	 */</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">AAC_MIN_FOOTPRINT_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">init</span><span class="p">)(</span><span class="n">aac</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">sync_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aac_sync_mode</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: Sync. mode enforced &quot;</span>
				<span class="s">&quot;by driver parameter. This will cause &quot;</span>
				<span class="s">&quot;a significant performance decrease!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aac</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">aac</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: Async. mode not supported &quot;</span>
				<span class="s">&quot;by current driver, sync. mode enforced.&quot;</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">Please update driver to get full performance.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aac</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">aac</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Start any kernel threads needed</span>
<span class="cm">	 */</span>
	<span class="n">aac</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">aac_command_thread</span><span class="p">,</span> <span class="n">aac</span><span class="p">,</span> <span class="n">AAC_DRIVERNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aacraid: Unable to create command thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_deinit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we had set a smaller DMA mask earlier, set it to 4gig</span>
<span class="cm">	 * now since the adapter can dma data to at least a 4gig</span>
<span class="cm">	 * address space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_31BIT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out_deinit</span><span class="p">;</span>

	<span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_channels</span> <span class="o">=</span> <span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">aac_get_adapter_info</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_deinit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lets override negotiations and drop the maximum SG limit to 34</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_34SG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">&gt;</span> <span class="mi">34</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">112</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_17SG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">112</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_set_dma_max_seg_size</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">adapter_info</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">AAC_OPT_NEW_COMM</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">:</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_deinit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware printf works only with older firmware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_drivers</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">AAC_QUIRK_34SG</span><span class="p">)</span>
		<span class="n">aac</span><span class="o">-&gt;</span><span class="n">printf_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aac</span><span class="o">-&gt;</span><span class="n">printf_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * max channel will be the physical channels plus 1 virtual channel</span>
<span class="cm">	 * all containers are on the virtual channel 0 (CONTAINER_CHANNEL)</span>
<span class="cm">	 * physical channels are address by their actual physical number+1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">nondasd_support</span> <span class="o">||</span> <span class="n">expose_physicals</span> <span class="o">||</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">jbod</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_channels</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aac_get_config_status</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">aac_get_containers</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="n">insert</span><span class="p">);</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_containers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">&lt;</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_physicals</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">maximum_num_physicals</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">MAXIMUM_NUM_CONTAINERS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dmb - we may need to move the setting of these parms somewhere else once</span>
<span class="cm">	 * we get a fib that can report the actual numbers</span>
<span class="cm">	 */</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">AAC_MAX_LUN</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_deinit</span><span class="p">;</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_deinit:</span>
	<span class="n">__aac_shutdown</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
 <span class="nl">out_unmap:</span>
	<span class="n">aac_fib_map_free</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_addr</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_size</span><span class="p">,</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_addr</span><span class="p">,</span>
		  <span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">);</span>
	<span class="n">aac_adapter_ioremap</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">);</span>
 <span class="nl">out_free_host:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
 <span class="nl">out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aac_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">__aac_shutdown</span><span class="p">((</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">aac_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="n">aac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aac_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">__aac_shutdown</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="n">aac_fib_map_free</span><span class="p">(</span><span class="n">aac</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_size</span><span class="p">,</span> <span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_addr</span><span class="p">,</span>
			<span class="n">aac</span><span class="o">-&gt;</span><span class="n">comm_phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">);</span>

	<span class="n">aac_adapter_ioremap</span><span class="p">(</span><span class="n">aac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fibs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">fsa_dev</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">aac_cfg_major</span><span class="p">,</span> <span class="s">&quot;aac&quot;</span><span class="p">);</span>
		<span class="n">aac_cfg_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">aac_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">AAC_DRIVERNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">aac_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">aac_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">aac_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">aac_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Adaptec %s driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">AAC_DRIVERNAME</span><span class="p">,</span> <span class="n">aac_driver_version</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">aac_cfg_major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;aac&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aac_cfg_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_cfg_major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;aacraid: unable to register </span><span class="se">\&quot;</span><span class="s">aac</span><span class="se">\&quot;</span><span class="s"> device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">aac_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aac_cfg_major</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">aac_cfg_major</span><span class="p">,</span> <span class="s">&quot;aac&quot;</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aac_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">aac_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">aac_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
