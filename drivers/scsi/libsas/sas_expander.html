<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › libsas › sas_expander.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sas_expander.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Serial Attached SCSI (SAS) Expander discovery and configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Adaptec, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (C) 2005 Luben Tuikov &lt;luben_tuikov@adaptec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under GPLv2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;sas_internal.h&quot;</span>

<span class="cp">#include &lt;scsi/sas_ata.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_sas.h&gt;</span>
<span class="cp">#include &quot;../scsi_sas_internal.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sas_discover_expander</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sas_configure_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sas_configure_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">include</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sas_disable_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">);</span>

<span class="cm">/* ---------- SMP task management ---------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smp_task_timedout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_task</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">))</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smp_task_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Give it some long enough timeout. In seconds. */</span>
<span class="cp">#define SMP_TIMEOUT 10</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smp_execute_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_size</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_internal</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span>
		<span class="n">to_sas_internal</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">.</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">cmd_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAS_DEV_GONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">task</span> <span class="o">=</span> <span class="n">sas_alloc_task</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tproto</span><span class="p">;</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">req_size</span><span class="p">);</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">resp_size</span><span class="p">);</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_done</span> <span class="o">=</span> <span class="n">smp_task_done</span><span class="p">;</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">task</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">smp_task_timedout</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SMP_TIMEOUT</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">dft</span><span class="o">-&gt;</span><span class="n">lldd_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;executing SMP task failed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;smp task timed out or aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">dft</span><span class="o">-&gt;</span><span class="n">lldd_abort_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;SMP task aborted and not done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span> <span class="o">==</span> <span class="n">SAS_TASK_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">==</span> <span class="n">SAM_STAT_GOOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span> <span class="o">==</span> <span class="n">SAS_TASK_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">==</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no error, but return the number of bytes of</span>
<span class="cm">			 * underrun */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">residual</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span> <span class="o">==</span> <span class="n">SAS_TASK_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">==</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span> <span class="o">==</span> <span class="n">SAS_TASK_UNDELIVERED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">==</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;%s: task to dev %016llx response: 0x%x &quot;</span>
				    <span class="s">&quot;status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
				    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
				    <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">sas_free_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
			<span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">cmd_mutex</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">retry</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">task</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sas_free_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------- Allocations ---------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_smp_req</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REQUEST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_smp_resp</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">sas_route_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TABLE_ROUTING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">t2t_supp</span><span class="p">)</span>
			<span class="k">return</span> <span class="sc">&#39;U&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIRECT_ROUTING</span>:
		<span class="k">return</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SUBTRACTIVE_ROUTING</span>:
		<span class="k">return</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="nf">to_dev_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">discover_resp</span> <span class="o">*</span><span class="n">dr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is detecting a failure to transmit initial dev to host</span>
<span class="cm">	 * FIS as described in section J.5 of sas-2 r16</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">NO_DEVICE</span> <span class="o">&amp;&amp;</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dr</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">&gt;=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SATA_PENDING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_set_ex_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="n">dev_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sas_linkrate</span> <span class="n">linkrate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sas_addr</span><span class="p">[</span><span class="n">SAS_ADDR_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">discover_resp</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_phy</span> <span class="o">=</span> <span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAS_HA_ATA_EH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">sas_phy_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>

		<span class="cm">/* FIXME: error_handling */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMP_RESP_PHY_VACANT</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_VACANT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMP_RESP_FUNC_ACC</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_EMPTY</span><span class="p">;</span> <span class="cm">/* do not know yet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if anything important changed to squelch debug */</span>
	<span class="n">dev_type</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">;</span>
	<span class="n">linkrate</span>  <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">=</span> <span class="n">to_dev_type</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAS_HA_ATA_EH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_host</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_host</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span>  <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_ps</span>   <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_ps</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_iproto</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">iproto</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">tproto</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* help some expanders that fail to zero sas_address in the &#39;no</span>
<span class="cm">	 * device&#39; case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">NO_DEVICE</span> <span class="o">||</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">&lt;</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_phy_id</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_phy_id</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_change_count</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">change_count</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">routing_attr</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="k">virtual</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="k">virtual</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">last_da_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">initiator_port_protocols</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_iproto</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span> <span class="o">&amp;&amp;</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">hmin_linkrate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">hmax_linkrate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">pmin_linkrate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">pmax_linkrate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_phy</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_phy_add</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sas_phy_free</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SATA_PENDING</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;stp pending&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NO_DEVICE</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;no device&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_END_DEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_iproto</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span><span class="p">)</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;host+target&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;host&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span><span class="p">)</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;stp&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ssp&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EDGE_DEV</span>:
	<span class="k">case</span> <span class="n">FANOUT_DEV</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;smp&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* this routine is polled by libata error recovery so filter</span>
<span class="cm">	 * unimportant messages</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_phy</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">!=</span> <span class="n">dev_type</span> <span class="o">||</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">!=</span> <span class="n">linkrate</span> <span class="o">||</span>
	    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">))</span>
		<span class="cm">/* pass */</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if the attached device type changed and ata_eh is active,</span>
<span class="cm">	 * make sure we run revalidation when eh completes (see:</span>
<span class="cm">	 * sas_enable_revalidation)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SAS_HA_ATA_EH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DISCE_REVALIDATE_DOMAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">pending</span><span class="p">);</span>

	<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;%sex %016llx phy%02d:%c:%X attached: %016llx (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">SAS_HA_ATA_EH_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ata: &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
		    <span class="n">sas_route_char</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">),</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">,</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">),</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* check if we have an existing attached ata device on this expander phy */</span>
<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="nf">sas_ex_to_ata</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">ex_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex_dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rphy</span> <span class="o">=</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">sas_find_dev_by_rphy</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev_is_sata</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DISCOVER_REQ_SIZE  16</span>
<span class="cp">#define DISCOVER_RESP_SIZE 56</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_phy_discover_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">disc_req</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">disc_resp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">single</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">discover_resp</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">disc_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">disc_req</span><span class="p">,</span> <span class="n">DISCOVER_REQ_SIZE</span><span class="p">,</span>
			       <span class="n">disc_resp</span><span class="p">,</span> <span class="n">DISCOVER_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="p">)</span><span class="n">disc_resp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_printk</span><span class="p">(</span><span class="s">&quot;Found loopback topology, just ignore it!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sas_set_ex_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">single</span><span class="p">,</span> <span class="n">disc_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sas_ex_phy_discover</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">single</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="o">*</span><span class="n">disc_req</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="o">*</span><span class="n">disc_resp</span><span class="p">;</span>

	<span class="n">disc_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">DISCOVER_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disc_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">disc_resp</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">DISCOVER_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disc_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">disc_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disc_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_DISCOVER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">single</span> <span class="o">&amp;&amp;</span> <span class="n">single</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_phy_discover_helper</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">disc_req</span><span class="p">,</span> <span class="n">disc_resp</span><span class="p">,</span> <span class="n">single</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_phy_discover_helper</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">disc_req</span><span class="p">,</span>
							 <span class="n">disc_resp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">disc_resp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">disc_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_expander_discover</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">);</span>
	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_EXPANDER_PHYS 128</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ex_assign_report_general</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">report_general_resp</span> <span class="o">*</span><span class="n">rg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">rg</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_change_count</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">change_count</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">max_route_indexes</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">route_indexes</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rg</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_EXPANDER_PHYS</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">t2t_supp</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">t2t_supp</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">conf_route_table</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">conf_route_table</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">configuring</span> <span class="o">=</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">configuring</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">rg</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RG_REQ_SIZE   8</span>
<span class="cp">#define RG_RESP_SIZE 32</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_general</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rg_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">rg_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rg_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">RG_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rg_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">RG_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rg_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rg_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_GENERAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rg_req</span><span class="p">,</span> <span class="n">RG_REQ_SIZE</span><span class="p">,</span> <span class="n">rg_resp</span><span class="p">,</span>
				       <span class="n">RG_RESP_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;RG to ex %016llx failed:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SMP_RESP_FUNC_ACC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;RG:ex %016llx returned SMP result:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ex_assign_report_general</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rg_resp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">configuring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;RG: ex %llx self-configuring...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">));</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rg_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rg_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ex_assign_manuf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span>
					<span class="o">*</span><span class="n">_mi_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mi_resp</span> <span class="o">=</span> <span class="n">_mi_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">edev</span> <span class="o">=</span> <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">mi_resp</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SAS_EXPANDER_VENDOR_ID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span> <span class="n">mi_resp</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">SAS_EXPANDER_PRODUCT_ID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_rev</span><span class="p">,</span> <span class="n">mi_resp</span> <span class="o">+</span> <span class="mi">36</span><span class="p">,</span>
	       <span class="n">SAS_EXPANDER_PRODUCT_REV_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mi_resp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_vendor_id</span><span class="p">,</span> <span class="n">mi_resp</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span>
		       <span class="n">SAS_EXPANDER_COMPONENT_VENDOR_ID_LEN</span><span class="p">);</span>
		<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_id</span> <span class="o">=</span> <span class="n">mi_resp</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">mi_resp</span><span class="p">[</span><span class="mi">49</span><span class="p">];</span>
		<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_revision_id</span> <span class="o">=</span> <span class="n">mi_resp</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define MI_REQ_SIZE   8</span>
<span class="cp">#define MI_RESP_SIZE 64</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_manuf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mi_req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mi_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">mi_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">MI_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mi_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mi_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">MI_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mi_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mi_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mi_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_MANUF_INFO</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mi_req</span><span class="p">,</span> <span class="n">MI_REQ_SIZE</span><span class="p">,</span> <span class="n">mi_resp</span><span class="p">,</span><span class="n">MI_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;MI: ex %016llx failed:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mi_resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SMP_RESP_FUNC_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;MI ex %016llx returned SMP result:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">mi_resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ex_assign_manuf_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mi_resp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mi_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mi_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PC_REQ_SIZE  44</span>
<span class="cp">#define PC_RESP_SIZE 8</span>

<span class="kt">int</span> <span class="nf">sas_smp_phy_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">phy_func</span> <span class="n">phy_func</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sas_phy_linkrates</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pc_req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pc_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">pc_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">PC_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pc_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">PC_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pc_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pc_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_PHY_CONTROL</span><span class="p">;</span>
	<span class="n">pc_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">pc_req</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span> <span class="n">phy_func</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc_req</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pc_req</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pc_req</span><span class="p">,</span> <span class="n">PC_REQ_SIZE</span><span class="p">,</span> <span class="n">pc_resp</span><span class="p">,</span><span class="n">PC_RESP_SIZE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pc_resp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pc_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_ex_disable_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>

	<span class="n">sas_smp_phy_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">PHY_FUNC_DISABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">SAS_PHY_DISABLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_ex_disable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">))</span>
			<span class="n">sas_ex_disable_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_dev_present_in_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">dev_list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RPEL_REQ_SIZE	16</span>
<span class="cp">#define RPEL_RESP_SIZE	32</span>
<span class="kt">int</span> <span class="nf">sas_smp_get_phy_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sas_find_dev_by_rphy</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">RPEL_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">RPEL_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_PHY_ERR_LOG</span><span class="p">;</span>
	<span class="n">req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">RPEL_REQ_SIZE</span><span class="p">,</span>
			            <span class="n">resp</span><span class="p">,</span> <span class="n">RPEL_RESP_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">invalid_dword_count</span> <span class="o">=</span> <span class="n">scsi_to_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">running_disparity_error_count</span> <span class="o">=</span> <span class="n">scsi_to_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">loss_of_dword_sync_count</span> <span class="o">=</span> <span class="n">scsi_to_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_reset_problem_count</span> <span class="o">=</span> <span class="n">scsi_to_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">[</span><span class="mi">24</span><span class="p">]);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_SAS_ATA</span>

<span class="cp">#define RPS_REQ_SIZE  16</span>
<span class="cp">#define RPS_RESP_SIZE 60</span>

<span class="kt">int</span> <span class="nf">sas_get_report_phy_sata</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">rps_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rps_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">RPS_REQ_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rps_resp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rps_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rps_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_PHY_SATA</span><span class="p">;</span>
	<span class="n">rps_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rps_req</span><span class="p">,</span> <span class="n">RPS_REQ_SIZE</span><span class="p">,</span>
			            <span class="n">rps_resp</span><span class="p">,</span> <span class="n">RPS_RESP_SIZE</span><span class="p">);</span>

	<span class="cm">/* 0x34 is the FIS type for the D2H fis.  There&#39;s a potential</span>
<span class="cm">	 * standards cockup here.  sas-2 explicitly specifies the FIS</span>
<span class="cm">	 * should be encoded so that FIS type is in resp[24].</span>
<span class="cm">	 * However, some expanders endian reverse this.  Undo the</span>
<span class="cm">	 * reversal here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x34</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x34</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">u8</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rps_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_ex_get_linkrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">parent_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">parent_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">child</span><span class="o">-&gt;</span><span class="n">pathways</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">child</span><span class="o">-&gt;</span><span class="n">min_linkrate</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">min_linkrate</span><span class="p">,</span>
						  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">);</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">max_linkrate</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">max_linkrate</span><span class="p">,</span>
						  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">);</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">pathways</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sas_port_add_phy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">max_linkrate</span><span class="p">);</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">pathways</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">pathways</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pathways</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="nf">sas_ex_discover_end_dev</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">parent_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_host</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_ps</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">child</span> <span class="o">=</span> <span class="n">sas_alloc_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">port</span>   <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">iproto</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_iproto</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">sas_hash_addr</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">hashed_sas_addr</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">sas_port_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sas_port_add</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sas_port_free</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sas_ex_get_linkrate</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">sas_device_set_phy</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SCSI_SAS_ATA</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span> <span class="o">&amp;</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">)</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sata_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_ata_info</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="n">sas_init_dev</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ata_init</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_end_device_alloc</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

		<span class="n">child</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">rphy</span><span class="p">;</span>
		<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">disco_list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disco_list</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_sata</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;sas_discover_sata() for device %16llx at &quot;</span>
				    <span class="s">&quot;%016llx:0x%x returned 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_list_del</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span> <span class="o">&amp;</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">SAS_END_DEV</span><span class="p">;</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_end_device_alloc</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="cm">/* FIXME: error handling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">tproto</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span><span class="p">;</span>
		<span class="n">sas_init_dev</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">rphy</span><span class="p">;</span>
		<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sas_fill_in_rphy</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">rphy</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">disco_list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disco_list</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_end_dev</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;sas_discover_end_dev() for device %16llx &quot;</span>
				    <span class="s">&quot;at %016llx:0x%x returned 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_list_del</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;target proto 0x%x at %016llx:0x%x not handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span><span class="p">,</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">siblings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">child</span><span class="p">;</span>

 <span class="nl">out_list_del:</span>
	<span class="n">sas_rphy_free</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">disco_list_node</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_list_node</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>
 <span class="nl">out_free:</span>
	<span class="n">sas_port_delete</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
 <span class="nl">out_err:</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sas_put_device</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* See if this phy is part of a wide port */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_join_wide_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ephy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ephy</span> <span class="o">==</span> <span class="n">phy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">ephy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span>
			    <span class="n">SAS_ADDR_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ephy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_port_add_phy</span><span class="p">(</span><span class="n">ephy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">ephy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_DEVICE_DISCOVERED</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="nf">sas_ex_discover_expander</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">parent_ex</span> <span class="o">=</span> <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">DIRECT_ROUTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx:0x%x:D &lt;--&gt; ex %016llx:0x%x is not &quot;</span>
			    <span class="s">&quot;allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">),</span>
			    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_phy_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">sas_alloc_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">sas_port_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="cm">/* FIXME: better error handling */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sas_port_add</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EDGE_DEV</span>:
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_expander_alloc</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					  <span class="n">SAS_EDGE_EXPANDER_DEVICE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FANOUT_DEV</span>:
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_expander_alloc</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
					  <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* shut gcc up */</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">rphy</span><span class="p">;</span>
	<span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">edev</span> <span class="o">=</span> <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">;</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">iproto</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_iproto</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">tproto</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_tproto</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">sas_hash_addr</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">hashed_sas_addr</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">);</span>
	<span class="n">sas_ex_get_linkrate</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">edev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span><span class="p">,</span>
					   <span class="n">edev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="n">sas_init_dev</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">sas_fill_in_rphy</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">rphy</span><span class="p">);</span>
	<span class="n">sas_rphy_add</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_expander</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_rphy_delete</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_list_node</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list_lock</span><span class="p">);</span>
		<span class="n">sas_put_device</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">siblings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">children</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_discover_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Phy state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">==</span> <span class="n">SAS_SATA_SPINUP_HOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_smp_phy_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">PHY_FUNC_LINK_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parent and domain coherency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sas_add_parent_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sas_add_parent_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">TABLE_ROUTING</span><span class="p">)</span>
			<span class="n">sas_configure_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_dev_present_in_domain</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span>
		<span class="n">sas_ex_disable_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">NO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">DIRECT_ROUTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
			<span class="n">sas_configure_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">==</span> <span class="n">SAS_LINK_RATE_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">!=</span> <span class="n">SAS_END_DEV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">!=</span> <span class="n">FANOUT_DEV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">!=</span> <span class="n">EDGE_DEV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">!=</span> <span class="n">SATA_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;unknown device type(0x%x) attached to ex %016llx &quot;</span>
			    <span class="s">&quot;phy 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_configure_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;configure routing for dev %016llx &quot;</span>
			    <span class="s">&quot;reported 0x%x. Forgotten</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">sas_disable_routing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_join_wide_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;Attaching ex phy%d to wide port %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">phy_id</span><span class="p">,</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAS_END_DEV</span>:
	<span class="k">case</span> <span class="n">SATA_PENDING</span>:
		<span class="n">child</span> <span class="o">=</span> <span class="n">sas_ex_discover_end_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FANOUT_DEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">fanout_sas_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;second fanout expander %016llx phy 0x%x &quot;</span>
				    <span class="s">&quot;attached to ex %016llx phy 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">),</span>
				    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_phy_id</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
				    <span class="n">phy_id</span><span class="p">);</span>
			<span class="n">sas_ex_disable_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">fanout_sas_addr</span><span class="p">,</span>
			       <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">EDGE_DEV</span>:
		<span class="n">child</span> <span class="o">=</span> <span class="n">sas_ex_discover_expander</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
			    <span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Due to races, the phy might not get added to the</span>
<span class="cm">			 * wide port, so we add the phy to the wide port here.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_state</span><span class="o">=</span> <span class="n">PHY_DEVICE_DISCOVERED</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_join_wide_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
					<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;Attaching ex phy%d to wide port %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">i</span><span class="p">,</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached_sas_addr</span><span class="p">));</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_find_sub_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sub_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
		     <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">SUBTRACTIVE_ROUTING</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">sub_addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span><span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_check_level_subtractive_boundary</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sub_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">EDGE_DEV</span> <span class="o">&amp;&amp;</span>
		    <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sub_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_find_sub_addr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">sub_addr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">s2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sas_find_sub_addr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sub_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">s2</span><span class="p">)))</span> <span class="p">{</span>

				<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx-&gt;%016llx-?-&gt;%016llx &quot;</span>
					    <span class="s">&quot;diverges from subtractive &quot;</span>
					    <span class="s">&quot;boundary %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">s2</span><span class="p">),</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sub_addr</span><span class="p">));</span>

				<span class="n">sas_ex_disable_port</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * sas_ex_discover_devices -- discover devices attached to this expander</span>
<span class="cm"> * dev: pointer to the expander domain device</span>
<span class="cm"> * single: if you want to do a single phy, else set to -1;</span>
<span class="cm"> *</span>
<span class="cm"> * Configure this expander for use with its devices and register the</span>
<span class="cm"> * devices of this expander.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_discover_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">single</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">single</span> <span class="o">&amp;&amp;</span> <span class="n">single</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">single</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span> <span class="o">||</span>
		    <span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_DEVICE_DISCOVERED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SAS_PHY_DISABLED</span>:
		<span class="k">case</span> <span class="n">SAS_PHY_RESET_PROBLEM</span>:
		<span class="k">case</span> <span class="n">SAS_SATA_PORT_SELECTOR</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">sas_check_level_subtractive_boundary</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_check_ex_subtractive_boundary</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="o">*</span><span class="n">sub_sas_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">EDGE_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span> <span class="o">||</span>
		     <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">SUBTRACTIVE_ROUTING</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sub_sas_addr</span><span class="p">)</span>
				<span class="n">sub_sas_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sub_sas_addr</span><span class="p">)</span> <span class="o">!=</span>
				 <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx phy 0x%x &quot;</span>
					    <span class="s">&quot;diverges(%016llx) on subtractive &quot;</span>
					    <span class="s">&quot;boundary(%016llx). Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">),</span>
					    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sub_sas_addr</span><span class="p">));</span>
				<span class="n">sas_ex_disable_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_print_parent_topology_bug</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">parent_phy</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">child_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ex_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">EDGE_DEV</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;edge&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">FANOUT_DEV</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;fanout&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">sas_printk</span><span class="p">(</span><span class="s">&quot;%s ex %016llx phy 0x%x &lt;--&gt; %s ex %016llx &quot;</span>
		   <span class="s">&quot;phy 0x%x has %c:%c routing link!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>

		   <span class="n">ex_type</span><span class="p">[</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">],</span>
		   <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
		   <span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>

		   <span class="n">ex_type</span><span class="p">[</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">],</span>
		   <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
		   <span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>

		   <span class="n">sas_route_char</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">),</span>
		   <span class="n">sas_route_char</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_check_eeds</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">parent_phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">child_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">fanout_sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;edge ex %016llx phy S:0x%x &lt;--&gt; edge ex %016llx &quot;</span>
			    <span class="s">&quot;phy S:0x%x, while there is a fanout ex %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">fanout_sas_addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_a</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span>
		       <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_b</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span>
		       <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_a</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_a</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)))</span>
		   <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_b</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">eeds_b</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))))</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;edge ex %016llx phy 0x%x &lt;--&gt; edge ex %016llx &quot;</span>
			    <span class="s">&quot;phy 0x%x link forms a third EEDS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span>
			    <span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Here we spill over 80 columns.  It is intentional.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_check_parent_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">child_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">parent_ex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">EDGE_DEV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">parent_ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">parent_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">child_phy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_VACANT</span> <span class="o">||</span>
		    <span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">==</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">child_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">child_ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">attached_phy_id</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EDGE_DEV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">!=</span> <span class="n">SUBTRACTIVE_ROUTING</span> <span class="o">||</span>
				    <span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">!=</span> <span class="n">TABLE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sas_print_parent_topology_bug</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">SUBTRACTIVE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">SUBTRACTIVE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">sas_check_eeds</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">!=</span> <span class="n">TABLE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sas_print_parent_topology_bug</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">TABLE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">SUBTRACTIVE_ROUTING</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">TABLE_ROUTING</span> <span class="o">&amp;&amp;</span>
				     <span class="n">child_ex</span><span class="o">-&gt;</span><span class="n">t2t_supp</span> <span class="o">&amp;&amp;</span> <span class="n">parent_ex</span><span class="o">-&gt;</span><span class="n">t2t_supp</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* All good */</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">sas_print_parent_topology_bug</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FANOUT_DEV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">parent_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">!=</span> <span class="n">TABLE_ROUTING</span> <span class="o">||</span>
			    <span class="n">child_phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">!=</span> <span class="n">SUBTRACTIVE_ROUTING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sas_print_parent_topology_bug</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_phy</span><span class="p">,</span> <span class="n">child_phy</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RRI_REQ_SIZE  16</span>
<span class="cp">#define RRI_RESP_SIZE 44</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_configure_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">present</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rri_req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rri_resp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rri_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">RRI_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rri_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rri_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">RRI_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rri_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rri_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rri_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_ROUTE_INFO</span><span class="p">;</span>
	<span class="n">rri_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">max_route_indexes</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">rri_req</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rri_req</span><span class="p">,</span> <span class="n">RRI_REQ_SIZE</span><span class="p">,</span> <span class="n">rri_resp</span><span class="p">,</span>
				       <span class="n">RRI_RESP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">rri_resp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">SMP_RESP_NO_INDEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;overflow of indexes: dev %016llx &quot;</span>
				    <span class="s">&quot;phy 0x%x index 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">SMP_RESP_FUNC_ACC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;%s: dev %016llx phy 0x%x index 0x%x &quot;</span>
				    <span class="s">&quot;result 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">rri_resp</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">rri_resp</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="o">*</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">rri_resp</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="o">*</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">rri_resp</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="n">phy</span><span class="o">-&gt;</span><span class="n">last_da_index</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">last_da_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="o">*</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rri_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rri_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CRI_REQ_SIZE  44</span>
<span class="cp">#define CRI_RESP_SIZE  8</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_configure_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">include</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cri_req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cri_resp</span><span class="p">;</span>

	<span class="n">cri_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">CRI_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cri_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cri_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">CRI_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cri_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cri_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cri_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_CONF_ROUTE_INFO</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">cri_req</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">cri_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">include</span><span class="p">)</span>
		<span class="n">cri_req</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cri_req</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cri_req</span><span class="p">,</span> <span class="n">CRI_REQ_SIZE</span><span class="p">,</span> <span class="n">cri_resp</span><span class="p">,</span>
			       <span class="n">CRI_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">cri_resp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">SMP_RESP_NO_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;overflow of indexes: dev %016llx phy 0x%x &quot;</span>
			    <span class="s">&quot;index 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cri_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cri_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_configure_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">include</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">present</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_configure_present</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">present</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">include</span> <span class="o">^</span> <span class="n">present</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sas_configure_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span><span class="n">include</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sas_configure_parent -- configure routing table of parent</span>
<span class="cm"> * parent: parent expander</span>
<span class="cm"> * child: child expander</span>
<span class="cm"> * sas_addr: SAS port identifier of device directly attached to child</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_configure_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">include</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex_parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_configure_parent</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span>
					   <span class="n">include</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ex_parent</span><span class="o">-&gt;</span><span class="n">conf_route_table</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx has self-configuring routing table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex_parent</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex_parent</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">routing_attr</span> <span class="o">==</span> <span class="n">TABLE_ROUTING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_configure_phy</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="n">include</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sas_configure_routing -- configure routing</span>
<span class="cm"> * dev: expander device</span>
<span class="cm"> * sas_addr: port identifier of device directly attached to the expander device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_configure_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sas_configure_parent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_disable_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sas_configure_parent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sas_discover_expander -- expander discovery</span>
<span class="cm"> * @ex: pointer to expander domain device</span>
<span class="cm"> *</span>
<span class="cm"> * See comment in sas_discover_sata().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_discover_expander</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_notify_lldd_dev_found</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_general</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_manuf_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_expander_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;expander %016llx discovery failed(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_check_ex_subtractive_boundary</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_check_parent_topology</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="n">sas_notify_lldd_dev_gone</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_level_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">dev_list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span>
				<span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_devices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_devices</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port_dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_ex_bfs_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_level_discovery</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sas_discover_root_expander</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_rphy_add</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">ex</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span><span class="p">;</span> <span class="cm">/* 0 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_expander</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>

	<span class="n">sas_ex_bfs_disc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="nl">out_err2:</span>
	<span class="n">sas_rphy_remove</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------- Domain revalidation ---------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_get_phy_discover</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">disc_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">disc_req</span><span class="p">;</span>

	<span class="n">disc_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">DISCOVER_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disc_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">disc_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_DISCOVER</span><span class="p">;</span>
	<span class="n">disc_req</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">disc_req</span><span class="p">,</span> <span class="n">DISCOVER_REQ_SIZE</span><span class="p">,</span>
			       <span class="n">disc_resp</span><span class="p">,</span> <span class="n">DISCOVER_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disc_resp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SMP_RESP_FUNC_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">disc_resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">disc_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_get_phy_change_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">disc_resp</span><span class="p">;</span>

	<span class="n">disc_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">DISCOVER_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disc_resp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">disc_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pcc</span> <span class="o">=</span> <span class="n">disc_resp</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">change_count</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">disc_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_get_phy_attached_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_resp</span> <span class="o">*</span><span class="n">disc_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">discover_resp</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>

	<span class="n">disc_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">DISCOVER_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disc_resp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">disc_resp</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">disc_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">disc_resp</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">to_dev_type</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">disc_resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_find_bcast_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">phy_id</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">from_phy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">update</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from_phy</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy_change_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_phy_change_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_change_count</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMP_RESP_PHY_VACANT</span>:
		<span class="k">case</span> <span class="n">SMP_RESP_NO_PHY</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMP_RESP_FUNC_ACC</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy_change_count</span> <span class="o">!=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_change_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>
				<span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_change_count</span> <span class="o">=</span>
					<span class="n">phy_change_count</span><span class="p">;</span>
			<span class="o">*</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_get_ex_change_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="o">*</span><span class="n">rg_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_resp</span>  <span class="o">*</span><span class="n">rg_resp</span><span class="p">;</span>

	<span class="n">rg_req</span> <span class="o">=</span> <span class="n">alloc_smp_req</span><span class="p">(</span><span class="n">RG_REQ_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rg_resp</span> <span class="o">=</span> <span class="n">alloc_smp_resp</span><span class="p">(</span><span class="n">RG_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rg_resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rg_req</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rg_req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMP_REPORT_GENERAL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rg_req</span><span class="p">,</span> <span class="n">RG_REQ_SIZE</span><span class="p">,</span> <span class="n">rg_resp</span><span class="p">,</span>
			       <span class="n">RG_RESP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="n">SMP_RESP_FUNC_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ecc</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rg_resp</span><span class="o">-&gt;</span><span class="n">rg</span><span class="p">.</span><span class="n">change_count</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rg_resp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rg_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * sas_find_bcast_dev -  find the device issue BROADCAST(CHANGE).</span>
<span class="cm"> * @dev:domain device to be detect.</span>
<span class="cm"> * @src_dev: the device which originated BROADCAST(CHANGE).</span>
<span class="cm"> *</span>
<span class="cm"> * Add self-configuration expander suport. Suppose two expander cascading,</span>
<span class="cm"> * when the first level expander is self-configuring, hotplug the disks in</span>
<span class="cm"> * second level expander, BROADCAST(CHANGE) will not only be originated</span>
<span class="cm"> * in the second level expander, but also be originated in the first level</span>
<span class="cm"> * expander (see SAS protocol SAS 2r-14, 7.11 for detail), it is to say,</span>
<span class="cm"> * expander changed count in two level expanders will all increment at least</span>
<span class="cm"> * once, but the phy which chang count has changed is the source device which</span>
<span class="cm"> * we concerned.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_find_bcast_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">domain_device</span> <span class="o">**</span><span class="n">src_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ex_change_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_ex_change_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex_change_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ex_change_count</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ex_change_count</span> <span class="o">!=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_change_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Just detect if this expander phys phy change count changed,</span>
<span class="cm">		* in order to determine if this expander originate BROADCAST,</span>
<span class="cm">		* and do not update phy change count field in our structure.</span>
<span class="cm">		*/</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_find_bcast_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">src_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_change_count</span> <span class="o">=</span> <span class="n">ex_change_count</span><span class="p">;</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;Expander phy change count has changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;Expander phys DID NOT change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_find_bcast_dev</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">src_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">src_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_unregister_ex_tree</span><span class="p">(</span><span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">SAS_DEV_GONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
		    <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
			<span class="n">sas_unregister_ex_tree</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sas_unregister_dev</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sas_unregister_dev</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sas_unregister_devs_sas_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex_dev</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ex_dev</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SAS_DEV_GONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
				    <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
					<span class="n">sas_unregister_ex_tree</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">sas_unregister_dev</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sas_disable_routing</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">sas_device_set_phy</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sas_port_delete</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_discover_bfs_by_root_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex_root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex_root</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
		    <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span>
				<span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_bfs_by_root_level</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
								     <span class="n">level</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_devices</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_discover_bfs_by_root</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_devices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_bfs_by_root_level</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">max_level</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_discover_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ex_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx phy%d new device attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* to support the wide port inserted */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">ex_phy_temp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">phy_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy_temp</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_ex_join_wide_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_ex_discover_devices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">children</span><span class="p">,</span> <span class="n">siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
			    <span class="n">child</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_bfs_by_root</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dev_type_flutter</span><span class="p">(</span><span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="n">new</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* treat device directed resets as flutter, if we went</span>
<span class="cm">	 * SAS_END_DEV to SATA_PENDING the link needs recovery</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old</span> <span class="o">==</span> <span class="n">SATA_PENDING</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">==</span> <span class="n">SATA_PENDING</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_rediscover_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">sas_dev_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">NO_DEVICE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sas_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_get_phy_attached_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">sas_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMP_RESP_NO_PHY</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_NOT_PRESENT</span><span class="p">;</span>
		<span class="n">sas_unregister_devs_sas_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMP_RESP_PHY_VACANT</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_VACANT</span><span class="p">;</span>
		<span class="n">sas_unregister_devs_sas_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMP_RESP_FUNC_ACC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="n">PHY_EMPTY</span><span class="p">;</span>
		<span class="n">sas_unregister_devs_sas_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">dev_type_flutter</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">ata_dev</span> <span class="o">=</span> <span class="n">sas_ex_to_ata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

		<span class="n">sas_ex_phy_discover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_dev</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_dev_type</span> <span class="o">==</span> <span class="n">SATA_PENDING</span><span class="p">)</span>
			<span class="n">action</span> <span class="o">=</span> <span class="s">&quot;, needs recovery&quot;</span><span class="p">;</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx phy 0x%x broadcast flutter%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* delete the old link */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx phy 0x%x replace %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">,</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">));</span>
		<span class="n">sas_unregister_devs_sas_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sas_discover_new</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sas_rediscover - revalidate the domain.</span>
<span class="cm"> * @dev:domain device to be detect.</span>
<span class="cm"> * @phy_id: the phy id will be detected.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: this process _must_ quit (return) as soon as any connection</span>
<span class="cm"> * errors are encountered.  Connection recovery is done elsewhere.</span>
<span class="cm"> * Discover process only interrogates devices in order to discover the</span>
<span class="cm"> * domain.For plugging out, we un-register the device only when it is</span>
<span class="cm"> * the last phy in the port, for other phys in this port, we just delete it</span>
<span class="cm"> * from the port.For inserting, we do discovery when it is the</span>
<span class="cm"> * first phy,for other phys in this port, we add it to the port to</span>
<span class="cm"> * forming the wide-port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sas_rediscover</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">changed_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="cm">/* is this the last phy of the port */</span>

	<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;ex %016llx phy%d originated BROADCAST(CHANGE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">),</span> <span class="n">phy_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">changed_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ex_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">ex_phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">phy_id</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">SAS_ADDR</span><span class="p">(</span><span class="n">changed_phy</span><span class="o">-&gt;</span><span class="n">attached_sas_addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SAS_DPRINTK</span><span class="p">(</span><span class="s">&quot;phy%d part of wide port with &quot;</span>
					    <span class="s">&quot;phy%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_rediscover_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">sas_discover_new</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sas_revalidate_domain -- revalidate the domain</span>
<span class="cm"> * @port: port to the domain of interest</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: this process _must_ quit (return) as soon as any connection</span>
<span class="cm"> * errors are encountered.  Connection recovery is done elsewhere.</span>
<span class="cm"> * Discover process only interrogates devices in order to discover the</span>
<span class="cm"> * domain.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sas_ex_revalidate_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">port_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sas_find_bcast_dev</span><span class="p">(</span><span class="n">port_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">expander_device</span> <span class="o">*</span><span class="n">ex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">phy_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_find_bcast_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">sas_rediscover</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">phy_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sas_smp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: space for a smp response is missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no rphy means no smp target support (ie aic94xx host) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sas_smp_host_handler</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">type</span> <span class="o">!=</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can we send a smp request to a device?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">sas_find_dev_by_rphy</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: fail to find a domain_device?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do we need to support multiple segments? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: multiple segments req %u %u, rsp %u %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		       <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">smp_execute_task</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
			       <span class="n">bio_data</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* positive number is the untransferred residual */</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
