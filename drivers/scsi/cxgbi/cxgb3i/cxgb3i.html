<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › cxgbi › cxgb3i › cxgb3i.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cxgb3i.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cxgb3i_offload.c: Chelsio S3xx iscsi offloaded tcp connection management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003-2008 Chelsio Communications.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the LICENSE file included in this</span>
<span class="cm"> * release for licensing terms and conditions.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by:	Dimitris Michailidis (dm@chelsio.com)</span>
<span class="cm"> *		Karen Xie (kxie@chelsio.com)</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;t3_cpl.h&quot;</span>
<span class="cp">#include &quot;t3cdev.h&quot;</span>
<span class="cp">#include &quot;cxgb3_defs.h&quot;</span>
<span class="cp">#include &quot;cxgb3_ctl_defs.h&quot;</span>
<span class="cp">#include &quot;cxgb3_offload.h&quot;</span>
<span class="cp">#include &quot;firmware_exports.h&quot;</span>
<span class="cp">#include &quot;cxgb3i.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dbg_level</span><span class="p">;</span>
<span class="cp">#include &quot;../libcxgbi.h&quot;</span>

<span class="cp">#define DRV_MODULE_NAME         &quot;cxgb3i&quot;</span>
<span class="cp">#define DRV_MODULE_DESC         &quot;Chelsio T3 iSCSI Driver&quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	&quot;2.0.0&quot;</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;Jun. 2010&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">DRV_MODULE_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_MODULE_NAME</span>
	<span class="s">&quot; v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chelsio Communications, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_MODULE_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="s">&quot;debug flag (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb3i_rcv_win</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb3i_rcv_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb3i_rcv_win</span><span class="p">,</span> <span class="s">&quot;TCP receive window in bytes (default=256KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb3i_snd_win</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb3i_snd_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb3i_snd_win</span><span class="p">,</span> <span class="s">&quot;TCP send window in bytes (default=128KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb3i_rx_credit_thres</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb3i_rx_credit_thres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_credit_thres</span><span class="p">,</span>
		 <span class="s">&quot;RX credits return threshold in bytes (default=10KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cxgb3i_max_connect</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb3i_max_connect</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb3i_max_connect</span><span class="p">,</span> <span class="s">&quot;Max. # of connections (default=8092)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cxgb3i_sport_base</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb3i_sport_base</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb3i_sport_base</span><span class="p">,</span> <span class="s">&quot;starting port number (default=20000)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cxgb3i_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cxgb3i_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cxgb3i_dev_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgb3_client</span> <span class="n">t3_client</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">cxgb3i_cpl_handlers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">cxgb3i_dev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">cxgb3i_dev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_handler</span> <span class="o">=</span> <span class="n">cxgb3i_dev_event_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">cxgb3i_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>	<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>	<span class="o">=</span> <span class="n">CXGB3I_SCSI_HOST_QDEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>	<span class="o">=</span> <span class="n">iscsi_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">iscsi_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>	<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>	<span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>	<span class="o">=</span> <span class="n">ISCSI_DEF_CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_recover_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>	<span class="o">=</span> <span class="n">iscsi_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>	<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">cxgb3i_iscsi_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="cm">/* owner and name should be set already */</span>
	<span class="p">.</span><span class="n">caps</span>		<span class="o">=</span> <span class="n">CAP_RECOVERY_L0</span> <span class="o">|</span> <span class="n">CAP_MULTI_R2T</span> <span class="o">|</span> <span class="n">CAP_HDRDGST</span>
				<span class="o">|</span> <span class="n">CAP_DATADGST</span> <span class="o">|</span> <span class="n">CAP_DIGEST_OFFLOAD</span> <span class="o">|</span>
				<span class="n">CAP_PADDING_OFFLOAD</span> <span class="o">|</span> <span class="n">CAP_TEXT_NEGO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_is_visible</span>	<span class="o">=</span> <span class="n">cxgbi_attr_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_param</span>	<span class="o">=</span> <span class="n">cxgbi_get_host_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_host_param</span>	<span class="o">=</span> <span class="n">cxgbi_set_host_param</span><span class="p">,</span>
	<span class="cm">/* session management */</span>
	<span class="p">.</span><span class="n">create_session</span>	<span class="o">=</span> <span class="n">cxgbi_create_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_session</span>	<span class="o">=</span> <span class="n">cxgbi_destroy_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_session_param</span> <span class="o">=</span> <span class="n">iscsi_session_get_param</span><span class="p">,</span>
	<span class="cm">/* connection management */</span>
	<span class="p">.</span><span class="n">create_conn</span>	<span class="o">=</span> <span class="n">cxgbi_create_conn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_conn</span>	<span class="o">=</span> <span class="n">cxgbi_bind_conn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_conn</span>	<span class="o">=</span> <span class="n">iscsi_tcp_conn_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_conn</span>	<span class="o">=</span> <span class="n">iscsi_conn_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_conn</span>	<span class="o">=</span> <span class="n">iscsi_conn_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_conn_param</span>	<span class="o">=</span> <span class="n">iscsi_conn_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_param</span>	<span class="o">=</span> <span class="n">cxgbi_set_conn_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>	<span class="o">=</span> <span class="n">cxgbi_get_conn_stats</span><span class="p">,</span>
	<span class="cm">/* pdu xmit req from user space */</span>
	<span class="p">.</span><span class="n">send_pdu</span>	<span class="o">=</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">,</span>
	<span class="cm">/* task */</span>
	<span class="p">.</span><span class="n">init_task</span>	<span class="o">=</span> <span class="n">iscsi_tcp_task_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_task</span>	<span class="o">=</span> <span class="n">iscsi_tcp_task_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_task</span>	<span class="o">=</span> <span class="n">cxgbi_cleanup_task</span><span class="p">,</span>
	<span class="cm">/* pdu */</span>
	<span class="p">.</span><span class="n">alloc_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_alloc_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_init_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_xmit_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse_pdu_itt</span>	<span class="o">=</span> <span class="n">cxgbi_parse_pdu_itt</span><span class="p">,</span>
	<span class="cm">/* TCP connect/disconnect */</span>
	<span class="p">.</span><span class="n">get_ep_param</span>	<span class="o">=</span> <span class="n">cxgbi_get_ep_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_connect</span>	<span class="o">=</span> <span class="n">cxgbi_ep_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_poll</span>	<span class="o">=</span> <span class="n">cxgbi_ep_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_disconnect</span>	<span class="o">=</span> <span class="n">cxgbi_ep_disconnect</span><span class="p">,</span>
	<span class="cm">/* Error recovery timeout call */</span>
	<span class="p">.</span><span class="n">session_recovery_timedout</span> <span class="o">=</span> <span class="n">iscsi_session_recovery_timedout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">cxgb3i_stt</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * CPL (Chelsio Protocol Language) defines a message passing interface between</span>
<span class="cm"> * the host driver and Chelsio asic.</span>
<span class="cm"> * The section below implments CPLs that related to iscsi tcp connection</span>
<span class="cm"> * open/close/abort and data send/receive.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">push_tx_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_completion</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_act_open_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wscale</span> <span class="o">=</span> <span class="n">cxgbi_sock_compute_wscale</span><span class="p">(</span><span class="n">cxgb3i_rcv_win</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ACT_OPEN_REQ</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0h</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_TCAM_BYPASS</span> <span class="o">|</span>
			<span class="n">V_WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_MSS_IDX</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_L2T_IDX</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_TX_CHANNEL</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0l</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_ULP_MODE</span><span class="p">(</span><span class="n">ULP2_MODE_ISCSI</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">V_RCV_BUFSIZ</span><span class="p">(</span><span class="n">cxgb3i_rcv_win</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">));</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, %pI4:%u-%pI4:%u, %u,%u,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span><span class="p">),</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">);</span>

	<span class="n">l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">act_open_arp_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgbi_sock_act_open_req_arp_failure</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection close request: host -&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Close a connection by sending a CPL_CLOSE_CON_REQ message and queue it to</span>
<span class="cm"> * the write queue (i.e., after any unsent txt data).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_close_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_CLOSE_CON</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_CON_REQ</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span><span class="p">);</span>

	<span class="n">cxgbi_sock_skb_entail</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span>
		<span class="n">push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection abort request: host -&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Send an ABORT_REQ message. Makes sure we do not send multiple ABORT_REQs</span>
<span class="cm"> * for the same connection and also that we do not try to send a message</span>
<span class="cm"> * after the connection has closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_arp_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;t3dev 0x%p, tid %u, skb 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tdev</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_abort_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ABORTING</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ABORTING</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">);</span>
	<span class="cm">/* Purge the send queue so we don&#39;t send anything after an abort. */</span>
	<span class="n">cxgbi_sock_purge_write_queue</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">abort_arp_failure</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_HOST_ABORT_CON_REQ</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_REQ</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd0</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_SEND_RST</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, snd_nxt %u, 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd1</span><span class="p">);</span>

	<span class="n">l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection abort reply: host -&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Send an ABORT_RPL message in response of the ABORT_REQ received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rst_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, status %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">rst_status</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_HOST_ABORT_CON_RPL</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_RPL</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">rst_status</span><span class="p">;</span>
	<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection rx data ack: host -&gt;</span>
<span class="cm"> * Send RX credits through an RX_DATA_ACK CPL message. Returns the number of</span>
<span class="cm"> * credits sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">send_rx_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dack</span> <span class="o">=</span> <span class="n">F_RX_DACK_CHANGE</span> <span class="o">|</span> <span class="n">V_RX_DACK_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, credit %u, dack %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">dack</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, credit %u, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_RX_DATA_ACK</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">credit_dack</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">F_RX_DACK_CHANGE</span> <span class="o">|</span> <span class="n">V_RX_DACK_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">V_RX_CREDITS</span><span class="p">(</span><span class="n">credits</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_ACK</span><span class="p">;</span>
	<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection tx data: host -&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Send iscsi PDU via TX_DATA CPL message. Returns the number of</span>
<span class="cm"> * credits sent.</span>
<span class="cm"> * Each TX_DATA consumes work request credit (wrs), so we need to keep track of</span>
<span class="cm"> * how many we&#39;ve used so far and how many are pending (i.e., yet ack&#39;ed by T3).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wrlen</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skb_wrs</span><span class="p">[</span><span class="n">SKB_WR_LIST_SIZE</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_wr_tab</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_wrs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>		<span class="cm">/* already initialized */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SKB_WR_LIST_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sgl_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sgl_len</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">skb_wrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sgl_len</span> <span class="o">&lt;=</span> <span class="n">wr_len</span>
			      <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">sgl_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wr_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">wrlen</span> <span class="o">=</span> <span class="n">wr_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">make_tx_data_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">;</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_data_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_OFLD_TX_DATA</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">req_completion</span> <span class="o">?</span> <span class="n">F_WR_COMPL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr_lo</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_TID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="cm">/* len includes the length of any HW ULP additions */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* V_TX_ULP_SUBMODE sets both the mode and submode */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_ULP_SUBMODE</span><span class="p">(</span><span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">|</span>
			   <span class="n">V_TX_SHOVE</span><span class="p">((</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sndseq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_PORT</span><span class="p">(</span><span class="n">l2t</span><span class="o">-&gt;</span><span class="n">smt_idx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_ACK_PAGES</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">F_TX_INIT</span> <span class="o">|</span>
				    <span class="n">V_TX_CPU_IDX</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">));</span>
		<span class="cm">/* sendbuffer is in units of 32KB. */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_TX_SNDBUF</span><span class="p">(</span><span class="n">cxgb3i_snd_win</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">));</span>
		<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * push_tx_frames -- start transmit</span>
<span class="cm"> * @c3cn: the offloaded connection</span>
<span class="cm"> * @req_completion: request wr_ack or not</span>
<span class="cm"> *</span>
<span class="cm"> * Prepends TX_DATA_WR or CPL_CLOSE_CON_REQ headers to buffers waiting in a</span>
<span class="cm"> * connection&#39;s send queue and sends them on to T3.  Must be called with the</span>
<span class="cm"> * connection&#39;s lock held.  Returns the amount of send buffer space that was</span>
<span class="cm"> * freed as a result of sending queued data to T3.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arp_failure_skb_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_tx_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CTP_ESTABLISHED</span> <span class="o">||</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_CLOSE_WAIT_1</span> <span class="o">||</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_ABORTING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
				<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, in closing state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>	<span class="cm">/* length before skb_push */</span>
		<span class="kt">int</span> <span class="n">frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">wrs_needed</span> <span class="o">=</span> <span class="n">skb_wrs</span><span class="p">[</span><span class="n">frags</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wrs_needed</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_data_wr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">wrlen</span><span class="p">)</span>
			<span class="n">wrs_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">frags</span> <span class="o">&gt;=</span> <span class="n">SKB_WR_LIST_SIZE</span> <span class="o">||</span> <span class="n">wrs_needed</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">&lt;</span> <span class="n">wrs_needed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
				<span class="s">&quot;csk 0x%p, skb len %u/%u, frag %u, wr %d&lt;%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">frags</span><span class="p">,</span>
				<span class="n">wrs_needed</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">wrs_needed</span><span class="p">;</span>	<span class="cm">/* remember this until the WR_ACK */</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">-=</span> <span class="n">wrs_needed</span><span class="p">;</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">+=</span> <span class="n">wrs_needed</span><span class="p">;</span>
		<span class="n">cxgbi_sock_enqueue_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, enqueue, skb len %u/%u, frag %u, wr %d, &quot;</span>
			<span class="s">&quot;left %u, unack %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">frags</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_TX_NEED_HDR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">req_completion</span> <span class="o">&amp;&amp;</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">==</span> <span class="n">wrs_needed</span><span class="p">)</span> <span class="o">||</span>
			     <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">&gt;=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">req_completion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">cxgbi_ulp_extra_len</span><span class="p">(</span><span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="n">make_tx_data_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">req_completion</span><span class="p">);</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">cxgbi_skcb_clear_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_TX_NEED_HDR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">total_size</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, tid 0x%x, send skb 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">arp_failure_skb_discard</span><span class="p">);</span>
		<span class="n">l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a CPL_ACT_ESTABLISH message: -&gt; host</span>
<span class="cm"> * Updates connection state from an active establish CPL message.  Runs with</span>
<span class="cm"> * the connection lock held.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_atid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgb3_free_atid</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
		<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">);</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_act_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span> <span class="n">G_PASS_OPEN_TID</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_tid</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">rcv_isn</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>	<span class="cm">/* real RCV_ISN + 1 */</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;atid 0x%x,tid 0x%x, csk 0x%p,%u,0x%lx, isn %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">atid</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">cxgb3_insert_tid</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_client</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">free_atid</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="n">G_QNUM</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">));</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, got EST.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">copied_seq</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">rcv_isn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb3i_rcv_win</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">M_RCV_BUFSIZ</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span> <span class="o">-=</span> <span class="n">cxgb3i_rcv_win</span> <span class="o">-</span> <span class="p">(</span><span class="n">M_RCV_BUFSIZ</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">cxgbi_sock_established</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ACTIVE_CLOSE_NEEDED</span><span class="p">)))</span>
		<span class="cm">/* upper layer has requested closing */</span>
		<span class="n">send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span>
			<span class="n">push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cxgbi_conn_tx_open</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a CPL_ACT_OPEN_RPL message: -&gt; host</span>
<span class="cm"> * Handle active open failures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_open_rpl_status_to_errno</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_ARP_MISS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_TCAM_FULL</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_EXIST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">act_open_retry_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">;</span>
		<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">act_open_arp_failure</span><span class="p">);</span>
		<span class="n">send_act_open_req</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_act_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, status %u, %pI4:%u-%pI4:%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_TCAM_FULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_ARP_MISS</span><span class="p">)</span>
		<span class="n">cxgb3_queue_tid_release</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">));</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="n">act_open_retry_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">act_open_retry_timer</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span>
				<span class="n">act_open_rpl_status_to_errno</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process PEER_CLOSE CPL messages: -&gt; host</span>
<span class="cm"> * Handle peer FIN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_peer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">cxgbi_sock_rcv_peer_close</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process CLOSE_CONN_RPL CPL message: -&gt; host</span>
<span class="cm"> * Process a peer ACK to our FIN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_close_con_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, snxt %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">));</span>

	<span class="n">cxgbi_sock_rcv_close_conn_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">));</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process ABORT_REQ_RSS CPL message: -&gt; host</span>
<span class="cm"> * Process abort requests.  If we are waiting for an ABORT_RPL we ignore this</span>
<span class="cm"> * request except that we need to reply to it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abort_status_to_errno</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abort_reason</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">need_rst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">abort_reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_BAD_SYN</span>: <span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">CTP_ESTABLISHED</span> <span class="o">?</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">:</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_XMIT_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_PERSIST_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_FINWAIT2_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_KEEPALIVE_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_abort_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rst_status</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span> <span class="o">||</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_PERSIST_NEG_ADVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">);</span>
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ABORTING</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">);</span>
	<span class="n">send_abort_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">rst_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">abort_status_to_errno</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rst_status</span><span class="p">);</span>
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process ABORT_RPL_RSS CPL message: -&gt; host</span>
<span class="cm"> * Process abort replies.  We only process these messages if we anticipate</span>
<span class="cm"> * them as the coordination between SW and HW in this area is somewhat lacking</span>
<span class="cm"> * and sometimes we get ABORT_RPLs after we are done with the connection that</span>
<span class="cm"> * originated the ABORT_REQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl_rss</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;status 0x%x, csk 0x%p, s %u, 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span> <span class="o">?</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">csk</span> <span class="o">?</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">:</span> <span class="mi">0UL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ignore replies to post-close aborts indicating that the abort was</span>
<span class="cm">	 * requested too late.  These connections are terminated when we get</span>
<span class="cm">	 * PEER_CLOSE or CLOSE_CON_RPL and by the time the abort_rpl_rss</span>
<span class="cm">	 * arrives the TID is either no longer used or it has been recycled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_ABORT_FAILED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Sometimes we&#39;ve already closed the connection, e.g., a post-close</span>
<span class="cm">	 * abort races with ABORT_REQ_RSS, the latter frees the connection</span>
<span class="cm">	 * expecting the ABORT_REQ will fail with CPL_ERR_ABORT_FAILED,</span>
<span class="cm">	 * but FW turns the ABORT_REQ into a regular one and so we get</span>
<span class="cm">	 * ABORT_RPL_RSS with status 0 and no connection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span>
		<span class="n">cxgbi_sock_rcv_abort_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process RX_ISCSI_HDR CPL message: -&gt; host</span>
<span class="cm"> * Handle received PDUs, the payload could be DDP&#39;ed. If not, the payload</span>
<span class="cm"> * follow after the bhs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_iscsi_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_iscsi_hdr</span> <span class="o">*</span><span class="n">hdr_cpl</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpl_iscsi_hdr_norss</span> <span class="n">data_cpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ddp_norss</span> <span class="n">ddp_cpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, skb 0x%p,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_PASSIVE_CLOSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, bad state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ABORTING</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr_cpl</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_iscsi_hdr</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr_cpl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* msg coalesce is off or not enough data received */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: tid %u, CPL_ISCSI_HDR, skb len %u &lt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_COALESCED</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ddp_cpl</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: tid %u, copy cpl_ddp %u-%zu failed %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_STATUS</span><span class="p">);</span>
	<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">cxgbi_skcb_rx_ddigest</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">.</span><span class="n">ulp_crc</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">.</span><span class="n">ddp_status</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, skb 0x%p,%u, pdulen %u, status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_HCRC_SHIFT</span><span class="p">))</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_HCRC_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_DCRC_SHIFT</span><span class="p">))</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_DCRC_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_PAD_SHIFT</span><span class="p">))</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_PAD_ERR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_cpl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data_cpl</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: tid %u, cp %zu/%u failed %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data_cpl</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">data_cpl</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;skb 0x%p, pdu not ddp&#39;ed %u/%u, status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data_cpl</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_DDP_SHIFT</span><span class="p">))</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA_DDPD</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">ddp_cpl</span><span class="p">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__pskb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">cxgbi_conn_pdu_ready</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">abort_conn:</span>
	<span class="n">send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">discard:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process TX_DATA_ACK CPL messages: -&gt; host</span>
<span class="cm"> * Process an acknowledgment of WR completion.  Advance snd_una and send the</span>
<span class="cm"> * next batch of work requests from the write queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_wr_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_wr_ack</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">cplhdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, cr %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">));</span>

	<span class="n">cxgbi_sock_rcv_wr_ack</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * for each connection, pre-allocate skbs needed for close/abort requests. So</span>
<span class="cm"> * that we can service the request right away.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_cpls</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_cpl_skbs</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_cpl_skbs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_cpl_skbs:</span>
	<span class="n">cxgbi_sock_free_cpl_skbs</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * release_offload_resources - release offload resource</span>
<span class="cm"> * @c3cn: the offloaded iscsi tcp connection.</span>
<span class="cm"> * Release resources held by an offload connection (TID, L2T entry, etc.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l2t_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l2t_release</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_offload_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cxgbi_sock_free_cpl_skbs</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">!=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxgbi_sock_purge_wr_queue</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="n">cxgbi_sock_reset_wr_list</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">l2t_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">))</span>
		<span class="n">free_atid</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgb3_remove_tid</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">);</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">&amp;&amp;</span>
		    <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span> <span class="o">!=</span> <span class="n">cxgb3i_get_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cxgb3i_set_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">);</span>
			<span class="n">cxgb3i_set_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s set %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span> <span class="o">!=</span>
				<span class="n">cxgb3i_get_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cxgb3i_set_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s set %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cxgb3i_get_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span>
			<span class="n">cxgb3i_set_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cxgb3i_set_private_ipv4addr</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_act_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">update_address</span><span class="p">(</span><span class="n">chba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ipv4addr</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">t3_l2t_get</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NO l2t available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">=</span> <span class="n">cxgb3_alloc_atid</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t3_client</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NO atid available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">);</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_resource</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">;</span>
	<span class="n">set_arp_failure_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">act_open_arp_failure</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">=</span> <span class="n">T3C_DATA</span><span class="p">(</span><span class="n">t3dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_wrs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span> <span class="o">=</span> <span class="n">cxgbi_sock_select_mss</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">cxgbi_sock_reset_wr_list</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, %pI4:%u-%pI4:%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">);</span>
	<span class="n">send_act_open_req</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rel_resource:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">cxgb3_cpl_handler_func</span> <span class="n">cxgb3i_cpl_handlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_act_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_act_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_peer_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_abort_req</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_abort_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_close_con_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_TX_DMA_ACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_wr_ack</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ISCSI_HDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_iscsi_hdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cxgb3i_ofld_init - allocate and initialize resources for each adapter found</span>
<span class="cm"> * @cdev:	cxgbi adapter</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cxgb3i_ofld_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adap_ports</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ofld_page_info</span> <span class="n">rx_page_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t3dev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">GET_WR_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wr_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">t3dev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">GET_PORTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">t3dev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">GET_RX_PAGE_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_page_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;t3 0x%p, offload up, ioctl failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t3dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb3i_max_connect</span> <span class="o">&gt;</span> <span class="n">CXGBI_MAX_CONN</span><span class="p">)</span>
		<span class="n">cxgb3i_max_connect</span> <span class="o">=</span> <span class="n">CXGBI_MAX_CONN</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgbi_device_portmap_create</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cxgb3i_sport_base</span><span class="p">,</span>
					<span class="n">cxgb3i_max_connect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">init_wr_tab</span><span class="p">(</span><span class="n">wr_len</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_release_offload_resources</span> <span class="o">=</span> <span class="n">release_offload_resources</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_push_tx_frames</span> <span class="o">=</span> <span class="n">push_tx_frames</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_abort_req</span> <span class="o">=</span> <span class="n">send_abort_req</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_close_req</span> <span class="o">=</span> <span class="n">send_close_req</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_rx_credits</span> <span class="o">=</span> <span class="n">send_rx_credits</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_alloc_cpls</span> <span class="o">=</span> <span class="n">alloc_cpls</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_init_act_open</span> <span class="o">=</span> <span class="n">init_act_open</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, offload up, added.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * functions to program the pagepod in h/w</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ulp_mem_io_set_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_BYPASS</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_lock_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_ULP_MEMIO_ADDR</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
				   <span class="n">V_ULPTX_CMD</span><span class="p">(</span><span class="n">ULP_MEM_WRITE</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_ULP_MEMIO_DATA_LEN</span><span class="p">(</span><span class="n">PPOD_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">V_ULPTX_NFLITS</span><span class="p">((</span><span class="n">PPOD_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_set_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxgbi_pagepod_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_SIZE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">llimit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, idx %u, npods %u, gl 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="n">pm_addr</span> <span class="o">+=</span> <span class="n">PPOD_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span><span class="p">)</span> <span class="o">+</span>
						<span class="n">PPOD_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ulp_mem_io_set_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pm_addr</span><span class="p">);</span>
		<span class="n">cxgbi_ddp_ppod_set</span><span class="p">((</span><span class="k">struct</span> <span class="n">cxgbi_pagepod</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span><span class="p">)),</span>
				   <span class="n">hdr</span><span class="p">,</span> <span class="n">gl</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PPOD_PAGES_MAX</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>
		<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_clear_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_SIZE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">llimit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, idx %u, npods %u, tag 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="n">pm_addr</span> <span class="o">+=</span> <span class="n">PPOD_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span><span class="p">)</span> <span class="o">+</span>
						<span class="n">PPOD_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;tag 0x%x, 0x%x, %d/%u, skb OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ulp_mem_io_set_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pm_addr</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>
		<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_setup_conn_pgidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pg_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pg_idx</span> <span class="o">&lt;</span> <span class="n">DDP_PGIDX_MAX</span> <span class="o">?</span> <span class="n">pg_idx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, tid %u, pg_idx %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">pg_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* set up ulp submode and page size */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">V_NO_REPLY</span><span class="p">(</span><span class="n">reply</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0xF0000000</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>

	<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cxgb3i_setup_conn_digest - setup conn. digest setting</span>
<span class="cm"> * @csk: cxgb tcp socket</span>
<span class="cm"> * @tid: connection id</span>
<span class="cm"> * @hcrc: header digest enabled</span>
<span class="cm"> * @dcrc: data digest enabled</span>
<span class="cm"> * @reply: request reply from h/w</span>
<span class="cm"> * set up the iscsi digest settings for a connection identified by tid</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_setup_conn_digest</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">hcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">hcrc</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dcrc</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, tid %u, crc %d,%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">hcrc</span><span class="p">,</span> <span class="n">dcrc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* set up ulp submode and page size */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">.</span><span class="n">wr_hi</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">V_WR_OP</span><span class="p">(</span><span class="n">FW_WROPCODE_FORWARD</span><span class="p">));</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">V_NO_REPLY</span><span class="p">(</span><span class="n">reply</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cpu_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0x0F000000</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">;</span>

	<span class="n">cxgb3_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * t3_ddp_cleanup - release the cxgb3 adapter&#39;s ddp resource</span>
<span class="cm"> * @cdev: cxgb3i adapter</span>
<span class="cm"> * release all the resource held by the ddp pagepod manager for a given</span>
<span class="cm"> * adapter if needed</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t3_ddp_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_ddp_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t3dev 0x%p, ulp_iscsi no more user.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tdev</span><span class="p">);</span>
		<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp_iscsi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ddp_init - initialize the cxgb3 adapter&#39;s ddp resource</span>
<span class="cm"> * @cdev: cxgb3i adapter</span>
<span class="cm"> * initialize the ddp pagepod manager for a given adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb3i_ddp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp_iscsi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_iscsi_info</span> <span class="n">uinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pgsz_factor</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;t3dev 0x%p, ddp 0x%p already set up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tdev</span><span class="p">,</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp_iscsi</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">ddp</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ULP_ISCSI_GET_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s, failed to get iscsi param err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_ddp_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">llimit</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">ulimit</span><span class="p">,</span>
			<span class="n">uinfo</span><span class="p">.</span><span class="n">max_txsz</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">max_rxsz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="p">.</span><span class="n">tagmask</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">;</span>
	<span class="n">cxgbi_ddp_page_size_factor</span><span class="p">(</span><span class="n">pgsz_factor</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="p">.</span><span class="n">pgsz_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgsz_factor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">uinfo</span><span class="p">.</span><span class="n">ulimit</span> <span class="o">=</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">llimit</span> <span class="o">+</span> <span class="p">(</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_SIZE_SHIFT</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">ULP_ISCSI_SET_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uinfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s unable to set iscsi param err=%d, ddp disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">cxgbi_ddp_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tdev</span><span class="o">-&gt;</span><span class="n">ulp_iscsi</span> <span class="o">=</span> <span class="n">ddp</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_digest</span> <span class="o">=</span> <span class="n">ddp_setup_conn_digest</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_pgidx</span> <span class="o">=</span> <span class="n">ddp_setup_conn_pgidx</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_set</span> <span class="o">=</span> <span class="n">ddp_set_map</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_clear</span> <span class="o">=</span> <span class="n">ddp_clear_map</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tdev 0x%p, nppods %u, bits %u, mask 0x%x,0x%x pkt %u/%u, &quot;</span>
		<span class="s">&quot;%u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tdev</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_bits</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span><span class="p">,</span>
		<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">rsvd_tag_mask</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">max_txsz</span><span class="p">,</span>
		<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">.</span><span class="n">max_rxsz</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb3i_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_find_by_lldev</span><span class="p">(</span><span class="n">t3dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span> <span class="o">||</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CXGBI_FLAG_ADAPTER_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p close, f 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span> <span class="o">?</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_device_unregister</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cxgb3i_dev_open - init a t3 adapter structure and any h/w settings</span>
<span class="cm"> * @t3dev: t3cdev adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb3i_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_find_by_lldev</span><span class="p">(</span><span class="n">t3dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">tdev2adap</span><span class="p">(</span><span class="n">t3dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p, updating.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;device 0x%p register failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t3dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CXGBI_FLAG_DEV_T3</span> <span class="o">|</span> <span class="n">CXGBI_FLAG_IPV4_SET</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span> <span class="o">=</span> <span class="n">t3dev</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mtus</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mtus</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nmtus</span> <span class="o">=</span> <span class="n">NMTUS</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">snd_win</span> <span class="o">=</span> <span class="n">cxgb3i_snd_win</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rcv_win</span> <span class="o">=</span> <span class="n">cxgb3i_rcv_win</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_credit_thres</span> <span class="o">=</span> <span class="n">cxgb3i_rx_credit_thres</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span> <span class="o">=</span> <span class="n">CXGB3I_TX_HEADER_LEN</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_rx_extra</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_iscsi_hdr_norss</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev_ddp_cleanup</span> <span class="o">=</span> <span class="n">t3_ddp_cleanup</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">itp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxgb3i_iscsi_transport</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgb3i_ddp_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p ddp init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgb3i_ofld_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p offload init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_hbas_add</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CXGB3I_MAX_LUN</span><span class="p">,</span> <span class="n">CXGBI_MAX_CONN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cxgb3i_host_template</span><span class="p">,</span> <span class="n">cxgb3i_stt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ipv4addr</span> <span class="o">=</span>
			<span class="n">cxgb3i_get_private_ipv4addr</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, f 0x%x, t3dev 0x%p open, err %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span> <span class="o">?</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t3dev</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">cxgbi_device_unregister</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgb3i_dev_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">t3cdev</span> <span class="o">*</span><span class="n">t3dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_find_by_lldev</span><span class="p">(</span><span class="n">t3dev</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span><span class="p">,</span>
		<span class="s">&quot;0x%p, cdev 0x%p, event 0x%x, port 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">t3dev</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OFFLOAD_STATUS_DOWN</span>:
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CXGBI_FLAG_ADAPTER_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OFFLOAD_STATUS_UP</span>:
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CXGBI_FLAG_ADAPTER_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cxgb3i_init_module - module init entry point</span>
<span class="cm"> *</span>
<span class="cm"> * initialize any driver wide global data structures and register itself</span>
<span class="cm"> *	with the cxgb3 module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cxgb3i_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgbi_iscsi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb3i_iscsi_transport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb3i_stt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cxgb3_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t3_client</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cxgb3i_exit_module - module cleanup/exit entry point</span>
<span class="cm"> *</span>
<span class="cm"> * go through the driver hba list and for each hba, release any resource held.</span>
<span class="cm"> *	and unregisters iscsi transport and the cxgb3 module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cxgb3i_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgb3_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t3_client</span><span class="p">);</span>
	<span class="n">cxgbi_device_unregister_all</span><span class="p">(</span><span class="n">CXGBI_FLAG_DEV_T3</span><span class="p">);</span>
	<span class="n">cxgbi_iscsi_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb3i_iscsi_transport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb3i_stt</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cxgb3i_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cxgb3i_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
