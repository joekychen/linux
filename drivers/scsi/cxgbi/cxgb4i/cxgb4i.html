<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › cxgbi › cxgb4i › cxgb4i.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cxgb4i.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cxgb4i.c: Chelsio T4 iSCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010 Chelsio Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by:	Karen Xie (kxie@chelsio.com)</span>
<span class="cm"> *		Rakesh Ranjan (rranjan@chelsio.com)</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>

<span class="cp">#include &quot;t4_msg.h&quot;</span>
<span class="cp">#include &quot;cxgb4.h&quot;</span>
<span class="cp">#include &quot;cxgb4_uld.h&quot;</span>
<span class="cp">#include &quot;t4fw_api.h&quot;</span>
<span class="cp">#include &quot;l2t.h&quot;</span>
<span class="cp">#include &quot;cxgb4i.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dbg_level</span><span class="p">;</span>

<span class="cp">#include &quot;../libcxgbi.h&quot;</span>

<span class="cp">#define	DRV_MODULE_NAME		&quot;cxgb4i&quot;</span>
<span class="cp">#define DRV_MODULE_DESC		&quot;Chelsio T4 iSCSI Driver&quot;</span>
<span class="cp">#define	DRV_MODULE_VERSION	&quot;0.9.1&quot;</span>
<span class="cp">#define	DRV_MODULE_RELDATE	&quot;Aug. 2010&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">DRV_MODULE_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_MODULE_NAME</span>
	<span class="s">&quot; v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chelsio Communications, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_MODULE_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="s">&quot;Debug flag (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb4i_rcv_win</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb4i_rcv_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb4i_rcv_win</span><span class="p">,</span> <span class="s">&quot;TCP reveive window in bytes&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb4i_snd_win</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb4i_snd_win</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb4i_snd_win</span><span class="p">,</span> <span class="s">&quot;TCP send window in bytes&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxgb4i_rx_credit_thres</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb4i_rx_credit_thres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb4i_rx_credit_thres</span><span class="p">,</span>
		<span class="s">&quot;RX credits return threshold in bytes (default=10KB)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cxgb4i_max_connect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb4i_max_connect</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb4i_max_connect</span><span class="p">,</span> <span class="s">&quot;Maximum number of connections&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cxgb4i_sport_base</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cxgb4i_sport_base</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cxgb4i_sport_base</span><span class="p">,</span> <span class="s">&quot;Starting port number (default 20000)&quot;</span><span class="p">);</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cxgb4i_cplhandler_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t4_uld_add</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">t4_uld_rx_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pkt_gl</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">t4_uld_state_change</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxgb4_state</span> <span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxgb4_uld_info</span> <span class="n">cxgb4i_uld_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">t4_uld_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_handler</span> <span class="o">=</span> <span class="n">t4_uld_rx_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_change</span> <span class="o">=</span> <span class="n">t4_uld_state_change</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">cxgb4i_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>	<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>	<span class="o">=</span> <span class="n">CXGB4I_SCSI_HOST_QDEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>	<span class="o">=</span> <span class="n">iscsi_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">iscsi_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>	<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>	<span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>	<span class="o">=</span> <span class="n">ISCSI_DEF_CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_recover_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>	<span class="o">=</span> <span class="n">iscsi_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>	<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">cxgb4i_iscsi_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>		<span class="o">=</span> <span class="n">CAP_RECOVERY_L0</span> <span class="o">|</span> <span class="n">CAP_MULTI_R2T</span> <span class="o">|</span> <span class="n">CAP_HDRDGST</span> <span class="o">|</span>
				<span class="n">CAP_DATADGST</span> <span class="o">|</span> <span class="n">CAP_DIGEST_OFFLOAD</span> <span class="o">|</span>
				<span class="n">CAP_PADDING_OFFLOAD</span> <span class="o">|</span> <span class="n">CAP_TEXT_NEGO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_is_visible</span>	<span class="o">=</span> <span class="n">cxgbi_attr_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_param</span>	<span class="o">=</span> <span class="n">cxgbi_get_host_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_host_param</span>	<span class="o">=</span> <span class="n">cxgbi_set_host_param</span><span class="p">,</span>
	<span class="cm">/* session management */</span>
	<span class="p">.</span><span class="n">create_session</span>	<span class="o">=</span> <span class="n">cxgbi_create_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_session</span>	<span class="o">=</span> <span class="n">cxgbi_destroy_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_session_param</span> <span class="o">=</span> <span class="n">iscsi_session_get_param</span><span class="p">,</span>
	<span class="cm">/* connection management */</span>
	<span class="p">.</span><span class="n">create_conn</span>	<span class="o">=</span> <span class="n">cxgbi_create_conn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_conn</span>		<span class="o">=</span> <span class="n">cxgbi_bind_conn</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_conn</span>	<span class="o">=</span> <span class="n">iscsi_tcp_conn_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_conn</span>		<span class="o">=</span> <span class="n">iscsi_conn_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_conn</span>		<span class="o">=</span> <span class="n">iscsi_conn_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_conn_param</span>	<span class="o">=</span> <span class="n">iscsi_conn_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_param</span>	<span class="o">=</span> <span class="n">cxgbi_set_conn_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>	<span class="o">=</span> <span class="n">cxgbi_get_conn_stats</span><span class="p">,</span>
	<span class="cm">/* pdu xmit req from user space */</span>
	<span class="p">.</span><span class="n">send_pdu</span>	<span class="o">=</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">,</span>
	<span class="cm">/* task */</span>
	<span class="p">.</span><span class="n">init_task</span>	<span class="o">=</span> <span class="n">iscsi_tcp_task_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_task</span>	<span class="o">=</span> <span class="n">iscsi_tcp_task_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_task</span>	<span class="o">=</span> <span class="n">cxgbi_cleanup_task</span><span class="p">,</span>
	<span class="cm">/* pdu */</span>
	<span class="p">.</span><span class="n">alloc_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_alloc_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_init_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_pdu</span>	<span class="o">=</span> <span class="n">cxgbi_conn_xmit_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse_pdu_itt</span>	<span class="o">=</span> <span class="n">cxgbi_parse_pdu_itt</span><span class="p">,</span>
	<span class="cm">/* TCP connect/disconnect */</span>
	<span class="p">.</span><span class="n">get_ep_param</span>	<span class="o">=</span> <span class="n">cxgbi_get_ep_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_connect</span>	<span class="o">=</span> <span class="n">cxgbi_ep_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_poll</span>	<span class="o">=</span> <span class="n">cxgbi_ep_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_disconnect</span>	<span class="o">=</span> <span class="n">cxgbi_ep_disconnect</span><span class="p">,</span>
	<span class="cm">/* Error recovery timeout call */</span>
	<span class="p">.</span><span class="n">session_recovery_timedout</span> <span class="o">=</span> <span class="n">iscsi_session_recovery_timedout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">cxgb4i_stt</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * CPL (Chelsio Protocol Language) defines a message passing interface between</span>
<span class="cm"> * the host driver and Chelsio asic.</span>
<span class="cm"> * The section below implments CPLs that related to iscsi tcp connection</span>
<span class="cm"> * open/close/abort and data send/receive.</span>
<span class="cm"> */</span>
<span class="cp">#define DIV_ROUND_UP(n, d)	(((n) + (d) - 1) / (d))</span>
<span class="cp">#define RCV_BUFSIZ_MASK		0x3FFU</span>
<span class="cp">#define MAX_IMM_TX_PKT_LEN	128</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">push_tx_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * is_ofld_imm - check whether a packet can be sent as immediate data</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if a packet can be sent as an offload WR with immediate</span>
<span class="cm"> * data.  We currently use the same limit as for Ethernet packets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ofld_imm</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_IMM_TX_PKT_LEN</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_act_open_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wscale</span> <span class="o">=</span> <span class="n">cxgbi_sock_compute_wscale</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opt0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opt2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qid_atid</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="n">opt0</span> <span class="o">=</span> <span class="n">KEEP_ALIVE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">WND_SCALE</span><span class="p">(</span><span class="n">wscale</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MSS_IDX</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">L2T_IDX</span><span class="p">(((</span><span class="k">struct</span> <span class="n">l2t_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">TX_CHAN</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SMAC_SEL</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ULP_MODE</span><span class="p">(</span><span class="n">ULP_MODE_ISCSI</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RCV_BUFSIZ</span><span class="p">(</span><span class="n">cxgb4i_rcv_win</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">opt2</span> <span class="o">=</span> <span class="n">RX_CHANNEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RSS_QUEUE_VALID</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RSS_QUEUE</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>

	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_SETUP</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ACT_OPEN_REQ</span><span class="p">,</span>
					<span class="n">qid_atid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt0</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">opt0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">opt2</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">opt2</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, %pI4:%u-%pI4:%u, atid %d, qid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">local_ip</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_ip</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">peer_port</span><span class="p">),</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>

	<span class="n">cxgb4_l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_close_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_CLOSE_CON_REQ</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cxgbi_sock_skb_entail</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span>
		<span class="n">push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_arp_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u, abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>
	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_abort_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ABORTING</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb</span> <span class="o">||</span> <span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ABORTING</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">);</span>
	<span class="n">cxgbi_sock_purge_write_queue</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">set_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CPL_ABORT_SEND_RST</span><span class="p">;</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">abort_arp_failure</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_REQ</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd0</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, snd_nxt %u, 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rsvd1</span><span class="p">);</span>

	<span class="n">cxgb4_l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rst_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, status %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">rst_status</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">set_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">rpl</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_ABORT_RPL</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">rst_status</span><span class="p">;</span>
	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CPL connection rx data ack: host -&gt;</span>
<span class="cm"> * Send RX credits through an RX_DATA_ACK CPL message. Returns the number of</span>
<span class="cm"> * credits sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">send_rx_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, credit %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, credit %u, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rx_data_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_ACK</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_RX_DATA_ACK</span><span class="p">,</span>
				      <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">credit_dack</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">RX_CREDITS</span><span class="p">(</span><span class="n">credits</span><span class="p">)</span> <span class="o">|</span> <span class="n">RX_FORCE_ACK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sgl_len - calculates the size of an SGL of the given capacity</span>
<span class="cm"> * @n: the number of SGL entries</span>
<span class="cm"> * Calculates the number of flits needed for a scatter/gather list that</span>
<span class="cm"> * can hold the given number of entries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sgl_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">n</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * calc_tx_flits_ofld - calculate # of flits for an offload packet</span>
<span class="cm"> * @skb: the packet</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of flits needed for the given offload packet.</span>
<span class="cm"> * These packets are already fully constructed and no additional headers</span>
<span class="cm"> * will be added.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_tx_flits_ofld</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flits</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ofld_imm</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">flits</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flits</span> <span class="o">+</span> <span class="n">sgl_len</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">send_tx_flowc_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_flowc_wr</span> <span class="o">*</span><span class="n">flowc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flowclen</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">flowclen</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="n">flowclen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">flowc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_flowc_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">op_to_nparams</span> <span class="o">=</span>
		<span class="n">htonl</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_FLOWC_WR</span><span class="p">)</span> <span class="o">|</span> <span class="n">FW_FLOWC_WR_NPARAMS</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span>
		<span class="n">htonl</span><span class="p">(</span><span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">|</span>
				<span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_PFNVFN</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pfvf</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_CH</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_PORT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_IQID</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_SNDNXT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_RCVNXT</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_SNDBUF</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">cxgb4i_snd_win</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">FW_FLOWC_MNEM_MSS</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span><span class="p">);</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flowc</span><span class="o">-&gt;</span><span class="n">mnemval</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, tid 0x%x, %u,%u,%u,%u,%u,%u,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">,</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">,</span> <span class="n">cxgb4i_snd_win</span><span class="p">,</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span><span class="p">);</span>

	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">make_tx_data_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">dlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">credits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">submode</span> <span class="o">=</span> <span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_ulp_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span> <span class="o">*</span><span class="p">)</span><span class="n">__skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ofld_imm</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">op_to_immdlen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_OFLD_TX_DATA_WR</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FW_WR_IMMDLEN</span><span class="p">(</span><span class="n">dlen</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">credits</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">op_to_immdlen</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_OP</span><span class="p">(</span><span class="n">FW_OFLD_TX_DATA_WR</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FW_WR_COMPL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FW_WR_IMMDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">flowid_len16</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">FW_WR_FLOWID</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">FW_WR_LEN16</span><span class="p">(</span><span class="n">credits</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">submode</span><span class="p">)</span>
		<span class="n">wr_ulp_mode</span> <span class="o">=</span> <span class="n">FW_OFLD_TX_DATA_WR_ULPMODE</span><span class="p">(</span><span class="n">ULP2_MODE_ISCSI</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">FW_OFLD_TX_DATA_WR_ULPSUBMODE</span><span class="p">(</span><span class="n">submode</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tunnel_to_proxy</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">wr_ulp_mode</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">FW_OFLD_TX_DATA_WR_SHOVE</span><span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">plen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">))</span>
		<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arp_failure_skb_discard</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_tx_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_completion</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CTP_ESTABLISHED</span> <span class="o">||</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_CLOSE_WAIT_1</span> <span class="o">||</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_ABORTING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span> <span class="o">|</span>
			 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, in closing state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits_needed</span><span class="p">;</span>

		<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ofld_imm</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="n">credits_needed</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">dlen</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">credits_needed</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">calc_tx_flits_ofld</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
					<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_ofld_tx_data_wr</span><span class="p">),</span>
					<span class="mi">16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">&lt;</span> <span class="n">credits_needed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
				<span class="s">&quot;csk 0x%p, skb %u/%u, wr %d &lt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span>
				<span class="n">credits_needed</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
		<span class="n">set_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_DATA</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">credits_needed</span><span class="p">;</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">-=</span> <span class="n">credits_needed</span><span class="p">;</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">+=</span> <span class="n">credits_needed</span><span class="p">;</span>
		<span class="n">cxgbi_sock_enqueue_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, skb %u/%u, wr %d, left %u, unack %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">credits_needed</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_TX_NEED_HDR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_TX_DATA_SENT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">send_tx_flowc_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">cxgbi_ulp_extra_len</span><span class="p">(</span><span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="n">make_tx_data_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">credits_needed</span><span class="p">,</span>
					<span class="n">req_completion</span><span class="p">);</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">cxgbi_skcb_clear_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_TX_NEED_HDR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">total_size</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
		<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">arp_failure_skb_discard</span><span class="p">);</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, skb 0x%p, %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">cxgb4_l2t_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_atid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgb4_free_atid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
		<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">);</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_act_establish</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tcp_opt</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span> <span class="n">GET_TID_TID</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tos_atid</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcv_isn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NO conn. for atid %u, cdev 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">!=</span> <span class="n">atid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bad conn atid %u, csk 0x%p,%u,0x%lx,tid %u, atid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atid</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u, atid %u, rseq %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">rcv_isn</span><span class="p">);</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">cxgb4_insert_tid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">);</span>

	<span class="n">free_atid</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, got EST.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">copied_seq</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">rcv_isn</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Causes the first RX_DATA_ACK to supply any Rx credits we couldn&#39;t</span>
<span class="cm">	 * pass through opt0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb4i_rcv_win</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RCV_BUFSIZ_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span> <span class="o">-=</span> <span class="n">cxgb4i_rcv_win</span> <span class="o">-</span> <span class="p">(</span><span class="n">RCV_BUFSIZ_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="n">GET_TCPOPT_MSS</span><span class="p">(</span><span class="n">tcp_opt</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_TCPOPT_TSTAMP</span><span class="p">(</span><span class="n">tcp_opt</span><span class="p">))</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, mss_idx %u, advmss %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">GET_TCPOPT_MSS</span><span class="p">(</span><span class="n">tcp_opt</span><span class="p">),</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span><span class="p">);</span>

	<span class="n">cxgbi_sock_established</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">snd_isn</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tcp_opt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ACTIVE_CLOSE_NEEDED</span><span class="p">)))</span>
		<span class="n">send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span>
			<span class="n">push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cxgbi_conn_tx_open</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_open_rpl_status_to_errno</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_ARP_MISS</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_TCAM_FULL</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_EXIST</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csk_act_open_retry_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">;</span>
		<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span>
					<span class="n">cxgbi_sock_act_open_req_arp_failure</span><span class="p">);</span>
		<span class="n">send_act_open_req</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_act_open_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_act_open_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_rpl</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atid</span> <span class="o">=</span>
		<span class="n">GET_TID_TID</span><span class="p">(</span><span class="n">GET_AOPEN_ATID</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">atid_status</span><span class="p">)));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GET_AOPEN_STATUS</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">atid_status</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_atid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">atid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;NO matching conn. atid %u, tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atid</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%pI4:%u-%pI4:%u, atid %u,%u, status %u, csk 0x%p,%u,0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
		<span class="n">atid</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_TCAM_FULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_ARP_MISS</span><span class="p">)</span>
		<span class="n">cxgb4_remove_tid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">));</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_CONN_EXIST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="n">csk_act_open_retry_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">csk_act_open_retry_timer</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span>
					<span class="n">act_open_rpl_status_to_errno</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_peer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_peer_close</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_peer_close</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find connection for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_rcv_peer_close</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_close_con_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_close_con_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_rpl</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find connection for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_rcv_close_conn_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">));</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abort_status_to_errno</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">abort_reason</span><span class="p">,</span>
								<span class="kt">int</span> <span class="o">*</span><span class="n">need_rst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">abort_reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPL_ERR_BAD_SYN</span>: <span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">CPL_ERR_CONN_RESET</span>:
		<span class="k">return</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">CTP_ESTABLISHED</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">EPIPE</span> <span class="o">:</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPL_ERR_XMIT_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_PERSIST_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_FINWAIT2_TIMEDOUT</span>:
	<span class="k">case</span> <span class="n">CPL_ERR_KEEPALIVE_TIMEDOUT</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_abort_req_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req_rss</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rst_status</span> <span class="o">=</span> <span class="n">CPL_ABORT_NO_RST</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find connection for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u, status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_RTX_NEG_ADVICE</span> <span class="o">||</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_PERSIST_NEG_ADVICE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>

	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">);</span>
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ABORTING</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">);</span>
	<span class="n">send_abort_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">rst_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">abort_status_to_errno</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rst_status</span><span class="p">);</span>
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_abort_rpl_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_abort_rpl_rss</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl_rss</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;status 0x%x, csk 0x%p, s %u, 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span> <span class="o">?</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">csk</span> <span class="o">?</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">:</span> <span class="mi">0UL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">CPL_ERR_ABORT_FAILED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>

	<span class="n">cxgbi_sock_rcv_abort_rpl</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_rx_iscsi_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_iscsi_hdr</span> <span class="o">*</span><span class="n">cpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pdu_len_ddp</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cpl</span><span class="o">-&gt;</span><span class="n">pdu_len_ddp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">cpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find conn. for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u, skb 0x%p,%u, 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		<span class="n">pdu_len_ddp</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_PASSIVE_CLOSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, bad state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ABORTING</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">cpl</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cpl</span><span class="p">));</span>
	<span class="n">__pskb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cpl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bhs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">dlen</span><span class="p">;</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx, tid %u, skb 0x%p header.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_HDR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tid %u, CPL_ISCSI_HDR, bad seq, 0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bhs</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">cpl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">bhs</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hlen</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ISCSI_PDU_LEN</span><span class="p">(</span><span class="n">pdu_len_ddp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tid 0x%x, CPL_ISCSI_HDR, pdu len &quot;</span>
				<span class="s">&quot;mismatch %u != %u + %u, seq 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ISCSI_PDU_LEN</span><span class="p">(</span><span class="n">pdu_len_ddp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">40</span><span class="p">,</span>
				<span class="n">hlen</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">+</span> <span class="n">dlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span><span class="p">)</span>
			<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">dcrc_len</span><span class="p">;</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">+=</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, skb 0x%p, 0x%x,%u+%u,0x%x,0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">bhs</span><span class="p">,</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">bhs</span> <span class="o">+</span> <span class="mi">16</span><span class="p">))),</span>
			<span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">bhs</span> <span class="o">+</span> <span class="mi">24</span><span class="p">))));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lskb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span><span class="p">;</span>

		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx, skb 0x%p data, 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">lskb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">abort_conn:</span>
	<span class="n">send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">discard:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_rx_data_ddp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_rx_data_ddp</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_rx_data_ddp</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ddpvld</span><span class="p">);</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find connection for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx, skb 0x%p,0x%x, lhdr 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_PASSIVE_CLOSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, bad state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ABORTING</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;tid 0x%x, rcv RX_DATA_DDP w/o pdu bhs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">abort_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lskb</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">skb_ulp_lhdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cxgbi_skcb_rx_ddigest</span><span class="p">(</span><span class="n">lskb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ulp_crc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">lskb</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tid 0x%x, RX_DATA_DDP pdulen %u != %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">lskb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_HCRC_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, lhdr 0x%p, status 0x%x, hcrc bad 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">lskb</span><span class="p">));</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_HCRC_ERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_DCRC_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, lhdr 0x%p, status 0x%x, dcrc bad 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">lskb</span><span class="p">));</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DCRC_ERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_PAD_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, lhdr 0x%p, status 0x%x, pad bad.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_PAD_ERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CPL_RX_DDP_STATUS_DDP_SHIFT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, lhdr 0x%p, 0x%x, data ddp&#39;ed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA_DDPD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, lskb 0x%p, f 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">lskb</span><span class="p">));</span>

	<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_STATUS</span><span class="p">);</span>
	<span class="n">cxgbi_conn_pdu_ready</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">rel_skb</span><span class="p">;</span>

<span class="nl">abort_conn:</span>
	<span class="n">send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">discard:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">rel_skb:</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_fw4_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_fw4_ack</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_fw4_ack</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find connection for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">cxgbi_sock_rcv_wr_ack</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">),</span>
					<span class="n">rpl</span><span class="o">-&gt;</span><span class="n">seq_vld</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_set_tcb_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_rpl</span> <span class="o">*</span><span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_rpl</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">GET_TID</span><span class="p">(</span><span class="n">rpl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tid_info</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">lookup_tid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t find conn. for tid %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,%lx,%u, status 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CPL_ERR_NONE</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u, SET_TCB_RPL status %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_cpls</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_close_con_req</span><span class="p">),</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_req</span><span class="p">),</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_cpls</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_abort_rpl</span><span class="p">),</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_cpls</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_cpls:</span>
	<span class="n">cxgbi_sock_free_cpl_skbs</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">l2t_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxgb4_l2t_release</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_offload_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">cxgbi_sock_free_cpl_skbs</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">!=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cxgbi_sock_purge_wr_queue</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="n">cxgbi_sock_reset_wr_list</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">l2t_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">))</span>
		<span class="n">free_atid</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">cxgb4_remove_tid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_TID</span><span class="p">);</span>
		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_act_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">step</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">=</span> <span class="n">cxgb4_alloc_atid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">tids</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">atid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s, NO atid available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_HAS_ATID</span><span class="p">);</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">dst_get_neighbour_noref</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s, can&#39;t get neighbour of csk-&gt;dst.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span> <span class="o">=</span> <span class="n">cxgb4_l2t_get</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s, cannot alloc l2t.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rel_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_open_req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rel_resource</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">;</span>
	<span class="n">t4_set_arp_err_handler</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">cxgbi_sock_act_open_req_arp_failure</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">dst_mtu</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">cxgb4_best_mtu</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">cxgb4_port_chan</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="cm">/* SMT two entries per row */</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">smac_idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">cxgb4_port_viid</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">step</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ntxq</span> <span class="o">/</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nchan</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">txq_idx</span> <span class="o">=</span> <span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">step</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nrxq</span> <span class="o">/</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nchan</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">rxq_ids</span><span class="p">[</span><span class="n">cxgb4_port_idx</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">];</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cxgbi_sock_reset_wr_list</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,p%d,%s, %u,%u,%u, mss %u,%u, smac %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">mss_idx</span><span class="p">,</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">smac_idx</span><span class="p">);</span>

	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">);</span>
	<span class="n">send_act_open_req</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">l2t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rel_resource:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">cxgb4i_cplhandler_func</span> <span class="n">cxgb4i_cplhandlers</span><span class="p">[</span><span class="n">NUM_CPL_CMDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CPL_ACT_ESTABLISH</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_act_establish</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ACT_OPEN_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_act_open_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_PEER_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_peer_close</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_REQ_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_abort_req_rss</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ABORT_RPL_RSS</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_abort_rpl_rss</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_CLOSE_CON_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_close_con_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_FW4_ACK</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_fw4_ack</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_ISCSI_HDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_rx_iscsi_hdr</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_SET_TCB_RPL</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_set_tcb_rpl</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPL_RX_DATA_DDP</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_rx_data_ddp</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">cxgb4i_ofld_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb4i_max_connect</span> <span class="o">&gt;</span> <span class="n">CXGB4I_MAX_CONN</span><span class="p">)</span>
		<span class="n">cxgb4i_max_connect</span> <span class="o">=</span> <span class="n">CXGB4I_MAX_CONN</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgbi_device_portmap_create</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">cxgb4i_sport_base</span><span class="p">,</span>
					<span class="n">cxgb4i_max_connect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_release_offload_resources</span> <span class="o">=</span> <span class="n">release_offload_resources</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_push_tx_frames</span> <span class="o">=</span> <span class="n">push_tx_frames</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_abort_req</span> <span class="o">=</span> <span class="n">send_abort_req</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_close_req</span> <span class="o">=</span> <span class="n">send_close_req</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_rx_credits</span> <span class="o">=</span> <span class="n">send_rx_credits</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_alloc_cpls</span> <span class="o">=</span> <span class="n">alloc_cpls</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_init_act_open</span> <span class="o">=</span> <span class="n">init_act_open</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, offload up, added.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * functions to program the pagepod in h/w</span>
<span class="cm"> */</span>
<span class="cp">#define ULPMEM_IDATA_MAX_NPPODS	4 </span><span class="cm">/* 256/PPOD_SIZE */</span><span class="cp"></span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ulp_mem_io_set_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="n">idata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">INIT_ULPTX_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ULPTX_CMD</span><span class="p">(</span><span class="n">ULP_TX_MEM_WRITE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ULP_MEMIO_DATA_LEN</span><span class="p">(</span><span class="n">dlen</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">lock_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ULP_MEMIO_ADDR</span><span class="p">(</span><span class="n">pm_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">len16</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wr_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">wr</span><span class="p">),</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">cmd_more</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ULPTX_CMD</span><span class="p">(</span><span class="n">ULP_TX_SC_IMM</span><span class="p">));</span>
	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_ppod_write_idata</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port_id</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cxgbi_pagepod_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gl_pidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="n">idata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_pagepod</span> <span class="o">*</span><span class="n">ppod</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_addr</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">PPOD_SIZE</span> <span class="o">+</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">llimit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span> <span class="o">=</span> <span class="n">PPOD_SIZE</span> <span class="o">*</span> <span class="n">npods</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr_len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulptx_idata</span><span class="p">)</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="n">wr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, idx %u, npods %u, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_mem_io</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">set_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ulp_mem_io_set_hdr</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">wr_len</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">pm_addr</span><span class="p">);</span>
	<span class="n">idata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulptx_idata</span> <span class="o">*</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ppod</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_pagepod</span> <span class="o">*</span><span class="p">)(</span><span class="n">idata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ppod</span><span class="o">++</span><span class="p">,</span> <span class="n">gl_pidx</span> <span class="o">+=</span> <span class="n">PPOD_PAGES_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gl</span><span class="p">)</span>
			<span class="n">cxgbi_ddp_ppod_clear</span><span class="p">(</span><span class="n">ppod</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cxgbi_ddp_ppod_set</span><span class="p">(</span><span class="n">ppod</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">gl</span><span class="p">,</span> <span class="n">gl_pidx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_set_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxgbi_pagepod_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npods</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">npods</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">ULPMEM_IDATA_MAX_NPPODS</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">ULPMEM_IDATA_MAX_NPPODS</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ddp_ppod_write_idata</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">gl</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_clear_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npods</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">npods</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">ULPMEM_IDATA_MAX_NPPODS</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">ULPMEM_IDATA_MAX_NPPODS</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ddp_ppod_write_idata</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_setup_conn_pgidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">pg_idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg_idx</span> <span class="o">||</span> <span class="n">pg_idx</span> <span class="o">&gt;=</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*  set up ulp page size */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_ctrl</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">NO_REPLY</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="o">|</span> <span class="n">QUEUENO</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word_cookie</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">pg_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, tid 0x%x, pg_idx %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">pg_idx</span><span class="p">);</span>

	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_setup_conn_digest</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">hcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcrc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dcrc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">hcrc_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">hcrc</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">dcrc_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcrc</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*  set up ulp submode */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_set_tcb_field</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">INIT_TP_WR</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">OPCODE_TID</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">MK_OPCODE_TID</span><span class="p">(</span><span class="n">CPL_SET_TCB_FIELD</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_ctrl</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">NO_REPLY</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="o">|</span> <span class="n">QUEUENO</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">rss_qid</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">word_cookie</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(((</span><span class="n">hcrc</span> <span class="o">?</span> <span class="n">ULP_CRC_HEADER</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">dcrc</span> <span class="o">?</span> <span class="n">ULP_CRC_DATA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">set_wr_txq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CPL_PRIORITY_CONTROL</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, tid 0x%x, crc %d,%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">hcrc</span><span class="p">,</span> <span class="n">dcrc</span><span class="p">);</span>

	<span class="n">cxgb4_ofld_send</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgb4i_ddp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span> <span class="o">=</span> <span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tagmask</span><span class="p">,</span> <span class="n">pgsz_factor</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, ddp 0x%p already set up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_ddp_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">iscsi</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			<span class="n">lldi</span><span class="o">-&gt;</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">iscsi</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">iscsi</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">lldi</span><span class="o">-&gt;</span><span class="n">iscsi_iolen</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">iscsi_iolen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>

	<span class="n">tagmask</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">;</span>
	<span class="n">cxgbi_ddp_page_size_factor</span><span class="p">(</span><span class="n">pgsz_factor</span><span class="p">);</span>
	<span class="n">cxgb4_iscsi_init</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tagmask</span><span class="p">,</span> <span class="n">pgsz_factor</span><span class="p">);</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_digest</span> <span class="o">=</span> <span class="n">ddp_setup_conn_digest</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_pgidx</span> <span class="o">=</span> <span class="n">ddp_setup_conn_pgidx</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_set</span> <span class="o">=</span> <span class="n">ddp_set_map</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_clear</span> <span class="o">=</span> <span class="n">ddp_clear_map</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cxgb4i 0x%p tag: sw %u, rsvd %u,%u, mask 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">sw_bits</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_bits</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_shift</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_mask</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cxgb4i 0x%p, nppods %u, bits %u, mask 0x%x,0x%x pkt %u/%u, &quot;</span>
		<span class="s">&quot; %u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_bits</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span><span class="p">,</span>
		<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">rsvd_tag_mask</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">iscsi_iolen</span><span class="p">,</span>
		<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">iscsi_iolen</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cxgb4i 0x%p max payload size: %u/%u, %u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tx_max_size</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_max_size</span><span class="p">,</span>
		<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">t4_uld_add</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cxgb4_lld_info</span> <span class="o">*</span><span class="n">lldi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_register</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lldi</span><span class="p">),</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t4 device 0x%p, register failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lldi</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p,0x%x, ports %u,%s, chan %u, q %u,%u, wr %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span>
		<span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nchan</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ntxq</span><span class="p">,</span>
		<span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nrxq</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nrxq</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
			<span class="s">&quot;t4 0x%p, rxq id #%d: %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">rxq_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cxgbi_cdev_priv</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">lldi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lldi</span><span class="p">));</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CXGBI_FLAG_DEV_T4</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mtus</span> <span class="o">=</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nmtus</span> <span class="o">=</span> <span class="n">NMTUS</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">snd_win</span> <span class="o">=</span> <span class="n">cxgb4i_snd_win</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rcv_win</span> <span class="o">=</span> <span class="n">cxgb4i_rcv_win</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_credit_thres</span> <span class="o">=</span> <span class="n">cxgb4i_rx_credit_thres</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span> <span class="o">=</span> <span class="n">CXGB4I_TX_HEADER_LEN</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_rx_extra</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpl_iscsi_hdr</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">itp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxgb4i_iscsi_transport</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pfvf</span> <span class="o">=</span> <span class="n">FW_VIID_PFN_GET</span><span class="p">(</span><span class="n">cxgb4_port_viid</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p,%s, pfvf %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pfvf</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgb4i_ddp_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t4 0x%p ddp init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgb4i_ofld_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t4 0x%p ofld init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgbi_hbas_add</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">CXGB4I_MAX_LUN</span><span class="p">,</span> <span class="n">CXGBI_MAX_CONN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cxgb4i_host_template</span><span class="p">,</span> <span class="n">cxgb4i_stt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">lldi</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cdev</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">cxgbi_device_unregister</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RX_PULL_LEN	128</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_uld_rx_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pkt_gl</span> <span class="o">*</span><span class="n">pgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="n">rpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pgl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsp_ctrl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_wr</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">rsp</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pgl</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;? FL 0x%p,RSS%#llx,FL %#llx,len %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pgl</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">),</span>
				<span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">pgl</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">),</span>
				<span class="n">pgl</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">cxgb4_pktgl_to_skb</span><span class="p">(</span><span class="n">pgl</span><span class="p">,</span> <span class="n">RX_PULL_LEN</span><span class="p">,</span> <span class="n">RX_PULL_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpl_act_establish</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">opc</span> <span class="o">=</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ot</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span><span class="p">,</span>
		<span class="s">&quot;cdev %p, opcode 0x%x(0x%x,0x%x), skb %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cdev</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ot</span><span class="p">.</span><span class="n">opcode_tid</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rpl</span><span class="o">-&gt;</span><span class="n">ot</span><span class="p">.</span><span class="n">opcode_tid</span><span class="p">),</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgb4i_cplhandlers</span><span class="p">[</span><span class="n">opc</span><span class="p">])</span>
		<span class="n">cxgb4i_cplhandlers</span><span class="p">[</span><span class="n">opc</span><span class="p">](</span><span class="n">cdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No handler for opcode 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nomem:</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span><span class="p">,</span> <span class="s">&quot;OOM bailing out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">t4_uld_state_change</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxgb4_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CXGB4_STATE_UP</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, UP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="cm">/* re-initialize */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CXGB4_STATE_START_RECOVERY</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, RECOVERY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="cm">/* close all connections */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CXGB4_STATE_DOWN</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, DOWN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CXGB4_STATE_DETACH</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, DETACH.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, unknown state %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cxgb4i_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cxgbi_iscsi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4i_iscsi_transport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb4i_stt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">cxgb4_register_uld</span><span class="p">(</span><span class="n">CXGB4_ULD_ISCSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb4i_uld_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cxgb4i_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgb4_unregister_uld</span><span class="p">(</span><span class="n">CXGB4_ULD_ISCSI</span><span class="p">);</span>
	<span class="n">cxgbi_device_unregister_all</span><span class="p">(</span><span class="n">CXGBI_FLAG_DEV_T4</span><span class="p">);</span>
	<span class="n">cxgbi_iscsi_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cxgb4i_iscsi_transport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxgb4i_stt</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cxgb4i_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cxgb4i_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
