<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › cxgbi › libcxgbi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>libcxgbi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * libcxgbi.c: Chelsio common library for T3/T4 iSCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2010 Chelsio Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Karen Xie (kxie@chelsio.com)</span>
<span class="cm"> * Written by: Rakesh Ranjan (rranjan@chelsio.com)</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt)	KBUILD_MODNAME &quot;:%s: &quot; fmt, __func__</span>

<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/route.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;	</span><span class="cm">/* ip_dev_find */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dbg_level</span><span class="p">;</span>

<span class="cp">#include &quot;libcxgbi.h&quot;</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;libcxgbi&quot;</span>
<span class="cp">#define DRV_MODULE_DESC		&quot;Chelsio iSCSI driver library&quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	&quot;0.9.0&quot;</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;Jun. 2010&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chelsio Communications, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_MODULE_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="s">&quot;libiscsi debug level (default=0)&quot;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * cxgbi device management</span>
<span class="cm"> * maintains a list of the cxgbi devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cdev_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cdev_mutex</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_device_portmap_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ports_map</span> <span class="o">*</span><span class="n">pmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">;</span>

	<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span> <span class="o">=</span> <span class="n">cxgbi_alloc_big_mem</span><span class="p">(</span><span class="n">max_conn</span> <span class="o">*</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">),</span>
					     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, portmap OOM %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">max_conn</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span> <span class="o">=</span> <span class="n">max_conn</span><span class="p">;</span>
	<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">sport_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_portmap_create</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_device_portmap_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ports_map</span> <span class="o">*</span><span class="n">pmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">csk</span> <span class="o">=</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
				<span class="s">&quot;csk 0x%p, cdev 0x%p, offload down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_OFFLOAD_DOWN</span><span class="p">);</span>
			<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_portmap_cleanup</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cxgbi_device_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, p# %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
	<span class="n">cxgbi_hbas_remove</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">cxgbi_device_portmap_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev_ddp_cleanup</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev_ddp_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cxgbi_ddp_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">)</span>
		<span class="n">cxgbi_ddp_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">.</span><span class="n">max_connect</span><span class="p">)</span>
		<span class="n">cxgbi_free_big_mem</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">.</span><span class="n">port_csk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="nf">cxgbi_device_register</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extra</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra</span> <span class="o">+</span> <span class="n">nports</span> <span class="o">*</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;nport %d, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nports</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">**</span><span class="p">)(</span><span class="n">cdev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">**</span><span class="p">)(((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">)</span> <span class="o">+</span> <span class="n">nports</span> <span class="o">*</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">nports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, p# %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">nports</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, p# %u,%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">?</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">cxgbi_device_destroy</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_unregister</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_device_unregister_all</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev_list</span><span class="p">,</span> <span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">==</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
				<span class="s">&quot;cdev 0x%p, p# %u,%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">?</span>
				 <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">);</span>
			<span class="n">cxgbi_device_destroy</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_unregister_all</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="nf">cxgbi_device_find_by_lldev</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev_list</span><span class="p">,</span> <span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lldev</span> <span class="o">==</span> <span class="n">lldev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cdev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;lldev 0x%p, NO match found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_device_find_by_lldev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="nf">cxgbi_device_find_by_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
							<span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
			<span class="s">&quot;vlan dev %s -&gt; %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev_list</span><span class="p">,</span> <span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span> <span class="o">==</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
					<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">cdev</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev_mutex</span><span class="p">);</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;ndev 0x%p, %s, NO match found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_hbas_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, p#%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chba</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chba</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">iscsi_host_remove</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">iscsi_host_free</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_hbas_remove</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_hbas_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_lun</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">stt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span> <span class="s">&quot;cdev 0x%p, p#%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_host_alloc</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chba</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;0x%p, p%d, %s, host alloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">stt</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">max_lun</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">max_id</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">chba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
		<span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">chba</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DEV</span><span class="p">,</span>
			<span class="s">&quot;cdev 0x%p, p#%d %s: chba 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chba</span><span class="p">);</span>

		<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_host_add</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, p#%d %s, host add failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
			<span class="k">goto</span>  <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chba</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">cxgbi_hbas_remove</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_hbas_add</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * iSCSI offload</span>
<span class="cm"> *</span>
<span class="cm"> * - source port management</span>
<span class="cm"> *   To find a free source port in the port allocation map we use a very simple</span>
<span class="cm"> *   rotor scheme to look for the next free port.</span>
<span class="cm"> *</span>
<span class="cm"> *   If a source port has been specified make sure that it doesn&#39;t collide with</span>
<span class="cm"> *   our normal source port allocation map.  If it&#39;s outside the range of our</span>
<span class="cm"> *   allocation/deallocation scheme just let them use it.</span>
<span class="cm"> *</span>
<span class="cm"> *   If the source port is outside our allocation range, the caller is</span>
<span class="cm"> *   responsible for keeping track of their port usage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sock_get_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ports_map</span> <span class="o">*</span><span class="n">pmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, p#%u %s, NO port map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;source port NON-ZERO %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">&gt;=</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, p#%u %s, ALL ports used.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span>
				<span class="n">htons</span><span class="p">(</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">sport_base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">csk</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
				<span class="s">&quot;cdev 0x%p, p#%u %s, p %u, %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">sport_base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* should not happen */</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, p#%u %s, next %u?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sock_put_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ports_map</span> <span class="o">*</span><span class="n">pmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span> <span class="o">-</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">sport_base</span><span class="p">;</span>

		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">pmap</span><span class="o">-&gt;</span><span class="n">max_connect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, p#%u %s, port %u OOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
				<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">port_csk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;cdev 0x%p, p#%u %s, release %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">pmap</span><span class="o">-&gt;</span><span class="n">sport_base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * iscsi tcp connection</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cxgbi_sock_free_cpl_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_close</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span><span class="p">);</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cpl_abort_rpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_free_cpl_skbs</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="nf">cxgbi_sock_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">csk</span><span class="p">),</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;alloc csk %zu failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">csk</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_alloc_cpls</span><span class="p">(</span><span class="n">csk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, alloc cpls failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">retry_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CLOSED</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;cdev 0x%p, new csk 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">csk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="nf">find_route_ipv4</span><span class="p">(</span><span class="k">struct</span> <span class="n">flowi4</span> <span class="o">*</span><span class="n">fl4</span><span class="p">,</span>
				      <span class="n">__be32</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">daddr</span><span class="p">,</span>
				      <span class="n">__be16</span> <span class="n">sport</span><span class="p">,</span> <span class="n">__be16</span> <span class="n">dport</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">ip_route_output_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">fl4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span>
				   <span class="n">dport</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="nf">cxgbi_check_route</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">daddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtable</span> <span class="o">*</span><span class="n">rt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flowi4</span> <span class="n">fl4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_family</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;address family 0x%x NOT supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_family</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAFNOSUPPORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">find_route_ipv4</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;no route to ipv4 0x%x, port %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">dst_get_neighbour_noref</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_rt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTCF_MULTICAST</span> <span class="o">|</span> <span class="n">RTCF_BROADCAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;multi-cast route %pI4, port %u, dev %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">),</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_rt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">ip_dev_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">);</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rt dev %s, loopback -&gt; %s, mtu %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cdev</span> <span class="o">=</span> <span class="n">cxgbi_device_find_by_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;dst %pI4, %s, NOT cxgbi device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENETUNREACH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_rt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;route to %pI4 :%u, ndev p#%d,%s, cdev 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">),</span>
			   <span class="n">port</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">cxgbi_sock_create</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rel_rt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">daddr</span><span class="o">-&gt;</span><span class="n">sin_family</span><span class="p">;</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">csk</span><span class="p">;</span>

<span class="nl">rel_rt:</span>
	<span class="n">ip_rt_put</span><span class="p">(</span><span class="n">rt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span>
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_established</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_isn</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_nxt</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">=</span> <span class="n">snd_isn</span><span class="p">;</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ESTABLISHED</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_established</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxgbi_inform_iscsi_conn_closing</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, state %u, flags 0x%lx, conn 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">)</span>
			<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">,</span>
					<span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
		<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_closed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ACTIVE_CLOSE_NEEDED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ACTIVE_OPEN</span> <span class="o">||</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_CLOSED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span>
		<span class="n">sock_put_port</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span>
		<span class="n">dst_release</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_release_offload_resources</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CLOSED</span><span class="p">);</span>
	<span class="n">cxgbi_inform_iscsi_conn_closing</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_closed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">need_active_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data_lost</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">close_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dst_confirm</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">data_lost</span> <span class="o">=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>
	<span class="n">__skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">)</span>
		<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ACTIVE_CLOSE_NEEDED</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_ACTIVE_CLOSE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_PASSIVE_CLOSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CLOSE_WAIT_2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">close_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_lost</span><span class="p">)</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_abort_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_close_req</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,%lx, %pI4:%u-%pI4:%u, err %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">,</span>
			<span class="n">errno</span><span class="p">);</span>

	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CONNECTING</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
	<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_fail_act_open</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_act_open_req_arp_failure</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CTP_ACTIVE_OPEN</span><span class="p">)</span>
		<span class="n">cxgbi_sock_fail_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_act_open_req_arp_failure</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_rcv_abort_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_RCVD</span><span class="p">))</span>
			<span class="n">cxgbi_sock_set_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_RCVD</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_RCVD</span><span class="p">);</span>
			<span class="n">cxgbi_sock_clear_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_REQ_RCVD</span><span class="p">))</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u,ABT_RPL_RSS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_rcv_abort_rpl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_rcv_peer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTP_ESTABLISHED</span>:
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_PASSIVE_CLOSE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTP_ACTIVE_CLOSE</span>:
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CLOSE_WAIT_2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTP_CLOSE_WAIT_1</span>:
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTP_ABORTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, bad state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cxgbi_inform_iscsi_conn_closing</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_rcv_peer_close</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_rcv_close_conn_rpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">snd_nxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span> <span class="s">&quot;csk 0x%p,%u,0x%lx,%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">csk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">=</span> <span class="n">snd_nxt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_flag</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTPF_ABORT_RPL_PENDING</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTP_ACTIVE_CLOSE</span>:
		<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CLOSE_WAIT_1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTP_CLOSE_WAIT_1</span>:
	<span class="k">case</span> <span class="n">CTP_CLOSE_WAIT_2</span>:
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTP_ABORTING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, bad state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_rcv_close_conn_rpl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_rcv_wr_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credits</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">snd_una</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq_chk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_TOE</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, cr %u,%u+%u, snd_una %u,%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span><span class="p">,</span> <span class="n">snd_una</span><span class="p">,</span> <span class="n">seq_chk</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">+=</span> <span class="n">credits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">&gt;</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span> <span class="o">-</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span> <span class="o">-</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">credits</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cxgbi_sock_peek_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, cr %u,%u+%u, empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, cr %u,%u+%u, &lt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
				<span class="n">credits</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_una_cred</span><span class="p">,</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">-=</span> <span class="n">credits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cxgbi_sock_dequeue_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
			<span class="n">credits</span> <span class="o">-=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cxgbi_sock_check_wr_invariants</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_chk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">before</span><span class="p">(</span><span class="n">snd_una</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;csk 0x%p,%u,0x%lx,%u, snd_una %u/%u.&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">snd_una</span><span class="p">,</span>
				<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">!=</span> <span class="n">snd_una</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">=</span> <span class="n">snd_una</span><span class="p">;</span>
			<span class="n">dst_confirm</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">cxgbi_conn_tx_open</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cxgbi_conn_tx_open</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_rcv_wr_ack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgbi_sock_find_best_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">nmtus</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mtu</span><span class="p">)</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cxgbi_sock_select_mss</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pmtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dst_entry</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">;</span>

	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">dst_metric_advmss</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">&gt;</span> <span class="n">pmtu</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">pmtu</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">&lt;</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mtus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">40</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">cxgbi_sock_find_best_mtu</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">advmss</span> <span class="o">+</span> <span class="mi">40</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_select_mss</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_skb_entail</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgbi_skcb_tcp_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span><span class="p">;</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_skb_entail</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_purge_wr_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">cxgbi_sock_dequeue_wr</span><span class="p">(</span><span class="n">csk</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_purge_wr_queue</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_sock_check_wr_invariants</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">cxgbi_sock_count_pending_wrs</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span> <span class="o">+</span> <span class="n">pending</span> <span class="o">!=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p, tid %u, credit %u + %u != %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_cred</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">wr_max_cred</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_sock_check_wr_invariants</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgbi_sock_send_pdus</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, EAGAIN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, EPIPE %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">-</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">&gt;=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">snd_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p,%u,0x%lx,%u, FULL %u-%u &gt;= %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">snd_win</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p, skb head %u &lt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&gt;=</span> <span class="n">SKB_WR_LIST_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p, frags %d, %u,%u &gt;%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">csk</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">SKB_WR_LIST_SIZE</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cxgbi_skcb_set_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_TX_NEED_HDR</span><span class="p">);</span>
		<span class="n">cxgbi_sock_skb_entail</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_seq</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span>
				<span class="n">cxgbi_ulp_extra_len</span><span class="p">(</span><span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">write_queue</span><span class="p">)))</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_push_tx_frames</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">?</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">:</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Direct Data Placement -</span>
<span class="cm"> * Directly place the iSCSI Data-In or Data-Out PDU&#39;s payload into pre-posted</span>
<span class="cm"> * final destination host-memory buffers based on the Initiator Task Tag (ITT)</span>
<span class="cm"> * in Data-In or Target Task Tag (TTT) in Data-Out PDUs.</span>
<span class="cm"> * The host memory address is programmed into h/w in the format of pagepod</span>
<span class="cm"> * entries.</span>
<span class="cm"> * The location of the pagepod entry is encoded into ddp tag which is used as</span>
<span class="cm"> * the base for ITT/TTT.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ddp_page_order</span><span class="p">[</span><span class="n">DDP_PGIDX_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ddp_page_shift</span><span class="p">[</span><span class="n">DDP_PGIDX_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">page_idx</span> <span class="o">=</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sw_tag_idx_bits</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sw_tag_age_bits</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Direct-Data Placement page size adjustment</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_adjust_page_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_order</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ddp_page_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PAGE_SIZE 0x%lx too small, min 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ddp_page_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ddp_page_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* first is the kernel page size, then just doubling */</span>
		<span class="n">ddp_page_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span> <span class="o">-</span> <span class="n">base_order</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ddp_page_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAGE_SHIFT</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_find_page_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pgsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgsz</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ddp_page_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ddp page size %lu not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pgsz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_setup_host_page_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">==</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_idx</span> <span class="o">=</span> <span class="n">ddp_find_page_index</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">==</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;system PAGE %lu, update hw.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ddp_adjust_page_table</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PAGE %lu, disable ddp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">page_idx</span> <span class="o">=</span> <span class="n">ddp_find_page_index</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;system PAGE %lu, ddp idx %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">page_idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_ddp_page_size_factor</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">pgsz_factor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DDP_PGIDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pgsz_factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddp_page_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ddp_page_size_factor</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DDP setup &amp; teardown</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">cxgbi_ddp_ppod_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_pagepod</span> <span class="o">*</span><span class="n">ppod</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cxgbi_pagepod_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ppod</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">PPOD_PAGES_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">gidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppod</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gidx</span> <span class="o">&lt;</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">?</span>
				<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="n">gidx</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ddp_ppod_set</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_ddp_ppod_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_pagepod</span> <span class="o">*</span><span class="n">ppod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ppod</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ppod</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ddp_ppod_clear</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ddp_find_unused_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="cm">/*  not enough entries */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">max</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;NOT enough entries %u+%u &lt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">gl</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;NO suitable entries %u available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ddp_unmark_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span><span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ddp_gl_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ddp_gl_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_map_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">PAGE_SIZE</span><span class="p">,</span>
						<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
				<span class="s">&quot;page %d 0x%p, 0x%p dma mapping err.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="nl">unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nelem</span> <span class="o">=</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">;</span>

		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ddp_gl_unmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_release_gl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ddp_gl_unmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="nf">ddp_make_gl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xferlen</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sgcnt</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">sgpage</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sglen</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sgoffset</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">xferlen</span> <span class="o">+</span> <span class="n">sgoffset</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xferlen</span> <span class="o">&lt;</span> <span class="n">DDP_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;xfer %u &lt; threshold %u, no ddp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xferlen</span><span class="p">,</span> <span class="n">DDP_THRESHOLD</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_gather_list</span><span class="p">)</span> <span class="o">+</span>
		     <span class="n">npages</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">+</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;xfer %u, %u pages, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xferlen</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	 <span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;xfer %u, sgl %u, gl max %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xferlen</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">npages</span><span class="p">);</span>

	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="n">npages</span><span class="p">];</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">npages</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">xferlen</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">sgoffset</span><span class="p">;</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sgpage</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sgcnt</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sgpage</span> <span class="o">==</span> <span class="n">page</span> <span class="o">&amp;&amp;</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">sgoffset</span> <span class="o">+</span> <span class="n">sglen</span><span class="p">)</span>
			<span class="n">sglen</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*  make sure the sgl is fit for ddp:</span>
<span class="cm">			 *  each has the same page size, and</span>
<span class="cm">			 *  all of the middle pages are used completely</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="n">sgoffset</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="n">sgcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">sglen</span> <span class="o">+</span> <span class="n">sgoffset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
					<span class="s">&quot;page %d/%u, %u + %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">sgoffset</span><span class="p">,</span> <span class="n">sglen</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">||</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
					<span class="s">&quot;page %d/%u, offset %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">j</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gl</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">sglen</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">sgoffset</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">sgpage</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="o">++</span><span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddp_gl_map</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gl</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_tag_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&gt;&gt;</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gl</span> <span class="o">||</span> <span class="o">!</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;tag 0x%x, idx %u, gl 0x%p, %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gl</span><span class="p">,</span> <span class="n">gl</span> <span class="o">?</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">npods</span> <span class="o">=</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">+</span> <span class="n">PPOD_PAGES_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PPOD_PAGES_SHIFT</span><span class="p">;</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;tag 0x%x, release idx %u, npods %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_clear</span><span class="p">(</span><span class="n">chba</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
		<span class="n">ddp_unmark_entries</span><span class="p">(</span><span class="n">ddp</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
		<span class="n">ddp_release_gl</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;tag 0x%x, idx %u &gt; max %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ddp_tag_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">sw_tag</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tagp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">,</span>
			   <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_tag_format</span> <span class="o">*</span><span class="n">tformat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_pagepod_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">npods</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">npods</span> <span class="o">=</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">+</span> <span class="n">PPOD_PAGES_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PPOD_PAGES_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">==</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ddp_find_unused_entries</span><span class="p">(</span><span class="n">ddp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">,</span>
							<span class="n">npods</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ddp_find_unused_entries</span><span class="p">(</span><span class="n">ddp</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
							<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">,</span> <span class="n">npods</span><span class="p">,</span>
							<span class="n">gl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">&gt;=</span> <span class="n">npods</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ddp_find_unused_entries</span><span class="p">(</span><span class="n">ddp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">min</span><span class="p">(</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">+</span> <span class="n">npods</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">),</span>
							<span class="n">npods</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;xferlen %u, gl %u, npods %u NO DDP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">cxgbi_ddp_tag_base</span><span class="p">(</span><span class="n">tformat</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">|=</span> <span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">vld_tid</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">PPOD_VALID_FLAG</span> <span class="o">|</span> <span class="n">PPOD_TID</span><span class="p">(</span><span class="n">tid</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">pgsz_tag_clr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">rsvd_tag_mask</span><span class="p">);</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">max_offset</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_set</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">,</span> <span class="n">gl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmark_entries</span><span class="p">;</span>

	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;xfer %u, gl %u,%u, tid 0x%x, tag 0x%x-&gt;0x%x(%u,%u).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span><span class="p">,</span> <span class="n">gl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		<span class="n">npods</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tagp</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unmark_entries:</span>
	<span class="n">ddp_unmark_entries</span><span class="p">(</span><span class="n">ddp</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgbi_ddp_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tagp</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sw_tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xferlen</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_tag_format</span> <span class="o">*</span><span class="n">tformat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">&gt;=</span> <span class="n">DDP_PGIDX_MAX</span> <span class="o">||</span> <span class="o">!</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span> <span class="o">||</span>
	    <span class="n">xferlen</span> <span class="o">&lt;</span> <span class="n">DDP_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;pgidx %u, xfer %u, NO ddp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page_idx</span><span class="p">,</span> <span class="n">xferlen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sw_tag_usable</span><span class="p">(</span><span class="n">tformat</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
			<span class="s">&quot;sw_tag 0x%x NOT usable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gl</span> <span class="o">=</span> <span class="n">ddp_make_gl</span><span class="p">(</span><span class="n">xferlen</span><span class="p">,</span> <span class="n">sgl</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ddp_tag_reserve</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">,</span> <span class="n">tagp</span><span class="p">,</span> <span class="n">gl</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ddp_release_gl</span><span class="p">(</span><span class="n">gl</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddp_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span><span class="p">,</span>
						<span class="n">refcnt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;kref 0, destroy ddp 0x%p, cdev 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ddp</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="n">gl</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">npods</span> <span class="o">=</span> <span class="p">(</span><span class="n">gl</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">+</span> <span class="n">PPOD_PAGES_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="o">&gt;&gt;</span> <span class="n">PPOD_PAGES_SHIFT</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, ddp %d + %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">npods</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">gl</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">npods</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cxgbi_free_big_mem</span><span class="p">(</span><span class="n">ddp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgbi_ddp_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, release ddp 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">ddp</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="n">ddp_destroy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ddp_cleanup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_ddp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">llimit</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ulimit</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_txsz</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_rxsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_ddp_info</span> <span class="o">*</span><span class="n">ddp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ppmax</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">ppmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulimit</span> <span class="o">-</span> <span class="n">llimit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PPOD_SIZE_SHIFT</span><span class="p">;</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">ppmax</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="n">PPOD_IDX_MAX_SIZE</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">PPOD_IDX_MAX_SIZE</span><span class="p">;</span>
	<span class="n">ppmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ddp</span> <span class="o">=</span> <span class="n">cxgbi_alloc_big_mem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_ddp_info</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">ppmax</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;cdev 0x%p, ddp ppmax %u OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">ppmax</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">gl_map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_gather_list</span> <span class="o">**</span><span class="p">)(</span><span class="n">ddp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ddp</span> <span class="o">=</span> <span class="n">ddp</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">map_lock</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>

	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">llimit</span> <span class="o">=</span> <span class="n">llimit</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">ulimit</span> <span class="o">=</span> <span class="n">ulimit</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_txsz</span><span class="p">,</span> <span class="n">ULP2_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_rxsz</span><span class="p">,</span> <span class="n">ULP2_MAX_PKT_SIZE</span><span class="p">);</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">nppods</span> <span class="o">=</span> <span class="n">ppmax</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_last</span> <span class="o">=</span> <span class="n">ppmax</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">rsvd_tag_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">+</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">sw_bits</span> <span class="o">=</span> <span class="n">sw_tag_idx_bits</span> <span class="o">+</span> <span class="n">sw_tag_age_bits</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_bits</span> <span class="o">=</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">idx_bits</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_shift</span> <span class="o">=</span> <span class="n">PPOD_IDX_SHIFT</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s tag format, sw %u, rsvd %u,%u, mask 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">sw_bits</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_bits</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_shift</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">.</span><span class="n">rsvd_mask</span><span class="p">);</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tx_max_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ULP2_MAX_PDU_PAYLOAD</span><span class="p">,</span>
				<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span> <span class="o">-</span> <span class="n">ISCSI_PDU_NONPAYLOAD_LEN</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_max_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ULP2_MAX_PDU_PAYLOAD</span><span class="p">,</span>
				<span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span> <span class="o">-</span> <span class="n">ISCSI_PDU_NONPAYLOAD_LEN</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;%s max payload size: %u/%u, %u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tx_max_size</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_txsz</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_max_size</span><span class="p">,</span> <span class="n">ddp</span><span class="o">-&gt;</span><span class="n">max_rxsz</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ddp_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * APIs interacting with open-iscsi libraries</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">padding</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">task_release_itt</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">itt_t</span> <span class="n">hdr_itt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_tag_format</span> <span class="o">*</span><span class="n">tformat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span><span class="n">hdr_itt</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		   <span class="s">&quot;cdev 0x%p, release tag 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cxgbi_is_ddp_tag</span><span class="p">(</span><span class="n">tformat</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
		<span class="n">ddp_tag_release</span><span class="p">(</span><span class="n">chba</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">task_reserve_itt</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">itt_t</span> <span class="o">*</span><span class="n">hdr_itt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_tag_format</span> <span class="o">*</span><span class="n">tformat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sw_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">&lt;&lt;</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">task_idx_bits</span><span class="p">)</span> <span class="o">|</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_ddp_reserve</span><span class="p">(</span><span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">,</span>
					<span class="n">scsi_in</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					<span class="n">scsi_in</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span>
					<span class="n">scsi_in</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
				<span class="s">&quot;csk 0x%p, R task 0x%p, %u,%u, no ddp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">scsi_in</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				<span class="n">scsi_in</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">cxgbi_set_non_ddp_tag</span><span class="p">(</span><span class="n">tformat</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">);</span>
	<span class="cm">/*  the itt need to sent in big-endian order */</span>
	<span class="o">*</span><span class="n">hdr_itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">itt_t</span><span class="p">)</span><span class="n">htonl</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, task 0x%p, 0x%x(0x%x,0x%x)-&gt;0x%x/0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">sw_tag</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="o">*</span><span class="n">hdr_itt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_parse_pdu_itt</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">itt_t</span> <span class="n">itt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">age</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">itt</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sw_bits</span><span class="p">;</span>

	<span class="n">sw_bits</span> <span class="o">=</span> <span class="n">cxgbi_tag_nonrsvd_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tag_format</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
		<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">sw_bits</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">task_idx_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">age</span><span class="p">)</span>
		<span class="o">*</span><span class="n">age</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw_bits</span> <span class="o">&gt;&gt;</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">task_idx_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISCSI_AGE_MASK</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_DDP</span><span class="p">,</span>
		<span class="s">&quot;cdev 0x%p, tag 0x%x/0x%x, -&gt; 0x%x(0x%x,0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdev</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">itt</span><span class="p">,</span> <span class="n">sw_bits</span><span class="p">,</span> <span class="n">idx</span> <span class="o">?</span> <span class="o">*</span><span class="n">idx</span> <span class="o">:</span> <span class="mh">0xFFFFF</span><span class="p">,</span>
		<span class="n">age</span> <span class="o">?</span> <span class="o">*</span><span class="n">age</span> <span class="o">:</span> <span class="mh">0xFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_parse_pdu_itt</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_conn_tx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, cid %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">iscsi_conn_queue_work</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_conn_tx_open</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * pdu receive, interact with libiscsi_tcp</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">read_pdu_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">offloaded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_read</span><span class="p">;</span>

	<span class="n">bytes_read</span> <span class="o">=</span> <span class="n">iscsi_tcp_recv_skb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_TCP_CONN_ERR</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;skb 0x%p, off %u, %d, TCP_ERR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_TCP_SUSPENDED</span>:
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;skb 0x%p, off %u, %d, TCP_SUSPEND, rc %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>
		<span class="cm">/* no transfer - just have caller flush queue */</span>
		<span class="k">return</span> <span class="n">bytes_read</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_TCP_SKB_DONE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;skb 0x%p, off %u, %d, TCP_SKB_DONE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * pdus should always fit in the skb and we should get</span>
<span class="cm">		 * segment done notifcation.</span>
<span class="cm">		 */</span>
		<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="s">&quot;Invalid pdu or skb.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_TCP_SEGMENT_DONE</span>:
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;skb 0x%p, off %u, %d, TCP_SEG_DONE, rc %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bytes_read</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;skb 0x%p, off %u, %d, invalid status %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skb_read_pdu_bhs</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;conn 0x%p, skb 0x%p, len %u, flag 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscsi_tcp_recv_segment_is_hdr</span><span class="p">(</span><span class="n">tcp_conn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;conn 0x%p, skb 0x%p, not hdr.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ISCSI_ERR_PROTO</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_HCRC_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;conn 0x%p, skb 0x%p, hcrc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ISCSI_ERR_HDR_DGST</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">read_pdu_skb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skb_read_pdu_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lskb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">offloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;conn 0x%p, skb 0x%p, len %u, flag 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DCRC_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;conn 0x%p, skb 0x%p, dcrc 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">conn</span><span class="p">,</span> <span class="n">lskb</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">lskb</span><span class="p">));</span>
		<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ISCSI_ERR_DATA_DGST</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_tcp_recv_segment_is_hdr</span><span class="p">(</span><span class="n">tcp_conn</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* coalesced, add header digest length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lskb</span> <span class="o">==</span> <span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">ISCSI_DIGEST_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">lskb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA_DDPD</span><span class="p">))</span>
		<span class="n">offloaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">ISCSI_OP_SCSI_DATA_IN</span><span class="p">)</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;skb 0x%p, op 0x%x, itt 0x%x, %u %s ddp&#39;ed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">),</span>
			<span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">datalen</span><span class="p">,</span> <span class="n">offloaded</span> <span class="o">?</span> <span class="s">&quot;is&quot;</span> <span class="o">:</span> <span class="s">&quot;not&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">read_pdu_skb</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offloaded</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csk_return_rx_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copied</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">must_send</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">credits</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p,%u,0x%lu,%u, seq %u, wup %u, thre %u, %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">,</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_credit_thres</span><span class="p">,</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rcv_win</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">credits</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">copied_seq</span> <span class="o">-</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">credits</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_credit_thres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">must_send</span> <span class="o">=</span> <span class="n">credits</span> <span class="o">+</span> <span class="mi">16384</span> <span class="o">&gt;=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rcv_win</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">must_send</span> <span class="o">||</span> <span class="n">credits</span> <span class="o">&gt;=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_credit_thres</span><span class="p">)</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">rcv_wup</span> <span class="o">+=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_send_rx_credits</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cxgbi_conn_pdu_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
		<span class="s">&quot;csk 0x%p, conn 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">conn</span> <span class="o">||</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">suspend_rx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, conn 0x%p, id %d, suspend_rx %lu!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">conn</span> <span class="o">?</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">:</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">conn</span> <span class="o">?</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">suspend_rx</span> <span class="o">:</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_STATUS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
					<span class="s">&quot;skb 0x%p, NOT ready 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">skb</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>

		<span class="n">read</span> <span class="o">+=</span> <span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span>
			<span class="s">&quot;csk 0x%p, skb 0x%p,%u,f 0x%lx, pdu len %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_COALESCED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">skb_read_pdu_bhs</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;coalesced bhs, csk 0x%p, skb 0x%p,%u, &quot;</span>
					<span class="s">&quot;f 0x%lx, plen %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">skb_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">skb_read_pdu_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
						<span class="n">err</span> <span class="o">+</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_rx_extra</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;coalesced data, csk 0x%p, skb 0x%p,%u, &quot;</span>
					<span class="s">&quot;f 0x%lx, plen %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">skb_read_pdu_bhs</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;bhs, csk 0x%p, skb 0x%p,%u, &quot;</span>
					<span class="s">&quot;f 0x%lx, plen %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">skb_done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_skcb_test_flag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SKCBF_RX_DATA</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dskb</span><span class="p">;</span>

				<span class="n">dskb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dskb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;csk 0x%p, skb 0x%p,%u, f 0x%lx,&quot;</span>
						<span class="s">&quot; plen %u, NO data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">skb_done</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">dskb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">receive_queue</span><span class="p">);</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">skb_read_pdu_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dskb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;data, csk 0x%p, skb 0x%p,%u, &quot;</span>
						<span class="s">&quot;f 0x%lx, plen %u, dskb 0x%p,&quot;</span>
						<span class="s">&quot;%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">cxgbi_skcb_flags</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						<span class="n">cxgbi_skcb_rx_pdulen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						<span class="n">dskb</span><span class="p">,</span> <span class="n">dskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">dskb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">skb_read_pdu_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">skb_done:</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_RX</span><span class="p">,</span> <span class="s">&quot;csk 0x%p, read %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csk</span><span class="o">-&gt;</span><span class="n">copied_seq</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>
		<span class="n">csk_return_rx_credits</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p, 0x%p, rx failed %d, read %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">csk</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>
		<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_conn_pdu_ready</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgl_seek_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sgcnt</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">off</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">**</span><span class="n">sgp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sgp</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgl_read_to_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sgoffset</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">frags</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">frag_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">datalen</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sglen</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">sgoffset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">copy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;sg %d NULL, len %u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sgoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sglen</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span> <span class="n">sglen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">page</span> <span class="o">==</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">page</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sgoffset</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">frag_max</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;too many pages %u, dlen %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">frag_max</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">sgoffset</span><span class="p">;</span>
			<span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">datalen</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">sgoffset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">sglen</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">datalen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgbi_conn_alloc_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">u8</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_task</span> <span class="o">*</span><span class="n">tcp_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_task_data</span> <span class="o">*</span><span class="n">tdata</span> <span class="o">=</span> <span class="n">iscsi_task_cxgbi_data</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">headroom</span> <span class="o">=</span> <span class="n">SKB_TX_ISCSI_PDU_HEADER_MAX</span><span class="p">;</span>

	<span class="n">tcp_task</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">tdata</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SKB_MAX_HEAD</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">ISCSI_OP_SCSI_DATA_OUT</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">ISCSI_OP_SCSI_CMD</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))))</span>
		<span class="cm">/* data could goes into skb head */</span>
		<span class="n">headroom</span> <span class="o">+=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
				<span class="n">SKB_MAX_HEAD</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">),</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">);</span>

	<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span> <span class="o">+</span> <span class="n">headroom</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">];</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_max</span> <span class="o">=</span> <span class="n">SKB_TX_ISCSI_PDU_HEADER_MAX</span><span class="p">;</span> <span class="cm">/* BHS + AHS */</span>

	<span class="cm">/* data_out uses scsi_cmd&#39;s itt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">ISCSI_OP_SCSI_DATA_OUT</span><span class="p">)</span>
		<span class="n">task_reserve_itt</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
		<span class="s">&quot;task 0x%p, op 0x%x, skb 0x%p,%u+%u/%u, itt 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">,</span> <span class="n">headroom</span><span class="p">,</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_conn_alloc_pdu</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tx_skb_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dcrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcrc</span> <span class="o">||</span> <span class="n">dcrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">submode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hcrc</span><span class="p">)</span>
			<span class="n">submode</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcrc</span><span class="p">)</span>
			<span class="n">submode</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULP2_MODE_ISCSI</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">submode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cxgbi_skcb_ulp_mode</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgbi_conn_init_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_task_data</span> <span class="o">*</span><span class="n">tdata</span> <span class="o">=</span> <span class="n">iscsi_task_cxgbi_data</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">datalen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">padlen</span> <span class="o">=</span> <span class="n">iscsi_padding</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
		<span class="s">&quot;task 0x%p,0x%p, skb 0x%p, 0x%x,0x%x,0x%x, %u+%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">,</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">),</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">tx_skb_setmode</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">,</span> <span class="n">datalen</span> <span class="o">?</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_data_buffer</span> <span class="o">*</span><span class="n">sdb</span> <span class="o">=</span> <span class="n">scsi_out</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sgl_seek_offset</span><span class="p">(</span>
					<span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span>
					<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">sgoffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;tpdu, sgl %u, bad offset %u/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">sdb</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sgl_read_to_frags</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">sgoffset</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
					<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">,</span> <span class="n">MAX_PDU_FRAGS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;tpdu, sgl %u, bad offset %u + %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">&gt;</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">padlen</span> <span class="o">&amp;&amp;</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">page_frag</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>

			<span class="cm">/* data fits in the skb&#39;s headroom */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="o">+</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
				<span class="n">dst</span> <span class="o">+=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
				<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">padlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">padlen</span><span class="p">);</span>
				<span class="n">padlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="n">padlen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* data fit into frag_list */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">,</span>
						<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
				<span class="n">skb_frag_ref</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pg</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">get_page</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
					<span class="n">count</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span>
				<span class="n">virt_to_page</span><span class="p">(</span><span class="n">padding</span><span class="p">),</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">padding</span><span class="p">),</span>
				<span class="n">padlen</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">padlen</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">padlen</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">padlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_conn_init_pdu</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_conn_xmit_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_task_data</span> <span class="o">*</span><span class="n">tdata</span> <span class="o">=</span> <span class="n">iscsi_task_cxgbi_data</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;task 0x%p, skb NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">datalen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_sock_send_pdus</span><span class="p">(</span><span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pdulen</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;task 0x%p,0x%p, skb 0x%p, len %u/%u, rv %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">)</span>
			<span class="n">pdulen</span> <span class="o">+=</span> <span class="n">ISCSI_DIGEST_SIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">)</span>
			<span class="n">pdulen</span> <span class="o">+=</span> <span class="n">ISCSI_DIGEST_SIZE</span><span class="p">;</span>

		<span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">+=</span> <span class="n">pdulen</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">||</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
			<span class="s">&quot;task 0x%p, skb 0x%p, len %u/%u, %d EAGAIN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">task</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* reset skb to send when we are called again */</span>
		<span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_PDU_TX</span><span class="p">,</span>
		<span class="s">&quot;itt 0x%x, skb 0x%p, len %u/%u, xmit err %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">iscsi_conn_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="s">&quot;xmit err %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">ISCSI_ERR_XMIT_FAILED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_conn_xmit_pdu</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_cleanup_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_task_data</span> <span class="o">*</span><span class="n">tdata</span> <span class="o">=</span> <span class="n">iscsi_task_cxgbi_data</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;task 0x%p, skb 0x%p, itt 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="p">,</span> <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_itt</span><span class="p">);</span>

	<span class="cm">/*  never reached the xmit task callout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">__kfree_skb</span><span class="p">(</span><span class="n">tdata</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdata</span><span class="p">));</span>

	<span class="n">task_release_itt</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_itt</span><span class="p">);</span>
	<span class="n">iscsi_tcp_cleanup_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_cleanup_task</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_get_conn_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">txdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dataout_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dataout_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">datain_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datain_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">r2t_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">r2t_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">digest_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;eh_abort_cnt&quot;</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">eh_abort_cnt</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_get_conn_stats</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgbi_conn_max_xmit_dlength</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">headroom</span> <span class="o">=</span> <span class="n">SKB_MAX_HEAD</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">skb_tx_rsvd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_def</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">max_def</span><span class="p">,</span> <span class="n">headroom</span><span class="p">);</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">tx_max_size</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">)</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">cxgbi_align_pdu_size</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxgbi_conn_max_recv_dlength</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">rx_max_size</span><span class="p">;</span>

	<span class="n">cxgbi_align_pdu_size</span><span class="p">(</span><span class="n">max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;MaxRecvDataSegmentLength %u &gt; %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">cxgbi_align_pdu_size</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cxgbi_set_conn_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;cls_conn 0x%p, param %d, buf(%d) %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_HDRDGST_EN</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_digest</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
							<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">,</span>
							<span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_DATADGST_EN</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_digest</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
							<span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">,</span>
							<span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_R2T</span>:
		<span class="k">return</span> <span class="n">iscsi_tcp_set_max_r2t</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_conn_max_recv_dlength</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">cxgbi_conn_max_xmit_dlength</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_set_conn_param</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_get_ep_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;cls_conn 0x%p, param %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

		<span class="n">csk</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csk</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">iscsi_conn_get_addr_param</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="p">)</span>
						 <span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_get_ep_param</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span>
<span class="nf">cxgbi_create_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span><span class="p">;</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">iscsi_tcp_conn_setup</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cconn</span><span class="p">),</span> <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">iconn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;cid %u(0x%x), cls 0x%p,0x%p, conn 0x%p,0x%p,0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cid</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">tcp_conn</span><span class="p">,</span> <span class="n">cconn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cls_conn</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_create_conn</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_bind_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">transport_eph</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_tcp_conn</span> <span class="o">*</span><span class="n">tcp_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">tcp_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_lookup_endpoint</span><span class="p">(</span><span class="n">transport_eph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*  setup ddp pagesize */</span>
	<span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">csk</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_ddp_setup_pgidx</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">page_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">iscsi_conn_bind</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">is_leading</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*  calculate the tag idx bits needed for this conn based on cmds_max */</span>
	<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">task_idx_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
	<span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">chba</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">chba</span><span class="p">;</span>
	<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span> <span class="o">=</span> <span class="n">cep</span><span class="p">;</span>
	<span class="n">cep</span><span class="o">-&gt;</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">cconn</span><span class="p">;</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>

	<span class="n">cxgbi_conn_max_xmit_dlength</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">cxgbi_conn_max_recv_dlength</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;cls 0x%p,0x%p, ep 0x%p, cconn 0x%p, csk 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">cconn</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
	<span class="cm">/*  init recv engine */</span>
	<span class="n">iscsi_tcp_hdr_recv_prep</span><span class="p">(</span><span class="n">tcp_conn</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_bind_conn</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="nf">cxgbi_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">cmds_max</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qdepth</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">initial_cmdsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;missing endpoint.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">chba</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">chba</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">chba</span> <span class="o">!=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>

	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">iscsi_session_setup</span><span class="p">(</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">itp</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
					<span class="n">cmds_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_tcp_task</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxgbi_task_data</span><span class="p">),</span>
					<span class="n">initial_cmdsn</span><span class="p">,</span> <span class="n">ISCSI_MAX_TARGET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_session</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_tcp_r2tpool_alloc</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">remove_session</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;ep 0x%p, cls sess 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">cls_session</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cls_session</span><span class="p">;</span>

<span class="nl">remove_session:</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_create_session</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_destroy_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;cls sess 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cls_session</span><span class="p">);</span>

	<span class="n">iscsi_tcp_r2tpool_free</span><span class="p">(</span><span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_destroy_session</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_set_host_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Could not get host param. &quot;</span>
				<span class="s">&quot;netdev for host not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;shost 0x%p, hba 0x%p,%s, param %d, buf(%d) %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">shost</span><span class="p">,</span> <span class="n">chba</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
	<span class="p">{</span>
		<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
			<span class="s">&quot;hba %s, req. ipv4 %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">cxgbi_set_iscsi_ipv4</span><span class="p">(</span><span class="n">chba</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_NETDEV_NAME</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_host_set_param</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_set_host_param</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_get_host_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">chba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Could not get host param. &quot;</span>
				<span class="s">&quot;netdev for host not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;shost 0x%p, hba 0x%p,%s, param %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">shost</span><span class="p">,</span> <span class="n">chba</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_NETDEV_NAME</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
	<span class="p">{</span>
		<span class="n">__be32</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">cxgbi_get_iscsi_ipv4</span><span class="p">(</span><span class="n">chba</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
			<span class="s">&quot;hba %s, ipv4 %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_host_get_param</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_get_host_param</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="nf">cxgbi_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">non_blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;shost 0x%p, non_blocking %d, dst_addr 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">shost</span><span class="p">,</span> <span class="n">non_blocking</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;shost 0x%p, priv NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">csk</span> <span class="o">=</span> <span class="n">cxgbi_check_route</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">csk</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="p">)</span><span class="n">csk</span><span class="p">;</span>
	<span class="n">cxgbi_sock_get</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Could not connect through requested host %u&quot;</span>
			<span class="s">&quot;hba 0x%p != 0x%p (%u).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">hba</span><span class="p">,</span>
			<span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">hbas</span><span class="p">[</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">],</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sock_get_port</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release_conn</span><span class="p">;</span>

	<span class="n">cxgbi_sock_set_state</span><span class="p">(</span><span class="n">csk</span><span class="p">,</span> <span class="n">CTP_CONNECTING</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">csk_init_act_open</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release_conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cxgbi_sock_is_closing</span><span class="p">(</span><span class="n">csk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;csk 0x%p is closing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_create_endpoint</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cep</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;iscsi alloc ep, OOM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release_conn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span> <span class="o">=</span> <span class="n">csk</span><span class="p">;</span>
	<span class="n">cep</span><span class="o">-&gt;</span><span class="n">chba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;ep 0x%p, cep 0x%p, csk 0x%p, hba 0x%p,%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="p">,</span> <span class="n">cep</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">hba</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>

<span class="nl">release_conn:</span>
	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ep_connect</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cxgbi_sock_is_established</span><span class="p">(</span><span class="n">csk</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ep_poll</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxgbi_endpoint</span> <span class="o">*</span><span class="n">cep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_conn</span> <span class="o">*</span><span class="n">cconn</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">cconn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxgbi_sock</span> <span class="o">*</span><span class="n">csk</span> <span class="o">=</span> <span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="p">;</span>

	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_SOCK</span><span class="p">,</span>
		<span class="s">&quot;ep 0x%p, cep 0x%p, cconn 0x%p, csk 0x%p,%u,0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ep</span><span class="p">,</span> <span class="n">cep</span><span class="p">,</span> <span class="n">cconn</span><span class="p">,</span> <span class="n">csk</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">csk</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cconn</span> <span class="o">&amp;&amp;</span> <span class="n">cconn</span><span class="o">-&gt;</span><span class="n">iconn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_suspend_tx</span><span class="p">(</span><span class="n">cconn</span><span class="o">-&gt;</span><span class="n">iconn</span><span class="p">);</span>
		<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
		<span class="n">cep</span><span class="o">-&gt;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">user_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cconn</span><span class="o">-&gt;</span><span class="n">cep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">callback_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">csk</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CTP_ESTABLISHED</span><span class="p">))</span>
		<span class="n">need_active_close</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cxgbi_sock_closed</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>

	<span class="n">cxgbi_sock_put</span><span class="p">(</span><span class="n">csk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_ep_disconnect</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cxgbi_iscsi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">itp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">**</span><span class="n">stt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">stt</span> <span class="o">=</span> <span class="n">iscsi_register_transport</span><span class="p">(</span><span class="n">itp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register %s transport 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">itp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">itp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
		<span class="s">&quot;%s, registered iscsi transport 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">itp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_iscsi_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cxgbi_iscsi_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="o">*</span><span class="n">itp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">**</span><span class="n">stt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">stt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">log_debug</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CXGBI_DBG_ISCSI</span><span class="p">,</span>
			<span class="s">&quot;de-register transport 0x%p, %s, stt 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">itp</span><span class="p">,</span> <span class="n">itp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">stt</span><span class="p">);</span>
		<span class="o">*</span><span class="n">stt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="n">itp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_iscsi_cleanup</span><span class="p">);</span>

<span class="n">umode_t</span> <span class="nf">cxgbi_attr_is_visible</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_NETDEV_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_INITIATOR_NAME</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_HDRDGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATADGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_EXP_STATSN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PING_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_RECV_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIAL_R2T_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_R2T</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IMM_DATA_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FIRST_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PDU_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATASEQ_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ERL</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TARGET_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TPGT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FAST_ABORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ABORT_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_LU_RESET_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TGT_RESET_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IFACE_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIATOR_NAME</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cxgbi_attr_is_visible</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">libcxgbi_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sw_tag_idx_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">ISCSI_ITT_MASK</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sw_tag_age_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">ISCSI_AGE_MASK</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tag itt 0x%x, %u bits, age 0x%x, %u bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ISCSI_ITT_MASK</span><span class="p">,</span> <span class="n">sw_tag_idx_bits</span><span class="p">,</span>
		<span class="n">ISCSI_AGE_MASK</span><span class="p">,</span> <span class="n">sw_tag_age_bits</span><span class="p">);</span>

	<span class="n">ddp_setup_host_page_size</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">libcxgbi_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cxgbi_device_unregister_all</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">libcxgbi_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">libcxgbi_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
