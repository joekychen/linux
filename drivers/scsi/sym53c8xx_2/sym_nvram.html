<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › sym53c8xx_2 › sym_nvram.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sym_nvram.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Device driver for the SYMBIOS/LSILOGIC 53C8XX and 53C1010 family </span>
<span class="cm"> * of PCI-SCSI IO processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2001  Gerard Roudier &lt;groudier@free.fr&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is derived from the Linux sym53c8xx driver.</span>
<span class="cm"> * Copyright (C) 1998-2000  Gerard Roudier</span>
<span class="cm"> *</span>
<span class="cm"> * The sym53c8xx driver is derived from the ncr53c8xx driver that had been </span>
<span class="cm"> * a port of the FreeBSD ncr driver to Linux-1.2.13.</span>
<span class="cm"> *</span>
<span class="cm"> * The original ncr driver has been written for 386bsd and FreeBSD by</span>
<span class="cm"> *         Wolfgang Stanglmeier        &lt;wolf@cologne.de&gt;</span>
<span class="cm"> *         Stefan Esser                &lt;se@mi.Uni-Koeln.de&gt;</span>
<span class="cm"> * Copyright (C) 1994  Wolfgang Stanglmeier</span>
<span class="cm"> *</span>
<span class="cm"> * Other major contributions:</span>
<span class="cm"> *</span>
<span class="cm"> * NVRAM detection and reading.</span>
<span class="cm"> * Copyright (C) 1997 Richard Waltham &lt;dormouse@farsrobt.demon.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *-----------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;sym_glue.h&quot;</span>
<span class="cp">#include &quot;sym_nvram.h&quot;</span>

<span class="cp">#ifdef	SYM_CONF_DEBUG_NVRAM</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">Tekram_boot_delay</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Get host setup from NVRAM.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sym_nvram_setup_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sym_hcb</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sym_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Get parity checking, host ID, verbose mode </span>
<span class="cm">	 *  and miscellaneous host flags from NVRAM.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYM_SYMBIOS_NVRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_PARITY_ENABLE</span><span class="p">))</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rv_scntl0</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0a</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">myaddr</span> <span class="o">=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">.</span><span class="n">host_id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_VERBOSE_MSGS</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">.</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_HI_LO</span><span class="p">)</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">reverse_ordering</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">.</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_AVOID_BUS_RESET</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">usrflags</span> <span class="o">|=</span> <span class="n">SYM_AVOID_BUS_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYM_TEKRAM_NVRAM</span>:
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">myaddr</span> <span class="o">=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Tekram</span><span class="p">.</span><span class="n">host_id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PARISC</span>
	<span class="k">case</span> <span class="n">SYM_PARISC_PDC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">host_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">myaddr</span> <span class="o">=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">host_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">factor</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">minsync</span> <span class="o">=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">factor</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">maxwide</span> <span class="o">=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">np</span><span class="o">-&gt;</span><span class="n">scsi_mode</span> <span class="o">=</span> <span class="n">SMODE_SE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">np</span><span class="o">-&gt;</span><span class="n">scsi_mode</span> <span class="o">=</span> <span class="n">SMODE_HVD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">np</span><span class="o">-&gt;</span><span class="n">scsi_mode</span> <span class="o">=</span> <span class="n">SMODE_LVD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Get target set-up from Symbios format NVRAM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sym_Symbios_setup_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_tcb</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">Symbios_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Symbios_target</span> <span class="o">*</span><span class="n">tn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_QUEUE_TAGS_ENABLED</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrtags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_DISCONNECT_ENABLE</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYM_DISC_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_AT_BOOT_TIME</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrflags</span> <span class="o">|=</span> <span class="n">SYM_SCAN_BOOT_DISABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_LUNS</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrflags</span> <span class="o">|=</span> <span class="n">SYM_SCAN_LUNS_DISABLED</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usr_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usr_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Tekram_sync</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">25</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Get target set-up from Tekram format NVRAM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sym_Tekram_setup_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_tcb</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">Tekram_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Tekram_target</span> <span class="o">*</span><span class="n">tn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_TAGGED_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrtags</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">max_tags_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_DISCONNECT_ENABLE</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usrflags</span> <span class="o">|=</span> <span class="n">SYM_DISC_ENABLED</span><span class="p">;</span>
 
	<span class="k">if</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_SYNC_NEGO</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usr_period</span> <span class="o">=</span> <span class="n">Tekram_sync</span><span class="p">[</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">sync_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">usr_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_WIDE_NEGO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Get target setup from NVRAM.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sym_nvram_setup_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_tcb</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sym_nvram</span> <span class="o">*</span><span class="n">nvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYM_SYMBIOS_NVRAM</span>:
		<span class="n">sym_Symbios_setup_target</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYM_TEKRAM_NVRAM</span>:
		<span class="n">sym_Tekram_setup_target</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Tekram</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef	SYM_CONF_DEBUG_NVRAM</span>
<span class="cm">/*</span>
<span class="cm"> *  Dump Symbios format NVRAM for debugging purpose.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_display_Symbios_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Symbios_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* display Symbios nvram host data */</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s: HOST ID=%d%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sym_name</span><span class="p">(</span><span class="n">np</span><span class="p">),</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">host_id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAM_ENABLE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; SCAM&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">&amp;</span> <span class="n">SYMBIOS_PARITY_ENABLE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; PARITY&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">&amp;</span> <span class="n">SYMBIOS_VERBOSE_MSGS</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; VERBOSE&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> 
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span>  <span class="o">&amp;</span> <span class="n">SYMBIOS_CHS_MAPPING</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; CHS_ALT&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> 
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_AVOID_BUS_RESET</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; NO_RESET&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_HI_LO</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; HI_LO&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* display Symbios nvram drive data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">Symbios_target</span> <span class="o">*</span><span class="n">tn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s-%d:%s%s%s%s WIDTH=%d SYNC=%d TMO=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sym_name</span><span class="p">(</span><span class="n">np</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_DISCONNECT_ENABLE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; DISC&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_AT_BOOT_TIME</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; SCAN_BOOT&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAN_LUNS</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot; SCAN_LUNS&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_QUEUE_TAGS_ENABLED</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot; TCQ&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">tn</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">,</span>
		<span class="n">tn</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">tn</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Dump TEKRAM format NVRAM for debugging purpose.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_display_Tekram_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Tekram_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">boot_delay</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rem</span><span class="p">;</span>

	<span class="cm">/* display Tekram nvram host data */</span>
	<span class="n">tags</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">max_tags_index</span><span class="p">;</span>
	<span class="n">boot_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">boot_delay_index</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">boot_delay</span> <span class="o">=</span> <span class="n">Tekram_boot_delay</span><span class="p">[</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">boot_delay_index</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_REMOVABLE_FLAGS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="n">rem</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">rem</span> <span class="o">=</span> <span class="s">&quot; REMOVABLE=boot device&quot;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">rem</span> <span class="o">=</span> <span class="s">&quot; REMOVABLE=all&quot;</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s: HOST ID=%d%s%s%s%s%s%s%s%s%s BOOT DELAY=%d tags=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sym_name</span><span class="p">(</span><span class="n">np</span><span class="p">),</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">host_id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">SYMBIOS_SCAM_ENABLE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; SCAM&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_MORE_THAN_2_DRIVES</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; &gt;2DRIVES&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_DRIVES_SUP_1GB</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; &gt;1GB&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_RESET_ON_POWER_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RESET&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_ACTIVE_NEGATION</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; ACT_NEG&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_IMMEDIATE_SEEK</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; IMM_SEEK&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_SCAN_LUNS</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; SCAN_LUNS&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">TEKRAM_F2_F6_ENABLED</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; F2_F6&quot;</span>	<span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">rem</span><span class="p">,</span> <span class="n">boot_delay</span><span class="p">,</span> <span class="n">tags</span><span class="p">);</span>

	<span class="cm">/* display Tekram nvram drive data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sync</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">Tekram_target</span> <span class="o">*</span><span class="n">tn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">tn</span><span class="o">-&gt;</span><span class="n">sync_index</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="n">Tekram_sync</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s-%d:%s%s%s%s%s%s PERIOD=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sym_name</span><span class="p">(</span><span class="n">np</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_PARITY_CHECK</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; PARITY&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_SYNC_NEGO</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot; SYNC&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_DISCONNECT_ENABLE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; DISC&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_START_CMD</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot; START&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_TAGGED_COMMANDS</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot; TCQ&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TEKRAM_WIDE_NEGO</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot; WIDE&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">sync</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_display_Symbios_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Symbios_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">np</span><span class="p">;</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">nvram</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_display_Tekram_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Tekram_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">np</span><span class="p">;</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">nvram</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* SYM_CONF_DEBUG_NVRAM */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> *  24C16 EEPROM reading.</span>
<span class="cm"> *</span>
<span class="cm"> *  GPOI0 - data in/data out</span>
<span class="cm"> *  GPIO1 - clock</span>
<span class="cm"> *  Symbios NVRAM wiring now also used by Tekram.</span>
<span class="cm"> */</span>

<span class="cp">#define SET_BIT 0</span>
<span class="cp">#define CLR_BIT 1</span>
<span class="cp">#define SET_CLK 2</span>
<span class="cp">#define CLR_CLK 3</span>

<span class="cm">/*</span>
<span class="cm"> *  Set/clear data/clock bit in GPIO0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">write_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">,</span> 
			  <span class="kt">int</span> <span class="n">bit_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bit_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_BIT</span>:
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">|=</span> <span class="n">write_bit</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLR_BIT</span>:
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_CLK</span>:
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLR_CLK</span>:
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">&amp;=</span> <span class="mh">0xfd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">);</span>
	<span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_mbox1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Send START condition to NVRAM to wake it up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_BIT</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_CLK</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_BIT</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_CLK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Send STOP condition to NVRAM - puts NVRAM to sleep... ZZzzzz!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_CLK</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_BIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Read or write a bit to the NVRAM,</span>
<span class="cm"> *  read if GPIO0 input else write if GPIO0 output</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_do_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">write_bit</span><span class="p">,</span> 
			 <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">write_bit</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_BIT</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">SET_CLK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_bit</span><span class="p">)</span>
		<span class="o">*</span><span class="n">read_bit</span> <span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_CLK</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_BIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Output an ACK to the NVRAM after reading,</span>
<span class="cm"> *  change GPIO0 to output and when done back to an input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_write_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">write_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">,</span> 
			    <span class="n">u_char</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="o">*</span><span class="n">gpcntl</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">);</span>
	<span class="n">S24C16_do_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">write_bit</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Input an ACK from NVRAM after writing,</span>
<span class="cm"> *  change GPIO0 to input and when done back to an output</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_read_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">,</span> 
			   <span class="n">u_char</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="o">*</span><span class="n">gpcntl</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">S24C16_do_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">read_bit</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  WRITE a byte to the NVRAM and then get an ACK to see it was accepted OK,</span>
<span class="cm"> *  GPIO0 must already be set as an output</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ack_data</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">write_data</span><span class="p">,</span> 
			     <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">S24C16_do_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">write_data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
		
	<span class="n">S24C16_read_ack</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ack_data</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  READ a byte from the NVRAM and then send an ACK to say we have got it,</span>
<span class="cm"> *  GPIO0 must already be set as an input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">S24C16_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">read_data</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">ack_data</span><span class="p">,</span> 
			    <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpcntl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">read_bit</span><span class="p">;</span>

	<span class="o">*</span><span class="n">read_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">S24C16_do_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_bit</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">read_data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">read_bit</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">x</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">S24C16_write_ack</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">ack_data</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef SYM_CONF_NVRAM_WRITE_SUPPORT</span>
<span class="cm">/*</span>
<span class="cm"> *  Write &#39;len&#39; bytes starting at &#39;offset&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_write_S24C16_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>	<span class="n">gpcntl</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="n">old_gpcntl</span><span class="p">,</span> <span class="n">old_gpreg</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="n">ack_data</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">x</span><span class="p">;</span>

	<span class="cm">/* save current state of GPCNTL and GPREG */</span>
	<span class="n">old_gpreg</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
	<span class="n">old_gpcntl</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">);</span>
	<span class="n">gpcntl</span>		<span class="o">=</span> <span class="n">old_gpcntl</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">;</span>

	<span class="cm">/* set up GPREG &amp; GPCNTL to set GPIO0 and GPIO1 in to known state */</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span>  <span class="n">old_gpreg</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>

	<span class="cm">/* this is to set NVRAM into a known state with GPIO0/1 both low */</span>
	<span class="n">gpreg</span> <span class="o">=</span> <span class="n">old_gpreg</span><span class="p">;</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_CLK</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_BIT</span><span class="p">);</span>
		
	<span class="cm">/* now set NVRAM inactive with GPIO0/1 both high */</span>
	<span class="n">S24C16_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>

	<span class="cm">/* NVRAM has to be written in segments of 16 bytes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">S24C16_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
			<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span>
					  <span class="mh">0xa0</span> <span class="o">|</span> <span class="p">(((</span><span class="n">offset</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ack_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> 
				  <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
			<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">],</span> 
					  <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>
		<span class="n">S24C16_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* return GPIO0/1 to original states after having accessed NVRAM */</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">old_gpcntl</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span>  <span class="n">old_gpreg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* SYM_CONF_NVRAM_WRITE_SUPPORT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Read &#39;len&#39; bytes starting at &#39;offset&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_read_S24C16_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>	<span class="n">gpcntl</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="n">old_gpcntl</span><span class="p">,</span> <span class="n">old_gpreg</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="n">ack_data</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">retv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">x</span><span class="p">;</span>

	<span class="cm">/* save current state of GPCNTL and GPREG */</span>
	<span class="n">old_gpreg</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
	<span class="n">old_gpcntl</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">);</span>
	<span class="n">gpcntl</span>		<span class="o">=</span> <span class="n">old_gpcntl</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">;</span>

	<span class="cm">/* set up GPREG &amp; GPCNTL to set GPIO0 and GPIO1 in to known state */</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span>  <span class="n">old_gpreg</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>

	<span class="cm">/* this is to set NVRAM into a known state with GPIO0/1 both low */</span>
	<span class="n">gpreg</span> <span class="o">=</span> <span class="n">old_gpreg</span><span class="p">;</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_CLK</span><span class="p">);</span>
	<span class="n">S24C16_set_bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="n">CLR_BIT</span><span class="p">);</span>
		
	<span class="cm">/* now set NVRAM inactive with GPIO0/1 both high */</span>
	<span class="n">S24C16_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
	
	<span class="cm">/* activate NVRAM */</span>
	<span class="n">S24C16_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>

	<span class="cm">/* write device code and random address MSB */</span>
	<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span>
		<span class="mh">0xa0</span> <span class="o">|</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* write random address LSB */</span>
	<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span>
		<span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* regenerate START state to set up for reading */</span>
	<span class="n">S24C16_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
	
	<span class="cm">/* rewrite device code and address MSB with read bit set (lsb = 0x01) */</span>
	<span class="n">S24C16_write_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_data</span><span class="p">,</span>
		<span class="mh">0xa1</span> <span class="o">|</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* now set up GPIO0 for inputting data */</span>
	<span class="n">gpcntl</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>
		
	<span class="cm">/* input all requested data - only part of total NVRAM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> 
		<span class="n">S24C16_read_byte</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="p">(</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpcntl</span><span class="p">);</span>

	<span class="cm">/* finally put NVRAM back in inactive mode */</span>
	<span class="n">gpcntl</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>
	<span class="n">S24C16_stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
	<span class="n">retv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="cm">/* return GPIO0/1 to original states after having accessed NVRAM */</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">old_gpcntl</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span>  <span class="n">old_gpreg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef SET_BIT</span>
<span class="cp">#undef CLR_BIT</span>
<span class="cp">#undef SET_CLK</span>
<span class="cp">#undef CLR_CLK</span>

<span class="cm">/*</span>
<span class="cm"> *  Try reading Symbios NVRAM.</span>
<span class="cm"> *  Return 0 if OK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_read_Symbios_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Symbios_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u_char</span> <span class="n">Symbios_trailer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">nvram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">u_short</span>	<span class="n">csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="cm">/* probe the 24c16 and read the SYMBIOS 24c16 area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym_read_S24C16_nvram</span> <span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">SYMBIOS_NVRAM_ADDRESS</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check valid NVRAM signature, verify byte count and checksum */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">nvram</span><span class="o">-&gt;</span><span class="n">trailer</span><span class="p">,</span> <span class="n">Symbios_trailer</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">!=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* verify checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="n">nvram</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  93C46 EEPROM reading.</span>
<span class="cm"> *</span>
<span class="cm"> *  GPOI0 - data in</span>
<span class="cm"> *  GPIO1 - data out</span>
<span class="cm"> *  GPIO2 - clock</span>
<span class="cm"> *  GPIO4 - chip select</span>
<span class="cm"> *</span>
<span class="cm"> *  Used by Tekram.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Pulse clock bit in GPIO0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="o">*</span><span class="n">gpreg</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_mbox1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> *  Read bit from NVRAM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Read_Bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">T93C46_Clk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
	<span class="o">*</span><span class="n">read_bit</span> <span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Write bit to GPIO0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Write_Bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">write_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_bit</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">gpreg</span> <span class="o">&amp;=</span> <span class="mh">0xfd</span><span class="p">;</span>
		
	<span class="o">*</span><span class="n">gpreg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">);</span>
	<span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_mbox1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">T93C46_Clk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Send STOP condition to NVRAM - puts NVRAM to sleep... ZZZzzz!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">gpreg</span> <span class="o">&amp;=</span> <span class="mh">0xef</span><span class="p">;</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">);</span>
	<span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_mbox1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">T93C46_Clk</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Send read command and address to NVRAM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Send_Command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">write_data</span><span class="p">,</span> 
				<span class="n">u_char</span> <span class="o">*</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="cm">/* send 9 bits, start bit (1), command (2), address (6)  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
		<span class="n">T93C46_Write_Bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">write_data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">x</span><span class="p">)),</span> <span class="n">gpreg</span><span class="p">);</span>

	<span class="o">*</span><span class="n">read_bit</span> <span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  READ 2 bytes from the NVRAM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">T93C46_Read_Word</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">nvram_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">read_bit</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nvram_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">T93C46_Read_Bit</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_bit</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="o">*</span><span class="n">nvram_data</span> <span class="o">|=</span>  <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">x</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">nvram_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">x</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Read Tekram NvRAM data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">T93C46_Read_Data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gpreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>  <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">read_bit</span><span class="p">;</span>
		<span class="cm">/* output read command and address */</span>
		<span class="n">T93C46_Send_Command</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mh">0x180</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_bit</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_bit</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Bad */</span>
		<span class="n">T93C46_Read_Word</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">gpreg</span><span class="p">);</span>
		<span class="n">T93C46_Stop</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Try reading 93C46 Tekram NVRAM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_read_T93C46_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Tekram_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">gpcntl</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">old_gpcntl</span><span class="p">,</span> <span class="n">old_gpreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* save current state of GPCNTL and GPREG */</span>
	<span class="n">old_gpreg</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">);</span>
	<span class="n">old_gpcntl</span>	<span class="o">=</span> <span class="n">INB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">);</span>

	<span class="cm">/* set up GPREG &amp; GPCNTL to set GPIO0/1/2/4 in to known state, 0 in,</span>
<span class="cm">	   1/2/4 out */</span>
	<span class="n">gpreg</span> <span class="o">=</span> <span class="n">old_gpreg</span> <span class="o">&amp;</span> <span class="mh">0xe9</span><span class="p">;</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span> <span class="n">gpreg</span><span class="p">);</span>
	<span class="n">gpcntl</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_gpcntl</span> <span class="o">&amp;</span> <span class="mh">0xe9</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">gpcntl</span><span class="p">);</span>

	<span class="cm">/* input all of NVRAM, 64 words */</span>
	<span class="n">retv</span> <span class="o">=</span> <span class="n">T93C46_Read_Data</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">nvram</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nvram</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">gpreg</span><span class="p">);</span>
	
	<span class="cm">/* return GPIO0/1/2/4 to original states after having accessed NVRAM */</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpcntl</span><span class="p">,</span> <span class="n">old_gpcntl</span><span class="p">);</span>
	<span class="n">OUTB</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nc_gpreg</span><span class="p">,</span>  <span class="n">old_gpreg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Try reading Tekram NVRAM.</span>
<span class="cm"> *  Return 0 if OK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_read_Tekram_nvram</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">Tekram_nvram</span> <span class="o">*</span><span class="n">nvram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">nvram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">u_short</span>	<span class="n">csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NCR_53C885</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NCR_53C895</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NCR_53C896</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="n">sym_read_S24C16_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">TEKRAM_24C16_NVRAM_ADDRESS</span><span class="p">,</span>
					  <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NCR_53C875</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="n">sym_read_S24C16_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">TEKRAM_24C16_NVRAM_ADDRESS</span><span class="p">,</span>
					  <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">sym_read_T93C46_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">nvram</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* verify checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="mh">0x1234</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARISC</span>
<span class="cm">/*</span>
<span class="cm"> * Host firmware (PDC) keeps a table for altering SCSI capabilities.</span>
<span class="cm"> * Many newer machines export one channel of 53c896 chip as SE, 50-pin HD.</span>
<span class="cm"> * Also used for Multi-initiator SCSI clusters to set the SCSI Initiator ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sym_read_parisc_pdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pdc_initiator</span> <span class="o">*</span><span class="n">pdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hardware_path</span> <span class="n">hwpath</span><span class="p">;</span>
	<span class="n">get_pci_node_path</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwpath</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdc_get_initiator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwpath</span><span class="p">,</span> <span class="n">pdc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SYM_PARISC_PDC</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sym_read_parisc_pdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pdc_initiator</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Try reading Symbios or Tekram NVRAM</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sym_read_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_device</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sym_nvram</span> <span class="o">*</span><span class="n">nvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym_read_Symbios_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SYM_SYMBIOS_NVRAM</span><span class="p">;</span>
		<span class="n">sym_display_Symbios_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Symbios</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sym_read_Tekram_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Tekram</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SYM_TEKRAM_NVRAM</span><span class="p">;</span>
		<span class="n">sym_display_Tekram_nvram</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">Tekram</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sym_read_parisc_pdc</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">parisc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">sym_nvram_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">sym_nvram</span> <span class="o">*</span><span class="n">nvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYM_SYMBIOS_NVRAM</span>:
		<span class="k">return</span> <span class="s">&quot;Symbios NVRAM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYM_TEKRAM_NVRAM</span>:
		<span class="k">return</span> <span class="s">&quot;Tekram NVRAM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYM_PARISC_PDC</span>:
		<span class="k">return</span> <span class="s">&quot;PA-RISC Firmware&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;No NVRAM&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
