<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › 53c700.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>53c700.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* -*- mode: c; c-basic-offset: 8 -*- */</span>

<span class="cm">/* NCR (or Symbios) 53c700 and 53c700-66 Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001 by James.Bottomley@HansenPartnership.com</span>
<span class="cm">**-----------------------------------------------------------------------------</span>
<span class="cm">**  </span>
<span class="cm">**  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">**  it under the terms of the GNU General Public License as published by</span>
<span class="cm">**  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">**  (at your option) any later version.</span>
<span class="cm">**</span>
<span class="cm">**  This program is distributed in the hope that it will be useful,</span>
<span class="cm">**  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">**  GNU General Public License for more details.</span>
<span class="cm">**</span>
<span class="cm">**  You should have received a copy of the GNU General Public License</span>
<span class="cm">**  along with this program; if not, write to the Free Software</span>
<span class="cm">**  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">**</span>
<span class="cm">**-----------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/* Notes:</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is designed exclusively for these chips (virtually the</span>
<span class="cm"> * earliest of the scripts engine chips).  They need their own drivers</span>
<span class="cm"> * because they are missing so many of the scripts and snazzy register</span>
<span class="cm"> * features of their elder brothers (the 710, 720 and 770).</span>
<span class="cm"> *</span>
<span class="cm"> * The 700 is the lowliest of the line, it can only do async SCSI.</span>
<span class="cm"> * The 700-66 can at least do synchronous SCSI up to 10MHz.</span>
<span class="cm"> * </span>
<span class="cm"> * The 700 chip has no host bus interface logic of its own.  However,</span>
<span class="cm"> * it is usually mapped to a location with well defined register</span>
<span class="cm"> * offsets.  Therefore, if you can determine the base address and the</span>
<span class="cm"> * irq your board incorporating this chip uses, you can probably use</span>
<span class="cm"> * this driver to run it (although you&#39;ll probably have to write a</span>
<span class="cm"> * minimal wrapper for the purpose---see the NCR_D700 driver for</span>
<span class="cm"> * details about how to do this).</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * TODO List:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Better statistics in the proc fs</span>
<span class="cm"> *</span>
<span class="cm"> * 2. Implement message queue (queues SCSI messages like commands) and make</span>
<span class="cm"> *    the abort and device reset functions use them.</span>
<span class="cm"> * */</span>

<span class="cm">/* CHANGELOG</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.8</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed bad bug affecting tag starvation processing (previously the</span>
<span class="cm"> * driver would hang the system if too many tags starved.  Also fixed</span>
<span class="cm"> * bad bug having to do with 10 byte command processing and REQUEST</span>
<span class="cm"> * SENSE (the command would loop forever getting a transfer length</span>
<span class="cm"> * mismatch in the CMD phase).</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.7</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed scripts problem which caused certain devices (notably CDRWs)</span>
<span class="cm"> * to hang on initial INQUIRY.  Updated NCR_700_readl/writel to use</span>
<span class="cm"> * __raw_readl/writel for parisc compatibility (Thomas</span>
<span class="cm"> * Bogendoerfer). Added missing SCp-&gt;request_bufflen initialisation</span>
<span class="cm"> * for sense requests (Ryan Bradetich).</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.6</span>
<span class="cm"> *</span>
<span class="cm"> * Following test of the 64 bit parisc kernel by Richard Hirst,</span>
<span class="cm"> * several problems have now been corrected.  Also adds support for</span>
<span class="cm"> * consistent memory allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.5</span>
<span class="cm"> * </span>
<span class="cm"> * More Compatibility changes for 710 (now actually works).  Enhanced</span>
<span class="cm"> * support for odd clock speeds which constrain SDTR negotiations.</span>
<span class="cm"> * correct cacheline separation for scsi messages and status for</span>
<span class="cm"> * incoherent architectures.  Use of the pci mapping functions on</span>
<span class="cm"> * buffers to begin support for 64 bit drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.4</span>
<span class="cm"> *</span>
<span class="cm"> * Added support for the 53c710 chip (in 53c700 emulation mode only---no </span>
<span class="cm"> * special 53c710 instructions or registers are used).</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.3</span>
<span class="cm"> *</span>
<span class="cm"> * More endianness/cache coherency changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Better bad device handling (handles devices lying about tag</span>
<span class="cm"> * queueing support and devices which fail to provide sense data on</span>
<span class="cm"> * contingent allegiance conditions)</span>
<span class="cm"> *</span>
<span class="cm"> * Many thanks to Richard Hirst &lt;rhirst@linuxcare.com&gt; for patiently</span>
<span class="cm"> * debugging this driver on the parisc architecture and suggesting</span>
<span class="cm"> * many improvements and bug fixes.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks also go to Linuxcare Inc. for providing several PARISC</span>
<span class="cm"> * machines for me to debug the driver on.</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.2</span>
<span class="cm"> *</span>
<span class="cm"> * Made the driver mem or io mapped; added endian invariance; added</span>
<span class="cm"> * dma cache flushing operations for architectures which need it;</span>
<span class="cm"> * added support for more varied clocking speeds.</span>
<span class="cm"> *</span>
<span class="cm"> * Version 2.1</span>
<span class="cm"> *</span>
<span class="cm"> * Initial modularisation from the D700.  See NCR_D700.c for the rest of</span>
<span class="cm"> * the changelog.</span>
<span class="cm"> * */</span>
<span class="cp">#define NCR_700_VERSION &quot;2.8&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_spi.h&gt;</span>

<span class="cp">#include &quot;53c700.h&quot;</span>

<span class="cm">/* NOTE: For 64 bit drivers there are points in the code where we use</span>
<span class="cm"> * a non dereferenceable pointer to point to a structure in dma-able</span>
<span class="cm"> * memory (which is 32 bits) so that we can use all of the structure</span>
<span class="cm"> * operations but take the address at the end.  This macro allows us</span>
<span class="cm"> * to truncate the 64 bit pointer down to 32 bits without the compiler</span>
<span class="cm"> * complaining */</span>
<span class="cp">#define to32bit(x)	((__u32)((unsigned long)(x)))</span>

<span class="cp">#ifdef NCR_700_DEBUG</span>
<span class="cp">#define STATIC</span>
<span class="cp">#else</span>
<span class="cp">#define STATIC static</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;James Bottomley&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;53c700 and 53c700-66 Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* This is the script */</span>
<span class="cp">#include &quot;53c700_d.h&quot;</span>


<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">NCR_700_chip_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">NCR_700_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDpnt</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">int</span> <span class="n">NCR_700_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDpnt</span><span class="p">);</span>
<span class="n">STATIC</span> <span class="kt">void</span> <span class="n">NCR_700_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">NCR_700_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">NCR_700_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">);</span>

<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">NCR_700_dev_attrs</span><span class="p">[];</span>

<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">NCR_700_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NCR_700_phase</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="s">&quot;after selection&quot;</span><span class="p">,</span>
	<span class="s">&quot;before command phase&quot;</span><span class="p">,</span>
	<span class="s">&quot;after command phase&quot;</span><span class="p">,</span>
	<span class="s">&quot;after status phase&quot;</span><span class="p">,</span>
	<span class="s">&quot;after data in phase&quot;</span><span class="p">,</span>
	<span class="s">&quot;after data out phase&quot;</span><span class="p">,</span>
	<span class="s">&quot;during data phase&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NCR_700_condition</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="s">&quot;NOT MSG_OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;UNEXPECTED PHASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;NOT MSG_IN&quot;</span><span class="p">,</span>
	<span class="s">&quot;UNEXPECTED MSG&quot;</span><span class="p">,</span>
	<span class="s">&quot;MSG_IN&quot;</span><span class="p">,</span>
	<span class="s">&quot;SDTR_MSG RECEIVED&quot;</span><span class="p">,</span>
	<span class="s">&quot;REJECT_MSG RECEIVED&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCONNECT_MSG RECEIVED&quot;</span><span class="p">,</span>
	<span class="s">&quot;MSG_OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DATA_IN&quot;</span><span class="p">,</span>
	
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NCR_700_fatal_messages</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;unexpected message after reselection&quot;</span><span class="p">,</span>
	<span class="s">&quot;still MSG_OUT after message injection&quot;</span><span class="p">,</span>
	<span class="s">&quot;not MSG_IN after selection&quot;</span><span class="p">,</span>
	<span class="s">&quot;Illegal message length received&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NCR_700_SBCL_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;IO &quot;</span><span class="p">,</span>
	<span class="s">&quot;CD &quot;</span><span class="p">,</span>
	<span class="s">&quot;MSG &quot;</span><span class="p">,</span>
	<span class="s">&quot;ATN &quot;</span><span class="p">,</span>
	<span class="s">&quot;SEL &quot;</span><span class="p">,</span>
	<span class="s">&quot;BSY &quot;</span><span class="p">,</span>
	<span class="s">&quot;ACK &quot;</span><span class="p">,</span>
	<span class="s">&quot;REQ &quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NCR_700_SBCL_to_phase</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;DATA_OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DATA_IN&quot;</span><span class="p">,</span>
	<span class="s">&quot;CMD_OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;STATE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ILLEGAL PHASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ILLEGAL PHASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;MSG OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;MSG IN&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This translates the SDTR message offset and period to a value</span>
<span class="cm"> * which can be loaded into the SXFER_REG.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: According to SCSI-2, the true transfer period (in ns) is</span>
<span class="cm"> *       actually four times this period value */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span>
<span class="nf">NCR_700_offset_period_to_sxfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span>
			       <span class="n">__u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">XFERP</span><span class="p">;</span>

	<span class="n">__u8</span> <span class="n">min_xferp</span> <span class="o">=</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span>
			  <span class="o">?</span> <span class="n">NCR_710_MIN_XFERP</span> <span class="o">:</span> <span class="n">NCR_700_MIN_XFERP</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span>
			   <span class="o">?</span> <span class="n">NCR_710_MAX_OFFSET</span> <span class="o">:</span> <span class="n">NCR_700_MAX_OFFSET</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;53c700: Period %dns is less than this chip&#39;s minimum, setting to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">NCR_700_MIN_PERIOD</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">XFERP</span> <span class="o">=</span> <span class="p">(</span><span class="n">period</span><span class="o">*</span><span class="mi">4</span> <span class="o">*</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">max_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;53c700: Offset %d exceeds chip maximum, setting to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">offset</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">max_offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">XFERP</span> <span class="o">&lt;</span> <span class="n">min_xferp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">XFERP</span> <span class="o">=</span>  <span class="n">min_xferp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">XFERP</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span>
<span class="nf">NCR_700_get_SXFER</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">NCR_700_offset_period_to_sxfer</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span>
					      <span class="n">spi_offset</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">),</span>
					      <span class="n">spi_period</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span>
<span class="nf">NCR_700_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">pScript</span><span class="p">,</span> <span class="n">pSlots</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">memory</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="o">*</span><span class="n">script</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">banner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">sdev_attrs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">sdev_attrs</span> <span class="o">=</span> <span class="n">NCR_700_dev_attrs</span><span class="p">;</span>

	<span class="n">memory</span> <span class="o">=</span> <span class="n">dma_alloc_noncoherent</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TOTAL_MEM_SIZE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pScript</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">memory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: Failed to allocate memory for driver, detatching</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">script</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="n">memory</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="n">MSGIN_OFFSET</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="n">MSGOUT_OFFSET</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="n">STATUS_OFFSET</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">SLOTS_OFFSET</span><span class="p">);</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">pSlots</span> <span class="o">=</span> <span class="n">pScript</span> <span class="o">+</span> <span class="n">SLOTS_OFFSET</span><span class="p">;</span>

	<span class="cm">/* Fill in the missing routines from the host template */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">NCR_700_queuecommand</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">NCR_700_abort</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">eh_bus_reset_handler</span> <span class="o">=</span> <span class="n">NCR_700_bus_reset</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">NCR_700_host_reset</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">NCR_700_SG_SEGMENTS</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">NCR_700_CMD_PER_LUN</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">NCR_700_slave_configure</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">slave_destroy</span> <span class="o">=</span> <span class="n">NCR_700_slave_destroy</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">slave_alloc</span> <span class="o">=</span> <span class="n">NCR_700_slave_alloc</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">NCR_700_change_queue_depth</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">change_queue_type</span> <span class="o">=</span> <span class="n">NCR_700_change_queue_type</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;53c700&quot;</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;53c700&quot;</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span><span class="p">)</span>
	       <span class="o">*</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					  <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pSG</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_SG_List</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pSlots</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">free_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ITL_forw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_FREE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">SCRIPT</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">script</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">SCRIPT</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

	<span class="cm">/* adjust all labels to be bus physical */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PATCHES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">script</span><span class="p">[</span><span class="n">LABELPATCHES</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">SCRIPT</span><span class="p">[</span><span class="n">LABELPATCHES</span><span class="p">[</span><span class="n">j</span><span class="p">]]);</span>
	<span class="cm">/* now patch up fixed addresses. */</span>
	<span class="n">script_patch_32</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">MessageLocation</span><span class="p">,</span>
			<span class="n">pScript</span> <span class="o">+</span> <span class="n">MSGOUT_OFFSET</span><span class="p">);</span>
	<span class="n">script_patch_32</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">StatusAddress</span><span class="p">,</span>
			<span class="n">pScript</span> <span class="o">+</span> <span class="n">STATUS_OFFSET</span><span class="p">);</span>
	<span class="n">script_patch_32</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">ReceiveMsgAddress</span><span class="p">,</span>
			<span class="n">pScript</span> <span class="o">+</span> <span class="n">MSGIN_OFFSET</span><span class="p">);</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span> <span class="o">=</span> <span class="n">script</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">=</span> <span class="n">pScript</span><span class="p">;</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pScript</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCRIPT</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">NCR_700_MAX_LUNS</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">NCR_700_transport_template</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">NCR_700_transport_template</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="cm">/* kick the chip */</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST9_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTEST8_REG</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTEST7_REG</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTEST9_REG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">banner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;53c700: Version &quot;</span> <span class="n">NCR_700_VERSION</span> <span class="s">&quot; By James.Bottomley@HansenPartnership.com</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">banner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;scsi%d: %s rev %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span> <span class="o">?</span> <span class="s">&quot;53c710&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">?</span> <span class="s">&quot;53c700-66&quot;</span> <span class="o">:</span> <span class="s">&quot;53c700&quot;</span><span class="p">),</span>
	       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">?</span>
	       <span class="s">&quot;(Differential)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="cm">/* reset the chip */</span>
	<span class="n">NCR_700_chip_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;53c700: scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_signalling</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">?</span> <span class="n">SPI_SIGNAL_HVD</span> <span class="o">:</span>
		<span class="n">SPI_SIGNAL_SE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">host</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">NCR_700_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">dma_free_noncoherent</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TOTAL_MEM_SIZE</span><span class="p">,</span>
			       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span>
<span class="nf">NCR_700_identify</span><span class="p">(</span><span class="kt">int</span> <span class="n">can_disconnect</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IDENTIFY_BASE</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">can_disconnect</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="n">NCR_700_LUN_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function : static int data_residual (Scsi_Host *host)</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose : return residual data count of what&#39;s in the chip.  If you</span>
<span class="cm"> * really want to know what this function is doing, it&#39;s almost a</span>
<span class="cm"> * direct transcription of the algorithm described in the 53c710</span>
<span class="cm"> * guide, except that the DBC and DFIFO registers are only 6 bits</span>
<span class="cm"> * wide on a 53c700.</span>
<span class="cm"> *</span>
<span class="cm"> * Inputs : host - SCSI host */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">NCR_700_data_residual</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">synchronous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ddir</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DFIFO_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DBC_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DFIFO_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DBC_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
		<span class="n">synchronous</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SXFER_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	
	<span class="cm">/* get the data direction */</span>
	<span class="n">ddir</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTEST0_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddir</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Receive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synchronous</span><span class="p">)</span> 
			<span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SSTAT2_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SSTAT1_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SIDL_REG_FULL</span><span class="p">)</span>
				<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Send */</span>
		<span class="n">__u8</span> <span class="n">sstat</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SSTAT1_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sstat</span> <span class="o">&amp;</span> <span class="n">SODL_REG_FULL</span><span class="p">)</span>
			<span class="o">++</span><span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synchronous</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sstat</span> <span class="o">&amp;</span> <span class="n">SODR_REG_FULL</span><span class="p">))</span>
			<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
	<span class="k">if</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RESIDUAL IS %d (ddir %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ddir</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* print out the SCSI wires and corresponding phase from the SBCL register</span>
<span class="cm"> * in the chip */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">sbcl_to_string</span><span class="p">(</span><span class="n">__u8</span> <span class="n">sbcl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">ret</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sbcl</span><span class="p">)</span> 
			<span class="n">strcat</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">NCR_700_SBCL_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">NCR_700_SBCL_to_phase</span><span class="p">[</span><span class="n">sbcl</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span>
<span class="nf">bitmap_to_number</span><span class="p">(</span><span class="n">__u8</span> <span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bitmap</span> <span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Pull a slot off the free list */</span>
<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span>
<span class="nf">find_empty_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sanity check */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span> <span class="o">!=</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SLOTS FULL, but count is %d, should be %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span><span class="p">,</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NCR_700_SLOT_FREE</span><span class="p">)</span>
		<span class="cm">/* should panic! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BUSY SLOT ON FREE LIST!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">free_list</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ITL_forw</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">ITL_forw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="cm">/* NOTE: set the state to busy here, not queued, since this</span>
<span class="cm">	 * indicates the slot is in use and cannot be run by the IRQ</span>
<span class="cm">	 * finish routine.  If we cannot queue the command when it</span>
<span class="cm">	 * is properly build, we then change to NCR_700_SLOT_QUEUED */</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_BUSY</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span><span class="o">++</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span> 
<span class="nf">free_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span>
	  <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">((</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">NCR_700_SLOT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NCR_700_SLOT_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: SLOT %p is not MAGIC!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NCR_700_SLOT_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: SLOT %p is FREE!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_FREE</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">ITL_forw</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">free_list</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This routine really does very little.  The command is indexed on</span>
<span class="cm">   the ITL and (if tagged) the ITLQ lists in _queuecommand */</span>
<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">save_for_reselection</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Its just possible that this gets executed twice */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">NCR_700_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_NONE</span> <span class="o">&amp;&amp;</span>
	   <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">NCR_700_scsi_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> 
			<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span><span class="p">,</span>
				 <span class="n">MAX_COMMAND_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">NCR_700_get_sense_cmnd</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ORIGINAL CMD %p RETURNED %d, new return is %d sense is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">SCp</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">result</span><span class="p">);</span>
			<span class="n">scsi_print_sense</span><span class="p">(</span><span class="s">&quot;53c700&quot;</span><span class="p">,</span> <span class="n">SCp</span><span class="p">);</span>

<span class="cp">#endif</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">,</span>
					 <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="cm">/* restore the old result if the request sense was</span>
<span class="cm">			 * successful */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="cm">/* restore the original length */</span>
			<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">NCR_700_unmap</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="n">free_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
		<span class="k">if</span><span class="p">(</span><span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		   <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid depth in NCR_700_scsi_done(): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* NCR_700_DEBUG */</span><span class="cp"></span>
		<span class="n">NCR_700_set_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: SCSI DONE HAS NULL SCp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Bus reset */</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASSERT_RST</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCNTL1_REG</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCNTL1_REG</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_chip_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">min_period</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">min_xferp</span> <span class="o">=</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span> <span class="o">?</span> <span class="n">NCR_710_MIN_XFERP</span> <span class="o">:</span> <span class="n">NCR_700_MIN_XFERP</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">burst_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="n">burst_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">burst_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
			        <span class="n">burst_length</span> <span class="o">=</span> <span class="n">BURST_LENGTH_1</span><span class="p">;</span>
			        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
			        <span class="n">burst_length</span> <span class="o">=</span> <span class="n">BURST_LENGTH_2</span><span class="p">;</span>
			        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
			        <span class="n">burst_length</span> <span class="o">=</span> <span class="n">BURST_LENGTH_4</span><span class="p">;</span>
			        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
			        <span class="n">burst_length</span> <span class="o">=</span> <span class="n">BURST_LENGTH_8</span><span class="p">;</span>
			        <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
			        <span class="n">burst_disable</span> <span class="o">=</span> <span class="n">BURST_DISABLE</span><span class="p">;</span>
			        <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span> <span class="o">|=</span> <span class="n">COMPAT_700_MODE</span><span class="p">;</span>

		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">burst_length</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dmode_extra</span><span class="p">,</span>
			       <span class="n">host</span><span class="p">,</span> <span class="n">DMODE_710_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">burst_disable</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">ctest7_extra</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">?</span> <span class="n">DIFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">host</span><span class="p">,</span> <span class="n">CTEST7_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">BTB_TIMER_DISABLE</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST0_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">FULL_ARBITRATION</span> <span class="o">|</span> <span class="n">ENABLE_PARITY</span> <span class="o">|</span> <span class="n">PARITY</span>
			       <span class="o">|</span> <span class="n">AUTO_ATN</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCNTL0_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">BURST_LENGTH_8</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dmode_extra</span><span class="p">,</span>
			       <span class="n">host</span><span class="p">,</span> <span class="n">DMODE_700_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">?</span> 
			       <span class="n">DIFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST7_REG</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this is for 700-66, does nothing on 700 */</span>
			<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">LAST_DIS_ENBL</span> <span class="o">|</span> <span class="n">ENABLE_ACTIVE_NEGATION</span> 
				       <span class="o">|</span> <span class="n">GENERATE_RECEIVE_PARITY</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
				       <span class="n">CTEST8_REG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">FULL_ARBITRATION</span> <span class="o">|</span> <span class="n">ENABLE_PARITY</span>
				       <span class="o">|</span> <span class="n">PARITY</span> <span class="o">|</span> <span class="n">AUTO_ATN</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCNTL0_REG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCID_REG</span><span class="p">);</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_OPERATION</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SXFER_REG</span><span class="p">);</span>

	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">PHASE_MM_INT</span> <span class="o">|</span> <span class="n">SEL_TIMEOUT_INT</span> <span class="o">|</span> <span class="n">GROSS_ERR_INT</span> <span class="o">|</span> <span class="n">UX_DISC_INT</span>
	     <span class="o">|</span> <span class="n">RST_INT</span> <span class="o">|</span> <span class="n">PAR_ERR_INT</span> <span class="o">|</span> <span class="n">SELECT_INT</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SIEN_REG</span><span class="p">);</span>

	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ABORT_INT</span> <span class="o">|</span> <span class="n">INT_INST_INT</span> <span class="o">|</span> <span class="n">ILGL_INST_INT</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DIEN_REG</span><span class="p">);</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ENABLE_SELECT</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SCNTL1_REG</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: Clock speed %dMHz is too high: 75Mhz is the maximum this chip can be driven at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="cm">/* do the best we can, but the async clock will be out</span>
<span class="cm">		 * of spec: sync divider 2, async divider 3 */</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;53c700: sync 2 async 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SYNC_DIV_2_0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_DIV_3_0</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="mi">50</span>  <span class="o">&amp;&amp;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sync divider 1.5, async divider 3 */</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;53c700: sync 1.5 async 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SYNC_DIV_1_5</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_DIV_3_0</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">/=</span> <span class="mi">3</span><span class="p">;</span>
		
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="mi">37</span> <span class="o">&amp;&amp;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sync divider 1, async divider 2 */</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;53c700: sync 1 async 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SYNC_DIV_1_0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_DIV_2_0</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="o">&amp;&amp;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;=</span><span class="mi">37</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sync divider 1, async divider 1.5 */</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;53c700: sync 1 async 1.5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SYNC_DIV_1_0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_DIV_1_5</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;53c700: sync 1 async 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SYNC_DIV_1_0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">ASYNC_DIV_1_0</span> <span class="o">|</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dcntl_extra</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="cm">/* sync divider 1, async divider 1 */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Calculate the actual minimum period that can be supported</span>
<span class="cm">	 * by our synchronous clock speed.  See the 710 manual for</span>
<span class="cm">	 * exact details of this calculation which is based on a</span>
<span class="cm">	 * setting of the SXFER register */</span>
	<span class="n">min_period</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="n">min_xferp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">sync_clock</span><span class="p">);</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="n">NCR_700_MIN_PERIOD</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">min_period</span> <span class="o">&gt;</span> <span class="n">NCR_700_MIN_PERIOD</span><span class="p">)</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="n">min_period</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SOFTWARE_RESET_710</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">ISTAT_REG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">ISTAT_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">SOFTWARE_RESET</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DCNTL_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">NCR_700_chip_setup</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The heart of the message processing engine is that the instruction</span>
<span class="cm"> * immediately after the INT is the normal case (and so must be CLEAR</span>
<span class="cm"> * ACK).  If we want to do something else, we call that routine in</span>
<span class="cm"> * scripts and set temp to be the normal case + 8 (skipping the CLEAR</span>
<span class="cm"> * ACK) so that the routine returns correctly to resume its activity</span>
<span class="cm"> * */</span>
<span class="n">STATIC</span> <span class="n">__u32</span>
<span class="nf">process_extended_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> 
			 <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">resume_offset</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">dsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">A_SDTR_MSG</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">NCR_700_is_flag_set</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">period</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">__u8</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

			<span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">NCR_700_is_flag_set</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_PRINT_SYNC_NEGOTIATION</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spi_display_xfer_agreement</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>
				<span class="n">NCR_700_clear_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_PRINT_SYNC_NEGOTIATION</span><span class="p">);</span>
			<span class="p">}</span>
			
			<span class="n">NCR_700_set_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span><span class="p">);</span>
			<span class="n">NCR_700_clear_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">);</span>
			
			<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">NCR_700_get_SXFER</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
				       <span class="n">host</span><span class="p">,</span> <span class="n">SXFER_REG</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* SDTR message out of the blue, reject it */</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
				<span class="s">&quot;Unexpected SDTR msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_REJECT_MSG</span><span class="p">;</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
			                <span class="n">MessageCount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* SendMsgOut returns, so set up the return</span>
<span class="cm">			 * address */</span>
			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SendMessageWithATN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="n">A_WDTR_MSG</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d: (%d:%d), Unsolicited WDTR after CMD, Rejecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_REJECT_MSG</span><span class="p">;</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">MessageCount</span><span class="p">,</span>
		                <span class="mi">1</span><span class="p">);</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SendMessageWithATN</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d (%d:%d): Unexpected message %s: &quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
		       <span class="n">NCR_700_phase</span><span class="p">[(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>
		<span class="n">spi_print_msg</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* just reject it */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_REJECT_MSG</span><span class="p">;</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">MessageCount</span><span class="p">,</span>
		                <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* SendMsgOut returns, so set up the return</span>
<span class="cm">		 * address */</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SendMessageWithATN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NCR_700_writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">TEMP_REG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">resume_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">__u32</span>
<span class="nf">process_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* work out where to return to */</span>
	<span class="n">__u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">dsp</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">resume_offset</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef NCR_700_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d (%d:%d): message %s: &quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
	       <span class="n">NCR_700_phase</span><span class="p">[(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>
	<span class="n">spi_print_msg</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">A_EXTENDED_MSG</span>:
		<span class="n">resume_offset</span> <span class="o">=</span>  <span class="n">process_extended_message</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
							  <span class="n">dsp</span><span class="p">,</span> <span class="n">dsps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">A_REJECT_MSG</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">NCR_700_is_flag_set</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Rejected our sync negotiation attempt */</span>
			<span class="n">spi_period</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">spi_offset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">NCR_700_set_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span><span class="p">);</span>
			<span class="n">NCR_700_clear_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">NCR_700_get_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="n">NCR_700_DURING_TAG_NEGOTIATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* rejected our first simple tag message */</span>
			<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
				<span class="s">&quot;Rejected first tag queue attempt, turning off tag queueing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* we&#39;re done negotiating */</span>
			<span class="n">NCR_700_set_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_FINISHED_TAG_NEGOTIATION</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">));</span>
			<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
				<span class="s">&quot;(%d:%d) Unexpected REJECT Message %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
			       <span class="n">NCR_700_phase</span><span class="p">[(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>
			<span class="cm">/* however, just ignore it */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">A_PARITY_ERROR_MSG</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d (%d:%d) Parity Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		       <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_SIMPLE_TAG_MSG</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d (%d:%d) SIMPLE TAG %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		       <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		       <span class="n">NCR_700_phase</span><span class="p">[(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>
		<span class="cm">/* just ignore it */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d (%d:%d): Unexpected message %s: &quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
		       <span class="n">NCR_700_phase</span><span class="p">[(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">]);</span>

		<span class="n">spi_print_msg</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* just reject it */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A_REJECT_MSG</span><span class="p">;</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">MessageCount</span><span class="p">,</span>
		                <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* SendMsgOut returns, so set up the return</span>
<span class="cm">		 * address */</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SendMessageWithATN</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NCR_700_writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">TEMP_REG</span><span class="p">);</span>
	<span class="cm">/* set us up to receive another message */</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">,</span> <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">resume_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="n">__u32</span>
<span class="nf">process_script_interrupt</span><span class="p">(</span><span class="n">__u32</span> <span class="n">dsps</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">resume_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lun</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dsps</span> <span class="o">==</span> <span class="n">A_GOOD_STATUS_AFTER_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;  COMMAND COMPLETE, status=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="cm">/* OK, if TCQ still under negotiation, we now know it works */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NCR_700_get_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="n">NCR_700_DURING_TAG_NEGOTIATION</span><span class="p">)</span>
			<span class="n">NCR_700_set_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						  <span class="n">NCR_700_FINISHED_TAG_NEGOTIATION</span><span class="p">);</span>
			
		<span class="cm">/* check for contingent allegiance contitions */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status_byte</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span> <span class="o">||</span>
		   <span class="n">status_byte</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">COMMAND_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* OOPS: bad device, returning another</span>
<span class="cm">				 * contingent allegiance condition */</span>
				<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
					<span class="s">&quot;broken device is looping in contingent allegiance: ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span> <span class="o">=</span>
					<span class="n">NCR_700_get_sense_cmnd</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="cp">#ifdef NCR_DEBUG</span>
				<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  cmd %p has status %d, requesting sense</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">SCp</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="cm">/* we can destroy the command here</span>
<span class="cm">				 * because the contingent allegiance</span>
<span class="cm">				 * condition will cause a retry which</span>
<span class="cm">				 * will re-copy the command from the</span>
<span class="cm">				 * saved data_cmnd.  We also unmap any</span>
<span class="cm">				 * data associated with the command</span>
<span class="cm">				 * here */</span>
				<span class="n">NCR_700_unmap</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span><span class="p">,</span>
						 <span class="n">MAX_COMMAND_SIZE</span><span class="p">,</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

				<span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* Here&#39;s a quiet hack: the</span>
<span class="cm">				 * REQUEST_SENSE command is six bytes,</span>
<span class="cm">				 * so store a flag indicating that</span>
<span class="cm">				 * this was an internal sense request</span>
<span class="cm">				 * and the original status at the end</span>
<span class="cm">				 * of the command */</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCR_700_INTERNAL_SENSE_MAGIC</span><span class="p">;</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
				<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* command length for</span>
<span class="cm">						   * REQUEST_SENSE */</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ins</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">SCRIPT_MOVE_DATA_IN</span> <span class="o">|</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">);</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ins</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">SCRIPT_RETURN</span><span class="p">);</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">;</span>
				<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

				<span class="cm">/* queue the command for reissue */</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_QUEUED</span><span class="p">;</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">;</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">;</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Currently rely on the mid layer evaluation
of the tag queuing capability</p>

<p>if(status<em>byte(hostdata->status[0]) == GOOD &amp;&amp;
  SCp->cmnd[0] == INQUIRY &amp;&amp; SCp->use</em>sg == 0) {
/* Piggy back the tag queueing support
 * on this command */
dma<em>sync</em>single<em>for</em>cpu(hostdata->dev,
            slot->dma<em>handle,
            SCp->request</em>bufflen,
            DMA<em>FROM</em>DEVICE);
if(((char *)SCp->request<em>buffer)[7] &amp; 0x02) {
    scmd</em>printk(KERN<em>INFO, SCp,
         "Enabling Tag Command Queuing\n");
    hostdata->tag</em>negotiated |= (1&lt;<scmd_id(SCp));
    NCR_700_set_flag(SCp->device, NCR<em>700</em>DEV<em>BEGIN</em>TAG<em>QUEUEING);
} else {
    NCR</em>700<em>clear</em>flag(SCp->device, NCR<em>700</em>DEV<em>BEGIN</em>TAG<em>QUEUEING);
    hostdata->tag</em>negotiated &amp;= ~(1&lt;<scmd_id(SCp));
}
}</p></td><td class="code"><div class="highlight"><pre>			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfffff0f0</span><span class="p">)</span> <span class="o">==</span> <span class="n">A_UNEXPECTED_PHASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;UNEXPECTED PHASE %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">NCR_700_phase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">sbcl_to_string</span><span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">)));</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;         len = %d, cmd =&quot;</span><span class="p">,</span>
			<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
		<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>

		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="n">A_FATAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) FATAL ERROR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">NCR_700_fatal_messages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dsps</span> <span class="o">==</span> <span class="n">A_FATAL_ILLEGAL_MSG_LENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;     msg begins %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfffff0f0</span><span class="p">)</span> <span class="o">==</span> <span class="n">A_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
		<span class="n">__u8</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: (%d:%d), DISCONNECTED (%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">NCR_700_phase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">save_for_reselection</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dsps</span> <span class="o">==</span> <span class="n">A_RESELECTION_IDENTIFIED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">lun</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="n">reselection_id</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">;</span>

		<span class="n">lun</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: (%d:%d) RESELECTED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
		<span class="cm">/* clear the reselection indicator */</span>
		<span class="n">SDp</span> <span class="o">=</span> <span class="n">__scsi_device_lookup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">SDp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) HAS NO device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">A_SIMPLE_TAG_MSG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span> <span class="o">=</span> <span class="n">scsi_find_tag</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">SCp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) no saved request for tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="n">DDEBUG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span>
				<span class="s">&quot;reselection is tag %d, slot %p(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">slot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span> <span class="o">=</span> <span class="n">scsi_find_tag</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">SCSI_NO_TAG</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">SCp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SDp</span><span class="p">,</span>
					<span class="s">&quot;no saved request for untagged cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) RESELECTED but no saved command (MSG = %02x %02x %02x)!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
			       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: FATAL, host not busy during valid reselection!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>

			<span class="cm">/* re-patch for this command */</span>
			<span class="n">script_patch_32_abs</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
			                    <span class="n">CommandAddress</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span><span class="p">);</span>
			<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
					<span class="n">CommandCount</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
			<span class="n">script_patch_32_abs</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
			                    <span class="n">SGScriptStartAddress</span><span class="p">,</span>
					    <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ins</span><span class="p">));</span>

			<span class="cm">/* Note: setting SXFER only works if we&#39;re</span>
<span class="cm">			 * still in the MESSAGE phase, so it is vital</span>
<span class="cm">			 * that ACK is still asserted when we process</span>
<span class="cm">			 * the reselection message.  The resume offset</span>
<span class="cm">			 * should therefore always clear ACK */</span>
			<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">NCR_700_get_SXFER</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
				       <span class="n">host</span><span class="p">,</span> <span class="n">SXFER_REG</span><span class="p">);</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">,</span>
				       <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span>
				       <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="cm">/* I&#39;m just being paranoid here, the command should</span>
<span class="cm">			 * already have been flushed from the cache */</span>
			<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span>
				       <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>


			
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dsps</span> <span class="o">==</span> <span class="n">A_RESELECTED_DURING_SELECTION</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* This section is full of debugging code because I&#39;ve</span>
<span class="cm">		 * never managed to reach it.  I think what happens is</span>
<span class="cm">		 * that, because the 700 runs with selection</span>
<span class="cm">		 * interrupts enabled the whole time that we take a</span>
<span class="cm">		 * selection interrupt before we manage to get to the</span>
<span class="cm">		 * reselected script interrupt */</span>

		<span class="n">__u8</span> <span class="n">reselection_id</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SFBR_REG</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
		
		<span class="cm">/* Take out our own ID */</span>
		<span class="n">reselection_id</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>
		
		<span class="cm">/* I&#39;ve never seen this happen, so keep this as a printk rather</span>
<span class="cm">		 * than a debug */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d: (%d:%d) RESELECTION DURING SELECTION, dsp=%08x[%04x] state=%d, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">reselection_id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span><span class="p">);</span>

		<span class="p">{</span>
			<span class="cm">/* FIXME: DEBUGGING CODE */</span>
			<span class="n">__u32</span> <span class="n">SG</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span><span class="n">bS_to_cpu</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">[</span><span class="n">A_SGScriptStartAddress_used</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">SG</span> <span class="o">&gt;=</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pSG</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				   <span class="o">&amp;&amp;</span> <span class="n">SG</span> <span class="o">&lt;=</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pSG</span><span class="p">[</span><span class="n">NCR_700_SG_SEGMENTS</span><span class="p">]))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;IDENTIFIED SG segment as being %08x in slot %p, cmd %p, slot-&gt;resume_offset=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resume_offset</span><span class="p">);</span>
			<span class="n">SCp</span> <span class="o">=</span>  <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="cm">/* change slot from busy to queued to redo command */</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_QUEUED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		
		<span class="k">if</span><span class="p">(</span><span class="n">reselection_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: Invalid reselection during selection!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: script reselected and we took a selection interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="n">reselection_id</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			
			<span class="cm">/* convert to real ID */</span>
			<span class="n">reselection_id</span> <span class="o">=</span> <span class="n">bitmap_to_number</span><span class="p">(</span><span class="n">reselection_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span> <span class="o">=</span> <span class="n">reselection_id</span><span class="p">;</span>
		<span class="cm">/* just in case we have a stale simple tag message, clear it */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">,</span>
			       <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">reselection_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_GetReselectionWithTag</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_GetReselectionData</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dsps</span> <span class="o">==</span> <span class="n">A_COMPLETED_SELECTION_AS_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we&#39;ve just disconnected from the bus, do nothing since</span>
<span class="cm">		 * a return here will re-run the queued command slot</span>
<span class="cm">		 * that may have been interrupted by the initial selection */</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot; SELECTION COMPLETED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfffff0f0</span><span class="p">)</span> <span class="o">==</span> <span class="n">A_MSG_IN</span><span class="p">)</span> <span class="p">{</span> 
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">process_message</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
						<span class="n">dsp</span><span class="p">,</span> <span class="n">dsps</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span>  <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d), unhandled script condition %s %s at %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">NCR_700_condition</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">NCR_700_phase</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

			<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
			<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SCp</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; SG[%d].length = %d, move_insn=%08x, addr %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pAddr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">==</span> <span class="n">A_DEBUG_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;scsi%d (%d:%d) DEBUG INTERRUPT %d AT %08x[%04x], continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">dsps</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d), unidentified script interrupt 0x%x at %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">dsps</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">resume_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We run the 53c700 with selection interrupts always enabled.  This</span>
<span class="cm"> * means that the chip may be selected as soon as the bus frees.  On a</span>
<span class="cm"> * busy bus, this can be before the scripts engine finishes its</span>
<span class="cm"> * processing.  Therefore, part of the selection processing has to be</span>
<span class="cm"> * to find out what the scripts engine is doing and complete the</span>
<span class="cm"> * function if necessary (i.e. process the pending disconnect or save</span>
<span class="cm"> * the interrupted initial selection */</span>
<span class="n">STATIC</span> <span class="kr">inline</span> <span class="n">__u32</span>
<span class="nf">process_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Squash compiler warning */</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">resume_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">sbcl</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span> <span class="o">?</span>
				   <span class="n">CTEST9_REG</span> <span class="o">:</span> <span class="n">SFBR_REG</span><span class="p">);</span>

		<span class="cm">/* Take out our own ID */</span>
		<span class="n">id</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sbcl</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">sbcl</span> <span class="o">&amp;</span> <span class="n">SBCL_IO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mark as having been selected rather than reselected */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* convert to real ID */</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">reselection_id</span> <span class="o">=</span> <span class="n">id</span> <span class="o">=</span> <span class="n">bitmap_to_number</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d:  Reselected by %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NCR_700_HOST_BUSY</span> <span class="o">&amp;&amp;</span> <span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;  ID %d WARNING: RESELECTION OF BUSY HOST, saving cmd %p, slot %p, addr %x [%04x], resume %x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">,</span> <span class="n">resume_offset</span><span class="p">));</span>
		
		<span class="k">switch</span><span class="p">(</span><span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">Ent_Disconnect1</span>:
		<span class="k">case</span> <span class="n">Ent_Disconnect2</span>:
			<span class="n">save_for_reselection</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">Ent_Disconnect2</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Ent_Disconnect3</span>:
		<span class="k">case</span> <span class="n">Ent_Disconnect4</span>:
			<span class="n">save_for_reselection</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">Ent_Disconnect4</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Ent_Disconnect5</span>:
		<span class="k">case</span> <span class="n">Ent_Disconnect6</span>:
			<span class="n">save_for_reselection</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">Ent_Disconnect6</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Ent_Disconnect7</span>:
		<span class="k">case</span> <span class="n">Ent_Disconnect8</span>:
			<span class="n">save_for_reselection</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">Ent_Disconnect8</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Ent_Finish1</span>:
		<span class="k">case</span> <span class="n">Ent_Finish2</span>:
			<span class="n">process_script_interrupt</span><span class="p">(</span><span class="n">A_GOOD_STATUS_AFTER_STATUS</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="nl">default:</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_QUEUED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* clear any stale simple tag message */</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">,</span> <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span>
		       <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Selected as target, Ignore */</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SelectedAsTarget</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_GetReselectionWithTag</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_GetReselectionData</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">resume_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">NCR_700_clear_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span>
		<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">CLR_FIFO_710</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST8_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">CLR_FIFO</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DFIFO_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">NCR_700_flush_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span>
		<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">FLUSH_DMA_FIFO_710</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST8_REG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">CTEST8_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">FLUSH_DMA_FIFO</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DFIFO_REG</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DFIFO_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* The queue lock with interrupts disabled must be held on entry to</span>
<span class="cm"> * this function */</span>
<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">NCR_700_start_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">__u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* for IDENTIFY message */</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* keep this inside the lock to close the race window where</span>
<span class="cm">		 * the running command finishes on another CPU while we don&#39;t</span>
<span class="cm">		 * change the state to queued on this one */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_QUEUED</span><span class="p">;</span>

		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: host busy, queueing command %p, slot %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">slot</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">;</span>
	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SCp</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_SLOT_BUSY</span><span class="p">;</span>
	<span class="cm">/* keep interrupts disabled until we have the command correctly</span>
<span class="cm">	 * set up so we cannot take a selection interrupt */</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCR_700_identify</span><span class="p">((</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REQUEST_SENSE</span> <span class="o">&amp;&amp;</span>
						<span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">),</span>
					       <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="cm">/* for INQUIRY or REQUEST_SENSE commands, we cannot be sure</span>
<span class="cm">	 * if the negotiated transfer parameters still hold, so</span>
<span class="cm">	 * always renegotiate them */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span> <span class="o">||</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span> <span class="o">||</span>
	   <span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NCR_700_clear_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* REQUEST_SENSE is asking for contingent I_T_L(_Q) status.</span>
<span class="cm">	 * If a contingent allegiance condition exists, the device</span>
<span class="cm">	 * will refuse all tags, so send the request sense as untagged</span>
<span class="cm">	 * */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">)))</span>
	   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">SCSI_NO_TAG</span> <span class="o">&amp;&amp;</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REQUEST_SENSE</span> <span class="o">&amp;&amp;</span>
	       <span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">NCR_700_FLAG_AUTOSENSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">SCp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">&amp;&amp;</span>
	   <span class="n">NCR_700_is_flag_clear</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">[</span><span class="n">count</span><span class="p">],</span>
				<span class="n">spi_period</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">),</span>
				<span class="n">spi_offset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">));</span>
		<span class="n">NCR_700_set_flag</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">MessageCount</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>


	<span class="n">script_patch_ID</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
			<span class="n">Device_ID</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">));</span>

	<span class="n">script_patch_32_abs</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">CommandAddress</span><span class="p">,</span>
			    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span><span class="p">);</span>
	<span class="n">script_patch_16</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span> <span class="n">CommandCount</span><span class="p">,</span>
	                <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="cm">/* finally plumb the beginning of the SG list into the script</span>
<span class="cm">	 * */</span>
	<span class="n">script_patch_32_abs</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">,</span>
	                    <span class="n">SGScriptStartAddress</span><span class="p">,</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ins</span><span class="p">));</span>
	<span class="n">NCR_700_clear_fifo</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">;</span>
	<span class="cm">/* now perform all the writebacks and invalidates */</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgout</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">msgin</span><span class="p">,</span> <span class="n">MSG_ARRAY_SIZE</span><span class="p">,</span>
		       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/* set the synchronous period/offset */</span>
	<span class="n">NCR_700_writeb</span><span class="p">(</span><span class="n">NCR_700_get_SXFER</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
		       <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">SXFER_REG</span><span class="p">);</span>
	<span class="n">NCR_700_writel</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TEMP_REG</span><span class="p">);</span>
	<span class="n">NCR_700_writel</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">DSP_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span>
<span class="nf">NCR_700_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">istat</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">resume_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use the host lock to serialise access to the 53c700</span>
<span class="cm">	 * hardware.  Note: In future, we may need to take the queue</span>
<span class="cm">	 * lock to enter the done routines.  When that happens, we</span>
<span class="cm">	 * need to ensure that for this driver, the host lock and the</span>
<span class="cm">	 * queue lock point to the same thing. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">istat</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ISTAT_REG</span><span class="p">))</span>
	      <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSI_INT_PENDING</span> <span class="o">|</span> <span class="n">DMA_INT_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">dsps</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="n">sstat0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">dsp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">NCR_700_Host_State</span> <span class="n">state</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">SCp</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">SCSI_INT_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

			<span class="n">sstat0</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SSTAT0_REG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">DMA_INT_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

			<span class="n">dstat</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DSTAT_REG</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dsps</span> <span class="o">=</span> <span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DSPS_REG</span><span class="p">);</span>
		<span class="n">dsp</span> <span class="o">=</span> <span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DSP_REG</span><span class="p">);</span>

		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: istat %02x sstat0 %02x dstat %02x dsp %04x[%08x] dsps 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">istat</span><span class="p">,</span> <span class="n">sstat0</span><span class="p">,</span> <span class="n">dstat</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">dsp</span> <span class="o">-</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
		       <span class="n">dsp</span><span class="p">,</span> <span class="n">dsps</span><span class="p">));</span>

		<span class="k">if</span><span class="p">(</span><span class="n">SCp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">SCSI_RESET_DETECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: Bus Reset detected, executing command %p, slot %p, dsp %08x[%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">SCp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>

			<span class="n">scsi_report_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* clear all the negotiated parameters */</span>
			<span class="n">__shost_for_each_device</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
				<span class="n">NCR_700_clear_flag</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
			
			<span class="cm">/* clear all the slots and their pending commands */</span>
			<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="k">if</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NCR_700_SLOT_FREE</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				
				<span class="n">SCp</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; failing command because of reset, slot %p, cmnd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">slot</span><span class="p">,</span> <span class="n">SCp</span><span class="p">);</span>
				<span class="n">free_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
				<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">NCR_700_set_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* NOTE: deadlock potential here: we</span>
<span class="cm">				 * rely on mid-layer guarantees that</span>
<span class="cm">				 * scsi_done won&#39;t try to issue the</span>
<span class="cm">				 * command again otherwise we&#39;ll</span>
<span class="cm">				 * deadlock on the</span>
<span class="cm">				 * hostdata-&gt;state_lock */</span>
				<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
			<span class="n">NCR_700_chip_setup</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">;</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* signal back if this was an eh induced reset */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">complete</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">SELECTION_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: (%d:%d) selection timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">PHASE_MISMATCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">dsp</span> <span class="o">==</span> <span class="n">Ent_SendMessage</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* It wants to reply to some part of</span>
<span class="cm">				 * our message */</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
				<span class="n">__u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TEMP_REG</span><span class="p">);</span>
				<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">script</span><span class="p">[</span><span class="n">Ent_SendMessage</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DBC_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="o">+</span> <span class="n">NCR_700_data_residual</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d (%d:%d) PHASE MISMATCH IN SEND MESSAGE %d remain, return %p[%04x], phase %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">temp</span><span class="p">,</span> <span class="n">temp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">,</span> <span class="n">sbcl_to_string</span><span class="p">(</span><span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">)));</span>
<span class="cp">#endif</span>
				<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_SendMessagePhaseMismatch</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dsp</span> <span class="o">&gt;=</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ins</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				  <span class="n">dsp</span> <span class="o">&lt;=</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="n">NCR_700_SG_SEGMENTS</span><span class="p">].</span><span class="n">ins</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">data_transfer</span> <span class="o">=</span> <span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DBC_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">SGcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span> <span class="o">-</span> <span class="n">to32bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ins</span><span class="p">))</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_SG_List</span><span class="p">);</span>
				<span class="kt">int</span> <span class="n">residual</span> <span class="o">=</span> <span class="n">NCR_700_data_residual</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
				<span class="n">__u32</span> <span class="n">naddr</span> <span class="o">=</span> <span class="n">NCR_700_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DNAD_REG</span><span class="p">);</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: (%d:%d) Expected phase mismatch in slot-&gt;SG[%d], transferred 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SGcount</span><span class="p">,</span> <span class="n">data_transfer</span><span class="p">);</span>
				<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: (%d:%d) Expected phase mismatch in slot-&gt;SG[%d], transferred 0x%x, residual %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SGcount</span><span class="p">,</span> <span class="n">data_transfer</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="n">data_transfer</span> <span class="o">+=</span> <span class="n">residual</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span><span class="n">data_transfer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">count</span><span class="p">;</span> 
					<span class="n">__u32</span> <span class="n">pAddr</span><span class="p">;</span>

					<span class="n">SGcount</span><span class="o">--</span><span class="p">;</span>

					<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">bS_to_cpu</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">SGcount</span><span class="p">].</span><span class="n">ins</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
					<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;DATA TRANSFER MISMATCH, count = %d, transferred %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="o">-</span><span class="n">data_transfer</span><span class="p">));</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">SGcount</span><span class="p">].</span><span class="n">ins</span> <span class="o">&amp;=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="mh">0xff000000</span><span class="p">);</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">SGcount</span><span class="p">].</span><span class="n">ins</span> <span class="o">|=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">data_transfer</span><span class="p">);</span>
					<span class="n">pAddr</span> <span class="o">=</span> <span class="n">bS_to_cpu</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">SGcount</span><span class="p">].</span><span class="n">pAddr</span><span class="p">);</span>
					<span class="n">pAddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">data_transfer</span><span class="p">);</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pAddr</span> <span class="o">!=</span> <span class="n">naddr</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d (%d:%d) transfer mismatch pAddr=%lx, naddr=%lx, data_transfer=%d, residual=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">naddr</span><span class="p">,</span> <span class="n">data_transfer</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>
					<span class="p">}</span>
<span class="cp">#endif</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">SGcount</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">pAddr</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* set the executed moves to nops */</span>
				<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SGcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">SCRIPT_NOP</span><span class="p">);</span>
					<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
				<span class="cm">/* and pretend we disconnected after</span>
<span class="cm">				 * the command phase */</span>
				<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span> <span class="o">+</span> <span class="n">Ent_MsgInDuringData</span><span class="p">;</span>
				<span class="cm">/* make sure all the data is flushed */</span>
				<span class="n">NCR_700_flush_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">__u8</span> <span class="n">sbcl</span> <span class="o">=</span> <span class="n">NCR_700_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SBCL_REG</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) phase mismatch at %04x, phase %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">,</span> <span class="n">sbcl_to_string</span><span class="p">(</span><span class="n">sbcl</span><span class="p">));</span>
				<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">SCSI_GROSS_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) GROSS ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) PARITY ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">SCRIPT_INT_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: (%d:%d) ====&gt;SCRIPT INTERRUPT&lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">process_script_interrupt</span><span class="p">(</span><span class="n">dsps</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">hostdata</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ILGL_INST_DETECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) Illegal Instruction detected at 0x%08x[0x%x]!!!</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;         Please email James.Bottomley@HansenPartnership.com with the details</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
			       <span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">dstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WATCH_DOG_INTERRUPT</span><span class="o">|</span><span class="n">ABORTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: (%d:%d) serious DMA problem, dstat=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pun</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">dstat</span><span class="p">);</span>
			<span class="n">NCR_700_scsi_done</span><span class="p">(</span><span class="n">hostdata</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>

		
		<span class="cm">/* NOTE: selection interrupt processing MUST occur</span>
<span class="cm">		 * after script interrupt processing to correctly cope</span>
<span class="cm">		 * with the case where we process a disconnect and</span>
<span class="cm">		 * then get reselected before we process the</span>
<span class="cm">		 * disconnection */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">sstat0</span> <span class="o">&amp;</span> <span class="n">SELECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIXME: It currently takes at least FOUR</span>
<span class="cm">			 * interrupts to complete a command that</span>
<span class="cm">			 * disconnects: one for the disconnect, one</span>
<span class="cm">			 * for the reselection, one to get the</span>
<span class="cm">			 * reselection data and one to complete the</span>
<span class="cm">			 * command.  If we guess the reselected</span>
<span class="cm">			 * command here and prepare it, we only need</span>
<span class="cm">			 * to get a reselection data interrupt if we</span>
<span class="cm">			 * guessed wrongly.  Since the interrupt</span>
<span class="cm">			 * overhead is much greater than the command</span>
<span class="cm">			 * setup, this would be an efficient</span>
<span class="cm">			 * optimisation particularly as we probably</span>
<span class="cm">			 * only have one outstanding command on a</span>
<span class="cm">			 * target most of the time */</span>

			<span class="n">resume_offset</span> <span class="o">=</span> <span class="n">process_selection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>

		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">resume_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%d: Driver error: resume at 0x%08x [0x%04x] with non busy host!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">resume_offset</span><span class="p">,</span> <span class="n">resume_offset</span> <span class="o">-</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pScript</span><span class="p">);</span>
			<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">NCR_700_HOST_BUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;Attempting to resume at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resume_offset</span><span class="p">));</span>
		<span class="n">NCR_700_clear_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">NCR_700_writel</span><span class="p">(</span><span class="n">resume_offset</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">DSP_REG</span><span class="p">);</span>
	<span class="p">}</span> 
	<span class="cm">/* There is probably a technical no-no about this: If we&#39;re a</span>
<span class="cm">	 * shared interrupt and we got this interrupt because the</span>
<span class="cm">	 * other device needs servicing not us, we&#39;re still going to</span>
<span class="cm">	 * check our queued commands here---of course, there shouldn&#39;t</span>
<span class="cm">	 * be any outstanding.... */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">NCR_700_HOST_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fairness: always run the queue from the last</span>
<span class="cm">			 * position we left off */</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">saved_slot_position</span><span class="p">)</span>
				<span class="o">%</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">;</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NCR_700_SLOT_QUEUED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">NCR_700_start_command</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cmnd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot;scsi%d: Issuing saved command slot %p, cmd %p</span><span class="se">\t\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				       <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cmnd</span><span class="p">));</span>
				<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">saved_slot_position</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">NCR_700_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">move_ins</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">command_slot_count</span> <span class="o">&gt;=</span> <span class="n">NCR_700_COMMAND_SLOTS_PER_HOST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We&#39;re over our allocation, this should never happen</span>
<span class="cm">		 * since we report the max allocation to the mid layer */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%d: Command depth has gone over queue depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check for untagged commands.  We cannot have any outstanding</span>
<span class="cm">	 * commands if we accept them.  Commands could be untagged because:</span>
<span class="cm">	 *</span>
<span class="cm">	 * - The tag negotiated bitmap is clear</span>
<span class="cm">	 * - The blk layer sent and untagged command</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">)))</span>
	       <span class="o">||</span> <span class="o">!</span><span class="n">blk_rq_tagged</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">CDEBUG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;has non zero depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_DEVICE_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CDEBUG</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;has max tag depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_DEVICE_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NCR_700_set_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* begin the command here */</span>
	<span class="cm">/* no need to check for NULL, test for command_slot_count above</span>
<span class="cm">	 * ensures a slot is free */</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">find_empty_slot</span><span class="p">(</span><span class="n">hostdata</span><span class="p">);</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">SCp</span><span class="p">;</span>

	<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef NCR_700_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;53c700: scsi%d, command &quot;</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span><span class="p">(</span><span class="n">blk_rq_tagged</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span>
	   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span>
	   <span class="o">&amp;&amp;</span> <span class="n">NCR_700_get_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="n">NCR_700_START_TAG_NEGOTIATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;Enabling Tag Command Queuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">));</span>
		<span class="n">NCR_700_set_tag_neg_state</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">NCR_700_DURING_TAG_NEGOTIATION</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* here we may have to process an untagged command.  The gate</span>
<span class="cm">	 * above ensures that this will be the only one outstanding,</span>
<span class="cm">	 * so clear the tag negotiated bit.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: This will royally screw up on multiple LUN devices</span>
<span class="cm">	 * */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">blk_rq_tagged</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span>
	   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;Disabling Tag Command Queuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCp</span><span class="p">)))</span>
	   <span class="o">&amp;&amp;</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">CDEBUG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;sending out tag %d, slot %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">slot</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">SCSI_NO_TAG</span><span class="p">;</span>
		<span class="cm">/* must populate current_cmnd for scsi_find_tag to work */</span>
		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">current_cmnd</span> <span class="o">=</span> <span class="n">SCp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* sanity check: some of the commands generated by the mid-layer</span>
<span class="cm">	 * have an eccentric idea of their sc_data_direction */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef NCR_700_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;53c700: Command&quot;</span><span class="p">);</span>
		<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Has wrong data direction %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="cm">/* clear the internal sense magic */</span>
		<span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="cm">/* OK, get it from the command */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53c700: Unknown command for data direction &quot;</span><span class="p">);</span>
			<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
			
			<span class="n">move_ins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_NONE</span>:
			<span class="n">move_ins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
			<span class="n">move_ins</span> <span class="o">=</span> <span class="n">SCRIPT_MOVE_DATA_IN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
			<span class="n">move_ins</span> <span class="o">=</span> <span class="n">SCRIPT_MOVE_DATA_OUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* now build the scatter gather list */</span>
	<span class="n">direction</span> <span class="o">=</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">move_ins</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sg_count</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">vPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sg_count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sg_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SCp</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vPtr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">move_ins</span> <span class="o">|</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot; scatter block %d: move %d[%08x] from 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vPtr</span><span class="p">));</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">vPtr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span> <span class="o">=</span> <span class="n">bS_to_host</span><span class="p">(</span><span class="n">SCRIPT_RETURN</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">((</span><span class="s">&quot; SETTING %08lx to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pSG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span><span class="p">),</span>
		       <span class="n">slot</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ins</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">resume_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pCmd</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span>
				    <span class="n">MAX_COMMAND_SIZE</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">NCR_700_start_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">NCR_700_queuecommand</span><span class="p">)</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="n">NCR_700_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
		<span class="s">&quot;New error handler wants to abort command</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_command_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* no outstanding command to abort */</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: This is because of a problem in the new</span>
<span class="cm">		 * error handler.  When it is in error recovery, it</span>
<span class="cm">		 * will send a TUR to a device it thinks may still be</span>
<span class="cm">		 * showing a problem.  If the TUR isn&#39;t responded to,</span>
<span class="cm">		 * it will abort it and mark the device off line.</span>
<span class="cm">		 * Unfortunately, it does no other error recovery, so</span>
<span class="cm">		 * this would leave us with an outstanding command</span>
<span class="cm">		 * occupying a slot.  Rather than allow this to</span>
<span class="cm">		 * happen, we issue a bus reset to force all</span>
<span class="cm">		 * outstanding commands to terminate here. */</span>
		<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="cm">/* still drop through and return failed */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">NCR_700_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">complete</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span>
		<span class="s">&quot;New error handler wants BUS reset, cmd %p</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCp</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>

	<span class="cm">/* In theory, eh_complete should always be null because the</span>
<span class="cm">	 * eh is single threaded, but just in case we&#39;re handling a</span>
<span class="cm">	 * reset via sg or something */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">complete</span><span class="p">;</span>
	<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">eh_complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Revalidate the transport parameters of the failing device */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
		<span class="n">spi_schedule_dv_device</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">NCR_700_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCp</span><span class="p">,</span> <span class="s">&quot;New error handler wants HOST reset</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCp</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">NCR_700_internal_bus_reset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">NCR_700_chip_reset</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_set_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SHp</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SHp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">;</span>

	<span class="n">spi_period</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">spi_flags</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span> <span class="o">|</span>
			    <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">);</span>
	<span class="n">spi_flags</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">|=</span> <span class="n">NCR_700_DEV_PRINT_SYNC_NEGOTIATION</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_set_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">STp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SHp</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">STp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SHp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">max_offset</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">chip710</span>
		<span class="o">?</span> <span class="n">NCR_710_MAX_OFFSET</span> <span class="o">:</span> <span class="n">NCR_700_MAX_OFFSET</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">max_offset</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">max_offset</span><span class="p">;</span>

	<span class="cm">/* if we&#39;re currently async, make sure the period is reasonable */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">spi_offset</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">||</span>
				    <span class="n">spi_period</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">))</span>
		<span class="n">spi_period</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">;</span>

	<span class="n">spi_offset</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">spi_flags</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NCR_700_DEV_NEGOTIATED_SYNC</span> <span class="o">|</span>
			    <span class="n">NCR_700_DEV_BEGIN_SYNC_NEGOTIATION</span><span class="p">);</span>
	<span class="n">spi_flags</span><span class="p">(</span><span class="n">STp</span><span class="p">)</span> <span class="o">|=</span> <span class="n">NCR_700_DEV_PRINT_SYNC_NEGOTIATION</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">NCR_700_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SDp</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Device_Parameters</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">int</span>
<span class="nf">NCR_700_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* to do here: allocate memory; build a queue_full list */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">);</span>
		<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">NCR_700_DEFAULT_TAGS</span><span class="p">);</span>
		<span class="n">NCR_700_set_tag_neg_state</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">NCR_700_START_TAG_NEGOTIATION</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* initialise to default depth */</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Find the correct offset and period via domain validation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi_initial_dv</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">))</span>
			<span class="n">spi_dv_device</span><span class="p">(</span><span class="n">SDp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spi_offset</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spi_period</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STATIC</span> <span class="kt">void</span>
<span class="nf">NCR_700_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">SDp</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">NCR_700_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">NCR_700_MAX_TAGS</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">NCR_700_MAX_TAGS</span><span class="p">;</span>

	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">SDp</span><span class="p">),</span> <span class="n">depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">NCR_700_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change_tag</span> <span class="o">=</span> <span class="p">((</span><span class="n">tag_type</span> <span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>  <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">SDp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			  <span class="o">||</span> <span class="p">(</span><span class="n">tag_type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">SDp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="n">hostdata</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">NCR_700_Host_Parameters</span> <span class="o">*</span><span class="p">)</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">);</span>

	<span class="cm">/* We have a global (per target) flag to track whether TCQ is</span>
<span class="cm">	 * enabled, so we&#39;ll be turning it off for the entire target here.</span>
<span class="cm">	 * our tag algorithm will fail if we mix tagged and untagged commands,</span>
<span class="cm">	 * so quiesce the device before doing this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_tag</span><span class="p">)</span>
		<span class="n">scsi_target_quiesce</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shift back to the default unqueued number of commands</span>
<span class="cm">		 * (the user can still raise this) */</span>
		<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
		<span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">tag_negotiated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sdev_id</span><span class="p">(</span><span class="n">SDp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Here, we cleared the negotiation flag above, so this</span>
<span class="cm">		 * will force the driver to renegotiate */</span>
		<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">SDp</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change_tag</span><span class="p">)</span>
			<span class="n">NCR_700_set_tag_neg_state</span><span class="p">(</span><span class="n">SDp</span><span class="p">,</span> <span class="n">NCR_700_START_TAG_NEGOTIATION</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_tag</span><span class="p">)</span>
		<span class="n">scsi_target_resume</span><span class="p">(</span><span class="n">SDp</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tag_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">NCR_700_show_active_tags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">SDp</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NCR_700_get_depth</span><span class="p">(</span><span class="n">SDp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">NCR_700_active_tags_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;active_tags&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">NCR_700_show_active_tags</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">STATIC</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">NCR_700_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">NCR_700_active_tags_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">NCR_700_detect</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">NCR_700_release</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">NCR_700_intr</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_function_template</span> <span class="n">NCR_700_transport_functions</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="p">.</span><span class="n">set_period</span>	<span class="o">=</span> <span class="n">NCR_700_set_period</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_period</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offset</span>	<span class="o">=</span> <span class="n">NCR_700_set_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_offset</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">NCR_700_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NCR_700_transport_template</span> <span class="o">=</span> <span class="n">spi_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NCR_700_transport_functions</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">NCR_700_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">NCR_700_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_release_transport</span><span class="p">(</span><span class="n">NCR_700_transport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">NCR_700_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">NCR_700_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
