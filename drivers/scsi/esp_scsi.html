<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › esp_scsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>esp_scsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* esp_scsi.c: ESP SCSI driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irqreturn.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_spi.h&gt;</span>

<span class="cp">#include &quot;esp_scsi.h&quot;</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;esp&quot;</span>
<span class="cp">#define PFX DRV_MODULE_NAME	&quot;: &quot;</span>
<span class="cp">#define DRV_VERSION		&quot;2.000&quot;</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;April 19, 2007&quot;</span>

<span class="cm">/* SCSI bus reset settle time in seconds.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">esp_bus_reset_settle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">esp_debug</span><span class="p">;</span>
<span class="cp">#define ESP_DEBUG_INTR		0x00000001</span>
<span class="cp">#define ESP_DEBUG_SCSICMD	0x00000002</span>
<span class="cp">#define ESP_DEBUG_RESET		0x00000004</span>
<span class="cp">#define ESP_DEBUG_MSGIN		0x00000008</span>
<span class="cp">#define ESP_DEBUG_MSGOUT	0x00000010</span>
<span class="cp">#define ESP_DEBUG_CMDDONE	0x00000020</span>
<span class="cp">#define ESP_DEBUG_DISCONNECT	0x00000040</span>
<span class="cp">#define ESP_DEBUG_DATASTART	0x00000080</span>
<span class="cp">#define ESP_DEBUG_DATADONE	0x00000100</span>
<span class="cp">#define ESP_DEBUG_RECONNECT	0x00000200</span>
<span class="cp">#define ESP_DEBUG_AUTOSENSE	0x00000400</span>

<span class="cp">#define esp_log_intr(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_INTR) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_reset(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_RESET) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_msgin(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_MSGIN) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_msgout(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_MSGOUT) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_cmddone(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_CMDDONE) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_disconnect(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_DISCONNECT) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_datastart(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_DATASTART) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_datadone(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_DATADONE) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_reconnect(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_RECONNECT) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_log_autosense(f, a...) \</span>
<span class="cp">do {	if (esp_debug &amp; ESP_DEBUG_AUTOSENSE) \</span>
<span class="cp">		printk(f, ## a); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define esp_read8(REG)		esp-&gt;ops-&gt;esp_read8(esp, REG)</span>
<span class="cp">#define esp_write8(VAL,REG)	esp-&gt;ops-&gt;esp_write8(esp, VAL, REG)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_log_fill_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">esp_event_ent</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">seqreg</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">seqreg</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">sreg2</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">scsi_esp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_event_ent</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_cur</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_log</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ESP_EVENT_TYPE_CMD</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">esp_log_fill_regs</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESP_EVENT_LOG_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">esp_write8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ESP_CMD</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_esp_cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_event_ent</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_cur</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_log</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ESP_EVENT_TYPE_EVENT</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">esp_log_fill_regs</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESP_EVENT_LOG_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_dump_cmd_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Dumping command log</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_event_ent</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_event_log</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: ent[%d] %s &quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ESP_EVENT_TYPE_CMD</span> <span class="o">?</span> <span class="s">&quot;CMD&quot;</span> <span class="o">:</span> <span class="s">&quot;EVENT&quot;</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;val[%02x] sreg[%02x] seqreg[%02x] &quot;</span>
		       <span class="s">&quot;sreg2[%02x] ireg[%02x] ss[%02x] event[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">seqreg</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">sreg2</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">select_state</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESP_EVENT_LOG_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">stop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_flush_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP236</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lim</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FFLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESP_FF_FBYTES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: ESP_FF_BYTES &quot;</span>
				       <span class="s">&quot;will not clear!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hme_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fcnt</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FFLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESP_FF_FBYTES</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fcnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span> <span class="o">&amp;</span> <span class="n">ESP_STAT2_F1BYTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ESP_FDATA</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo_cnt</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_set_all_config3</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_MAX_TARGET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">esp_config3</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the ESP chip, _not_ the SCSI bus. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_reset_esp</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">family_code</span><span class="p">,</span> <span class="n">version</span><span class="p">;</span>

	<span class="cm">/* Now reset the ESP chip */</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RC</span><span class="p">);</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span> <span class="o">|</span> <span class="n">ESP_CMD_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FAST</span><span class="p">)</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">ESP_CONFIG2_FENAB</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span> <span class="o">|</span> <span class="n">ESP_CMD_DMA</span><span class="p">);</span>

	<span class="cm">/* This is the only point at which it is reliable to read</span>
<span class="cm">	 * the ID-code for a fast ESP chip variants.</span>
<span class="cm">	 */</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">max_period</span> <span class="o">=</span> <span class="p">((</span><span class="mi">35</span> <span class="o">*</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_UID</span><span class="p">);</span>
		<span class="n">family_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">family_code</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">FAS236</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">family_code</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">FASHME</span><span class="p">;</span> <span class="cm">/* Version is usually &#39;5&#39;. */</span>
		<span class="k">else</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">FAS100A</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="p">((</span><span class="mi">5</span> <span class="o">*</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">max_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">max_period</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config1</span><span class="p">,</span> <span class="n">ESP_CFG1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESP100</span>:
		<span class="cm">/* nothing to do */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESP100A</span>:
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESP236</span>:
		<span class="cm">/* Slow 236 */</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FASHME</span>:
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ESP_CONFIG2_HME32</span> <span class="o">|</span> <span class="n">ESP_CONFIG2_HMEFENAB</span><span class="p">);</span>
		<span class="cm">/* fallthrough... */</span>

	<span class="k">case</span> <span class="n">FAS236</span>:
		<span class="cm">/* Fast 236 or HME */</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">cfg3</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>

			<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">ESP_CONFIG3_FCLOCK</span> <span class="o">|</span> <span class="n">ESP_CONFIG3_OBPUSH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">ESP_CONFIG3_IDBIT3</span><span class="p">;</span>
			<span class="n">esp_set_all_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cfg3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cfg3</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>

			<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">ESP_CONFIG3_FCLK</span><span class="p">;</span>
			<span class="n">esp_set_all_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cfg3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_DIFFERENTIAL</span><span class="p">)</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FAS100A</span>:
		<span class="cm">/* Fast 100a */</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="n">esp_set_all_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span> <span class="o">|</span>
				     <span class="n">ESP_CONFIG3_FCLOCK</span><span class="p">));</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reload the configuration registers */</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfact</span><span class="p">,</span> <span class="n">ESP_CFACT</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_stp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_stp</span><span class="p">,</span> <span class="n">ESP_STP</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span><span class="p">,</span> <span class="n">ESP_SOFF</span><span class="p">);</span>

	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">neg_defp</span><span class="p">,</span> <span class="n">ESP_TIMEO</span><span class="p">);</span>

	<span class="cm">/* Eat any bitrot in the chip */</span>
	<span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_map_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">num_sg</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_sg</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spriv</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">num_sg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">tot_residue</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">esp_cur_dma_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_dma</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">)</span> <span class="o">-</span>
		 <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">esp_cur_dma_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_advance_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">tot_residue</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tot_residue</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Data transfer overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: cur_residue[%d] tot_residue[%d] &quot;</span>
		       <span class="s">&quot;len[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tot_residue</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tot_residue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tot_residue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_unmap_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_sg</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">spriv</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">num_sg</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_save_pointers</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_sense_ptr</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_cur_residue</span> <span class="o">=</span> <span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span><span class="p">;</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_cur_sg</span> <span class="o">=</span> <span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">;</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_tot_residue</span> <span class="o">=</span> <span class="n">spriv</span><span class="o">-&gt;</span><span class="n">tot_residue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_restore_pointers</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_sense_ptr</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_cur_residue</span><span class="p">;</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_cur_sg</span><span class="p">;</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">tot_residue</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_tot_residue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_check_command_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_write_tgt_config3</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="n">ESP100A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">esp_config3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">esp_write8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_write_tgt_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">off</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">esp_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">per</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">esp_period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">ESP_SOFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">per</span> <span class="o">!=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_stp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_stp</span> <span class="o">=</span> <span class="n">per</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">per</span><span class="p">,</span> <span class="n">ESP_STP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">esp_dma_length_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Arbitrary segment boundaries, 24-bit counts.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

		<span class="cm">/* ESP chip limits other variants by 16-bits of transfer</span>
<span class="cm">		 * count.  Actually on FAS100A and FAS236 we could get</span>
<span class="cm">		 * 24-bits of transfer count by enabling ESP_CONFIG2_FENAB</span>
<span class="cm">		 * in the ESP_CFG2 register but that causes other unwanted</span>
<span class="cm">		 * changes so we don&#39;t use it currently.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* All of the DMA variants hooked up to these chips</span>
<span class="cm">		 * cannot handle crossing a 24-bit address boundary.</span>
<span class="cm">		 */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1U</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">dma_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span>
			<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">);</span>
		<span class="n">dma_len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dma_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_need_to_nego_wide</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">spi_width</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_width</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_need_to_nego_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>

	<span class="cm">/* When offset is zero, period is &quot;don&#39;t care&quot;.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi_offset</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_offset</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span> <span class="o">&amp;&amp;</span>
	    <span class="n">spi_period</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_alloc_lun_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Non-tagged, slot already taken?  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hold</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We are being held by active tagged</span>
<span class="cm">			 * commands.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

			<span class="cm">/* Tagged commands completed, we can unplug</span>
<span class="cm">			 * the queue and run this untagged command.</span>
<span class="cm">			 */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Plug the queue until num_tagged decreases</span>
<span class="cm">			 * to zero in esp_free_lun_tag.</span>
<span class="cm">			 */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Tagged command, see if blocked by a</span>
<span class="cm">		 * non-tagged one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hold</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tagged_cmds</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tagged_cmds</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_free_lun_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tagged_cmds</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">ent</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tagged_cmds</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span> <span class="o">!=</span> <span class="n">ent</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* When a contingent allegiance conditon is created, we force feed a</span>
<span class="cm"> * REQUEST_SENSE command to the device to fetch the sense data.  I</span>
<span class="cm"> * tried many other schemes, relying on the scsi error handling layer</span>
<span class="cm"> * to send out the REQUEST_SENSE automatically, but this was difficult</span>
<span class="cm"> * to get right especially in the presence of applications like smartd</span>
<span class="cm"> * which use SG_IO to send out their own REQUEST_SENSE commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_autosense</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_log_autosense</span><span class="p">(</span><span class="s">&quot;esp%d: Doing auto-sense for &quot;</span>
				  <span class="s">&quot;tgt[%d] lun[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_dma</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_single</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span>
						      <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span><span class="p">,</span>
						      <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
						      <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">saved_sense_ptr</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IDENTIFY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;=</span> <span class="n">SCSI_2</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">=</span> <span class="n">ESP_SELECT_BASIC</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ESP_BUSID_RESELID</span> <span class="o">|</span> <span class="n">ESP_BUSID_CTR32BIT</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ESP_BUSID</span><span class="p">);</span>

	<span class="n">esp_write_tgt_sync</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>
	<span class="n">esp_write_tgt_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block_dma</span><span class="p">,</span>
			       <span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_SELA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="nf">find_and_prep_issuable_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp_alloc_lun_tag</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_maybe_execute_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">start_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_RESETTING</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">find_and_prep_issuable_command</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_autosense</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">];</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>

	<span class="n">esp_map_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">esp_save_pointers</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>

	<span class="n">esp_check_command_len</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to negotiate.  If the target is broken</span>
<span class="cm">		 * go for synchronous transfers and non-wide.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_BROKEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_DISCONNECT</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_tags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If the settings are not changing, skip this.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi_width</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_width</span> <span class="o">&amp;&amp;</span>
		    <span class="n">spi_period</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span> <span class="o">&amp;&amp;</span>
		    <span class="n">spi_offset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">build_identify</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span> <span class="o">&amp;&amp;</span> <span class="n">esp_need_to_nego_wide</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span>
				<span class="n">spi_populate_width_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						       <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_width</span> <span class="o">?</span>
							<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_NEGO_WIDE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">esp_need_to_nego_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span>
				<span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span><span class="p">,</span>
						      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Process it like a slow command.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESP_TGT_NEGO_WIDE</span> <span class="o">|</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">))</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">build_identify:</span>
	<span class="cm">/* If we don&#39;t have a lun-data struct yet, we&#39;re probing</span>
<span class="cm">	 * so do not disconnect.  Also, do not disconnect unless</span>
<span class="cm">	 * we have a tag on this command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_DISCONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IDENTIFY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IDENTIFY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ESP100 lacks select w/atn3 command, use select</span>
<span class="cm">		 * and stop instead.</span>
<span class="cm">		 */</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_cmd</span> <span class="o">=</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_SELA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="n">start_cmd</span> <span class="o">=</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_SA3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">=</span> <span class="n">ESP_SELECT_BASIC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_left</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start_cmd</span> <span class="o">=</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_SELAS</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">=</span> <span class="n">ESP_SELECT_MSGOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ESP_BUSID_RESELID</span> <span class="o">|</span> <span class="n">ESP_BUSID_CTR32BIT</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ESP_BUSID</span><span class="p">);</span>

	<span class="n">esp_write_tgt_sync</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>
	<span class="n">esp_write_tgt_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp_debug</span> <span class="o">&amp;</span> <span class="n">ESP_DEBUG_SCSICMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: tgt[%d] lun[%d] scsi_cmd [ &quot;</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block_dma</span><span class="p">,</span>
			       <span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="nf">esp_get_ent</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_cmd_pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_put_ent</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_cmd_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_cmd_is_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">esp_unmap_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">esp_free_lun_tag</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">eh_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">eh_done</span><span class="p">);</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eh_done</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_single</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">,</span>
				       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Restore the message/status bytes to what we actually</span>
<span class="cm">		 * saw originally.  Also, report that we are providing</span>
<span class="cm">		 * the sense data.</span>
<span class="cm">		 */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp_debug</span> <span class="o">&amp;</span> <span class="n">ESP_DEBUG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;esp%d: tgt[%d] lun[%d] AUTO SENSE[ &quot;</span><span class="p">,</span>
			       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">esp_put_ent</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>

	<span class="n">esp_maybe_execute_command</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">compose_result</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">message</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">driver_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">|</span> <span class="p">(</span><span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">driver_code</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_event_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">esp_get_ent</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">);</span>

	<span class="n">esp_maybe_execute_command</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">esp_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">esp_check_gross_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_SPAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Gross Error, could be one of:</span>
<span class="cm">		 * - top of fifo overwritten</span>
<span class="cm">		 * - top of command register overwritten</span>
<span class="cm">		 * - DMA programmed with wrong direction</span>
<span class="cm">		 * - improper phase change</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Gross error sreg[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>
		<span class="cm">/* XXX Reset the chip. XXX */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_check_spur_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESP100</span>:
	<span class="k">case</span> <span class="n">ESP100A</span>:
		<span class="cm">/* The interrupt pending bit of the status register cannot</span>
<span class="cm">		 * be trusted on these revisions.</span>
<span class="cm">		 */</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_STAT_INTR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_INTR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_SR</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* If the DMA is indicating interrupt pending and the</span>
<span class="cm">			 * ESP is not, the only possibility is a DMA error.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_error</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Spurious irq, &quot;</span>
				       <span class="s">&quot;sreg=%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: DMA error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>

			<span class="cm">/* XXX Reset the chip. XXX */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_schedule_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">esp_log_reset</span><span class="p">(</span><span class="s">&quot;ESP: esp_schedule_reset() from %pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_RESETTING</span><span class="p">;</span>
	<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* In order to avoid having to add a special half-reconnected state</span>
<span class="cm"> * into the driver we just sit here and poll through the rest of</span>
<span class="cm"> * the reselection process to get the tag message bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="nf">esp_reconnect_with_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect w/num_tagged==0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp_log_reconnect</span><span class="p">(</span><span class="s">&quot;ESP: reconnect tag, &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_QUICKIRQ_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ESP_QUICKIRQ_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect IRQ1 timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>

	<span class="n">esp_log_reconnect</span><span class="p">(</span><span class="s">&quot;IRQ(%d:%x:%x), &quot;</span><span class="p">,</span>
			  <span class="n">i</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_DC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect, got disconnect.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_PMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ESP_MIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect, not MIP sreg[%02x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DMA in the tag bytes... */</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block_dma</span><span class="p">,</span>
			       <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>

	<span class="cm">/* ACK the message.  */</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_MOK</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_RESELECT_TAG_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_FDONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ESP_RESELECT_TAG_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect IRQ2 timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_drain</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_invalidate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="n">esp_log_reconnect</span><span class="p">(</span><span class="s">&quot;IRQ2(%d:%x:%x) tag[%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">i</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">,</span>
			  <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SIMPLE_QUEUE_TAG</span> <span class="o">||</span>
	    <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ORDERED_QUEUE_TAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect, bad tag &quot;</span>
		       <span class="s">&quot;type %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tagged_cmds</span><span class="p">[</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect, no entry for &quot;</span>
		       <span class="s">&quot;tag %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FASHME puts the target and lun numbers directly</span>
<span class="cm">		 * into the fifo.</span>
<span class="cm">		 */</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>

		<span class="cm">/* Older chips put the lun directly into the fifo, but</span>
<span class="cm">		 * the target is given as a sample of the arbitration</span>
<span class="cm">		 * lines on the bus at reselection time.  So we should</span>
<span class="cm">		 * see the ID of the ESP and the one reconnecting target</span>
<span class="cm">		 * set in the bitmap.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">scsi_id_mask</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_reset</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">scsi_id_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits</span> <span class="o">||</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">do_reset</span><span class="p">;</span>

		<span class="n">target</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">ireg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>
			<span class="cm">/* This chip has a bug during reselection that can</span>
<span class="cm">			 * cause a spurious illegal-command interrupt, which</span>
<span class="cm">			 * we simply ACK here.  Another possibility is a bus</span>
<span class="cm">			 * reset so we must check for that.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_SR</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do_reset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">esp_write_tgt_sync</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">esp_write_tgt_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_MOK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">target</span> <span class="o">|</span> <span class="n">ESP_BUSID_RESELID</span> <span class="o">|</span> <span class="n">ESP_BUSID_CTR32BIT</span><span class="p">,</span>
			   <span class="n">ESP_BUSID</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">__scsi_device_lookup_by_target</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Reconnect, no lp &quot;</span>
		       <span class="s">&quot;tgt[%u] lun[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">non_tagged_cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">esp_reconnect_with_tag</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_ABORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT_TASK_SET</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
	<span class="n">esp_restore_pointers</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">do_reset:</span>
	<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_finish_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_select_state</span><span class="p">;</span>

	<span class="n">orig_select_state</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span><span class="p">;</span>

	<span class="cm">/* No longer selecting.  */</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">=</span> <span class="n">ESP_SELECT_NONE</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">seqreg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_SSTEP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESP_STEP_VBITS</span><span class="p">;</span>
	<span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_error</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we see a DMA error during or as a result of selection,</span>
<span class="cm">		 * all bets are off.</span>
<span class="cm">		 */</span>
		<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="n">esp_cmd_is_done</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_invalidate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">==</span> <span class="p">(</span><span class="n">ESP_INTR_RSEL</span> <span class="o">|</span> <span class="n">ESP_INTR_FDONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

		<span class="cm">/* Carefully back out of the selection attempt.  Release</span>
<span class="cm">		 * resources (such as DMA mapping &amp; TAG) and reset state (such</span>
<span class="cm">		 * as message out and command delivery variables).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp_unmap_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">esp_free_lun_tag</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESP_TGT_NEGO_SYNC</span> <span class="o">|</span> <span class="n">ESP_TGT_NEGO_WIDE</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_FLAG_DOING_SLOWCMD</span><span class="p">;</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_single</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">,</span>
					       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
					       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now that the state is unwound properly, put back onto</span>
<span class="cm">		 * the issue queue.  This command is no longer active.</span>
<span class="cm">		 */</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Return value ignored by caller, it directly invokes</span>
<span class="cm">		 * esp_reconnect().</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">==</span> <span class="n">ESP_INTR_DC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

		<span class="cm">/* Disconnect.  Make sure we re-negotiate sync and</span>
<span class="cm">		 * wide parameters if this target starts responding</span>
<span class="cm">		 * again in the future.</span>
<span class="cm">		 */</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>

		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_ESEL</span><span class="p">);</span>
		<span class="n">esp_cmd_is_done</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">==</span> <span class="p">(</span><span class="n">ESP_INTR_FDONE</span> <span class="o">|</span> <span class="n">ESP_INTR_BSERV</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Selection successful.  On pre-FAST chips we have</span>
<span class="cm">		 * to do a NOP and possibly clean out the FIFO.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="n">ESP236</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">fcnt</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FFLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESP_FF_FBYTES</span><span class="p">;</span>

			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcnt</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span> <span class="o">||</span>
			     <span class="p">((</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_PMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ESP_DIP</span><span class="p">)))</span>
				<span class="n">esp_flush_fifo</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If we are doing a slow command, negotiation, etc.</span>
<span class="cm">		 * we&#39;ll do the right thing as we transition to the</span>
<span class="cm">		 * next phase.</span>
<span class="cm">		 */</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected selection completion ireg[%x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">);</span>
	<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_data_bytes_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifo_cnt</span><span class="p">,</span> <span class="n">ecount</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="p">,</span> <span class="n">flush_fifo</span><span class="p">;</span>

	<span class="n">fifo_cnt</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FFLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESP_FF_FBYTES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">&amp;</span> <span class="n">ESP_CONFIG3_EWIDE</span><span class="p">)</span>
		<span class="n">fifo_cnt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_TCNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecount</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_TCLOW</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_TCMED</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
			<span class="n">ecount</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">FAS_RLO</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">data_dma_len</span><span class="p">;</span>
	<span class="n">bytes_sent</span> <span class="o">-=</span> <span class="n">ecount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_WRITE</span><span class="p">))</span>
		<span class="n">bytes_sent</span> <span class="o">-=</span> <span class="n">fifo_cnt</span><span class="p">;</span>

	<span class="n">flush_fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Synchronous data transfer, always flush fifo. */</span>
		<span class="n">flush_fifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">fflags</span><span class="p">,</span> <span class="n">phase</span><span class="p">;</span>

			<span class="cm">/* ESP100 has a chip bug where in the synchronous data</span>
<span class="cm">			 * phase it can mistake a final long REQ pulse from the</span>
<span class="cm">			 * target as an extra data byte.  Fun.</span>
<span class="cm">			 *</span>
<span class="cm">			 * To detect this case we resample the status register</span>
<span class="cm">			 * and fifo flags.  If we&#39;re still in a data phase and</span>
<span class="cm">			 * we see spurious chunks in the fifo, we return error</span>
<span class="cm">			 * to the caller which should reset and set things up</span>
<span class="cm">			 * such that we only try future transfers to this</span>
<span class="cm">			 * target in synchronous mode.</span>
<span class="cm">			 */</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS</span><span class="p">);</span>
			<span class="n">phase</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_PMASK</span><span class="p">;</span>
			<span class="n">fflags</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FFLAGS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ESP_DOP</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">ESP_FF_ONOTZERO</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ESP_DIP</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">ESP_FF_FBYTES</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_WRITE</span><span class="p">))</span>
			<span class="n">flush_fifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flush_fifo</span><span class="p">)</span>
		<span class="n">esp_flush_fifo</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes_sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_setsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">scsi_period</span><span class="p">,</span> <span class="n">u8</span> <span class="n">scsi_offset</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">esp_stp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">esp_soff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_period</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">scsi_period</span><span class="p">;</span>
	<span class="n">spi_offset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">scsi_offset</span><span class="p">;</span>
	<span class="n">spi_width</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_WIDE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp_soff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_stp</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">esp_soff</span> <span class="o">|=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">FAS236</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">ESP_CONFIG3_FSCSI</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">FAS100A</span><span class="p">)</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">ESP_CONFIG3_FAST</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_period</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
					<span class="n">esp_soff</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">radelay</span><span class="p">;</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span><span class="p">;</span>
			<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_period</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_stp</span> <span class="o">=</span> <span class="n">esp_stp</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_offset</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_soff</span> <span class="o">=</span> <span class="n">esp_soff</span><span class="p">;</span>

	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp_soff</span><span class="p">,</span> <span class="n">ESP_SOFF</span><span class="p">);</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp_stp</span><span class="p">,</span> <span class="n">ESP_STP</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESP_TGT_NEGO_SYNC</span> <span class="o">|</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">);</span>

	<span class="n">spi_display_xfer_agreement</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_msgin_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt</span><span class="p">;</span>

	<span class="n">tgt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_NEGO_WIDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESP_TGT_NEGO_WIDE</span> <span class="o">|</span> <span class="n">ESP_TGT_WIDE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp_need_to_nego_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RATN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span>
				<span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span><span class="p">,</span>
						      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">;</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESP_TGT_NEGO_SYNC</span> <span class="o">|</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp_setsync</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RATN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT_TASK_SET</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_msgin_sdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">period</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">stp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">one_clock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">max_period</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">period</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do_sdtr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

		<span class="n">one_clock</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">period</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">one_clock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span> <span class="o">&amp;&amp;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">FAS236</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stp</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>
				<span class="n">stp</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp_setsync</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">stp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">do_reject:</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">do_sdtr:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span>
		<span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span><span class="p">,</span>
				      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">);</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_msgin_wdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cfg3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">FASHME</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_TGT_NEGO_WIDE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

	<span class="n">cfg3</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_WIDE</span><span class="p">;</span>
		<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">ESP_CONFIG3_EWIDE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_WIDE</span><span class="p">;</span>
		<span class="n">cfg3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_CONFIG3_EWIDE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span> <span class="o">=</span> <span class="n">cfg3</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="n">cfg3</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_NEGO_WIDE</span><span class="p">;</span>

	<span class="n">spi_period</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_offset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp_need_to_nego_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RATN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span>
			<span class="n">spi_populate_sync_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span><span class="p">,</span>
					      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_NEGO_SYNC</span><span class="p">;</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">do_reject:</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_msgin_extended</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">tgt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">EXTENDED_SDTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_msgin_sdtr</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">EXTENDED_WDTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_msgin_wdtr</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected extended msg type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT_TASK_SET</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Analyze msgin bytes received from target so far.  Return non-zero</span>
<span class="cm"> * if there are more bytes needed to complete the message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_msgin_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">msg0</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg0</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Identify */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected msgin identify</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EXTENDED_MESSAGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">esp_msgin_extended</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IGNORE_WIDE_RESIDUE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">esp_cmd_priv</span> <span class="o">*</span><span class="n">spriv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">do_reject</span><span class="p">;</span>

		<span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
		<span class="n">spriv</span> <span class="o">=</span> <span class="n">ESP_CMD_PRIV</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">==</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="o">--</span><span class="p">;</span>
			<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">cur_residue</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spriv</span><span class="o">-&gt;</span><span class="n">tot_residue</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">NOP</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESTORE_POINTERS</span>:
		<span class="n">esp_restore_pointers</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAVE_POINTERS</span>:
		<span class="n">esp_save_pointers</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>:
	<span class="k">case</span> <span class="n">DISCONNECT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>

		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">msg0</span><span class="p">;</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_FREE_BUS</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MESSAGE_REJECT</span>:
		<span class="n">esp_msgin_reject</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
	<span class="nl">do_reject:</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_process_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_CHECK_PHASE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_PMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ESP_DOP</span>:
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_DATA_OUT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ESP_DIP</span>:
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_DATA_IN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ESP_STATP</span>:
			<span class="n">esp_flush_fifo</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_ICCSEQ</span><span class="p">);</span>
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_STATUS</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ESP_MOP</span>:
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_MSGOUT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ESP_MIP</span>:
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_MSGIN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ESP_CMDP</span>:
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CMD_START</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected phase, sreg=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESP_EVENT_DATA_IN</span>:
		<span class="n">write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>

	<span class="k">case</span> <span class="n">ESP_EVENT_DATA_OUT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">esp_cur_dma_addr</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span> <span class="o">=</span> <span class="n">esp_cur_dma_len</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP100</span><span class="p">)</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_CMD_FLAG_WRITE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_CMD_FLAG_WRITE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_length_limit</span><span class="p">)</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_length_limit</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span>
							     <span class="n">dma_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">esp_dma_length_limit</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">);</span>

		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">data_dma_len</span> <span class="o">=</span> <span class="n">dma_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: DMA length is zero!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: cur adr[%08llx] len[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">esp_cur_dma_addr</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">),</span>
			       <span class="n">esp_cur_dma_len</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">esp_log_datastart</span><span class="p">(</span><span class="s">&quot;ESP: start data addr[%08llx] len[%u] &quot;</span>
				  <span class="s">&quot;write(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>

		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span>
				       <span class="n">write</span><span class="p">,</span> <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_DATA_DONE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_DATA_DONE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bytes_sent</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_error</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: data done, DMA error, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX parity errors, etc. XXX */</span>

			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_drain</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_invalidate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">!=</span> <span class="n">ESP_INTR_BSERV</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We should always see exactly a bus-service</span>
<span class="cm">			 * interrupt at the end of a successful transfer.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: data done, not BSERV, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">esp_data_bytes_sent</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="n">esp_log_datadone</span><span class="p">(</span><span class="s">&quot;ESP: data done flgs[%x] sent[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX force sync mode for this target XXX */</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">esp_advance_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="p">);</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">ESP_EVENT_STATUS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_FDONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_MOK</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">==</span> <span class="n">ESP_INTR_BSERV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_MSGIN</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">!=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected message %x in status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_FREE_BUS</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_FREE_BUS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">==</span> <span class="n">COMMAND_COMPLETE</span> <span class="o">||</span>
		    <span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">==</span> <span class="n">DISCONNECT</span><span class="p">)</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_ESEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">==</span> <span class="n">COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esp_log_cmddone</span><span class="p">(</span><span class="s">&quot;ESP: Command done status[%x] &quot;</span>
					<span class="s">&quot;message[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">)</span>
				<span class="n">esp_event_queue_full</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">;</span>
				<span class="n">esp_autosense</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">esp_cmd_is_done</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
						<span class="n">compose_result</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
							       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span>
							       <span class="n">DID_OK</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">==</span> <span class="n">DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esp_log_disconnect</span><span class="p">(</span><span class="s">&quot;ESP: Disconnecting tgt[%d] &quot;</span>
					   <span class="s">&quot;tag[%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					   <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">esp_maybe_execute_command</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected message %x in freebus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">)</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_MSGOUT</span>: <span class="p">{</span>
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp_debug</span> <span class="o">&amp;</span> <span class="n">ESP_DEBUG_MSGOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Sending message [ &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Always use the fifo.  */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ESP_FDATA</span><span class="p">);</span>
				<span class="n">esp_write8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ESP_FDATA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ESP_FDATA</span><span class="p">);</span>
				<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Use DMA. */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">,</span>
				       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">,</span>
				       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">);</span>

				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span>
						       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block_dma</span><span class="p">,</span>
						       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">,</span>
						       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span>
						       <span class="n">ESP_CMD_DMA</span><span class="o">|</span><span class="n">ESP_CMD_TI</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_MSGOUT_DONE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_MSGOUT_DONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_invalidate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_DC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">FASHME</span><span class="p">)</span>
				<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_MSGIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_BSERV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS2</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">ESP_STAT2_FEMPTY</span><span class="p">))</span>
					<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">ESP100</span><span class="p">)</span>
					<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_FDONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_FDATA</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in</span><span class="p">[</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">esp_log_msgin</span><span class="p">(</span><span class="s">&quot;ESP: Got msgin byte %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp_msgin_process</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_in_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
				<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>

			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_MOK</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">ESP_EVENT_FREE_BUS</span><span class="p">)</span>
				<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: MSGIN neither BSERV not FDON, resetting&quot;</span><span class="p">);</span>
			<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_CMD_START</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_ptr</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span>
			<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_FLUSH</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_dma_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">command_block_dma</span><span class="p">,</span>
				       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cmd_bytes_left</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">ESP_CMD_DMA</span> <span class="o">|</span> <span class="n">ESP_CMD_TI</span><span class="p">);</span>
		<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CMD_DONE</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESP_EVENT_CMD_DONE</span>:
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">dma_invalidate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_BSERV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">esp_event</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_EVENT_CHECK_PHASE</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESP_EVENT_RESET</span>:
		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: Unexpected event %x, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_reset_cleanup_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">esp_unmap_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">esp_free_lun_tag</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_CMD_FLAG_AUTOSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap_single</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">,</span>
				       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">sense_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">esp_put_ent</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_clear_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_tagged</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_reset_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">esp_put_ent</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span> <span class="o">==</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">)</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">esp_reset_cleanup_one</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Force renegotiation of sync/wide transfers.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_MAX_TARGET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">esp_config3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ESP_CONFIG3_EWIDE</span> <span class="o">|</span>
				     <span class="n">ESP_CONFIG3_FSCSI</span> <span class="o">|</span>
				     <span class="n">ESP_CONFIG3_FAST</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_TGT_WIDE</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span>
			<span class="n">__starget_for_each_device</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						  <span class="n">esp_clear_hold</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_FLAG_RESETTING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Runs under host-&gt;lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__esp_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">finish_reset</span><span class="p">,</span> <span class="n">intr_done</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phase</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_RESETTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">finish_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp_check_gross_error</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">finish_reset</span> <span class="o">=</span> <span class="n">esp_check_spur_intr</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">finish_reset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_SR</span><span class="p">)</span>
		<span class="n">finish_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">finish_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp_reset_cleanup</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">eh_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">eh_reset</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">eh_reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">&amp;</span> <span class="n">ESP_STAT_PMASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="n">FASHME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">ESP_DIP</span> <span class="o">&amp;&amp;</span> <span class="n">phase</span> <span class="o">!=</span> <span class="n">ESP_DOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">==</span> <span class="n">ESP_SELECT_NONE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">ESP_EVENT_STATUS</span> <span class="o">&amp;&amp;</span>
		     <span class="n">esp</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">ESP_EVENT_DATA_DONE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_RSEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_STATUS2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span> <span class="o">&amp;</span> <span class="n">ESP_STAT2_FEMPTY</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span> <span class="o">&amp;</span> <span class="n">ESP_STAT2_F1BYTE</span><span class="p">))</span>
				<span class="n">hme_read_fifo</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">esp_log_intr</span><span class="p">(</span><span class="s">&quot;ESP: intr sreg[%02x] seqreg[%02x] &quot;</span>
		     <span class="s">&quot;sreg2[%02x] ireg[%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">seqreg</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">sreg2</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">);</span>

	<span class="n">intr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESP_INTR_S</span> <span class="o">|</span> <span class="n">ESP_INTR_SATN</span> <span class="o">|</span> <span class="n">ESP_INTR_IC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESP: unexpected IREG %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_IC</span><span class="p">)</span>
			<span class="n">esp_dump_cmd_log</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

		<span class="n">esp_schedule_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_RSEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Some combination of FDONE, BSERV, DC.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">select_state</span> <span class="o">!=</span> <span class="n">ESP_SELECT_NONE</span><span class="p">)</span>
				<span class="n">intr_done</span> <span class="o">=</span> <span class="n">esp_finish_select</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">ESP_INTR_RSEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">)</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">esp_finish_select</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="n">intr_done</span> <span class="o">=</span> <span class="n">esp_reconnect</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">intr_done</span><span class="p">)</span>
		<span class="n">intr_done</span> <span class="o">=</span> <span class="n">esp_process_event</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">scsi_esp_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">__esp_interrupt</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_FLAG_QUICKIRQ_CHECK</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_QUICKIRQ_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_pending</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ESP_QUICKIRQ_LIMIT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_esp_intr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_get_revision</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">config1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESP_CONFIG1_PENABLE</span> <span class="o">|</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ESP_CONFIG2_SCSI2ENAB</span> <span class="o">|</span> <span class="n">ESP_CONFIG2_REGPARITY</span><span class="p">);</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_CFG2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ESP_CONFIG2_MAGIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ESP_CONFIG2_SCSI2ENAB</span> <span class="o">|</span> <span class="n">ESP_CONFIG2_REGPARITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If what we write to cfg2 does not come back, cfg2 is not</span>
<span class="cm">		 * implemented, therefore this must be a plain esp100.</span>
<span class="cm">		 */</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ESP100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp_set_all_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_CFG3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The cfg2 register is implemented, however</span>
<span class="cm">			 * cfg3 is not, must be esp100a.</span>
<span class="cm">			 */</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ESP100A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">esp_set_all_config3</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">prev_cfg3</span><span class="p">,</span> <span class="n">ESP_CFG3</span><span class="p">);</span>

			<span class="cm">/* All of cfg{1,2,3} implemented, must be one of</span>
<span class="cm">			 * the fas variants, figure out which one.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfact</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfact</span> <span class="o">&gt;</span> <span class="n">ESP_CCF_F5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">FAST</span><span class="p">;</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sync_defp</span> <span class="o">=</span> <span class="n">SYNC_DEFP_FAST</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">ESP236</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config2</span><span class="p">,</span> <span class="n">ESP_CFG2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_init_swstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">esp_cmd_pool</span><span class="p">);</span>

	<span class="cm">/* Start with a clear state, domain validation (via -&gt;slave_configure,</span>
<span class="cm">	 * spi_dv_device()) will attempt to enable SYNC, WIDE, and tagged</span>
<span class="cm">	 * commands.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESP_MAX_TARGET</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nego_goal_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nego_goal_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nego_goal_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nego_goal_tags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This places the ESP into a known state at boot time. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_bootup_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Reset the DMA */</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset_dma</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="cm">/* Reset the ESP */</span>
	<span class="n">esp_reset_esp</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="cm">/* Reset the SCSI bus, but tell ESP not to generate an irq */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ESP_CONFIG1_SRRDISAB</span><span class="p">;</span>
	<span class="n">esp_write8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ESP_CFG1</span><span class="p">);</span>

	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

	<span class="n">esp_write8</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">config1</span><span class="p">,</span> <span class="n">ESP_CFG1</span><span class="p">);</span>

	<span class="cm">/* Eat any bitrot in the chip and we are done... */</span>
	<span class="n">esp_read8</span><span class="p">(</span><span class="n">ESP_INTRPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_set_clock_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fhz</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ccf</span><span class="p">;</span>

	<span class="cm">/* This is getting messy but it has to be done correctly or else</span>
<span class="cm">	 * you get weird behavior all over the place.  We are trying to</span>
<span class="cm">	 * basically figure out three pieces of information.</span>
<span class="cm">	 *</span>
<span class="cm">	 * a) Clock Conversion Factor</span>
<span class="cm">	 *</span>
<span class="cm">	 *    This is a representation of the input crystal clock frequency</span>
<span class="cm">	 *    going into the ESP on this machine.  Any operation whose timing</span>
<span class="cm">	 *    is longer than 400ns depends on this value being correct.  For</span>
<span class="cm">	 *    example, you&#39;ll get blips for arbitration/selection during high</span>
<span class="cm">	 *    load or with multiple targets if this is not set correctly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * b) Selection Time-Out</span>
<span class="cm">	 *</span>
<span class="cm">	 *    The ESP isn&#39;t very bright and will arbitrate for the bus and try</span>
<span class="cm">	 *    to select a target forever if you let it.  This value tells the</span>
<span class="cm">	 *    ESP when it has taken too long to negotiate and that it should</span>
<span class="cm">	 *    interrupt the CPU so we can see what happened.  The value is</span>
<span class="cm">	 *    computed as follows (from NCR/Symbios chip docs).</span>
<span class="cm">	 *</span>
<span class="cm">	 *          (Time Out Period) *  (Input Clock)</span>
<span class="cm">	 *    STO = ----------------------------------</span>
<span class="cm">	 *          (8192) * (Clock Conversion Factor)</span>
<span class="cm">	 *</span>
<span class="cm">	 *    We use a time out period of 250ms (ESP_BUS_TIMEOUT).</span>
<span class="cm">	 *</span>
<span class="cm">	 * c) Imperical constants for synchronous offset and transfer period</span>
<span class="cm">         *    register values</span>
<span class="cm">	 *</span>
<span class="cm">	 *    This entails the smallest and largest sync period we could ever</span>
<span class="cm">	 *    handle on this ESP.</span>
<span class="cm">	 */</span>
	<span class="n">fhz</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfreq</span><span class="p">;</span>

	<span class="n">ccf</span> <span class="o">=</span> <span class="p">((</span><span class="n">fhz</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ccf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t find anything reasonable, just assume 20MHZ.</span>
<span class="cm">	 * This is the clock frequency of the older sun4c&#39;s where I&#39;ve</span>
<span class="cm">	 * been unable to find the clock-frequency PROM property.  All</span>
<span class="cm">	 * other machines provide useful values it seems.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fhz</span> <span class="o">&lt;=</span> <span class="mi">5000000</span> <span class="o">||</span> <span class="n">ccf</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ccf</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fhz</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
		<span class="n">ccf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfact</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccf</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ccf</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfreq</span> <span class="o">=</span> <span class="n">fhz</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span> <span class="o">=</span> <span class="n">ESP_HZ_TO_CYCLE</span><span class="p">(</span><span class="n">fhz</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">ctick</span> <span class="o">=</span> <span class="n">ESP_TICK</span><span class="p">(</span><span class="n">ccf</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">ccycle</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">neg_defp</span> <span class="o">=</span> <span class="n">ESP_NEG_DEFP</span><span class="p">(</span><span class="n">fhz</span><span class="p">,</span> <span class="n">ccf</span><span class="p">);</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">sync_defp</span> <span class="o">=</span> <span class="n">SYNC_DEFP_SLOW</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esp_chip_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ESP100&quot;</span><span class="p">,</span>
	<span class="s">&quot;ESP100A&quot;</span><span class="p">,</span>
	<span class="s">&quot;ESP236&quot;</span><span class="p">,</span>
	<span class="s">&quot;FAS236&quot;</span><span class="p">,</span>
	<span class="s">&quot;FAS100A&quot;</span><span class="p">,</span>
	<span class="s">&quot;FAST&quot;</span><span class="p">,</span>
	<span class="s">&quot;FASHME&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">esp_transport_template</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">scsi_esp_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">esp_transport_template</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">ESP_MAX_LUN</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">esp_set_clock_params</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="n">esp_get_revision</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="n">esp_init_swstate</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="n">esp_bootup_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;esp%u, regs[%1p:%1p] irq[%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">dma_regs</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;esp%u is a %s, %u MHz (ccf=%u), SCSI ID %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">esp_chip_names</span><span class="p">[</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">],</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfreq</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">cfact</span><span class="p">,</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">);</span>

	<span class="cm">/* Let the SCSI bus reset settle. */</span>
	<span class="n">ssleep</span><span class="p">(</span><span class="n">esp_bus_reset_settle</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">++</span><span class="p">;</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_esp_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">scsi_esp_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_esp_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>

	<span class="n">spi_min_period</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">;</span>
	<span class="n">spi_max_offset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_WIDE_CAPABLE</span><span class="p">)</span>
		<span class="n">spi_max_width</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spi_max_width</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">goal_tags</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">;</span>

	<span class="n">goal_tags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX make this configurable somehow XXX */</span>
		<span class="n">goal_tags</span> <span class="o">=</span> <span class="n">ESP_DEFAULT_TAGS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">goal_tags</span> <span class="o">&gt;</span> <span class="n">ESP_MAX_TAG</span><span class="p">)</span>
			<span class="n">goal_tags</span> <span class="o">=</span> <span class="n">ESP_MAX_TAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">goal_tags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">)</span>
		<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">goal_tags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">);</span>
		<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spi_initial_dv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">))</span>
		<span class="n">spi_dv_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp_lun_data</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_eh_abort_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_cmd_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">eh_done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* XXX This helps a lot with debugging but might be a bit</span>
<span class="cm">	 * XXX much for the final driver.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Aborting command [%p:%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Current command [%p:%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Queued command [%p:%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;esp%d: Active command [%p:%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">esp_dump_cmd_log</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">queued_cmds</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ent</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Easiest case, we didn&#39;t even issue the command</span>
<span class="cm">		 * yet so it is trivial to abort.</span>
<span class="cm">		 */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="n">esp_put_ent</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out_success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh_done</span><span class="p">);</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">esp</span><span class="o">-&gt;</span><span class="n">active_cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span> <span class="o">&amp;&amp;</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Command is the currently active command on</span>
<span class="cm">		 * the bus.  If we already have an output message</span>
<span class="cm">		 * pending, no dice.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_failure</span><span class="p">;</span>

		<span class="cm">/* Send out an abort, encouraging the target to</span>
<span class="cm">		 * go to MSGOUT phase by asserting ATN.</span>
<span class="cm">		 */</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT_TASK_SET</span><span class="p">;</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">msg_out_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eh_done</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eh_done</span><span class="p">;</span>

		<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_SATN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The command is disconnected.  This is not easy to</span>
<span class="cm">		 * abort.  For now we fail and let the scsi error</span>
<span class="cm">		 * handling layer go try a scsi bus reset or host</span>
<span class="cm">		 * reset.</span>
<span class="cm">		 *</span>
<span class="cm">		 * What we could do is put together a scsi command</span>
<span class="cm">		 * solely for the purpose of sending an abort message</span>
<span class="cm">		 * to the target.  Coming up with all the code to</span>
<span class="cm">		 * cook up scsi commands, special case them everywhere,</span>
<span class="cm">		 * etc. is for questionable gain and it would be better</span>
<span class="cm">		 * if the generic scsi error handling layer could do at</span>
<span class="cm">		 * least some of that for us.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Anyways this is an area for potential future improvement</span>
<span class="cm">		 * in this driver.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">out_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh_done</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eh_done</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">out_success:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">out_failure:</span>
	<span class="cm">/* XXX This might be a good location to set ESP_TGT_BROKEN</span>
<span class="cm">	 * XXX since we know which target/lun in particular is</span>
<span class="cm">	 * XXX causing trouble.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_eh_bus_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">eh_reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh_reset</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">eh_reset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eh_reset</span><span class="p">;</span>

	<span class="cm">/* XXX This is too simple... We should add lots of</span>
<span class="cm">	 * XXX checks here so that if we find that the chip is</span>
<span class="cm">	 * XXX very wedged we return failure immediately so</span>
<span class="cm">	 * XXX that we can perform a full chip reset.</span>
<span class="cm">	 */</span>
	<span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_FLAG_RESETTING</span><span class="p">;</span>
	<span class="n">scsi_esp_cmd</span><span class="p">(</span><span class="n">esp</span><span class="p">,</span> <span class="n">ESP_CMD_RS</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="n">esp_bus_reset_settle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh_reset</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">esp</span><span class="o">-&gt;</span><span class="n">eh_reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* All bets are off, reset the entire device.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">esp_eh_host_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">esp_bootup_reset</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="n">esp_reset_cleanup</span><span class="p">(</span><span class="n">esp</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="n">esp_bus_reset_settle</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">esp_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;esp&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">scsi_esp_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;esp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">esp_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">esp_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>		<span class="o">=</span> <span class="n">esp_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>		<span class="o">=</span> <span class="n">esp_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">esp_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">esp_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>		<span class="o">=</span> <span class="n">esp_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">esp_eh_abort_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">esp_eh_bus_reset_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">esp_eh_host_reset_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_settle_delay</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_esp_template</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_get_signalling</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">spi_signal_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_DIFFERENTIAL</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">SPI_SIGNAL_HVD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">SPI_SIGNAL_SE</span><span class="p">;</span>

	<span class="n">spi_signalling</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_set_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ESP_FLAG_DISABLE_SYNC</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_set_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">esp_set_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp</span> <span class="o">*</span><span class="n">esp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">esp_target_data</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">esp</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nego_goal_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ESP_TGT_CHECK_NEGO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_function_template</span> <span class="n">esp_transport_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_offset</span>		<span class="o">=</span> <span class="n">esp_set_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_offset</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_period</span>		<span class="o">=</span> <span class="n">esp_set_period</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_period</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_width</span>		<span class="o">=</span> <span class="n">esp_set_width</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_width</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_signalling</span>		<span class="o">=</span> <span class="n">esp_get_signalling</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">esp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_pointer</span><span class="p">)</span> <span class="o">&lt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">esp_cmd_priv</span><span class="p">));</span>

	<span class="n">esp_transport_template</span> <span class="o">=</span> <span class="n">spi_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esp_transport_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esp_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">esp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_release_transport</span><span class="p">(</span><span class="n">esp_transport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ESP SCSI driver core&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller (davem@davemloft.net)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">esp_bus_reset_settle</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">esp_bus_reset_settle</span><span class="p">,</span>
		 <span class="s">&quot;ESP scsi bus reset delay in seconds&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">esp_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">esp_debug</span><span class="p">,</span>
<span class="s">&quot;ESP bitmapped debugging message enable value:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000001	Log interrupt events</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000002	Log scsi commands</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000004	Log resets</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000008	Log message in events</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000010	Log message out events</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000020	Log command completion</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000040	Log disconnects</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000080	Log data start</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000100	Log data done</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000200	Log reconnects</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	0x00000400	Log auto-sense data</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">esp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">esp_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
