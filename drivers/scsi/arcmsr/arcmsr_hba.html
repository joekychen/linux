<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › arcmsr › arcmsr_hba.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>arcmsr_hba.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">*******************************************************************************</span>
<span class="cm">**        O.S   : Linux</span>
<span class="cm">**   FILE NAME  : arcmsr_hba.c</span>
<span class="cm">**        BY    : Nick Cheng</span>
<span class="cm">**   Description: SCSI RAID Device Driver for</span>
<span class="cm">**                ARECA RAID Host adapter</span>
<span class="cm">*******************************************************************************</span>
<span class="cm">** Copyright (C) 2002 - 2005, Areca Technology Corporation All rights reserved</span>
<span class="cm">**</span>
<span class="cm">**     Web site: www.areca.com.tw</span>
<span class="cm">**       E-mail: support@areca.com.tw</span>
<span class="cm">**</span>
<span class="cm">** This program is free software; you can redistribute it and/or modify</span>
<span class="cm">** it under the terms of the GNU General Public License version 2 as</span>
<span class="cm">** published by the Free Software Foundation.</span>
<span class="cm">** This program is distributed in the hope that it will be useful,</span>
<span class="cm">** but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">** GNU General Public License for more details.</span>
<span class="cm">*******************************************************************************</span>
<span class="cm">** Redistribution and use in source and binary forms, with or without</span>
<span class="cm">** modification, are permitted provided that the following conditions</span>
<span class="cm">** are met:</span>
<span class="cm">** 1. Redistributions of source code must retain the above copyright</span>
<span class="cm">**    notice, this list of conditions and the following disclaimer.</span>
<span class="cm">** 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm">**    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm">**    documentation and/or other materials provided with the distribution.</span>
<span class="cm">** 3. The name of the author may not be used to endorse or promote products</span>
<span class="cm">**    derived from this software without specific prior written permission.</span>
<span class="cm">**</span>
<span class="cm">** THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="cm">** IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm">** OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<span class="cm">** IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm">** INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES(INCLUDING,BUT</span>
<span class="cm">** NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm">** DATA, OR PROFITS; OR BUSINESS INTERRUPTION)HOWEVER CAUSED AND ON ANY</span>
<span class="cm">** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm">** (INCLUDING NEGLIGENCE OR OTHERWISE)ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm">** THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm">*******************************************************************************</span>
<span class="cm">** For history of changes, see Documentation/scsi/ChangeLog.arcmsr</span>
<span class="cm">**     Firmware Specification, see Documentation/scsi/arcmsr_spec.txt</span>
<span class="cm">*******************************************************************************</span>
<span class="cm">*/</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &quot;arcmsr.h&quot;</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nick Cheng &lt;support@areca.com.tw&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ARECA (ARC11xx/12xx/16xx/1880) SATA/SAS RAID Host Bus Adapter&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">ARCMSR_DRIVER_VERSION</span><span class="p">);</span>

<span class="cp">#define	ARCMSR_SLEEPTIME	10</span>
<span class="cp">#define	ARCMSR_RETRYCOUNT	12</span>

<span class="n">wait_queue_head_t</span> <span class="n">wait_q</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_iop_message_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_iop_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_queue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcmsr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_iop_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_free_ccb_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_flush_hba_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_flush_hbb_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_request_device_map</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pacb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_request_hba_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_request_hbb_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_request_hbc_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_message_isr_bh_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">arcmsr_get_firmware_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_start_adapter_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_hbc_message_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">arcmsr_hardware_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arcmsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">arcmsr_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_adjust_disk_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">queue_depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">ARCMSR_MAX_CMD_PERLUN</span><span class="p">)</span>
		<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_CMD_PERLUN</span><span class="p">;</span>
	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">arcmsr_scsi_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;ARCMSR ARECA SATA/SAS RAID Controller&quot;</span>
				<span class="n">ARCMSR_DRIVER_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">arcmsr_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">arcmsr_queue_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">arcmsr_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">arcmsr_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">arcmsr_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">arcmsr_adjust_disk_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="n">ARCMSR_SCSI_INITIATOR_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>	        	<span class="o">=</span> <span class="n">ARCMSR_DEFAULT_SG_ENTRIES</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">max_sectors</span>    	    	<span class="o">=</span> <span class="n">ARCMSR_MAX_XFER_SECTORS_C</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="n">ARCMSR_MAX_CMD_PERLUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">arcmsr_host_attrs</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">arcmsr_device_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1110</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1120</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1130</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1160</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1170</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1200</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1201</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1202</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1210</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1220</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1230</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1260</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1270</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1280</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1380</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1381</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1680</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1681</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ARECA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ARECA_1880</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">arcmsr_device_id_table</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">arcmsr_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;arcmsr&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>			<span class="o">=</span> <span class="n">arcmsr_device_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">arcmsr_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">arcmsr_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>		<span class="o">=</span> <span class="n">arcmsr_shutdown</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">****************************************************************************</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_free_hbb_mu</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:<span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_B</span><span class="p">),</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle_hbb_mu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">arcmsr_remap_pciregion</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:<span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: memory mapping region fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:<span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_base0</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_base1</span><span class="p">;</span>
		<span class="n">mem_base0</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_base0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: memory mapping region fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mem_base1</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_base1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_base0</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: memory mapping region fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span> <span class="o">=</span> <span class="n">mem_base0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base1</span> <span class="o">=</span> <span class="n">mem_base1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:<span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: memory mapping region fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE_DOORBELL_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span><span class="cm">/*clear interrupt*/</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_unmap_pciregion</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:<span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:<span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:<span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">arcmsr_do_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">handle_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">handle_state</span> <span class="o">=</span> <span class="n">arcmsr_interrupt</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">handle_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">geom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">,</span> <span class="n">total_capacity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span><span class="cm">/* return copy of block device&#39;s partition table */</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">scsi_bios_ptable</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_partsize</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">total_capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">total_capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">total_capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_define_adapter_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1880</span>: <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ACB_ADAPTER_TYPE_C</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1201</span>: <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ACB_ADAPTER_TYPE_B</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">=</span> <span class="n">ACB_ADAPTER_TYPE_A</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">ARCMSR_MU_OUTBOUND_MESSAGE0_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MU_OUTBOUND_MESSAGE0_INT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* max 20 seconds */</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">ARCMSR_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_INT_CLEAR_PATTERN</span><span class="p">,</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_END_OF_INTERRUPT</span><span class="p">,</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* max 20 seconds */</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE_DOORBELL_CLEAR</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span> <span class="cm">/*clear interrupt*/</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* max 20 seconds */</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_flush_hba_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_FLUSH_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">retry_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;flush adapter cache&#39; \</span>
<span class="s">			timeout, retry count down = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_flush_hbb_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_FLUSH_CACHE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">retry_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;flush adapter cache&#39; \</span>
<span class="s">			timeout,retry count down = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_flush_hbc_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span><span class="cm">/* enlarge wait flush adapter cache time: 10 minute */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_FLUSH_CACHE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="n">pACB</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retry_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;flush adapter cache&#39; \</span>
<span class="s">			timeout,retry count down = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="n">arcmsr_flush_hba_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="n">arcmsr_flush_hbb_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="n">arcmsr_flush_hbc_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_alloc_ccb_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dma_coherent</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb_tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cdb_phyaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">roundup_ccbsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_xfer_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_sg_entrys</span><span class="p">;</span>
	<span class="kt">uint32_t</span>  <span class="n">firm_config_version</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETLUN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GONE</span><span class="p">;</span>

	<span class="n">max_xfer_len</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_XFER_LEN</span><span class="p">;</span>
	<span class="n">max_sg_entrys</span> <span class="o">=</span> <span class="n">ARCMSR_DEFAULT_SG_ENTRIES</span><span class="p">;</span>
	<span class="n">firm_config_version</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_cfg_version</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">firm_config_version</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">){</span>
		<span class="n">max_xfer_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">ARCMSR_CDB_SG_PAGE_LENGTH</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">firm_config_version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span><span class="cm">/* max 4M byte */</span>
		<span class="n">max_sg_entrys</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_xfer_len</span><span class="o">/</span><span class="mi">4096</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">max_xfer_len</span><span class="o">/</span><span class="mi">512</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">max_sg_entrys</span><span class="p">;</span>
	<span class="n">roundup_ccbsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_sg_entrys</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SG64ENTRY</span><span class="p">),</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">uncache_size</span> <span class="o">=</span> <span class="n">roundup_ccbsize</span> <span class="o">*</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span>
	<span class="n">dma_coherent</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">uncache_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_coherent_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dma_coherent</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: dma_alloc_coherent got error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent</span> <span class="o">=</span> <span class="n">dma_coherent</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle</span> <span class="o">=</span> <span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dma_coherent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">uncache_size</span><span class="p">);</span>
	<span class="n">ccb_tmp</span> <span class="o">=</span> <span class="n">dma_coherent</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_coherent</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">cdb_phyaddr</span> <span class="o">=</span> <span class="n">dma_coherent_handle</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">ccb_tmp</span><span class="o">-&gt;</span><span class="n">cdb_phyaddr_pattern</span> <span class="o">=</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">==</span> <span class="n">ACB_ADAPTER_TYPE_C</span><span class="p">)</span> <span class="o">?</span> <span class="n">cdb_phyaddr</span> <span class="o">:</span> <span class="p">(</span><span class="n">cdb_phyaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pccb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccb_tmp</span><span class="p">;</span>
		<span class="n">ccb_tmp</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">=</span> <span class="n">acb</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccb_tmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccb_tmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccb_free_list</span><span class="p">);</span>
		<span class="n">ccb_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ccb_tmp</span> <span class="o">+</span> <span class="n">roundup_ccbsize</span><span class="p">);</span>
		<span class="n">dma_coherent_handle</span> <span class="o">=</span> <span class="n">dma_coherent_handle</span> <span class="o">+</span> <span class="n">roundup_ccbsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_message_isr_bh_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span><span class="p">,</span> <span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>

			<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">device_map</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devicemap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">diff</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">ARCMSR_SIGNATURE_GET_CONFIG</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETID</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">acb_dev_map</span><span class="p">)</span><span class="o">^</span><span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
						<span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
						<span class="n">temp</span> <span class="o">=*</span><span class="n">acb_dev_map</span><span class="p">;</span>
						<span class="k">for</span><span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETLUN</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	
								<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
							<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">psdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
									<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
									<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span>
							<span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">diff</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">devicemap</span><span class="o">++</span><span class="p">;</span>
					<span class="n">acb_dev_map</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">device_map</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devicemap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">diff</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">ARCMSR_SIGNATURE_GET_CONFIG</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETID</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">acb_dev_map</span><span class="p">)</span><span class="o">^</span><span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
						<span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
						<span class="n">temp</span> <span class="o">=*</span><span class="n">acb_dev_map</span><span class="p">;</span>
						<span class="k">for</span><span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETLUN</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	
								<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
							<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">psdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
									<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
									<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span>
							<span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">diff</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">devicemap</span><span class="o">++</span><span class="p">;</span>
					<span class="n">acb_dev_map</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">device_map</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devicemap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">psdev</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">diff</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">ARCMSR_SIGNATURE_GET_CONFIG</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">acb_dev_map</span><span class="p">)</span><span class="o">^</span><span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
						<span class="o">*</span><span class="n">acb_dev_map</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devicemap</span><span class="p">);</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">acb_dev_map</span><span class="p">;</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_TARGETLUN</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
							<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">psdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">psdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
									<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">psdev</span><span class="p">);</span>
								<span class="p">}</span>
							<span class="p">}</span>
							<span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">diff</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">devicemap</span><span class="o">++</span><span class="p">;</span>
					<span class="n">acb_dev_map</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bus</span><span class="p">,</span><span class="n">dev_fun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arcmsr_scsi_host_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">){</span>
    		<span class="k">goto</span> <span class="n">pci_disable_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;scsi%d: No suitable DMA mask available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">scsi_host_release</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_q</span><span class="p">);</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">dev_fun</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span><span class="p">));</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_TARGETLUN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_TARGETID</span><span class="p">;</span>		<span class="cm">/*16:8*/</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	 			<span class="cm">/*this is issue of 64bit LBA ,over 2T byte*/</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span>	<span class="cm">/* max simultaneous cmds */</span>		
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">ARCMSR_MAX_CMD_PERLUN</span><span class="p">;</span>	    
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">ARCMSR_SCSI_INITIATOR_ID</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">dev_fun</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;arcmsr&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">scsi_host_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eh_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span> <span class="o">|</span>
			<span class="n">ACB_F_MESSAGE_RQBUFFER_CLEARED</span> <span class="o">|</span>
			<span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_SCSISTOPADAPTER</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccb_free_list</span><span class="p">);</span>
	<span class="n">arcmsr_define_adapter_type</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">arcmsr_remap_pciregion</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">pci_release_regs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">arcmsr_get_firmware_spec</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">unmap_pci_region</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">arcmsr_alloc_ccb_pool</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">free_hbb_mu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arcmsr_iop_init</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">RAID_controller_stop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">arcmsr_do_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;arcmsr&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">scsi_host_remove</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">,</span> <span class="n">arcmsr_message_isr_bh_fn</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">acb</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arcmsr_request_device_map</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">arcmsr_alloc_sysfs_attr</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_sysfs</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free_sysfs:</span>
<span class="nl">scsi_host_remove:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">RAID_controller_stop:</span>
	<span class="n">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_free_ccb_pool</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="nl">free_hbb_mu:</span>
	<span class="n">arcmsr_free_hbb_mu</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="nl">unmap_pci_region:</span>
	<span class="n">arcmsr_unmap_pciregion</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="nl">pci_release_regs:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">scsi_host_release:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">pci_disable_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_abort_hba_allcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_ABORT_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;abort all outstanding command&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_abort_hbb_allcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_ABORT_CMD</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;abort all outstanding command&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_abort_hbc_allcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_ABORT_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="n">pACB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;abort all outstanding command&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_abort_allcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">rtnval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="n">rtnval</span> <span class="o">=</span> <span class="n">arcmsr_abort_hba_allcmd</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="n">rtnval</span> <span class="o">=</span> <span class="n">arcmsr_abort_hbb_allcmd</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="n">rtnval</span> <span class="o">=</span> <span class="n">arcmsr_abort_hbc_allcmd</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtnval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">arcmsr_hbb_enable_driver_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pacb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">pacb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_START_DRIVER_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">pacb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr%d: can&#39;t set driver mode. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pacb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
    	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_pci_unmap_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_ccb_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">acb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">);</span>
	<span class="n">arcmsr_pci_unmap_dma</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">=</span> <span class="n">ARCMSR_CCB_DONE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccb_free_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_report_sense_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="n">sensebuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="p">)</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
	<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensebuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sense_data_length</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SENSE_DATA</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span>
			<span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SENSE_DATA</span><span class="p">)</span> <span class="o">:</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sensebuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sensebuffer</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arcmsr_cdb</span><span class="p">.</span><span class="n">SenseData</span><span class="p">,</span> <span class="n">sense_data_length</span><span class="p">);</span>
		<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">SCSI_SENSE_CURRENT_ERRORS</span><span class="p">;</span>
		<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">Valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">orig_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>	
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span> : <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="n">orig_mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intmask</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">orig_mask</span><span class="o">|</span><span class="n">ARCMSR_MU_OUTBOUND_ALL_INTMASKENABLE</span><span class="p">,</span> \
						<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intmask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span> : <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="n">orig_mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell_mask</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell_mask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:<span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="cm">/* disable all outbound interrupt */</span>
		<span class="n">orig_mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">);</span> <span class="cm">/* disable outbound message0 int */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">orig_mask</span><span class="o">|</span><span class="n">ARCMSR_HBCMU_ALL_INTMASKENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">orig_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_report_ccb_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> 
			<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">ARECA_RAID_GONE</span><span class="p">)</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GOOD</span><span class="p">;</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arcmsr_cdb</span><span class="p">.</span><span class="n">DeviceStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ARCMSR_DEV_SELECT_TIMEOUT</span>: <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GONE</span><span class="p">;</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ARCMSR_DEV_ABORTED</span>:

		<span class="k">case</span> <span class="n">ARCMSR_DEV_INIT_FAIL</span>: <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GONE</span><span class="p">;</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ARCMSR_DEV_CHECK_CONDITION</span>: <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GOOD</span><span class="p">;</span>
			<span class="n">arcmsr_report_sense_info</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
				<span class="s">&quot;arcmsr%d: scsi id = %d lun = %d isr get command error done, \</span>
<span class="s">				but got unknown DeviceStatus = 0x%x </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
				<span class="p">,</span> <span class="n">id</span>
				<span class="p">,</span> <span class="n">lun</span>
				<span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arcmsr_cdb</span><span class="p">.</span><span class="n">DeviceStatus</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARECA_RAID_GONE</span><span class="p">;</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_drain_donequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">,</span> <span class="n">bool</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">!=</span> <span class="n">acb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">!=</span> <span class="n">ARCMSR_CCB_START</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">abortcmd</span> <span class="o">=</span> <span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abortcmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">abortcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
				<span class="n">lun</span> <span class="o">=</span> <span class="n">abortcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>				
				<span class="n">abortcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">pCCB</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: pCCB =&#39;0x%p&#39; isr got aborted command </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: isr get an illegal ccb command \</span>
<span class="s">				done acb = &#39;0x%p&#39;&quot;</span>
				<span class="s">&quot;ccb = &#39;0x%p&#39; ccbacb = &#39;0x%p&#39; startdone = 0x%x&quot;</span>
				<span class="s">&quot; ccboutstandingcount = %d </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
				<span class="p">,</span> <span class="n">acb</span>
				<span class="p">,</span> <span class="n">pCCB</span>
				<span class="p">,</span> <span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">acb</span>
				<span class="p">,</span> <span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">startdone</span>
				<span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">));</span>
		  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arcmsr_report_ccb_state</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_done4abort_postqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">pARCMSR_CDB</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">outbound_intstatus</span><span class="p">;</span>
		<span class="n">outbound_intstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span><span class="p">;</span>
		<span class="cm">/*clear and abort all outbound posted Q*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">outbound_intstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">);</span><span class="cm">/*clear interrupt*/</span>
		<span class="k">while</span><span class="p">(((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_queueport</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_OUTSTANDING_CMD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pARCMSR_CDB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
			<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pARCMSR_CDB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="cm">/*clear all outbound posted Q*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DOORBELL_INT_CLEAR_PATTERN</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span> <span class="cm">/* clear doorbell interrupt */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_HBB_POSTQUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">pARCMSR_CDB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span><span class="o">+</span><span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
				<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pARCMSR_CDB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">post_qbuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">postq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="k">struct</span>  <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">pARCMSR_CDB</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">,</span> <span class="n">ccb_cdb_phy</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_OUTBOUND_POSTQUEUE_ISR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_OUTSTANDING_CMD</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*need to do*/</span>
			<span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_queueport_low</span><span class="p">);</span>
			<span class="n">ccb_cdb_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">);</span>
			<span class="n">pARCMSR_CDB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span>  <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span><span class="o">+</span><span class="n">ccb_cdb_phy</span><span class="p">);</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
			<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pARCMSR_CDB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arcmsr_free_sysfs_attr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">);</span>
	<span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>	
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_SCSISTOPADAPTER</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">poll_count</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_OUTSTANDING_CMD</span><span class="p">;</span> <span class="n">poll_count</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">arcmsr_interrupt</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span><span class="cm">/* FIXME: need spinlock */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">arcmsr_abort_allcmd</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="n">arcmsr_done4abort_postqueue</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pccb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_START</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">=</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">;</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_free_ccb_pool</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_free_hbb_mu</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_unmap_pciregion</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">);</span>
	<span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
	<span class="n">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arcmsr_pci_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arcmsr_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">arcmsr_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">arcmsr_module_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">intmask_org</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">intmask_org</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ARCMSR_MU_OUTBOUND_POSTQUEUE_INTMASKENABLE</span> <span class="o">|</span>
			     <span class="n">ARCMSR_MU_OUTBOUND_DOORBELL_INTMASKENABLE</span><span class="o">|</span>
			     <span class="n">ARCMSR_MU_OUTBOUND_MESSAGE0_INTMASKENABLE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intmask</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">intmask_org</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">intmask_org</span> <span class="o">|</span> <span class="p">(</span><span class="n">ARCMSR_IOP2DRV_DATA_WRITE_OK</span> <span class="o">|</span>
			<span class="n">ARCMSR_IOP2DRV_DATA_READ_OK</span> <span class="o">|</span>
			<span class="n">ARCMSR_IOP2DRV_CDB_DONE</span> <span class="o">|</span>
			<span class="n">ARCMSR_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell_mask</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">intmask_org</span> <span class="o">|</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_UTILITY_A_ISR_MASK</span> <span class="o">|</span> <span class="n">ARCMSR_HBCMU_OUTBOUND_DOORBELL_ISR_MASK</span><span class="o">|</span><span class="n">ARCMSR_HBCMU_OUTBOUND_POSTQUEUE_ISR_MASK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">intmask_org</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">intmask_org</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_build_ccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="kt">int8_t</span> <span class="o">*</span><span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">address_lo</span><span class="p">,</span> <span class="n">address_hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arccdbsize</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">pcmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span><span class="p">));</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">LUN</span> <span class="o">=</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&gt;</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">||</span> <span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">pcmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the physical address of the current data pointer */</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">address_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)));</span>
		<span class="n">address_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr_hi32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">address_hi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">SG32ENTRY</span> <span class="o">*</span><span class="n">pdma_sg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG32ENTRY</span> <span class="o">*</span><span class="p">)</span><span class="n">psge</span><span class="p">;</span>

			<span class="n">pdma_sg</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">address_lo</span><span class="p">;</span>
			<span class="n">pdma_sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">psge</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG32ENTRY</span><span class="p">);</span>
			<span class="n">arccdbsize</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG32ENTRY</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">SG64ENTRY</span> <span class="o">*</span><span class="n">pdma_sg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG64ENTRY</span> <span class="o">*</span><span class="p">)</span><span class="n">psge</span><span class="p">;</span>

			<span class="n">pdma_sg</span><span class="o">-&gt;</span><span class="n">addresshigh</span> <span class="o">=</span> <span class="n">address_hi</span><span class="p">;</span>
			<span class="n">pdma_sg</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">address_lo</span><span class="p">;</span>
			<span class="n">pdma_sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">|</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IS_SG64_ADDR</span><span class="p">);</span>
			<span class="n">psge</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG64ENTRY</span><span class="p">);</span>
			<span class="n">arccdbsize</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">SG64ENTRY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">sgcount</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">nseg</span><span class="p">;</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
	<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">msgPages</span> <span class="o">=</span> <span class="n">arccdbsize</span><span class="o">/</span><span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">arccdbsize</span> <span class="o">%</span> <span class="mh">0x100</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">arccdbsize</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">ARCMSR_CDB_FLAG_SGL_BSIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">ARCMSR_CDB_FLAG_WRITE</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arc_cdb_size</span> <span class="o">=</span> <span class="n">arccdbsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_post_ccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cdb_phyaddr_pattern</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">cdb_phyaddr_pattern</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">=</span> <span class="n">ARCMSR_CCB_START</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CDB_FLAG_SGL_BSIZE</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_pattern</span> <span class="o">|</span> <span class="n">ARCMSR_CCBPOST_FLAG_SGL_BSIZE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_queueport</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_pattern</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_queueport</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">ending_index</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">postq_index</span><span class="p">;</span>

		<span class="n">ending_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ARCMSR_MAX_HBB_POSTQUEUE</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">post_qbuffer</span><span class="p">[</span><span class="n">ending_index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_cdb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CDB_FLAG_SGL_BSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_pattern</span> <span class="o">|</span> <span class="n">ARCMSR_CCBPOST_FLAG_SGL_BSIZE</span><span class="p">,</span>\
						 <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">post_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_pattern</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">post_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_HBB_POSTQUEUE</span><span class="p">;</span><span class="cm">/*if last index number set it to 0 */</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">postq_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_CDB_POSTED</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">ccb_post_stamp</span><span class="p">,</span> <span class="n">arc_cdb_size</span><span class="p">;</span>

		<span class="n">arc_cdb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arc_cdb_size</span> <span class="o">&gt;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x300</span> <span class="o">:</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">arc_cdb_size</span><span class="p">;</span>
		<span class="n">ccb_post_stamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb_phyaddr_pattern</span> <span class="o">|</span> <span class="p">((</span><span class="n">arc_cdb_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">cdb_phyaddr_hi32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">cdb_phyaddr_hi32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_queueport_high</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ccb_post_stamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_queueport_low</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ccb_post_stamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_queueport_low</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_stop_hba_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_STOP_BGRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;stop adapter background rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_stop_hbb_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_STOP_BGRB</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;stop adapter background rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_stop_hbc_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_STOP_BGRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="n">pACB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
			<span class="s">&quot;arcmsr%d: wait &#39;stop adapter background rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="n">arcmsr_stop_hba_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="n">arcmsr_stop_hbb_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="n">arcmsr_stop_hbc_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_free_ccb_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">uncache_size</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">arcmsr_iop_message_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_DRIVER_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_DATA_READ_OK</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_iop_message_wrote</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		** push inbound doorbell tell iop, driver data write ok</span>
<span class="cm">		** and wait reply on next hwinterrupt for next Qbuffer post</span>
<span class="cm">		*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_DRIVER_DATA_WRITE_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		** push inbound doorbell tell iop, driver data write ok</span>
<span class="cm">		** and wait reply on next hwinterrupt for next Qbuffer post</span>
<span class="cm">		*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_DATA_WRITE_OK</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		** push inbound doorbell tell iop, driver data write ok</span>
<span class="cm">		** and wait reply on next hwinterrupt for next Qbuffer post</span>
<span class="cm">		*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_DATA_WRITE_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">arcmsr_get_iop_rqbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">qbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="n">qbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rbuffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="n">qbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rbuffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="n">qbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">message_rbuffer</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qbuffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">arcmsr_get_iop_wqbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pqbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="n">pqbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_wbuffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span>  <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="n">pqbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_wbuffer</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="n">pqbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_wbuffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pqbuffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_iop2drv_data_wrote_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_data</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">my_empty_len</span><span class="p">,</span> <span class="n">iop_len</span><span class="p">,</span> <span class="n">rqbuf_firstindex</span><span class="p">,</span> <span class="n">rqbuf_lastindex</span><span class="p">;</span>
	<span class="n">rqbuf_lastindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span><span class="p">;</span>
	<span class="n">rqbuf_firstindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span><span class="p">;</span>
	<span class="n">prbuffer</span> <span class="o">=</span> <span class="n">arcmsr_get_iop_rqbuffer</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">iop_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">prbuffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">iop_len</span> <span class="o">=</span> <span class="n">prbuffer</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">my_empty_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rqbuf_firstindex</span> <span class="o">-</span> <span class="n">rqbuf_lastindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ARCMSR_MAX_QBUFFER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">my_empty_len</span> <span class="o">&gt;=</span> <span class="n">iop_len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">iop_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pQbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuffer</span><span class="p">[</span><span class="n">rqbuf_lastindex</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="n">iop_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rqbuf_lastindex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rqbuf_lastindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
			<span class="n">iop_data</span><span class="o">++</span><span class="p">;</span>
			<span class="n">iop_len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span> <span class="o">=</span> <span class="n">rqbuf_lastindex</span><span class="p">;</span>
		<span class="n">arcmsr_iop_message_read</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_iop2drv_data_read_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">!=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pwbuffer</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_data</span><span class="p">;</span>
		<span class="kt">int32_t</span> <span class="n">allxfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">);</span>
		<span class="n">pwbuffer</span> <span class="o">=</span> <span class="n">arcmsr_get_iop_wqbuffer</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="n">iop_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">pwbuffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">!=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
							<span class="p">(</span><span class="n">allxfer_len</span> <span class="o">&lt;</span> <span class="mi">124</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pQbuffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuffer</span><span class="p">[</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">iop_data</span><span class="p">,</span> <span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
			<span class="n">iop_data</span><span class="o">++</span><span class="p">;</span>
			<span class="n">allxfer_len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pwbuffer</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">allxfer_len</span><span class="p">;</span>

		<span class="n">arcmsr_iop_message_wrote</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">==</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hba_doorbell_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_OUTBOUND_IOP331_DATA_WRITE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_wrote_handle</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_OUTBOUND_IOP331_DATA_READ_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_read_handle</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hbc_doorbell_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	*******************************************************************</span>
<span class="cm">	**  Maybe here we need to check wrqbuffer_lock is lock or not</span>
<span class="cm">	**  DOORBELL: din! don!</span>
<span class="cm">	**  check if there are any mail need to pack from firmware</span>
<span class="cm">	*******************************************************************</span>
<span class="cm">	*/</span>
	<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span><span class="cm">/*clear interrupt*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_DATA_WRITE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_wrote_handle</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_DATA_READ_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_read_handle</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_hbc_message_isr</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>    <span class="cm">/* messenger of &quot;driver to iop commands&quot; */</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hba_postqueue_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">pARCMSR_CDB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_queueport</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pARCMSR_CDB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
		<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pARCMSR_CDB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hbb_postqueue_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">pARCMSR_CDB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">pARCMSR_CDB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span><span class="o">+</span><span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
		<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pARCMSR_CDB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_HBB_POSTQUEUE</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hbc_postqueue_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">,</span> <span class="n">ccb_cdb_phy</span><span class="p">,</span> <span class="n">throttling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="cm">/* areca cdb command done */</span>
	<span class="cm">/* Use correct offset and size for syncing */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">host_int_status</span><span class="p">)</span> <span class="o">&amp;</span>
	<span class="n">ARCMSR_HBCMU_OUTBOUND_POSTQUEUE_ISR</span><span class="p">){</span>
	<span class="cm">/* check if command done with no error*/</span>
	<span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">outbound_queueport_low</span><span class="p">);</span>
	<span class="n">ccb_cdb_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">);</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
	<span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="n">ccb_cdb_phy</span><span class="p">);</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* check if command done with no error */</span>
	<span class="n">arcmsr_drain_donequeue</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">throttling</span> <span class="o">==</span> <span class="n">ARCMSR_HBC_ISR_THROTTLING_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_POSTQUEUE_THROTTLING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">throttling</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">**********************************************************************************</span>
<span class="cm">** Handle a message interrupt</span>
<span class="cm">**</span>
<span class="cm">** The only message interrupt we expect is in response to a query for the current adapter config.  </span>
<span class="cm">** We want this in order to compare the drivemap so that we can detect newly-attached drives.</span>
<span class="cm">**********************************************************************************</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hba_message_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="cm">/*clear interrupt and message state*/</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MU_OUTBOUND_MESSAGE0_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hbb_message_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>

	<span class="cm">/*clear interrupt and message state*/</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_INT_CLEAR_PATTERN</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">**********************************************************************************</span>
<span class="cm">** Handle a message interrupt</span>
<span class="cm">**</span>
<span class="cm">** The only message interrupt we expect is in response to a query for the</span>
<span class="cm">** current adapter config.</span>
<span class="cm">** We want this in order to compare the drivemap so that we can detect newly-attached drives.</span>
<span class="cm">**********************************************************************************</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hbc_message_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span>  <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="cm">/*clear interrupt and message state*/</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE_DOORBELL_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">arcmsr_do_message_isr_bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_handle_hba_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">outbound_intstatus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="n">outbound_intstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">outbound_intstatus</span> <span class="o">&amp;</span> <span class="n">ARCMSR_MU_OUTBOUND_HANDLE_INT</span><span class="p">))</span>	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">outbound_intstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_intstatus</span> <span class="o">&amp;</span> <span class="n">ARCMSR_MU_OUTBOUND_DOORBELL_INT</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">arcmsr_hba_doorbell_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_intstatus</span> <span class="o">&amp;</span> <span class="n">ARCMSR_MU_OUTBOUND_POSTQUEUE_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_hba_postqueue_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">outbound_intstatus</span> <span class="o">&amp;</span> <span class="n">ARCMSR_MU_OUTBOUND_MESSAGE0_INT</span><span class="p">)</span> 	<span class="p">{</span>
		<span class="cm">/* messenger of &quot;driver to iop commands&quot; */</span>
		<span class="n">arcmsr_hba_message_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_handle_hbb_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outbound_doorbell</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
	<span class="cm">/*in case the last action of doorbell interrupt clearance is cached,</span>
<span class="cm">	this action can push HW to write down the clear bit*/</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_END_OF_INTERRUPT</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_IOP2DRV_DATA_WRITE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_wrote_handle</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_IOP2DRV_DATA_READ_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_iop2drv_data_read_handle</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_IOP2DRV_CDB_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_hbb_postqueue_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">outbound_doorbell</span> <span class="o">&amp;</span> <span class="n">ARCMSR_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* messenger of &quot;driver to iop commands&quot; */</span>
		<span class="n">arcmsr_hbb_message_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_handle_hbc_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">host_interrupt_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	*********************************************</span>
<span class="cm">	**   check outbound intstatus</span>
<span class="cm">	*********************************************</span>
<span class="cm">	*/</span>
	<span class="n">host_interrupt_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">host_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host_interrupt_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*it must be share irq*/</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* MU ioctl transfer doorbell interrupts*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_interrupt_status</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_OUTBOUND_DOORBELL_ISR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_hbc_doorbell_isr</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>   <span class="cm">/* messenger of &quot;ioctl message read write&quot; */</span>
	<span class="p">}</span>
	<span class="cm">/* MU post queue interrupts*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_interrupt_status</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_OUTBOUND_POSTQUEUE_ISR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arcmsr_hbc_postqueue_isr</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>  <span class="cm">/* messenger of &quot;scsi commands&quot; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">arcmsr_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_handle_hba_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_handle_hbb_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	 <span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_handle_hbc_isr</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_iop_parking</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop adapter background rebuild */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_MSG_START_BGRB</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">;</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
			<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="n">arcmsr_stop_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="n">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">arcmsr_post_ioctldata2iop</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int32_t</span> <span class="n">wqbuf_firstindex</span><span class="p">,</span> <span class="n">wqbuf_lastindex</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pwbuffer</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_data</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">allxfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pwbuffer</span> <span class="o">=</span> <span class="n">arcmsr_get_iop_wqbuffer</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">iop_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">pwbuffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">);</span>
		<span class="n">wqbuf_firstindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span><span class="p">;</span>
		<span class="n">wqbuf_lastindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">wqbuf_firstindex</span> <span class="o">!=</span> <span class="n">wqbuf_lastindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">allxfer_len</span> <span class="o">&lt;</span> <span class="mi">124</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pQbuffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuffer</span><span class="p">[</span><span class="n">wqbuf_firstindex</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">iop_data</span><span class="p">,</span> <span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">wqbuf_firstindex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">wqbuf_firstindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
			<span class="n">iop_data</span><span class="o">++</span><span class="p">;</span>
			<span class="n">allxfer_len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">=</span> <span class="n">wqbuf_firstindex</span><span class="p">;</span>
		<span class="n">pwbuffer</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">allxfer_len</span><span class="p">;</span>
		<span class="n">arcmsr_iop_message_wrote</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_iop_message_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CMD_MESSAGE_FIELD</span> <span class="o">*</span><span class="n">pcmdmessagefld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">transfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">controlcode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
						<span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
						<span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>  <span class="o">|</span>
						<span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
						<span class="cm">/* 4 bytes: Areca io control code */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">message_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">transfer_len</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">transfer_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CMD_MESSAGE_FIELD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">message_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcmdmessagefld</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">CMD_MESSAGE_FIELD</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">controlcode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_READ_RQBUFFER</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ver_addr</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="o">*</span><span class="n">ptmpQbuffer</span><span class="p">;</span>
		<span class="kt">int32_t</span> <span class="n">allxfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ver_addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1032</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ver_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">message_out</span><span class="p">;</span>
		<span class="p">}</span>
				
		<span class="n">ptmpQbuffer</span> <span class="o">=</span> <span class="n">ver_addr</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span> <span class="o">!=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">allxfer_len</span> <span class="o">&lt;</span> <span class="mi">1031</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pQbuffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuffer</span><span class="p">[</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptmpQbuffer</span><span class="p">,</span> <span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
			<span class="n">ptmpQbuffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">allxfer_len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">struct</span> <span class="n">QBUFFER</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prbuffer</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_data</span><span class="p">;</span>
			<span class="kt">int32_t</span> <span class="n">iop_len</span><span class="p">;</span>

			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">;</span>
			<span class="n">prbuffer</span> <span class="o">=</span> <span class="n">arcmsr_get_iop_rqbuffer</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="n">iop_data</span> <span class="o">=</span> <span class="n">prbuffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">iop_len</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prbuffer</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">iop_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuffer</span><span class="p">[</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_data</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span><span class="o">++</span><span class="p">;</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
				<span class="n">iop_data</span><span class="o">++</span><span class="p">;</span>
				<span class="n">iop_len</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arcmsr_iop_message_read</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">messagedatabuffer</span><span class="p">,</span> <span class="n">ver_addr</span><span class="p">,</span> <span class="n">allxfer_len</span><span class="p">);</span>
		<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">allxfer_len</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ver_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_WRITE_WQBUFFER</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ver_addr</span><span class="p">;</span>
		<span class="kt">int32_t</span> <span class="n">my_empty_len</span><span class="p">,</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">wqbuf_firstindex</span><span class="p">,</span> <span class="n">wqbuf_lastindex</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="o">*</span><span class="n">ptmpuserbuffer</span><span class="p">;</span>

		<span class="n">ver_addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1032</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ver_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">message_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span> 
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span> 
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptmpuserbuffer</span> <span class="o">=</span> <span class="n">ver_addr</span><span class="p">;</span>
		<span class="n">user_len</span> <span class="o">=</span> <span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptmpuserbuffer</span><span class="p">,</span> <span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">messagedatabuffer</span><span class="p">,</span> <span class="n">user_len</span><span class="p">);</span>
		<span class="n">wqbuf_lastindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">;</span>
		<span class="n">wqbuf_firstindex</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wqbuf_lastindex</span> <span class="o">!=</span> <span class="n">wqbuf_firstindex</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="n">sensebuffer</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
			<span class="n">arcmsr_post_ioctldata2iop</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="cm">/* has error report sensedata */</span>
			<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>
			<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
			<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">Valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">my_empty_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">wqbuf_firstindex</span><span class="o">-</span><span class="n">wqbuf_lastindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">ARCMSR_MAX_QBUFFER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">my_empty_len</span> <span class="o">&gt;=</span> <span class="n">user_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">user_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pQbuffer</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuffer</span><span class="p">[</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="p">];</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="n">ptmpuserbuffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span><span class="o">++</span><span class="p">;</span>
					<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">;</span>
					<span class="n">ptmpuserbuffer</span><span class="o">++</span><span class="p">;</span>
					<span class="n">user_len</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span>
						<span class="o">~</span><span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span><span class="p">;</span>
					<span class="n">arcmsr_post_ioctldata2iop</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* has error report sensedata */</span>
				<span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="n">sensebuffer</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">SENSE_DATA</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
				<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
				<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>
				<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
				<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">sensebuffer</span><span class="o">-&gt;</span><span class="n">Valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ver_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_CLEAR_RQBUFFER</span>: <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuffer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">;</span>
			<span class="n">arcmsr_iop_message_read</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MESSAGE_RQBUFFER_CLEARED</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_CLEAR_WQBUFFER</span>: <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuffer</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">;</span>
			<span class="n">arcmsr_iop_message_read</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span> <span class="o">|</span>
				<span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARCMSR_MAX_QBUFFER</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_CLEAR_ALLQBUFFER</span>: <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pQbuffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOPDATA_OVERFLOW</span><span class="p">;</span>
			<span class="n">arcmsr_iop_message_read</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">ACB_F_MESSAGE_WQBUFFER_CLEARED</span>
			<span class="o">|</span> <span class="n">ACB_F_MESSAGE_RQBUFFER_CLEARED</span>
			<span class="o">|</span> <span class="n">ACB_F_MESSAGE_WQBUFFER_READED</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_firstindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuf_lastindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_firstindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuf_lastindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pQbuffer</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">rqbuffer</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span><span class="p">));</span>
		<span class="n">pQbuffer</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">wqbuffer</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pQbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">QBUFFER</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_RETURN_CODE_3F</span>: <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_3F</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_SAY_HELLO</span>: <span class="p">{</span>
		<span class="kt">int8_t</span> <span class="o">*</span><span class="n">hello_string</span> <span class="o">=</span> <span class="s">&quot;Hello! I am ARCMSR&quot;</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">messagedatabuffer</span><span class="p">,</span> <span class="n">hello_string</span>
			<span class="p">,</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">hello_string</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_SAY_GOODBYE</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">arcmsr_iop_parking</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ARCMSR_MESSAGE_FLUSH_ADAPTER_CACHE</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">==</span> <span class="n">FW_DEADLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcmdmessagefld</span><span class="o">-&gt;</span><span class="n">cmdmessage</span><span class="p">.</span><span class="n">ReturnCode</span> <span class="o">=</span>
			<span class="n">ARCMSR_MESSAGE_RETURNCODE_BUS_HANG_ON</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">arcmsr_flush_adapter_cache</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">retvalue</span> <span class="o">=</span> <span class="n">ARCMSR_MESSAGE_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">message_out:</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span> <span class="o">-</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="nf">arcmsr_get_freeccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccb_free_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ccb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ccb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_handle_virtual_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inqdata</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TYPE_PROCESSOR</span><span class="p">;</span>
		<span class="cm">/* Periph Qualifier &amp; Periph Dev Type */</span>
		<span class="n">inqdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* rem media bit &amp; Dev Type Modifier */</span>
		<span class="n">inqdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* ISO, ECMA, &amp; ANSI versions */</span>
		<span class="n">inqdata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="cm">/* length of additional data */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inqdata</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s">&quot;Areca   &quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/* Vendor Identification */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inqdata</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="s">&quot;RAID controller &quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="cm">/* Product Identification */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inqdata</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="s">&quot;R001&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* Product Revision */</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">inqdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inqdata</span><span class="p">));</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span> <span class="o">-</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
	<span class="k">case</span> <span class="n">READ_BUFFER</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_iop_message_xfer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_queue_command_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">scsicmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsicmd</span> <span class="o">==</span> <span class="n">SYNCHRONIZE_CACHE</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="n">scsicmd</span> <span class="o">==</span> <span class="n">SEND_DIAGNOSTIC</span><span class="p">)){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">devstate</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">ARECA_RAID_GONE</span><span class="p">)</span> <span class="p">{</span>
    			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* virtual device for iop message transfer */</span>
		<span class="n">arcmsr_handle_virtual_command</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">)</span> <span class="o">&gt;=</span>
			<span class="n">ARCMSR_MAX_OUTSTANDING_CMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="n">arcmsr_get_freeccb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arcmsr_build_ccb</span><span class="p">(</span> <span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">cmd</span> <span class="p">)</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">RESERVATION_CONFLICT</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arcmsr_post_ccb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">arcmsr_queue_command</span><span class="p">)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">arcmsr_get_hba_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_device_map</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">device_map</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_firm_model</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_firm_version</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_device_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_GET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;get adapter firmware \</span>
<span class="s">			miscellaneous data&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_model</span><span class="p">);</span>
		<span class="n">acb_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_version</span><span class="p">);</span>
		<span class="n">acb_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span><span class="o">=</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_device_map</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_device_map</span><span class="p">);</span>
		<span class="n">acb_device_map</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_device_map</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Areca RAID Controller%d: F/W %s &amp; Model %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_request_len</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_numbers_queue</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_sdram_size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_hd_channels</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_cfg_version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>  <span class="cm">/*firm_cfg_version,25,100-103*/</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">arcmsr_get_hbb_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dma_coherent</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_device_map</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">device_map</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_firm_model</span><span class="p">;</span>
	<span class="cm">/*firm_model,15,60-67*/</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_firm_version</span><span class="p">;</span>
	<span class="cm">/*firm_version,17,68-83*/</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iop_device_map</span><span class="p">;</span>
	<span class="cm">/*firm_version,21,84-99*/</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">dma_coherent</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_B</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dma_coherent_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_coherent</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: dma_alloc_coherent got error for hbb mu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle_hbb_mu</span> <span class="o">=</span> <span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="p">)</span><span class="n">dma_coherent</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span> <span class="o">+</span> <span class="n">ARCMSR_DRV2IOP_DOORBELL</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell_mask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span> <span class="o">+</span> <span class="n">ARCMSR_DRV2IOP_DOORBELL_MASK</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span> <span class="o">+</span> <span class="n">ARCMSR_IOP2DRV_DOORBELL</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell_mask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base0</span> <span class="o">+</span> <span class="n">ARCMSR_IOP2DRV_DOORBELL_MASK</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_wbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base1</span> <span class="o">+</span> <span class="n">ARCMSR_MESSAGE_WBUFFER</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rbuffer</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base1</span> <span class="o">+</span> <span class="n">ARCMSR_MESSAGE_RBUFFER</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">mem_base1</span> <span class="o">+</span> <span class="n">ARCMSR_MESSAGE_RWBUFFER</span><span class="p">);</span>
	<span class="n">iop_firm_model</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>	<span class="cm">/*firm_model,15,60-67*/</span>
	<span class="n">iop_firm_version</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>	<span class="cm">/*firm_version,17,68-83*/</span>
	<span class="n">iop_device_map</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>	<span class="cm">/*firm_version,21,84-99*/</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_GET_CONFIG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;get adapter firmware \</span>
<span class="s">			miscellaneous data&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_model</span><span class="p">);</span>
		<span class="n">acb_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_version</span><span class="p">);</span>
		<span class="n">acb_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="p">){</span>
		<span class="o">*</span><span class="n">acb_device_map</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_device_map</span><span class="p">);</span>
		<span class="n">acb_device_map</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_device_map</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Areca RAID Controller%d: F/W %s &amp; Model %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">);</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/*firm_signature,1,00-03*/</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_request_len</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="cm">/*firm_request_len,1,04-07*/</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_numbers_queue</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="cm">/*firm_numbers_queue,2,08-11*/</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_sdram_size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="cm">/*firm_sdram_size,3,12-15*/</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_hd_channels</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="cm">/*firm_ide_channels,4,16-19*/</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">firm_cfg_version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>  <span class="cm">/*firm_cfg_version,25,100-103*/</span>
	<span class="cm">/*firm_ide_channels,4,16-19*/</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">arcmsr_get_hbc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">firmware_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">iop_firm_model</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>    <span class="cm">/*firm_model,15,60-67*/</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">iop_firm_version</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>  <span class="cm">/*firm_version,17,68-83*/</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/* disable all outbound interrupt */</span>
	<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">);</span> <span class="cm">/* disable outbound message0 int */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intmask_org</span><span class="o">|</span><span class="n">ARCMSR_HBCMU_ALL_INTMASKENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">);</span>
	<span class="cm">/* wait firmware ready */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">firmware_state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_msgaddr1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">firmware_state</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_MESSAGE_FIRMWARE_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* post &quot;get config&quot; instruction */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_GET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
	<span class="cm">/* wait message ready */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Index</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">Index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_IOP2DRV_MESSAGE_CMD_DONE_DOORBELL_CLEAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span><span class="cm">/*clear interrupt*/</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/*max 1 seconds*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Index</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;get adapter firmware \</span>
<span class="s">			miscellaneous data&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">acb_firm_model</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_model</span><span class="p">);</span>
		<span class="n">acb_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_model</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">acb_firm_version</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">iop_firm_version</span><span class="p">);</span>
		<span class="n">acb_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iop_firm_version</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Areca RAID Controller%d: F/W %s &amp; Model %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_version</span><span class="p">,</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_model</span><span class="p">);</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_request_len</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>   <span class="cm">/*firm_request_len,1,04-07*/</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_numbers_queue</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="cm">/*firm_numbers_queue,2,08-11*/</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_sdram_size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>    <span class="cm">/*firm_sdram_size,3,12-15*/</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_hd_channels</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>  <span class="cm">/*firm_ide_channels,4,16-19*/</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">firm_cfg_version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]);</span>  <span class="cm">/*firm_cfg_version,25,100-103*/</span>
	<span class="cm">/*all interrupt service will be enable at arcmsr_iop_init*/</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">arcmsr_get_firmware_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">==</span> <span class="n">ACB_ADAPTER_TYPE_A</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">arcmsr_get_hba_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span> <span class="o">==</span> <span class="n">ACB_ADAPTER_TYPE_B</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">arcmsr_get_hbb_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">arcmsr_get_hbc_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_polling_hba_ccbdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">poll_ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">,</span> <span class="n">outbound_intstatus</span><span class="p">,</span> <span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="nl">polling_hba_ccb_retry:</span>
	<span class="n">poll_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">outbound_intstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">outbound_int_enable</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">outbound_intstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_intstatus</span><span class="p">);</span><span class="cm">/*clear interrupt*/</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_queueport</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_ccb_done</span><span class="p">){</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">){</span>
					<span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">polling_hba_ccb_retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">ccb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccb</span> <span class="o">==</span> <span class="n">poll_ccb</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">!=</span> <span class="n">acb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">!=</span> <span class="n">ARCMSR_CCB_START</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ccb</span> <span class="o">==</span> <span class="n">poll_ccb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: scsi id = %d lun = %d ccb = &#39;0x%p&#39;&quot;</span>
					<span class="s">&quot; poll command abort successfully </span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
					<span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span>
					<span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span>
					<span class="p">,</span> <span class="n">ccb</span><span class="p">);</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: polling get an illegal ccb&quot;</span>
				<span class="s">&quot; command done ccb = &#39;0x%p&#39;&quot;</span>
				<span class="s">&quot;ccboutstandingcount = %d </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
				<span class="p">,</span> <span class="n">ccb</span>
				<span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">arcmsr_report_ccb_state</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_polling_hbb_ccbdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">poll_ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">,</span> <span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">rtn</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="nl">polling_hbb_ccb_retry:</span>

	<span class="n">poll_count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* clear doorbell interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DOORBELL_INT_CLEAR_PATTERN</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_ccb_done</span><span class="p">){</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">){</span>
					<span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">polling_hbb_ccb_retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">done_qbuffer</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*if last index number set it to 0 */</span>
		<span class="n">index</span> <span class="o">%=</span> <span class="n">ARCMSR_MAX_HBB_POSTQUEUE</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="cm">/* check if command done with no error*/</span>
		<span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">ccb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccb</span> <span class="o">==</span> <span class="n">poll_ccb</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">!=</span> <span class="n">acb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">!=</span> <span class="n">ARCMSR_CCB_START</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ccb</span> <span class="o">==</span> <span class="n">poll_ccb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: scsi id = %d lun = %d ccb = &#39;0x%p&#39;&quot;</span>
					<span class="s">&quot; poll command abort successfully </span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="p">,</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
					<span class="p">,</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span>
					<span class="p">,</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span>
					<span class="p">,</span><span class="n">ccb</span><span class="p">);</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">ccb</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: polling get an illegal ccb&quot;</span>
				<span class="s">&quot; command done ccb = &#39;0x%p&#39;&quot;</span>
				<span class="s">&quot;ccboutstandingcount = %d </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
				<span class="p">,</span> <span class="n">ccb</span>
				<span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> 
		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">arcmsr_report_ccb_state</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_polling_hbc_ccbdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">poll_ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag_ccb</span><span class="p">,</span> <span class="n">ccb_cdb_phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="n">arcmsr_cdb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">pCCB</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span><span class="p">;</span>
<span class="nl">polling_hbc_ccb_retry:</span>
	<span class="n">poll_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_OUTBOUND_POSTQUEUE_ISR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_ccb_done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">polling_hbc_ccb_retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">flag_ccb</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_queueport_low</span><span class="p">);</span>
		<span class="n">ccb_cdb_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">);</span>
		<span class="n">arcmsr_cdb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ARCMSR_CDB</span> <span class="o">*</span><span class="p">)(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">vir2phy_offset</span> <span class="o">+</span> <span class="n">ccb_cdb_phy</span><span class="p">);</span><span class="cm">/*frame must be 32 bytes aligned*/</span>
		<span class="n">pCCB</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">arcmsr_cdb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CommandControlBlock</span><span class="p">,</span> <span class="n">arcmsr_cdb</span><span class="p">);</span>
		<span class="n">poll_ccb_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">pCCB</span> <span class="o">==</span> <span class="n">poll_ccb</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* check ifcommand done with no error*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">!=</span> <span class="n">acb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">!=</span> <span class="n">ARCMSR_CCB_START</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: scsi id = %d lun = %d ccb = &#39;0x%p&#39;&quot;</span>
					<span class="s">&quot; poll command abort successfully </span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
					<span class="p">,</span> <span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span>
					<span class="p">,</span> <span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span>
					<span class="p">,</span> <span class="n">pCCB</span><span class="p">);</span>
					<span class="n">pCCB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">arcmsr_ccb_complete</span><span class="p">(</span><span class="n">pCCB</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: polling get an illegal ccb&quot;</span>
				<span class="s">&quot; command done ccb = &#39;0x%p&#39;&quot;</span>
				<span class="s">&quot;ccboutstandingcount = %d </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span>
				<span class="p">,</span> <span class="n">pCCB</span>
				<span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">flag_ccb</span> <span class="o">&amp;</span> <span class="n">ARCMSR_CCBREPLY_FLAG_ERROR_MODE1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">arcmsr_report_ccb_state</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pCCB</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_polling_ccbdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">poll_ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="n">rtn</span> <span class="o">=</span> <span class="n">arcmsr_polling_hba_ccbdone</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">poll_ccb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="n">rtn</span> <span class="o">=</span> <span class="n">arcmsr_polling_hbb_ccbdone</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">poll_ccb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="n">rtn</span> <span class="o">=</span> <span class="n">arcmsr_polling_hbc_ccbdone</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">poll_ccb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_iop_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cdb_phyaddr</span><span class="p">,</span> <span class="n">cdb_phyaddr_hi32</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	********************************************************************</span>
<span class="cm">	** here we need to tell iop 331 our freeccb.HighPart</span>
<span class="cm">	** if freeccb.HighPart is not zero</span>
<span class="cm">	********************************************************************</span>
<span class="cm">	*/</span>
	<span class="n">dma_coherent_handle</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle</span><span class="p">;</span>
	<span class="n">cdb_phyaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">dma_coherent_handle</span><span class="p">);</span>
	<span class="n">cdb_phyaddr_hi32</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="n">cdb_phyaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">cdb_phyaddr_hi32</span> <span class="o">=</span> <span class="n">cdb_phyaddr_hi32</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	***********************************************************************</span>
<span class="cm">	**    if adapter type B, set window of &quot;post command Q&quot;</span>
<span class="cm">	***********************************************************************</span>
<span class="cm">	*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdb_phyaddr_hi32</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">;</span>
			<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_SIGNATURE_SET_CONFIG</span><span class="p">,</span> \
						<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_hi32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_SET_CONFIG</span><span class="p">,</span> \
							<span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: &quot;&quot;set ccb high \</span>
<span class="s">				part physical address timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">post_queue_phyaddr</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rwbuffer</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">;</span>
		<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">postq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">doneq_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_SET_POST_WINDOW</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d:can not set diver mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> \
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">post_queue_phyaddr</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dma_coherent_handle_hbb_mu</span><span class="p">;</span>
		<span class="n">rwbuffer</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">message_rwbuffer</span><span class="p">;</span>
		<span class="cm">/* driver &quot;set config&quot; signature */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_SIGNATURE_SET_CONFIG</span><span class="p">,</span> <span class="n">rwbuffer</span><span class="o">++</span><span class="p">);</span>
		<span class="cm">/* normal should be zero */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_hi32</span><span class="p">,</span> <span class="n">rwbuffer</span><span class="o">++</span><span class="p">);</span>
		<span class="cm">/* postQ size (256 + 8)*4	 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">post_queue_phyaddr</span><span class="p">,</span> <span class="n">rwbuffer</span><span class="o">++</span><span class="p">);</span>
		<span class="cm">/* doneQ size (256 + 8)*4	 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">post_queue_phyaddr</span> <span class="o">+</span> <span class="mi">1056</span><span class="p">,</span> <span class="n">rwbuffer</span><span class="o">++</span><span class="p">);</span>
		<span class="cm">/* ccb maxQ size must be --&gt; [(256 + 8)*4]*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1056</span><span class="p">,</span> <span class="n">rwbuffer</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_SET_CONFIG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: &#39;set command Q window&#39; \</span>
<span class="s">			timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">arcmsr_hbb_enable_driver_mode</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdb_phyaddr_hi32</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: cdb_phyaddr_hi32=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_index</span><span class="p">,</span> <span class="n">cdb_phyaddr_hi32</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_SIGNATURE_SET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cdb_phyaddr_hi32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">msgcode_rwbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_SET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: &#39;set command Q window&#39; \</span>
<span class="s">				timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_wait_firmware_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">firmware_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">firmware_state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_msgaddr1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">firmware_state</span> <span class="o">&amp;</span> <span class="n">ARCMSR_OUTBOUND_MESG1_FIRMWARE_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">firmware_state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">firmware_state</span> <span class="o">&amp;</span> <span class="n">ARCMSR_MESSAGE_FIRMWARE_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_END_OF_INTERRUPT</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">firmware_state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_msgaddr1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">firmware_state</span> <span class="o">&amp;</span> <span class="n">ARCMSR_HBCMU_MESSAGE_FIRMWARE_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_request_hba_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_ABORT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)){</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">)){</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_GET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_request_hbb_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_ABORT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)){</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_GET_CONFIG</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_request_hbc_device_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_ABORT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_GET_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_request_device_map</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pacb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span><span class="n">pacb</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
			<span class="n">arcmsr_request_hba_device_map</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
			<span class="n">arcmsr_request_hbb_device_map</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
			<span class="n">arcmsr_request_hbc_device_map</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_start_hba_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_START_BGRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hba_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;start adapter background \</span>
<span class="s">				rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_start_hbb_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_START_BGRB</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;start adapter background \</span>
<span class="s">				rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_start_hbc_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">phbcmu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_MSG_START_BGRB</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_MESG0_START_BGRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_msgaddr0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_MESSAGE_CMD_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phbcmu</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbc_wait_msgint_ready</span><span class="p">(</span><span class="n">pACB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: wait &#39;start adapter background \</span>
<span class="s">				rebulid&#39; timeout </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_start_adapter_bgrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:
		<span class="n">arcmsr_start_hba_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:
		<span class="n">arcmsr_start_hbb_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:
		<span class="n">arcmsr_start_hbc_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_clear_doorbell_queue_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
		<span class="cm">/* empty doorbell Qbuffer if door bell ringed */</span>
		<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
		<span class="cm">/*clear doorbell interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_DRIVER_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
		<span class="cm">/*clear interrupt and message state*/</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_INT_CLEAR_PATTERN</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">iop2drv_doorbell</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_DRV2IOP_DATA_READ_OK</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
		<span class="cm">/* let IOP know data has been read */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="o">*</span><span class="p">)</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
		<span class="cm">/* empty doorbell Qbuffer if door bell ringed */</span>
		<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_enable_eoi_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">MessageUnit_B</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuB</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_MESSAGE_ACTIVE_EOI_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">drv2iop_doorbell</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_hbb_wait_msgint_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ARCMSR IOP enables EOI_MODE TIMEOUT&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_hardware_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">value</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pmuA</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pmuC</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* backup pci config data */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;arcmsr%d: executing hw bus reset .....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="cm">/* hardware reset signal */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x1680</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_ARC1680_BUS_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuA</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mh">0x1880</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">write_sequence</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((((</span><span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">host_diagnostic</span><span class="p">))</span> <span class="o">|</span> <span class="n">ARCMSR_ARC1880_DiagWrite_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_ARC1880_RESET_ADAPTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmuC</span><span class="o">-&gt;</span><span class="n">host_diagnostic</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="cm">/* write back pci config data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcmsr_iop_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">;</span>
	<span class="cm">/* disable all outbound interrupt */</span>
	<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_wait_firmware_ready</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_iop_confirm</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="cm">/*start background rebuild*/</span>
	<span class="n">arcmsr_start_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="cm">/* empty doorbell Qbuffer if door bell ringed */</span>
	<span class="n">arcmsr_clear_doorbell_queue_buffer</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">arcmsr_enable_eoi_mode</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="cm">/* enable outbound Post Queue,outbound doorbell Interrupt */</span>
	<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">arcmsr_iop_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">rtnval</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable all outbound interrupt */</span>
		<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="cm">/* talk to iop 331 outstanding command aborted */</span>
		<span class="n">rtnval</span> <span class="o">=</span> <span class="n">arcmsr_abort_allcmd</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="cm">/* clear all outbound posted Q */</span>
		<span class="n">arcmsr_done4abort_postqueue</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pccb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_START</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">);</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">=</span> <span class="n">ARCMSR_CCB_DONE</span><span class="p">;</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccb_free_list</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccblist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* enable all outbound interrupt */</span>
		<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rtnval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtnval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intmask_org</span><span class="p">,</span> <span class="n">outbound_doorbell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr: executing bus reset eh.....num_resets = %d, num_aborts = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">num_aborts</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">adapter_type</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_A</span>:<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">){</span>
				<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr: there is an  bus reset eh proceeding.......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">wait_q</span><span class="p">,</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">220</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_iop_reset</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">MessageUnit_A</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuA</span><span class="p">;</span>
				<span class="n">arcmsr_hardware_reset</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>
<span class="nl">sleep_again:</span>
				<span class="n">ssleep</span><span class="p">(</span><span class="n">ARCMSR_SLEEPTIME</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_msgaddr1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ARCMSR_OUTBOUND_MESG1_FIRMWARE_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr%d: waiting for hw bus reset return, retry=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">ARCMSR_RETRYCOUNT</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_DEADLOCK</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr%d: waiting for hw bus reset return, RETRY TERMINATED!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">sleep_again</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>
				<span class="cm">/* disable all outbound interrupt */</span>
				<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">arcmsr_get_firmware_spec</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">arcmsr_start_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="cm">/* clear Qbuffer if door bell ringed */</span>
				<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span> <span class="cm">/*clear interrupt */</span>
   				<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_INBOUND_DRIVER_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
				<span class="cm">/* enable outbound Post Queue,outbound doorbell Interrupt */</span>
				<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr: scsi  bus reset eh returns with success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_B</span>:<span class="p">{</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_iop_reset</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">ACB_ADAPTER_TYPE_C</span>:<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr: there is an bus reset eh proceeding.......</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">wait_q</span><span class="p">,</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">220</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arcmsr_iop_reset</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">MessageUnit_C</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pmuC</span><span class="p">;</span>
				<span class="n">arcmsr_hardware_reset</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>
<span class="nl">sleep:</span>
				<span class="n">ssleep</span><span class="p">(</span><span class="n">ARCMSR_SLEEPTIME</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_diagnostic</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr%d: waiting for hw bus reset return, retry=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">ARCMSR_RETRYCOUNT</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_DEADLOCK</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr%d: waiting for hw bus reset return, RETRY TERMINATED!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">sleep</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_IOP_INITED</span><span class="p">;</span>
				<span class="cm">/* disable all outbound interrupt */</span>
				<span class="n">intmask_org</span> <span class="o">=</span> <span class="n">arcmsr_disable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">arcmsr_get_firmware_spec</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="n">arcmsr_start_adapter_bgrb</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
				<span class="cm">/* clear Qbuffer if door bell ringed */</span>
				<span class="n">outbound_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">outbound_doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">outbound_doorbell_clear</span><span class="p">);</span> <span class="cm">/*clear interrupt */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">ARCMSR_HBCMU_DRV2IOP_DATA_READ_OK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">inbound_doorbell</span><span class="p">);</span>
				<span class="cm">/* enable outbound Post Queue,outbound doorbell Interrupt */</span>
				<span class="n">arcmsr_enable_outbound_ints</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">intmask_org</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;arcmsr: scsi bus reset eh returns with success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_BUS_RESET</span><span class="p">;</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">rq_map_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ante_token_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">acb</span><span class="o">-&gt;</span><span class="n">fw_flag</span> <span class="o">=</span> <span class="n">FW_NORMAL</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eternal_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
				<span class="n">rtn</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_abort_one_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rtn</span><span class="p">;</span>
	<span class="n">rtn</span> <span class="o">=</span> <span class="n">arcmsr_polling_ccbdone</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcmsr_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span>
		<span class="s">&quot;arcmsr%d: abort device command of scsi id = %d lun = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">|=</span> <span class="n">ACB_F_ABORT</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">num_aborts</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	************************************************</span>
<span class="cm">	** the all interrupt service routine is locked</span>
<span class="cm">	** we need to handle it as soon as possible and exit</span>
<span class="cm">	************************************************</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ccboutstandingcount</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARCMSR_MAX_FREECCB_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">CommandControlBlock</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pccb_pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">==</span> <span class="n">ARCMSR_CCB_START</span> <span class="o">&amp;&amp;</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">pcmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">startdone</span> <span class="o">=</span> <span class="n">ARCMSR_CCB_ABORTED</span><span class="p">;</span>
			<span class="n">rtn</span> <span class="o">=</span> <span class="n">arcmsr_abort_one_cmd</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">ccb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACB_F_ABORT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">arcmsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">AdapterControlBlock</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raid6</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1110</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1200</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1202</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1210</span>:
		<span class="n">raid6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*FALLTHRU*/</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1120</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1130</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1160</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1170</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1201</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1220</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1230</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1260</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1270</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1280</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;SATA&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1380</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1381</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1680</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1681</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_ARECA_1880</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;SAS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;X-TYPE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Areca %s Host Adapter RAID Controller%s</span><span class="se">\n</span><span class="s"> %s&quot;</span><span class="p">,</span>
			<span class="n">type</span><span class="p">,</span> <span class="n">raid6</span> <span class="o">?</span> <span class="s">&quot;( RAID6 capable)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ARCMSR_DRIVER_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
