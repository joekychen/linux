<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › scsi_devinfo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scsi_devinfo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_devinfo.h&gt;</span>

<span class="cp">#include &quot;scsi_priv.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * scsi_dev_info_list: structure to hold black/white listed devices.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dev_info_list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">vendor</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">compatible</span><span class="p">;</span> <span class="cm">/* for use with scsi_static_device_list entries */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>	<span class="cm">/* our node for being on the master list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">scsi_dev_info_list</span><span class="p">;</span> <span class="cm">/* head of dev info list */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/* name of list for /proc (NULL for global) */</span>
	<span class="kt">int</span> <span class="n">key</span><span class="p">;</span>		<span class="cm">/* unique numeric identifier */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">spaces</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;                &quot;</span><span class="p">;</span> <span class="cm">/* 16 of them */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">scsi_default_dev_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">scsi_dev_info_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">scsi_dev_flags</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * scsi_static_device_list: deprecated list of devices that require</span>
<span class="cm"> * settings that differ from the default, includes black-listed (broken)</span>
<span class="cm"> * devices. The entries here are added to the tail of scsi_dev_info_list</span>
<span class="cm"> * via scsi_dev_info_list_init.</span>
<span class="cm"> *</span>
<span class="cm"> * Do not add to this list, use the command line or proc interface to add</span>
<span class="cm"> * to the scsi_dev_info_list. This table will eventually go away.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">revision</span><span class="p">;</span>	<span class="cm">/* revision known to be bad, unused */</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scsi_static_device_list</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following devices are known not to tolerate a lun != 0 scan</span>
<span class="cm">	 * for one reason or another. Some will respond to all luns,</span>
<span class="cm">	 * others will lock up.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;Aashima&quot;</span><span class="p">,</span> <span class="s">&quot;IMAGERY 2400SP&quot;</span><span class="p">,</span> <span class="s">&quot;1.03&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;CHINON&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDS-431&quot;</span><span class="p">,</span> <span class="s">&quot;H42&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;CHINON&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDS-535&quot;</span><span class="p">,</span> <span class="s">&quot;Q14&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;DENON&quot;</span><span class="p">,</span> <span class="s">&quot;DRD-25X&quot;</span><span class="p">,</span> <span class="s">&quot;V&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>			<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;DK312C&quot;</span><span class="p">,</span> <span class="s">&quot;CM81&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;DK314C&quot;</span><span class="p">,</span> <span class="s">&quot;CR21&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;2104-DU3&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;2104-TU3&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;IMS&quot;</span><span class="p">,</span> <span class="s">&quot;CDD521/10&quot;</span><span class="p">,</span> <span class="s">&quot;2.06&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MAXTOR&quot;</span><span class="p">,</span> <span class="s">&quot;XT-3280&quot;</span><span class="p">,</span> <span class="s">&quot;PR02&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MAXTOR&quot;</span><span class="p">,</span> <span class="s">&quot;XT-4380S&quot;</span><span class="p">,</span> <span class="s">&quot;B3C&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MAXTOR&quot;</span><span class="p">,</span> <span class="s">&quot;MXT-1240S&quot;</span><span class="p">,</span> <span class="s">&quot;I1.2&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MAXTOR&quot;</span><span class="p">,</span> <span class="s">&quot;XT-4170S&quot;</span><span class="p">,</span> <span class="s">&quot;B5A&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MAXTOR&quot;</span><span class="p">,</span> <span class="s">&quot;XT-8760S&quot;</span><span class="p">,</span> <span class="s">&quot;B7B&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MEDIAVIS&quot;</span><span class="p">,</span> <span class="s">&quot;RENO CD-ROMX2A&quot;</span><span class="p">,</span> <span class="s">&quot;2.03&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;MICROTEK&quot;</span><span class="p">,</span> <span class="s">&quot;ScanMakerIII&quot;</span><span class="p">,</span> <span class="s">&quot;2.30&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM DRIVE:841&quot;</span><span class="p">,</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span><span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;PHILIPS&quot;</span><span class="p">,</span> <span class="s">&quot;PCA80SC&quot;</span><span class="p">,</span> <span class="s">&quot;V4-2&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;RODIME&quot;</span><span class="p">,</span> <span class="s">&quot;RO3000S&quot;</span><span class="p">,</span> <span class="s">&quot;2.33&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;SENA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* responds to all luns */</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following causes a failed REQUEST SENSE on lun 1 for</span>
<span class="cm">	 * aha152x controller, which causes SCSI code to reset bus.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;SANYO&quot;</span><span class="p">,</span> <span class="s">&quot;CRD-250S&quot;</span><span class="p">,</span> <span class="s">&quot;1.20&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following causes a failed REQUEST SENSE on lun 1 for</span>
<span class="cm">	 * aha152x controller, which causes SCSI code to reset bus.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;SEAGATE&quot;</span><span class="p">,</span> <span class="s">&quot;ST157N&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\004</span><span class="s">|j&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SEAGATE&quot;</span><span class="p">,</span> <span class="s">&quot;ST296&quot;</span><span class="p">,</span> <span class="s">&quot;921&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;SEAGATE&quot;</span><span class="p">,</span> <span class="s">&quot;ST1581&quot;</span><span class="p">,</span> <span class="s">&quot;6538&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDU-541&quot;</span><span class="p">,</span> <span class="s">&quot;4.3d&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDU-55S&quot;</span><span class="p">,</span> <span class="s">&quot;1.0i&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDU-561&quot;</span><span class="p">,</span> <span class="s">&quot;1.7x&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDU-8012&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;SDT-5000&quot;</span><span class="p">,</span> <span class="s">&quot;3.17&quot;</span><span class="p">,</span> <span class="n">BLIST_SELECT_NO_ATN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TANDBERG&quot;</span><span class="p">,</span> <span class="s">&quot;TDC 3600&quot;</span><span class="p">,</span> <span class="s">&quot;U07&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;TEAC&quot;</span><span class="p">,</span> <span class="s">&quot;CD-R55S&quot;</span><span class="p">,</span> <span class="s">&quot;1.0H&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following causes a failed REQUEST SENSE on lun 1 for</span>
<span class="cm">	 * seagate controller, which causes SCSI code to reset bus.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;TEAC&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">,</span> <span class="s">&quot;1.06&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TEAC&quot;</span><span class="p">,</span> <span class="s">&quot;MT-2ST/45S2-27&quot;</span><span class="p">,</span> <span class="s">&quot;RV M&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="cm">/*</span>
<span class="cm">	 * The following causes a failed REQUEST SENSE on lun 1 for</span>
<span class="cm">	 * seagate controller, which causes SCSI code to reset bus.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C1750A&quot;</span><span class="p">,</span> <span class="s">&quot;3226&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* scanjet iic */</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C1790A&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* scanjet iip */</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C2500A&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>		<span class="cm">/* scanjet iicx */</span>
	<span class="p">{</span><span class="s">&quot;MEDIAVIS&quot;</span><span class="p">,</span> <span class="s">&quot;CDR-H93MV&quot;</span><span class="p">,</span> <span class="s">&quot;1.31&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;MICROTEK&quot;</span><span class="p">,</span> <span class="s">&quot;ScanMaker II&quot;</span><span class="p">,</span> <span class="s">&quot;5.61&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;MITSUMI&quot;</span><span class="p">,</span> <span class="s">&quot;CD-R CR-2201CS&quot;</span><span class="p">,</span> <span class="s">&quot;6119&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;D3856&quot;</span><span class="p">,</span> <span class="s">&quot;0009&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;QUANTUM&quot;</span><span class="p">,</span> <span class="s">&quot;LPS525S&quot;</span><span class="p">,</span> <span class="s">&quot;3110&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;QUANTUM&quot;</span><span class="p">,</span> <span class="s">&quot;PD1225S&quot;</span><span class="p">,</span> <span class="s">&quot;3110&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;QUANTUM&quot;</span><span class="p">,</span> <span class="s">&quot;FIREBALL ST4.3S&quot;</span><span class="p">,</span> <span class="s">&quot;0F0C&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;RELISYS&quot;</span><span class="p">,</span> <span class="s">&quot;Scorpio&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>
	<span class="p">{</span><span class="s">&quot;SANKYO&quot;</span><span class="p">,</span> <span class="s">&quot;CP525&quot;</span><span class="p">,</span> <span class="s">&quot;6.64&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* causes failed REQ SENSE, extra reset */</span>
	<span class="p">{</span><span class="s">&quot;TEXEL&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">,</span> <span class="s">&quot;1.06&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;transtec&quot;</span><span class="p">,</span> <span class="s">&quot;T5008&quot;</span><span class="p">,</span> <span class="s">&quot;0001&quot;</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;YAMAHA&quot;</span><span class="p">,</span> <span class="s">&quot;CDR100&quot;</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;YAMAHA&quot;</span><span class="p">,</span> <span class="s">&quot;CDR102&quot;</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;YAMAHA&quot;</span><span class="p">,</span> <span class="s">&quot;CRW8424S&quot;</span><span class="p">,</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;YAMAHA&quot;</span><span class="p">,</span> <span class="s">&quot;CRW6416S&quot;</span><span class="p">,</span> <span class="s">&quot;1.0c&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Scanner&quot;</span><span class="p">,</span> <span class="s">&quot;1.80&quot;</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* responds to all lun */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Other types of devices that have special flags.</span>
<span class="cm">	 * Note that all USB devices should have the BLIST_INQUIRY_36 flag.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="s">&quot;3PARdata&quot;</span><span class="p">,</span> <span class="s">&quot;VV&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADAPTEC&quot;</span><span class="p">,</span> <span class="s">&quot;AACRAID&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ADAPTEC&quot;</span><span class="p">,</span> <span class="s">&quot;Adaptec 5400S&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;AFT PRO&quot;</span><span class="p">,</span> <span class="s">&quot;-IX CF&quot;</span><span class="p">,</span> <span class="s">&quot;0.0&gt;&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BELKIN&quot;</span><span class="p">,</span> <span class="s">&quot;USB 2 HS-CF&quot;</span><span class="p">,</span> <span class="s">&quot;1.95&quot;</span><span class="p">,</span>  <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BROWNIE&quot;</span><span class="p">,</span> <span class="s">&quot;1200U3P&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BROWNIE&quot;</span><span class="p">,</span> <span class="s">&quot;1600U3P&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CANON&quot;</span><span class="p">,</span> <span class="s">&quot;IPUBJD&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CBOX3&quot;</span><span class="p">,</span> <span class="s">&quot;USB Storage-SMC&quot;</span><span class="p">,</span> <span class="s">&quot;300A&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CMD&quot;</span><span class="p">,</span> <span class="s">&quot;CRA-7280&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* CMD RAID Controller */</span>
	<span class="p">{</span><span class="s">&quot;CNSI&quot;</span><span class="p">,</span> <span class="s">&quot;G7324&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* Chaparral G7324 RAID */</span>
	<span class="p">{</span><span class="s">&quot;CNSi&quot;</span><span class="p">,</span> <span class="s">&quot;G8324&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* Chaparral G8324 RAID */</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;ARRAY CONTROLLER&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span> <span class="o">|</span>
		<span class="n">BLIST_MAX_512</span> <span class="o">|</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>	<span class="cm">/* Compaq RA4x00 */</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;LOGICAL VOLUME&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_MAX_512</span><span class="p">},</span> <span class="cm">/* Compaq RA4x00 */</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;CR3500&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;MSA1000&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_NOSTARTONADD</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;MSA1000 VOLUME&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_NOSTARTONADD</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;COMPAQ&quot;</span><span class="p">,</span> <span class="s">&quot;HSV110&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span> <span class="o">|</span> <span class="n">BLIST_NOSTARTONADD</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DDN&quot;</span><span class="p">,</span> <span class="s">&quot;SAN DataDirector&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DEC&quot;</span><span class="p">,</span> <span class="s">&quot;HSG80&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span> <span class="o">|</span> <span class="n">BLIST_NOSTARTONADD</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;PV660F&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;PV660F   PSEUDO&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;PSEUDO DEVICE .&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* Dell PV 530F */</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;PV530F&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;PERCRAID&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="s">&quot;RAID&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* Dell PV 650F, storage on LUN 0 */</span>
	<span class="p">{</span><span class="s">&quot;DGC&quot;</span><span class="p">,</span> <span class="s">&quot;DISK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>	<span class="cm">/* Dell PV 650F, no storage on LUN 0 */</span>
	<span class="p">{</span><span class="s">&quot;EMC&quot;</span><span class="p">,</span>  <span class="s">&quot;Invista&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;EMC&quot;</span><span class="p">,</span> <span class="s">&quot;SYMMETRIX&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span> <span class="o">|</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;EMULEX&quot;</span><span class="p">,</span> <span class="s">&quot;MD21/S2     ESDI&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;easyRAID&quot;</span><span class="p">,</span> <span class="s">&quot;16P&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;easyRAID&quot;</span><span class="p">,</span> <span class="s">&quot;X6P&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;easyRAID&quot;</span><span class="p">,</span> <span class="s">&quot;F8&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;FSC&quot;</span><span class="p">,</span> <span class="s">&quot;CentricStor&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Generic&quot;</span><span class="p">,</span> <span class="s">&quot;USB SD Reader&quot;</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Generic&quot;</span><span class="p">,</span> <span class="s">&quot;USB Storage-SMC&quot;</span><span class="p">,</span> <span class="s">&quot;0180&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Generic&quot;</span><span class="p">,</span> <span class="s">&quot;USB Storage-SMC&quot;</span><span class="p">,</span> <span class="s">&quot;0207&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;DF400&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;DF500&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;DISK-SUBSYSTEM&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;OPEN-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;OP-C-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;3380-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;3390-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;6586-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;6588-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;A6189A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>	<span class="cm">/* HP VA7400 */</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;OPEN-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span> <span class="cm">/* HP XP Arrays */</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;NetRAID-4M&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;HSV100&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span> <span class="o">|</span> <span class="n">BLIST_NOSTARTONADD</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C1557A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C3323-300&quot;</span><span class="p">,</span> <span class="s">&quot;4269&quot;</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;C5713A&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;DF400&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;DF500&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;DF600&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;OP-C-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;3380-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;3390-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;6586-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;HP&quot;</span><span class="p">,</span> <span class="s">&quot;6588-&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;AuSaV1S2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;ProFibre 4000R&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;2105&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_RETRY_HWERROR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;iomega&quot;</span><span class="p">,</span> <span class="s">&quot;jaz 1GB&quot;</span><span class="p">,</span> <span class="s">&quot;J.86&quot;</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span> <span class="o">|</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IOMEGA&quot;</span><span class="p">,</span> <span class="s">&quot;ZIP&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span> <span class="o">|</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IOMEGA&quot;</span><span class="p">,</span> <span class="s">&quot;Io20S         *F&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_KEY</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;INSITE&quot;</span><span class="p">,</span> <span class="s">&quot;Floptical   F*8I&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_KEY</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;INSITE&quot;</span><span class="p">,</span> <span class="s">&quot;I325VM&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_KEY</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;iRiver&quot;</span><span class="p">,</span> <span class="s">&quot;iFP Mass Driver&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOT_LOCKABLE</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;LASOUND&quot;</span><span class="p">,</span> <span class="s">&quot;CDX7405&quot;</span><span class="p">,</span> <span class="s">&quot;3.10&quot;</span><span class="p">,</span> <span class="n">BLIST_MAX5LUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MATSHITA&quot;</span><span class="p">,</span> <span class="s">&quot;PD-1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MATSHITA&quot;</span><span class="p">,</span> <span class="s">&quot;DMC-LC5&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOT_LOCKABLE</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MATSHITA&quot;</span><span class="p">,</span> <span class="s">&quot;DMC-LC40&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOT_LOCKABLE</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Medion&quot;</span><span class="p">,</span> <span class="s">&quot;Flash XL  MMC/SD&quot;</span><span class="p">,</span> <span class="s">&quot;2.6D&quot;</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MegaRAID&quot;</span><span class="p">,</span> <span class="s">&quot;LD&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MICROP&quot;</span><span class="p">,</span> <span class="s">&quot;4110&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MYLEX&quot;</span><span class="p">,</span> <span class="s">&quot;DACARMRB&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;nCipher&quot;</span><span class="p">,</span> <span class="s">&quot;Fastness Crypto&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NAKAMICH&quot;</span><span class="p">,</span> <span class="s">&quot;MJ-4.8S&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NAKAMICH&quot;</span><span class="p">,</span> <span class="s">&quot;MJ-5.16S&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;PD-1 ODX654P&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;iStorage&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NRC&quot;</span><span class="p">,</span> <span class="s">&quot;MBR-7&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NRC&quot;</span><span class="p">,</span> <span class="s">&quot;MBR-7.4&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PIONEER&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM DRM-600&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PIONEER&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM DRM-602X&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PIONEER&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM DRM-604X&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;PIONEER&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM DRM-624X&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Promise&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;QUANTUM&quot;</span><span class="p">,</span> <span class="s">&quot;XP34301&quot;</span><span class="p">,</span> <span class="s">&quot;1071&quot;</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;REGAL&quot;</span><span class="p">,</span> <span class="s">&quot;CDC-4X&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_MAX5LUN</span> <span class="o">|</span> <span class="n">BLIST_SINGLELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SanDisk&quot;</span><span class="p">,</span> <span class="s">&quot;ImageMate CF-SD1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SEAGATE&quot;</span><span class="p">,</span> <span class="s">&quot;ST34555N&quot;</span><span class="p">,</span> <span class="s">&quot;0930&quot;</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span><span class="p">},</span>	<span class="cm">/* Chokes on tagged INQUIRY */</span>
	<span class="p">{</span><span class="s">&quot;SEAGATE&quot;</span><span class="p">,</span> <span class="s">&quot;ST3390N&quot;</span><span class="p">,</span> <span class="s">&quot;9546&quot;</span><span class="p">,</span> <span class="n">BLIST_NOTQ</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;RAID3&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;RAID5&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;TP9100&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_REPORTLUN2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SGI&quot;</span><span class="p">,</span> <span class="s">&quot;Universal Xport&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_NO_ULD_ATTACH</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="s">&quot;Universal Xport&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_NO_ULD_ATTACH</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;Universal Xport&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_NO_ULD_ATTACH</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DELL&quot;</span><span class="p">,</span> <span class="s">&quot;Universal Xport&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_NO_ULD_ATTACH</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SMSC&quot;</span><span class="p">,</span> <span class="s">&quot;USB 2 HS-CF&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM CDU-8001&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_BORKEN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SONY&quot;</span><span class="p">,</span> <span class="s">&quot;TSL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span><span class="p">},</span>		<span class="cm">/* DDS3 &amp; DDS4 autoloaders */</span>
	<span class="p">{</span><span class="s">&quot;ST650211&quot;</span><span class="p">,</span> <span class="s">&quot;CF&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_RETRY_HWERROR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;T300&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;SUN&quot;</span><span class="p">,</span> <span class="s">&quot;T4&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TEXEL&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">,</span> <span class="s">&quot;1.06&quot;</span><span class="p">,</span> <span class="n">BLIST_BORKEN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Tornado-&quot;</span><span class="p">,</span> <span class="s">&quot;F4&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TOSHIBA&quot;</span><span class="p">,</span> <span class="s">&quot;CDROM&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_ISROM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;TOSHIBA&quot;</span><span class="p">,</span> <span class="s">&quot;CD-ROM&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_ISROM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Traxdata&quot;</span><span class="p">,</span> <span class="s">&quot;CDR4120&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOLUN</span><span class="p">},</span>	<span class="cm">/* locks up */</span>
	<span class="p">{</span><span class="s">&quot;USB2.0&quot;</span><span class="p">,</span> <span class="s">&quot;SMARTMEDIA/XD&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_FORCELUN</span> <span class="o">|</span> <span class="n">BLIST_INQUIRY_36</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;WangDAT&quot;</span><span class="p">,</span> <span class="s">&quot;Model 2600&quot;</span><span class="p">,</span> <span class="s">&quot;01.7&quot;</span><span class="p">,</span> <span class="n">BLIST_SELECT_NO_ATN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;WangDAT&quot;</span><span class="p">,</span> <span class="s">&quot;Model 3200&quot;</span><span class="p">,</span> <span class="s">&quot;02.2&quot;</span><span class="p">,</span> <span class="n">BLIST_SELECT_NO_ATN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;WangDAT&quot;</span><span class="p">,</span> <span class="s">&quot;Model 1300&quot;</span><span class="p">,</span> <span class="s">&quot;02.4&quot;</span><span class="p">,</span> <span class="n">BLIST_SELECT_NO_ATN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;WDC WD25&quot;</span><span class="p">,</span> <span class="s">&quot;00JB-00FUA0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_NOREPORTLUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;XYRATEX&quot;</span><span class="p">,</span> <span class="s">&quot;RS&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span> <span class="o">|</span> <span class="n">BLIST_LARGELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Zzyzx&quot;</span><span class="p">,</span> <span class="s">&quot;RocketStor 500S&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Zzyzx&quot;</span><span class="p">,</span> <span class="s">&quot;RocketStor 2000&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BLIST_SPARSELUN</span><span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="nf">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_dev_info_list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">devinfo_table</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * scsi_strcpy_devinfo: called from scsi_dev_info_list_add to copy into</span>
<span class="cm"> * devinfo vendor and model strings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_strcpy_devinfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">to_length</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">compatible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">from_length</span><span class="p">;</span>

	<span class="n">from_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">to_length</span><span class="p">,</span> <span class="n">from_length</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from_length</span> <span class="o">&lt;</span> <span class="n">to_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compatible</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * NUL terminate the string if it is short.</span>
<span class="cm">			 */</span>
			<span class="n">to</span><span class="p">[</span><span class="n">from_length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* </span>
<span class="cm">			 * space pad the string if it is short. </span>
<span class="cm">			 */</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to</span><span class="p">[</span><span class="n">from_length</span><span class="p">],</span> <span class="n">spaces</span><span class="p">,</span>
				<span class="n">to_length</span> <span class="o">-</span> <span class="n">from_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from_length</span> <span class="o">&gt;</span> <span class="n">to_length</span><span class="p">)</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s string &#39;%s&#39; is too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_list_add - add one dev_info list entry.</span>
<span class="cm"> * @compatible: if true, null terminate short strings.  Otherwise space pad.</span>
<span class="cm"> * @vendor:	vendor string</span>
<span class="cm"> * @model:	model (product) string</span>
<span class="cm"> * @strflags:	integer string</span>
<span class="cm"> * @flags:	if strflags NULL, use this flag value</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	Create and add one dev_info entry for @vendor, @model, @strflags or</span>
<span class="cm"> * 	@flag. If @compatible, add to the tail of the list, do not space</span>
<span class="cm"> * 	pad, and set devinfo-&gt;compatible. The scsi_static_device_list entries</span>
<span class="cm"> * 	are added with @compatible 1 and @clfags NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 OK, -error on failure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_dev_info_list_add</span><span class="p">(</span><span class="kt">int</span> <span class="n">compatible</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">strflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scsi_dev_info_list_add_keyed</span><span class="p">(</span><span class="n">compatible</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
					    <span class="n">strflags</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
					    <span class="n">SCSI_DEVINFO_GLOBAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_list_add_keyed - add one dev_info list entry.</span>
<span class="cm"> * @compatible: if true, null terminate short strings.  Otherwise space pad.</span>
<span class="cm"> * @vendor:	vendor string</span>
<span class="cm"> * @model:	model (product) string</span>
<span class="cm"> * @strflags:	integer string</span>
<span class="cm"> * @flags:	if strflags NULL, use this flag value</span>
<span class="cm"> * @key:	specify list to use</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	Create and add one dev_info entry for @vendor, @model,</span>
<span class="cm"> * 	@strflags or @flag in list specified by @key. If @compatible,</span>
<span class="cm"> * 	add to the tail of the list, do not space pad, and set</span>
<span class="cm"> * 	devinfo-&gt;compatible. The scsi_static_device_list entries are</span>
<span class="cm"> * 	added with @compatible 1 and @clfags NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 OK, -error on failure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">scsi_dev_info_list_add_keyed</span><span class="p">(</span><span class="kt">int</span> <span class="n">compatible</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">strflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">);</span>

	<span class="n">devinfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_strcpy_devinfo</span><span class="p">(</span><span class="s">&quot;vendor&quot;</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">),</span>
			    <span class="n">vendor</span><span class="p">,</span> <span class="n">compatible</span><span class="p">);</span>
	<span class="n">scsi_strcpy_devinfo</span><span class="p">(</span><span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">),</span>
			    <span class="n">model</span><span class="p">,</span> <span class="n">compatible</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strflags</span><span class="p">)</span>
		<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">strflags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">compatible</span> <span class="o">=</span> <span class="n">compatible</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">compatible</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_dev_info_list_add_keyed</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_list_del_keyed - remove one dev_info list entry.</span>
<span class="cm"> * @vendor:	vendor string</span>
<span class="cm"> * @model:	model (product) string</span>
<span class="cm"> * @key:	specify list to use</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	Remove and destroy one dev_info entry for @vendor, @model</span>
<span class="cm"> * 	in list specified by @key.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 OK, -error on failure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">scsi_dev_info_list_del_keyed</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span> <span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">devinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">,</span>
			    <span class="n">dev_info_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">compatible</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Behave like the older version of get_device_flags.</span>
<span class="cm">			 */</span>
			<span class="kt">size_t</span> <span class="n">max</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX why skip leading spaces? If an odd INQUIRY</span>
<span class="cm">			 * value, that should have been part of the</span>
<span class="cm">			 * scsi_static_device_list[] entry, such as &quot;  FOO&quot;</span>
<span class="cm">			 * rather than &quot;FOO&quot;. Since this code is already</span>
<span class="cm">			 * here, and we don&#39;t know what device it is</span>
<span class="cm">			 * trying to work with, leave it as-is.</span>
<span class="cm">			 */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* max length of vendor */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">vendor</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max</span><span class="o">--</span><span class="p">;</span>
				<span class="n">vendor</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX removing the following strlen() would be</span>
<span class="cm">			 * good, using it means that for a an entry not in</span>
<span class="cm">			 * the list, we scan every byte of every vendor</span>
<span class="cm">			 * listed in scsi_static_device_list[], and never match</span>
<span class="cm">			 * a single one (and still have to compare at</span>
<span class="cm">			 * least the first byte of each vendor).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip spaces again.</span>
<span class="cm">			 */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* max length of model */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">model</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max</span><span class="o">--</span><span class="p">;</span>
				<span class="n">model</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
				   <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">devinfo</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			     <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)))</span>
				<span class="n">found</span> <span class="o">=</span> <span class="n">devinfo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">found</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">found</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_dev_info_list_del_keyed</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_list_add_str - parse dev_list and add to the scsi_dev_info_list.</span>
<span class="cm"> * @dev_list:	string of device flags to add</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	Parse dev_list, and add entries to the scsi_dev_info_list.</span>
<span class="cm"> * 	dev_list is of the form &quot;vendor:product:flag,vendor:product:flag&quot;.</span>
<span class="cm"> * 	dev_list is modified via strsep. Can be called for command line</span>
<span class="cm"> * 	addition, for proc or mabye a sysfs interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if OK, -error on failure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_dev_info_list_add_str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dev_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">strflags</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">next_check</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">dev_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore both the leading and trailing quote.</span>
<span class="cm">		 */</span>
		<span class="n">next</span><span class="o">++</span><span class="p">;</span>
		<span class="n">next_check</span> <span class="o">=</span> <span class="s">&quot;,</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">next_check</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the leading and trailing &#39;&quot;&#39; case, the for loop comes</span>
<span class="cm">	 * through the last time with vendor[0] == &#39;\0&#39;.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span> <span class="n">vendor</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vendor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
	     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="n">vendor</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strflags</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="p">)</span>
			<span class="n">strflags</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">next_check</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span> <span class="o">||</span> <span class="o">!</span><span class="n">strflags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bad dev info string &#39;%s&#39; &#39;%s&#39;&quot;</span>
			       <span class="s">&quot; &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
			       <span class="n">strflags</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">scsi_dev_info_list_add</span><span class="p">(</span><span class="mi">0</span> <span class="cm">/* compatible */</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span>
						     <span class="n">model</span><span class="p">,</span> <span class="n">strflags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_device_flags - get device specific flags from the dynamic device list.</span>
<span class="cm"> * @sdev:       &amp;scsi_device to get flags for</span>
<span class="cm"> * @vendor:	vendor name</span>
<span class="cm"> * @model:	model name</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Search the global scsi_dev_info_list (specified by list zero)</span>
<span class="cm"> *     for an entry matching @vendor and @model, if found, return the</span>
<span class="cm"> *     matching flags value, else return the host or global default</span>
<span class="cm"> *     settings.  Called during scan time.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">scsi_get_device_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scsi_get_device_flags_keyed</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
					   <span class="n">SCSI_DEVINFO_GLOBAL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * scsi_get_device_flags_keyed - get device specific flags from the dynamic device list</span>
<span class="cm"> * @sdev:       &amp;scsi_device to get flags for</span>
<span class="cm"> * @vendor:	vendor name</span>
<span class="cm"> * @model:	model name</span>
<span class="cm"> * @key:	list to look up</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Search the scsi_dev_info_list specified by @key for an entry</span>
<span class="cm"> *     matching @vendor and @model, if found, return the matching</span>
<span class="cm"> *     flags value, else return the host or global default settings.</span>
<span class="cm"> *     Called during scan time.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">scsi_get_device_flags_keyed</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span><span class="p">;</span>

	<span class="n">devinfo_table</span> <span class="o">=</span> <span class="n">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">devinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">,</span>
			    <span class="n">dev_info_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">compatible</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Behave like the older version of get_device_flags.</span>
<span class="cm">			 */</span>
			<span class="kt">size_t</span> <span class="n">max</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX why skip leading spaces? If an odd INQUIRY</span>
<span class="cm">			 * value, that should have been part of the</span>
<span class="cm">			 * scsi_static_device_list[] entry, such as &quot;  FOO&quot;</span>
<span class="cm">			 * rather than &quot;FOO&quot;. Since this code is already</span>
<span class="cm">			 * here, and we don&#39;t know what device it is</span>
<span class="cm">			 * trying to work with, leave it as-is.</span>
<span class="cm">			 */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* max length of vendor */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">vendor</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max</span><span class="o">--</span><span class="p">;</span>
				<span class="n">vendor</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX removing the following strlen() would be</span>
<span class="cm">			 * good, using it means that for a an entry not in</span>
<span class="cm">			 * the list, we scan every byte of every vendor</span>
<span class="cm">			 * listed in scsi_static_device_list[], and never match</span>
<span class="cm">			 * a single one (and still have to compare at</span>
<span class="cm">			 * least the first byte of each vendor).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip spaces again.</span>
<span class="cm">			 */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* max length of model */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">model</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max</span><span class="o">--</span><span class="p">;</span>
				<span class="n">model</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
				   <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			     <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* nothing found, return nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="n">SCSI_DEVINFO_GLOBAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* except for the global list, where we have an exception */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_bflags</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_bflags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scsi_default_dev_flags</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_get_device_flags_keyed</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SCSI_PROC_FS</span>
<span class="k">struct</span> <span class="n">double_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bottom</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">devinfo_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">double_list</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">list_entry</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="o">*</span><span class="n">devinfo</span> <span class="o">=</span>
		<span class="n">list_entry</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list</span><span class="p">,</span>
			   <span class="n">dev_info_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">&amp;&amp;</span>
	    <span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%s]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;&#39;%.8s&#39; &#39;%.16s&#39; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">devinfo_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">double_list</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dl</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_dev_info_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span><span class="p">,</span>
				   <span class="n">node</span><span class="p">);</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">dl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">devinfo_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">double_list</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">list_entry</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="o">++*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span> <span class="o">==</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">scsi_dev_info_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dl</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devinfo_table</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dl</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span><span class="p">,</span>
					   <span class="n">node</span><span class="p">);</span>
		<span class="n">dl</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devinfo_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">scsi_devinfo_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">devinfo_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">devinfo_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">devinfo_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">devinfo_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_scsi_devinfo_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_devinfo_seq_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * proc_scsi_dev_info_write - allow additions to scsi_dev_info_list via /proc.</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Adds a black/white list entry for vendor and model with an</span>
<span class="cm"> * integer value of flag to the scsi device info list.</span>
<span class="cm"> * To use, echo &quot;vendor:model:flag&quot; &gt; /proc/scsi/device_info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">proc_scsi_devinfo_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="n">length</span><span class="o">&gt;</span><span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_dev_info_list_add_str</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">scsi_devinfo_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_scsi_devinfo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_scsi_devinfo_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SCSI_PROC_FS */</span><span class="cp"></span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">dev_flags</span><span class="p">,</span> <span class="n">scsi_dev_flags</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scsi_dev_flags</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dev_flags</span><span class="p">,</span>
	 <span class="s">&quot;Given scsi_dev_flags=vendor:model:flags[,v:m:f] add black/white&quot;</span>
	 <span class="s">&quot; list entries for vendor and model with an integer value of flags&quot;</span>
	 <span class="s">&quot; to the scsi device info list&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">default_dev_flags</span><span class="p">,</span> <span class="n">scsi_default_dev_flags</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">default_dev_flags</span><span class="p">,</span>
		 <span class="s">&quot;scsi default device flag integer value&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_exit_devinfo - remove /proc/scsi/device_info &amp; the scsi_dev_info_list</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">scsi_exit_devinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_PROC_FS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;scsi/device_info&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">scsi_dev_info_remove_list</span><span class="p">(</span><span class="n">SCSI_DEVINFO_GLOBAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_add_list - add a new devinfo list</span>
<span class="cm"> * @key:	key of the list to add</span>
<span class="cm"> * @name:	Name of the list to add (for /proc/scsi/device_info)</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the requested list, returns zero on success, -EEXIST if the</span>
<span class="cm"> * key is already registered to a list, or other error on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">scsi_dev_info_add_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">))</span>
		<span class="cm">/* list already exists */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="n">devinfo_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devinfo_table</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devinfo_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">);</span>
	<span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_dev_info_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_dev_info_add_list</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_dev_info_remove_list - destroy an added devinfo list</span>
<span class="cm"> * @key: key of the list to destroy</span>
<span class="cm"> *</span>
<span class="cm"> * Iterates over the entire list first, freeing all the values, then</span>
<span class="cm"> * frees the list itself.  Returns 0 on success or -EINVAL if the key</span>
<span class="cm"> * can&#39;t be found.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">scsi_dev_info_remove_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">,</span> <span class="o">*</span><span class="n">lh_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_dev_info_list_table</span> <span class="o">*</span><span class="n">devinfo_table</span> <span class="o">=</span>
		<span class="n">scsi_devinfo_lookup_by_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">))</span>
		<span class="cm">/* no such list */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* remove from the master list */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="n">lh_next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo_table</span><span class="o">-&gt;</span><span class="n">scsi_dev_info_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_dev_info_list</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">;</span>

		<span class="n">devinfo</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_dev_info_list</span><span class="p">,</span>
				     <span class="n">dev_info_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devinfo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">devinfo_table</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_dev_info_remove_list</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_init_devinfo - set up the dynamic device list.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	Add command line entries from scsi_dev_flags, then add</span>
<span class="cm"> * 	scsi_static_device_list entries to the scsi device info list.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">scsi_init_devinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_PROC_FS</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_dev_info_add_list</span><span class="p">(</span><span class="n">SCSI_DEVINFO_GLOBAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_dev_info_list_add_str</span><span class="p">(</span><span class="n">scsi_dev_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scsi_static_device_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_dev_info_list_add</span><span class="p">(</span><span class="mi">1</span> <span class="cm">/* compatibile */</span><span class="p">,</span>
				<span class="n">scsi_static_device_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
				<span class="n">scsi_static_device_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span>
				<span class="n">scsi_static_device_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_PROC_FS</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;scsi/device_info&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_devinfo_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SCSI_PROC_FS */</span><span class="cp"></span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">scsi_exit_devinfo</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
