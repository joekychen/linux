<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › 3w-xxxx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>3w-xxxx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* </span>
<span class="cm">   3w-xxxx.c -- 3ware Storage Controller device driver for Linux.</span>

<span class="cm">   Written By: Adam Radford &lt;linuxraid@lsi.com&gt;</span>
<span class="cm">   Modifications By: Joel Jacobson &lt;linux@3ware.com&gt;</span>
<span class="cm">   		     Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm">                     Brad Strand &lt;linux@3ware.com&gt;</span>

<span class="cm">   Copyright (C) 1999-2010 3ware Inc.</span>

<span class="cm">   Kernel compatibility By: 	Andre Hedrick &lt;andre@suse.com&gt;</span>
<span class="cm">   Non-Copyright (C) 2000	Andre Hedrick &lt;andre@suse.com&gt;</span>
<span class="cm">   </span>
<span class="cm">   Further tiny build fixes and trivial hoovering    Alan Cox</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; version 2 of the License.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,           </span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of            </span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             </span>
<span class="cm">   GNU General Public License for more details.                              </span>

<span class="cm">   NO WARRANTY                                                               </span>
<span class="cm">   THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        </span>
<span class="cm">   CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      </span>
<span class="cm">   LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      </span>
<span class="cm">   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    </span>
<span class="cm">   solely responsible for determining the appropriateness of using and       </span>
<span class="cm">   distributing the Program and assumes all risks associated with its        </span>
<span class="cm">   exercise of rights under this Agreement, including but not limited to     </span>
<span class="cm">   the risks and costs of program errors, damage to or loss of data,         </span>
<span class="cm">   programs or equipment, and unavailability or interruption of operations.  </span>

<span class="cm">   DISCLAIMER OF LIABILITY                                                   </span>
<span class="cm">   NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   </span>
<span class="cm">   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        </span>
<span class="cm">   DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   </span>
<span class="cm">   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     </span>
<span class="cm">   TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    </span>
<span class="cm">   USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  </span>
<span class="cm">   HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             </span>

<span class="cm">   You should have received a copy of the GNU General Public License         </span>
<span class="cm">   along with this program; if not, write to the Free Software               </span>
<span class="cm">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA </span>

<span class="cm">   Bugs/Comments/Suggestions should be mailed to:                            </span>
<span class="cm">   linuxraid@lsi.com</span>

<span class="cm">   For more information, goto:</span>
<span class="cm">   http://www.lsi.com</span>

<span class="cm">   History</span>
<span class="cm">   -------</span>
<span class="cm">   0.1.000 -     Initial release.</span>
<span class="cm">   0.4.000 -     Added support for Asynchronous Event Notification through</span>
<span class="cm">                 ioctls for 3DM.</span>
<span class="cm">   1.0.000 -     Added DPO &amp; FUA bit support for WRITE_10 &amp; WRITE_6 cdb</span>
<span class="cm">                 to disable drive write-cache before writes.</span>
<span class="cm">   1.1.000 -     Fixed performance bug with DPO &amp; FUA not existing for WRITE_6.</span>
<span class="cm">   1.2.000 -     Added support for clean shutdown notification/feature table.</span>
<span class="cm">   1.02.00.001 - Added support for full command packet posts through ioctls</span>
<span class="cm">                 for 3DM.</span>
<span class="cm">                 Bug fix so hot spare drives don&#39;t show up.</span>
<span class="cm">   1.02.00.002 - Fix bug with tw_setfeature() call that caused oops on some</span>
<span class="cm">                 systems.</span>
<span class="cm">   08/21/00    - release previously allocated resources on failure at</span>
<span class="cm">                 tw_allocate_memory (acme)</span>
<span class="cm">   1.02.00.003 - Fix tw_interrupt() to report error to scsi layer when</span>
<span class="cm">                 controller status is non-zero.</span>
<span class="cm">                 Added handling of request_sense opcode.</span>
<span class="cm">                 Fix possible null pointer dereference in </span>
<span class="cm">                 tw_reset_device_extension()</span>
<span class="cm">   1.02.00.004 - Add support for device id of 3ware 7000 series controllers.</span>
<span class="cm">                 Make tw_setfeature() call with interrupts disabled.</span>
<span class="cm">                 Register interrupt handler before enabling interrupts.</span>
<span class="cm">                 Clear attention interrupt before draining aen queue.</span>
<span class="cm">   1.02.00.005 - Allocate bounce buffers and custom queue depth for raid5 for</span>
<span class="cm">                 6000 and 5000 series controllers.</span>
<span class="cm">                 Reduce polling mdelays causing problems on some systems.</span>
<span class="cm">                 Fix use_sg = 1 calculation bug.</span>
<span class="cm">                 Check for scsi_register returning NULL.</span>
<span class="cm">                 Add aen count to /proc/scsi/3w-xxxx.</span>
<span class="cm">                 Remove aen code unit masking in tw_aen_complete().</span>
<span class="cm">   1.02.00.006 - Remove unit from printk in tw_scsi_eh_abort(), causing</span>
<span class="cm">                 possible oops.</span>
<span class="cm">                 Fix possible null pointer dereference in tw_scsi_queue()</span>
<span class="cm">                 if done function pointer was invalid.</span>
<span class="cm">   1.02.00.007 - Fix possible null pointer dereferences in tw_ioctl().</span>
<span class="cm">                 Remove check for invalid done function pointer from</span>
<span class="cm">                 tw_scsi_queue().</span>
<span class="cm">   1.02.00.008 - Set max sectors per io to TW_MAX_SECTORS in tw_findcards().</span>
<span class="cm">                 Add tw_decode_error() for printing readable error messages.</span>
<span class="cm">                 Print some useful information on certain aen codes.</span>
<span class="cm">                 Add tw_decode_bits() for interpreting status register output.</span>
<span class="cm">                 Make scsi_set_pci_device() for kernels &gt;= 2.4.4</span>
<span class="cm">                 Fix bug where aen&#39;s could be lost before a reset.</span>
<span class="cm">                 Re-add spinlocks in tw_scsi_detect().</span>
<span class="cm">                 Fix possible null pointer dereference in tw_aen_drain_queue()</span>
<span class="cm">                 during initialization.</span>
<span class="cm">                 Clear pci parity errors during initialization and during io.</span>
<span class="cm">   1.02.00.009 - Remove redundant increment in tw_state_request_start().</span>
<span class="cm">                 Add ioctl support for direct ATA command passthru.</span>
<span class="cm">                 Add entire aen code string list.</span>
<span class="cm">   1.02.00.010 - Cleanup queueing code, fix jbod thoughput.</span>
<span class="cm">                 Fix get_param for specific units.</span>
<span class="cm">   1.02.00.011 - Fix bug in tw_aen_complete() where aen&#39;s could be lost.</span>
<span class="cm">                 Fix tw_aen_drain_queue() to display useful info at init.</span>
<span class="cm">                 Set tw_host-&gt;max_id for 12 port cards.</span>
<span class="cm">                 Add ioctl support for raw command packet post from userspace</span>
<span class="cm">                 with sglist fragments (parameter and io).</span>
<span class="cm">   1.02.00.012 - Fix read capacity to under report by 1 sector to fix get</span>
<span class="cm">                 last sector ioctl.</span>
<span class="cm">   1.02.00.013 - Fix bug where more AEN codes weren&#39;t coming out during</span>
<span class="cm">                 driver initialization.</span>
<span class="cm">                 Improved handling of PCI aborts.</span>
<span class="cm">   1.02.00.014 - Fix bug in tw_findcards() where AEN code could be lost.</span>
<span class="cm">                 Increase timeout in tw_aen_drain_queue() to 30 seconds.</span>
<span class="cm">   1.02.00.015 - Re-write raw command post with data ioctl method.</span>
<span class="cm">                 Remove raid5 bounce buffers for raid5 for 6XXX for kernel 2.5</span>
<span class="cm">                 Add tw_map/unmap_scsi_sg/single_data() for kernel 2.5</span>
<span class="cm">                 Replace io_request_lock with host_lock for kernel 2.5</span>
<span class="cm">                 Set max_cmd_len to 16 for 3dm for kernel 2.5</span>
<span class="cm">   1.02.00.016 - Set host-&gt;max_sectors back up to 256.</span>
<span class="cm">   1.02.00.017 - Modified pci parity error handling/clearing from config space</span>
<span class="cm">                 during initialization.</span>
<span class="cm">   1.02.00.018 - Better handling of request sense opcode and sense information</span>
<span class="cm">                 for failed commands.  Add tw_decode_sense().</span>
<span class="cm">                 Replace all mdelay()&#39;s with scsi_sleep().</span>
<span class="cm">   1.02.00.019 - Revert mdelay&#39;s and scsi_sleep&#39;s, this caused problems on</span>
<span class="cm">                 some SMP systems.</span>
<span class="cm">   1.02.00.020 - Add pci_set_dma_mask(), rewrite kmalloc()/virt_to_bus() to</span>
<span class="cm">                 pci_alloc/free_consistent().</span>
<span class="cm">                 Better alignment checking in tw_allocate_memory().</span>
<span class="cm">                 Cleanup tw_initialize_device_extension().</span>
<span class="cm">   1.02.00.021 - Bump cmd_per_lun in SHT to 255 for better jbod performance.</span>
<span class="cm">                 Improve handling of errors in tw_interrupt().</span>
<span class="cm">                 Add handling/clearing of controller queue error.</span>
<span class="cm">                 Empty stale responses before draining aen queue.</span>
<span class="cm">                 Fix tw_scsi_eh_abort() to not reset on every io abort.</span>
<span class="cm">                 Set can_queue in SHT to 255 to prevent hang from AEN.</span>
<span class="cm">   1.02.00.022 - Fix possible null pointer dereference in tw_scsi_release().</span>
<span class="cm">   1.02.00.023 - Fix bug in tw_aen_drain_queue() where unit # was always zero.</span>
<span class="cm">   1.02.00.024 - Add severity levels to AEN strings.</span>
<span class="cm">   1.02.00.025 - Fix command interrupt spurious error messages.</span>
<span class="cm">                 Fix bug in raw command post with data ioctl method.</span>
<span class="cm">                 Fix bug where rollcall sometimes failed with cable errors.</span>
<span class="cm">                 Print unit # on all command timeouts.</span>
<span class="cm">   1.02.00.026 - Fix possible infinite retry bug with power glitch induced</span>
<span class="cm">                 drive timeouts.</span>
<span class="cm">                 Cleanup some AEN severity levels.</span>
<span class="cm">   1.02.00.027 - Add drive not supported AEN code for SATA controllers.</span>
<span class="cm">                 Remove spurious unknown ioctl error message.</span>
<span class="cm">   1.02.00.028 - Fix bug where multiple controllers with no units were the</span>
<span class="cm">                 same card number.</span>
<span class="cm">                 Fix bug where cards were being shut down more than once.</span>
<span class="cm">   1.02.00.029 - Add missing pci_free_consistent() in tw_allocate_memory().</span>
<span class="cm">                 Replace pci_map_single() with pci_map_page() for highmem.</span>
<span class="cm">                 Check for tw_setfeature() failure.</span>
<span class="cm">   1.02.00.030 - Make driver 64-bit clean.</span>
<span class="cm">   1.02.00.031 - Cleanup polling timeouts/routines in several places.</span>
<span class="cm">                 Add support for mode sense opcode.</span>
<span class="cm">                 Add support for cache mode page.</span>
<span class="cm">                 Add support for synchronize cache opcode.</span>
<span class="cm">   1.02.00.032 - Fix small multicard rollcall bug.</span>
<span class="cm">                 Make driver stay loaded with no units for hot add/swap.</span>
<span class="cm">                 Add support for &quot;twe&quot; character device for ioctls.</span>
<span class="cm">                 Clean up request_id queueing code.</span>
<span class="cm">                 Fix tw_scsi_queue() spinlocks.</span>
<span class="cm">   1.02.00.033 - Fix tw_aen_complete() to not queue &#39;queue empty&#39; AEN&#39;s.</span>
<span class="cm">                 Initialize queues correctly when loading with no valid units.</span>
<span class="cm">   1.02.00.034 - Fix tw_decode_bits() to handle multiple errors.</span>
<span class="cm">                 Add support for user configurable cmd_per_lun.</span>
<span class="cm">                 Add support for sht-&gt;slave_configure().</span>
<span class="cm">   1.02.00.035 - Improve tw_allocate_memory() memory allocation.</span>
<span class="cm">                 Fix tw_chrdev_ioctl() to sleep correctly.</span>
<span class="cm">   1.02.00.036 - Increase character ioctl timeout to 60 seconds.</span>
<span class="cm">   1.02.00.037 - Fix tw_ioctl() to handle all non-data ATA passthru cmds</span>
<span class="cm">                 for &#39;smartmontools&#39; support.</span>
<span class="cm">   1.26.00.038 - Roll driver minor version to 26 to denote kernel 2.6.</span>
<span class="cm">                 Add support for cmds_per_lun module parameter.</span>
<span class="cm">   1.26.00.039 - Fix bug in tw_chrdev_ioctl() polling code.</span>
<span class="cm">                 Fix data_buffer_length usage in tw_chrdev_ioctl().</span>
<span class="cm">                 Update contact information.</span>
<span class="cm">   1.26.02.000 - Convert driver to pci_driver format.</span>
<span class="cm">   1.26.02.001 - Increase max ioctl buffer size to 512 sectors.</span>
<span class="cm">                 Make tw_scsi_queue() return 0 for &#39;Unknown scsi opcode&#39;.</span>
<span class="cm">                 Fix tw_remove() to free irq handler/unregister_chrdev()</span>
<span class="cm">                 before shutting down card.</span>
<span class="cm">                 Change to new &#39;change_queue_depth&#39; api.</span>
<span class="cm">                 Fix &#39;handled=1&#39; ISR usage, remove bogus IRQ check.</span>
<span class="cm">   1.26.02.002 - Free irq handler in __tw_shutdown().</span>
<span class="cm">                 Turn on RCD bit for caching mode page.</span>
<span class="cm">                 Serialize reset code.</span>
<span class="cm">   1.26.02.003 - Force 60 second timeout default.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &quot;3w-xxxx.h&quot;</span>

<span class="cm">/* Globals */</span>
<span class="cp">#define TW_DRIVER_VERSION &quot;1.26.02.003&quot;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">tw_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_device_extension_list</span><span class="p">[</span><span class="n">TW_MAX_SLOT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tw_device_extension_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twe_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Module parameters */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;LSI&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;3ware Storage Controller Linux Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">TW_DRIVER_VERSION</span><span class="p">);</span>

<span class="cm">/* Function prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tw_reset_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">);</span>

<span class="cm">/* Functions */</span>

<span class="cm">/* This function will check the status register for unexpected bits */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_check_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_EXPECTED_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TW_STATUS_EXPECTED_BITS</span><span class="p">)</span> <span class="p">{</span>  
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_check_bits(): No expected bits (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_UNEXPECTED_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_check_bits(): Found unexpected bits (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_check_bits() */</span>

<span class="cm">/* This function will print readable messages from status register errors */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_decode_bits</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">host</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_decode_bits()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_host</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot; scsi%d:&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_PCI_PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx:%s PCI Parity Error: clearing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_PARITY_ERROR</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_PCI_ABORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx:%s PCI Abort: clearing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_PCI_ABORT</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">TW_PCI_CLEAR_PCI_ABORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_QUEUE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx:%s Controller Queue Error: clearing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_QUEUE_ERROR</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_SBUF_WRITE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx:%s SBUF Write Error: clearing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_SBUF_WRITE_ERROR</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_MICROCONTROLLER_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx:%s Microcontroller Error: clearing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_decode_bits() */</span>

<span class="cm">/* This function will poll the status register for a flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_poll_status</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="n">before</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
		<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
			<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">seconds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_poll_status() */</span>

<span class="cm">/* This function will poll the status register for disappearance of a flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_poll_status_gone</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="n">before</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
		<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
			<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">seconds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_poll_status_gone() */</span>

<span class="cm">/* This function will attempt to post a command packet to the board */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_post_command_packet</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_post_command_packet()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_post_command_packet(): Unexpected bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_COMMAND_QUEUE_FULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We successfully posted the command packet */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_POSTED</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Couldn&#39;t post the command packet, so we do it in the isr */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_PENDING</span><span class="p">;</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> 
		<span class="n">TW_UNMASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_post_command_packet() */</span>

<span class="cm">/* This function will return valid sense buffer information for failed cmds */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_decode_sense</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fill_sense</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>

        <span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_decode_sense()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Command failed: status = 0x%x, flags = 0x%x, unit #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">TW_UNIT_OUT</span><span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">unit__hostid</span><span class="p">));</span>

	<span class="cm">/* Attempt to return intelligent sense information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fill_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xc7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xcb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tw_sense_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">tw_sense_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>

					<span class="cm">/* Valid bit and &#39;current errors&#39; */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="o">|</span> <span class="mh">0x70</span><span class="p">);</span>

					<span class="cm">/* Sense key */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_sense_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

					<span class="cm">/* Additional sense length */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span> <span class="cm">/* 10 bytes */</span>

					<span class="cm">/* Additional sense code */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_sense_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

					<span class="cm">/* Additional sense code qualifier */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_sense_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>

					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">TW_ISR_DONT_RESULT</span><span class="p">;</span> <span class="cm">/* Special case for isr to not over-write result */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If no table match, error so we get a reset */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_decode_sense() */</span>

<span class="cm">/* This function will report controller error status */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_check_errors</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
  
	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TW_STATUS_ERRORS</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">)</span> <span class="o">||</span> <span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_check_errors() */</span>

<span class="cm">/* This function will empty the response que */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_empty_response_que</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="n">response_que_value</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">response_que_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* End tw_empty_response_que() */</span>

<span class="cm">/* This function will free a request_id */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_state_request_finish</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_FINISHED</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_state_request_finish() */</span>

<span class="cm">/* This function will assign an available request_id */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_state_request_start</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span><span class="p">];</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="o">*</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_STARTED</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_state_request_start() */</span>

<span class="cm">/* Show some statistics about the card */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tw_show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;3w-xxxx Driver version: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Current commands posted:   %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max commands posted:       %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Current pending commands:  %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max pending commands:      %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Last sgl length:           %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max sgl length:            %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Last sector count:         %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max sector count:          %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;SCSI Host Resets:          %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;AEN&#39;s:                     %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">TW_DRIVER_VERSION</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_show_stats() */</span>

<span class="cm">/* This function will set a devices queue depth */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue_depth</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_change_queue_depth() */</span>

<span class="cm">/* Create sysfs &#39;stats&#39; entry */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">tw_host_stats_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> 	<span class="s">&quot;stats&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">tw_show_stats</span>
<span class="p">};</span>

<span class="cm">/* Host attributes initializer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">tw_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">tw_host_stats_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This function will read the aen queue from the isr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_aen_read_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Unexpected bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="mh">0x401</span><span class="p">;</span> <span class="cm">/* AEN table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Unit code */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>

	<span class="cm">/* Now post the command packet */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_COMMAND_QUEUE_FULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Post succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Flag internal command */</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_POSTED</span><span class="p">;</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_read_queue(): Post failed, will retry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_aen_read_queue() */</span>

<span class="cm">/* This function will complete an aen request from the isr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_aen_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">table_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_complete()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_complete(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">aen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_aen_complete(): Queue&#39;d code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aen</span><span class="p">);</span>

	<span class="cm">/* Print some useful info when certain aen codes come out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aen</span> <span class="o">==</span> <span class="mh">0x0ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: AEN: INFO: AEN queue overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">table_max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tw_aen_string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">table_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">][</span><span class="n">strlen</span><span class="p">(</span><span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: AEN: %s%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">aen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aen</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> 
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: AEN: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Received AEN %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">aen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aen</span> <span class="o">!=</span> <span class="n">TW_AEN_QUEUE_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Now queue the code */</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">aen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">tw_aen_read_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Error completing AEN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
			<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_aen_complete() */</span>

<span class="cm">/* This function will drain the aen queue after a soft reset */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_aen_drain_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">table_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_poll_status</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_ATTENTION_INTERRUPT</span> <span class="o">|</span> <span class="n">TW_STATUS_MICROCONTROLLER_READY</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): No attention interrupt for card %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_device_extension_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">TW_CLEAR_ATTENTION_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Empty response queue */</span>
	<span class="n">tw_empty_response_que</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="mh">0x401</span><span class="p">;</span> <span class="cm">/* AEN table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Unit code */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>

	<span class="cm">/* Now drain the controller&#39;s aen queue */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Post command packet */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

		<span class="cm">/* Now poll for completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_poll_status_gone</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">response_queue</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_queue</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Unexpected request id */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Unexpected request id.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">TW_AEN_TABLE_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Bad response */</span>
					<span class="n">tw_decode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* We know this is a 3w-1x00, and doesn&#39;t support aen&#39;s */</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Now check the aen */</span>
			<span class="n">aen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">aen_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">);</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">aen_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">TW_AEN_QUEUE_EMPTY</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: AEN: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first_reset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TW_AEN_SOFT_RESET</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">first_reset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">first_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: AEN: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
						<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="o">++</span><span class="p">;</span>
						<span class="n">queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">aen</span> <span class="o">==</span> <span class="mh">0x0ff</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: AEN: INFO: AEN queue overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">table_max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tw_aen_string</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">table_max</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">][</span><span class="n">strlen</span><span class="p">(</span><span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: AEN: %s%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">aen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: AEN: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_aen_string</span><span class="p">[</span><span class="n">aen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Received AEN %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aen</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="o">++</span><span class="p">;</span>
					<span class="n">queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Now put the aen on the aen_queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">aen</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_aen_drain_queue(): Response never received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">finished</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_aen_drain_queue() */</span>

<span class="cm">/* This function will allocate memory */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_allocate_memory</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cpu_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_allocate_memory()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: pci_alloc_consistent() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">%</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TW_DEVICE_ID</span> <span class="o">?</span> <span class="n">TW_ALIGNMENT_6000</span> <span class="o">:</span> <span class="n">TW_ALIGNMENT_7000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Couldn&#39;t allocate correctly aligned memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TW_Q_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_allocate_memory(): case slip in tw_allocate_memory()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_allocate_memory() */</span>

<span class="cm">/* This function handles ioctl for the character device */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">tw_chrdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tw_aen_code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_buffer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_buffer_length_adjusted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">TW_New_Ioctl</span> <span class="o">*</span><span class="n">tw_ioctl</span><span class="p">;</span>
	<span class="n">TW_Passthru</span> <span class="o">*</span><span class="n">passthru</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="n">tw_device_extension_list</span><span class="p">[</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_chrdev_ioctl()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_mutex</span><span class="p">);</span>
	<span class="cm">/* Only let one of these through at a time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First copy down the buffer length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_buffer_length</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Check size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_buffer_length</span> <span class="o">&gt;</span> <span class="n">TW_MAX_IOCTL_SECTORS</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware can only do multiple of 512 byte transfers */</span>
	<span class="n">data_buffer_length_adjusted</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_buffer_length</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">511</span><span class="p">;</span>
	
	<span class="cm">/* Now allocate ioctl buf memory */</span>
	<span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_ioctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_New_Ioctl</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span><span class="p">;</span>

	<span class="cm">/* Now copy down the entire ioctl */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">data_buffer_length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">passthru</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Passthru</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">;</span>

	<span class="cm">/* See which ioctl we are doing */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TW_OP_NOP</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_OP_NOP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TW_OP_AEN_LISTEN</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_AEN_LISTEN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_buffer_length</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_tail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_aen_code</span> <span class="o">=</span> <span class="n">TW_AEN_QUEUE_EMPTY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tw_aen_code</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_aen_code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tw_aen_code</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TW_CMD_PACKET_WITH_DATA</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_CMD_PACKET_WITH_DATA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">tw_state_request_start</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>

			<span class="cm">/* Flag internal command */</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* Flag chrdev ioctl */</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>

			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>

			<span class="cm">/* Load the sg list */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">TW_SGL_OUT</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">opcode__sgloffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dma_handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">data_buffer_length_adjusted</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">byte8</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dma_handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">.</span><span class="n">byte8</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">data_buffer_length_adjusted</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">passthru</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dma_handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">passthru</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">data_buffer_length_adjusted</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command</span><span class="p">));</span>

			<span class="cm">/* Now post the command packet to the controller */</span>
			<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">timeout</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_TIMEOUT</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

			<span class="cm">/* Now wait for the command to complete */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">==</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

			<span class="cm">/* We timed out, and didn&#39;t get an interrupt */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">!=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Now we need to reset the board */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Character ioctl (0x%x) timed out, resetting card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_reset_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_chrdev_ioctl(): Reset failed for card %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Now copy in the command packet response */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">),</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command</span><span class="p">));</span>

			<span class="cm">/* Now complete the io */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
			<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now copy the response to userspace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">tw_ioctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_buffer_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="cm">/* Now free ioctl buf memory */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TW_New_Ioctl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_chrdev_ioctl() */</span>

<span class="cm">/* This function handles open for the character device */</span>
<span class="cm">/* NOTE that this function races with remove. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_chrdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor_number</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_ioctl_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">minor_number</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor_number</span> <span class="o">&gt;=</span> <span class="n">tw_device_extension_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_chrdev_open() */</span>

<span class="cm">/* File operations struct for character device */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">tw_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">tw_chrdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tw_chrdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This function will free up device extension resources */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_free_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_free_device_extension()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Free command packet and generic buffer memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command</span><span class="p">)</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">)</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> <span class="cm">/* End tw_free_device_extension() */</span>

<span class="cm">/* This function will send an initconnection command to controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_initconnection</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">message_credits</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="n">TW_Command</span>  <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_initconnection()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize InitConnection command packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_initconnection(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TW_OP_INIT_CONNECTION</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">TW_INIT_COMMAND_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">message_credits</span> <span class="o">=</span> <span class="n">message_credits</span><span class="p">;</span> 
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">init_connection</span><span class="p">.</span><span class="n">response_queue_pointer</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_initconnection(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="cm">/* Send command packet to the board */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
    
	<span class="cm">/* Poll for completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_poll_status_gone</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">response_queue</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_queue</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unexpected request id */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_initconnection(): Unexpected request id.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* bad response */</span>
			<span class="n">tw_decode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_initconnection() */</span>

<span class="cm">/* Set a value in the features table */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_setfeature</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param_size</span><span class="p">,</span>
                  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">TW_Command</span>  <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>

  	<span class="cm">/* Initialize SetParam command packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_setfeature(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_SET_PARAM</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="mh">0x404</span><span class="p">;</span>  <span class="cm">/* Features table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="n">param_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">param_size</span><span class="p">);</span>

	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_setfeature(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_setfeature(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send command packet to the board */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="cm">/* Poll for completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_poll_status_gone</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">response_queue</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_queue</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* unexpected request id */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_setfeature(): Unexpected request id.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* bad response */</span>
			<span class="n">tw_decode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_setfeature() */</span>

<span class="cm">/* This function will reset a controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_reset_sequence</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Reset the board */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">TW_MAX_RESET_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_SOFT_RESET</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">tw_aen_drain_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: AEN drain failed, retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check for controller errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_errors</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Controller errors found, retrying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now the controller is in a good state */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">TW_MAX_RESET_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Controller errors, card not responding, check all cabling.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">tw_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_INIT_MESSAGE_CREDITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Connection initialization failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">tw_setfeature</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Unable to set features for card, probable old firmware or card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_reset_sequence() */</span>

<span class="cm">/* This function will initialize the fields of a device extension */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_initialize_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_initialize_device_extension()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize command packet buffers */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tw_allocate_memory</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Command packet memory allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize generic buffer */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">tw_allocate_memory</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Generic memory allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TW_Q_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_initialize_device_extension() */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_map_scsi_sg_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">use_sg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_map_scsi_sg_data()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">use_sg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_sg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_map_scsi_sg_data(): pci_map_sg() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">TW_PHASE_SGLIST</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">have_data_in</span> <span class="o">=</span> <span class="n">use_sg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">use_sg</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_map_scsi_sg_data() */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_unmap_scsi_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_unmap_scsi_data()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">TW_PHASE_SGLIST</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End tw_unmap_scsi_data() */</span>

<span class="cm">/* This function will reset a device extension */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_reset_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_reset_device_extension()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">TW_MASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Abort all requests that are in progress */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TW_Q_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_FINISHED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
		    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_INITIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_COMPLETED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">srb</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">tw_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset queues and counts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TW_Q_LENGTH</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_reset_sequence</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Reset sequence failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_reset_device_extension() */</span>

<span class="cm">/* This funciton returns unit geometry in cylinders/heads/sectors */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsi_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">;</span>
	
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_biosparam()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_biosparam(): heads = %d, sectors = %d, cylinders = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">);</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>			 
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsi_biosparam() */</span>

<span class="cm">/* This is the new scsi eh reset function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsi_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="s">&quot;WARNING: Command (0x%x) timed out, resetting card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Make sure we are not issuing an ioctl or resetting from ioctl */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>

	<span class="cm">/* Now reset the card and some of the device extension data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_reset_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsi_eh_reset() */</span>

<span class="cm">/* This function handles scsi inquiry commands */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_inquiry</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	 <span class="cm">/* unit summary table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* unitsstatus parameter */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="n">TW_MAX_UNITS</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now try to post the command packet */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_inquiry() */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_transfer_internal</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function is called by the isr to complete an inquiry command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_inquiry_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">is_unit_present</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">request_buffer</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry_complete()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TYPE_DISK</span><span class="p">;</span> <span class="cm">/* Peripheral device type */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	       <span class="cm">/* Device type modifier */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	       <span class="cm">/* No ansi/iso compliance */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>	       <span class="cm">/* Additional length */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s">&quot;3ware   &quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>	 <span class="cm">/* Vendor ID */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="s">&quot;Logical Disk %-2d &quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">TW_DRIVER_VERSION</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">tw_transfer_internal</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">request_buffer</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>

	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_inquiry_complete(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is_unit_present</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TW_UNIT_ONLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TW_ISR_DONT_RESULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_inquiry_complete() */</span>

<span class="cm">/* This function handles scsi mode_sense commands */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_mode_sense</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Only page control = 0, page code = 0x8 (cache page) supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now read firmware cache setting for this unit */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the command packet */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="n">TW_UNIT_INFORMATION_TABLE_BASE</span> <span class="o">+</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* unit flags */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now try to post the command packet */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_mode_sense() */</span>

<span class="cm">/* This function is called by the isr to complete a mode sense command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_mode_sense_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">request_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense_complete()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_mode_sense_complete(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>

	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>        <span class="cm">/* mode data length */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="cm">/* default medium type */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>       <span class="cm">/* dpo/fua support on */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="cm">/* no block descriptors */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>        <span class="cm">/* caching page */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>        <span class="cm">/* page length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">request_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>        <span class="cm">/* WCE on, RCD on */</span>
	<span class="k">else</span>
		<span class="n">request_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>        <span class="cm">/* WCE off, RCD on */</span>
	<span class="n">tw_transfer_internal</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">request_buffer</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_mode_sense_complete() */</span>

<span class="cm">/* This function handles scsi read_capacity commands */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_read_capacity</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">unit__hostid</span> <span class="o">=</span> <span class="n">TW_UNITHOST_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">block_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="n">TW_UNIT_INFORMATION_TABLE_BASE</span> <span class="o">+</span> 
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* unitcapacity parameter */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now try to post the command to the board */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_read_capacity() */</span>

<span class="cm">/* This function is called by the isr to complete a readcapacity command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_read_capacity_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity_complete()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">param_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> 
		   <span class="p">(</span><span class="n">param_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">param_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Subtract one sector to fix get last sector ioctl */</span>
	<span class="n">capacity</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Capacity = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">);</span>

	<span class="cm">/* Number of LBA&#39;s */</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Block size in bytes (512) */</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_BLOCK_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_BLOCK_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_BLOCK_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_BLOCK_SIZE</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">tw_transfer_internal</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_read_capacity_complete() */</span>

<span class="cm">/* This function handles scsi read or write commands */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_read_write</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lba</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">num_sectors</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">use_sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_write()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="n">sglist</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_write(): Request buffer NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">||</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">TW_OP_READ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">TW_OP_WRITE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">unit__hostid</span> <span class="o">=</span> <span class="n">TW_UNITHOST_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span>
			<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">||</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
  
	<span class="cm">/* Update sector statistic */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">num_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span><span class="p">)</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span><span class="p">;</span>
  
	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_write(): lba = 0x%x num_sectors = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num_sectors</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">block_count</span> <span class="o">=</span> <span class="n">num_sectors</span><span class="p">;</span>

	<span class="n">use_sg</span> <span class="o">=</span> <span class="n">tw_map_scsi_sg_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_sg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="n">sg</span><span class="p">,</span> <span class="n">use_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update SG statistics */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span><span class="p">)</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span><span class="p">;</span>

	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
      
	<span class="cm">/* Now try to post the command to the board */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_read_write() */</span>

<span class="cm">/* This function will handle the request sense scsi command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_request_sense</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">request_buffer</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_request_sense()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span> <span class="cm">/* Immediate fixed format */</span>
	<span class="n">request_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* minimum size per SPC: 18 bytes */</span>
	<span class="cm">/* leave all other fields zero, giving effectively NO_SENSE return */</span>
	<span class="n">tw_transfer_internal</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">request_buffer</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">request_buffer</span><span class="p">));</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
	<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

	<span class="cm">/* If we got a request_sense, we probably want a reset, return error */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_request_sense() */</span>

<span class="cm">/* This function will handle synchronize cache scsi command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_synchronize_cache</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_synchronize_cache()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Send firmware flush command for this unit */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the command packet */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TW_OP_FLUSH_CACHE</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">unit__hostid</span> <span class="o">=</span> <span class="n">TW_UNITHOST_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now try to post the command packet */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_synchronize_cache() */</span>

<span class="cm">/* This function will handle test unit ready scsi command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_test_unit_ready</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param_value</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now setup the param */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">));</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	 <span class="cm">/* unit summary table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* unitsstatus parameter */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="n">TW_MAX_UNITS</span><span class="p">;</span>
	<span class="n">param_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Sector</span><span class="p">);</span>
	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_physical_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command_que_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet physical address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now try to post the command packet */</span>
	<span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_test_unit_ready() */</span>

<span class="cm">/* This function is called by the isr to complete a testunitready command */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsiop_test_unit_ready_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">is_unit_present</span><span class="p">;</span>
	<span class="n">TW_Param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready_complete()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">alignment_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_scsiop_test_unit_ready_complete(): Bad alignment virtual address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is_unit_present</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TW_UNIT_ONLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">is_unit_present</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TW_ISR_DONT_RESULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsiop_test_unit_ready_complete() */</span>

<span class="cm">/* This is the main scsi queue function to handle scsi opcodes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_scsi_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* If we are resetting due to timed out ioctl, report as busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="cm">/* Save done function into Scsi_Cmnd struct */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
		 
	<span class="cm">/* Queue the command and get a request id */</span>
	<span class="n">tw_state_request_start</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>

	<span class="cm">/* Save the scsi command for use by the ISR */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>

	<span class="cm">/* Initialize phase to zero */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">TW_PHASE_INITIAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="k">case</span> <span class="n">WRITE_6</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught READ/WRITE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_read_write</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught TEST_UNIT_READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_test_unit_ready</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INQUIRY</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught INQUIRY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_inquiry</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught READ_CAPACITY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_read_capacity</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	        <span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		        <span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught REQUEST_SENSE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		        <span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_request_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		        <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODE_SENSE</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught MODE_SENSE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_mode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_scsi_queue(): caught SYNCHRONIZE_CACHE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_scsiop_synchronize_cache</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TW_IOCTL</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: SCSI_IOCTL_SEND_COMMAND deprecated, please update your 3ware tools.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: scsi%d: Unknown scsi opcode: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="o">*</span><span class="n">command</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
			<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_scsi_queue() */</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">tw_scsi_queue</span><span class="p">)</span>

<span class="cm">/* This function is the interrupt service routine */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">tw_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_que</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the host lock for io completions */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* Read the registers */</span>
	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="cm">/* Check if this is our interrupt, otherwise bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_VALID_INTERRUPT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">tw_interrupt_bail</span><span class="p">;</span>

	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If we are resetting, bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">tw_interrupt_bail</span><span class="p">;</span>

	<span class="cm">/* Check controller for errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Unexpected bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">tw_interrupt_bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle host interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_HOST_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Received host interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">TW_CLEAR_HOST_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle attention interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_ATTENTION_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Received attention interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">TW_CLEAR_ATTENTION_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="n">tw_state_request_start</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">tw_aen_read_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Error reading aen queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
			<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle command interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_COMMAND_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drain as many pending commands as we can */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Found request id that wasn&#39;t pending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If we get here, we will continue re-posting on the next command interrupt */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* If there are no more pending requests, we mask command interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
			<span class="n">TW_MASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle response interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drain the response queue from the board */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read response queue register */</span>
			<span class="n">response_que</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_que</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>
			<span class="n">command_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virtual_address</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Check for bad response */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* If internal command, don&#39;t error, don&#39;t fill sense */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw_decode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">tw_decode_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Check for correct state */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_POSTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Received a request id that wasn&#39;t posted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Response queue request id: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>

			<span class="cm">/* Check for internal command completion */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Found internally posted command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* Check for chrdev ioctl completion */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">tw_aen_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Error completing aen.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">READ_10</span>:
				<span class="k">case</span> <span class="n">READ_6</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught READ_10/READ_6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">WRITE_10</span>:
				<span class="k">case</span> <span class="n">WRITE_6</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught WRITE_10/WRITE_6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught TEST_UNIT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">tw_scsiop_test_unit_ready_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">INQUIRY</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught INQUIRY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">tw_scsiop_inquiry_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught READ_CAPACITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">tw_scsiop_read_capacity_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MODE_SENSE</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught MODE_SENSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">tw_scsiop_mode_sense_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): caught SYNCHRONIZE_CACHE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: case slip in tw_interrupt()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* If no error command was a success */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* If error, command failed */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Ask for a host reset */</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* Now complete the io */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">!=</span> <span class="n">TW_ISR_DONT_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
					<span class="n">tw_state_request_finish</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
					
					<span class="n">tw_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
				
			<span class="cm">/* Check for valid status after each drain */</span>
			<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: tw_interrupt(): Unexpected bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">tw_interrupt_bail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">tw_interrupt_bail:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End tw_interrupt() */</span>

<span class="cm">/* This function tells the controller to shut down */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tw_shutdown</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable interrupts */</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Free up the IRQ */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Shutting down host %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="cm">/* Tell the card we are shutting down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Connection shutdown failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Shutdown complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear all interrupts just before exit */</span>
	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End __tw_shutdown() */</span>

<span class="cm">/* Wrapper for __tw_shutdown */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">__tw_shutdown</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End tw_shutdown() */</span>

<span class="cm">/* This function gets called when a disk is coming online */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tw_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Force 60 second timeout */</span>
	<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_slave_configure() */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;3ware Storage Controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">tw_scsi_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">tw_scsi_eh_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">tw_scsi_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">tw_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">tw_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">TW_MAX_SGL_LENGTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="n">TW_MAX_SECTORS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="n">TW_MAX_CMDS_PER_LUN</span><span class="p">,</span>	
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">tw_host_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">emulated</span>		<span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/* This function will probe and initialize a card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tw_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to enable pci device.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TW_DMA_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to set dma mask.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Device_Extension</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to allocate memory for device extension.&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* Save values to device extension */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_initialize_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to initialize device extension.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_device_extension</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request IO regions */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;3w-xxxx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to get mem region.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_device_extension</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save base address */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to get io address.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts on the card */</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Initialize the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_reset_sequence</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_release_mem_region</span><span class="p">;</span>

	<span class="cm">/* Set host specific parameters */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">TW_MAX_UNITS</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">;</span>

	<span class="cm">/* Luns and channels aren&#39;t supported by adapter */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Register the card with the kernel SCSI layer */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi add host failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: scsi%d: Found a 3ware Storage Controller at 0x%x, IRQ: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Now setup the interrupt handler */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tw_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;3w-xxxx&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Error requesting IRQ.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_remove_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_device_extension_list</span><span class="p">[</span><span class="n">tw_device_extension_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="p">;</span>
	<span class="n">tw_device_extension_count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Re-enable interrupts on the card */</span>
	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Finally, scan the host */</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twe_major</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">twe_major</span> <span class="o">=</span> <span class="n">register_chrdev</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;twe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_fops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-xxxx: Failed to register character device.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_remove_host:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out_release_mem_region:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_free_device_extension:</span>
	<span class="n">tw_free_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_probe() */</span>

<span class="cm">/* This function is called to remove a device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tw_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Unregister character device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twe_major</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">twe_major</span><span class="p">,</span> <span class="s">&quot;twe&quot;</span><span class="p">);</span>
		<span class="n">twe_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shutdown the card */</span>
	<span class="n">__tw_shutdown</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Free up the mem region */</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Free up device extension resources */</span>
	<span class="n">tw_free_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">tw_device_extension_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End tw_remove() */</span>

<span class="cm">/* PCI Devices supported by this driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">tw_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_1000</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_7000</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tw_pci_tbl</span><span class="p">);</span>

<span class="cm">/* pci_driver initializer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tw_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;3w-xxxx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tw_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tw_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">tw_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">tw_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This function is called on driver initialization */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tw_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3ware Storage Controller device driver for Linux v%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TW_DRIVER_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End tw_init() */</span>

<span class="cm">/* This function is called on driver exit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tw_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End tw_exit() */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tw_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tw_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
