<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › fnic › fnic_fcs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fnic_fcs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Cisco Systems, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright 2007 Nuova Systems, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you may redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fip.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_els.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fcoe.h&gt;</span>
<span class="cp">#include &lt;scsi/fc_frame.h&gt;</span>
<span class="cp">#include &lt;scsi/libfc.h&gt;</span>
<span class="cp">#include &quot;fnic_io.h&quot;</span>
<span class="cp">#include &quot;fnic.h&quot;</span>
<span class="cp">#include &quot;cq_enet_desc.h&quot;</span>
<span class="cp">#include &quot;cq_exch_desc.h&quot;</span>

<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">fnic_event_queue</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fnic_set_eth_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">fnic_handle_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fnic</span><span class="p">,</span> <span class="n">link_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_link_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_link_down_cnt</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stop_rx_link_events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_link_down_cnt</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="p">;</span>
	<span class="n">old_link_status</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">vnic_dev_link_status</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span> <span class="o">=</span> <span class="n">vnic_dev_link_down_cnt</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_link_status</span> <span class="o">==</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">)</span>
			<span class="cm">/* DOWN -&gt; DOWN */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_link_down_cnt</span> <span class="o">!=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* UP -&gt; DOWN -&gt; UP */</span>
				<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host_stats</span><span class="p">.</span><span class="n">link_failure_count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
					     <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fcoe_ctlr_link_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">);</span>
				<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
					     <span class="s">&quot;link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* UP -&gt; UP */</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DOWN -&gt; UP */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot;link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* UP -&gt; DOWN */</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host_stats</span><span class="p">.</span><span class="n">link_failure_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_link_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function passes incoming fabric frames to libFC</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_handle_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fnic</span><span class="p">,</span> <span class="n">frame_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stop_rx_link_events</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re in a transitional state, just re-queue and return.</span>
<span class="cm">		 * The queue will be serviced when we get to a stable state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FNIC_IN_FC_MODE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FNIC_IN_ETH_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">fc_exch_recv</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_import_rq_eth_pkt() - handle received FCoE or FIP frame.</span>
<span class="cm"> * @fnic:	fnic instance.</span>
<span class="cm"> * @skb:	Ethernet Frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fnic_import_rq_eth_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="n">fcoe_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_crc_eof</span> <span class="o">*</span><span class="n">ft</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Undo VLAN encapsulation if present.</span>
<span class="cm">	 */</span>
	<span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">eh</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">,</span> <span class="n">eh</span><span class="p">,</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eh</span><span class="p">));</span>
		<span class="n">fcoe_ctlr_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* let caller know packet was used */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eh</span><span class="p">));</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eh</span><span class="p">));</span>

	<span class="n">fcoe_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FC_FCOE_DECAPS_VER</span><span class="p">(</span><span class="n">fcoe_hdr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FC_FCOE_VER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">fc_frame_init</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">fcoe_hdr</span><span class="o">-&gt;</span><span class="n">fcoe_sof</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">));</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ft</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ft</span><span class="p">));</span>
	<span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">ft</span><span class="o">-&gt;</span><span class="n">fcoe_eof</span><span class="p">;</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ft</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_update_mac_locked() - set data MAC address and filters.</span>
<span class="cm"> * @fnic:	fnic instance.</span>
<span class="cm"> * @new:	newly-assigned FCoE MAC address.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with the fnic lock held.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_update_mac_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">ctl_src_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot;update_mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ctl</span><span class="p">))</span>
		<span class="n">vnic_dev_del_addr</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">ctl</span><span class="p">))</span>
		<span class="n">vnic_dev_add_addr</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_update_mac() - set data MAC address and filters.</span>
<span class="cm"> * @lport:	local port.</span>
<span class="cm"> * @new:	newly-assigned FCoE MAC address.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_update_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
	<span class="n">fnic_update_mac_locked</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_set_port_id() - set the port_ID after successful FLOGI.</span>
<span class="cm"> * @lport:	local port.</span>
<span class="cm"> * @port_id:	assigned FC_ID.</span>
<span class="cm"> * @fp:		received frame containing the FLOGI accept or NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called from libfc when a new FC_ID has been assigned.</span>
<span class="cm"> * This causes us to reset the firmware to FC_MODE and setup the new MAC</span>
<span class="cm"> * address and FC_ID.</span>
<span class="cm"> *</span>
<span class="cm"> * It is also called with FC_ID 0 when we&#39;re logged off.</span>
<span class="cm"> *</span>
<span class="cm"> * If the FC_ID is due to point-to-point, fp may be NULL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_set_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot;set port_id %x fp %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re clearing the FC_ID, change to use the ctl_src_addr.</span>
<span class="cm">	 * Set ethernet mode to send FLOGI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fnic_update_mac</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">ctl_src_addr</span><span class="p">);</span>
		<span class="n">fnic_set_eth_mode</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="n">fr_cb</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">granted_mac</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* non-FIP - FLOGI already accepted - ignore return */</span>
			<span class="n">fcoe_ctlr_recv_flogi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fnic_update_mac</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Change state to reflect transition to FC mode */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FNIC_IN_ETH_MODE</span> <span class="o">||</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FNIC_IN_FC_MODE</span><span class="p">)</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FNIC_IN_ETH_TRANS_FC_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Unexpected fnic state %s while&quot;</span>
			     <span class="s">&quot; processing flogi resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fnic_state_to_str</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send FLOGI registration to firmware to set up FC mode.</span>
<span class="cm">	 * The new address will be set up when registration completes.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fnic_flogi_reg_handler</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FNIC_IN_ETH_TRANS_FC_MODE</span><span class="p">)</span>
			<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FNIC_IN_ETH_MODE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_rq_cmpl_frame_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_rq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cq_desc</span>
				    <span class="o">*</span><span class="n">cq_desc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vnic_rq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">skipped</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth_hdrs_stripped</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">eop</span><span class="p">,</span> <span class="n">sop</span><span class="p">,</span> <span class="n">ingress_port</span><span class="p">,</span> <span class="n">vlan_stripped</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fcoe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_sof</span><span class="p">,</span> <span class="n">fcoe_eof</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fcoe_fc_crc_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fcoe_enc_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tcp_udp_csum_ok</span><span class="p">,</span> <span class="n">udp</span><span class="p">,</span> <span class="n">tcp</span><span class="p">,</span> <span class="n">ipv4_csum_ok</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ipv6</span><span class="p">,</span> <span class="n">ipv4</span><span class="p">,</span> <span class="n">ipv4_fragment</span><span class="p">,</span> <span class="n">rss_type</span><span class="p">,</span> <span class="n">csum_not_calc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fcs_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">q_number</span><span class="p">,</span> <span class="n">completed_index</span><span class="p">,</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlan</span><span class="p">,</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rss_hash</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">exchange_id</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcp_bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cq_desc_dec</span><span class="p">(</span><span class="n">cq_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completed_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CQ_DESC_TYPE_RQ_FCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq_fcp_rq_desc_dec</span><span class="p">((</span><span class="k">struct</span> <span class="n">cq_fcp_rq_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">cq_desc</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completed_index</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">eop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcoe_fc_crc_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exchange_id</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">tmpl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcp_bytes_written</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eof</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ingress_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_error</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fcoe_enc_error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vlan_stripped</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">vlan</span><span class="p">);</span>
		<span class="n">eth_hdrs_stripped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">fcp_bytes_written</span><span class="p">);</span>
		<span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">sof</span><span class="p">;</span>
		<span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">eof</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CQ_DESC_TYPE_RQ_ENET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq_enet_rq_desc_dec</span><span class="p">((</span><span class="k">struct</span> <span class="n">cq_enet_rq_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">cq_desc</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">color</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completed_index</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ingress_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcoe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sop</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">rss_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csum_not_calc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rss_hash</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">bytes_written</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet_error</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">vlan_stripped</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vlan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">checksum</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">fcoe_sof</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcoe_fc_crc_ok</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">fcoe_enc_error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcoe_eof</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">tcp_udp_csum_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ipv4_csum_ok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipv4</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ipv4_fragment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcs_ok</span><span class="p">);</span>
		<span class="n">eth_hdrs_stripped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcs_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;fcs error.  dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnic_import_rq_eth_pkt</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wrong CQ type*/</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;fnic rq_cmpl wrong cq type x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcs_ok</span> <span class="o">||</span> <span class="n">packet_error</span> <span class="o">||</span> <span class="o">!</span><span class="n">fcoe_fc_crc_ok</span> <span class="o">||</span> <span class="n">fcoe_enc_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;fnic rq_cmpl fcoe x%x fcsok x%x&quot;</span>
			     <span class="s">&quot; pkterr x%x fcoe_fc_crc_ok x%x, fcoe_enc_err&quot;</span>
			     <span class="s">&quot; x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fcoe</span><span class="p">,</span> <span class="n">fcs_ok</span><span class="p">,</span> <span class="n">packet_error</span><span class="p">,</span>
			     <span class="n">fcoe_fc_crc_ok</span><span class="p">,</span> <span class="n">fcoe_enc_error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stop_rx_link_events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fr_dev</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">fnic_event_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_work</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_rq_cmpl_handler_cont</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cq_desc</span> <span class="o">*</span><span class="n">cq_desc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">q_number</span><span class="p">,</span> <span class="n">u16</span> <span class="n">completed_index</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">vnic_rq_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">q_number</span><span class="p">],</span> <span class="n">cq_desc</span><span class="p">,</span> <span class="n">completed_index</span><span class="p">,</span>
			<span class="n">VNIC_RQ_RETURN_DESC</span><span class="p">,</span> <span class="n">fnic_rq_cmpl_frame_recv</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fnic_rq_cmpl_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rq_work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tot_rq_work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_work_done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_work_done</span> <span class="o">=</span> <span class="n">vnic_cq_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rq_work_to_do</span><span class="p">,</span>
						<span class="n">fnic_rq_cmpl_handler_cont</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_work_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_rq_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fnic_alloc_rq_frame</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
					     <span class="s">&quot;fnic_alloc_rq_frame can&#39;t alloc&quot;</span>
					     <span class="s">&quot; frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tot_rq_work_done</span> <span class="o">+=</span> <span class="n">cur_work_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tot_rq_work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called once at init time to allocate and fill RQ</span>
<span class="cm"> * buffers. Subsequently, it is called in the interrupt context after RQ</span>
<span class="cm"> * buffer processing to replenish the buffers in the RQ</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fnic_alloc_rq_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_rq</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">FC_FRAME_HEADROOM</span> <span class="o">+</span> <span class="n">FC_MAX_FRAME</span> <span class="o">+</span> <span class="n">FC_FRAME_TAILROOM</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FNIC_FCS_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Unable to allocate RQ sk_buff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">fnic_queue_rq_desc</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fnic_free_rq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_rq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vnic_rq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_eth_send() - Send Ethernet frame.</span>
<span class="cm"> * @fip:	fcoe_ctlr instance.</span>
<span class="cm"> * @skb:	Ethernet Frame, FIP, without VLAN encapsulation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_eth_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">fnic_from_ctlr</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vnic_wq</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vlan_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_hw_insert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eth_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">vlan_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vlan_hdr</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth_hdr</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vlan_hdr</span><span class="p">,</span> <span class="n">eth_hdr</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vnic_wq_desc_avail</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fnic_queue_wq_eth_desc</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			       <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_hw_insert</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send FC frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vnic_wq</span> <span class="o">*</span><span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vlan_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="n">fcoe_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tot_len</span><span class="p">,</span> <span class="n">eth_hdr_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fcoe_ctlr_els_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_hw_insert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eth_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vlan_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcoe_hdr</span><span class="p">);</span>
		<span class="n">vlan_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">eth_hdr_len</span><span class="p">);</span>
		<span class="n">eth_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">vlan_hdr</span><span class="p">;</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">);</span>
		<span class="n">vlan_hdr</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">);</span>
		<span class="n">fcoe_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">vlan_hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">eth_hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eth_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcoe_hdr</span><span class="p">);</span>
		<span class="n">eth_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">eth_hdr_len</span><span class="p">);</span>
		<span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">);</span>
		<span class="n">fcoe_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">eth_hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">map_dest</span><span class="p">)</span>
		<span class="n">fc_fcoe_set_mac</span><span class="p">(</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">tot_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tot_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fcoe_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcoe_hdr</span><span class="p">));</span>
	<span class="n">fcoe_hdr</span><span class="o">-&gt;</span><span class="n">fcoe_sof</span> <span class="o">=</span> <span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FC_FCOE_VER</span><span class="p">)</span>
		<span class="n">FC_FCOE_ENCAPS_VER</span><span class="p">(</span><span class="n">fcoe_hdr</span><span class="p">,</span> <span class="n">FC_FCOE_VER</span><span class="p">);</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">eth_hdr</span><span class="p">,</span> <span class="n">tot_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vnic_wq_desc_avail</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span>
				 <span class="n">tot_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fnic_send_frame_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fnic_queue_wq_desc</span><span class="p">(</span><span class="n">wq</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">tot_len</span><span class="p">,</span> <span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span>
			   <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_hw_insert</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">fnic_send_frame_end:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fnic_send</span>
<span class="cm"> * Routine to send a raw frame</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fnic_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">in_remove</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Queue frame if in a transitional state.</span>
<span class="cm">	 * This occurs while registering the Port_ID / MAC address after FLOGI.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FNIC_IN_FC_MODE</span> <span class="o">&amp;&amp;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FNIC_IN_ETH_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fnic_send_frame</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_flush_tx() - send queued frames.</span>
<span class="cm"> * @fnic: fnic device</span>
<span class="cm"> *</span>
<span class="cm"> * Send frames that were waiting to go out in FC or Ethernet mode.</span>
<span class="cm"> * Whenever changing modes we purge queued frames, so these frames should</span>
<span class="cm"> * be queued for the stable mode that we&#39;re in, either FC or Ethernet.</span>
<span class="cm"> *</span>
<span class="cm"> * Called without fnic_lock held.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fnic_flush_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">fnic_send_frame</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_set_eth_mode() - put fnic into ethernet mode.</span>
<span class="cm"> * @fnic: fnic device</span>
<span class="cm"> *</span>
<span class="cm"> * Called without fnic lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_set_eth_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fnic_state</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="n">old_state</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">old_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FNIC_IN_FC_MODE</span>:
	<span class="k">case</span> <span class="n">FNIC_IN_ETH_TRANS_FC_MODE</span>:
	<span class="nl">default:</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FNIC_IN_FC_TRANS_ETH_MODE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">fnic_fw_reset_handler</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FNIC_IN_FC_TRANS_ETH_MODE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">old_state</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FNIC_IN_FC_TRANS_ETH_MODE</span>:
	<span class="k">case</span> <span class="n">FNIC_IN_ETH_MODE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_wq_complete_frame_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cq_desc</span> <span class="o">*</span><span class="n">cq_desc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vnic_wq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_wq_cmpl_handler_cont</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cq_desc</span> <span class="o">*</span><span class="n">cq_desc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">q_number</span><span class="p">,</span> <span class="n">u16</span> <span class="n">completed_index</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="n">q_number</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vnic_wq_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="n">q_number</span><span class="p">],</span> <span class="n">cq_desc</span><span class="p">,</span> <span class="n">completed_index</span><span class="p">,</span>
			<span class="n">fnic_wq_complete_frame_send</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="n">q_number</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fnic_wq_cmpl_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wq_work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">raw_wq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wq_work_done</span>  <span class="o">+=</span> <span class="n">vnic_cq_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">[</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="o">+</span><span class="n">i</span><span class="p">],</span>
						 <span class="n">work_to_do</span><span class="p">,</span>
						 <span class="n">fnic_wq_cmpl_handler_cont</span><span class="p">,</span>
						 <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">wq_work_done</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">fnic_free_wq_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vnic_wq_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">vnic_dev_priv</span><span class="p">(</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">os_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
