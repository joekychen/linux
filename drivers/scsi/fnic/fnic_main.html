<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › fnic › fnic_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fnic_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Cisco Systems, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright 2007 Nuova Systems, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you may redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fip.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/libfc.h&gt;</span>
<span class="cp">#include &lt;scsi/fc_frame.h&gt;</span>

<span class="cp">#include &quot;vnic_dev.h&quot;</span>
<span class="cp">#include &quot;vnic_intr.h&quot;</span>
<span class="cp">#include &quot;vnic_stats.h&quot;</span>
<span class="cp">#include &quot;fnic_io.h&quot;</span>
<span class="cp">#include &quot;fnic.h&quot;</span>

<span class="cp">#define PCI_DEVICE_ID_CISCO_FNIC	0x0045</span>

<span class="cm">/* Timer to poll notification area for events. Used for MSI interrupts */</span>
<span class="cp">#define FNIC_NOTIFY_TIMER_PERIOD	(2 * HZ)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_NUM_CACHES</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">fnic_io_req_cache</span><span class="p">;</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fnic_list</span><span class="p">);</span>
<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">fnic_list_lock</span><span class="p">);</span>

<span class="cm">/* Supported devices by fnic module */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">fnic_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CISCO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CISCO_FNIC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Abhijeet Joglekar &lt;abjoglek@cisco.com&gt;, &quot;</span>
	      <span class="s">&quot;Joseph R. Eykholt &lt;jeykholt@cisco.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">fnic_id_table</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fnic_log_level</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fnic_log_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fnic_log_level</span><span class="p">,</span> <span class="s">&quot;bit mask of fnic logging levels&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">libfc_function_template</span> <span class="n">fnic_transport_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">frame_send</span> <span class="o">=</span> <span class="n">fnic_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lport_set_port_id</span> <span class="o">=</span> <span class="n">fnic_set_port_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fcp_abort_io</span> <span class="o">=</span> <span class="n">fnic_empty_scsi_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fcp_cleanup</span> <span class="o">=</span> <span class="n">fnic_empty_scsi_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exch_mgr_reset</span> <span class="o">=</span> <span class="n">fnic_exch_mgr_reset</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span> <span class="o">||</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">FNIC_DFLT_QUEUE_DEPTH</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">fnic_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">fnic_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">fnic_abort_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">fnic_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">fnic_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span> <span class="o">=</span> <span class="n">fnic_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">fc_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span> <span class="o">=</span> <span class="n">fc_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">FNIC_MAX_IO_REQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">FNIC_MAX_SG_DESC_CNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span> <span class="o">=</span> <span class="n">fnic_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fnic_set_rport_dev_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fnic_get_host_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">fnic_fc_transport</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">fnic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">fnic_fc_functions</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_active_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">fnic_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">fc_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">fnic_set_rport_dev_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">fnic_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">fnic_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_libfc_priv</span><span class="p">),</span>
	<span class="p">.</span><span class="n">terminate_rport_io</span> <span class="o">=</span> <span class="n">fnic_terminate_rport_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">fc_lport_bsg_request</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_get_host_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">port_speed</span> <span class="o">=</span> <span class="n">vnic_dev_port_speed</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* Add in other values as they get defined in fw */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10000</span>:
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="nf">fnic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vnic_stats</span> <span class="o">*</span><span class="n">vs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stats_time</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">FNIC_STATS_RATE_LIMIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stats_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vnic_dev_stats_dump</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FNIC_MAIN_DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			      <span class="s">&quot;fnic: Get vnic stats failed&quot;</span>
			      <span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vs</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_unicast_frames_ok</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_words</span>  <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_unicast_bytes_ok</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_unicast_frames_ok</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_words</span>  <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_unicast_bytes_ok</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">error_frames</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dumped_frames</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_drops</span> <span class="o">+</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_drop</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span> <span class="o">=</span> <span class="n">vs</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">seconds_since_last_reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">boot_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">fcp_input_megabytes</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fcp_input_bytes</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">fcp_output_megabytes</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fcp_output_bytes</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fnic_log_q_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">raw_wq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">error_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error_status</span><span class="p">)</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;WQ[%d] error_status&quot;</span>
				     <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">error_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error_status</span><span class="p">)</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;RQ[%d] error_status&quot;</span>
				     <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">error_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error_status</span><span class="p">)</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;CWQ[%d] error_status&quot;</span>
				     <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fnic_handle_link_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stop_rx_link_events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">fnic_event_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_notify_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vnic_dev_get_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VNIC_DEV_INTR_MODE_INTX</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_dev_notify_set</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">FNIC_INTX_NOTIFY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VNIC_DEV_INTR_MODE_MSI</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_dev_notify_set</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VNIC_DEV_INTR_MODE_MSIX</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_dev_notify_set</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">FNIC_MSIX_ERR_NOTIFY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Interrupt mode should be set up&quot;</span>
			     <span class="s">&quot; before devcmd notify set %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">vnic_dev_get_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_notify_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fnic_handle_link_event</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">notify_timer</span><span class="p">,</span>
		  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">FNIC_NOTIFY_TIMER_PERIOD</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_notify_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vnic_dev_get_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VNIC_DEV_INTR_MODE_MSI</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Schedule first timeout immediately. The driver is</span>
<span class="cm">		 * initiatialized and ready to look for link up notification</span>
<span class="cm">		 */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">notify_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Using intr for notification for INTx/MSI-X */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_dev_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">vnic_dev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vnic_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">),</span>
			 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">finished</span><span class="p">)(</span><span class="k">struct</span> <span class="n">vnic_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">),</span>
			 <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Wait for func to complete...2 seconds max */</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">finished</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fnic_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vnic_dev_disable</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_intr_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_rq_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">raw_wq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_wq_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_wq_copy_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clean up completed IOs and FCS frames */</span>
	<span class="n">fnic_wq_copy_cmpl_handler</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">fnic_wq_cmpl_handler</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">fnic_rq_cmpl_handler</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Clean up the IOs and FCS frames that have not completed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">raw_wq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_wq_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fnic_free_wq_buf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_rq_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fnic_free_rq_buf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_wq_copy_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				   <span class="n">fnic_wq_copy_cleanup_handler</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">cq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_cq_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_intr_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_req_pool</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FNIC_SGL_NUM_CACHES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_sgl_pool</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fnic_iounmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">vaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fnic_get_mac() - get assigned data MAC address for FIP code.</span>
<span class="cm"> * @lport: 	local port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">fnic_get_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fnic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span><span class="p">;</span>
	<span class="n">mempool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate SCSI Host and set up association between host,</span>
<span class="cm">	 * local port, and fnic</span>
<span class="cm">	 */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">libfc_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_host_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to alloc libfc local port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">fnic</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">lp</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		 <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">fnic_fc_transport</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_init_shared_tag_map</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">FNIC_MAX_IO_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Unable to alloc shared tag map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_hba</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup PCI resources */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fnic</span><span class="p">);</span>

	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Cannot enable PCI device, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_hba</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Cannot enable PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Query PCI controller on system for DMA addressing</span>
<span class="cm">	 * limitation for the device.  Try 40-bit first, and</span>
<span class="cm">	 * fail to 32-bit.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;No usable DMA configuration &quot;</span>
				     <span class="s">&quot;aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;Unable to obtain 32-bit DMA &quot;</span>
				     <span class="s">&quot;for consistent allocations, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;Unable to obtain 40-bit DMA &quot;</span>
				     <span class="s">&quot;for consistent allocations, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Map vNIC resources from BAR0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;BAR0 not memory-map&#39;able, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">.</span><span class="n">vaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Cannot memory-map BAR0 res hdr, &quot;</span>
			     <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vnic_dev_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">fnic</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;vNIC registration failed, &quot;</span>
			     <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_dev_wait</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vnic_dev_open</span><span class="p">,</span>
			    <span class="n">vnic_dev_open_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;vNIC dev open failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_vnic_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_dev_init</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;vNIC dev init failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_dev_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_dev_mac_addr</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">ctl_src_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;vNIC get MAC addr failed </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_dev_close</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set data_src for point-to-point mode and to keep it non-zero */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Get vNIC configuration */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_get_vnic_config</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Get vNIC configuration failed, &quot;</span>
			     <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_dev_close</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">luns_per_tgt</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">FNIC_MAX_FCP_TARGET</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">FCOE_MAX_CMD_LEN</span><span class="p">;</span>

	<span class="n">fnic_get_res_counts</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_set_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Failed to set intr mode, &quot;</span>
			     <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_dev_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_alloc_vnic_resources</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Failed to alloc vNIC resources, &quot;</span>
			     <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_clear_intr</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* initialize all fnic locks */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FNIC_WQ_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FNIC_WQ_COPY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_desc_low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DESC_CLEAN_LOW_WATERMARK</span><span class="p">;</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fw_ack_recd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fw_ack_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FNIC_IO_LOCKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_req_lock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_req_pool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fnic_io_req_cache</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_req_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_resources</span><span class="p">;</span>

	<span class="n">pool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_ioreq_pool</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_sgl_pool</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>

	<span class="n">pool</span> <span class="o">=</span> <span class="n">mempool_create_slab_pool</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_dflt_pool</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_sgl_pool</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>

	<span class="cm">/* setup vlan config, hw inserts vlan header */</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_hw_insert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize the FIP fcoe_ctrl struct */</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">fnic_eth_send</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">update_mac</span> <span class="o">=</span> <span class="n">fnic_update_mac</span><span class="p">;</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">get_src_addr</span> <span class="o">=</span> <span class="n">fnic_get_mac</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VFCF_FIP_CAPABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;firmware supports FIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* enable directed and multicast */</span>
		<span class="n">vnic_dev_packet_filter</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vnic_dev_add_addr</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">FIP_ALL_ENODE_MACS</span><span class="p">);</span>
		<span class="n">vnic_dev_add_addr</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">.</span><span class="n">ctl_src_addr</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">FIP_MODE_AUTO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;firmware uses non-FIP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">FIP_MODE_NON_FIP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FNIC_IN_FC_MODE</span><span class="p">;</span>

	<span class="cm">/* Enable hardware stripping of vlan header on ingress */</span>
	<span class="n">fnic_set_nic_config</span><span class="p">(</span><span class="n">fnic</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup notification buffer area */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_notify_set</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Failed to alloc notify buffer, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_max_pool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup notify timer when using MSI interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vnic_dev_get_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="o">==</span> <span class="n">VNIC_DEV_INTR_MODE_MSI</span><span class="p">)</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">notify_timer</span><span class="p">,</span>
			    <span class="n">fnic_notify_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fnic</span><span class="p">);</span>

	<span class="cm">/* allocate RQ buffers and post them to RQ*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">vnic_rq_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fnic_alloc_rq_frame</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				     <span class="s">&quot;fnic_alloc_rq_frame can&#39;t alloc &quot;</span>
				     <span class="s">&quot;frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_rq_buf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialization done with PCI system, hardware, firmware.</span>
<span class="cm">	 * Add host to SCSI</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;fnic: scsi_add_host failed...exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_rq_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start local port initiatialization */</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">flogi_retries</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">max_rport_retry_count</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">plogi_retries</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCP_SPPF_INIT_FCN</span> <span class="o">|</span> <span class="n">FCP_SPPF_RD_XRDY_DIS</span> <span class="o">|</span>
			      <span class="n">FCP_SPPF_CONF_COMPL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VFCF_FCP_SEQ_LVL_ERR</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">|=</span> <span class="n">FCP_SPPF_RETRY</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">boot_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ed_tov</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ra_tov</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
	<span class="n">fc_set_wwnn</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">node_wwn</span><span class="p">);</span>
	<span class="n">fc_set_wwpn</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">port_wwn</span><span class="p">);</span>

	<span class="n">fcoe_libfc_config</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic_transport_template</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc_exch_mgr_alloc</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">FCPIO_HOST_EXCH_RANGE_START</span><span class="p">,</span>
			       <span class="n">FCPIO_HOST_EXCH_RANGE_END</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_remove_scsi_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc_lport_init_stats</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">fc_lport_config</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_set_mfs</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">maxdatafieldsize</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_exch_mgr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">;</span>
	<span class="n">fc_host_dev_loss_tmo</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">port_down_timeout</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
		<span class="n">DRV_NAME</span> <span class="s">&quot; v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; over %s&quot;</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnic_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">link_work</span><span class="p">,</span> <span class="n">fnic_handle_link</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_work</span><span class="p">,</span> <span class="n">fnic_handle_frame</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>

	<span class="cm">/* Enable all queues */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">raw_wq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_wq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_rq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_wq_copy_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">wq_copy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">fc_fabric_login</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">vnic_dev_enable</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fnic_request_intr</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
			     <span class="s">&quot;Unable to request irq.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_exch_mgr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_intr_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">fnic_notify_timer_start</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_exch_mgr:</span>
	<span class="n">fc_exch_mgr_free</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="nl">err_out_remove_scsi_host:</span>
	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_out_free_rq_buf:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vnic_rq_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fnic_free_rq_buf</span><span class="p">);</span>
	<span class="n">vnic_dev_notify_unset</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="nl">err_out_free_max_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_sgl_pool</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]);</span>
<span class="nl">err_out_free_dflt_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_sgl_pool</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]);</span>
<span class="nl">err_out_free_ioreq_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">io_req_pool</span><span class="p">);</span>
<span class="nl">err_out_free_resources:</span>
	<span class="n">fnic_free_vnic_resources</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
<span class="nl">err_out_clear_intr:</span>
	<span class="n">fnic_clear_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
<span class="nl">err_out_dev_close:</span>
	<span class="n">vnic_dev_close</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="nl">err_out_vnic_unregister:</span>
	<span class="n">vnic_dev_unregister</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
	<span class="n">fnic_iounmap</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
<span class="nl">err_out_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free_hba:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">fnic_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fnic</span> <span class="o">*</span><span class="n">fnic</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark state so that the workqueue thread stops forwarding</span>
<span class="cm">	 * received frames and link events to the local port. ISR and</span>
<span class="cm">	 * other threads that can queue work items will also stop</span>
<span class="cm">	 * creating work items on the fnic workqueue</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">stop_rx_link_events</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vnic_dev_get_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="o">==</span> <span class="n">VNIC_DEV_INTR_MODE_MSI</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">notify_timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Flush the fnic event queue. After this call, there should</span>
<span class="cm">	 * be no event queued for this fnic device in the workqueue</span>
<span class="cm">	 */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">fnic_event_queue</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Log off the fabric. This stops all remote ports, dns port,</span>
<span class="cm">	 * logs off the fabric. This flushes all rport, disc, lport work</span>
<span class="cm">	 * before returning</span>
<span class="cm">	 */</span>
	<span class="n">fc_fabric_logoff</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fnic</span><span class="o">-&gt;</span><span class="n">in_remove</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">fnic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">fcoe_ctlr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="n">fc_lport_destroy</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This stops the fnic device, masks all interrupts. Completed</span>
<span class="cm">	 * CQ entries are drained. Posted WQ/RQ/Copy-WQ entries are</span>
<span class="cm">	 * cleaned up</span>
<span class="cm">	 */</span>
	<span class="n">fnic_cleanup</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">frame_queue</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">fc_exch_mgr_free</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">vnic_dev_notify_unset</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">fnic_free_intr</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="n">fnic_free_vnic_resources</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="n">fnic_clear_intr_mode</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="n">vnic_dev_close</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">vnic_dev_unregister</span><span class="p">(</span><span class="n">fnic</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">fnic_iounmap</span><span class="p">(</span><span class="n">fnic</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">fnic_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">fnic_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">fnic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fnic_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fnic_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s, ver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="cm">/* Create a cache for allocation of default size sgls */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic_dflt_sgl_list</span><span class="p">);</span>
	<span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmem_cache_create</span>
		<span class="p">(</span><span class="s">&quot;fnic_sgl_dflt&quot;</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">FNIC_SG_DESC_ALIGN</span><span class="p">,</span> <span class="n">FNIC_SG_DESC_ALIGN</span><span class="p">,</span>
		 <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
		 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create fnic dflt sgl slab</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_create_fnic_sgl_slab_dflt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create a cache for allocation of max size sgls*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic_sgl_list</span><span class="p">);</span>
	<span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmem_cache_create</span>
		<span class="p">(</span><span class="s">&quot;fnic_sgl_max&quot;</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">FNIC_SG_DESC_ALIGN</span><span class="p">,</span> <span class="n">FNIC_SG_DESC_ALIGN</span><span class="p">,</span>
		 <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
		 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create fnic max sgl slab</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_create_fnic_sgl_slab_max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create a cache of io_req structs for use via mempool */</span>
	<span class="n">fnic_io_req_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;fnic_io_req&quot;</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fnic_io_req</span><span class="p">),</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic_io_req_cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create fnic io_req slab</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_create_fnic_ioreq_slab</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fnic_event_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;fnic_event_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic_event_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;fnic work queue create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_create_fnic_workq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_list</span><span class="p">);</span>

	<span class="n">fnic_fc_transport</span> <span class="o">=</span> <span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_fc_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnic_fc_transport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;fc_attach_transport error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_fc_transport</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register the driver with PCI system */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;pci register error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pci_register</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_pci_register:</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">fnic_fc_transport</span><span class="p">);</span>
<span class="nl">err_fc_transport:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">fnic_event_queue</span><span class="p">);</span>
<span class="nl">err_create_fnic_workq:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_io_req_cache</span><span class="p">);</span>
<span class="nl">err_create_fnic_ioreq_slab:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]);</span>
<span class="nl">err_create_fnic_sgl_slab_max:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]);</span>
<span class="nl">err_create_fnic_sgl_slab_dflt:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fnic_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fnic_driver</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">fnic_event_queue</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_MAX</span><span class="p">]);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_sgl_cache</span><span class="p">[</span><span class="n">FNIC_SGL_CACHE_DFLT</span><span class="p">]);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">fnic_io_req_cache</span><span class="p">);</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">fnic_fc_transport</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fnic_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fnic_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
