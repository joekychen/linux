<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › fnic › fcpio.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fcpio.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Cisco Systems, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright 2007 Nuova Systems, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you may redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm"> * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _FCPIO_H_</span>
<span class="cp">#define _FCPIO_H_</span>

<span class="cp">#include &lt;linux/if_ether.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * This header file includes all of the data structures used for</span>
<span class="cm"> * communication by the host driver to the fcp firmware.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Exchange and sequence id space allocated to the host driver</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_HOST_EXCH_RANGE_START         0x1000</span>
<span class="cp">#define FCPIO_HOST_EXCH_RANGE_END           0x1fff</span>
<span class="cp">#define FCPIO_HOST_SEQ_ID_RANGE_START       0x80</span>
<span class="cp">#define FCPIO_HOST_SEQ_ID_RANGE_END         0xff</span>

<span class="cm">/*</span>
<span class="cm"> * Command entry type</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">fcpio_type</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initiator request types</span>
<span class="cm">	 */</span>
	<span class="n">FCPIO_ICMND_16</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="n">FCPIO_ICMND_32</span><span class="p">,</span>
	<span class="n">FCPIO_ICMND_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_ITMF</span><span class="p">,</span>
	<span class="n">FCPIO_ITMF_CMPL</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * Target request types</span>
<span class="cm">	 */</span>
	<span class="n">FCPIO_TCMND_16</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">FCPIO_TCMND_32</span><span class="p">,</span>
	<span class="n">FCPIO_TDATA</span><span class="p">,</span>
	<span class="n">FCPIO_TXRDY</span><span class="p">,</span>
	<span class="n">FCPIO_TRSP</span><span class="p">,</span>
	<span class="n">FCPIO_TDRSP_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_TTMF</span><span class="p">,</span>
	<span class="n">FCPIO_TTMF_ACK</span><span class="p">,</span>
	<span class="n">FCPIO_TABORT</span><span class="p">,</span>
	<span class="n">FCPIO_TABORT_CMPL</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * Misc request types</span>
<span class="cm">	 */</span>
	<span class="n">FCPIO_ACK</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">FCPIO_RESET</span><span class="p">,</span>
	<span class="n">FCPIO_RESET_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_FLOGI_REG</span><span class="p">,</span>
	<span class="n">FCPIO_FLOGI_REG_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_ECHO</span><span class="p">,</span>
	<span class="n">FCPIO_ECHO_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_LUNMAP_CHNG</span><span class="p">,</span>
	<span class="n">FCPIO_LUNMAP_REQ</span><span class="p">,</span>
	<span class="n">FCPIO_LUNMAP_REQ_CMPL</span><span class="p">,</span>
	<span class="n">FCPIO_FLOGI_FIP_REG</span><span class="p">,</span>
	<span class="n">FCPIO_FLOGI_FIP_REG_CMPL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Header status codes from the firmware</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">fcpio_status</span> <span class="p">{</span>
	<span class="n">FCPIO_SUCCESS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>              <span class="cm">/* request was successful */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a request to the firmware is rejected, the original request</span>
<span class="cm">	 * header will be returned with the status set to one of the following:</span>
<span class="cm">	 */</span>
	<span class="n">FCPIO_INVALID_HEADER</span><span class="p">,</span>    <span class="cm">/* header contains invalid data */</span>
	<span class="n">FCPIO_OUT_OF_RESOURCE</span><span class="p">,</span>   <span class="cm">/* out of resources to complete request */</span>
	<span class="n">FCPIO_INVALID_PARAM</span><span class="p">,</span>     <span class="cm">/* some parameter in request is invalid */</span>
	<span class="n">FCPIO_REQ_NOT_SUPPORTED</span><span class="p">,</span> <span class="cm">/* request type is not supported */</span>
	<span class="n">FCPIO_IO_NOT_FOUND</span><span class="p">,</span>      <span class="cm">/* requested I/O was not found */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Once a request is processed, the firmware will usually return</span>
<span class="cm">	 * a cmpl message type.  In cases where errors occurred,</span>
<span class="cm">	 * the header status field would be filled in with one of the following:</span>
<span class="cm">	 */</span>
	<span class="n">FCPIO_ABORTED</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">,</span>     <span class="cm">/* request was aborted */</span>
	<span class="n">FCPIO_TIMEOUT</span><span class="p">,</span>            <span class="cm">/* request was timed out */</span>
	<span class="n">FCPIO_SGL_INVALID</span><span class="p">,</span>        <span class="cm">/* request was aborted due to sgl error */</span>
	<span class="n">FCPIO_MSS_INVALID</span><span class="p">,</span>        <span class="cm">/* request was aborted due to mss error */</span>
	<span class="n">FCPIO_DATA_CNT_MISMATCH</span><span class="p">,</span>  <span class="cm">/* recv/sent more/less data than exp. */</span>
	<span class="n">FCPIO_FW_ERR</span><span class="p">,</span>             <span class="cm">/* request was terminated due to fw error */</span>
	<span class="n">FCPIO_ITMF_REJECTED</span><span class="p">,</span>      <span class="cm">/* itmf req was rejected by remote node */</span>
	<span class="n">FCPIO_ITMF_FAILED</span><span class="p">,</span>        <span class="cm">/* itmf req was failed by remote node */</span>
	<span class="n">FCPIO_ITMF_INCORRECT_LUN</span><span class="p">,</span> <span class="cm">/* itmf req targeted incorrect LUN */</span>
	<span class="n">FCPIO_CMND_REJECTED</span><span class="p">,</span>      <span class="cm">/* request was invalid and rejected */</span>
	<span class="n">FCPIO_NO_PATH_AVAIL</span><span class="p">,</span>      <span class="cm">/* no paths to the lun was available */</span>
	<span class="n">FCPIO_PATH_FAILED</span><span class="p">,</span>        <span class="cm">/* i/o sent to current path failed */</span>
	<span class="n">FCPIO_LUNMAP_CHNG_PEND</span><span class="p">,</span>   <span class="cm">/* i/o rejected due to lunmap change */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The header command tag.  All host requests will use the &quot;tag&quot; field</span>
<span class="cm"> * to mark commands with a unique tag.  When the firmware responds to</span>
<span class="cm"> * a host request, it will copy the tag field into the response.</span>
<span class="cm"> *</span>
<span class="cm"> * The only firmware requests that will use the rx_id/ox_id fields instead</span>
<span class="cm"> * of the tag field will be the target command and target task management</span>
<span class="cm"> * requests.  These two requests do not have corresponding host requests</span>
<span class="cm"> * since they come directly from the FC initiator on the network.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">rx_id</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">ox_id</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ex_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_tag_id_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_tag_id_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_tag_exid_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ox_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ex_id</span><span class="p">.</span><span class="n">rx_id</span> <span class="o">=</span> <span class="n">rx_id</span><span class="p">;</span>
	<span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ex_id</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">ox_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_tag_exid_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ox_id</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rx_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">rx_id</span> <span class="o">=</span> <span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ex_id</span><span class="p">.</span><span class="n">rx_id</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">tag</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ex_id</span><span class="p">.</span><span class="n">ox_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The header for an fcpio request, whether from the firmware or from the</span>
<span class="cm"> * host driver</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_header</span> <span class="p">{</span>
	<span class="n">u8</span>            <span class="n">type</span><span class="p">;</span>           <span class="cm">/* enum fcpio_type */</span>
	<span class="n">u8</span>            <span class="n">status</span><span class="p">;</span>         <span class="cm">/* header status entry */</span>
	<span class="n">u16</span>           <span class="n">_resvd</span><span class="p">;</span>         <span class="cm">/* reserved */</span>
	<span class="k">struct</span> <span class="n">fcpio_tag</span>    <span class="n">tag</span><span class="p">;</span>      <span class="cm">/* header tag */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_header_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		 <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">_resvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fcpio_header_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
		 <span class="n">u8</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">fcpio_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CDB_16      16</span>
<span class="cp">#define CDB_32      32</span>
<span class="cp">#define LUN_ADDRESS 8</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_icmnd_16: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for sending out an initiator SCSI 16-byte command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_icmnd_16</span> <span class="p">{</span>
	<span class="n">u32</span>	  <span class="n">lunmap_id</span><span class="p">;</span>		<span class="cm">/* index into lunmap table */</span>
	<span class="n">u8</span>	  <span class="n">special_req_flags</span><span class="p">;</span>	<span class="cm">/* special exchange request flags */</span>
	<span class="n">u8</span>	  <span class="n">_resvd0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	        <span class="cm">/* reserved */</span>
	<span class="n">u32</span>	  <span class="n">sgl_cnt</span><span class="p">;</span>		<span class="cm">/* scatter-gather list count */</span>
	<span class="n">u32</span>	  <span class="n">sense_len</span><span class="p">;</span>		<span class="cm">/* sense buffer length */</span>
	<span class="n">u64</span>	  <span class="n">sgl_addr</span><span class="p">;</span>		<span class="cm">/* scatter-gather list addr */</span>
	<span class="n">u64</span>	  <span class="n">sense_addr</span><span class="p">;</span>		<span class="cm">/* sense buffer address */</span>
	<span class="n">u8</span>	  <span class="n">crn</span><span class="p">;</span>			<span class="cm">/* SCSI Command Reference No. */</span>
	<span class="n">u8</span>	  <span class="n">pri_ta</span><span class="p">;</span>		<span class="cm">/* SCSI Priority and Task attribute */</span>
	<span class="n">u8</span>	  <span class="n">_resvd1</span><span class="p">;</span>		<span class="cm">/* reserved: should be 0 */</span>
	<span class="n">u8</span>	  <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* command flags */</span>
	<span class="n">u8</span>	  <span class="n">scsi_cdb</span><span class="p">[</span><span class="n">CDB_16</span><span class="p">];</span>	<span class="cm">/* SCSI Cmnd Descriptor Block */</span>
	<span class="n">u32</span>	  <span class="n">data_len</span><span class="p">;</span>		<span class="cm">/* length of data expected */</span>
	<span class="n">u8</span>	  <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>	<span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>	  <span class="n">_resvd2</span><span class="p">;</span>		<span class="cm">/* reserved */</span>
	<span class="n">u8</span>	  <span class="n">d_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="cm">/* FC vNIC only: Target D_ID */</span>
	<span class="n">u16</span>	  <span class="n">mss</span><span class="p">;</span>			<span class="cm">/* FC vNIC only: max burst */</span>
	<span class="n">u16</span>	  <span class="n">_resvd3</span><span class="p">;</span>		<span class="cm">/* reserved */</span>
	<span class="n">u32</span>	  <span class="n">r_a_tov</span><span class="p">;</span>		<span class="cm">/* FC vNIC only: Res. Alloc Timeout */</span>
	<span class="n">u32</span>	  <span class="n">e_d_tov</span><span class="p">;</span>	        <span class="cm">/* FC vNIC only: Err Detect Timeout */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Special request flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_ICMND_SRFLAG_RETRY 0x01   </span><span class="cm">/* Enable Retry handling on exchange */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Priority/Task Attribute settings</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_ICMND_PTA_SIMPLE      0   </span><span class="cm">/* simple task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_PTA_HEADQ       1   </span><span class="cm">/* head of queue task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_PTA_ORDERED     2   </span><span class="cm">/* ordered task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_PTA_ACA         4   </span><span class="cm">/* auto contingent allegiance */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_PRI_SHIFT       3   </span><span class="cm">/* priority field starts in bit 3 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Command flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_ICMND_RDDATA      0x02    </span><span class="cm">/* read data */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_WRDATA      0x01    </span><span class="cm">/* write data */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_icmnd_32: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for sending out an initiator SCSI 32-byte command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_icmnd_32</span> <span class="p">{</span>
	<span class="n">u32</span>   <span class="n">lunmap_id</span><span class="p">;</span>              <span class="cm">/* index into lunmap table */</span>
	<span class="n">u8</span>    <span class="n">special_req_flags</span><span class="p">;</span>      <span class="cm">/* special exchange request flags */</span>
	<span class="n">u8</span>    <span class="n">_resvd0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>             <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">sgl_cnt</span><span class="p">;</span>                <span class="cm">/* scatter-gather list count */</span>
	<span class="n">u32</span>   <span class="n">sense_len</span><span class="p">;</span>              <span class="cm">/* sense buffer length */</span>
	<span class="n">u64</span>   <span class="n">sgl_addr</span><span class="p">;</span>               <span class="cm">/* scatter-gather list addr */</span>
	<span class="n">u64</span>   <span class="n">sense_addr</span><span class="p">;</span>             <span class="cm">/* sense buffer address */</span>
	<span class="n">u8</span>    <span class="n">crn</span><span class="p">;</span>                    <span class="cm">/* SCSI Command Reference No. */</span>
	<span class="n">u8</span>    <span class="n">pri_ta</span><span class="p">;</span>                 <span class="cm">/* SCSI Priority and Task attribute */</span>
	<span class="n">u8</span>    <span class="n">_resvd1</span><span class="p">;</span>                <span class="cm">/* reserved: should be 0 */</span>
	<span class="n">u8</span>    <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* command flags */</span>
	<span class="n">u8</span>    <span class="n">scsi_cdb</span><span class="p">[</span><span class="n">CDB_32</span><span class="p">];</span>       <span class="cm">/* SCSI Cmnd Descriptor Block */</span>
	<span class="n">u32</span>   <span class="n">data_len</span><span class="p">;</span>               <span class="cm">/* length of data expected */</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>       <span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>    <span class="n">_resvd2</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">d_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		      <span class="cm">/* FC vNIC only: Target D_ID */</span>
	<span class="n">u16</span>   <span class="n">mss</span><span class="p">;</span>                    <span class="cm">/* FC vNIC only: max burst */</span>
	<span class="n">u16</span>   <span class="n">_resvd3</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">r_a_tov</span><span class="p">;</span>                <span class="cm">/* FC vNIC only: Res. Alloc Timeout */</span>
	<span class="n">u32</span>   <span class="n">e_d_tov</span><span class="p">;</span>                <span class="cm">/* FC vNIC only: Error Detect Timeout */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_itmf: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for requesting the firmware to abort a request and/or send out</span>
<span class="cm"> * a task management function</span>
<span class="cm"> *</span>
<span class="cm"> * The t_tag field is only needed when the request type is ABT_TASK.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_itmf</span> <span class="p">{</span>
	<span class="n">u32</span>   <span class="n">lunmap_id</span><span class="p">;</span>              <span class="cm">/* index into lunmap table */</span>
	<span class="n">u32</span>   <span class="n">tm_req</span><span class="p">;</span>                 <span class="cm">/* SCSI Task Management request */</span>
	<span class="n">u32</span>   <span class="n">t_tag</span><span class="p">;</span>                  <span class="cm">/* header tag of fcpio to be aborted */</span>
	<span class="n">u32</span>   <span class="n">_resvd</span><span class="p">;</span>                 <span class="cm">/* _reserved */</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>       <span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>    <span class="n">_resvd1</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">d_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		      <span class="cm">/* FC vNIC only: Target D_ID */</span>
	<span class="n">u32</span>   <span class="n">r_a_tov</span><span class="p">;</span>                <span class="cm">/* FC vNIC only: R_A_TOV in msec */</span>
	<span class="n">u32</span>   <span class="n">e_d_tov</span><span class="p">;</span>                <span class="cm">/* FC vNIC only: E_D_TOV in msec */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Task Management request</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">fcpio_itmf_tm_req_type</span> <span class="p">{</span>
	<span class="n">FCPIO_ITMF_ABT_TASK_TERM</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>    <span class="cm">/* abort task and terminate */</span>
	<span class="n">FCPIO_ITMF_ABT_TASK</span><span class="p">,</span>                <span class="cm">/* abort task and issue abts */</span>
	<span class="n">FCPIO_ITMF_ABT_TASK_SET</span><span class="p">,</span>            <span class="cm">/* abort task set */</span>
	<span class="n">FCPIO_ITMF_CLR_TASK_SET</span><span class="p">,</span>            <span class="cm">/* clear task set */</span>
	<span class="n">FCPIO_ITMF_LUN_RESET</span><span class="p">,</span>               <span class="cm">/* logical unit reset task mgmt */</span>
	<span class="n">FCPIO_ITMF_CLR_ACA</span><span class="p">,</span>                 <span class="cm">/* Clear ACA condition */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tdata: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for requesting the firmware to send out a read data transfer for a</span>
<span class="cm"> * target command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tdata</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* FC rx_id of target command */</span>
	<span class="n">u16</span>   <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* command flags */</span>
	<span class="n">u32</span>   <span class="n">rel_offset</span><span class="p">;</span>             <span class="cm">/* data sequence relative offset */</span>
	<span class="n">u32</span>   <span class="n">sgl_cnt</span><span class="p">;</span>                <span class="cm">/* scatter-gather list count */</span>
	<span class="n">u32</span>   <span class="n">data_len</span><span class="p">;</span>               <span class="cm">/* length of data expected to send */</span>
	<span class="n">u64</span>   <span class="n">sgl_addr</span><span class="p">;</span>               <span class="cm">/* scatter-gather list address */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Command flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_TDATA_SCSI_RSP    0x01    </span><span class="cm">/* send a scsi resp. after last frame */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_txrdy: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for requesting the firmware to send out a write data transfer for a</span>
<span class="cm"> * target command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_txrdy</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* FC rx_id of target command */</span>
	<span class="n">u16</span>   <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">rel_offset</span><span class="p">;</span>             <span class="cm">/* data sequence relative offset */</span>
	<span class="n">u32</span>   <span class="n">sgl_cnt</span><span class="p">;</span>                <span class="cm">/* scatter-gather list count */</span>
	<span class="n">u32</span>   <span class="n">data_len</span><span class="p">;</span>               <span class="cm">/* length of data expected to send */</span>
	<span class="n">u64</span>   <span class="n">sgl_addr</span><span class="p">;</span>               <span class="cm">/* scatter-gather list address */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_trsp: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used for requesting the firmware to send out a response for a target</span>
<span class="cm"> * command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_trsp</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* FC rx_id of target command */</span>
	<span class="n">u16</span>   <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">sense_len</span><span class="p">;</span>              <span class="cm">/* sense data buffer length */</span>
	<span class="n">u64</span>   <span class="n">sense_addr</span><span class="p">;</span>             <span class="cm">/* sense data buffer address */</span>
	<span class="n">u16</span>   <span class="n">_resvd1</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* response request flags */</span>
	<span class="n">u8</span>    <span class="n">scsi_status</span><span class="p">;</span>            <span class="cm">/* SCSI status */</span>
	<span class="n">u32</span>   <span class="n">residual</span><span class="p">;</span>               <span class="cm">/* SCSI data residual value of I/O */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * resposnse request flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_TRSP_RESID_UNDER  0x08   </span><span class="cm">/* residual is valid and is underflow */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TRSP_RESID_OVER   0x04   </span><span class="cm">/* residual is valid and is overflow */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_ttmf_ack: host -&gt; firmware response</span>
<span class="cm"> *</span>
<span class="cm"> * used by the host to indicate to the firmware it has received and processed</span>
<span class="cm"> * the target tmf request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_ttmf_ack</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* FC rx_id of target command */</span>
	<span class="n">u16</span>   <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">tmf_status</span><span class="p">;</span>             <span class="cm">/* SCSI task management status */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tabort: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used by the host to request the firmware to abort a target request that was</span>
<span class="cm"> * received by the firmware</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tabort</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* rx_id of the target request */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_reset: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * used by the host to signal a reset of the driver to the firmware</span>
<span class="cm"> * and to request firmware to clean up all outstanding I/O</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_reset</span> <span class="p">{</span>
	<span class="n">u32</span>   <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">fcpio_flogi_reg_format_type</span> <span class="p">{</span>
	<span class="n">FCPIO_FLOGI_REG_DEF_DEST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="cm">/* Use the oui | s_id mac format */</span>
	<span class="n">FCPIO_FLOGI_REG_GW_DEST</span><span class="p">,</span>         <span class="cm">/* Use the fixed gateway mac */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_flogi_reg: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * fc vnic only</span>
<span class="cm"> * used by the host to notify the firmware of the lif&#39;s s_id</span>
<span class="cm"> * and destination mac address format</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_flogi_reg</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>			<span class="cm">/* FC vNIC only: Source S_ID */</span>
	<span class="n">u8</span> <span class="n">gateway_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* Destination gateway mac */</span>
	<span class="n">u16</span> <span class="n">_resvd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r_a_tov</span><span class="p">;</span>			<span class="cm">/* R_A_TOV in msec */</span>
	<span class="n">u32</span> <span class="n">e_d_tov</span><span class="p">;</span>			<span class="cm">/* E_D_TOV in msec */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_echo: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * sends a heartbeat echo request to the firmware</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_echo</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_lunmap_req: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * scsi vnic only</span>
<span class="cm"> * sends a request to retrieve the lunmap table for scsi vnics</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_lunmap_req</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>                     <span class="cm">/* address of the buffer */</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>                      <span class="cm">/* len of the buffer */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_flogi_fip_reg: host -&gt; firmware request</span>
<span class="cm"> *</span>
<span class="cm"> * fc vnic only</span>
<span class="cm"> * used by the host to notify the firmware of the lif&#39;s s_id</span>
<span class="cm"> * and destination mac address format</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_flogi_fip_reg</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">_resvd0</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>               <span class="cm">/* FC vNIC only: Source S_ID */</span>
	<span class="n">u8</span>     <span class="n">fcf_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>     <span class="cm">/* FCF Target destination mac */</span>
	<span class="n">u16</span>   <span class="n">_resvd1</span><span class="p">;</span>
	<span class="n">u32</span>   <span class="n">r_a_tov</span><span class="p">;</span>                <span class="cm">/* R_A_TOV in msec */</span>
	<span class="n">u32</span>   <span class="n">e_d_tov</span><span class="p">;</span>                <span class="cm">/* E_D_TOV in msec */</span>
	<span class="n">u8</span>    <span class="n">ha_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>       <span class="cm">/* Host adapter source mac */</span>
	<span class="n">u16</span>   <span class="n">_resvd2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Basic structure for all fcpio structures that are sent from the host to the</span>
<span class="cm"> * firmware.  They are 128 bytes per structure.</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_HOST_REQ_LEN      128     </span><span class="cm">/* expected length of host requests */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">fcpio_host_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcpio_header</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Defines space needed for request</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">FCPIO_HOST_REQ_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_header</span><span class="p">)];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Initiator host requests</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_icmnd_16</span>               <span class="n">icmnd_16</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_icmnd_32</span>               <span class="n">icmnd_32</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_itmf</span>                   <span class="n">itmf</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Target host requests</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_tdata</span>                  <span class="n">tdata</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_txrdy</span>                  <span class="n">txrdy</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_trsp</span>                   <span class="n">trsp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_ttmf_ack</span>               <span class="n">ttmf_ack</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_tabort</span>                 <span class="n">tabort</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Misc requests</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_reset</span>                  <span class="n">reset</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_flogi_reg</span>              <span class="n">flogi_reg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_echo</span>                   <span class="n">echo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_lunmap_req</span>             <span class="n">lunmap_req</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_flogi_fip_reg</span>          <span class="n">flogi_fip_reg</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_icmnd_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * used for sending the host a response to an initiator command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_icmnd_cmpl</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">_resvd0</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>             <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* response flags */</span>
	<span class="n">u8</span>    <span class="n">scsi_status</span><span class="p">;</span>            <span class="cm">/* SCSI status */</span>
	<span class="n">u32</span>   <span class="n">residual</span><span class="p">;</span>               <span class="cm">/* SCSI data residual length */</span>
	<span class="n">u32</span>   <span class="n">sense_len</span><span class="p">;</span>              <span class="cm">/* SCSI sense length */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * response flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_ICMND_CMPL_RESID_UNDER    0x08    </span><span class="cm">/* resid under and valid */</span><span class="cp"></span>
<span class="cp">#define FCPIO_ICMND_CMPL_RESID_OVER     0x04    </span><span class="cm">/* resid over and valid */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_itmf_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * used for sending the host a response for a itmf request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_itmf_cmpl</span> <span class="p">{</span>
	<span class="n">u32</span>    <span class="n">_resvd</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tcmnd_16: firmware -&gt; host request</span>
<span class="cm"> *</span>
<span class="cm"> * used by the firmware to notify the host of an incoming target SCSI 16-Byte</span>
<span class="cm"> * request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tcmnd_16</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>       <span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>    <span class="n">crn</span><span class="p">;</span>                    <span class="cm">/* SCSI Command Reference No. */</span>
	<span class="n">u8</span>    <span class="n">pri_ta</span><span class="p">;</span>                 <span class="cm">/* SCSI Priority and Task attribute */</span>
	<span class="n">u8</span>    <span class="n">_resvd2</span><span class="p">;</span>                <span class="cm">/* reserved: should be 0 */</span>
	<span class="n">u8</span>    <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* command flags */</span>
	<span class="n">u8</span>    <span class="n">scsi_cdb</span><span class="p">[</span><span class="n">CDB_16</span><span class="p">];</span>       <span class="cm">/* SCSI Cmnd Descriptor Block */</span>
	<span class="n">u32</span>   <span class="n">data_len</span><span class="p">;</span>               <span class="cm">/* length of data expected */</span>
	<span class="n">u8</span>    <span class="n">_resvd1</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		      <span class="cm">/* FC vNIC only: Source S_ID */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Priority/Task Attribute settings</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_TCMND_PTA_SIMPLE      0   </span><span class="cm">/* simple task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TCMND_PTA_HEADQ       1   </span><span class="cm">/* head of queue task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TCMND_PTA_ORDERED     2   </span><span class="cm">/* ordered task attribute */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TCMND_PTA_ACA         4   </span><span class="cm">/* auto contingent allegiance */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TCMND_PRI_SHIFT       3   </span><span class="cm">/* priority field starts in bit 3 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Command flags</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_TCMND_RDDATA      0x02    </span><span class="cm">/* read data */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TCMND_WRDATA      0x01    </span><span class="cm">/* write data */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tcmnd_32: firmware -&gt; host request</span>
<span class="cm"> *</span>
<span class="cm"> * used by the firmware to notify the host of an incoming target SCSI 32-Byte</span>
<span class="cm"> * request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tcmnd_32</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>       <span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>    <span class="n">crn</span><span class="p">;</span>                    <span class="cm">/* SCSI Command Reference No. */</span>
	<span class="n">u8</span>    <span class="n">pri_ta</span><span class="p">;</span>                 <span class="cm">/* SCSI Priority and Task attribute */</span>
	<span class="n">u8</span>    <span class="n">_resvd2</span><span class="p">;</span>                <span class="cm">/* reserved: should be 0 */</span>
	<span class="n">u8</span>    <span class="n">flags</span><span class="p">;</span>                  <span class="cm">/* command flags */</span>
	<span class="n">u8</span>    <span class="n">scsi_cdb</span><span class="p">[</span><span class="n">CDB_32</span><span class="p">];</span>       <span class="cm">/* SCSI Cmnd Descriptor Block */</span>
	<span class="n">u32</span>   <span class="n">data_len</span><span class="p">;</span>               <span class="cm">/* length of data expected */</span>
	<span class="n">u8</span>    <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		      <span class="cm">/* FC vNIC only: Source S_ID */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tdrsp_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * used by the firmware to notify the host of a response to a host target</span>
<span class="cm"> * command</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tdrsp_cmpl</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* rx_id of the target request */</span>
	<span class="n">u16</span>   <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_ttmf: firmware -&gt; host request</span>
<span class="cm"> *</span>
<span class="cm"> * used by the firmware to notify the host of an incoming task management</span>
<span class="cm"> * function request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_ttmf</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
	<span class="n">u8</span>    <span class="n">s_id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		      <span class="cm">/* FC vNIC only: Source S_ID */</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">[</span><span class="n">LUN_ADDRESS</span><span class="p">];</span>       <span class="cm">/* FC vNIC only: LUN address */</span>
	<span class="n">u8</span>    <span class="n">crn</span><span class="p">;</span>                    <span class="cm">/* SCSI Command Reference No. */</span>
	<span class="n">u8</span>    <span class="n">_resvd2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>             <span class="cm">/* reserved */</span>
	<span class="n">u32</span>   <span class="n">tmf_type</span><span class="p">;</span>               <span class="cm">/* task management request type */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Task Management request</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_TTMF_CLR_ACA      0x40    </span><span class="cm">/* Clear ACA condition */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TTMF_LUN_RESET    0x10    </span><span class="cm">/* logical unit reset task mgmt */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TTMF_CLR_TASK_SET 0x04    </span><span class="cm">/* clear task set */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TTMF_ABT_TASK_SET 0x02    </span><span class="cm">/* abort task set */</span><span class="cp"></span>
<span class="cp">#define FCPIO_TTMF_ABT_TASK     0x01    </span><span class="cm">/* abort task */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_tabort_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * used by the firmware to respond to a host&#39;s tabort request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_tabort_cmpl</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">rx_id</span><span class="p">;</span>                  <span class="cm">/* rx_id of the target request */</span>
	<span class="n">u16</span>   <span class="n">_resvd0</span><span class="p">;</span>                <span class="cm">/* reserved */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_ack: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * used by firmware to notify the host of the last work request received</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_ack</span> <span class="p">{</span>
	<span class="n">u16</span>  <span class="n">request_out</span><span class="p">;</span>             <span class="cm">/* last host entry received */</span>
	<span class="n">u16</span>  <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_reset_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * use by firmware to respond to the host&#39;s reset request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_reset_cmpl</span> <span class="p">{</span>
	<span class="n">u16</span>   <span class="n">vnic_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_flogi_reg_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * fc vnic only</span>
<span class="cm"> * response to the fcpio_flogi_reg request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_flogi_reg_cmpl</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_echo_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * response to the fcpio_echo request</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_echo_cmpl</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_lunmap_chng: firmware -&gt; host notification</span>
<span class="cm"> *</span>
<span class="cm"> * scsi vnic only</span>
<span class="cm"> * notifies the host that the lunmap tables have changed</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_lunmap_chng</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * fcpio_lunmap_req_cmpl: firmware -&gt; host response</span>
<span class="cm"> *</span>
<span class="cm"> * scsi vnic only</span>
<span class="cm"> * response for lunmap table request from the host</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcpio_lunmap_req_cmpl</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">_resvd</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Basic structure for all fcpio structures that are sent from the firmware to</span>
<span class="cm"> * the host.  They are 64 bytes per structure.</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_FW_REQ_LEN        64      </span><span class="cm">/* expected length of fw requests */</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">fcpio_fw_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcpio_header</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Defines space needed for request</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">FCPIO_FW_REQ_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_header</span><span class="p">)];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Initiator firmware responses</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_icmnd_cmpl</span>         <span class="n">icmnd_cmpl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_itmf_cmpl</span>          <span class="n">itmf_cmpl</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Target firmware new requests</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_tcmnd_16</span>           <span class="n">tcmnd_16</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_tcmnd_32</span>           <span class="n">tcmnd_32</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Target firmware responses</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_tdrsp_cmpl</span>         <span class="n">tdrsp_cmpl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_ttmf</span>               <span class="n">ttmf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_tabort_cmpl</span>        <span class="n">tabort_cmpl</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Firmware response to work received</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_ack</span>                <span class="n">ack</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Misc requests</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fcpio_reset_cmpl</span>         <span class="n">reset_cmpl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_flogi_reg_cmpl</span>     <span class="n">flogi_reg_cmpl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_echo_cmpl</span>          <span class="n">echo_cmpl</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_lunmap_chng</span>        <span class="n">lunmap_chng</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcpio_lunmap_req_cmpl</span>    <span class="n">lunmap_req_cmpl</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Access routines to encode and decode the color bit, which is the most</span>
<span class="cm"> * significant bit of the MSB of the structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fcpio_color_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_fw_req</span> <span class="o">*</span><span class="n">fw_req</span><span class="p">,</span> <span class="n">u8</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_req</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_fw_req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fcpio_color_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_fw_req</span> <span class="o">*</span><span class="n">fw_req</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_req</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcpio_fw_req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">color</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure color bit is read from desc *before* other fields</span>
<span class="cm">	 * are read from desc.  Hardware guarantees color bit is last</span>
<span class="cm">	 * bit (byte) written.  Adding the rmb() prevents the compiler</span>
<span class="cm">	 * and/or CPU from reordering the reads which would potentially</span>
<span class="cm">	 * result in reading stale values.</span>
<span class="cm">	 */</span>

	<span class="n">rmb</span><span class="p">();</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lunmap table entry for scsi vnics</span>
<span class="cm"> */</span>
<span class="cp">#define FCPIO_LUNMAP_TABLE_SIZE     256</span>
<span class="cp">#define FCPIO_FLAGS_LUNMAP_VALID    0x80</span>
<span class="cp">#define FCPIO_FLAGS_BOOT            0x01</span>
<span class="k">struct</span> <span class="n">fcpio_lunmap_entry</span> <span class="p">{</span>
	<span class="n">u8</span>    <span class="n">bus</span><span class="p">;</span>
	<span class="n">u8</span>    <span class="n">target</span><span class="p">;</span>
	<span class="n">u8</span>    <span class="n">lun</span><span class="p">;</span>
	<span class="n">u8</span>    <span class="n">path_cnt</span><span class="p">;</span>
	<span class="n">u16</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>   <span class="n">update_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fcpio_lunmap_tbl</span> <span class="p">{</span>
	<span class="n">u32</span>                   <span class="n">update_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcpio_lunmap_entry</span>   <span class="n">lunmaps</span><span class="p">[</span><span class="n">FCPIO_LUNMAP_TABLE_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* _FCPIO_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
