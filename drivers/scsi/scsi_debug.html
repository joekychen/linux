<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › scsi_debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>scsi_debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * vvvvvvvvvvvvvvvvvvvvvvv Original vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv</span>
<span class="cm"> *  Copyright (C) 1992  Eric Youngdale</span>
<span class="cm"> *  Simulate a host adapter with 2 disks attached.  Do a lot of checking</span>
<span class="cm"> *  to make sure that we are not getting blocks mixed up, and PANIC if</span>
<span class="cm"> *  anything out of the ordinary is seen.</span>
<span class="cm"> * ^^^^^^^^^^^^^^^^^^^^^^^ Original ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="cm"> *</span>
<span class="cm"> *  This version is more generic, simulating a variable number of disk</span>
<span class="cm"> *  (or disk like devices) sharing a common amount of RAM. To be more</span>
<span class="cm"> *  realistic, the simulated devices have the transport attributes of</span>
<span class="cm"> *  SAS disks.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  For documentation see http://sg.danny.cz/sg/sdebug26.html</span>
<span class="cm"> *</span>
<span class="cm"> *   D. Gilbert (dpg) work for Magneto-Optical device test [20010421]</span>
<span class="cm"> *   dpg: work for devfs large number of disks [20010809]</span>
<span class="cm"> *        forked for lk 2.5 series [20011216, 20020101]</span>
<span class="cm"> *        use vmalloc() more inquiry+mode_sense [20020302]</span>
<span class="cm"> *        add timers for delayed responses [20020721]</span>
<span class="cm"> *   Patrick Mansfield &lt;patmans@us.ibm.com&gt; max_luns+scsi_level [20021031]</span>
<span class="cm"> *   Mike Anderson &lt;andmike@us.ibm.com&gt; sysfs work [20021118]</span>
<span class="cm"> *   dpg: change style of boot options to &quot;scsi_debug.num_tgts=2&quot; and</span>
<span class="cm"> *        module options to &quot;modprobe scsi_debug num_tgts=2&quot; [20021221]</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/crc-t10dif.h&gt;</span>

<span class="cp">#include &lt;net/checksum.h&gt;</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#include &quot;sd.h&quot;</span>
<span class="cp">#include &quot;scsi_logging.h&quot;</span>

<span class="cp">#define SCSI_DEBUG_VERSION &quot;1.82&quot;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">scsi_debug_version_date</span> <span class="o">=</span> <span class="s">&quot;20100324&quot;</span><span class="p">;</span>

<span class="cm">/* Additional Sense Code (ASC) */</span>
<span class="cp">#define NO_ADDITIONAL_SENSE 0x0</span>
<span class="cp">#define LOGICAL_UNIT_NOT_READY 0x4</span>
<span class="cp">#define UNRECOVERED_READ_ERR 0x11</span>
<span class="cp">#define PARAMETER_LIST_LENGTH_ERR 0x1a</span>
<span class="cp">#define INVALID_OPCODE 0x20</span>
<span class="cp">#define ADDR_OUT_OF_RANGE 0x21</span>
<span class="cp">#define INVALID_COMMAND_OPCODE 0x20</span>
<span class="cp">#define INVALID_FIELD_IN_CDB 0x24</span>
<span class="cp">#define INVALID_FIELD_IN_PARAM_LIST 0x26</span>
<span class="cp">#define POWERON_RESET 0x29</span>
<span class="cp">#define SAVING_PARAMS_UNSUP 0x39</span>
<span class="cp">#define TRANSPORT_PROBLEM 0x4b</span>
<span class="cp">#define THRESHOLD_EXCEEDED 0x5d</span>
<span class="cp">#define LOW_POWER_COND_ON 0x5e</span>

<span class="cm">/* Additional Sense Code Qualifier (ASCQ) */</span>
<span class="cp">#define ACK_NAK_TO 0x3</span>

<span class="cp">#define SDEBUG_TAGGED_QUEUING 0 </span><span class="cm">/* 0 | MSG_SIMPLE_TAG | MSG_ORDERED_TAG */</span><span class="cp"></span>

<span class="cm">/* Default values for driver parameters */</span>
<span class="cp">#define DEF_NUM_HOST   1</span>
<span class="cp">#define DEF_NUM_TGTS   1</span>
<span class="cp">#define DEF_MAX_LUNS   1</span>
<span class="cm">/* With these defaults, this driver will make 1 host with 1 target</span>
<span class="cm"> * (id 0) containing 1 logical unit (lun 0). That is 1 device.</span>
<span class="cm"> */</span>
<span class="cp">#define DEF_ATO 1</span>
<span class="cp">#define DEF_DELAY   1</span>
<span class="cp">#define DEF_DEV_SIZE_MB   8</span>
<span class="cp">#define DEF_DIF 0</span>
<span class="cp">#define DEF_DIX 0</span>
<span class="cp">#define DEF_D_SENSE   0</span>
<span class="cp">#define DEF_EVERY_NTH   0</span>
<span class="cp">#define DEF_FAKE_RW	0</span>
<span class="cp">#define DEF_GUARD 0</span>
<span class="cp">#define DEF_LBPU 0</span>
<span class="cp">#define DEF_LBPWS 0</span>
<span class="cp">#define DEF_LBPWS10 0</span>
<span class="cp">#define DEF_LBPRZ 1</span>
<span class="cp">#define DEF_LOWEST_ALIGNED 0</span>
<span class="cp">#define DEF_NO_LUN_0   0</span>
<span class="cp">#define DEF_NUM_PARTS   0</span>
<span class="cp">#define DEF_OPTS   0</span>
<span class="cp">#define DEF_OPT_BLKS 64</span>
<span class="cp">#define DEF_PHYSBLK_EXP 0</span>
<span class="cp">#define DEF_PTYPE   0</span>
<span class="cp">#define DEF_SCSI_LEVEL   5    </span><span class="cm">/* INQUIRY, byte2 [5-&gt;SPC-3] */</span><span class="cp"></span>
<span class="cp">#define DEF_SECTOR_SIZE 512</span>
<span class="cp">#define DEF_UNMAP_ALIGNMENT 0</span>
<span class="cp">#define DEF_UNMAP_GRANULARITY 1</span>
<span class="cp">#define DEF_UNMAP_MAX_BLOCKS 0xFFFFFFFF</span>
<span class="cp">#define DEF_UNMAP_MAX_DESC 256</span>
<span class="cp">#define DEF_VIRTUAL_GB   0</span>
<span class="cp">#define DEF_VPD_USE_HOSTNO 1</span>
<span class="cp">#define DEF_WRITESAME_LENGTH 0xFFFF</span>

<span class="cm">/* bit mask values for scsi_debug_opts */</span>
<span class="cp">#define SCSI_DEBUG_OPT_NOISE   1</span>
<span class="cp">#define SCSI_DEBUG_OPT_MEDIUM_ERR   2</span>
<span class="cp">#define SCSI_DEBUG_OPT_TIMEOUT   4</span>
<span class="cp">#define SCSI_DEBUG_OPT_RECOVERED_ERR   8</span>
<span class="cp">#define SCSI_DEBUG_OPT_TRANSPORT_ERR   16</span>
<span class="cp">#define SCSI_DEBUG_OPT_DIF_ERR   32</span>
<span class="cp">#define SCSI_DEBUG_OPT_DIX_ERR   64</span>
<span class="cp">#define SCSI_DEBUG_OPT_MAC_TIMEOUT  128</span>
<span class="cm">/* When &quot;every_nth&quot; &gt; 0 then modulo &quot;every_nth&quot; commands:</span>
<span class="cm"> *   - a no response is simulated if SCSI_DEBUG_OPT_TIMEOUT is set</span>
<span class="cm"> *   - a RECOVERED_ERROR is simulated on successful read and write</span>
<span class="cm"> *     commands if SCSI_DEBUG_OPT_RECOVERED_ERR is set.</span>
<span class="cm"> *   - a TRANSPORT_ERROR is simulated on successful read and write</span>
<span class="cm"> *     commands if SCSI_DEBUG_OPT_TRANSPORT_ERR is set.</span>
<span class="cm"> *</span>
<span class="cm"> * When &quot;every_nth&quot; &lt; 0 then after &quot;- every_nth&quot; commands:</span>
<span class="cm"> *   - a no response is simulated if SCSI_DEBUG_OPT_TIMEOUT is set</span>
<span class="cm"> *   - a RECOVERED_ERROR is simulated on successful read and write</span>
<span class="cm"> *     commands if SCSI_DEBUG_OPT_RECOVERED_ERR is set.</span>
<span class="cm"> *   - a TRANSPORT_ERROR is simulated on successful read and write</span>
<span class="cm"> *     commands if SCSI_DEBUG_OPT_TRANSPORT_ERR is set.</span>
<span class="cm"> * This will continue until some other action occurs (e.g. the user</span>
<span class="cm"> * writing a new value (other than -1 or 1) to every_nth via sysfs).</span>
<span class="cm"> */</span>

<span class="cm">/* when 1==SCSI_DEBUG_OPT_MEDIUM_ERR, a medium error is simulated at this</span>
<span class="cm"> * sector on read commands: */</span>
<span class="cp">#define OPT_MEDIUM_ERR_ADDR   0x1234 </span><span class="cm">/* that&#39;s sector 4660 in decimal */</span><span class="cp"></span>
<span class="cp">#define OPT_MEDIUM_ERR_NUM    10     </span><span class="cm">/* number of consecutive medium errs */</span><span class="cp"></span>

<span class="cm">/* If REPORT LUNS has luns &gt;= 256 it can choose &quot;flat space&quot; (value 1)</span>
<span class="cm"> * or &quot;peripheral device&quot; addressing (value 0) */</span>
<span class="cp">#define SAM2_LUN_ADDRESS_METHOD 0</span>
<span class="cp">#define SAM2_WLUN_REPORT_LUNS 0xc101</span>

<span class="cm">/* Can queue up to this number of commands. Typically commands that</span>
<span class="cm"> * that have a non-zero delay are queued. */</span>
<span class="cp">#define SCSI_DEBUG_CANQUEUE  255</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_add_host</span> <span class="o">=</span> <span class="n">DEF_NUM_HOST</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_ato</span> <span class="o">=</span> <span class="n">DEF_ATO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_delay</span> <span class="o">=</span> <span class="n">DEF_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_dev_size_mb</span> <span class="o">=</span> <span class="n">DEF_DEV_SIZE_MB</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_dif</span> <span class="o">=</span> <span class="n">DEF_DIF</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_dix</span> <span class="o">=</span> <span class="n">DEF_DIX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_dsense</span> <span class="o">=</span> <span class="n">DEF_D_SENSE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_every_nth</span> <span class="o">=</span> <span class="n">DEF_EVERY_NTH</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_fake_rw</span> <span class="o">=</span> <span class="n">DEF_FAKE_RW</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_guard</span> <span class="o">=</span> <span class="n">DEF_GUARD</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_lowest_aligned</span> <span class="o">=</span> <span class="n">DEF_LOWEST_ALIGNED</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_max_luns</span> <span class="o">=</span> <span class="n">DEF_MAX_LUNS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_max_queue</span> <span class="o">=</span> <span class="n">SCSI_DEBUG_CANQUEUE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_no_lun_0</span> <span class="o">=</span> <span class="n">DEF_NO_LUN_0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_no_uld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_num_parts</span> <span class="o">=</span> <span class="n">DEF_NUM_PARTS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_num_tgts</span> <span class="o">=</span> <span class="n">DEF_NUM_TGTS</span><span class="p">;</span> <span class="cm">/* targets per host */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_opt_blks</span> <span class="o">=</span> <span class="n">DEF_OPT_BLKS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_opts</span> <span class="o">=</span> <span class="n">DEF_OPTS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_physblk_exp</span> <span class="o">=</span> <span class="n">DEF_PHYSBLK_EXP</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_ptype</span> <span class="o">=</span> <span class="n">DEF_PTYPE</span><span class="p">;</span> <span class="cm">/* SCSI peripheral type (0==disk) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_scsi_level</span> <span class="o">=</span> <span class="n">DEF_SCSI_LEVEL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_sector_size</span> <span class="o">=</span> <span class="n">DEF_SECTOR_SIZE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_virtual_gb</span> <span class="o">=</span> <span class="n">DEF_VIRTUAL_GB</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_vpd_use_hostno</span> <span class="o">=</span> <span class="n">DEF_VPD_USE_HOSTNO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_lbpu</span> <span class="o">=</span> <span class="n">DEF_LBPU</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_lbpws</span> <span class="o">=</span> <span class="n">DEF_LBPWS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_lbpws10</span> <span class="o">=</span> <span class="n">DEF_LBPWS10</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_lbprz</span> <span class="o">=</span> <span class="n">DEF_LBPRZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_unmap_alignment</span> <span class="o">=</span> <span class="n">DEF_UNMAP_ALIGNMENT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_unmap_granularity</span> <span class="o">=</span> <span class="n">DEF_UNMAP_GRANULARITY</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_unmap_max_blocks</span> <span class="o">=</span> <span class="n">DEF_UNMAP_MAX_BLOCKS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_unmap_max_desc</span> <span class="o">=</span> <span class="n">DEF_UNMAP_MAX_DESC</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_debug_write_same_length</span> <span class="o">=</span> <span class="n">DEF_WRITESAME_LENGTH</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">scsi_debug_cmnd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define DEV_READONLY(TGT)      (0)</span>
<span class="cp">#define DEV_REMOVEABLE(TGT)    (0)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sdebug_store_sectors</span><span class="p">;</span>
<span class="k">static</span> <span class="n">sector_t</span> <span class="n">sdebug_capacity</span><span class="p">;</span>	<span class="cm">/* in sectors */</span>

<span class="cm">/* old BIOS stuff, kernel may get rid of them but some mode sense pages</span>
<span class="cm">   may still need them */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdebug_heads</span><span class="p">;</span>		<span class="cm">/* heads per disk */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdebug_cylinders_per</span><span class="p">;</span>	<span class="cm">/* cylinders per surface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>		<span class="cm">/* sectors per cylinder */</span>

<span class="cp">#define SDEBUG_MAX_PARTS 4</span>

<span class="cp">#define SDEBUG_SENSE_LEN 32</span>

<span class="cp">#define SCSI_DEBUG_MAX_CMD_LEN 32</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">scsi_debug_lbp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scsi_debug_lbpu</span> <span class="o">|</span> <span class="n">scsi_debug_lbpws</span> <span class="o">|</span> <span class="n">scsi_debug_lbpws10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dev_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense_buff</span><span class="p">[</span><span class="n">SDEBUG_SENSE_LEN</span><span class="p">];</span>	<span class="cm">/* weak nexus */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wlun</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">reset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">stopped</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">used</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">host_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dev_info_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_sdebug_host(d)	\</span>
<span class="cp">	container_of(d, struct sdebug_host_info, dev)</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">sdebug_host_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">done_funct_t</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">in_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">cmnd_timer</span><span class="p">;</span>
	<span class="n">done_funct_t</span> <span class="n">done_funct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">a_cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scsi_result</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="n">queued_arr</span><span class="p">[</span><span class="n">SCSI_DEBUG_CANQUEUE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">fake_storep</span><span class="p">;</span>	<span class="cm">/* ramdisk storage */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dif_storep</span><span class="p">;</span>	<span class="cm">/* protection info */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">map_storep</span><span class="p">;</span>		<span class="cm">/* provisioning map */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_size</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_aborts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_dev_resets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_bus_resets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_host_resets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dix_writes</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dix_reads</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dif_errors</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">queued_arr_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">atomic_rw</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">sdebug_proc_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;scsi_debug&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">pseudo_lld_bus</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">sector_t</span> <span class="nf">dif_offset</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sector</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">sdebug_driverfs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="n">sdebug_proc_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pseudo_lld_bus</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">check_condition_result</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">illegal_condition_result</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ctrl_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xa</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iec_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			           <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sdebug_add_adapter</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sdebug_remove_adapter</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdebug_max_tgts_luns</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">hpnt</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdebug_host_list</span><span class="p">,</span> <span class="n">host_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hpnt</span> <span class="o">=</span> <span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">scsi_debug_num_tgts</span> <span class="o">&gt;</span> <span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">))</span>
			<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">scsi_debug_num_tgts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">scsi_debug_num_tgts</span><span class="p">;</span>
		<span class="cm">/* scsi_debug_max_luns; */</span>
		<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mk_sense_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">asc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">asq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sbuff</span><span class="p">;</span>

	<span class="n">sbuff</span> <span class="o">=</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sbuff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_SENSE_LEN</span><span class="p">);</span>

	<span class="n">scsi_build_sense_buffer</span><span class="p">(</span><span class="n">scsi_debug_dsense</span><span class="p">,</span> <span class="n">sbuff</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">asq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug:    [sense_key,asc,ascq]: &quot;</span>
		      <span class="s">&quot;[0x%x,0x%x,0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">asq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_data_transfer_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="o">*</span><span class="n">ei_lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ei_lba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VARIABLE_LENGTH_CMD</span>:
		<span class="o">*</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">;</span>

		<span class="o">*</span><span class="n">ei_lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_SAME_16</span>:
	<span class="k">case</span> <span class="n">WRITE_16</span>:
	<span class="k">case</span> <span class="n">READ_16</span>:
		<span class="o">*</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">;</span>

		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_12</span>:
	<span class="k">case</span> <span class="n">READ_12</span>:
		<span class="o">*</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_SAME</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
	<span class="k">case</span> <span class="n">READ_10</span>:
	<span class="k">case</span> <span class="n">XDWRITEREAD_10</span>:
		<span class="o">*</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>	<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_6</span>:
	<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="o">*</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: ioctl: cmd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* return -ENOTTY; // correct return but upsets fdisk */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_readiness</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_only</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: Reporting Unit &quot;</span>
			       <span class="s">&quot;attention: power on reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devip</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">UNIT_ATTENTION</span><span class="p">,</span> <span class="n">POWERON_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">reset_only</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: Reporting Not &quot;</span>
			       <span class="s">&quot;ready: initializing command required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">NOT_READY</span><span class="p">,</span> <span class="n">LOGICAL_UNIT_NOT_READY</span><span class="p">,</span>
				<span class="mh">0x2</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns 0 if ok else (DID_ERROR &lt;&lt; 16). Sets scp-&gt;resid . */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_from_dev_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">arr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">act_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_data_buffer</span> <span class="o">*</span><span class="n">sdb</span> <span class="o">=</span> <span class="n">scsi_in</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdb</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">scp</span><span class="p">)</span> <span class="o">||</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">act_len</span> <span class="o">=</span> <span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span>
				      <span class="n">arr</span><span class="p">,</span> <span class="n">arr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdb</span><span class="o">-&gt;</span><span class="n">resid</span><span class="p">)</span>
		<span class="n">sdb</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">-=</span> <span class="n">act_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdb</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">)</span> <span class="o">-</span> <span class="n">act_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns number of bytes fetched into &#39;arr&#39; or -1 if error. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fetch_to_dev_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">arr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">scp</span><span class="p">)</span> <span class="o">||</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">arr_len</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">inq_vendor_id</span> <span class="o">=</span> <span class="s">&quot;Linux   &quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">inq_product_id</span> <span class="o">=</span> <span class="s">&quot;scsi_debug      &quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">inq_product_rev</span> <span class="o">=</span> <span class="s">&quot;0004&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_83</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port_group_id</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">target_dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_id_num</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">dev_id_str</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">dev_id_str_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">port_a</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">port_a</span> <span class="o">=</span> <span class="n">target_dev_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* T10 vendor identifier field format (faked) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* ASCII */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">inq_vendor_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">inq_product_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span> <span class="n">dev_id_str</span><span class="p">,</span> <span class="n">dev_id_str_len</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">dev_id_str_len</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_id_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NAA-5, Logical unit identifier (binary) */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* binary (not necessarily sas) */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* PIV=0, lu, naa */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">;</span>  <span class="cm">/* naa-5 ieee company id=0x333333 (fake) */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_id_num</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_id_num</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_id_num</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_id_num</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="cm">/* Target relative port number */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x94</span><span class="p">;</span>	<span class="cm">/* PIV=1, target port, rel port */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>	<span class="cm">/* length */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* relative port A */</span>
	<span class="p">}</span>
	<span class="cm">/* NAA-5, Target port identifier */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x93</span><span class="p">;</span>	<span class="cm">/* piv=1, target port, naa */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>	<span class="cm">/* naa-5, company id=0x222222 (fake) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* NAA-5, Target port group identifier */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x95</span><span class="p">;</span>	<span class="cm">/* piv=1, target port group id */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_group_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_group_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* NAA-5, Target device identifier */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa3</span><span class="p">;</span>	<span class="cm">/* piv=1, target device, naa */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>	<span class="cm">/* naa-5, company id=0x222222 (fake) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_dev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_dev_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* SCSI name string: Target device identifier */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">;</span>	<span class="cm">/* proto=sas, UTF-8 */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa8</span><span class="p">;</span>	<span class="cm">/* piv=1, target device, SCSI name string */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="s">&quot;naa.52222220&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;%08X&quot;</span><span class="p">,</span> <span class="n">target_dev_id</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vpd84_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* from 4th byte */</span> <span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span>
    <span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span>
    <span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_84</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">vpd84_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd84_data</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd84_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_85</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">na1</span> <span class="o">=</span> <span class="s">&quot;https://www.kernel.org/config&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">na2</span> <span class="o">=</span> <span class="s">&quot;http://www.kernel.org/log&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plen</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>

	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* lu, storage config */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">olen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">na1</span><span class="p">);</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">olen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="p">((</span><span class="n">plen</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>	<span class="cm">/* length, null termianted, padded */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">na1</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">olen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plen</span> <span class="o">-</span> <span class="n">olen</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>	<span class="cm">/* lu, logging */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">olen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">na2</span><span class="p">);</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">olen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="p">((</span><span class="n">plen</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>	<span class="cm">/* length, null terminated, padded */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">na2</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="n">olen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plen</span> <span class="o">-</span> <span class="n">olen</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SCSI ports VPD page */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_88</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target_dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_a</span><span class="p">,</span> <span class="n">port_b</span><span class="p">;</span>

	<span class="n">port_a</span> <span class="o">=</span> <span class="n">target_dev_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port_b</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* relative port 1 (primary) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* length tp descriptor */</span>
	<span class="cm">/* naa-5 target port identifier (A) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x93</span><span class="p">;</span>	<span class="cm">/* PIV=1, target port, NAA */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>	<span class="cm">/* length */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>	<span class="cm">/* NAA-5, company_id=0x222222 (fake) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* relative port 2 (secondary) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* length tp descriptor */</span>
	<span class="cm">/* naa-5 target port identifier (B) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>	<span class="cm">/* proto=sas, binary */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x93</span><span class="p">;</span>	<span class="cm">/* PIV=1, target port, NAA */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>	<span class="cm">/* length */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>	<span class="cm">/* NAA-5, company_id=0x222222 (fake) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_b</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vpd89_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* from 4th byte */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;u&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span>
<span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="sc">&#39;T&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;s&#39;</span><span class="p">,</span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="sc">&#39;s&#39;</span><span class="p">,</span><span class="sc">&#39;i&#39;</span><span class="p">,</span><span class="sc">&#39;_&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;b&#39;</span><span class="p">,</span><span class="sc">&#39;u&#39;</span><span class="p">,</span><span class="sc">&#39;g&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span>
<span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="sc">&#39;4&#39;</span><span class="p">,</span>
<span class="mh">0x34</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0xec</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0x5a</span><span class="p">,</span><span class="mh">0xc</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
<span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span>
<span class="mh">0x38</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span>
<span class="mh">0x53</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span>
<span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
<span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
<span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
<span class="mh">0x10</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0x3f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xc1</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0x3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0x7e</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x6b</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x7d</span><span class="p">,</span><span class="mh">0x3</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0x3</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span>
<span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mh">0x1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xb6</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x6</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xc6</span><span class="p">,</span><span class="mh">0x7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span>
<span class="mh">0xf0</span><span class="p">,</span><span class="mh">0xf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x6</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_89</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">vpd89_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd89_data</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpd89_data</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Block limits VPD page (SBC-3) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vpdb0_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* from 4th byte */</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_b0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gran</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">vpdb0_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpdb0_data</span><span class="p">));</span>

	<span class="cm">/* Optimal transfer length granularity */</span>
	<span class="n">gran</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scsi_debug_physblk_exp</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gran</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gran</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Maximum Transfer Length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdebug_store_sectors</span> <span class="o">&gt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_store_sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_store_sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_store_sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_store_sectors</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Optimal Transfer Length */</span>
	<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">scsi_debug_opt_blks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Maximum Unmap LBA Count */</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">scsi_debug_unmap_max_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>

		<span class="cm">/* Maximum Unmap Block Descriptor Count */</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">scsi_debug_unmap_max_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Unmap Granularity Alignment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_unmap_alignment</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">scsi_debug_unmap_alignment</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* UGAVALID */</span>
	<span class="p">}</span>

	<span class="cm">/* Optimal Unmap Granularity */</span>
	<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">scsi_debug_unmap_granularity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">24</span><span class="p">]);</span>

	<span class="cm">/* Maximum WRITE SAME Length */</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">scsi_debug_write_same_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mh">0x3c</span><span class="p">;</span> <span class="cm">/* Mandatory page length for Logical Block Provisioning */</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vpdb0_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Block device characteristics VPD page (SBC-3) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_b1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* non rotating medium (e.g. solid state) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* less than 1.8&quot; */</span>

	<span class="k">return</span> <span class="mh">0x3c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Logical block provisioning VPD page (SBC-3) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry_evpd_b2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* threshold exponent */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbpu</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbpws</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbpws10</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbprz</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mh">0x4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_LONG_INQ_SZ 96</span>
<span class="cp">#define SDEBUG_MAX_INQ_ARR_SZ 584</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pq_pdt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">alloc_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">arr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SDEBUG_MAX_INQ_ARR_SZ</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">arr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DID_REQUEUE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">wlun</span><span class="p">)</span>
		<span class="n">pq_pdt</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">;</span>	<span class="cm">/* present, wlun */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_no_lun_0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span>
		<span class="n">pq_pdt</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* not present, no device type */</span>
	<span class="k">else</span>
		<span class="n">pq_pdt</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_ptype</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pq_pdt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>  <span class="cm">/* CMDDT bit set */</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>  <span class="cm">/* EVPD bit set */</span>
		<span class="kt">int</span> <span class="n">lu_id_num</span><span class="p">,</span> <span class="n">port_group_id</span><span class="p">,</span> <span class="n">target_dev_id</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">lu_id_str</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">host_no</span> <span class="o">=</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
		
		<span class="n">port_group_id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">scsi_debug_vpd_use_hostno</span><span class="p">)</span>
			<span class="n">host_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lu_id_num</span> <span class="o">=</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">wlun</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(((</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">target_dev_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span>
				 <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">lu_id_str</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">lu_id_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* supported vital product data pages */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>   <span class="cm">/* this page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="cm">/* unit serial number */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span>  <span class="cm">/* device identification */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>  <span class="cm">/* software interface ident. */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">;</span>  <span class="cm">/* management network addresses */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>  <span class="cm">/* extended inquiry */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x87</span><span class="p">;</span>  <span class="cm">/* mode page policy */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>  <span class="cm">/* SCSI ports */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x89</span><span class="p">;</span>  <span class="cm">/* ATA information */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb0</span><span class="p">;</span>  <span class="cm">/* Block limits (SBC) */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb1</span><span class="p">;</span>  <span class="cm">/* Block characteristics (SBC) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbp</span><span class="p">())</span> <span class="cm">/* Logical Block Prov. (SBC) */</span>
				<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb2</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>	  <span class="cm">/* number of supported VPD pages */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* unit serial number */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lu_id_str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x83</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* device identification */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_83</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">port_group_id</span><span class="p">,</span>
						 <span class="n">target_dev_id</span><span class="p">,</span> <span class="n">lu_id_num</span><span class="p">,</span>
						 <span class="n">lu_id_str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x84</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Software interface ident. */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_84</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x85</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Management network addresses */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_85</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x86</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* extended inquiry */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">;</span>	<span class="cm">/* number of following entries */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE3_PROTECTION</span><span class="p">)</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>	<span class="cm">/* SPT: GRD_CHK:1 */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span><span class="p">)</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>   <span class="cm">/* SPT: GRD_CHK:1, REF_CHK:1 */</span>
			<span class="k">else</span>
				<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>   <span class="cm">/* no protection stuff */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>   <span class="cm">/* head of q, ordered + simple q&#39;s */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x87</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* mode page policy */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>	<span class="cm">/* number of following entries */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* disconnect-reconnect mp */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* mlus, shared */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>	 <span class="cm">/* protocol specific lu */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>	 <span class="cm">/* mlus, per initiator port */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x88</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* SCSI Ports */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_88</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">target_dev_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x89</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* ATA information */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>        <span class="cm">/*sanity */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">inquiry_evpd_89</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0xb0</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Block limits (SBC) */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>        <span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_b0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0xb1</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Block characteristics (SBC) */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>        <span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_b1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0xb2</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Logical Block Prov. (SBC) */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>        <span class="cm">/*sanity */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inquiry_evpd_b2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Illegal request, invalid field in cdb */</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">SDEBUG_MAX_INQ_ARR_SZ</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* drops through here for a standard inquiry */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEV_REMOVEABLE</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Removable disk */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_scsi_level</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>    <span class="cm">/* response_data_format==2 */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDEBUG_LONG_INQ_SZ</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_dif</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* PROTECT bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">scsi_debug_vpd_use_hostno</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* claim: implicit TGPS */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* claim: MultiP */</span>
	<span class="cm">/* arr[6] |= 0x40; ... claim: EncServ (enclosure services) */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span> <span class="cm">/* claim: LINKED + CMDQUE */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">inq_vendor_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">inq_product_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">inq_product_rev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* version descriptors (2 bytes each) follow */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">arr</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span> <span class="cm">/* SAM-3 ANSI */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="n">arr</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>  <span class="cm">/* SPC-3 ANSI */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_ptype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">;</span> <span class="cm">/* SBC-2 ANSI */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_ptype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span> <span class="cm">/* SSC-2 no version */</span>
	<span class="p">}</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span> <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>  <span class="cm">/* SAS-1.1 rev 10 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">alloc_len</span><span class="p">,</span> <span class="n">SDEBUG_LONG_INQ_SZ</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sbuff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_SENSE_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">want_dsense</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_ADDITIONAL_SENSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">want_dsense</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">scsi_debug_dsense</span><span class="p">;</span>
	<span class="n">sbuff</span> <span class="o">=</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iec_m_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">==</span> <span class="p">(</span><span class="n">iec_m_pg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">want_dsense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* NO_SENSE in sense_key */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">THRESHOLD_EXCEEDED</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* TEST set and MRIE==6 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* NO_SENSE in sense_key */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>   	<span class="cm">/* 18 byte sense buffer */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">THRESHOLD_EXCEEDED</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* TEST set and MRIE==6 */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sbuff</span><span class="p">,</span> <span class="n">SDEBUG_SENSE_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">scsi_debug_dsense</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* DESC bit set and sense_buff in fixed format */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">));</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbuff</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>     <span class="cm">/* sense key */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbuff</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>    <span class="cm">/* asc */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbuff</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>    <span class="cm">/* ascq */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_ADDITIONAL_SENSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">power_cond</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="n">power_cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_cond</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
		<span class="n">devip</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="o">!</span><span class="n">start</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sector_t</span> <span class="nf">get_sdebug_capacity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_virtual_gb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">scsi_debug_virtual_gb</span> <span class="o">*</span>
			<span class="p">(</span><span class="mi">1073741824</span> <span class="o">/</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sdebug_store_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_READCAP_ARR_SZ 8</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_readcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_READCAP_ARR_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">capac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errsts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="cm">/* following just in case virtual_gb changed */</span>
	<span class="n">sdebug_capacity</span> <span class="o">=</span> <span class="n">get_sdebug_capacity</span><span class="p">();</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_READCAP_ARR_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdebug_capacity</span> <span class="o">&lt;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">capac</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sdebug_capacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capac</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capac</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">capac</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">capac</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_sector_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">SDEBUG_READCAP_ARR_SZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_READCAP16_ARR_SZ 32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_readcap16</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_READCAP16_ARR_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">capac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errsts</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		     <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="cm">/* following just in case virtual_gb changed */</span>
	<span class="n">sdebug_capacity</span> <span class="o">=</span> <span class="n">get_sdebug_capacity</span><span class="p">();</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_READCAP16_ARR_SZ</span><span class="p">);</span>
	<span class="n">capac</span> <span class="o">=</span> <span class="n">sdebug_capacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">,</span> <span class="n">capac</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">capac</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_sector_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_physblk_exp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_lowest_aligned</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbp</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* LBPME */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbprz</span><span class="p">)</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* LBPRZ */</span>
	<span class="p">}</span>

	<span class="n">arr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_lowest_aligned</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* P_TYPE */</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PROT_EN */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
				    <span class="n">min</span><span class="p">(</span><span class="n">alloc_len</span><span class="p">,</span> <span class="n">SDEBUG_READCAP16_ARR_SZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_MAX_TGTPGS_ARR_SZ 1412</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_report_tgtpgs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">host_no</span> <span class="o">=</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">alen</span><span class="p">,</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_group_a</span><span class="p">,</span> <span class="n">port_group_b</span><span class="p">,</span> <span class="n">port_a</span><span class="p">,</span> <span class="n">port_b</span><span class="p">;</span>

	<span class="n">alen</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

	<span class="n">arr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SDEBUG_MAX_TGTPGS_ARR_SZ</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">arr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DID_REQUEUE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * EVPD page 0x88 states we have two ports, one</span>
<span class="cm">	 * real and a fake port with no device connected.</span>
<span class="cm">	 * So we create two port groups with one port each</span>
<span class="cm">	 * and set the group with port B to unavailable.</span>
<span class="cm">	 */</span>
	<span class="n">port_a</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* relative port A */</span>
	<span class="n">port_b</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* relative port B */</span>
	<span class="n">port_group_a</span> <span class="o">=</span> <span class="p">(((</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">port_group_b</span> <span class="o">=</span> <span class="p">(((</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The asymmetric access state is cycled according to the host_id.</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">scsi_debug_vpd_use_hostno</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">host_no</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Asymm access state */</span>
	    <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span> <span class="cm">/* claim: all states are supported */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="cm">/* Active/Optimized path */</span>
	    <span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* claim: only support active/optimized paths */</span>
	<span class="p">}</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_group_a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_group_a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Status code */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Vendor unique */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>  <span class="cm">/* One port per group */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>    <span class="cm">/* Port unavailable */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* claim: only unavailalbe paths are supported */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_group_b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_group_b</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Status code */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Vendor unique */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>  <span class="cm">/* One port per group */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Reserved */</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_b</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return the smallest value of either</span>
<span class="cm">	 * - The allocated length</span>
<span class="cm">	 * - The constructed command length</span>
<span class="cm">	 * - The maximum array size</span>
<span class="cm">	 */</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">alen</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
				   <span class="n">min</span><span class="p">(</span><span class="n">rlen</span><span class="p">,</span> <span class="n">SDEBUG_MAX_TGTPGS_ARR_SZ</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* &lt;&lt;Following mode page info copied from ST318451LW&gt;&gt; */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_err_recov_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* Read-Write Error Recovery page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">err_recov_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">err_recov_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">err_recov_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">err_recov_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">err_recov_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_disconnect_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span> 	<span class="cm">/* Disconnect-Reconnect page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">disconnect_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x2</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">disconnect_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disconnect_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disconnect_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disconnect_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_format_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>       <span class="cm">/* Format device page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">format_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">format_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format_pg</span><span class="p">));</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_sectors_per</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_sectors_per</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_sector_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DEV_REMOVEABLE</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* should agree with INQUIRY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_caching_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span> 	<span class="cm">/* Caching page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">caching_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">caching_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caching_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caching_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caching_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_ctrl_m_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span> 	<span class="cm">/* Control mode page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch_ctrl_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="cm">/* 0xa, 10, */</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d_ctrl_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xa</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dsense</span><span class="p">)</span>
		<span class="n">ctrl_m_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl_m_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_ato</span><span class="p">)</span>
		<span class="n">ctrl_m_pg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* ATO=1 */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ctrl_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl_m_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ch_ctrl_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_ctrl_m_pg</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d_ctrl_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d_ctrl_m_pg</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl_m_pg</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_iec_m_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* Informational Exceptions control mode page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch_iec_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="cm">/* 0x1c, 0xa, */</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d_iec_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">iec_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iec_m_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ch_iec_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_iec_m_pg</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d_iec_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d_iec_m_pg</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iec_m_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_sas_sf_m_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* SAS SSP mode page - short format for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sas_sf_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span>
		<span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sas_sf_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sf_m_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sf_m_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sf_m_pg</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_sas_pcd_m_spg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">target_dev_id</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* SAS phy control and discover mode page for mode_sense */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sas_pcd_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		    <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		    <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span>
		    <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		    <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
		    <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span>
		    <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">};</span>
	<span class="kt">int</span> <span class="n">port_a</span><span class="p">,</span> <span class="n">port_b</span><span class="p">;</span>

	<span class="n">port_a</span> <span class="o">=</span> <span class="n">target_dev_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port_b</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sas_pcd_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_pcd_m_pg</span><span class="p">));</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_a</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_b</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_pcd_m_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_pcd_m_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_sas_sha_m_spg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcontrol</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* SAS SSP shared protocol specific port mode subpage */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sas_sha_m_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sas_sha_m_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sha_m_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sha_m_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sas_sha_m_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_MAX_MSENSE_SZ 256</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dbd</span><span class="p">,</span> <span class="n">llbaa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">pcode</span><span class="p">,</span> <span class="n">subpcode</span><span class="p">,</span> <span class="n">bd_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev_spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">msense_6</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span> <span class="n">target_dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_MAX_MSENSE_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="n">dbd</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">pcontrol</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pcode</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">subpcode</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">msense_6</span> <span class="o">=</span> <span class="p">(</span><span class="n">MODE_SENSE</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">llbaa</span> <span class="o">=</span> <span class="n">msense_6</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">scsi_debug_ptype</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dbd</span><span class="p">))</span>
		<span class="n">bd_len</span> <span class="o">=</span> <span class="n">llbaa</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bd_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">msense_6</span> <span class="o">?</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_MAX_MSENSE_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">==</span> <span class="n">pcontrol</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Saving values not supported */</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">SAVING_PARAMS_UNSUP</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">target_dev_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* set DPOFUA bit for disks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">scsi_debug_ptype</span><span class="p">)</span>
		<span class="n">dev_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEV_READONLY</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_spec</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msense_6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_spec</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd_len</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_spec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">16</span> <span class="o">==</span> <span class="n">bd_len</span><span class="p">)</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* set LONGLBA bit */</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd_len</span><span class="p">;</span>	<span class="cm">/* assume 255 or less */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bd_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sdebug_capacity</span><span class="p">))</span>
		<span class="n">sdebug_capacity</span> <span class="o">=</span> <span class="n">get_sdebug_capacity</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">==</span> <span class="n">bd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdebug_capacity</span> <span class="o">&gt;</span> <span class="mh">0xfffffffe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">ap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_capacity</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_sector_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bd_len</span><span class="p">;</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">16</span> <span class="o">==</span> <span class="n">bd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">capac</span> <span class="o">=</span> <span class="n">sdebug_capacity</span><span class="p">;</span>

        	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">,</span> <span class="n">capac</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">)</span>
                	<span class="n">ap</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">capac</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ap</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_debug_sector_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">bd_len</span><span class="p">;</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">subpcode</span> <span class="o">&gt;</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">subpcode</span> <span class="o">&lt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x19</span> <span class="o">!=</span> <span class="n">pcode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TODO: Control Extension page */</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1</span>:	<span class="cm">/* Read-Write error recovery page, direct access */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">resp_err_recov_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:	<span class="cm">/* Disconnect-Reconnect page, all devices */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">resp_disconnect_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mh">0x3</span>:       <span class="cm">/* Format device page, direct access */</span>
                <span class="n">len</span> <span class="o">=</span> <span class="n">resp_format_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8</span>:	<span class="cm">/* Caching page, direct access */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">resp_caching_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa</span>:	<span class="cm">/* Control Mode page, all devices */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">resp_ctrl_m_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x19</span>:	<span class="cm">/* if spc==1 then sas phy, control+discover */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">subpcode</span> <span class="o">&gt;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">subpcode</span> <span class="o">&lt;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		        <span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	        <span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0x0</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_sf_m_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0x1</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_pcd_m_spg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
						  <span class="n">target_dev_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0x2</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_sha_m_spg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1c</span>:	<span class="cm">/* Informational Exceptions Mode page, all devices */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">resp_iec_m_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3f</span>:	<span class="cm">/* Read all Mode pages */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">resp_err_recov_pg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_disconnect_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_format_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_caching_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_ctrl_m_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_sf_m_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_pcd_m_spg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span>
						  <span class="n">target</span><span class="p">,</span> <span class="n">target_dev_id</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_sas_sha_m_spg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">resp_iec_m_pg</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
                <span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msense_6</span><span class="p">)</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">alloc_len</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_MAX_MSELECT_SZ 512</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mselect6</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pf</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">md_len</span><span class="p">,</span> <span class="n">bd_len</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">spf</span><span class="p">,</span> <span class="n">pg_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">param_len</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span> <span class="n">mpage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_MAX_MSELECT_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">));</span>
	<span class="n">pf</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">param_len</span> <span class="o">=</span> <span class="n">mselect6</span> <span class="o">?</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pf</span><span class="p">)</span> <span class="o">||</span> <span class="n">sp</span> <span class="o">||</span> <span class="p">(</span><span class="n">param_len</span> <span class="o">&gt;</span> <span class="n">SDEBUG_MAX_MSELECT_SZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fetch_to_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">param_len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">res</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">param_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">))</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: mode_select: cdb indicated=%d, &quot;</span>
                       <span class="s">&quot; IO sent=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param_len</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">md_len</span> <span class="o">=</span> <span class="n">mselect6</span> <span class="o">?</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">bd_len</span> <span class="o">=</span> <span class="n">mselect6</span> <span class="o">?</span> <span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="p">((</span><span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_PARAM_LIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">bd_len</span> <span class="o">+</span> <span class="p">(</span><span class="n">mselect6</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mpage</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ps</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_PARAM_LIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spf</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">pg_len</span> <span class="o">=</span> <span class="n">spf</span> <span class="o">?</span> <span class="p">((</span><span class="n">arr</span><span class="p">[</span><span class="n">off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="n">off</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pg_len</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">param_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">PARAMETER_LIST_LENGTH_ERR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mpage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xa</span>:      <span class="cm">/* Control Mode page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_m_pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arr</span><span class="p">[</span><span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ctrl_m_pg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl_m_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">scsi_debug_dsense</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ctrl_m_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1c</span>:      <span class="cm">/* Informational Exceptions Mode page */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iec_m_pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arr</span><span class="p">[</span><span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">iec_m_pg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">iec_m_pg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
			<span class="n">INVALID_FIELD_IN_PARAM_LIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_temp_l_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_l_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
				     <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span>
		<span class="p">};</span>

        <span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">temp_l_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_l_pg</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_l_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_ie_l_pg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ie_l_pg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
		<span class="p">};</span>

        <span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ie_l_pg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_l_pg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iec_m_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TEST bit set */</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">THRESHOLD_EXCEEDED</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_l_pg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_MAX_LSENSE_SZ 512</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_log_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
                          <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ppc</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">pcontrol</span><span class="p">,</span> <span class="n">pcode</span><span class="p">,</span> <span class="n">subpcode</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_MAX_LSENSE_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">errsts</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">));</span>
	<span class="n">ppc</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc</span> <span class="o">||</span> <span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcontrol</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pcode</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">subpcode</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0</span>:	<span class="cm">/* Supported log pages log page */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* this page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>		<span class="cm">/* Temperature */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">;</span>	<span class="cm">/* Informational exceptions */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xd</span>:	<span class="cm">/* Temperature log page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp_temp_l_pg</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2f</span>:	<span class="cm">/* Informational exceptions log page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp_ie_l_pg</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">==</span> <span class="n">subpcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subpcode</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0</span>:	<span class="cm">/* Supported log pages and subpages log page */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* 0,0 page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* this page */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* Temperature */</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* Informational exceptions */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xd</span>:	<span class="cm">/* Temperature subpages */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* Temperature */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2f</span>:	<span class="cm">/* Informational exceptions subpages */</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">;</span>
			<span class="n">arr</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* Informational exceptions */</span>
			<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">SDEBUG_MAX_INQ_ARR_SZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_device_access_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devi</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lba</span> <span class="o">+</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">sdebug_capacity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devi</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">ADDR_OUT_OF_RANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* transfer length excessive (tie in to block limits VPD page) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">sdebug_store_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devi</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_device_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devi</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span> <span class="n">fetch_to_dev_buffer</span> <span class="o">:</span> <span class="n">fill_from_dev_buffer</span><span class="p">;</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="n">sdebug_store_sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">+</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">sdebug_store_sectors</span><span class="p">)</span>
		<span class="n">rest</span> <span class="o">=</span> <span class="n">block</span> <span class="o">+</span> <span class="n">num</span> <span class="o">-</span> <span class="n">sdebug_store_sectors</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">fake_storep</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">rest</span><span class="p">)</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">rest</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">fake_storep</span><span class="p">,</span> <span class="n">rest</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prot_verify_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">start_sec</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ei_lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">resid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">psgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd_dif_tuple</span> <span class="o">*</span><span class="n">sdt</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">tmp_sec</span> <span class="o">=</span> <span class="n">start_sec</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>

	<span class="n">start_sec</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">tmp_sec</span><span class="p">,</span> <span class="n">sdebug_store_sectors</span><span class="p">);</span>

	<span class="n">sdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sd_dif_tuple</span> <span class="o">*</span><span class="p">)(</span><span class="n">dif_storep</span> <span class="o">+</span> <span class="n">dif_offset</span><span class="p">(</span><span class="n">start_sec</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectors</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">csum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_tag</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sector</span> <span class="o">=</span> <span class="n">start_sec</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_debug_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">csum</span> <span class="o">=</span> <span class="n">ip_compute_csum</span><span class="p">(</span><span class="n">fake_storep</span> <span class="o">+</span>
					       <span class="n">sector</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span>
					       <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">csum</span> <span class="o">=</span> <span class="n">crc_t10dif</span><span class="p">(</span><span class="n">fake_storep</span> <span class="o">+</span>
					  <span class="n">sector</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span>
					  <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
			<span class="n">csum</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">csum</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">guard_tag</span> <span class="o">!=</span> <span class="n">csum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: GUARD check failed on sector %lu&quot;</span> \
			       <span class="s">&quot; rcvd 0x%04x, data 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span>
			       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">guard_tag</span><span class="p">),</span>
			       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">csum</span><span class="p">));</span>
			<span class="n">dif_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ref_tag</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: REF check failed on sector %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">dif_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ref_tag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ei_lba</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: REF check failed on sector %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
			<span class="n">dif_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ei_lba</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resid</span> <span class="o">=</span> <span class="n">sectors</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* Bytes of protection data to copy into sgl */</span>
	<span class="n">sector</span> <span class="o">=</span> <span class="n">start_sec</span><span class="p">;</span>

	<span class="n">scsi_for_each_prot_sg</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">psgl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>

		<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">psgl</span><span class="p">))</span> <span class="o">+</span> <span class="n">psgl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">dif_storep</span> <span class="o">+</span> <span class="n">dif_offset</span><span class="p">(</span><span class="n">sector</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">sector</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&gt;=</span> <span class="n">sdebug_store_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Force wrap */</span>
			<span class="n">tmp_sec</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
			<span class="n">sector</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">tmp_sec</span><span class="p">,</span> <span class="n">sdebug_store_sectors</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">resid</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dix_reads</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">ei_lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_device_access_params</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SCSI_DEBUG_OPT_MEDIUM_ERR</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">OPT_MEDIUM_ERR_ADDR</span> <span class="o">+</span> <span class="n">OPT_MEDIUM_ERR_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">lba</span> <span class="o">+</span> <span class="n">num</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">OPT_MEDIUM_ERR_ADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* claim unrecoverable read error */</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">MEDIUM_ERROR</span><span class="p">,</span> <span class="n">UNRECOVERED_READ_ERR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* set info field and valid bit for fixed descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0x70</span> <span class="o">==</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* Valid bit */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;</span> <span class="n">OPT_MEDIUM_ERR_ADDR</span><span class="p">)</span>
			      <span class="o">?</span> <span class="n">OPT_MEDIUM_ERR_ADDR</span> <span class="o">:</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lba</span><span class="p">;</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	        <span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DIX + T10 DIF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prot_ret</span> <span class="o">=</span> <span class="n">prot_verify_read</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prot_ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ABORTED_COMMAND</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">prot_ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_device_access</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_sector</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;&gt;&gt;&gt; Sector Dump &lt;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%04d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x7e</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %c &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prot_verify_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">start_sec</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ei_lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd_dif_tuple</span> <span class="o">*</span><span class="n">sdt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">dsgl</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">psgl</span> <span class="o">=</span> <span class="n">scsi_prot_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">tmp_sec</span> <span class="o">=</span> <span class="n">start_sec</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">sector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ppage_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">csum</span><span class="p">;</span>

	<span class="n">sector</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">tmp_sec</span><span class="p">,</span> <span class="n">sdebug_store_sectors</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">psgl</span><span class="p">))</span> <span class="o">+</span> <span class="n">psgl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">ppage_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For each data page */</span>
	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">dsgl</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">daddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">dsgl</span><span class="p">))</span> <span class="o">+</span> <span class="n">dsgl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* For each sector-sized chunk in data page */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dsgl</span><span class="o">-&gt;</span><span class="n">length</span> <span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">scsi_debug_sector_size</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* If we&#39;re at the end of the current</span>
<span class="cm">			 * protection page advance to the next one</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ppage_offset</span> <span class="o">&gt;=</span> <span class="n">psgl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
				<span class="n">psgl</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">psgl</span><span class="p">);</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">psgl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">paddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">psgl</span><span class="p">))</span>
					<span class="o">+</span> <span class="n">psgl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
				<span class="n">ppage_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sdt</span> <span class="o">=</span> <span class="n">paddr</span> <span class="o">+</span> <span class="n">ppage_offset</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_debug_guard</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">csum</span> <span class="o">=</span> <span class="n">ip_compute_csum</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span>
						       <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">csum</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">crc_t10dif</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span>
						      <span class="n">scsi_debug_sector_size</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">BUG</span><span class="p">();</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">guard_tag</span> <span class="o">!=</span> <span class="n">csum</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: GUARD check failed on sector %lu &quot;</span> \
				       <span class="s">&quot;rcvd 0x%04x, calculated 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">,</span>
				       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">guard_tag</span><span class="p">),</span>
				       <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">csum</span><span class="p">));</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">dump_sector</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span> <span class="o">&amp;&amp;</span>
			    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">ref_tag</span><span class="p">)</span>
			    <span class="o">!=</span> <span class="p">(</span><span class="n">start_sec</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: REF check failed on sector %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">dump_sector</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span> <span class="o">&amp;&amp;</span>
			    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">ref_tag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ei_lba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;%s: REF check failed on sector %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sector</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">dump_sector</span><span class="p">(</span><span class="n">daddr</span><span class="p">,</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Would be great to copy this in bigger</span>
<span class="cm">			 * chunks.  However, for the sake of</span>
<span class="cm">			 * correctness we need to verify each sector</span>
<span class="cm">			 * before writing it to &quot;stable&quot; storage</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dif_storep</span> <span class="o">+</span> <span class="n">dif_offset</span><span class="p">(</span><span class="n">sector</span><span class="p">),</span> <span class="n">sdt</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">sector</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sdebug_store_sectors</span><span class="p">)</span>
				<span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Force wrap */</span>

			<span class="n">start_sec</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ei_lba</span><span class="o">++</span><span class="p">;</span>
			<span class="n">daddr</span> <span class="o">+=</span> <span class="n">scsi_debug_sector_size</span><span class="p">;</span>
			<span class="n">ppage_offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd_dif_tuple</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">daddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>

	<span class="n">dix_writes</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dif_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">map_state</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">mapped</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">block</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">granularity</span> <span class="o">=</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">;</span>
	<span class="n">alignment</span> <span class="o">=</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">;</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">alignment</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">granularity</span><span class="p">);</span>

	<span class="n">mapped</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">map_storep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapped</span><span class="p">)</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">map_storep</span><span class="p">,</span> <span class="n">map_size</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">find_next_bit</span><span class="p">(</span><span class="n">map_storep</span><span class="p">,</span> <span class="n">map_size</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>

	<span class="n">end</span> <span class="o">=</span> <span class="n">next</span> <span class="o">*</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">;</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">lba</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mapped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_region</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">alignment</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">granularity</span> <span class="o">=</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">;</span>
	<span class="n">alignment</span> <span class="o">=</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">block</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">block</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">alignment</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">granularity</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="n">map_size</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">map_storep</span><span class="p">);</span>

		<span class="n">lba</span> <span class="o">+=</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">rem</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unmap_region</span><span class="p">(</span><span class="n">sector_t</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">alignment</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">granularity</span> <span class="o">=</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">;</span>
	<span class="n">alignment</span> <span class="o">=</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sector_t</span> <span class="n">block</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>

		<span class="n">block</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">alignment</span><span class="p">;</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">granularity</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lba</span> <span class="o">+</span> <span class="n">granularity</span> <span class="o">&lt;=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="n">map_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">map_storep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbprz</span><span class="p">)</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">fake_storep</span> <span class="o">+</span>
				       <span class="n">block</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lba</span> <span class="o">+=</span> <span class="n">granularity</span> <span class="o">-</span> <span class="n">rem</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">ei_lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_device_access_params</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* DIX + T10 DIF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_prot_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">prot_ret</span> <span class="o">=</span> <span class="n">prot_verify_write</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prot_ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">prot_ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_device_access</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_unmap_granularity</span><span class="p">)</span>
		<span class="n">map_region</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: write: cdb indicated=%u, &quot;</span>
		       <span class="s">&quot; IO sent=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_write_same</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">ei_lba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_device_access_params</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">scsi_debug_write_same_length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unmap</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unmap_region</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Else fetch one logical block */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fetch_to_dev_buffer</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span>
				  <span class="n">fake_storep</span> <span class="o">+</span> <span class="p">(</span><span class="n">lba</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">),</span>
				  <span class="n">scsi_debug_sector_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: write same: cdb indicated=%u, &quot;</span>
		       <span class="s">&quot; IO sent=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Copy first sector to remaining blocks */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fake_storep</span> <span class="o">+</span> <span class="p">((</span><span class="n">lba</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">),</span>
		       <span class="n">fake_storep</span> <span class="o">+</span> <span class="p">(</span><span class="n">lba</span> <span class="o">*</span> <span class="n">scsi_debug_sector_size</span><span class="p">),</span>
		       <span class="n">scsi_debug_sector_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_unmap_granularity</span><span class="p">)</span>
		<span class="n">map_region</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_rw</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">unmap_block_desc</span> <span class="p">{</span>
	<span class="n">__be64</span>	<span class="n">lba</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">blocks</span><span class="p">;</span>
	<span class="n">__be32</span>	<span class="n">__reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unmap_block_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">payload_len</span><span class="p">);</span>

	<span class="n">descriptors</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>

	<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">));</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">payload_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="n">descriptors</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">descriptors</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lba</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blocks</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_device_access_params</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">unmap_region</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_GET_LBA_STATUS_LEN 32</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_get_lba_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">mapped</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_GET_LBA_STATUS_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lba</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_device_access_params</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mapped</span> <span class="o">=</span> <span class="n">map_state</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_GET_LBA_STATUS_LEN</span><span class="p">);</span>
	<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	<span class="cm">/* Parameter Data Length */</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>	<span class="cm">/* LBA */</span>
	<span class="n">put_unaligned_be32</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>	<span class="cm">/* Number of blocks */</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">mapped</span><span class="p">;</span>			<span class="cm">/* mapped = 0, unmapped = 1 */</span>

	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">SDEBUG_GET_LBA_STATUS_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SDEBUG_RLUN_ARR_SZ 256</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_report_luns</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lun_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlun</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">select_report</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="n">one_lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="n">SDEBUG_RLUN_ARR_SZ</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">max_addr</span><span class="p">;</span>

	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">alloc_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">select_report</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span>
			       	<span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">check_condition_result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* can produce response with up to 16k luns (lun 0 to lun 16383) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_RLUN_ARR_SZ</span><span class="p">);</span>
	<span class="n">lun_cnt</span> <span class="o">=</span> <span class="n">scsi_debug_max_luns</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">select_report</span><span class="p">)</span>
		<span class="n">lun_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_no_lun_0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lun_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="o">--</span><span class="n">lun_cnt</span><span class="p">;</span>
	<span class="n">wlun</span> <span class="o">=</span> <span class="p">(</span><span class="n">select_report</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">lun_cnt</span> <span class="o">+</span> <span class="n">wlun</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDEBUG_RLUN_ARR_SZ</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span><span class="p">)),</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lun_cnt</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">one_lun</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">max_addr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">SDEBUG_RLUN_ARR_SZ</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_debug_no_lun_0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
             <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">lun_cnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">one_lun</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_addr</span><span class="p">));</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">lun</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">upper</span><span class="p">)</span>
			<span class="n">one_lun</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">upper</span> <span class="o">|</span> <span class="p">(</span><span class="n">SAM2_LUN_ADDRESS_METHOD</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">one_lun</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lun</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">one_lun</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAM2_WLUN_REPORT_LUNS</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">one_lun</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi_lun</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">one_lun</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">arr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fill_from_dev_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span>
				    <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">alloc_len</span><span class="p">,</span> <span class="n">SDEBUG_RLUN_ARR_SZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resp_xdwriteread</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_data_buffer</span> <span class="o">*</span><span class="n">sdb</span> <span class="o">=</span> <span class="n">scsi_in</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

	<span class="cm">/* better not to use temporary buffer. */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">));</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sdb</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kaddr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When timer goes off this function is called. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">timer_intr_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="o">*</span> <span class="n">sqcp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indx</span> <span class="o">&gt;=</span> <span class="n">scsi_debug_max_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug:timer_intr_handler: indx too &quot;</span>
		       <span class="s">&quot;large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">sqcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queued_arr</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">indx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug:timer_intr_handler: Unexpected &quot;</span>
		       <span class="s">&quot;interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">done_funct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">scsi_result</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">done_funct</span><span class="p">(</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span><span class="p">);</span> <span class="cm">/* callback to mid level */</span>
	<span class="p">}</span>
	<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">done_funct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span>
<span class="nf">sdebug_device_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">;</span>

	<span class="n">devip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devip</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devip</span><span class="o">-&gt;</span><span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">sdbg_host</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">devip</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="nf">devInfoReg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span> <span class="n">sdbg_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">open_devip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">devip</span><span class="p">;</span>
	<span class="n">sdbg_host</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">**</span><span class="p">)</span><span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdbg_host</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Host info NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">devip</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">open_devip</span><span class="p">))</span>
				<span class="n">open_devip</span> <span class="o">=</span> <span class="n">devip</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open_devip</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* try and make a new one */</span>
		<span class="n">open_devip</span> <span class="o">=</span> <span class="n">sdebug_device_create</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">open_devip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: out of memory at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">sdbg_host</span><span class="p">;</span>
	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDEBUG_SENSE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dsense</span><span class="p">)</span>
		<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span><span class="p">)</span>
		<span class="n">open_devip</span><span class="o">-&gt;</span><span class="n">wlun</span> <span class="o">=</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">open_devip</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: slave_alloc &lt;%u %u %u %u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">queue_flag_set_unlocked</span><span class="p">(</span><span class="n">QUEUE_FLAG_BIDI</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: slave_configure &lt;%u %u %u %u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">!=</span> <span class="n">SCSI_DEBUG_MAX_CMD_LEN</span><span class="p">)</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">SCSI_DEBUG_MAX_CMD_LEN</span><span class="p">;</span>
	<span class="n">devip</span> <span class="o">=</span> <span class="n">devInfoReg</span><span class="p">(</span><span class="n">sdp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">devip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no resources, will be marked offline */</span>
	<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">devip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">)</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdp</span><span class="p">,</span> <span class="n">SDEBUG_TAGGED_QUEUING</span><span class="p">,</span>
					<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
	<span class="n">blk_queue_max_segment_size</span><span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_no_uld</span><span class="p">)</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_debug_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="p">)</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: slave_destroy &lt;%u %u %u %u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make this slot available for re-use */</span>
		<span class="n">devip</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdp</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Returns 1 if found &#39;cmnd&#39; and deleted its timer. else returns 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_queued_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="o">*</span><span class="n">sqcp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_max_queue</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sqcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queued_arr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmnd</span> <span class="o">==</span> <span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">);</span>
			<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_max_queue</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Deletes (stops) timers of all queued commands */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_all_queued</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="o">*</span><span class="n">sqcp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_max_queue</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sqcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queued_arr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">&amp;&amp;</span> <span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">);</span>
			<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">++</span><span class="n">num_aborts</span><span class="p">;</span>
	<span class="n">stop_queued_cmnd</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: biosparam</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">scsi_bios_ptable</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">scsi_partsize</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_heads</span><span class="p">;</span>
	<span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>
	<span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_cylinders_per</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: device_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">++</span><span class="n">num_dev_resets</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devip</span> <span class="o">=</span> <span class="n">devInfoReg</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="p">)</span>
			<span class="n">devip</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">dev_info</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">sdp</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span> <span class="n">hp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: bus_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">++</span><span class="n">num_bus_resets</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hp</span> <span class="o">=</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sdbg_host</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">**</span><span class="p">)</span><span class="n">shost_priv</span><span class="p">(</span><span class="n">hp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdbg_host</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_info</span><span class="p">,</span>
                                            <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
                                            <span class="n">dev_list</span><span class="p">)</span>
				<span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span> <span class="n">sdbg_host</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">dev_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: host_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">++</span><span class="n">num_host_resets</span><span class="p">;</span>
        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
        <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdebug_host_list</span><span class="p">,</span> <span class="n">host_list</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
                                    <span class="n">dev_list</span><span class="p">)</span>
                        <span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
	<span class="n">stop_all_queued</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initializes timers in queued array */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_all_queued</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="o">*</span> <span class="n">sqcp</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_max_queue</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sqcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queued_arr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">);</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sdebug_build_parts</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ramp</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">store_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span> <span class="n">pp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">starts</span><span class="p">[</span><span class="n">SDEBUG_MAX_PARTS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sectors_per_part</span><span class="p">,</span> <span class="n">num_sectors</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">heads_by_sects</span><span class="p">,</span> <span class="n">start_sec</span><span class="p">,</span> <span class="n">end_sec</span><span class="p">;</span>

	<span class="cm">/* assume partition table already zeroed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_debug_num_parts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">store_size</span> <span class="o">&lt;</span> <span class="mi">1048576</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_num_parts</span> <span class="o">&gt;</span> <span class="n">SDEBUG_MAX_PARTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_debug_num_parts</span> <span class="o">=</span> <span class="n">SDEBUG_MAX_PARTS</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug:build_parts: reducing &quot;</span>
				    <span class="s">&quot;partitions to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SDEBUG_MAX_PARTS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sdebug_store_sectors</span><span class="p">;</span>
	<span class="n">sectors_per_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_sectors</span> <span class="o">-</span> <span class="n">sdebug_sectors_per</span><span class="p">)</span>
			   <span class="o">/</span> <span class="n">scsi_debug_num_parts</span><span class="p">;</span>
	<span class="n">heads_by_sects</span> <span class="o">=</span> <span class="n">sdebug_heads</span> <span class="o">*</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>
        <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_num_parts</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
		<span class="n">starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">k</span> <span class="o">*</span> <span class="n">sectors_per_part</span><span class="p">)</span> <span class="o">/</span> <span class="n">heads_by_sects</span><span class="p">)</span>
			    <span class="o">*</span> <span class="n">heads_by_sects</span><span class="p">;</span>
	<span class="n">starts</span><span class="p">[</span><span class="n">scsi_debug_num_parts</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_sectors</span><span class="p">;</span>
	<span class="n">starts</span><span class="p">[</span><span class="n">scsi_debug_num_parts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ramp</span><span class="p">[</span><span class="mi">510</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>	<span class="cm">/* magic partition markings */</span>
	<span class="n">ramp</span><span class="p">[</span><span class="mi">511</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="p">)(</span><span class="n">ramp</span> <span class="o">+</span> <span class="mh">0x1be</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">starts</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">k</span><span class="p">,</span> <span class="o">++</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">end_sec</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">boot_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">start_sec</span> <span class="o">/</span> <span class="n">heads_by_sects</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cyl</span> <span class="o">*</span> <span class="n">heads_by_sects</span><span class="p">))</span>
			   <span class="o">/</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_sec</span> <span class="o">%</span> <span class="n">sdebug_sectors_per</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">end_cyl</span> <span class="o">=</span> <span class="n">end_sec</span> <span class="o">/</span> <span class="n">heads_by_sects</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">end_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">end_cyl</span> <span class="o">*</span> <span class="n">heads_by_sects</span><span class="p">))</span>
			       <span class="o">/</span> <span class="n">sdebug_sectors_per</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_sec</span> <span class="o">%</span> <span class="n">sdebug_sectors_per</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">start_sect</span> <span class="o">=</span> <span class="n">start_sec</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">nr_sects</span> <span class="o">=</span> <span class="n">end_sec</span> <span class="o">-</span> <span class="n">start_sec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">sys_ind</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span>	<span class="cm">/* plain Linux partition */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">schedule_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmnd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span> <span class="n">devip</span><span class="p">,</span>
			 <span class="n">done_funct_t</span> <span class="n">done</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scsi_result</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta_jiff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmnd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_result</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">sdp</span> <span class="o">=</span> <span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug:    &lt;%u %u %u %u&gt; &quot;</span>
			       <span class="s">&quot;non-zero result=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			       <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdp</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">scsi_result</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span> <span class="o">&amp;&amp;</span> <span class="n">devip</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* simulate autosense by this driver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SAM_STAT_CHECK_CONDITION</span> <span class="o">==</span> <span class="p">(</span><span class="n">scsi_result</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">devip</span><span class="o">-&gt;</span><span class="n">sense_buff</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span> <span class="o">&gt;</span> <span class="n">SDEBUG_SENSE_LEN</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">SDEBUG_SENSE_LEN</span> <span class="o">:</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta_jiff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span><span class="p">)</span>
			<span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">scsi_result</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
			<span class="n">done</span><span class="p">(</span><span class="n">cmnd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sdebug_queued_cmd</span> <span class="o">*</span> <span class="n">sqcp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">scsi_debug_max_queue</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sqcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queued_arr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">scsi_debug_max_queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug: can_queue exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* report busy to mid level */</span>
		<span class="p">}</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">a_cmnd</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">scsi_result</span> <span class="o">=</span> <span class="n">scsi_result</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">done_funct</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">timer_intr_handler</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">delta_jiff</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sqcp</span><span class="o">-&gt;</span><span class="n">cmnd_timer</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queued_arr_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span><span class="p">)</span>
			<span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* Note: The following macros create attribute files in the</span>
<span class="cm">   /sys/module/scsi_debug/parameters directory. Unfortunately this</span>
<span class="cm">   driver is unaware of a change and cannot trigger auxiliary actions</span>
<span class="cm">   as it can when the corresponding attribute in the</span>
<span class="cm">   /sys/bus/pseudo/drivers/scsi_debug directory is changed.</span>
<span class="cm"> */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">add_host</span><span class="p">,</span> <span class="n">scsi_debug_add_host</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">ato</span><span class="p">,</span> <span class="n">scsi_debug_ato</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">scsi_debug_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dev_size_mb</span><span class="p">,</span> <span class="n">scsi_debug_dev_size_mb</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="n">scsi_debug_dif</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dix</span><span class="p">,</span> <span class="n">scsi_debug_dix</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dsense</span><span class="p">,</span> <span class="n">scsi_debug_dsense</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">every_nth</span><span class="p">,</span> <span class="n">scsi_debug_every_nth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">fake_rw</span><span class="p">,</span> <span class="n">scsi_debug_fake_rw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="n">scsi_debug_guard</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">lbpu</span><span class="p">,</span> <span class="n">scsi_debug_lbpu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">lbpws</span><span class="p">,</span> <span class="n">scsi_debug_lbpws</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">lbpws10</span><span class="p">,</span> <span class="n">scsi_debug_lbpws10</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">lbprz</span><span class="p">,</span> <span class="n">scsi_debug_lbprz</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">lowest_aligned</span><span class="p">,</span> <span class="n">scsi_debug_lowest_aligned</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_luns</span><span class="p">,</span> <span class="n">scsi_debug_max_luns</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_queue</span><span class="p">,</span> <span class="n">scsi_debug_max_queue</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">no_lun_0</span><span class="p">,</span> <span class="n">scsi_debug_no_lun_0</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">no_uld</span><span class="p">,</span> <span class="n">scsi_debug_no_uld</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_parts</span><span class="p">,</span> <span class="n">scsi_debug_num_parts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">num_tgts</span><span class="p">,</span> <span class="n">scsi_debug_num_tgts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">opt_blks</span><span class="p">,</span> <span class="n">scsi_debug_opt_blks</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">scsi_debug_opts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">physblk_exp</span><span class="p">,</span> <span class="n">scsi_debug_physblk_exp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">scsi_debug_ptype</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">scsi_level</span><span class="p">,</span> <span class="n">scsi_debug_scsi_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">sector_size</span><span class="p">,</span> <span class="n">scsi_debug_sector_size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">unmap_alignment</span><span class="p">,</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">unmap_granularity</span><span class="p">,</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">unmap_max_blocks</span><span class="p">,</span> <span class="n">scsi_debug_unmap_max_blocks</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">unmap_max_desc</span><span class="p">,</span> <span class="n">scsi_debug_unmap_max_desc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">virtual_gb</span><span class="p">,</span> <span class="n">scsi_debug_virtual_gb</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">vpd_use_hostno</span><span class="p">,</span> <span class="n">scsi_debug_vpd_use_hostno</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">write_same_length</span><span class="p">,</span> <span class="n">scsi_debug_write_same_length</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eric Youngdale + Douglas Gilbert&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SCSI debug adapter driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">SCSI_DEBUG_VERSION</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">add_host</span><span class="p">,</span> <span class="s">&quot;0..127 hosts allowed(def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ato</span><span class="p">,</span> <span class="s">&quot;application tag ownership: 0=disk 1=host (def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s">&quot;# of jiffies to delay response(def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dev_size_mb</span><span class="p">,</span> <span class="s">&quot;size in MB of ram shared by devs(def=8)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="s">&quot;data integrity field type: 0-3 (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dix</span><span class="p">,</span> <span class="s">&quot;data integrity extensions mask (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dsense</span><span class="p">,</span> <span class="s">&quot;use descriptor sense format(def=0 -&gt; fixed)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">every_nth</span><span class="p">,</span> <span class="s">&quot;timeout every nth command(def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fake_rw</span><span class="p">,</span> <span class="s">&quot;fake reads/writes instead of copying (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="s">&quot;protection checksum: 0=crc, 1=ip (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lbpu</span><span class="p">,</span> <span class="s">&quot;enable LBP, support UNMAP command (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lbpws</span><span class="p">,</span> <span class="s">&quot;enable LBP, support WRITE SAME(16) with UNMAP bit (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lbpws10</span><span class="p">,</span> <span class="s">&quot;enable LBP, support WRITE SAME(10) with UNMAP bit (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lbprz</span><span class="p">,</span> <span class="s">&quot;unmapped blocks return 0 on read (def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lowest_aligned</span><span class="p">,</span> <span class="s">&quot;lowest aligned lba (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_luns</span><span class="p">,</span> <span class="s">&quot;number of LUNs per target to simulate(def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_queue</span><span class="p">,</span> <span class="s">&quot;max number of queued commands (1 to 255(def))&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_lun_0</span><span class="p">,</span> <span class="s">&quot;no LU number 0 (def=0 -&gt; have lun 0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_uld</span><span class="p">,</span> <span class="s">&quot;stop ULD (e.g. sd driver) attaching (def=0))&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_parts</span><span class="p">,</span> <span class="s">&quot;number of partitions(def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_tgts</span><span class="p">,</span> <span class="s">&quot;number of targets per host to simulate(def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">opt_blks</span><span class="p">,</span> <span class="s">&quot;optimal transfer length in block (def=64)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;1-&gt;noise, 2-&gt;medium_err, 4-&gt;timeout, 8-&gt;recovered_err... (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">physblk_exp</span><span class="p">,</span> <span class="s">&quot;physical block exponent (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="s">&quot;SCSI peripheral type(def=0[disk])&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scsi_level</span><span class="p">,</span> <span class="s">&quot;SCSI level to simulate(def=5[SPC-3])&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sector_size</span><span class="p">,</span> <span class="s">&quot;logical block size in bytes (def=512)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">unmap_alignment</span><span class="p">,</span> <span class="s">&quot;lowest aligned thin provisioning lba (def=0)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">unmap_granularity</span><span class="p">,</span> <span class="s">&quot;thin provisioning granularity in blocks (def=1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">unmap_max_blocks</span><span class="p">,</span> <span class="s">&quot;max # of blocks can be unmapped in one cmd (def=0xffffffff)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">unmap_max_desc</span><span class="p">,</span> <span class="s">&quot;max # of ranges that can be unmapped in one cmd (def=256)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">virtual_gb</span><span class="p">,</span> <span class="s">&quot;virtual gigabyte size (def=0 -&gt; use dev_size_mb)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vpd_use_hostno</span><span class="p">,</span> <span class="s">&quot;0 -&gt; dev ids ignore hostno (def=1 -&gt; unique dev ids)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">write_same_length</span><span class="p">,</span> <span class="s">&quot;Maximum blocks per WRITE SAME cmd (def=0xffff)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">sdebug_info</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">scsi_debug_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span> <span class="n">shp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">sdebug_info</span><span class="p">,</span> <span class="s">&quot;scsi_debug, version %s [%s], &quot;</span>
		<span class="s">&quot;dev_size_mb=%d, opts=0x%x&quot;</span><span class="p">,</span> <span class="n">SCSI_DEBUG_VERSION</span><span class="p">,</span>
		<span class="n">scsi_debug_version_date</span><span class="p">,</span> <span class="n">scsi_debug_dev_size_mb</span><span class="p">,</span>
		<span class="n">scsi_debug_opts</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sdebug_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* scsi_debug_proc_info</span>
<span class="cm"> * Used if the driver currently has no own support for /proc/scsi</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_debug_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">begin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_length</span><span class="p">;</span>

	<span class="n">orig_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inout</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">minLen</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">minLen</span><span class="p">);</span>
		<span class="n">arr</span><span class="p">[</span><span class="n">minLen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scsi_debug_opts</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_every_nth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">scsi_debug_cmnd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;scsi_debug adapter driver, version &quot;</span>
	    <span class="s">&quot;%s [%s]</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;num_tgts=%d, shared (ram) size=%d MB, opts=0x%x, &quot;</span>
	    <span class="s">&quot;every_nth=%d(curr:%d)</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;delay=%d, max_luns=%d, scsi_level=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;sector_size=%d bytes, cylinders=%d, heads=%d, sectors=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;number of aborts=%d, device_reset=%d, bus_resets=%d, &quot;</span>
	    <span class="s">&quot;host_resets=%d</span><span class="se">\n</span><span class="s">dix_reads=%d dix_writes=%d dif_errors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">SCSI_DEBUG_VERSION</span><span class="p">,</span> <span class="n">scsi_debug_version_date</span><span class="p">,</span> <span class="n">scsi_debug_num_tgts</span><span class="p">,</span>
	    <span class="n">scsi_debug_dev_size_mb</span><span class="p">,</span> <span class="n">scsi_debug_opts</span><span class="p">,</span> <span class="n">scsi_debug_every_nth</span><span class="p">,</span>
	    <span class="n">scsi_debug_cmnd_count</span><span class="p">,</span> <span class="n">scsi_debug_delay</span><span class="p">,</span>
	    <span class="n">scsi_debug_max_luns</span><span class="p">,</span> <span class="n">scsi_debug_scsi_level</span><span class="p">,</span>
	    <span class="n">scsi_debug_sector_size</span><span class="p">,</span> <span class="n">sdebug_cylinders_per</span><span class="p">,</span> <span class="n">sdebug_heads</span><span class="p">,</span>
	    <span class="n">sdebug_sectors_per</span><span class="p">,</span> <span class="n">num_aborts</span><span class="p">,</span> <span class="n">num_dev_resets</span><span class="p">,</span> <span class="n">num_bus_resets</span><span class="p">,</span>
	    <span class="n">num_host_resets</span><span class="p">,</span> <span class="n">dix_reads</span><span class="p">,</span> <span class="n">dix_writes</span><span class="p">,</span> <span class="n">dif_errors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>	<span class="cm">/* Start of wanted data */</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_delay_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_delay_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">work</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%10s&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scsi_debug_delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_delay_show</span><span class="p">,</span>
	    <span class="n">sdebug_delay_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_opts_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_opts_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">opts</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">work</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%10s&quot;</span><span class="p">,</span> <span class="n">work</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strnicmp</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="s">&quot;0x&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">opts_done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">opts_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">opts_done:</span>
	<span class="n">scsi_debug_opts</span> <span class="o">=</span> <span class="n">opts</span><span class="p">;</span>
	<span class="n">scsi_debug_cmnd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_opts_show</span><span class="p">,</span>
	    <span class="n">sdebug_opts_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_ptype_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_ptype</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_ptype_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_ptype</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_ptype_show</span><span class="p">,</span> <span class="n">sdebug_ptype_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_dsense_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_dsense</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_dsense_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_dsense</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">dsense</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_dsense_show</span><span class="p">,</span>
	    <span class="n">sdebug_dsense_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_fake_rw_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_fake_rw</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_fake_rw_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_fake_rw</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">fake_rw</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_fake_rw_show</span><span class="p">,</span>
	    <span class="n">sdebug_fake_rw_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_no_lun_0_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_no_lun_0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_no_lun_0_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_no_lun_0</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">no_lun_0</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_no_lun_0_show</span><span class="p">,</span>
	    <span class="n">sdebug_no_lun_0_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_num_tgts_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_num_tgts</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_num_tgts_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_num_tgts</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">sdebug_max_tgts_luns</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">num_tgts</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_num_tgts_show</span><span class="p">,</span>
	    <span class="n">sdebug_num_tgts_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_dev_size_mb_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_dev_size_mb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">dev_size_mb</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_dev_size_mb_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_num_parts_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_num_parts</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">num_parts</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_num_parts_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_every_nth_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_every_nth</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_every_nth_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">nth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nth</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">scsi_debug_every_nth</span> <span class="o">=</span> <span class="n">nth</span><span class="p">;</span>
		<span class="n">scsi_debug_cmnd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">every_nth</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_every_nth_show</span><span class="p">,</span>
	    <span class="n">sdebug_every_nth_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_max_luns_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_max_luns</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_max_luns_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_max_luns</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">sdebug_max_tgts_luns</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">max_luns</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_max_luns_show</span><span class="p">,</span>
	    <span class="n">sdebug_max_luns_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_max_queue_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_max_queue</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_max_queue_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">SCSI_DEBUG_CANQUEUE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_max_queue</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">max_queue</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_max_queue_show</span><span class="p">,</span>
	    <span class="n">sdebug_max_queue_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_no_uld_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_no_uld</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">no_uld</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_no_uld_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_scsi_level_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_scsi_level</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">scsi_level</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_scsi_level_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_virtual_gb_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_virtual_gb</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_virtual_gb_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_virtual_gb</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

		<span class="n">sdebug_capacity</span> <span class="o">=</span> <span class="n">get_sdebug_capacity</span><span class="p">();</span>

		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">virtual_gb</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_virtual_gb_show</span><span class="p">,</span>
	    <span class="n">sdebug_virtual_gb_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_add_host_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_add_host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_add_host_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delta_hosts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delta_hosts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta_hosts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">sdebug_add_adapter</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delta_hosts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delta_hosts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">sdebug_remove_adapter</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">delta_hosts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">add_host</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_add_host_show</span><span class="p">,</span>
	    <span class="n">sdebug_add_host_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_vpd_use_hostno_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_vpd_use_hostno</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_vpd_use_hostno_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_debug_vpd_use_hostno</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">vpd_use_hostno</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">sdebug_vpd_use_hostno_show</span><span class="p">,</span>
	    <span class="n">sdebug_vpd_use_hostno_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_sector_size_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span> <span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">sector_size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_sector_size_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_dix_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_dix</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">dix</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_dix_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_dif_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_dif</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_dif_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_guard_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_guard</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_guard_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_ato_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_debug_ato</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">ato</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_ato_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sdebug_map_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">ddp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_debug_lbp</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0-%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sdebug_store_sectors</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">bitmap_scnlistprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">map_storep</span><span class="p">,</span> <span class="n">map_size</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">sdebug_map_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/* Note: The following function creates attribute files in the</span>
<span class="cm">   /sys/bus/pseudo/drivers/scsi_debug directory. The advantage of these</span>
<span class="cm">   files (over those found in the /sys/module/scsi_debug/parameters</span>
<span class="cm">   directory) is that auxiliary actions can be triggered when an attribute</span>
<span class="cm">   is changed. For example see: sdebug_add_host_store() above.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_create_driverfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_add_host</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_delay</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dev_size_mb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dsense</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_every_nth</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_fake_rw</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_luns</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_queue</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_no_lun_0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_no_uld</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_num_parts</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_num_tgts</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_ptype</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_opts</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_scsi_level</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_virtual_gb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_vpd_use_hostno</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_sector_size</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dix</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dif</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_guard</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_ato</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_map</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_remove_driverfs_files</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_map</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_ato</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_guard</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dif</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dix</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_sector_size</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_vpd_use_hostno</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_virtual_gb</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_scsi_level</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_opts</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_ptype</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_num_tgts</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_num_parts</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_no_uld</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_no_lun_0</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_queue</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_max_luns</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_fake_rw</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_every_nth</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dsense</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_dev_size_mb</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_delay</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_add_host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pseudo_primary</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">scsi_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">host_to_add</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_debug_sector_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="mi">512</span>:
	<span class="k">case</span> <span class="mi">1024</span>:
	<span class="k">case</span> <span class="mi">2048</span>:
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: invalid sector_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scsi_debug_sector_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_debug_dif</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SD_DIF_TYPE0_PROTECTION</span>:
	<span class="k">case</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span>:
	<span class="k">case</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span>:
	<span class="k">case</span> <span class="n">SD_DIF_TYPE3_PROTECTION</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: dif must be 0, 1, 2 or 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_guard</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: guard must be 0 or 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_ato</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: ato must be 0 or 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_physblk_exp</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: invalid physblk_exp %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scsi_debug_physblk_exp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lowest_aligned</span> <span class="o">&gt;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: lowest_aligned too big: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scsi_debug_lowest_aligned</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dev_size_mb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">scsi_debug_dev_size_mb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* force minimum 1 MB ramdisk */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scsi_debug_dev_size_mb</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">;</span>
	<span class="n">sdebug_store_sectors</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">/</span> <span class="n">scsi_debug_sector_size</span><span class="p">;</span>
	<span class="n">sdebug_capacity</span> <span class="o">=</span> <span class="n">get_sdebug_capacity</span><span class="p">();</span>

	<span class="cm">/* play around with geometry, don&#39;t waste too much on track 0 */</span>
	<span class="n">sdebug_heads</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sdebug_sectors_per</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dev_size_mb</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">sdebug_heads</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dev_size_mb</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">sdebug_heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sdebug_cylinders_per</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sdebug_capacity</span> <span class="o">/</span>
			       <span class="p">(</span><span class="n">sdebug_sectors_per</span> <span class="o">*</span> <span class="n">sdebug_heads</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdebug_cylinders_per</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* other LLDs do this; implies &gt;= 1GB ram disk ... */</span>
		<span class="n">sdebug_heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sdebug_sectors_per</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">sdebug_cylinders_per</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sdebug_capacity</span> <span class="o">/</span>
			       <span class="p">(</span><span class="n">sdebug_sectors_per</span> <span class="o">*</span> <span class="n">sdebug_heads</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fake_storep</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fake_storep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: out of memory, 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fake_storep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_num_parts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdebug_build_parts</span><span class="p">(</span><span class="n">fake_storep</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dif_size</span><span class="p">;</span>

		<span class="n">dif_size</span> <span class="o">=</span> <span class="n">sdebug_store_sectors</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd_dif_tuple</span><span class="p">);</span>
		<span class="n">dif_storep</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">dif_size</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: dif_storep %u bytes @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dif_size</span><span class="p">,</span> <span class="n">dif_storep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dif_storep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: out of mem. (DIX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_vm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dif_storep</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">dif_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Logical Block Provisioning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbp</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map_bytes</span><span class="p">;</span>

		<span class="n">scsi_debug_unmap_max_blocks</span> <span class="o">=</span>
			<span class="n">clamp</span><span class="p">(</span><span class="n">scsi_debug_unmap_max_blocks</span><span class="p">,</span> <span class="mi">0U</span><span class="p">,</span> <span class="mh">0xffffffffU</span><span class="p">);</span>

		<span class="n">scsi_debug_unmap_max_desc</span> <span class="o">=</span>
			<span class="n">clamp</span><span class="p">(</span><span class="n">scsi_debug_unmap_max_desc</span><span class="p">,</span> <span class="mi">0U</span><span class="p">,</span> <span class="mi">256U</span><span class="p">);</span>

		<span class="n">scsi_debug_unmap_granularity</span> <span class="o">=</span>
			<span class="n">clamp</span><span class="p">(</span><span class="n">scsi_debug_unmap_granularity</span><span class="p">,</span> <span class="mi">1U</span><span class="p">,</span> <span class="mh">0xffffffffU</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_unmap_alignment</span> <span class="o">&amp;&amp;</span>
		    <span class="n">scsi_debug_unmap_granularity</span> <span class="o">&lt;</span> <span class="n">scsi_debug_unmap_alignment</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: ERR: unmap_granularity &lt; unmap_alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">map_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdebug_store_sectors</span> <span class="o">/</span> <span class="n">scsi_debug_unmap_granularity</span><span class="p">);</span>
		<span class="n">map_bytes</span> <span class="o">=</span> <span class="n">map_size</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">map_storep</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">map_bytes</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug_init: %lu provisioning blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">map_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">map_storep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: out of mem. (MAP)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_vm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">map_storep</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">map_bytes</span><span class="p">);</span>

		<span class="cm">/* Map first 1KB for partition table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_num_parts</span><span class="p">)</span>
			<span class="n">map_region</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pseudo_primary</span> <span class="o">=</span> <span class="n">root_device_register</span><span class="p">(</span><span class="s">&quot;pseudo_0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pseudo_primary</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug: root_device_register() error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pseudo_primary</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_vm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pseudo_lld_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug: bus_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dev_unreg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug: driver_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bus_unreg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_create_driverfs_files</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi_debug: driver_create_file error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">del_files</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_all_queued</span><span class="p">();</span>

	<span class="n">host_to_add</span> <span class="o">=</span> <span class="n">scsi_debug_add_host</span><span class="p">;</span>
        <span class="n">scsi_debug_add_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">host_to_add</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sdebug_add_adapter</span><span class="p">())</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi_debug_init: &quot;</span>
                               <span class="s">&quot;sdebug_add_adapter failed k=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug_init: built %d host(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scsi_debug_add_host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">del_files:</span>
	<span class="n">do_remove_driverfs_files</span><span class="p">();</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">);</span>
<span class="nl">bus_unreg:</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pseudo_lld_bus</span><span class="p">);</span>
<span class="nl">dev_unreg:</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">pseudo_primary</span><span class="p">);</span>
<span class="nl">free_vm:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_storep</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">map_storep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dif_storep</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">dif_storep</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">fake_storep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">scsi_debug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">scsi_debug_add_host</span><span class="p">;</span>

	<span class="n">stop_all_queued</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">k</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span>
		<span class="n">sdebug_remove_adapter</span><span class="p">();</span>
	<span class="n">do_remove_driverfs_files</span><span class="p">();</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driverfs_driver</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pseudo_lld_bus</span><span class="p">);</span>
	<span class="n">root_device_unregister</span><span class="p">(</span><span class="n">pseudo_primary</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dif_storep</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">dif_storep</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">fake_storep</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">scsi_debug_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">scsi_debug_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdebug_release_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>

	<span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">to_sdebug_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdebug_add_adapter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">devs_per_host</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">sdbg_devinfo</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

        <span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdbg_host</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">sdbg_host</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: out of memory at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">);</span>

	<span class="n">devs_per_host</span> <span class="o">=</span> <span class="n">scsi_debug_num_tgts</span> <span class="o">*</span> <span class="n">scsi_debug_max_luns</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">devs_per_host</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdbg_devinfo</span> <span class="o">=</span> <span class="n">sdebug_device_create</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdbg_devinfo</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: out of memory at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
        <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdebug_host_list</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>

        <span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pseudo_lld_bus</span><span class="p">;</span>
        <span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pseudo_primary</span><span class="p">;</span>
        <span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdebug_release_adapter</span><span class="p">;</span>
        <span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adapter%d&quot;</span><span class="p">,</span> <span class="n">scsi_debug_add_host</span><span class="p">);</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>

	<span class="o">++</span><span class="n">scsi_debug_add_host</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">clean:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sdbg_devinfo</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
				 <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_devinfo</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sdbg_devinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdebug_remove_adapter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span> <span class="n">sdbg_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">sdebug_host_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
                                       <span class="k">struct</span> <span class="n">sdebug_host_info</span><span class="p">,</span> <span class="n">host_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
	<span class="p">}</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_host_list_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdbg_host</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

        <span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="o">--</span><span class="n">scsi_debug_add_host</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">scsi_debug_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">done_funct_t</span> <span class="n">done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ei_lba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errsts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">devip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inj_recovered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inj_transport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inj_dif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inj_dix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: cmd &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: initiator&#39;s id used as &quot;</span>
		       <span class="s">&quot;target!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">schedule_resp</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span>
				     <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;=</span> <span class="n">scsi_debug_max_luns</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">schedule_resp</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span>
				     <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">devip</span> <span class="o">=</span> <span class="n">devInfoReg</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">devip</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">schedule_resp</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span>
				     <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_debug_every_nth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">++</span><span class="n">scsi_debug_cmnd_count</span> <span class="o">&gt;=</span> <span class="n">abs</span><span class="p">(</span><span class="n">scsi_debug_every_nth</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">scsi_debug_cmnd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_every_nth</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">scsi_debug_every_nth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_TIMEOUT</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ignore command causing timeout */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_MAC_TIMEOUT</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span> <span class="o">&amp;&amp;</span>
			 <span class="n">scsi_medium_access_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* time out reads and writes */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_RECOVERED_ERR</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">inj_recovered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* to reads and writes below */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_TRANSPORT_ERR</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">inj_transport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* to reads and writes below */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_DIF_ERR</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">inj_dif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* to reads and writes below */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_DIX_ERR</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">inj_dix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* to reads and writes below */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devip</span><span class="o">-&gt;</span><span class="n">wlun</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="k">case</span> <span class="n">REPORT_LUNS</span>:
			<span class="k">break</span><span class="p">;</span>  <span class="cm">/* only allowable wlun commands */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: Opcode: 0x%x &quot;</span>
				       <span class="s">&quot;not supported for wlun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">schedule_resp</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span>
					     <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:     <span class="cm">/* mandatory, ignore unit attention */</span>
		<span class="n">delay_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_inquiry</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:	<span class="cm">/* mandatory, ignore unit attention */</span>
		<span class="n">delay_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_requests</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REZERO_UNIT</span>:	<span class="cm">/* actually this is REWIND for SSC */</span>
	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_start_stop</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: Medium removal %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;inhibited&quot;</span> <span class="o">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>:     <span class="cm">/* mandatory */</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:     <span class="cm">/* mandatory */</span>
		<span class="n">delay_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESERVE</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESERVE_10</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELEASE</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELEASE_10</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_readcap</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAI_READ_CAPACITY_16</span><span class="p">)</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_readcap16</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAI_GET_LBA_STATUS</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_lbp</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
						<span class="n">INVALID_COMMAND_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_get_lba_status</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAINTENANCE_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">MI_REPORT_TARGET_PGS</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_report_tgtpgs</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_16</span>:
	<span class="k">case</span> <span class="n">READ_12</span>:
	<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="cm">/* READ{10,12,16} and DIF Type 2 are natural enemies */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_COMMAND_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span> <span class="o">||</span>
		     <span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE3_PROTECTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unprotected RD/WR to DIF device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">READ_6</span>:
<span class="nl">read:</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_fake_rw</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">get_data_transfer_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei_lba</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_read</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inj_recovered</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">RECOVERED_ERROR</span><span class="p">,</span>
					<span class="n">THRESHOLD_EXCEEDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inj_transport</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ABORTED_COMMAND</span><span class="p">,</span>
					<span class="n">TRANSPORT_PROBLEM</span><span class="p">,</span> <span class="n">ACK_NAK_TO</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inj_dif</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ABORTED_COMMAND</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inj_dix</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LUNS</span>:	<span class="cm">/* mandatory, ignore unit attention */</span>
		<span class="n">delay_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_report_luns</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VERIFY</span>:		<span class="cm">/* 10 byte SBC-2 command */</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_16</span>:
	<span class="k">case</span> <span class="n">WRITE_12</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="cm">/* WRITE{10,12,16} and DIF Type 2 are natural enemies */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_COMMAND_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span> <span class="o">||</span>
		     <span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE3_PROTECTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unprotected RD/WR to DIF device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">WRITE_6</span>:
<span class="nl">write:</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_fake_rw</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">get_data_transfer_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei_lba</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_write</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inj_recovered</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">RECOVERED_ERROR</span><span class="p">,</span>
					<span class="n">THRESHOLD_EXCEEDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inj_dif</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ABORTED_COMMAND</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inj_dix</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errsts</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">illegal_condition_result</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_SAME_16</span>:
	<span class="k">case</span> <span class="n">WRITE_SAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WRITE_SAME_16</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_debug_lbpws</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WRITE_SAME</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_debug_lbpws10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
						<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">unmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">get_data_transfer_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei_lba</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_write_same</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">,</span> <span class="n">unmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNMAP</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_unmap_max_desc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">scsi_debug_lbpu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_COMMAND_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_unmap</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_mode_sense</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_mode_select</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT_10</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_mode_select</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOG_SENSE</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_log_sense</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
		<span class="n">delay_override</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XDWRITEREAD_10</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bidi_cmnd</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
					<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_fake_rw</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">get_data_transfer_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ei_lba</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_read</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_write</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">ei_lba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">resp_xdwriteread</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VARIABLE_LENGTH_CMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dif</span> <span class="o">==</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;Unprotected RD/WR to DIF device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">read</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">write</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
				<span class="n">INVALID_FIELD_IN_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCSI_DEBUG_OPT_NOISE</span> <span class="o">&amp;</span> <span class="n">scsi_debug_opts</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: Opcode: 0x%x not &quot;</span>
			       <span class="s">&quot;supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_readiness</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">devip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errsts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Unit attention takes precedence */</span>
		<span class="n">mk_sense_buffer</span><span class="p">(</span><span class="n">devip</span><span class="p">,</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="n">INVALID_OPCODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">errsts</span> <span class="o">=</span> <span class="n">check_condition_result</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">schedule_resp</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">devip</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">errsts</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">delay_override</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">scsi_debug_delay</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">scsi_debug_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">sdebug_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">proc_info</span> <span class="o">=</span>		<span class="n">scsi_debug_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span> <span class="o">=</span>		<span class="n">sdebug_proc_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>			<span class="s">&quot;SCSI DEBUG&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="n">scsi_debug_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span> <span class="o">=</span>		<span class="n">scsi_debug_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span>	<span class="n">scsi_debug_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span> <span class="o">=</span>	<span class="n">scsi_debug_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">scsi_debug_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span>		<span class="n">scsi_debug_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span>	<span class="n">scsi_debug_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span> <span class="o">=</span> <span class="n">scsi_debug_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">scsi_debug_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">scsi_debug_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span> <span class="o">=</span>		<span class="n">scsi_debug_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span>		<span class="n">SCSI_DEBUG_CANQUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span>		<span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span>		<span class="mi">256</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span> <span class="o">=</span>		<span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span>		<span class="mh">0xffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> 	<span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdebug_driver_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">hpnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">host_prot</span><span class="p">;</span>

	<span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">to_sdebug_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sdebug_driver_template</span><span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">scsi_debug_max_queue</span><span class="p">;</span>
	<span class="n">hpnt</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdebug_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdbg_host</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">hpnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: scsi_register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">hpnt</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">**</span><span class="p">)</span><span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="o">=</span> <span class="n">sdbg_host</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scsi_debug_num_tgts</span> <span class="o">&gt;</span> <span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">))</span>
		<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">scsi_debug_num_tgts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">scsi_debug_num_tgts</span><span class="p">;</span>
	<span class="n">hpnt</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">SAM2_WLUN_REPORT_LUNS</span><span class="p">;</span>	<span class="cm">/* = scsi_debug_max_luns; */</span>

	<span class="n">host_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_debug_dif</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SD_DIF_TYPE1_PROTECTION</span>:
		<span class="n">host_prot</span> <span class="o">=</span> <span class="n">SHOST_DIF_TYPE1_PROTECTION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span><span class="p">)</span>
			<span class="n">host_prot</span> <span class="o">|=</span> <span class="n">SHOST_DIX_TYPE1_PROTECTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_DIF_TYPE2_PROTECTION</span>:
		<span class="n">host_prot</span> <span class="o">=</span> <span class="n">SHOST_DIF_TYPE2_PROTECTION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span><span class="p">)</span>
			<span class="n">host_prot</span> <span class="o">|=</span> <span class="n">SHOST_DIX_TYPE2_PROTECTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_DIF_TYPE3_PROTECTION</span>:
		<span class="n">host_prot</span> <span class="o">=</span> <span class="n">SHOST_DIF_TYPE3_PROTECTION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span><span class="p">)</span>
			<span class="n">host_prot</span> <span class="o">|=</span> <span class="n">SHOST_DIX_TYPE3_PROTECTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_dix</span><span class="p">)</span>
			<span class="n">host_prot</span> <span class="o">|=</span> <span class="n">SHOST_DIX_TYPE0_PROTECTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_host_set_prot</span><span class="p">(</span><span class="n">hpnt</span><span class="p">,</span> <span class="n">host_prot</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi_debug: host protection%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIF_TYPE1_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIF1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIF_TYPE2_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIF2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIF_TYPE3_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIF3&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIX_TYPE0_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIX0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIX_TYPE1_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIX1&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIX_TYPE2_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIX2&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">host_prot</span> <span class="o">&amp;</span> <span class="n">SHOST_DIX_TYPE3_PROTECTION</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; DIX3&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_debug_guard</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">hpnt</span><span class="p">,</span> <span class="n">SHOST_DIX_GUARD_IP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">hpnt</span><span class="p">,</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">);</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">hpnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
                <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">hpnt</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>
		<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">hpnt</span><span class="p">);</span>


        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdebug_driver_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sdebug_host_info</span> <span class="o">*</span><span class="n">sdbg_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdebug_dev_info</span> <span class="o">*</span><span class="n">sdbg_devinfo</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">sdbg_host</span> <span class="o">=</span> <span class="n">to_sdebug_host</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdbg_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to locate host info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sdbg_devinfo</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">dev_info_list</span><span class="p">,</span>
				 <span class="n">dev_list</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdbg_devinfo</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">sdbg_devinfo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sdbg_host</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pseudo_lld_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">dev_driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">pseudo_lld_bus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pseudo&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">pseudo_lld_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sdebug_driver_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">sdebug_driver_remove</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
