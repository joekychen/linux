<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › u14-34f.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>u14-34f.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      u14-34f.c - Low-level driver for UltraStor 14F/34F SCSI host adapters.</span>
<span class="cm"> *</span>
<span class="cm"> *      03 Jun 2003 Rev. 8.10 for linux-2.5.70</span>
<span class="cm"> *        + Update for new IRQ API.</span>
<span class="cm"> *        + Use &quot;goto&quot; when appropriate.</span>
<span class="cm"> *        + Drop u14-34f.h.</span>
<span class="cm"> *        + Update for new module_param API.</span>
<span class="cm"> *        + Module parameters  can now be specified only in the</span>
<span class="cm"> *          same format as the kernel boot options.</span>
<span class="cm"> *</span>
<span class="cm"> *             boot option    old module param </span>
<span class="cm"> *             -----------    ------------------</span>
<span class="cm"> *             addr,...       io_port=addr,...</span>
<span class="cm"> *             lc:[y|n]       linked_comm=[1|0]</span>
<span class="cm"> *             mq:xx          max_queue_depth=xx</span>
<span class="cm"> *             tm:[0|1|2]     tag_mode=[0|1|2]</span>
<span class="cm"> *             et:[y|n]       ext_tran=[1|0]</span>
<span class="cm"> *             of:[y|n]       have_old_firmware=[1|0]</span>
<span class="cm"> *</span>
<span class="cm"> *          A valid example using the new parameter format is:</span>
<span class="cm"> *          modprobe u14-34f &quot;u14-34f=0x340,0x330,lc:y,tm:0,mq:4&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *          which is equivalent to the old format:</span>
<span class="cm"> *          modprobe u14-34f io_port=0x340,0x330 linked_comm=1 tag_mode=0 \</span>
<span class="cm"> *                        max_queue_depth=4</span>
<span class="cm"> *</span>
<span class="cm"> *          With actual module code, u14-34f and u14_34f are equivalent</span>
<span class="cm"> *          as module parameter names.</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Feb 2003 Rev. 8.04 for linux 2.5.60</span>
<span class="cm"> *        + Release irq before calling scsi_register.</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Nov 2002 Rev. 8.02 for linux 2.5.47</span>
<span class="cm"> *        + Release driver_lock before calling scsi_register.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Nov 2002 Rev. 8.01 for linux 2.5.47</span>
<span class="cm"> *        + Fixed bios_param and scsicam_bios_param calling parameters.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 Oct 2002 Rev. 8.00 for linux 2.5.44-ac4</span>
<span class="cm"> *        + Use new tcq and adjust_queue_depth api.</span>
<span class="cm"> *        + New command line option (tm:[0-2]) to choose the type of tags:</span>
<span class="cm"> *          0 -&gt; disable tagging ; 1 -&gt; simple tags  ; 2 -&gt; ordered tags.</span>
<span class="cm"> *          Default is tm:0 (tagged commands disabled).</span>
<span class="cm"> *          For compatibility the &quot;tc:&quot; option is an alias of the &quot;tm:&quot;</span>
<span class="cm"> *          option; tc:n is equivalent to tm:0 and tc:y is equivalent to</span>
<span class="cm"> *          tm:1.</span>
<span class="cm"> *</span>
<span class="cm"> *      10 Oct 2002 Rev. 7.70 for linux 2.5.42</span>
<span class="cm"> *        + Foreport from revision 6.70.</span>
<span class="cm"> *</span>
<span class="cm"> *      25 Jun 2002 Rev. 6.70 for linux 2.4.19</span>
<span class="cm"> *        + Fixed endian-ness problem due to bitfields.</span>
<span class="cm"> *</span>
<span class="cm"> *      21 Feb 2002 Rev. 6.52 for linux 2.4.18</span>
<span class="cm"> *        + Backport from rev. 7.22 (use io_request_lock).</span>
<span class="cm"> *</span>
<span class="cm"> *      20 Feb 2002 Rev. 7.22 for linux 2.5.5</span>
<span class="cm"> *        + Remove any reference to virt_to_bus().</span>
<span class="cm"> *        + Fix pio hang while detecting multiple HBAs.</span>
<span class="cm"> *</span>
<span class="cm"> *      01 Jan 2002 Rev. 7.20 for linux 2.5.1</span>
<span class="cm"> *        + Use the dynamic DMA mapping API.</span>
<span class="cm"> *</span>
<span class="cm"> *      19 Dec 2001 Rev. 7.02 for linux 2.5.1</span>
<span class="cm"> *        + Use SCpnt-&gt;sc_data_direction if set.</span>
<span class="cm"> *        + Use sglist.page instead of sglist.address.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Dec 2001 Rev. 7.00 for linux 2.5.1</span>
<span class="cm"> *        + Use host-&gt;host_lock instead of io_request_lock.</span>
<span class="cm"> *</span>
<span class="cm"> *       1 May 2001 Rev. 6.05 for linux 2.4.4</span>
<span class="cm"> *        + Fix data transfer direction for opcode SEND_CUE_SHEET (0x5d)</span>
<span class="cm"> *</span>
<span class="cm"> *      25 Jan 2001 Rev. 6.03 for linux 2.4.0</span>
<span class="cm"> *        + &quot;check_region&quot; call replaced by &quot;request_region&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Nov 2000 Rev. 6.02 for linux 2.4.0-test11</span>
<span class="cm"> *        + Removed old scsi error handling support.</span>
<span class="cm"> *        + The obsolete boot option flag eh:n is silently ignored.</span>
<span class="cm"> *        + Removed error messages while a disk drive is powered up at</span>
<span class="cm"> *          boot time.</span>
<span class="cm"> *        + Improved boot messages: all tagged capable device are</span>
<span class="cm"> *          indicated as &quot;tagged&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Sep 1999 Rev. 5.11 for linux 2.2.12 and 2.3.18</span>
<span class="cm"> *        + Updated to the new __setup interface for boot command line options.</span>
<span class="cm"> *        + When loaded as a module, accepts the new parameter boot_options</span>
<span class="cm"> *          which value is a string with the same format of the kernel boot</span>
<span class="cm"> *          command line options. A valid example is:</span>
<span class="cm"> *          modprobe u14-34f &#39;boot_options=&quot;0x230,0x340,lc:y,mq:4&quot;&#39;</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Jul 1999 Rev. 5.00 for linux 2.2.10 and 2.3.11</span>
<span class="cm"> *        + Removed pre-2.2 source code compatibility.</span>
<span class="cm"> *</span>
<span class="cm"> *      26 Jul 1998 Rev. 4.33 for linux 2.0.35 and 2.1.111</span>
<span class="cm"> *          Added command line option (et:[y|n]) to use the existing</span>
<span class="cm"> *          translation (returned by scsicam_bios_param) as disk geometry.</span>
<span class="cm"> *          The default is et:n, which uses the disk geometry jumpered</span>
<span class="cm"> *          on the board.</span>
<span class="cm"> *          The default value et:n is compatible with all previous revisions</span>
<span class="cm"> *          of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 May 1998 Rev. 4.32 for linux 2.0.33 and 2.1.104</span>
<span class="cm"> *          Increased busy timeout from 10 msec. to 200 msec. while</span>
<span class="cm"> *          processing interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 May 1998 Rev. 4.31 for linux 2.0.33 and 2.1.102</span>
<span class="cm"> *          Improved abort handling during the eh recovery process.</span>
<span class="cm"> *</span>
<span class="cm"> *      13 May 1998 Rev. 4.30 for linux 2.0.33 and 2.1.101</span>
<span class="cm"> *          The driver is now fully SMP safe, including the</span>
<span class="cm"> *          abort and reset routines.</span>
<span class="cm"> *          Added command line options (eh:[y|n]) to choose between</span>
<span class="cm"> *          new_eh_code and the old scsi code.</span>
<span class="cm"> *          If linux version &gt;= 2.1.101 the default is eh:y, while the eh</span>
<span class="cm"> *          option is ignored for previous releases and the old scsi code</span>
<span class="cm"> *          is used.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 Apr 1998 Rev. 4.20 for linux 2.0.33 and 2.1.97</span>
<span class="cm"> *          Reworked interrupt handler.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Apr 1998 rev. 4.05 for linux 2.0.33 and 2.1.95</span>
<span class="cm"> *          Major reliability improvement: when a batch with overlapping</span>
<span class="cm"> *          requests is detected, requests are queued one at a time</span>
<span class="cm"> *          eliminating any possible board or drive reordering.</span>
<span class="cm"> *</span>
<span class="cm"> *      10 Apr 1998 rev. 4.04 for linux 2.0.33 and 2.1.95</span>
<span class="cm"> *          Improved SMP support (if linux version &gt;= 2.1.95).</span>
<span class="cm"> *</span>
<span class="cm"> *       9 Apr 1998 rev. 4.03 for linux 2.0.33 and 2.1.94</span>
<span class="cm"> *          Performance improvement: when sequential i/o is detected,</span>
<span class="cm"> *          always use direct sort instead of reverse sort.</span>
<span class="cm"> *</span>
<span class="cm"> *       4 Apr 1998 rev. 4.02 for linux 2.0.33 and 2.1.92</span>
<span class="cm"> *          io_port is now unsigned long.</span>
<span class="cm"> *</span>
<span class="cm"> *      17 Mar 1998 rev. 4.01 for linux 2.0.33 and 2.1.88</span>
<span class="cm"> *          Use new scsi error handling code (if linux version &gt;= 2.1.88).</span>
<span class="cm"> *          Use new interrupt code.</span>
<span class="cm"> *</span>
<span class="cm"> *      12 Sep 1997 rev. 3.11 for linux 2.0.30 and 2.1.55</span>
<span class="cm"> *          Use of udelay inside the wait loops to avoid timeout</span>
<span class="cm"> *          problems with fast cpus.</span>
<span class="cm"> *          Removed check about useless calls to the interrupt service</span>
<span class="cm"> *          routine (reported on SMP systems only).</span>
<span class="cm"> *          At initialization time &quot;sorted/unsorted&quot; is displayed instead</span>
<span class="cm"> *          of &quot;linked/unlinked&quot; to reinforce the fact that &quot;linking&quot; is</span>
<span class="cm"> *          nothing but &quot;elevator sorting&quot; in the actual implementation.</span>
<span class="cm"> *</span>
<span class="cm"> *      17 May 1997 rev. 3.10 for linux 2.0.30 and 2.1.38</span>
<span class="cm"> *          Use of serial_number_at_timeout in abort and reset processing.</span>
<span class="cm"> *          Use of the __initfunc and __initdata macro in setup code.</span>
<span class="cm"> *          Minor cleanups in the list_statistics code.</span>
<span class="cm"> *</span>
<span class="cm"> *      24 Feb 1997 rev. 3.00 for linux 2.0.29 and 2.1.26</span>
<span class="cm"> *          When loading as a module, parameter passing is now supported</span>
<span class="cm"> *          both in 2.0 and in 2.1 style.</span>
<span class="cm"> *          Fixed data transfer direction for some SCSI opcodes.</span>
<span class="cm"> *          Immediate acknowledge to request sense commands.</span>
<span class="cm"> *          Linked commands to each disk device are now reordered by elevator</span>
<span class="cm"> *          sorting. Rare cases in which reordering of write requests could</span>
<span class="cm"> *          cause wrong results are managed.</span>
<span class="cm"> *</span>
<span class="cm"> *      18 Jan 1997 rev. 2.60 for linux 2.1.21 and 2.0.28</span>
<span class="cm"> *          Added command line options to enable/disable linked commands</span>
<span class="cm"> *          (lc:[y|n]), old firmware support (of:[y|n]) and to set the max</span>
<span class="cm"> *          queue depth (mq:xx). Default is &quot;u14-34f=lc:n,of:n,mq:8&quot;.</span>
<span class="cm"> *          Improved command linking.</span>
<span class="cm"> *</span>
<span class="cm"> *       8 Jan 1997 rev. 2.50 for linux 2.1.20 and 2.0.27</span>
<span class="cm"> *          Added linked command support.</span>
<span class="cm"> *</span>
<span class="cm"> *       3 Dec 1996 rev. 2.40 for linux 2.1.14 and 2.0.27</span>
<span class="cm"> *          Added queue depth adjustment.</span>
<span class="cm"> *</span>
<span class="cm"> *      22 Nov 1996 rev. 2.30 for linux 2.1.12 and 2.0.26</span>
<span class="cm"> *          The list of i/o ports to be probed can be overwritten by the</span>
<span class="cm"> *          &quot;u14-34f=port0,port1,....&quot; boot command line option.</span>
<span class="cm"> *          Scatter/gather lists are now allocated by a number of kmalloc</span>
<span class="cm"> *          calls, in order to avoid the previous size limit of 64Kb.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Nov 1996 rev. 2.20 for linux 2.1.10 and 2.0.25</span>
<span class="cm"> *          Added multichannel support.</span>
<span class="cm"> *</span>
<span class="cm"> *      27 Sep 1996 rev. 2.12 for linux 2.1.0</span>
<span class="cm"> *          Portability cleanups (virtual/bus addressing, little/big endian</span>
<span class="cm"> *          support).</span>
<span class="cm"> *</span>
<span class="cm"> *      09 Jul 1996 rev. 2.11 for linux 2.0.4</span>
<span class="cm"> *          &quot;Data over/under-run&quot; no longer implies a redo on all targets.</span>
<span class="cm"> *          Number of internal retries is now limited.</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Apr 1996 rev. 2.10 for linux 1.3.90</span>
<span class="cm"> *          New argument &quot;reset_flags&quot; to the reset routine.</span>
<span class="cm"> *</span>
<span class="cm"> *      21 Jul 1995 rev. 2.02 for linux 1.3.11</span>
<span class="cm"> *          Fixed Data Transfer Direction for some SCSI commands.</span>
<span class="cm"> *</span>
<span class="cm"> *      13 Jun 1995 rev. 2.01 for linux 1.2.10</span>
<span class="cm"> *          HAVE_OLD_UX4F_FIRMWARE should be defined for U34F boards when</span>
<span class="cm"> *          the firmware prom is not the latest one (28008-006).</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Mar 1995 rev. 2.00 for linux 1.2.0</span>
<span class="cm"> *          Fixed a bug which prevented media change detection for removable</span>
<span class="cm"> *          disk drives.</span>
<span class="cm"> *</span>
<span class="cm"> *      23 Feb 1995 rev. 1.18 for linux 1.1.94</span>
<span class="cm"> *          Added a check for scsi_register returning NULL.</span>
<span class="cm"> *</span>
<span class="cm"> *      11 Feb 1995 rev. 1.17 for linux 1.1.91</span>
<span class="cm"> *          U14F qualified to run with 32 sglists.</span>
<span class="cm"> *          Now DEBUG_RESET is disabled by default.</span>
<span class="cm"> *</span>
<span class="cm"> *       9 Feb 1995 rev. 1.16 for linux 1.1.90</span>
<span class="cm"> *          Use host-&gt;wish_block instead of host-&gt;block.</span>
<span class="cm"> *</span>
<span class="cm"> *       8 Feb 1995 rev. 1.15 for linux 1.1.89</span>
<span class="cm"> *          Cleared target_time_out counter while performing a reset.</span>
<span class="cm"> *</span>
<span class="cm"> *      28 Jan 1995 rev. 1.14 for linux 1.1.86</span>
<span class="cm"> *          Added module support.</span>
<span class="cm"> *          Log and do a retry when a disk drive returns a target status</span>
<span class="cm"> *          different from zero on a recovered error.</span>
<span class="cm"> *          Auto detects if U14F boards have an old firmware revision.</span>
<span class="cm"> *          Max number of scatter/gather lists set to 16 for all boards</span>
<span class="cm"> *          (most installation run fine using 33 sglists, while other</span>
<span class="cm"> *          has problems when using more than 16).</span>
<span class="cm"> *</span>
<span class="cm"> *      16 Jan 1995 rev. 1.13 for linux 1.1.81</span>
<span class="cm"> *          Display a message if check_region detects a port address</span>
<span class="cm"> *          already in use.</span>
<span class="cm"> *</span>
<span class="cm"> *      15 Dec 1994 rev. 1.12 for linux 1.1.74</span>
<span class="cm"> *          The host-&gt;block flag is set for all the detected ISA boards.</span>
<span class="cm"> *</span>
<span class="cm"> *      30 Nov 1994 rev. 1.11 for linux 1.1.68</span>
<span class="cm"> *          Redo i/o on target status CHECK_CONDITION for TYPE_DISK only.</span>
<span class="cm"> *          Added optional support for using a single board at a time.</span>
<span class="cm"> *</span>
<span class="cm"> *      14 Nov 1994 rev. 1.10 for linux 1.1.63</span>
<span class="cm"> *</span>
<span class="cm"> *      28 Oct 1994 rev. 1.09 for linux 1.1.58  Final BETA release.</span>
<span class="cm"> *      16 Jul 1994 rev. 1.00 for linux 1.1.29  Initial ALPHA release.</span>
<span class="cm"> *</span>
<span class="cm"> *          This driver is a total replacement of the original UltraStor</span>
<span class="cm"> *          scsi driver, but it supports ONLY the 14F and 34F boards.</span>
<span class="cm"> *          It can be configured in the same kernel in which the original</span>
<span class="cm"> *          ultrastor driver is configured to allow the original U24F</span>
<span class="cm"> *          support.</span>
<span class="cm"> *</span>
<span class="cm"> *          Multiple U14F and/or U34F host adapters are supported.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1994-2003 Dario Ballabio (ballabio_dario@emc.com)</span>
<span class="cm"> *</span>
<span class="cm"> *  Alternate email: dario.ballabio@inwind.it, dario.ballabio@tiscalinet.it</span>
<span class="cm"> *</span>
<span class="cm"> *  Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> *  modification, are permitted provided that redistributions of source</span>
<span class="cm"> *  code retain the above copyright notice and this comment without</span>
<span class="cm"> *  modification.</span>
<span class="cm"> *</span>
<span class="cm"> *      WARNING: if your 14/34F board has an old firmware revision (see below)</span>
<span class="cm"> *               you must change &quot;#undef&quot; into &quot;#define&quot; in the following</span>
<span class="cm"> *               statement.</span>
<span class="cm"> */</span>
<span class="cp">#undef HAVE_OLD_UX4F_FIRMWARE</span>
<span class="cm">/*</span>
<span class="cm"> *  The UltraStor 14F, 24F, and 34F are a family of intelligent, high</span>
<span class="cm"> *  performance SCSI-2 host adapters.</span>
<span class="cm"> *  Here is the scoop on the various models:</span>
<span class="cm"> *</span>
<span class="cm"> *  14F - ISA first-party DMA HA with floppy support and WD1003 emulation.</span>
<span class="cm"> *  24F - EISA Bus Master HA with floppy support and WD1003 emulation.</span>
<span class="cm"> *  34F - VESA Local-Bus Bus Master HA (no WD1003 emulation).</span>
<span class="cm"> *</span>
<span class="cm"> *  This code has been tested with up to two U14F boards, using both</span>
<span class="cm"> *  firmware 28004-005/38004-004 (BIOS rev. 2.00) and the latest firmware</span>
<span class="cm"> *  28004-006/38004-005 (BIOS rev. 2.01).</span>
<span class="cm"> *</span>
<span class="cm"> *  The latest firmware is required in order to get reliable operations when</span>
<span class="cm"> *  clustering is enabled. ENABLE_CLUSTERING provides a performance increase</span>
<span class="cm"> *  up to 50% on sequential access.</span>
<span class="cm"> *</span>
<span class="cm"> *  Since the struct scsi_host_template structure is shared among all 14F and 34F,</span>
<span class="cm"> *  the last setting of use_clustering is in effect for all of these boards.</span>
<span class="cm"> *</span>
<span class="cm"> *  Here a sample configuration using two U14F boards:</span>
<span class="cm"> *</span>
<span class="cm"> U14F0: ISA 0x330, BIOS 0xc8000, IRQ 11, DMA 5, SG 32, MB 16, of:n, lc:y, mq:8.</span>
<span class="cm"> U14F1: ISA 0x340, BIOS 0x00000, IRQ 10, DMA 6, SG 32, MB 16, of:n, lc:y, mq:8.</span>
<span class="cm"> *</span>
<span class="cm"> *  The boot controller must have its BIOS enabled, while other boards can</span>
<span class="cm"> *  have their BIOS disabled, or enabled to an higher address.</span>
<span class="cm"> *  Boards are named Ux4F0, Ux4F1..., according to the port address order in</span>
<span class="cm"> *  the io_port[] array.</span>
<span class="cm"> *</span>
<span class="cm"> *  The following facts are based on real testing results (not on</span>
<span class="cm"> *  documentation) on the above U14F board.</span>
<span class="cm"> *</span>
<span class="cm"> *  - The U14F board should be jumpered for bus on time less or equal to 7</span>
<span class="cm"> *    microseconds, while the default is 11 microseconds. This is order to</span>
<span class="cm"> *    get acceptable performance while using floppy drive and hard disk</span>
<span class="cm"> *    together. The jumpering for 7 microseconds is: JP13 pin 15-16,</span>
<span class="cm"> *    JP14 pin 7-8 and pin 9-10.</span>
<span class="cm"> *    The reduction has a little impact on scsi performance.</span>
<span class="cm"> *</span>
<span class="cm"> *  - If scsi bus length exceeds 3m., the scsi bus speed needs to be reduced</span>
<span class="cm"> *    from 10Mhz to 5Mhz (do this by inserting a jumper on JP13 pin 7-8).</span>
<span class="cm"> *</span>
<span class="cm"> *  - If U14F on board firmware is older than 28004-006/38004-005,</span>
<span class="cm"> *    the U14F board is unable to provide reliable operations if the scsi</span>
<span class="cm"> *    request length exceeds 16Kbyte. When this length is exceeded the</span>
<span class="cm"> *    behavior is:</span>
<span class="cm"> *    - adapter_status equal 0x96 or 0xa3 or 0x93 or 0x94;</span>
<span class="cm"> *    - adapter_status equal 0 and target_status equal 2 on for all targets</span>
<span class="cm"> *      in the next operation following the reset.</span>
<span class="cm"> *    This sequence takes a long time (&gt;3 seconds), so in the meantime</span>
<span class="cm"> *    the SD_TIMEOUT in sd.c could expire giving rise to scsi aborts</span>
<span class="cm"> *    (SD_TIMEOUT has been increased from 3 to 6 seconds in 1.1.31).</span>
<span class="cm"> *    Because of this I had to DISABLE_CLUSTERING and to work around the</span>
<span class="cm"> *    bus reset in the interrupt service routine, returning DID_BUS_BUSY</span>
<span class="cm"> *    so that the operations are retried without complains from the scsi.c</span>
<span class="cm"> *    code.</span>
<span class="cm"> *    Any reset of the scsi bus is going to kill tape operations, since</span>
<span class="cm"> *    no retry is allowed for tapes. Bus resets are more likely when the</span>
<span class="cm"> *    scsi bus is under heavy load.</span>
<span class="cm"> *    Requests using scatter/gather have a maximum length of 16 x 1024 bytes</span>
<span class="cm"> *    when DISABLE_CLUSTERING is in effect, but unscattered requests could be</span>
<span class="cm"> *    larger than 16Kbyte.</span>
<span class="cm"> *</span>
<span class="cm"> *    The new firmware has fixed all the above problems.</span>
<span class="cm"> *</span>
<span class="cm"> *  For U34F boards the latest bios prom is 38008-002 (BIOS rev. 2.01),</span>
<span class="cm"> *  the latest firmware prom is 28008-006. Older firmware 28008-005 has</span>
<span class="cm"> *  problems when using more than 16 scatter/gather lists.</span>
<span class="cm"> *</span>
<span class="cm"> *  The list of i/o ports to be probed can be totally replaced by the</span>
<span class="cm"> *  boot command line option: &quot;u14-34f=port0,port1,port2,...&quot;, where the</span>
<span class="cm"> *  port0, port1... arguments are ISA/VESA addresses to be probed.</span>
<span class="cm"> *  For example using &quot;u14-34f=0x230,0x340&quot;, the driver probes only the two</span>
<span class="cm"> *  addresses 0x230 and 0x340 in this order; &quot;u14-34f=0&quot; totally disables</span>
<span class="cm"> *  this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *  After the optional list of detection probes, other possible command line</span>
<span class="cm"> *  options are:</span>
<span class="cm"> *</span>
<span class="cm"> *  et:y  use disk geometry returned by scsicam_bios_param;</span>
<span class="cm"> *  et:n  use disk geometry jumpered on the board;</span>
<span class="cm"> *  lc:y  enables linked commands;</span>
<span class="cm"> *  lc:n  disables linked commands;</span>
<span class="cm"> *  tm:0  disables tagged commands (same as tc:n);</span>
<span class="cm"> *  tm:1  use simple queue tags (same as tc:y);</span>
<span class="cm"> *  tm:2  use ordered queue tags (same as tc:2);</span>
<span class="cm"> *  of:y  enables old firmware support;</span>
<span class="cm"> *  of:n  disables old firmware support;</span>
<span class="cm"> *  mq:xx set the max queue depth to the value xx (2 &lt;= xx &lt;= 8).</span>
<span class="cm"> *</span>
<span class="cm"> *  The default value is: &quot;u14-34f=lc:n,of:n,mq:8,tm:0,et:n&quot;.</span>
<span class="cm"> *  An example using the list of detection probes could be:</span>
<span class="cm"> *  &quot;u14-34f=0x230,0x340,lc:y,tm:2,of:n,mq:4,et:n&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> *  When loading as a module, parameters can be specified as well.</span>
<span class="cm"> *  The above example would be (use 1 in place of y and 0 in place of n):</span>
<span class="cm"> *</span>
<span class="cm"> *  modprobe u14-34f io_port=0x230,0x340 linked_comm=1 have_old_firmware=0 \</span>
<span class="cm"> *                max_queue_depth=4 ext_tran=0 tag_mode=2</span>
<span class="cm"> *</span>
<span class="cm"> *  ----------------------------------------------------------------------------</span>
<span class="cm"> *  In this implementation, linked commands are designed to work with any DISK</span>
<span class="cm"> *  or CD-ROM, since this linking has only the intent of clustering (time-wise)</span>
<span class="cm"> *  and reordering by elevator sorting commands directed to each device,</span>
<span class="cm"> *  without any relation with the actual SCSI protocol between the controller</span>
<span class="cm"> *  and the device.</span>
<span class="cm"> *  If Q is the queue depth reported at boot time for each device (also named</span>
<span class="cm"> *  cmds/lun) and Q &gt; 2, whenever there is already an active command to the</span>
<span class="cm"> *  device all other commands to the same device  (up to Q-1) are kept waiting</span>
<span class="cm"> *  in the elevator sorting queue. When the active command completes, the</span>
<span class="cm"> *  commands in this queue are sorted by sector address. The sort is chosen</span>
<span class="cm"> *  between increasing or decreasing by minimizing the seek distance between</span>
<span class="cm"> *  the sector of the commands just completed and the sector of the first</span>
<span class="cm"> *  command in the list to be sorted.</span>
<span class="cm"> *  Trivial math assures that the unsorted average seek distance when doing</span>
<span class="cm"> *  random seeks over S sectors is S/3.</span>
<span class="cm"> *  When (Q-1) requests are uniformly distributed over S sectors, the average</span>
<span class="cm"> *  distance between two adjacent requests is S/((Q-1) + 1), so the sorted</span>
<span class="cm"> *  average seek distance for (Q-1) random requests over S sectors is S/Q.</span>
<span class="cm"> *  The elevator sorting hence divides the seek distance by a factor Q/3.</span>
<span class="cm"> *  The above pure geometric remarks are valid in all cases and the</span>
<span class="cm"> *  driver effectively reduces the seek distance by the predicted factor</span>
<span class="cm"> *  when there are Q concurrent read i/o operations on the device, but this</span>
<span class="cm"> *  does not necessarily results in a noticeable performance improvement:</span>
<span class="cm"> *  your mileage may vary....</span>
<span class="cm"> *</span>
<span class="cm"> *  Note: command reordering inside a batch of queued commands could cause</span>
<span class="cm"> *        wrong results only if there is at least one write request and the</span>
<span class="cm"> *        intersection (sector-wise) of all requests is not empty.</span>
<span class="cm"> *        When the driver detects a batch including overlapping requests</span>
<span class="cm"> *        (a really rare event) strict serial (pid) order is enforced.</span>
<span class="cm"> *  ----------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> *  The boards are named Ux4F0, Ux4F1,... according to the detection order.</span>
<span class="cm"> *</span>
<span class="cm"> *  In order to support multiple ISA boards in a reliable way,</span>
<span class="cm"> *  the driver sets host-&gt;wish_block = TRUE for all ISA boards.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">,</span>
                              <span class="n">sector_t</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span>                    <span class="o">=</span> <span class="s">&quot;UltraStor 14F/34F rev. 8.10.00 &quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">detect</span>                  <span class="o">=</span> <span class="n">u14_34f_detect</span><span class="p">,</span>
                <span class="p">.</span><span class="n">release</span>                 <span class="o">=</span> <span class="n">u14_34f_release</span><span class="p">,</span>
                <span class="p">.</span><span class="n">queuecommand</span>            <span class="o">=</span> <span class="n">u14_34f_queuecommand</span><span class="p">,</span>
                <span class="p">.</span><span class="n">eh_abort_handler</span>        <span class="o">=</span> <span class="n">u14_34f_eh_abort</span><span class="p">,</span>
                <span class="p">.</span><span class="n">eh_host_reset_handler</span>   <span class="o">=</span> <span class="n">u14_34f_eh_host_reset</span><span class="p">,</span>
                <span class="p">.</span><span class="n">bios_param</span>              <span class="o">=</span> <span class="n">u14_34f_bios_param</span><span class="p">,</span>
                <span class="p">.</span><span class="n">slave_configure</span>         <span class="o">=</span> <span class="n">u14_34f_slave_configure</span><span class="p">,</span>
                <span class="p">.</span><span class="n">this_id</span>                 <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                <span class="p">.</span><span class="n">unchecked_isa_dma</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">use_clustering</span>          <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
                <span class="p">};</span>

<span class="cp">#if !defined(__BIG_ENDIAN_BITFIELD) &amp;&amp; !defined(__LITTLE_ENDIAN_BITFIELD)</span>
<span class="cp">#error &quot;Adjust your &lt;asm/byteorder.h&gt; defines&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* Values for the PRODUCT_ID ports for the 14/34F */</span>
<span class="cp">#define PRODUCT_ID1  0x56</span>
<span class="cp">#define PRODUCT_ID2  0x40        </span><span class="cm">/* NOTE: Only upper nibble is used */</span><span class="cp"></span>

<span class="cm">/* Subversion values */</span>
<span class="cp">#define ISA  0</span>
<span class="cp">#define ESA 1</span>

<span class="cp">#define OP_HOST_ADAPTER   0x1</span>
<span class="cp">#define OP_SCSI           0x2</span>
<span class="cp">#define OP_RESET          0x4</span>
<span class="cp">#define DTD_SCSI          0x0</span>
<span class="cp">#define DTD_IN            0x1</span>
<span class="cp">#define DTD_OUT           0x2</span>
<span class="cp">#define DTD_NONE          0x3</span>
<span class="cp">#define HA_CMD_INQUIRY    0x1</span>
<span class="cp">#define HA_CMD_SELF_DIAG  0x2</span>
<span class="cp">#define HA_CMD_READ_BUFF  0x3</span>
<span class="cp">#define HA_CMD_WRITE_BUFF 0x4</span>

<span class="cp">#undef  DEBUG_LINKED_COMMANDS</span>
<span class="cp">#undef  DEBUG_DETECT</span>
<span class="cp">#undef  DEBUG_INTERRUPT</span>
<span class="cp">#undef  DEBUG_RESET</span>
<span class="cp">#undef  DEBUG_GENERATE_ERRORS</span>
<span class="cp">#undef  DEBUG_GENERATE_ABORTS</span>
<span class="cp">#undef  DEBUG_GEOMETRY</span>

<span class="cp">#define MAX_ISA 3</span>
<span class="cp">#define MAX_VESA 1</span>
<span class="cp">#define MAX_EISA 0</span>
<span class="cp">#define MAX_PCI 0</span>
<span class="cp">#define MAX_BOARDS (MAX_ISA + MAX_VESA + MAX_EISA + MAX_PCI)</span>
<span class="cp">#define MAX_CHANNEL 1</span>
<span class="cp">#define MAX_LUN 8</span>
<span class="cp">#define MAX_TARGET 8</span>
<span class="cp">#define MAX_MAILBOXES 16</span>
<span class="cp">#define MAX_SGLIST 32</span>
<span class="cp">#define MAX_SAFE_SGLIST 16</span>
<span class="cp">#define MAX_INTERNAL_RETRIES 64</span>
<span class="cp">#define MAX_CMD_PER_LUN 2</span>
<span class="cp">#define MAX_TAGGED_CMD_PER_LUN (MAX_MAILBOXES - MAX_CMD_PER_LUN)</span>

<span class="cp">#define SKIP ULONG_MAX</span>
<span class="cp">#define FALSE 0</span>
<span class="cp">#define TRUE 1</span>
<span class="cp">#define FREE 0</span>
<span class="cp">#define IN_USE   1</span>
<span class="cp">#define LOCKED   2</span>
<span class="cp">#define IN_RESET 3</span>
<span class="cp">#define IGNORE   4</span>
<span class="cp">#define READY    5</span>
<span class="cp">#define ABORTING 6</span>
<span class="cp">#define NO_DMA  0xff</span>
<span class="cp">#define MAXLOOP  10000</span>
<span class="cp">#define TAG_DISABLED 0</span>
<span class="cp">#define TAG_SIMPLE   1</span>
<span class="cp">#define TAG_ORDERED  2</span>

<span class="cp">#define REG_LCL_MASK      0</span>
<span class="cp">#define REG_LCL_INTR      1</span>
<span class="cp">#define REG_SYS_MASK      2</span>
<span class="cp">#define REG_SYS_INTR      3</span>
<span class="cp">#define REG_PRODUCT_ID1   4</span>
<span class="cp">#define REG_PRODUCT_ID2   5</span>
<span class="cp">#define REG_CONFIG1       6</span>
<span class="cp">#define REG_CONFIG2       7</span>
<span class="cp">#define REG_OGM           8</span>
<span class="cp">#define REG_ICM           12</span>
<span class="cp">#define REGION_SIZE       13UL</span>
<span class="cp">#define BSY_ASSERTED      0x01</span>
<span class="cp">#define IRQ_ASSERTED      0x01</span>
<span class="cp">#define CMD_RESET         0xc0</span>
<span class="cp">#define CMD_OGM_INTR      0x01</span>
<span class="cp">#define CMD_CLR_INTR      0x01</span>
<span class="cp">#define CMD_ENA_INTR      0x81</span>
<span class="cp">#define ASOK              0x00</span>
<span class="cp">#define ASST              0x91</span>

<span class="cp">#define YESNO(a) ((a) ? &#39;y&#39; : &#39;n&#39;)</span>
<span class="cp">#define TLDEV(type) ((type) == TYPE_DISK || (type) == TYPE_ROM)</span>

<span class="cp">#define PACKED          __attribute__((packed))</span>

<span class="k">struct</span> <span class="n">sg_list</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">address</span><span class="p">;</span>                <span class="cm">/* Segment Address */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bytes</span><span class="p">;</span>              <span class="cm">/* Segment Length */</span>
   <span class="p">};</span>

<span class="cm">/* MailBox SCSI Command Packet */</span>
<span class="k">struct</span> <span class="n">mscp</span> <span class="p">{</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sg</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">ca</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">dcn</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">xdir</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">opcode</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lun</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">channel</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">target</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opcode</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>             <span class="cm">/* type of command */</span>
                 <span class="nl">xdir:</span> <span class="mi">2</span><span class="p">,</span>               <span class="cm">/* data transfer direction */</span>
                 <span class="nl">dcn:</span> <span class="mi">1</span><span class="p">,</span>                <span class="cm">/* disable disconnect */</span>
                 <span class="nl">ca:</span> <span class="mi">1</span><span class="p">,</span>                 <span class="cm">/* use cache (if available) */</span>
                 <span class="nl">sg:</span> <span class="mi">1</span><span class="p">;</span>                 <span class="cm">/* scatter/gather operation */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>             <span class="cm">/* SCSI target id */</span>
                 <span class="nl">channel:</span> <span class="mi">2</span><span class="p">,</span>            <span class="cm">/* SCSI channel number */</span>
                 <span class="nl">lun:</span> <span class="mi">3</span><span class="p">;</span>                <span class="cm">/* SCSI logical unit number */</span>
<span class="cp">#endif</span>

   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_address</span> <span class="n">PACKED</span><span class="p">;</span>    <span class="cm">/* transfer data pointer */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="n">PACKED</span><span class="p">;</span>        <span class="cm">/* length in bytes */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">link_address</span> <span class="n">PACKED</span><span class="p">;</span>    <span class="cm">/* for linking command chains */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clink_id</span><span class="p">;</span>              <span class="cm">/* identifies command in chain */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">use_sg</span><span class="p">;</span>                <span class="cm">/* (if sg is set) 8 bytes per list */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense_len</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cdb_len</span><span class="p">;</span>               <span class="cm">/* 6, 10, or 12 */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>               <span class="cm">/* SCSI Command Descriptor Block */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">adapter_status</span><span class="p">;</span>        <span class="cm">/* non-zero indicates HA error */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target_status</span><span class="p">;</span>         <span class="cm">/* non-zero indicates target error */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sense_addr</span> <span class="n">PACKED</span><span class="p">;</span>

   <span class="cm">/* Additional fields begin here. */</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpp_index</span><span class="p">;</span>              <span class="cm">/* cp index */</span>

   <span class="cm">/* All the cp structure is zero filled by queuecommand except the</span>
<span class="cm">      following CP_TAIL_SIZE bytes, initialized by detect */</span>
   <span class="n">dma_addr_t</span> <span class="n">cp_dma_addr</span><span class="p">;</span> <span class="cm">/* dma handle for this cp structure */</span>
   <span class="k">struct</span> <span class="n">sg_list</span> <span class="o">*</span><span class="n">sglist</span><span class="p">;</span> <span class="cm">/* pointer to the allocated SG list */</span>
   <span class="p">};</span>

<span class="cp">#define CP_TAIL_SIZE (sizeof(struct sglist *) + sizeof(dma_addr_t))</span>

<span class="k">struct</span> <span class="n">hostdata</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="n">cp</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span>       <span class="cm">/* Mailboxes for this board */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cp_stat</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span> <span class="cm">/* FREE, IN_USE, LOCKED, IN_RESET */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_cp_used</span><span class="p">;</span>           <span class="cm">/* Index of last mailbox used */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iocount</span><span class="p">;</span>                <span class="cm">/* Total i/o done for this board */</span>
   <span class="kt">int</span> <span class="n">board_number</span><span class="p">;</span>                    <span class="cm">/* Number of this board */</span>
   <span class="kt">char</span> <span class="n">board_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>                 <span class="cm">/* Name of this board */</span>
   <span class="kt">int</span> <span class="n">in_reset</span><span class="p">;</span>                        <span class="cm">/* True if board is doing a reset */</span>
   <span class="kt">int</span> <span class="n">target_to</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">][</span><span class="n">MAX_CHANNEL</span><span class="p">];</span> <span class="cm">/* N. of timeout errors on target */</span>
   <span class="kt">int</span> <span class="n">target_redo</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">][</span><span class="n">MAX_CHANNEL</span><span class="p">];</span> <span class="cm">/* If TRUE redo i/o on target */</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>                <span class="cm">/* Number of internal retries */</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_retried_pid</span><span class="p">;</span>      <span class="cm">/* Pid of last retried command */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">subversion</span><span class="p">;</span>            <span class="cm">/* Bus type, either ISA or ESA */</span>
   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>                <span class="cm">/* Always NULL */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">heads</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sectors</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">board_id</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>                  <span class="cm">/* data from INQUIRY on this board */</span>
   <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">[</span><span class="n">MAX_BOARDS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;Ux4F&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">sha</span><span class="p">[</span><span class="n">MAX_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">driver_lock</span><span class="p">);</span>

<span class="cm">/* Initialize num_boards so that ihdlr can work while detect is in progress */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_boards</span> <span class="o">=</span> <span class="n">MAX_BOARDS</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

   <span class="cm">/* Space for MAX_INT_PARAM ports usable while loading as a module */</span>
   <span class="n">SKIP</span><span class="p">,</span>    <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>   <span class="n">SKIP</span><span class="p">,</span>
   <span class="n">SKIP</span><span class="p">,</span>    <span class="n">SKIP</span><span class="p">,</span>

   <span class="cm">/* Possible ISA/VESA ports */</span>
   <span class="mh">0x330</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x230</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x210</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="mh">0x140</span><span class="p">,</span>

   <span class="cm">/* End of list */</span>
   <span class="mh">0x0</span>
   <span class="p">};</span>

<span class="cp">#define HD(board) ((struct hostdata *) &amp;sh[board]-&gt;hostdata)</span>
<span class="cp">#define BN(board) (HD(board)-&gt;board_name)</span>

<span class="cm">/* Device is Little Endian */</span>
<span class="cp">#define H2DEV(x) cpu_to_le32(x)</span>
<span class="cp">#define DEV2H(x) le32_to_cpu(x)</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_interrupt_handler</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_trace</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">link_statistics</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ext_tran</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="cp">#if defined(HAVE_OLD_UX4F_FIRMWARE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">have_old_firmware</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">have_old_firmware</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SCSI_U14_34F_TAGGED_QUEUE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_SIMPLE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_DISABLED</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SCSI_U14_34F_LINKED_COMMANDS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">linked_comm</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">linked_comm</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_SCSI_U14_34F_MAX_TAGS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">CONFIG_SCSI_U14_34F_MAX_TAGS</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_INT_PARAM 10</span>
<span class="cp">#define MAX_BOOT_OPTIONS_SIZE 256</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">boot_options</span><span class="p">[</span><span class="n">MAX_BOOT_OPTIONS_SIZE</span><span class="p">];</span>

<span class="cp">#if defined(MODULE)</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">u14_34f</span><span class="p">,</span> <span class="n">boot_options</span><span class="p">,</span> <span class="n">MAX_BOOT_OPTIONS_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">u14_34f</span><span class="p">,</span> <span class="s">&quot; equivalent to the </span><span class="se">\&quot;</span><span class="s">u14-34f=...</span><span class="se">\&quot;</span><span class="s"> kernel boot &quot;</span> \
<span class="s">&quot;option.&quot;</span> \
<span class="s">&quot;      Example: modprobe u14-34f </span><span class="se">\&quot;</span><span class="s">u14_34f=0x340,0x330,lc:y,tm:0,mq:4</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dario Ballabio&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;UltraStor 14F/34F SCSI Driver&quot;</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u14_34f_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">tqd</span><span class="p">,</span> <span class="n">utqd</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">tag_suffix</span><span class="p">,</span> <span class="o">*</span><span class="n">link_suffix</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

   <span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_number</span><span class="p">;</span>

   <span class="n">utqd</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>
   <span class="n">tqd</span> <span class="o">=</span> <span class="n">max_queue_depth</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">==</span> <span class="n">TAG_SIMPLE</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
         <span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, simple tags&quot;</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">==</span> <span class="n">TAG_ORDERED</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
         <span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, ordered tags&quot;</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
         <span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, no tags&quot;</span><span class="p">;</span>
         <span class="p">}</span>

   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">linked_comm</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tqd</span><span class="p">);</span>
      <span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;, untagged&quot;</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">else</span> <span class="p">{</span>
      <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">utqd</span><span class="p">);</span>
      <span class="n">tag_suffix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;, sorted&quot;</span><span class="p">;</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TLDEV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
      <span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;, unsorted&quot;</span><span class="p">;</span>
   <span class="k">else</span>
      <span class="n">link_suffix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

   <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmds/lun %d%s%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">link_suffix</span><span class="p">,</span> <span class="n">tag_suffix</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_on_busy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">REG_LCL_INTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BSY_ASSERTED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">udelay</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">board_inquiry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="n">dma_addr_t</span> <span class="n">id_dma_addr</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>

   <span class="n">id_dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">,</span>
                    <span class="k">sizeof</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cpp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span>
                                     <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
   <span class="n">memset</span><span class="p">(</span><span class="n">cpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">)</span> <span class="o">-</span> <span class="n">CP_TAIL_SIZE</span><span class="p">);</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_HOST_ADAPTER</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_IN</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">id_dma_addr</span><span class="p">);</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">));</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HA_CMD_INQUIRY</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: board_inquiry, adapter busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IGNORE</span><span class="p">;</span>

   <span class="cm">/* Clear the interrupt indication */</span>
   <span class="n">outb</span><span class="p">(</span><span class="n">CMD_CLR_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_INTR</span><span class="p">);</span>

   <span class="cm">/* Store pointer in OGM address bytes */</span>
   <span class="n">outl</span><span class="p">(</span><span class="n">H2DEV</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">),</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_OGM</span><span class="p">);</span>

   <span class="cm">/* Issue OGM interrupt */</span>
   <span class="n">outb</span><span class="p">(</span><span class="n">CMD_OGM_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_LCL_INTR</span><span class="p">);</span>

   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
   <span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HZ</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">)</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">100L</span><span class="p">);</span>
   <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">||</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: board_inquiry, err 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span>
                    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
   <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">id_dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">),</span>
                    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">port_detect</span> \
      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">,</span> <span class="n">subversion</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in_byte</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">bus_type</span><span class="p">,</span> <span class="n">dma_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

   <span class="cm">/* Allowed BIOS base addresses (NULL indicates reserved) */</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bios_segment_table</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mi">0</span><span class="p">,</span>
      <span class="mh">0xc4000</span><span class="p">,</span> <span class="mh">0xc8000</span><span class="p">,</span> <span class="mh">0xcc000</span><span class="p">,</span> <span class="mh">0xd0000</span><span class="p">,</span>
      <span class="mh">0xd4000</span><span class="p">,</span> <span class="mh">0xd8000</span><span class="p">,</span> <span class="mh">0xdc000</span>
      <span class="p">};</span>

   <span class="cm">/* Allowed IRQs */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">interrupt_table</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span> <span class="p">};</span>

   <span class="cm">/* Allowed DMA channels for ISA (0 indicates reserved) */</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma_channel_table</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

   <span class="cm">/* Head/sector mappings */</span>
   <span class="k">struct</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">heads</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sectors</span><span class="p">;</span>
      <span class="p">}</span> <span class="n">mapping_table</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
           <span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span> <span class="p">}</span>
           <span class="p">};</span>

   <span class="k">struct</span> <span class="n">config_1</span> <span class="p">{</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma_channel</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="nl">removable_disks_as_fixed:</span><span class="mi">1</span><span class="p">,</span> <span class="n">bios_segment</span><span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bios_segment</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">removable_disks_as_fixed</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nl">interrupt:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dma_channel</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>

      <span class="p">}</span> <span class="n">config_1</span><span class="p">;</span>

   <span class="k">struct</span> <span class="n">config_2</span> <span class="p">{</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tfr_port</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bios_drive_number</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nl">mapping_mode:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ha_scsi_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ha_scsi_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mapping_mode</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="nl">bios_drive_number:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tfr_port</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>

      <span class="p">}</span> <span class="n">config_2</span><span class="p">;</span>

   <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

   <span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if defined(DEBUG_DETECT)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: address 0x%03lx in use, skipping probe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">port_base</span><span class="p">);</span>
<span class="cp">#endif</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">REG_PRODUCT_ID1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PRODUCT_ID1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>

   <span class="n">in_byte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">REG_PRODUCT_ID2</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">in_byte</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PRODUCT_ID2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>

   <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config_1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">REG_CONFIG1</span><span class="p">);</span>
   <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">config_2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">REG_CONFIG2</span><span class="p">);</span>

   <span class="n">irq</span> <span class="o">=</span> <span class="n">interrupt_table</span><span class="p">[</span><span class="n">config_1</span><span class="p">.</span><span class="n">interrupt</span><span class="p">];</span>
   <span class="n">dma_channel</span> <span class="o">=</span> <span class="n">dma_channel_table</span><span class="p">[</span><span class="n">config_1</span><span class="p">.</span><span class="n">dma_channel</span><span class="p">];</span>
   <span class="n">subversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

   <span class="cm">/* Board detected, allocate its IRQ */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_interrupt_handler</span><span class="p">,</span>
             <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="p">((</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span><span class="p">)</span> <span class="o">?</span> <span class="n">IRQF_SHARED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
             <span class="n">driver_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate IRQ %u, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">freelock</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span> <span class="o">&amp;&amp;</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate DMA channel %u, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">name</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">freeirq</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">have_old_firmware</span><span class="p">)</span> <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">;</span>

   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsi_register</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span><span class="p">));</span>
   <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to register host, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">freedma</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">port_base</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="n">REGION_SIZE</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">bios_segment_table</span><span class="p">[</span><span class="n">config_1</span><span class="p">.</span><span class="n">bios_segment</span><span class="p">];</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MAX_SGLIST</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">config_2</span><span class="p">.</span><span class="n">ha_scsi_id</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">MAX_MAILBOXES</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG_DETECT)</span>
   <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sys_mask</span><span class="p">,</span> <span class="n">lcl_mask</span><span class="p">;</span>

   <span class="n">sys_mask</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_MASK</span><span class="p">);</span>
   <span class="n">lcl_mask</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_LCL_MASK</span><span class="p">);</span>
   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SYS_MASK 0x%x, LCL_MASK 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sys_mask</span><span class="p">,</span> <span class="n">lcl_mask</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">#endif</span>

   <span class="cm">/* Probably a bogus host scsi id, set it to the dummy value */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

   <span class="cm">/* If BIOS is disabled, force enable interrupts */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">outb</span><span class="p">(</span><span class="n">CMD_ENA_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_MASK</span><span class="p">);</span>

   <span class="n">memset</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostdata</span><span class="p">));</span>
   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">mapping_table</span><span class="p">[</span><span class="n">config_2</span><span class="p">.</span><span class="n">mapping_mode</span><span class="p">].</span><span class="n">heads</span><span class="p">;</span>
   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">mapping_table</span><span class="p">[</span><span class="n">config_2</span><span class="p">.</span><span class="n">mapping_mode</span><span class="p">].</span><span class="n">sectors</span><span class="p">;</span>
   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">subversion</span> <span class="o">=</span> <span class="n">subversion</span><span class="p">;</span>
   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_number</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">have_old_firmware</span><span class="p">)</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MAX_SAFE_SGLIST</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ESA</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">NO_DMA</span><span class="p">;</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s">&quot;U34F%d&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
      <span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;VESA&quot;</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
      <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

      <span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
      <span class="n">disable_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
      <span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
      <span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">,</span> <span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
      <span class="n">enable_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
      <span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

      <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">dma_channel</span><span class="p">;</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s">&quot;U14F%d&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
      <span class="n">bus_type</span> <span class="o">=</span> <span class="s">&quot;ISA&quot;</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">MAX_CHANNEL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">MAX_TARGET</span><span class="p">;</span>
   <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">MAX_LUN</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">board_inquiry</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="s">&quot;06000600&quot;</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: firmware %s is outdated, FW PROM should be 28004-006.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>
         <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">;</span>
         <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MAX_SAFE_SGLIST</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">dma_channel</span> <span class="o">==</span> <span class="n">NO_DMA</span><span class="p">)</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">dma_name</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;BMST&quot;</span><span class="p">);</span>
   <span class="k">else</span>                       <span class="n">sprintf</span><span class="p">(</span><span class="n">dma_name</span><span class="p">,</span> <span class="s">&quot;DMA %u&quot;</span><span class="p">,</span> <span class="n">dma_channel</span><span class="p">);</span>

   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cp_dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">((</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">sglist</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
            <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_list</span><span class="p">),</span>
            <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">?</span> <span class="n">GFP_DMA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: kmalloc SGlist failed, mbox %d, detaching.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
         <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">&gt;</span> <span class="n">MAX_TAGGED_CMD_PER_LUN</span><span class="p">)</span>
       <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_TAGGED_CMD_PER_LUN</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">)</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">MAX_CMD_PER_LUN</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">tag_mode</span> <span class="o">!=</span> <span class="n">TAG_DISABLED</span> <span class="o">&amp;&amp;</span> <span class="n">tag_mode</span> <span class="o">!=</span> <span class="n">TAG_SIMPLE</span><span class="p">)</span>
      <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">TAG_ORDERED</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;UltraStor 14F/34F: Copyright (C) 1994-2003 Dario Ballabio.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s config options -&gt; of:%c, tm:%d, lc:%c, mq:%d, et:%c.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">driver_name</span><span class="p">,</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">have_old_firmware</span><span class="p">),</span> <span class="n">tag_mode</span><span class="p">,</span>
             <span class="n">YESNO</span><span class="p">(</span><span class="n">linked_comm</span><span class="p">),</span> <span class="n">max_queue_depth</span><span class="p">,</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">ext_tran</span><span class="p">));</span>
      <span class="p">}</span>

   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s 0x%03lx, BIOS 0x%05x, IRQ %u, %s, SG %d, MB %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">bus_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
          <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dma_name</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: wide SCSI support enabled, max_id %u, max_lun %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SCSI channel %u enabled, host target ID %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="nl">freedma:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">subversion</span> <span class="o">==</span> <span class="n">ISA</span><span class="p">)</span> <span class="n">free_dma</span><span class="p">(</span><span class="n">dma_channel</span><span class="p">);</span>
<span class="nl">freeirq:</span>
   <span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="nl">freelock:</span>
   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_lock</span><span class="p">);</span>
   <span class="n">release_region</span><span class="p">(</span><span class="n">port_base</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">);</span>
<span class="nl">fail:</span>
   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="nl">release:</span>
   <span class="n">u14_34f_release</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">internal_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">MAX_INT_PARAM</span><span class="p">)</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">MAX_INT_PARAM</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">io_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

      <span class="n">io_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">setup_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*++</span><span class="n">pc</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;Y&#39;</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="k">else</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;lc:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="n">linked_comm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;of:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="n">have_old_firmware</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;tm:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;tc:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="n">tag_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;mq:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;ls:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="n">link_statistics</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s">&quot;et:&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="n">ext_tran</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)))</span> <span class="o">++</span><span class="n">cur</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">option_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="n">MAX_INT_PARAM</span><span class="p">];</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_INT_PARAM</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ints</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">cur</span><span class="o">++</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">internal_setup</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

   <span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;u14-34f&quot;</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">boot_options</span><span class="p">))</span> <span class="n">option_setup</span><span class="p">(</span><span class="n">boot_options</span><span class="p">);</span>

<span class="cp">#if defined(MODULE)</span>
   <span class="cm">/* io_port could have been modified when loading as a module */</span>
   <span class="k">if</span><span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setup_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="n">io_port</span><span class="p">[</span><span class="n">MAX_INT_PARAM</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#endif</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="n">sh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">SKIP</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_BOARDS</span> <span class="o">&amp;&amp;</span> <span class="n">port_detect</span><span class="p">(</span><span class="n">io_port</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">tpnt</span><span class="p">))</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">num_boards</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">map_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">pci_dir</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">)</span>
      <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
                           <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>

   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span> <span class="p">{</span>
	   <span class="n">count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	   <span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	   <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">num_bytes</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		   <span class="n">data_len</span> <span class="o">+=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	   <span class="p">}</span>

	   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">use_sg</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span> <span class="o">=</span>
		   <span class="n">H2DEV</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					<span class="n">cpp</span><span class="o">-&gt;</span><span class="n">use_sg</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_list</span><span class="p">),</span>
					<span class="n">pci_dir</span><span class="p">));</span>
	   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>

   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	   <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>
	   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">H2DEV</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">unmap_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dir</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">))</span>
      <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">),</span>
                       <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

   <span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span> <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">))</span>
      <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">),</span>
                       <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sync_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dir</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">))</span>
      <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_addr</span><span class="p">),</span>
                          <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">))</span>
	   <span class="n">pci_dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span>
				   <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">))</span> <span class="n">pci_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">))</span>
      <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_address</span><span class="p">),</span>
                       <span class="n">DEV2H</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">),</span> <span class="n">pci_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">scsi_to_dev_dir</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_out_cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
      <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
      <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x5d</span>
      <span class="p">};</span>

   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_none_cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
      <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
      <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x00</span>
      <span class="p">};</span>

   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_IN</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_OUT</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_NONE</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">!=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: qcomm, invalid SCpnt-&gt;sc_data_direction.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_IN</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data_out_cmds</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data_out_cmds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
         <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_OUT</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">==</span> <span class="n">DTD_IN</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data_none_cmds</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data_none_cmds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">=</span> <span class="n">DTD_NONE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>

   <span class="cm">/* j is the board number */</span>
   <span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_number</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: qcomm, SCpnt %p already active.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>

   <span class="cm">/* i is the mailbox number, look for the first free mailbox</span>
<span class="cm">      starting from last_cp_used */</span>
   <span class="n">i</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_cp_used</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_cp_used</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: qcomm, no free mailbox.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="cm">/* Set pointer to control packet structure */</span>
   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

   <span class="n">memset</span><span class="p">(</span><span class="n">cpp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">)</span> <span class="o">-</span> <span class="n">CP_TAIL_SIZE</span><span class="p">);</span>
   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cpp_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cpp_index</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: qcomm, mbox %d, target %d.%d:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OP_SCSI</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>
   <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
   <span class="n">memcpy</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

   <span class="cm">/* Use data transfer direction SCpnt-&gt;sc_data_direction */</span>
   <span class="n">scsi_to_dev_dir</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

   <span class="cm">/* Map DMA buffers and SG list */</span>
   <span class="n">map_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span>
                                     <span class="o">&amp;&amp;</span> <span class="n">TLDEV</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">READY</span><span class="p">;</span>
      <span class="n">flush_dev</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
      <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
      		<span class="s">&quot;qcomm, adapter busy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="cm">/* Store pointer in OGM address bytes */</span>
   <span class="n">outl</span><span class="p">(</span><span class="n">H2DEV</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">),</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_OGM</span><span class="p">);</span>

   <span class="cm">/* Issue OGM interrupt */</span>
   <span class="n">outb</span><span class="p">(</span><span class="n">CMD_OGM_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_LCL_INTR</span><span class="p">);</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_USE</span><span class="p">;</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">u14_34f_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCarg</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

   <span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_number</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;abort, command inactive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
   <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;abort, mbox %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, invalid SCarg-&gt;host_scribble.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_USE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span> <span class="o">!=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">)</span>
         <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, SCarg %p, cp SCpnt %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_INTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_ASSERTED</span><span class="p">)</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, interrupt pending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d is locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">READY</span> <span class="o">||</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
      <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
      <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, abort, mbox %d ready, DID_ABORT, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCarg</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: abort, mbox %d, invalid cp_stat.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCarg</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">arg_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="n">j</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">board_number</span><span class="p">;</span>
   <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCarg</span><span class="p">,</span> <span class="s">&quot;reset, enter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCarg</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, inactive.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_reset</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, already in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, locked mbox %d forced free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SCpnt</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">))</span>
         <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, SCpnt == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">READY</span> <span class="o">||</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="p">}</span>

      <span class="k">else</span> <span class="p">{</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_RESET</span><span class="p">;</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
         <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, garbled SCpnt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
         <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, index mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
         <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: reset, mbox %d, SCpnt-&gt;scsi_done == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span> <span class="o">==</span> <span class="n">SCarg</span><span class="p">)</span> <span class="n">arg_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, cannot reset, timeout error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
      <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">outb</span><span class="p">(</span><span class="n">CMD_RESET</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_LCL_INTR</span><span class="p">);</span>
   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, board reset done, enabling interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

<span class="cp">#if defined(DEBUG_RESET)</span>
   <span class="n">do_trace</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="cp">#endif</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_reset</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
   <span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">100L</span><span class="p">);</span>
   <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, interrupts disabled, loops %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">limit</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">;</span>
         <span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
         <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
         <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

         <span class="cm">/* This mailbox is still waiting for its interrupt */</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LOCKED</span><span class="p">;</span>

         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, reset, mbox %d locked, DID_RESET, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="p">}</span>

      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORTING</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SCpnt</span><span class="p">;</span>
         <span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
         <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
         <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

         <span class="cm">/* This mailbox was never queued to the adapter */</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>

         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, reset, mbox %d aborting, DID_RESET, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
         <span class="p">}</span>

      <span class="k">else</span>

         <span class="cm">/* Any other mailbox has already been set free by interrupt */</span>
         <span class="k">continue</span><span class="p">;</span>

      <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
      <span class="p">}</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">in_reset</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="n">do_trace</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">arg_done</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit, done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
   <span class="k">else</span>          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: reset, exit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>

   <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
                 <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dkinfo</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>

   <span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
   <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
   <span class="n">dkinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ext_tran</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scsicam_bios_param</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">dkinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
      <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
      <span class="n">dkinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>

<span class="cp">#if defined (DEBUG_GEOMETRY)</span>
   <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s: bios_param, head=%d, sec=%d, cyl=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span>
           <span class="n">dkinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dkinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="cp">#endif</span>

   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sk</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">da</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
                 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">sk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">sk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
         <span class="n">y</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">da</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">da</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>

   <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reorder</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cursec</span><span class="p">,</span>
                 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ihdlr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">il</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_ready</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_only</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sl</span><span class="p">[</span><span class="n">n_ready</span><span class="p">],</span> <span class="n">pl</span><span class="p">[</span><span class="n">n_ready</span><span class="p">],</span> <span class="n">ll</span><span class="p">[</span><span class="n">n_ready</span><span class="p">];</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minsec</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">,</span> <span class="n">seek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iseek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioseek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flushcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batchcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sortcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readycount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ovlcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readysorted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">revcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seeksorted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seeknosort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">++</span><span class="n">flushcount</span> <span class="o">%</span> <span class="n">link_statistics</span><span class="p">))</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;fc %d bc %d ic %d oc %d rc %d rs %d sc %d re %d&quot;</span>\
             <span class="s">&quot; av %ldK as %ldK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flushcount</span><span class="p">,</span> <span class="n">batchcount</span><span class="p">,</span> <span class="n">inputcount</span><span class="p">,</span>
             <span class="n">ovlcount</span><span class="p">,</span> <span class="n">readycount</span><span class="p">,</span> <span class="n">readysorted</span><span class="p">,</span> <span class="n">sortcount</span><span class="p">,</span> <span class="n">revcount</span><span class="p">,</span>
             <span class="n">seeknosort</span> <span class="o">/</span> <span class="p">(</span><span class="n">readycount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
             <span class="n">seeksorted</span> <span class="o">/</span> <span class="p">(</span><span class="n">readycount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">n_ready</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span> <span class="o">==</span> <span class="n">DTD_IN</span><span class="p">))</span> <span class="n">input_only</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minsec</span><span class="p">)</span>
	 <span class="n">minsec</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsec</span><span class="p">)</span>
	 <span class="n">maxsec</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>

      <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
      <span class="n">ioseek</span> <span class="o">+=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="n">s</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="n">r</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
         <span class="k">else</span>
            <span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
         <span class="p">}</span>

      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="n">seek</span> <span class="o">+=</span> <span class="n">cursec</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">else</span> <span class="n">seek</span> <span class="o">+=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cursec</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">maxsec</span> <span class="o">+</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ioseek</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">maxsec</span> <span class="o">-</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">)))</span> <span class="n">sort</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_only</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
      <span class="n">ll</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span> <span class="n">pl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ll</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
          <span class="o">||</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">ll</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])))</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="n">sort</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cursec</span> <span class="o">&gt;</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="n">iseek</span> <span class="o">=</span> <span class="n">cursec</span> <span class="o">-</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="k">else</span> <span class="n">iseek</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cursec</span><span class="p">;</span>
      <span class="n">batchcount</span><span class="o">++</span><span class="p">;</span> <span class="n">readycount</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">seeknosort</span> <span class="o">+=</span> <span class="n">seek</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">input_only</span><span class="p">)</span> <span class="n">inputcount</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="p">{</span> <span class="n">ovlcount</span><span class="o">++</span><span class="p">;</span> <span class="n">seeksorted</span> <span class="o">+=</span> <span class="n">iseek</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="n">seeksorted</span> <span class="o">+=</span> <span class="p">(</span><span class="n">iseek</span> <span class="o">+</span> <span class="n">maxsec</span> <span class="o">-</span> <span class="n">minsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="p">)</span>     <span class="p">{</span>  <span class="n">revcount</span><span class="o">++</span><span class="p">;</span> <span class="n">readysorted</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="p">)</span>    <span class="p">{</span> <span class="n">sortcount</span><span class="o">++</span><span class="p">;</span> <span class="n">readysorted</span> <span class="o">+=</span> <span class="n">n_ready</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>

<span class="cp">#if defined(DEBUG_LINKED_COMMANDS)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">link_statistics</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">overlap</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">flushcount</span> <span class="o">%</span> <span class="n">link_statistics</span><span class="p">)))</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %d.%d:%d mb %d fc %d nr %d sec %ld ns %u&quot;</span>\
                <span class="s">&quot; cur %ld s:%c r:%c rev:%c in:%c ov:%c xd %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ihdlr</span> <span class="o">?</span> <span class="s">&quot;ihdlr&quot;</span> <span class="o">:</span> <span class="s">&quot;qcomm&quot;</span><span class="p">),</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
                <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">flushcount</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">,</span>
                <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span>
		<span class="n">cursec</span><span class="p">,</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">rev</span><span class="p">),</span> <span class="n">YESNO</span><span class="p">(</span><span class="n">input_only</span><span class="p">),</span>
                <span class="n">YESNO</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">xdir</span><span class="p">);</span>
         <span class="p">}</span>
<span class="cp">#endif</span>
   <span class="k">return</span> <span class="n">overlap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cursec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span>
                      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ihdlr</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">il</span><span class="p">[</span><span class="n">MAX_MAILBOXES</span><span class="p">];</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">READY</span> <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IN_USE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_USE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="n">il</span><span class="p">[</span><span class="n">n_ready</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">reorder</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">cursec</span><span class="p">,</span> <span class="n">ihdlr</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">n_ready</span><span class="p">))</span> <span class="n">n_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_ready</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">il</span><span class="p">[</span><span class="n">n</span><span class="p">];</span> <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
	 	<span class="s">&quot;%s, mbox %d, adapter&quot;</span>
                <span class="s">&quot; busy, will abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ihdlr</span> <span class="o">?</span> <span class="s">&quot;ihdlr&quot;</span> <span class="o">:</span> <span class="s">&quot;qcomm&quot;</span><span class="p">),</span>
                <span class="n">k</span><span class="p">);</span>
         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORTING</span><span class="p">;</span>
         <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

      <span class="n">outl</span><span class="p">(</span><span class="n">H2DEV</span><span class="p">(</span><span class="n">cpp</span><span class="o">-&gt;</span><span class="n">cp_dma_addr</span><span class="p">),</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_OGM</span><span class="p">);</span>
      <span class="n">outb</span><span class="p">(</span><span class="n">CMD_OGM_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_LCL_INTR</span><span class="p">);</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">IN_USE</span><span class="p">;</span>
      <span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ihdlr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">tstatus</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">mscp</span> <span class="o">*</span><span class="n">spp</span><span class="p">,</span> <span class="o">*</span><span class="n">cpp</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

   <span class="cm">/* Check if this board need to be serviced */</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_INTR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">IRQ_ASSERTED</span><span class="p">))</span> <span class="k">goto</span> <span class="n">none</span><span class="p">;</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="o">++</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, enter, irq %d, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">irq</span><span class="p">,</span>
                        <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

   <span class="cm">/* Check if this board is still busy */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">wait_on_busy</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">MAXLOOP</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">outb</span><span class="p">(</span><span class="n">CMD_CLR_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_INTR</span><span class="p">);</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, busy timeout error,  irq %d, reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">irq</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_ICM</span><span class="p">);</span>

   <span class="cm">/* Clear interrupt pending flag */</span>
   <span class="n">outb</span><span class="p">(</span><span class="n">CMD_CLR_INTR</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">REG_SYS_INTR</span><span class="p">);</span>

   <span class="cm">/* Find the mailbox to be serviced on this board */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">H2DEV</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cp_dma_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, invalid mscp bus address %p, cp0 %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">H2DEV</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cp_dma_addr</span><span class="p">));</span>

   <span class="n">cpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
   <span class="n">spp</span> <span class="o">=</span> <span class="n">cpp</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG_GENERATE_ABORTS)</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">%</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
<span class="cp">#endif</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IGNORE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOCKED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d unlocked, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
             <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">FREE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d is free, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
             <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">handled</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IN_RESET</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d is in reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IN_USE</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, invalid cp_stat: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

   <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FREE</span><span class="p">;</span>
   <span class="n">SCpnt</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">-&gt;</span><span class="n">SCpnt</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, SCpnt == NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, SCpnt %p garbled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">SCpnt</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, mbox %d, index mismatch %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">);</span>

   <span class="n">sync_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">linked_comm</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="mi">2</span>
                                     <span class="o">&amp;&amp;</span> <span class="n">TLDEV</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
      <span class="n">flush_dev</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>

   <span class="n">tstatus</span> <span class="o">=</span> <span class="n">status_byte</span><span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG_GENERATE_ERRORS)</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">%</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
                                           <span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#endif</span>

   <span class="k">switch</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ASOK</span>:     <span class="cm">/* status OK */</span>

         <span class="cm">/* Forces a reset if a disk drive keeps returning BUSY */</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">BUSY</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

         <span class="cm">/* If there was a bus reset, redo operation on each target */</span>
         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">!=</span> <span class="n">GOOD</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span>
                  <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)][</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)])</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

         <span class="cm">/* Works around a flaw in scsi.c */</span>
         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span>
                  <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span>
                  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

         <span class="k">else</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">GOOD</span><span class="p">)</span>
            <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)][</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span> <span class="o">&amp;&amp;</span>
             <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tstatus</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span> <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&lt;=</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOT_READY</span><span class="p">)))</span>
            <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span>
	    	<span class="s">&quot;ihdlr, target_status 0x%x, sense key 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">,</span>
                   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

         <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)][</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_retried_pid</span> <span class="o">==</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">)</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

         <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">ASST</span>:     <span class="cm">/* Selection Time Out */</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)][</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
         <span class="k">else</span> <span class="p">{</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_to</span><span class="p">[</span><span class="n">scmd_id</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)][</span><span class="n">scmd_channel</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>

         <span class="k">break</span><span class="p">;</span>

      <span class="cm">/* Perform a limited number of internal retries */</span>
      <span class="k">case</span> <span class="mh">0x93</span>:     <span class="cm">/* Unexpected bus free */</span>
      <span class="k">case</span> <span class="mh">0x94</span>:     <span class="cm">/* Target bus phase sequence failure */</span>
      <span class="k">case</span> <span class="mh">0x96</span>:     <span class="cm">/* Illegal SCSI command */</span>
      <span class="k">case</span> <span class="mh">0xa3</span>:     <span class="cm">/* SCSI bus reset error */</span>

         <span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_channel</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
               <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_redo</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>


      <span class="k">case</span> <span class="mh">0x92</span>:     <span class="cm">/* Data over/under-run */</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span>
             <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">MAX_INTERNAL_RETRIES</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#if defined(DID_SOFT_ERROR)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#else</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#endif</span>

            <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>
            <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_retried_pid</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="k">else</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

         <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mh">0x01</span>:     <span class="cm">/* Invalid command */</span>
      <span class="k">case</span> <span class="mh">0x02</span>:     <span class="cm">/* Invalid parameters */</span>
      <span class="k">case</span> <span class="mh">0x03</span>:     <span class="cm">/* Invalid data list */</span>
      <span class="k">case</span> <span class="mh">0x84</span>:     <span class="cm">/* SCSI bus abort error */</span>
      <span class="k">case</span> <span class="mh">0x9b</span>:     <span class="cm">/* Auto request sense error */</span>
      <span class="k">case</span> <span class="mh">0x9f</span>:     <span class="cm">/* Unexpected command complete message error */</span>
      <span class="k">case</span> <span class="mh">0xff</span>:     <span class="cm">/* Invalid parameter in the S/G list */</span>
      <span class="nl">default:</span>
         <span class="n">status</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">status</span> <span class="o">|</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>

<span class="cp">#if defined(DEBUG_INTERRUPT)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">||</span> <span class="n">do_trace</span><span class="p">)</span>
<span class="cp">#else</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASOK</span> <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&gt;</span>  <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span>
       <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASOK</span> <span class="o">&amp;&amp;</span>
        <span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">!=</span> <span class="n">ASST</span> <span class="o">&amp;&amp;</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">do_trace</span> <span class="o">||</span> <span class="n">msg_byte</span><span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">))</span>
<span class="cp">#endif</span>
      <span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="s">&quot;ihdlr, mbox %2d, err 0x%x:%x,&quot;</span>\
             <span class="s">&quot; reg 0x%x, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">i</span><span class="p">,</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">,</span> <span class="n">spp</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">,</span>
             <span class="n">reg</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

   <span class="n">unmap_dma</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

   <span class="cm">/* Set the command state to inactive */</span>
   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">do_trace</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ihdlr, exit, irq %d, count %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BN</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">irq</span><span class="p">,</span>
                        <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocount</span><span class="p">);</span>

<span class="nl">handled:</span>
   <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="nl">none:</span>
   <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shap</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spin_flags</span><span class="p">;</span>
   <span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

   <span class="cm">/* Check if the interrupt must be processed by this handler */</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">shap</span> <span class="o">-</span> <span class="n">sha</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">num_boards</span><span class="p">)</span> <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

   <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">ihdlr</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
   <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">spin_flags</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">u14_34f_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shpnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: release, invalid Scsi_Host pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">kfree</span><span class="p">((</span><span class="o">&amp;</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">HD</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cp_dma_addr</span><span class="p">,</span>
                     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mscp</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

   <span class="n">free_irq</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sha</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">!=</span> <span class="n">NO_DMA</span><span class="p">)</span>
      <span class="n">free_dma</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>

   <span class="n">release_region</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>
   <span class="n">scsi_unregister</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="cp">#ifndef MODULE</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;u14-34f=&quot;</span><span class="p">,</span> <span class="n">option_setup</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* end MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
