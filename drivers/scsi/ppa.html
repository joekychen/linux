<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › ppa.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ppa.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*  Driver for the PPA3 parallel port SCSI HBA embedded in </span>
<span class="cm"> * the Iomega ZIP drive</span>
<span class="cm"> * </span>
<span class="cm"> * (c) 1996     Grant R. Guenther  grant@torque.net</span>
<span class="cm"> *              David Campbell</span>
<span class="cm"> *</span>
<span class="cm"> *      All comments to David.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _PPA_H</span>
<span class="cp">#define _PPA_H</span>

<span class="cp">#define   PPA_VERSION   &quot;2.07 (for Linux 2.4.x)&quot;</span>

<span class="cm">/* </span>
<span class="cm"> * this driver has been hacked by Matteo Frigo (athena@theory.lcs.mit.edu)</span>
<span class="cm"> * to support EPP and scatter-gather.                        [0.26-athena]</span>
<span class="cm"> *</span>
<span class="cm"> * additional hacks by David Campbell</span>
<span class="cm"> * in response to this driver &quot;mis-behaving&quot; on his machine.</span>
<span class="cm"> *      Fixed EPP to handle &quot;software&quot; changing of EPP port data direction.</span>
<span class="cm"> *      Chased down EPP timeouts</span>
<span class="cm"> *      Made this driver &quot;kernel version friendly&quot;           [0.28-athena]</span>
<span class="cm"> *</span>
<span class="cm"> * [ Stuff removed ]</span>
<span class="cm"> *</span>
<span class="cm"> * Corrected ppa.h for 2.1.x kernels (&gt;=2.1.85)</span>
<span class="cm"> * Modified &quot;Nat Semi Kludge&quot; for extended chipsets</span>
<span class="cm"> *                                                      [1.41]</span>
<span class="cm"> *</span>
<span class="cm"> * Fixed id_probe for EPP 1.9 chipsets (misdetected as EPP 1.7)</span>
<span class="cm"> *                                                      [1.42]</span>
<span class="cm"> *</span>
<span class="cm"> * Development solely for 2.1.x kernels from now on!</span>
<span class="cm"> *                                                      [2.00]</span>
<span class="cm"> *</span>
<span class="cm"> * Hack and slash at the init code (EPP device check routine)</span>
<span class="cm"> * Added INSANE option.</span>
<span class="cm"> *                                                      [2.01]</span>
<span class="cm"> *</span>
<span class="cm"> * Patch applied to sync against the 2.1.x kernel code</span>
<span class="cm"> * Included qboot_zip.sh</span>
<span class="cm"> *                                                      [2.02]</span>
<span class="cm"> *</span>
<span class="cm"> * Cleaned up the mess left by someone else trying to fix the</span>
<span class="cm"> * asm section to keep egcc happy. The asm section no longer</span>
<span class="cm"> * exists, the nibble code is *almost* as fast as the asm code</span>
<span class="cm"> * providing it is compiled with egcc.</span>
<span class="cm"> *</span>
<span class="cm"> * Other clean ups include the follow changes:</span>
<span class="cm"> *    CONFIG_SCSI_PPA_HAVE_PEDANTIC =&gt; CONFIG_SCSI_IZIP_EPP16</span>
<span class="cm"> *    added CONFIG_SCSI_IZIP_SLOW_CTR option</span>
<span class="cm"> *                                                      [2.03]</span>
<span class="cm"> *</span>
<span class="cm"> * Use ppa_wait() to check for ready AND connected status bits</span>
<span class="cm"> * Add ppa_wait() calls to ppa_completion()</span>
<span class="cm"> *  by Peter Cherriman &lt;pjc@ecs.soton.ac.uk&gt; and</span>
<span class="cm"> *     Tim Waugh &lt;twaugh@redhat.com&gt;</span>
<span class="cm"> *							[2.04]</span>
<span class="cm"> *</span>
<span class="cm"> * Fix kernel panic on scsi timeout, 2000-08-18		[2.05]</span>
<span class="cm"> *</span>
<span class="cm"> * Avoid io_request_lock problems.</span>
<span class="cm"> * John Cavan &lt;johncavan@home.com&gt;			[2.06]</span>
<span class="cm"> *</span>
<span class="cm"> * Busy wait for connected status bit in ppa_completion()</span>
<span class="cm"> *  in order to cope with some hardware that has this bit low</span>
<span class="cm"> *  for short periods of time.</span>
<span class="cm"> * Add udelay() to ppa_select()</span>
<span class="cm"> *  by Peter Cherriman &lt;pjc@ecs.soton.ac.uk&gt; and</span>
<span class="cm"> *     Oleg Makarenko &lt;omakarenko@cyberplat.ru&gt;         </span>
<span class="cm"> *                                                      [2.07]</span>
<span class="cm"> */</span>
<span class="cm">/* ------ END OF USER CONFIGURABLE PARAMETERS ----- */</span>

<span class="cp">#include  &lt;linux/stddef.h&gt;</span>
<span class="cp">#include  &lt;linux/module.h&gt;</span>
<span class="cp">#include  &lt;linux/kernel.h&gt;</span>
<span class="cp">#include  &lt;linux/ioport.h&gt;</span>
<span class="cp">#include  &lt;linux/delay.h&gt;</span>
<span class="cp">#include  &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include  &lt;linux/stat.h&gt;</span>
<span class="cp">#include  &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include  &lt;linux/sched.h&gt;</span>
<span class="cp">#include  &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include  &lt;asm/io.h&gt;</span>
<span class="cp">#include  &lt;scsi/scsi_host.h&gt;</span>
<span class="cm">/* batteries not included :-) */</span>

<span class="cm">/*</span>
<span class="cm"> * modes in which the driver can operate </span>
<span class="cm"> */</span>
<span class="cp">#define   PPA_AUTODETECT        0	</span><span class="cm">/* Autodetect mode                */</span><span class="cp"></span>
<span class="cp">#define   PPA_NIBBLE            1	</span><span class="cm">/* work in standard 4 bit mode    */</span><span class="cp"></span>
<span class="cp">#define   PPA_PS2               2	</span><span class="cm">/* PS/2 byte mode         */</span><span class="cp"></span>
<span class="cp">#define   PPA_EPP_8             3	</span><span class="cm">/* EPP mode, 8 bit                */</span><span class="cp"></span>
<span class="cp">#define   PPA_EPP_16            4	</span><span class="cm">/* EPP mode, 16 bit               */</span><span class="cp"></span>
<span class="cp">#define   PPA_EPP_32            5	</span><span class="cm">/* EPP mode, 32 bit               */</span><span class="cp"></span>
<span class="cp">#define   PPA_UNKNOWN           6	</span><span class="cm">/* Just in case...                */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">PPA_MODE_STRING</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="s">&quot;Autodetect&quot;</span><span class="p">,</span>
    <span class="s">&quot;SPP&quot;</span><span class="p">,</span>
    <span class="s">&quot;PS/2&quot;</span><span class="p">,</span>
    <span class="s">&quot;EPP 8 bit&quot;</span><span class="p">,</span>
    <span class="s">&quot;EPP 16 bit&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SCSI_IZIP_EPP16</span>
    <span class="s">&quot;EPP 16 bit&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
    <span class="s">&quot;EPP 32 bit&quot;</span><span class="p">,</span>
<span class="cp">#endif</span>
    <span class="s">&quot;Unknown&quot;</span><span class="p">};</span>

<span class="cm">/* other options */</span>
<span class="cp">#define PPA_BURST_SIZE	512	</span><span class="cm">/* data burst size */</span><span class="cp"></span>
<span class="cp">#define PPA_SELECT_TMO  5000	</span><span class="cm">/* how long to wait for target ? */</span><span class="cp"></span>
<span class="cp">#define PPA_SPIN_TMO    50000	</span><span class="cm">/* ppa_wait loop limiter */</span><span class="cp"></span>
<span class="cp">#define PPA_RECON_TMO   500	</span><span class="cm">/* scsi reconnection loop limiter */</span><span class="cp"></span>
<span class="cp">#define PPA_DEBUG	0	</span><span class="cm">/* debugging option */</span><span class="cp"></span>
<span class="cp">#define IN_EPP_MODE(x) (x == PPA_EPP_8 || x == PPA_EPP_16 || x == PPA_EPP_32)</span>

<span class="cm">/* args to ppa_connect */</span>
<span class="cp">#define CONNECT_EPP_MAYBE 1</span>
<span class="cp">#define CONNECT_NORMAL  0</span>

<span class="cp">#define r_dtr(x)        (unsigned char)inb((x))</span>
<span class="cp">#define r_str(x)        (unsigned char)inb((x)+1)</span>
<span class="cp">#define r_ctr(x)        (unsigned char)inb((x)+2)</span>
<span class="cp">#define r_epp(x)        (unsigned char)inb((x)+4)</span>
<span class="cp">#define r_fifo(x)       (unsigned char)inb((x)) </span><span class="cm">/* x must be base_hi */</span><span class="cp"></span>
					<span class="cm">/* On PCI is base+0x400 != base_hi */</span>
<span class="cp">#define r_ecr(x)        (unsigned char)inb((x)+0x2) </span><span class="cm">/* x must be base_hi */</span><span class="cp"></span>

<span class="cp">#define w_dtr(x,y)      outb(y, (x))</span>
<span class="cp">#define w_str(x,y)      outb(y, (x)+1)</span>
<span class="cp">#define w_epp(x,y)      outb(y, (x)+4)</span>
<span class="cp">#define w_fifo(x,y)     outb(y, (x))	</span><span class="cm">/* x must be base_hi */</span><span class="cp"></span>
<span class="cp">#define w_ecr(x,y)      outb(y, (x)+0x2)</span><span class="cm">/* x must be base_hi */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SCSI_IZIP_SLOW_CTR</span>
<span class="cp">#define w_ctr(x,y)      outb_p(y, (x)+2)</span>
<span class="cp">#else</span>
<span class="cp">#define w_ctr(x,y)      outb(y, (x)+2)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ppa_engine</span><span class="p">(</span><span class="n">ppa_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* _PPA_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
