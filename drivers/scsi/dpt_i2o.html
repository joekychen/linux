<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › dpt_i2o.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dpt_i2o.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************</span>
<span class="cm">                          dpti.c  -  description</span>
<span class="cm">                             -------------------</span>
<span class="cm">    begin                : Thu Sep 7 2000</span>
<span class="cm">    copyright            : (C) 2000 by Adaptec</span>

<span class="cm">			   July 30, 2001 First version being submitted</span>
<span class="cm">			   for inclusion in the kernel.  V2.4</span>

<span class="cm">    See Documentation/scsi/dpti.txt for history, notes, license info</span>
<span class="cm">    and credits</span>
<span class="cm"> ***************************************************************************/</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify  *</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by  *</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<span class="cm"> *   (at your option) any later version.                                   *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> ***************************************************************************/</span>
<span class="cm">/***************************************************************************</span>
<span class="cm"> * Sat Dec 20 2003 Go Taniguchi &lt;go@turbolinux.co.jp&gt;</span>
<span class="cm"> - Support 2.6 kernel and DMA-mapping</span>
<span class="cm"> - ioctl fix for raid tools</span>
<span class="cm"> - use schedule_timeout in long long loop</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*#define DEBUG 1 */</span>
<span class="cm">/*#define UARTDELAY 1 */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Deanna Bonds, with _lots_ of help from Mark Salyzyn&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Adaptec I2O RAID Driver&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>//////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/ioctl.h&gt;	</span><span class="cm">/* For SCSI-Passthrough */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;		</span><span class="cm">/* for kmalloc() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/pci.h&gt;		</span><span class="cm">/* for PCI support */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for udelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;	</span><span class="cm">/* for printk */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;	</span><span class="cm">/* for boot_cpu_data */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;		</span><span class="cm">/* for virt_to_bus, etc. */</span><span class="cp"></span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="cp">#include &quot;dpt/dptsig.h&quot;</span>
<span class="cp">#include &quot;dpti.h&quot;</span>

<span class="cm">/*============================================================================</span>
<span class="cm"> * Create a binary signature - this is read by dptsig</span>
<span class="cm"> * Needed for our management apps</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">adpt_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">dpt_sig_S</span> <span class="n">DPTI_sig</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">},</span> <span class="n">SIG_VERSION</span><span class="p">,</span>
<span class="cp">#ifdef __i386__</span>
	<span class="n">PROC_INTEL</span><span class="p">,</span> <span class="n">PROC_386</span> <span class="o">|</span> <span class="n">PROC_486</span> <span class="o">|</span> <span class="n">PROC_PENTIUM</span> <span class="o">|</span> <span class="n">PROC_SEXIUM</span><span class="p">,</span>
<span class="cp">#elif defined(__ia64__)</span>
	<span class="n">PROC_INTEL</span><span class="p">,</span> <span class="n">PROC_IA64</span><span class="p">,</span>
<span class="cp">#elif defined(__sparc__)</span>
	<span class="n">PROC_ULTRASPARC</span><span class="p">,</span> <span class="n">PROC_ULTRASPARC</span><span class="p">,</span>
<span class="cp">#elif defined(__alpha__)</span>
	<span class="n">PROC_ALPHA</span><span class="p">,</span> <span class="n">PROC_ALPHA</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<span class="cp">#endif</span>
	 <span class="n">FT_HBADRVR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OEM_DPT</span><span class="p">,</span> <span class="n">OS_LINUX</span><span class="p">,</span> <span class="n">CAP_OVERLAP</span><span class="p">,</span> <span class="n">DEV_ALL</span><span class="p">,</span>
	<span class="n">ADF_ALL_SC5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DPT_VERSION</span><span class="p">,</span> <span class="n">DPT_REVISION</span><span class="p">,</span> <span class="n">DPT_SUBREVISION</span><span class="p">,</span>
	<span class="n">DPT_MONTH</span><span class="p">,</span> <span class="n">DPT_DAY</span><span class="p">,</span> <span class="n">DPT_YEAR</span><span class="p">,</span> <span class="s">&quot;Adaptec Linux I2O RAID Driver&quot;</span>
<span class="p">};</span>




<span class="cm">/*============================================================================</span>
<span class="cm"> * Globals</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2o_sys_tbl</span> <span class="o">*</span><span class="n">sys_tbl</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="n">sys_tbl_pa</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sys_tbl_ind</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sys_tbl_len</span><span class="p">;</span>

<span class="k">static</span> <span class="n">adpt_hba</span><span class="o">*</span> <span class="n">hba_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hba_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">adpt_sysfs_class</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">adpt_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">compat_adpt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">adpt_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">adpt_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">adpt_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">adpt_close</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">compat_adpt_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Structures and definitions for synchronous message posting.</span>
<span class="cm"> * See adpt_i2o_post_wait() for description</span>
<span class="cm"> * */</span>
<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">adpt_wait_queue_head_t</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">adpt_post_wait_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">adpt_post_wait_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">adpt_post_wait_lock</span><span class="p">);</span>


<span class="cm">/*============================================================================</span>
<span class="cm"> * 				Functions</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dpt_dma64</span><span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span><span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pHba</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dma_high</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">dma_low</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">adpt_read_blink_led</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDflag_P</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDflag_P</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xbc</span> <span class="p">){</span>
			<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDvalue_P</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================</span>
<span class="cm"> * Scsi host template interface functions</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">dptids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DPT_VENDOR_ID</span><span class="p">,</span> <span class="n">PCI_DPT_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span> <span class="n">PCI_DPT_VENDOR_ID</span><span class="p">,</span> <span class="n">PCI_DPT_RAPTOR_DEVICE_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="n">dptids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span><span class="o">*</span> <span class="n">sht</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pDev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adpt_hba</span> <span class="o">*</span><span class="n">pHba</span><span class="p">;</span>
	<span class="n">adpt_hba</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">PINFO</span><span class="p">(</span><span class="s">&quot;Detecting Adaptec I2O RAID controllers...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="cm">/* search for all Adatpec I2O RAID cards */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">pDev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span> <span class="n">PCI_DPT_VENDOR_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">pDev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DPT_DEVICE_ID</span> <span class="o">||</span>
		   <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DPT_RAPTOR_DEVICE_ID</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">adpt_install_hba</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="n">pDev</span><span class="p">)</span> <span class="p">){</span>
				<span class="n">PERROR</span><span class="p">(</span><span class="s">&quot;Could not Init an I2O RAID device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">PERROR</span><span class="p">(</span><span class="s">&quot;Will not try to detect others.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">hba_count</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* In INIT state, Activate IOPs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Activate does get status , init outbound, and get hrt</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_activate_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* Active IOPs in HOLD state */</span>

<span class="nl">rebuild_sys_tab:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba_chain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If build_sys_table fails, we kill everything and bail</span>
<span class="cm">	 * as we can&#39;t init the IOPs w/o a system table</span>
<span class="cm">	 */</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_build_sys_table</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_i2o_sys_shutdown</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;HBA&#39;s in HOLD state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If IOP don&#39;t get online, we need to rebuild the System table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_online_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>	
			<span class="k">goto</span> <span class="n">rebuild_sys_tab</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Active IOPs now in OPERATIONAL state */</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;HBA&#39;s in OPERATIONAL state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dpti: If you have a lot of devices this could take a few minutes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Reading the hardware resource table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_lct_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_parse_lct</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adpt_inquiry</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adpt_sysfs_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;dpt_i2o&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;dpti: unable to create dpt_i2o class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adpt_sysfs_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_scsi_host_alloc</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">sht</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPTI_STATE_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">DPTI_I2O_MAJOR</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="s">&quot;dpti%d&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;dpti%d: unable to &quot;</span>
					<span class="s">&quot;create device in dpt_i2o class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Register our control device node
nodes will need to be created in /dev to access this
the nodes can not be created from within the driver</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">hba_count</span> <span class="o">&amp;&amp;</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="n">DPTI_I2O_MAJOR</span><span class="p">,</span> <span class="n">DPT_DRIVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adpt_fops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adpt_i2o_sys_shutdown</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">hba_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * scsi_unregister will be called AFTER we return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>adpt<em>i2o</em>quiesce_hba(pHba);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="n">scsi_unregister</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_inquiry</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span> 
	<span class="n">u32</span> <span class="o">*</span><span class="n">mptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">lenptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scsidir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reqlen</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">scb</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s: Could not allocate buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>
	
	<span class="n">len</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="n">direction</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>	
	<span class="n">scsidir</span>  <span class="o">=</span><span class="mh">0x40000000</span><span class="p">;</span>	<span class="c1">// DATA IN  (iop&lt;--dev)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpt_dma64</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>		<span class="c1">// SINGLE SGE, 64 bit</span>
	<span class="k">else</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>		<span class="c1">// SINGLE SGE, 32 bit</span>
	<span class="cm">/* Stick the headers on */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reqlen</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">SGL_OFFSET_12</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xff</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">ADAPTER_TID</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Adaptec/DPT Private stuff </p></td><td class="code"><div class="highlight"><pre>	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_SCSI_EXEC</span><span class="o">|</span><span class="n">DPT_ORGANIZATION_ID</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ADAPTER_TID</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="cm">/* Interpret*/</span><span class="p">;</span>
	<span class="cm">/* Direction, disconnect ok | sense data | simple queue , CDBLen */</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>I2O<em>SCB</em>FLAG<em>ENABLE</em>DISCONNECT | 
I2O<em>SCB</em>FLAG<em>SIMPLE</em>QUEUE<em>TAG | 
I2O</em>SCB<em>FLAG</em>SENSE<em>DATA</em>IN_MESSAGE;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsidir</span><span class="o">|</span><span class="mh">0x20a00000</span><span class="o">|</span> <span class="mi">6</span> <span class="cm">/* cmd len*/</span><span class="p">;</span>

	<span class="n">mptr</span><span class="o">=</span><span class="n">msg</span><span class="o">+</span><span class="mi">7</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Write SCSI command into the message - always 16 byte block </p></td><td class="code"><div class="highlight"><pre>	<span class="n">scb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INQUIRY</span><span class="p">;</span>
	<span class="n">scb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="n">scb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Don't care about the rest of scb</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="n">mptr</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scb</span><span class="p">));</span>
	<span class="n">mptr</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">lenptr</span><span class="o">=</span><span class="n">mptr</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* Remember me - fill in when we know */</span>

	<span class="cm">/* Now fill in the SGList and command */</span>
	<span class="o">*</span><span class="n">lenptr</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpt_dma64</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7C</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Enable 64 bit */</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xD0000000</span><span class="o">|</span><span class="n">direction</span><span class="o">|</span><span class="n">len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dma_low</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dma_high</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xD0000000</span><span class="o">|</span><span class="n">direction</span><span class="o">|</span><span class="n">len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Send it on it's way</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reqlen</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">,</span> <span class="s">&quot;Adaptec I2O RAID&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Inquiry Error (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">rcode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIME</span> <span class="o">&amp;&amp;</span> <span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">),</span> <span class="s">&quot;Vendor: Adaptec &quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">[</span><span class="mi">16</span><span class="p">]),</span> <span class="s">&quot; Model: &quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">[</span><span class="mi">24</span><span class="p">]),</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">[</span><span class="mi">40</span><span class="p">]),</span> <span class="s">&quot; FW: &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">[</span><span class="mi">44</span><span class="p">]),</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/* precautionary */</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">pDev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* dpt per device information */</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * SCSI REQUEST_SENSE commands will be executed automatically by the </span>
<span class="cm">	 * Host Adapter for any errors, so they should not be executed </span>
<span class="cm">	 * explicitly unless the Sense Data is zero indicating that no error </span>
<span class="cm">	 * occurred.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHba</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * TODO: I need to block here if I am processing ioctl cmds</span>
<span class="cm">	 * but if the outstanding cmds all finish before the ioctl,</span>
<span class="cm">	 * the scsi-core will not know to start sending cmds to me again.</span>
<span class="cm">	 * I need to a way to restart the scsi-cores queues or should I block</span>
<span class="cm">	 * calling scsi_done on the outstanding cmds instead</span>
<span class="cm">	 * for now we don&#39;t set the IOCTL state</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPTI_STATE_IOCTL</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPTI_STATE_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">resetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>TODO if the cmd->device if offline then I may need to issue a bus rescan
followed by a get_lct to see if the device is there anymore</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">pDev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * First command request for this device.  Set up a pointer</span>
<span class="cm">		 * to the device structure.  This should be a TEST_UNIT_READY</span>
<span class="cm">		 * command from scan_scsis_single.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pDev</span> <span class="o">=</span> <span class="n">adpt_find_device</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>TODO: if any luns are at this bus, scsi id then fake a TEST<em>UNIT</em>READY and INQUIRY response 
with type 7F (for all luns less than the max for this bus,id) so the lun scan will continue.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are being called from when the device is being reset, </span>
<span class="cm">	 * delay processing of the command until later.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DPTI_DEV_RESET</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">adpt_scsi_to_i2o</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">pDev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">adpt_queue</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">adpt_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sectors</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cylinders</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p><strong>* First lets set the default geometry **</strong></p></td><td class="code"><div class="highlight"><pre>	</pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>If the capacity is less than ox2000</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&lt;</span> <span class="mh">0x2000</span> <span class="p">)</span> <span class="p">{</span>	<span class="c1">// floppy</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> </pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>else if between 0x2000 and 0x20000</p></td><td class="code"><div class="highlight"><pre>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&lt;</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>else if between 0x20000 and 0x40000</p></td><td class="code"><div class="highlight"><pre>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&lt;</span> <span class="mh">0x40000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>else if between 0x4000 and 0x80000</p></td><td class="code"><div class="highlight"><pre>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&lt;</span> <span class="mh">0x80000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>else if greater than 0x80000</p></td><td class="code"><div class="highlight"><pre>	<span class="k">else</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Special case if CDROM</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// CDROM</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">252</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="mi">1111</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>
	
	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;adpt_bios_param: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">adpt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inout</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The user has done a write and wants us to take the</span>
<span class="cm">		 * data in the buffer and do something with it.</span>
<span class="cm">		 * proc_scsiwrite calls us with inout = 1</span>
<span class="cm">		 *</span>
<span class="cm">		 * Read data from buffer (writing to us) - NOT SUPPORTED</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * inout = 0 means the user has done a read and wants information</span>
<span class="cm">	 * returned, so we write information about the cards into the buffer</span>
<span class="cm">	 * proc_scsiread() calls us with inout = 0</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Find HBA (host bus adapter) we are looking for</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">==</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* found adapter */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="n">len</span>  <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span>    <span class="p">,</span> <span class="s">&quot;Adaptec I2O RAID Driver Version: %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DPT_I2O_VERSION</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">detail</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SCSI Host=scsi%d  Control Node=/dev/%s  irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">post fifo size  = %d</span><span class="se">\n\t</span><span class="s">reply fifo size = %d</span><span class="se">\n\t</span><span class="s">sg table size   = %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* CHECKPOINT */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">stop_output</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we haven&#39;t even written to where we last left</span>
<span class="cm">		 * off (the last time we were called), reset the </span>
<span class="cm">		 * beginning pointer.</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span>  <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Devices:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNEL</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">MAX_ID</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
			<span class="k">while</span><span class="p">(</span><span class="n">d</span><span class="p">){</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">%-24.24s&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot; Rev: %-8.8s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
				<span class="n">pos</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>


				<span class="cm">/* CHECKPOINT */</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">stop_output</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">begin</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">unit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">pI2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">TID=%d, (Channel=%d, Target=%d, Lun=%d)  (%s)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">unit</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">scsi_channel</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">scsi_lun</span><span class="p">,</span>
					       <span class="n">scsi_device_online</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;online&quot;</span><span class="o">:</span><span class="s">&quot;offline&quot;</span><span class="p">);</span> 
				<span class="n">pos</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

				<span class="cm">/* CHECKPOINT */</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">stop_output</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">begin</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * begin is where we last checked our position with regards to offset</span>
<span class="cm">	 * begin is always less than offset.  len is relative to begin.  It</span>
<span class="cm">	 * is the number of bytes written past begin</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
<span class="nl">stop_output:</span>
	<span class="cm">/* stop the output and calculate the correct length */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>	<span class="cm">/* Start of wanted data */</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">**</span><span class="n">start</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Turn a struct scsi_cmnd * into a unique 32 bit &#39;context&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">adpt_cmd_to_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Go from a u32 &#39;context&#39; to a struct scsi_cmnd * .</span>
<span class="cm"> *	This could probably be made more efficient.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span>
	<span class="nf">adpt_cmd_from_context</span><span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">==</span> <span class="n">context</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Turn a pointer to ioctl reply data into an u32 &#39;context&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">adpt_ioctl_to_context</span><span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">ioctl_reply_context</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">ioctl_reply_context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">ioctl_reply_context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Too many outstanding &quot;</span>
				<span class="s">&quot;ioctl commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Go from an u32 &#39;context&#39; to a pointer to ioctl reply data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">adpt_ioctl_from_context</span><span class="p">(</span><span class="n">adpt_hba</span> <span class="o">*</span><span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">ioctl_reply_context</span><span class="p">[</span><span class="n">context</span><span class="p">];</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">ioctl_reply_context</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================</span>
<span class="cm"> * Error Handling routines</span>
<span class="cm"> *===========================================================================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* host bus adapter structure */</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">dptdevice</span><span class="p">;</span>	<span class="cm">/* dpt per device information */</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Trying to Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dptdevice</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to abort: No device in cmnd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIVE_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_SCSI_ABORT</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">dptdevice</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">adpt_cmd_to_context</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">FOREVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span> <span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Abort cmd not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Abort failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Abort complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define I2O_DEVICE_RESET 0x27</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>This is the same for BLK and SCSI devices
NOTE this is wrong in the i2o.h definitions
This is not currently supported by our adapter but we issue it anyway</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Trying to reset device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Reset Device: Device Not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FOUR_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I2O_DEVICE_RESET</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">old_state</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DPTI_DEV_RESET</span><span class="p">;</span>
	<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">FOREVER</span><span class="p">);</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span> <span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Device reset not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Device reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;%s: Device reset successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#define I2O_HBA_BUS_RESET 0x87</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>This version of bus reset is called by the eh_error handler</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Bus reset: SCSI Bus %d: tid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">].</span><span class="n">tid</span> <span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FOUR_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I2O_HBA_BUS_RESET</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">].</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">FOREVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Bus reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Bus reset success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>This version of reset is called by the eh<em>error</em>handler</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">__adpt_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Hba Reset: scsi id %d: tid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">].</span><span class="n">tid</span> <span class="p">);</span>
	<span class="n">rcode</span> <span class="o">=</span>  <span class="n">adpt_hba_reset</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: HBA reset complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: HBA reset failed (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rcode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__adpt_reset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>This version of reset is called by the ioctls and indirectly from eh<em>error</em>handler via adpt_reset</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_hba_reset</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DPTI_STATE_RESET</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Activate does get status , init outbound, and get hrt</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_activate_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Could not activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_build_sys_table</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: in HOLD state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_online_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>	
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: in OPERATIONAL state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_lct_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_reparse_lct</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPTI_STATE_RESET</span><span class="p">;</span>

	<span class="n">adpt_fail_posted_scbs</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* return success */</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================</span>
<span class="cm"> * </span>
<span class="cm"> *===========================================================================</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_i2o_sys_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span> <span class="o">*</span><span class="n">pHba</span><span class="p">,</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>

	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Shutting down Adaptec I2O controllers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;   This could take a few minutes if there are many devices attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Delete all IOPs from the controller chain */</span>
	<span class="cm">/* They should have already been released by the</span>
<span class="cm">	 * scsi-core</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pNext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pNext</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Remove any timedout entries from the wait queue.  */</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>spin<em>lock</em>irqsave(&amp;adpt<em>post</em>wait_lock, flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Nothing should be outstanding at this point so just</span>
<span class="cm">	 * free them </span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">p1</span> <span class="o">=</span> <span class="n">adpt_post_wait_queue</span><span class="p">;</span> <span class="n">p1</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
		<span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>spin<em>unlock</em>irqrestore(&amp;adpt<em>post</em>wait_lock, flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">adpt_post_wait_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Adaptec I2O controllers down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_install_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span><span class="o">*</span> <span class="n">sht</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pDev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">base_addr0_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">base_addr1_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hba_map1_area_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg_addr_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">raptorFlag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pDev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="s">&quot;dpt_i2o&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PERROR</span><span class="p">(</span><span class="s">&quot;dpti: adpt_config_hba: pci request region failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	See if we should enable dma64 mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_get_required_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
			<span class="n">dma64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma64</span> <span class="o">&amp;&amp;</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* adapter only supports message blocks below 4GB */</span>
	<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>

	<span class="n">base_addr0_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Check if standard PCI card or single BAR Raptor</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DPT_DEVICE_ID</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">&gt;=</span><span class="mh">0xc032</span> <span class="o">&amp;&amp;</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">&lt;=</span> <span class="mh">0xc03b</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Raptor card with this device id needs 4M</p></td><td class="code"><div class="highlight"><pre>			<span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Not Raptor - it is a PCI card</span>
			<span class="k">if</span><span class="p">(</span><span class="n">hba_map0_area_size</span> <span class="o">&gt;</span> <span class="mh">0x100000</span> <span class="p">){</span> 
				<span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">// Raptor split BAR config</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Use BAR1 in this configuration</p></td><td class="code"><div class="highlight"><pre>		<span class="n">base_addr1_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hba_map1_area_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pDev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">raptorFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="cm">/*</span>
<span class="cm">	 *	The original Adaptec 64 bit driver has this comment here:</span>
<span class="cm">	 *	&quot;x86_64 machines need more optimal mappings&quot;</span>
<span class="cm">	 *</span>
<span class="cm">	 *	I assume some HBAs report ridiculously large mappings</span>
<span class="cm">	 *	and we need to limit them on platforms with IOMMUs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raptorFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba_map0_area_size</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba_map1_area_size</span> <span class="o">&gt;</span> <span class="mi">524288</span><span class="p">)</span>
			<span class="n">hba_map1_area_size</span> <span class="o">=</span> <span class="mi">524288</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba_map0_area_size</span> <span class="o">&gt;</span> <span class="mi">524288</span><span class="p">)</span>
			<span class="n">hba_map0_area_size</span> <span class="o">=</span> <span class="mi">524288</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">base_addr_virt</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">base_addr0_phys</span><span class="p">,</span><span class="n">hba_map0_area_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_addr_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>
		<span class="n">PERROR</span><span class="p">(</span><span class="s">&quot;dpti: adpt_config_hba: io remap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">raptorFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg_addr_virt</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">base_addr1_phys</span><span class="p">,</span> <span class="n">hba_map1_area_size</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_addr_virt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PERROR</span><span class="p">(</span><span class="s">&quot;dpti: adpt_config_hba: io remap failed on BAR1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">base_addr_virt</span><span class="p">);</span>
			<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg_addr_virt</span> <span class="o">=</span> <span class="n">base_addr_virt</span><span class="p">;</span>
	<span class="p">}</span>
	</pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Allocate and zero the data structure</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pHba</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">adpt_hba</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHba</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_addr_virt</span> <span class="o">!=</span> <span class="n">base_addr_virt</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">msg_addr_virt</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">base_addr_virt</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hba_chain</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hba_chain</span> <span class="o">=</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">hba_count</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;dpti%d&quot;</span><span class="p">,</span> <span class="n">hba_count</span><span class="p">);</span>
	<span class="n">hba_count</span><span class="o">++</span><span class="p">;</span>
	
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_phys</span> <span class="o">=</span> <span class="n">base_addr0_phys</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Set up the Virtual Base Address of the I2O Device</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_virt</span> <span class="o">=</span> <span class="n">base_addr_virt</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span> <span class="o">=</span> <span class="n">msg_addr_virt</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">base_addr_virt</span><span class="o">+</span><span class="mh">0x30</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span> <span class="o">=</span> <span class="n">base_addr_virt</span><span class="o">+</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span> <span class="o">=</span> <span class="n">base_addr_virt</span><span class="o">+</span><span class="mh">0x44</span><span class="p">;</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DPTI_STATE_RESET</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">dma64</span> <span class="o">=</span> <span class="n">dma64</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Initializing the spinlocks</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">raptorFlag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Adaptec I2O RAID controller&quot;</span>
				 <span class="s">&quot; %d at %p size=%x irq=%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">hba_count</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">base_addr_virt</span><span class="p">,</span>
			<span class="n">hba_map0_area_size</span><span class="p">,</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">dma64</span> <span class="o">?</span> <span class="s">&quot; (64-bit DMA)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Adaptec I2O RAID controller %d irq=%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hba_count</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">dma64</span> <span class="o">?</span> <span class="s">&quot; (64-bit DMA)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;     BAR0 %p - size= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">base_addr_virt</span><span class="p">,</span><span class="n">hba_map0_area_size</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;     BAR1 %p - size= %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">msg_addr_virt</span><span class="p">,</span><span class="n">hba_map1_area_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adpt_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pHba</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s: Couldn&#39;t register IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">p1</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">p2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_device</span><span class="o">*</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_device</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">pDev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">pNext</span><span class="p">;</span>


	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>scsi<em>unregister calls our adpt</em>release which
does a quiese</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">){</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pHba</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">p1</span><span class="p">;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span><span class="n">p1</span><span class="o">=</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p1</span> <span class="o">==</span> <span class="n">pHba</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p2</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hba_chain</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hba_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_virt</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span> <span class="o">!=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_virt</span><span class="p">){</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span><span class="p">)</span>
	   	<span class="n">iounmap</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">entry_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt_pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_status_block</span><span class="p">),</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block_pa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span> <span class="n">d</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">next</span><span class="p">){</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_ID</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="k">for</span><span class="p">(</span><span class="n">pDev</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">pDev</span><span class="p">;</span> <span class="n">pDev</span> <span class="o">=</span> <span class="n">pNext</span><span class="p">){</span>
					<span class="n">pNext</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">pDev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">)</span>
		<span class="n">device_destroy</span><span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">,</span>
				<span class="n">MKDEV</span><span class="p">(</span><span class="n">DPTI_I2O_MAJOR</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">hba_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">DPTI_I2O_MAJOR</span><span class="p">,</span> <span class="n">DPT_DRIVER</span><span class="p">);</span>   
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">class_destroy</span><span class="p">(</span><span class="n">adpt_sysfs_class</span><span class="p">);</span>
			<span class="n">adpt_sysfs_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="nf">adpt_find_device</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;Adaptec I2O RAID: Trying to find device before they are allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">d</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If it is the only lun at that address then this should match*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">==</span> <span class="n">lun</span><span class="p">){</span>
		<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* else we need to look through all the luns */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">next_lun</span> <span class="p">;</span> <span class="n">d</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">==</span> <span class="n">lun</span><span class="p">){</span>
			<span class="k">return</span> <span class="n">d</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>I used my own version of the WAIT<em>QUEUE</em>HEAD
to handle some version differences
When embedded in the kernel this could go back to the vanilla one</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ADPT_DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">adpt_wq_i2o_post</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">wait_data</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The spin locking is needed to keep anyone from playing</span>
<span class="cm">	 * with the queue pointers and id while we do the same</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>TODO we need a MORE unique way of getting ids
to support async LCT get</p></td><td class="code"><div class="highlight"><pre>	<span class="n">wait_data</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">adpt_post_wait_queue</span><span class="p">;</span>
	<span class="n">adpt_post_wait_queue</span> <span class="o">=</span> <span class="n">wait_data</span><span class="p">;</span>
	<span class="n">adpt_post_wait_id</span><span class="o">++</span><span class="p">;</span>
	<span class="n">adpt_post_wait_id</span> <span class="o">&amp;=</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="n">wait_data</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span>  <span class="n">adpt_post_wait_id</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wait_data</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adpt_wq_i2o_post</span><span class="p">;</span>
	<span class="n">wait_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_wq_i2o_post</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">wait_data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">*=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">adpt_i2o_post_this</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>I/O issued, but cannot get result in
specified time. Freeing resorces is
dangerous.</p></td><td class="code"><div class="highlight"><pre>				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_wq_i2o_post</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;dpti%d: POST WAIT TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>We will have to free the wait_data memory during shutdown</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remove the entry from the queue.  */</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">p1</span> <span class="o">=</span> <span class="n">adpt_post_wait_queue</span><span class="p">;</span> <span class="n">p1</span><span class="p">;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p1</span> <span class="o">==</span> <span class="n">wait_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">I2O_DETAIL_STATUS_UNSUPPORTED_FUNCTION</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p2</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">adpt_post_wait_queue</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wait_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_post_this</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">m</span> <span class="o">=</span> <span class="n">EMPTY_QUEUE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;dpti%d: Timeout waiting for message frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">);</span>
		
	<span class="n">msg</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span> <span class="o">+</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>post message</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_i2o_post_wait_complete</span><span class="p">(</span><span class="n">u32</span> <span class="n">context</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adpt_i2o_post_wait_data</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to search through the adpt_post_wait</span>
<span class="cm">	 * queue to see if the given message is still</span>
<span class="cm">	 * outstanding.  If not, it means that the IOP</span>
<span class="cm">	 * took longer to respond to the message than we</span>
<span class="cm">	 * had allowed and timer has already expired.</span>
<span class="cm">	 * Not much we can do about that except log</span>
<span class="cm">	 * it for debug purposes, increase timeout, and recompile</span>
<span class="cm">	 *</span>
<span class="cm">	 * Lock needed to keep anyone from moving queue pointers</span>
<span class="cm">	 * around while we&#39;re looking through them.</span>
<span class="cm">	 */</span>

	<span class="n">context</span> <span class="o">&amp;=</span> <span class="mh">0x7fff</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">p1</span> <span class="o">=</span> <span class="n">adpt_post_wait_queue</span><span class="p">;</span> <span class="n">p1</span><span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p1</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_post_wait_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>If this happens we lose commands that probably really completed</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;dpti: Could Not find task %d in wait queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">context</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;      Tasks in wait queue:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">p1</span> <span class="o">=</span> <span class="n">adpt_post_wait_queue</span><span class="p">;</span> <span class="n">p1</span><span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;           %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">p1</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_reset_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>			
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span> <span class="o">=</span> <span class="n">EMPTY_QUEUE</span> <span class="p">;</span>
	<span class="n">ulong</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">TMOUT_IOPRESET</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">initialized</span>  <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// First time reset should be quick</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">25</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adpt_i2o_quiesce_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;Timeout waiting for message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_send_nop</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;IOP reset failed - no free memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">EIGHT_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">I2O_CMD_ADAPTER_RESET</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">ADAPTER_TID</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">dma_low</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="n">dma_high</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span><span class="o">+</span><span class="n">m</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: IOP Reset Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* We lose 4 bytes of &quot;status&quot; here, but we cannot</span>
<span class="cm">			   free these because controller may awake and corrupt</span>
<span class="cm">			   those bytes at any time */</span>
			<span class="cm">/* dma_free_coherent(&amp;pHba-&gt;pDev-&gt;dev, 4, buf, addr); */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="cm">/*I2O_EXEC_IOP_RESET_IN_PROGRESS*/</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: Reset in progress...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Here we wait for message frame to become available
indicated that reset has finished</p></td><td class="code"><div class="highlight"><pre>		<span class="k">do</span> <span class="p">{</span>
			<span class="n">rmb</span><span class="p">();</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:Timeout waiting for IOP Reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* We lose 4 bytes of &quot;status&quot; here, but we</span>
<span class="cm">				   cannot free these because controller may</span>
<span class="cm">				   awake and corrupt those bytes at any time */</span>
				<span class="cm">/* dma_free_coherent(&amp;pHba-&gt;pDev-&gt;dev, 4, buf, addr); */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Flush the offset</p></td><td class="code"><div class="highlight"><pre>		<span class="n">adpt_send_nop</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">!=</span> <span class="n">ADAPTER_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Reset reject, trying to clear</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: Reset completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#ifdef UARTDELAY</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>This delay is to allow someone attached to the card through the debug UART to 
set up the dump levels that they want before the rest of the initialization sequence</p></td><td class="code"><div class="highlight"><pre>	<span class="n">adpt_delay</span><span class="p">(</span><span class="mi">20000</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_parse_lct</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">i2o_lct</span> <span class="o">*</span><span class="n">lct</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">scsi_lun</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">// larger than 7, or 8 ...</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">pDev</span><span class="p">;</span> 
	
	<span class="k">if</span> <span class="p">(</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: LCT is empty???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">max</span> <span class="o">=</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span><span class="p">;</span>	
	<span class="n">max</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">/=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">user_tid</span> <span class="o">!=</span> <span class="mh">0xfff</span><span class="p">){</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we have hidden devices, we need to inform the upper layers about</span>
<span class="cm">			 * the possible maximum id reference to handle device access when</span>
<span class="cm">			 * an array is disassembled. This code has no other purpose but to</span>
<span class="cm">			 * allow us future access to devices that are currently hidden</span>
<span class="cm">			 * behind arrays, hotspares or have not been configured (JBOD mode).</span>
<span class="cm">			 */</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">!=</span> <span class="n">I2O_CLASS_RANDOM_BLOCK_STORAGE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">!=</span> <span class="n">I2O_CLASS_SCSI_PERIPHERAL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">!=</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL</span> <span class="p">){</span>
			    	<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>I2O<em>DPT</em>DEVICE<em>INFO</em>GROUP_NO;</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_no</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
			<span class="n">scsi_id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">scsi_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span> <span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Something wrong skip it</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Channel number %d out of range </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus_no</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_id</span> <span class="o">&gt;=</span> <span class="n">MAX_ID</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI ID %d out of range </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus_no</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span><span class="p">){</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">scsi_id</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span><span class="p">){</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span> <span class="o">=</span> <span class="n">scsi_id</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">scsi_lun</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span><span class="p">){</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span> <span class="o">=</span> <span class="n">scsi_lun</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span><span class="s">&quot;%s: Out of memory for I2O device data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">=</span> <span class="n">pHba</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_lct_entry</span><span class="p">));</span>

		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span>
		<span class="n">adpt_i2o_report_hba_unit</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
		<span class="n">adpt_i2o_install_device</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span> <span class="n">d</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span>  <span class="o">==</span> <span class="n">I2O_CLASS_BUS_ADAPTER_PORT</span> <span class="o">||</span>
		   <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span>  <span class="o">==</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PORT</span><span class="p">){</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>TODO get the bus<em>no from hrt-but for now they are in order
bus</em>no = </p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span><span class="p">){</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;Bus %d - SCSI ID %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_no</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>TODO remove - this is just until we get from hrt</p></td><td class="code"><div class="highlight"><pre>			<span class="n">bus_no</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Something wrong skip it</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Channel number %d out of range - LCT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus_no</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Setup adpt_device table</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span> <span class="n">d</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span>  <span class="o">==</span> <span class="n">I2O_CLASS_RANDOM_BLOCK_STORAGE</span> <span class="o">||</span>
		   <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span>  <span class="o">==</span> <span class="n">I2O_CLASS_SCSI_PERIPHERAL</span> <span class="o">||</span>
		   <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span>  <span class="o">==</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL</span> <span class="p">){</span>

			<span class="n">tid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span>
			<span class="n">scsi_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>I2O<em>DPT</em>DEVICE<em>INFO</em>GROUP_NO;</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bus_no</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
				<span class="n">scsi_id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">scsi_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span> <span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Something wrong skip it</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scsi_id</span> <span class="o">&gt;=</span> <span class="n">MAX_ID</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
					<span class="n">pDev</span> <span class="o">=</span>  <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pDev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">for</span><span class="p">(</span> <span class="n">pDev</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">];</span>	
							<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span> <span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">){</span>
					<span class="p">}</span>
					<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_channel</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">scsi_id</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">=</span> <span class="n">scsi_lun</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pI2o_dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">scsi_id</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span><span class="p">){</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span> <span class="o">=</span> <span class="n">scsi_id</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">scsi_lun</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span><span class="p">){</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span> <span class="o">=</span> <span class="n">scsi_lun</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">scsi_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;Could not find SCSI ID for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">identity_tag</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Each I2O controller has a chain of devices on it - these match</span>
<span class="cm"> *	the useful parts of the LCT of the board.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_install_device</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">=</span><span class="n">pHba</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">=</span><span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">=</span><span class="n">d</span><span class="p">;</span>
	<span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>TODO check for root access</p></td><td class="code"><div class="highlight"><pre>	<span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">hba_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* found adapter */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>if(pHba->in<em>use){
mutex</em>unlock(&amp;adpt<em>configuration</em>lock);
    return -EBUSY;
}</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>

	<span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">hba_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* found adapter */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_passthru</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="n">MAX_MESSAGE_SIZE</span><span class="p">];</span>
	<span class="n">u32</span><span class="o">*</span> <span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reply_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_msg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">user_reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sg_list</span><span class="p">[</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">sg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_MESSAGE_SIZE</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>get user msg size in u32s </p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">user_reply</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">user_msg</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_MESSAGE_SIZE</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// Convert to bytes</span>

	<span class="cm">/* Copy in the user&#39;s I2O command */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_user</span><span class="p">(</span><span class="n">reply_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">reply_size</span> <span class="o">=</span> <span class="n">reply_size</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reply_size</span> <span class="o">&gt;</span> <span class="n">REPLY_FRAME_SIZE</span><span class="p">){</span>
		<span class="n">reply_size</span> <span class="o">=</span> <span class="n">REPLY_FRAME_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply_size</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">REPLY_FRAME_SIZE</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not allocate reply buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">;</span> <span class="c1">// IOCTL context</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">adpt_ioctl_to_context</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sg_list</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sg_offset</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>TODO add 64 bit API</p></td><td class="code"><div class="highlight"><pre>		<span class="k">struct</span> <span class="n">sg_simple_element</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="n">sg_offset</span><span class="p">);</span>
		<span class="n">sg_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">sg_offset</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_count</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;%s:IOCTL SG List too large (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">sg_count</span><span class="p">);</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">sg_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span> <span class="cm">/*I2O_SGL_FLAGS_SIMPLE_ADDRESS_ELEMENT*/</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;%s:Bad SG element %d - not simple (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>  <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_count</span><span class="p">);</span>
				<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sg_size</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>      
			<span class="cm">/* Allocate memory for the transfer */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;%s: Could not allocate SG buffer - size = %d buffer number %d of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">sg_size</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">sg_count</span><span class="p">);</span>
				<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sg_list</span><span class="p">[</span><span class="n">sg_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="c1">// sglist indexed with input frame, not our internal frame.</span>
			<span class="cm">/* Copy in the user&#39;s SG buffer if necessary */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span> <span class="cm">/*I2O_SGL_FLAGS_DIR*/</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>sg<em>simple</em>element API is 32 bit</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">p</span><span class="p">,(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr_bus</span><span class="p">,</span> <span class="n">sg_size</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;%s: Could not copy SG buf %d FROM user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
					<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* sg_simple_element API is 32 bit, but addr &lt; 4GB */</span>
			<span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr_bus</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>This state stops any new commands from enterring the
controller while processing the ioctl
    pHba->state |= DPTI<em>STATE</em>IOCTL;
    We can't set this now - The scsi subsystem sets host_blocked and
    the queue empties and stops.  We need a way to restart the queue</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">FOREVER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;adpt_i2o_passthru: post wait failed %d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rcode</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><pre><code>pHba-&gt;state &amp;= ~DPTI_STATE_IOCTL;
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>  

	<span class="k">if</span><span class="p">(</span><span class="n">rcode</span><span class="p">){</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sg_offset</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Copy back the Scatter Gather buffers back to user space */</span>
		<span class="n">u32</span> <span class="n">j</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>TODO add 64 bit API</p></td><td class="code"><div class="highlight"><pre>		<span class="k">struct</span> <span class="n">sg_simple_element</span><span class="o">*</span> <span class="n">sg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sg_size</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>re-acquire the original message to handle correctly the sg copy operation</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_MESSAGE_SIZE</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> </pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>get user msg size in u32s </p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])){</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span> 
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span> 
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_MESSAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Copy in the user&#39;s I2O command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sg_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">sg_offset</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>TODO add 64 bit API</p></td><td class="code"><div class="highlight"><pre>		<span class="n">sg</span> 	 <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="o">*</span><span class="p">)(</span><span class="n">msg</span> <span class="o">+</span> <span class="n">sg_offset</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sg_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Copy out the SG list to user&#39;s buffer if necessary */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">sg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0x4000000</span> <span class="cm">/*I2O_SGL_FLAGS_DIR*/</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sg_size</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span> </pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>sg<em>simple</em>element API is 32 bit</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">sg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">addr_bus</span><span class="p">,</span><span class="n">sg_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sg_size</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not copy %p TO user %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sg_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">addr_bus</span><span class="p">);</span>
					<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> 

	<span class="cm">/* Copy back the reply to user space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply_size</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>we wrote our own values for context - now restore the user supplied ones</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">user_msg</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not copy message context FROM user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">reply_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not copy reply TO user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">rcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIME</span> <span class="o">&amp;&amp;</span> <span class="n">rcode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sg_simple_element</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span> <span class="o">+</span><span class="n">sg_offset</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">sg_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">sg_list</span><span class="p">[</span><span class="o">--</span><span class="n">sg_index</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">flag_count</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">,</span>
					<span class="n">sg_list</span><span class="p">[</span><span class="n">sg_index</span><span class="p">],</span>
					<span class="n">sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">addr_bus</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined __ia64__ </span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_ia64_info</span><span class="p">(</span><span class="n">sysInfo_S</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>This is all the info we need for now
We will add more info as our new
managmenent utility requires it</p></td><td class="code"><div class="highlight"><pre>	<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_IA64</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined __sparc__ </span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_sparc_info</span><span class="p">(</span><span class="n">sysInfo_S</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>This is all the info we need for now
We will add more info as our new
managmenent utility requires it</p></td><td class="code"><div class="highlight"><pre>	<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_ULTRASPARC</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#if defined __alpha__ </span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_alpha_info</span><span class="p">(</span><span class="n">sysInfo_S</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>This is all the info we need for now
We will add more info as our new
managmenent utility requires it</p></td><td class="code"><div class="highlight"><pre>	<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_ALPHA</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined __i386__</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_i386_info</span><span class="p">(</span><span class="n">sysInfo_S</span><span class="o">*</span> <span class="n">si</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>This is all the info we need for now
We will add more info as our new
managmenent utility requires it</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_386</span>:
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_386</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_486</span>:
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_486</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_586</span>:
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_PENTIUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>  <span class="c1">// Just in case </span>
		<span class="n">si</span><span class="o">-&gt;</span><span class="n">processorType</span> <span class="o">=</span> <span class="n">PROC_PENTIUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This routine returns information about the system.  This does not effect</span>
<span class="cm"> * any logic and if the info is wrong - it doesn&#39;t matter.</span>
<span class="cm"> */</span>

<span class="cm">/* Get all the info we can not get from kernel services */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_system_info</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysInfo_S</span> <span class="n">si</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>

	<span class="n">si</span><span class="p">.</span><span class="n">osType</span> <span class="o">=</span> <span class="n">OS_LINUX</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">osMajorVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">osMinorVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">osRevision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">busType</span> <span class="o">=</span> <span class="n">SI_PCI_BUS</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">processorFamily</span> <span class="o">=</span> <span class="n">DPTI_sig</span><span class="p">.</span><span class="n">dsProcessorFamily</span><span class="p">;</span>

<span class="cp">#if defined __i386__</span>
	<span class="n">adpt_i386_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
<span class="cp">#elif defined (__ia64__)</span>
	<span class="n">adpt_ia64_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
<span class="cp">#elif defined(__sparc__)</span>
	<span class="n">adpt_sparc_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
<span class="cp">#elif defined (__alpha__)</span>
	<span class="n">adpt_alpha_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">si</span><span class="p">.</span><span class="n">processorType</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">))){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;dpti: Could not copy buffer TO user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="n">DPTI_MAX_HBA</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* found adapter */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_configuration_lock</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span><span class="p">((</span><span class="k">volatile</span> <span class="n">u32</span><span class="p">)</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DPTI_STATE_RESET</span> <span class="p">)</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>TODO: handle 3 cases</p></td><td class="code"><div class="highlight"><pre>	<span class="k">case</span> <span class="n">DPT_SIGNATURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DPTI_sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DPTI_sig</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2OUSRCMD</span>:
		<span class="k">return</span> <span class="n">adpt_i2o_passthru</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DPT_CTRLINFO</span>:<span class="p">{</span>
		<span class="n">drvrHBAinfo_S</span> <span class="n">HbaInfo</span><span class="p">;</span>

<span class="cp">#define FLG_OSD_PCI_VALID 0x0001</span>
<span class="cp">#define FLG_OSD_DMA	  0x0002</span>
<span class="cp">#define FLG_OSD_I2O	  0x0004</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HbaInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HbaInfo</span><span class="p">));</span>
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">drvrHBAnum</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">baseAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_phys</span><span class="p">;</span>
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">blinkState</span> <span class="o">=</span> <span class="n">adpt_read_blink_led</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">pciBusNum</span> <span class="o">=</span>  <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">pciDeviceNum</span><span class="o">=</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span> 
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">Interrupt</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span> 
		<span class="n">HbaInfo</span><span class="p">.</span><span class="n">hbaFlags</span> <span class="o">=</span> <span class="n">FLG_OSD_PCI_VALID</span> <span class="o">|</span> <span class="n">FLG_OSD_DMA</span> <span class="o">|</span> <span class="n">FLG_OSD_I2O</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HbaInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HbaInfo</span><span class="p">))){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not copy HbaInfo TO user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">DPT_SYSINFO</span>:
		<span class="k">return</span> <span class="n">adpt_system_info</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DPT_BLINKLED</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">adpt_read_blink_led</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">I2ORESETCMD</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adpt_hba_reset</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2ORESCANCMD</span>:
		<span class="n">adpt_rescan</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">adpt_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
 
	<span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
 
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">adpt_ioctl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">compat_adpt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
 
	<span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
 
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>
 
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DPT_SIGNATURE</span>:
		<span class="k">case</span> <span class="n">I2OUSRCMD</span>:
		<span class="k">case</span> <span class="n">DPT_CTRLINFO</span>:
		<span class="k">case</span> <span class="n">DPT_SYSINFO</span>:
		<span class="k">case</span> <span class="n">DPT_BLINKLED</span>:
		<span class="k">case</span> <span class="n">I2ORESETCMD</span>:
		<span class="k">case</span> <span class="n">I2ORESCANCMD</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">DPT_TARGET_BUSY</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">DPT_TARGET_BUSY</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">adpt_ioctl</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
 
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adpt_mutex</span><span class="p">);</span>
 
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">adpt_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;adpt_isr: NULL dev_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I2O_INTERRUPT_PENDING_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Try twice then give up</p></td><td class="code"><div class="highlight"><pre>			<span class="n">rmb</span><span class="p">();</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">){</span> </pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>This really should not happen</p></td><td class="code"><div class="highlight"><pre>				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;dpti: Could not get reply frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span> <span class="o">&lt;=</span> <span class="n">m</span> <span class="o">&amp;&amp;</span>
		    <span class="n">m</span> <span class="o">&lt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Ick, we should *never* be here */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dpti: reply frame not from pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bus_to_virt</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSG_FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">old_m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">28</span><span class="p">);</span> 
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">old_context</span><span class="p">;</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: Failed message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">old_m</span> <span class="o">&gt;=</span> <span class="mh">0x100000</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s: Bad preserved MFA (%x)- dropping frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">old_m</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Transaction context is 0 in failed reply frame</p></td><td class="code"><div class="highlight"><pre>			<span class="n">msg</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span> <span class="o">+</span> <span class="n">old_m</span><span class="p">;</span>
			<span class="n">old_context</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">old_context</span><span class="p">,</span> <span class="n">reply</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">adpt_send_nop</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">old_m</span><span class="p">);</span>
		<span class="p">}</span> 
		<span class="n">context</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">){</span> <span class="c1">// IOCTL</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">adpt_ioctl_from_context</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">12</span><span class="p">));</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>All IOCTLs will also be post wait</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">){</span> <span class="c1">// Post wait message</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">status</span>  <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">){</span>
				<span class="n">status</span> <span class="o">&amp;=</span>  <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* Get detail status */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">I2O_POST_WAIT_OK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">context</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">adpt_cmd_from_context</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span>
							<span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">12</span><span class="p">));</span>
				<span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Apparent SCSI cmd in Post Wait Context - cmd=%p context=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">adpt_i2o_post_wait_complete</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// SCSI message</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">adpt_cmd_from_context</span> <span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">12</span><span class="p">));</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// If not timedout</span>
					<span class="n">adpt_i2o_to_scsi</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_scsi_to_i2o</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="n">MAX_MESSAGE_SIZE</span><span class="p">];</span>
	<span class="n">u32</span><span class="o">*</span> <span class="n">mptr</span><span class="p">;</span>
	<span class="n">u32</span><span class="o">*</span> <span class="n">lptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">lenptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scsidir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reqlen</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">direction</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>	
	
	<span class="n">scsidir</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>			<span class="c1">// DATA NO XFER</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set SCBFlags to indicate if data is being transferred</span>
<span class="cm">		 * in or out, or no data transfer</span>
<span class="cm">		 * Note:  Do not have to verify index is less than 0 since</span>
<span class="cm">		 * cmd-&gt;cmnd[0] is an unsigned char</span>
<span class="cm">		 */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
			<span class="n">scsidir</span>  <span class="o">=</span><span class="mh">0x40000000</span><span class="p">;</span>	<span class="c1">// DATA IN  (iop&lt;--dev)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
			<span class="n">direction</span><span class="o">=</span><span class="mh">0x04000000</span><span class="p">;</span>	<span class="c1">// SGL OUT</span>
			<span class="n">scsidir</span>  <span class="o">=</span><span class="mh">0x80000000</span><span class="p">;</span>	<span class="c1">// DATA OUT (iop--&gt;dev)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_NONE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:
			<span class="n">scsidir</span>  <span class="o">=</span><span class="mh">0x40000000</span><span class="p">;</span>	<span class="c1">// DATA IN  (iop&lt;--dev)</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Assume In - and continue;</p></td><td class="code"><div class="highlight"><pre>			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: scsi opcode 0x%x not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">INITIATOR_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> 	<span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>msg[0] is set later
I2O<em>CMD</em>SCSI_EXEC</p></td><td class="code"><div class="highlight"><pre>	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xff</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">adpt_cmd_to_context</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>  <span class="cm">/* Want SCSI control block back */</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Our cards use the transaction context as the tag for queueing
Adaptec/DPT Private stuff </p></td><td class="code"><div class="highlight"><pre>	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_SCSI_EXEC</span><span class="o">|</span><span class="p">(</span><span class="n">DPT_ORGANIZATION_ID</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
	<span class="cm">/* Direction, disconnect ok | sense data | simple queue , CDBLen */</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>I2O<em>SCB</em>FLAG<em>ENABLE</em>DISCONNECT | 
I2O<em>SCB</em>FLAG<em>SIMPLE</em>QUEUE<em>TAG | 
I2O</em>SCB<em>FLAG</em>SENSE<em>DATA</em>IN_MESSAGE;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsidir</span><span class="o">|</span><span class="mh">0x20a00000</span><span class="o">|</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>

	<span class="n">mptr</span><span class="o">=</span><span class="n">msg</span><span class="o">+</span><span class="mi">7</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Write SCSI command into the message - always 16 byte block </p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="n">mptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">16</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mptr</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">mptr</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">lenptr</span><span class="o">=</span><span class="n">mptr</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* Remember me - fill in when we know */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpt_dma64</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>		<span class="c1">// SINGLE SGE</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7C</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Enable 64 bit */</span>
		<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>		<span class="c1">// SINGLE SGE</span>
	<span class="p">}</span>
	<span class="cm">/* Now fill in the SGList and command */</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lptr</span> <span class="o">=</span> <span class="n">mptr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">direction</span><span class="o">|</span><span class="mh">0x10000000</span><span class="o">|</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">len</span><span class="o">+=</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dma_low</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpt_dma64</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span>
				<span class="o">*</span><span class="n">mptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dma_high</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="cm">/* Make this an end of list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">nseg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">*</span><span class="n">lptr</span> <span class="o">=</span> <span class="n">direction</span><span class="o">|</span><span class="mh">0xD0000000</span><span class="o">|</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="n">mptr</span> <span class="o">-</span> <span class="n">msg</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lenptr</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		
		<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;Cmd len %08X Cmd underflow %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lenptr</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reqlen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Stick the headers on */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reqlen</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="p">((</span><span class="n">reqlen</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">?</span> <span class="n">SGL_OFFSET_12</span> <span class="o">:</span> <span class="n">SGL_OFFSET_0</span><span class="p">);</span>
	</pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Send it on it's way</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_post_this</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reqlen</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_scsi_host_alloc</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: scsi_host_alloc returned NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pHba</span><span class="p">;</span>
	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="cm">/* no IO ports, so don&#39;t have to set host-&gt;io_port and</span>
<span class="cm">	 * host-&gt;n_io_port</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* see comments in scsi_host.h */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sys_tbl_pa</span> <span class="o">+</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_fifo_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_to_scsi</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hba_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reply_flags</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span> <span class="c1">// Leave it shifted up 8 bits </span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>I know this would look cleaner if I just read bytes
but the model I have been using for all the rest of the
io is in 4 byte words - so I keep that model</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u16</span> <span class="n">detailed_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">dev_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">detailed_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">hba_status</span> <span class="o">=</span> <span class="n">detailed_status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>calculate resid for sg </p></td><td class="code"><div class="highlight"><pre>	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">20</span><span class="p">));</span>

	<span class="n">pHba</span> <span class="o">=</span> <span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>  <span class="c1">// initialize sense valid flag to false</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reply_flags</span> <span class="o">&amp;</span> <span class="n">MSG_FAIL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">detailed_status</span> <span class="o">&amp;</span> <span class="n">I2O_SCSI_DSC_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_SUCCESS</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>handle underflow</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI CMD underflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_REQUEST_ABORTED</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_PATH_INVALID</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_DEVICE_NOT_PRESENT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_SELECTION_TIMEOUT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_COMMAND_TIMEOUT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_NO_ADAPTER</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_RESOURCE_UNAVAILABLE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI Timeout-Device (%d,%d,%d) hba status=0x%x, dev status=0x%x, cmd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">hba_status</span><span class="p">,</span> <span class="n">dev_status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_ADAPTER_BUSY</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_BUS_BUSY</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_SCSI_BUS_RESET</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_BDR_MESSAGE_SENT</span>:
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_PARITY_ERROR_FAILURE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI CMD parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_PARITY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_UNABLE_TO_ABORT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_COMPLETE_WITH_ERROR</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_UNABLE_TO_TERMINATE</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_MR_MESSAGE_RECEIVED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_AUTOSENSE_FAILED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_DATA_OVERRUN</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_UNEXPECTED_BUS_FREE</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_SEQUENCE_FAILURE</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_REQUEST_LENGTH_ERROR</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_PROVIDE_FAILURE</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_REQUEST_TERMINATED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_IDE_MESSAGE_SENT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_UNACKNOWLEDGED_EVENT</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_MESSAGE_RECEIVED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_INVALID_CDB</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_LUN_INVALID</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_SCSI_TID_INVALID</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_FUNCTION_UNAVAILABLE</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_NO_NEXUS</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_CDB_RECEIVED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_LUN_ALREADY_ENABLED</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_QUEUE_FROZEN</span>:
		<span class="k">case</span> <span class="n">I2O_SCSI_DSC_REQUEST_INVALID</span>:
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI error %0x-Device(%d,%d,%d) hba_status=0x%x, dev_status=0x%x, cmd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">detailed_status</span> <span class="o">&amp;</span> <span class="n">I2O_SCSI_DSC_MASK</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			       <span class="n">hba_status</span><span class="p">,</span> <span class="n">dev_status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>copy over the request sense data if it was a check
condition status</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">dev_status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Copy over the sense data</p></td><td class="code"><div class="highlight"><pre>			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">reply</span><span class="o">+</span><span class="mi">28</span><span class="p">)</span> <span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="cm">/* class 7 */</span> <span class="o">&amp;&amp;</span> 
			   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">DATA_PROTECT</span> <span class="p">){</span>
				<span class="cm">/* This is to handle an array failed */</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: SCSI Data Protect-Device (%d,%d,%d) hba_status=0x%x, dev_status=0x%x, cmd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> 
					<span class="n">hba_status</span><span class="p">,</span> <span class="n">dev_status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* In this condtion we could not talk to the tid</span>
<span class="cm">		 * the card rejected it.  We should signal a retry</span>
<span class="cm">		 * for a limitted number of retries.</span>
<span class="cm">		 */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: I2O MSG_FAIL - Device (%d,%d,%d) tid=%d, cmd=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev_status</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> 
	<span class="k">return</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_rescan</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_lct_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span><span class="o">=</span><span class="n">adpt_i2o_reparse_lct</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_reparse_lct</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">i2o_lct</span> <span class="o">*</span><span class="n">lct</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">scsi_lun</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">// at least 8 u32&#39;s</span>
	<span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span> <span class="n">pDev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_device</span><span class="o">*</span> <span class="n">pI2o_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: LCT is empty???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">max</span> <span class="o">=</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span><span class="p">;</span>	
	<span class="n">max</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">/=</span> <span class="mi">9</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>Mark each drive as unscanned</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span> <span class="n">d</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDev</span> <span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pDev</span><span class="p">){</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DPTI_DEV_UNSCANNED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: LCT has %d entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">max</span><span class="p">);</span>
	
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">user_tid</span> <span class="o">!=</span> <span class="mh">0xfff</span><span class="p">){</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">I2O_CLASS_RANDOM_BLOCK_STORAGE</span> <span class="o">||</span>
		    <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">I2O_CLASS_SCSI_PERIPHERAL</span> <span class="o">||</span>
		    <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL</span> <span class="p">){</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s: Could not query device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_no</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Something wrong skip it */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;%s: Channel number %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bus_no</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scsi_id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">scsi_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span> <span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
			<span class="n">pDev</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">];</span>
			<span class="cm">/* da lun */</span>
			<span class="k">while</span><span class="p">(</span><span class="n">pDev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">==</span> <span class="n">scsi_lun</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pDev</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// Something new add it</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span><span class="p">),</span>
					    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Out of memory for I2O device data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">=</span> <span class="n">pHba</span><span class="p">;</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_lct_entry</span><span class="p">));</span>

				<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">adpt_i2o_report_hba_unit</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
				<span class="n">adpt_i2o_install_device</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	
				<span class="n">pDev</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">];</span>	
				<span class="k">if</span><span class="p">(</span> <span class="n">pDev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
					<span class="n">pDev</span> <span class="o">=</span>
					  <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="p">),</span>
						  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pDev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">device</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span> <span class="o">=</span>
					  <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="p">),</span>
						  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pDev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_channel</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">scsi_id</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">=</span> <span class="n">scsi_lun</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pI2o_dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">pDev</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
				<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Too late, SCSI system has made up it's mind, but what the hey ...</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="n">scsi_id</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span><span class="p">){</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_id</span> <span class="o">=</span> <span class="n">scsi_id</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">scsi_lun</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span><span class="p">){</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">top_scsi_lun</span> <span class="o">=</span> <span class="n">scsi_lun</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="c1">// end of new i2o device</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>We found an old device - check it</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span><span class="p">(</span><span class="n">pDev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_lun</span> <span class="o">==</span> <span class="n">scsi_lun</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">scsi_device_online</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Setting device (%d,%d,%d) back online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">bus_no</span><span class="p">,</span><span class="n">scsi_id</span><span class="p">,</span><span class="n">scsi_lun</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">scsi_device_set_state</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">,</span> <span class="n">SDEV_RUNNING</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pI2o_dev</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span> <span class="o">!=</span> <span class="n">tid</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// something changed</span>
						<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_lct_entry</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
							<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="o">-&gt;</span><span class="n">removable</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>Found it - mark it scanned</p></td><td class="code"><div class="highlight"><pre>					<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DPTI_DEV_ONLINE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pDev</span> <span class="o">=</span> <span class="n">pDev</span><span class="o">-&gt;</span><span class="n">next_lun</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pI2o_dev</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">;</span> <span class="n">pI2o_dev</span><span class="p">;</span> <span class="n">pI2o_dev</span> <span class="o">=</span> <span class="n">pI2o_dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDev</span> <span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">adpt_device</span><span class="o">*</span><span class="p">)</span> <span class="n">pI2o_dev</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pDev</span><span class="p">){</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>Drive offline drives that previously existed but could not be found
in the LCT table</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DPTI_DEV_UNSCANNED</span><span class="p">){</span>
			<span class="n">pDev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DPTI_DEV_OFFLINE</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Device (%d,%d,%d) offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_channel</span><span class="p">,</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">scsi_lun</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsi_device_set_state</span><span class="p">(</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">pScsi_dev</span><span class="p">,</span> <span class="n">SDEV_OFFLINE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_fail_posted_scbs</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="o">*</span> 	<span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span><span class="o">*</span> 	<span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">cmd_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">QUEUE_FULL</span> <span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*============================================================================</span>
<span class="cm"> *  Routines from i2o subsystem</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>



<span class="cm">/*</span>
<span class="cm"> *	Bring an I2O controller into HOLD state. See the spec.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_activate_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_reset_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could NOT reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HBA not responding.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_FAULTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: hardware fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_READY</span> <span class="o">||</span>
		    <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_OPERATIONAL</span> <span class="o">||</span>
		    <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_HOLD</span> <span class="o">||</span>
		    <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adpt_i2o_reset_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>			
			<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">!=</span> <span class="n">ADAPTER_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to initialize.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">adpt_i2o_reset_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could NOT reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rcode</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_init_outbound_q</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In HOLD state */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_hrt_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Bring a controller online into OPERATIONAL state. </span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_online_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_systab_send</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* In READY state */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_enable_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_i2o_delete_hba</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In OPERATIONAL state  */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_send_nop</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span><span class="n">pHba</span><span class="p">,</span><span class="n">u32</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">){</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">){</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Timeout waiting for message frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span> <span class="o">+</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">THREE_WORD_MSG_SIZE</span> <span class="o">|</span> <span class="n">SGL_OFFSET_0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">I2O_CMD_UTIL_NOP</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_init_outbound_q</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TMOUT_INITOUTBOUND</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Timeout waiting for message frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">EMPTY_QUEUE</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">=</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span><span class="o">+</span><span class="n">m</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adpt_send_nop</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: IOP reset failed - no free memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">EIGHT_WORD_MSG_SIZE</span><span class="o">|</span> <span class="n">SGL_OFFSET_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">I2O_CMD_OUTBOUND_INIT</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="o">|</span> <span class="n">ADAPTER_TID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0106</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>	<span class="cm">/* Transaction context */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>		<span class="cm">/* Host page frame size */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">REPLY_FRAME_SIZE</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="o">|</span><span class="mh">0x80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>	<span class="cm">/* Outbound msg frame size and Initcode */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xD0000004</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>		<span class="cm">/* Simple SG LE, EOB */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Wait for the reply status to come back</p></td><td class="code"><div class="highlight"><pre>	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="cm">/*I2O_EXEC_OUTBOUND_INIT_IN_PROGRESS*/</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Timeout Initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* We lose 4 bytes of &quot;status&quot; here, but we</span>
<span class="cm">			   cannot free these because controller may</span>
<span class="cm">			   awake and corrupt those bytes at any time */</span>
			<span class="cm">/* dma_free_coherent(&amp;pHba-&gt;pDev-&gt;dev, 4, status, addr); */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>If the command was successful, fill the fifo with our reply
message packets</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">!=</span> <span class="mh">0x04</span> <span class="cm">/*I2O_EXEC_OUTBOUND_INIT_COMPLETE*/</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Could not allocate reply pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_pool_pa</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">REPLY_FRAME_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_port</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * I2O System Table.  Contains information about</span>
<span class="cm"> * all the IOPs in the system.  Used to inform IOPs</span>
<span class="cm"> * about each other&#39;s existence.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_tbl_ver is the CurrentChangeIndicator that is</span>
<span class="cm"> * used by IOPs to track changes.</span>
<span class="cm"> */</span>



<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_status_get</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">status_block</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_status_block</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;dpti%d: Get Status Block failed; Out of memory. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_status_block</span><span class="p">));</span>
	<span class="n">status_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">TMOUT_GETSTATUS</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">EMPTY_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Timeout waiting for message !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">m</span><span class="o">==</span><span class="n">EMPTY_QUEUE</span><span class="p">);</span>

	
	<span class="n">msg</span><span class="o">=</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">msg_addr_virt</span><span class="o">+</span><span class="n">m</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NINE_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">I2O_CMD_STATUS_GET</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">ADAPTER_TID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">dma_low</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block_pa</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">dma_high</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block_pa</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_status_block</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span> <span class="c1">// 88 bytes</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>post message</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_port</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">while</span><span class="p">(</span><span class="n">status_block</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span><span class="o">!=</span><span class="mh">0xff</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timeout</span><span class="p">)){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;dpti%d: Get status timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>Set up our number of outbound and inbound messages</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_fifo_size</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">max_inbound_frames</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_fifo_size</span> <span class="o">&gt;</span> <span class="n">MAX_TO_IOP_MESSAGES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">post_fifo_size</span> <span class="o">=</span> <span class="n">MAX_TO_IOP_MESSAGES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">max_outbound_frames</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">&gt;</span> <span class="n">MAX_FROM_IOP_MESSAGES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">reply_fifo_size</span> <span class="o">=</span> <span class="n">MAX_FROM_IOP_MESSAGES</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>Calculate the Scatter Gather list size</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">dpt_dma64</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span>
		  <span class="o">=</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">inbound_frame_size</span> <span class="o">*</span> <span class="mi">4</span>
		  <span class="o">-</span> <span class="mi">14</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		  <span class="o">/</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span>
		  <span class="o">=</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">inbound_frame_size</span> <span class="o">*</span> <span class="mi">4</span>
		  <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		  <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_simple_element</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">&gt;</span> <span class="n">SG_LIST_ELEMENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">SG_LIST_ELEMENTS</span><span class="p">;</span>
	<span class="p">}</span>


<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dpti%d: State = &quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HOLD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;OPERATIONAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x11</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FAULTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x (unknown!!)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the IOP&#39;s Logical Configuration Table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_lct_get</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)){</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">expected_lct_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_pa</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: Lct Get failed. Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">);</span>

		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIGHT_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_6</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_LCT_NOTIFY</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="o">|</span> <span class="n">ADAPTER_TID</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>	<span class="cm">/* All devices */</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>	<span class="cm">/* Report now */</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD0000000</span><span class="o">|</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_pa</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span><span class="o">=</span><span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">360</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: LCT Get failed (status=%#10x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>	
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;Adaptec: Error Reading Hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_size</span><span class="p">,</span>
					<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct_pa</span><span class="p">);</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: Hardware resource table read.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>I2O<em>DPT</em>EXEC<em>IOP</em>BUFFERS<em>GROUP</em>NO;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBufferSize</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_phys</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBufferSize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugFlags_P</span>     <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span> <span class="o">+</span>
							<span class="n">FW_DEBUG_FLAGS_OFFSET</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDvalue_P</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span> <span class="o">+</span>
							<span class="n">FW_DEBUG_BLED_OFFSET</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDflag_P</span>  <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBLEDvalue_P</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugStrLength_P</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span> <span class="o">+</span>
						<span class="n">FW_DEBUG_STR_LENGTH_OFFSET</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugBuffer_P</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> 
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">FwDebugFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_build_sys_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys_tbl</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sys_tbl_len</span><span class="p">,</span>
					<span class="n">sys_tbl</span><span class="p">,</span> <span class="n">sys_tbl_pa</span><span class="p">);</span>

	<span class="n">sys_tbl_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_sys_tbl</span><span class="p">)</span> <span class="o">+</span>	<span class="c1">// Header + IOPs</span>
				<span class="p">(</span><span class="n">hba_count</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_sys_tbl_entry</span><span class="p">);</span>

	<span class="n">sys_tbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">sys_tbl_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_tbl_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sys_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SysTab Set failed. Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>	
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sys_tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sys_tbl_len</span><span class="p">);</span>

	<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">hba_count</span><span class="p">;</span>
	<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">I2OVERSION</span><span class="p">;</span>
	<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">change_ind</span> <span class="o">=</span> <span class="n">sys_tbl_ind</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Get updated Status Block so we have the latest information</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span> <span class="c1">// try next one	</span>
		<span class="p">}</span>

		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">org_id</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">org_id</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">iop_id</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">seg_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">i2o_version</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">i2o_version</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">iop_state</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">inbound_frame_size</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">last_changed</span> <span class="o">=</span> <span class="n">sys_tbl_ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// ??</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">iop_capabilities</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_capabilities</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">base_addr_phys</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">inbound_low</span> <span class="o">=</span> <span class="n">dma_low</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">sys_tbl</span><span class="o">-&gt;</span><span class="n">iops</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">inbound_high</span> <span class="o">=</span> <span class="n">dma_high</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">sys_tbl</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;sys_tbl_len=%d in 32bit words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">sys_tbl_len</span> <span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="k">for</span><span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sys_tbl_len</span> <span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sys_tbl[%d] = %0#10x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">count</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	 Dump the information block associated with a given unit (TID)</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_i2o_report_hba_unit</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;TID %3.3d &quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="mh">0xF100</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Vendor: %-12.12s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="mh">0xF100</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Device: %-12.12s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="mh">0xF100</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Rev: %-12.12s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Class: %.21s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adpt_i2o_get_class_name</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span><span class="p">));</span>
	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Subclass: 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">sub_class</span><span class="p">);</span>
	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Flags: &quot;</span><span class="p">);</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">device_flags</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span>
		  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">);</span>	     <span class="c1">// ConfigDialog requested</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">device_flags</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
		  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">);</span>	     <span class="c1">// Multi-user capable</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">device_flags</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)))</span>
		  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;P&quot;</span><span class="p">);</span>	     <span class="c1">// Peer service enabled!</span>
	 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">device_flags</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)))</span>
		  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">);</span>	     <span class="c1">// Mgmt service enabled!</span>
	 <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> *	Do i2o class name lookup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">adpt_i2o_get_class_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">i2o_class_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Executive&quot;</span><span class="p">,</span>
		<span class="s">&quot;Device Driver Module&quot;</span><span class="p">,</span>
		<span class="s">&quot;Block Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;Tape Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;LAN Interface&quot;</span><span class="p">,</span>
		<span class="s">&quot;WAN Interface&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fibre Channel Port&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fibre Channel Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;SCSI Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;ATE Port&quot;</span><span class="p">,</span>
		<span class="s">&quot;ATE Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;Floppy Controller&quot;</span><span class="p">,</span>
		<span class="s">&quot;Floppy Device&quot;</span><span class="p">,</span>
		<span class="s">&quot;Secondary Bus Port&quot;</span><span class="p">,</span>
		<span class="s">&quot;Peer Transport Agent&quot;</span><span class="p">,</span>
		<span class="s">&quot;Peer Transport&quot;</span><span class="p">,</span>
		<span class="s">&quot;Unknown&quot;</span>
	<span class="p">};</span>
	
	<span class="k">switch</span><span class="p">(</span><span class="n">class</span><span class="o">&amp;</span><span class="mh">0xFFF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_EXECUTIVE</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_DDM</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_RANDOM_BLOCK_STORAGE</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_SEQUENTIAL_STORAGE</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_LAN</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_WAN</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PORT</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_SCSI_PERIPHERAL</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_ATE_PORT</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_ATE_PERIPHERAL</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_FLOPPY_CONTROLLER</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_FLOPPY_DEVICE</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_BUS_ADAPTER_PORT</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_PEER_TRANSPORT_AGENT</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2O_CLASS_PEER_TRANSPORT</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i2o_class_name</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_hrt_get</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2o_hrt</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: Hrt Get failed; Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">SIX_WORD_MSG_SIZE</span><span class="o">|</span> <span class="n">SGL_OFFSET_4</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">I2O_CMD_HRT_GET</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="o">|</span> <span class="n">ADAPTER_TID</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="mh">0xD0000000</span> <span class="o">|</span> <span class="n">size</span><span class="p">);</span>    <span class="cm">/* Simple transaction */</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt_pa</span><span class="p">;</span>	<span class="cm">/* Dump it here */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span><span class="mi">20</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to get HRT (status=%#10x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">entry_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">newsize</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="o">-&gt;</span><span class="n">entry_len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt_pa</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">;</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">hrt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>                                                                                                                                       

<span class="cm">/*</span>
<span class="cm"> *	 Query one scalar group value or a whole scalar group.</span>
<span class="cm"> */</span>		    	
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_query_scalar</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> 
			<span class="kt">int</span> <span class="n">group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">field</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">opblk</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2O_PARAMS_FIELD_GET</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">field</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">opblk_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">opblk_pa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">resblk_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">resblk_pa</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* 8 bytes for header */</span>
	<span class="n">resblk_va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">resblk_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resblk_va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: query scalar failed; Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opblk_va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">opblk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">opblk_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opblk_va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">buflen</span><span class="p">),</span>
			<span class="n">resblk_va</span><span class="p">,</span> <span class="n">resblk_pa</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: query operatio failed; Out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  		<span class="cm">/* whole group */</span>
			<span class="n">opblk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">opblk_va</span><span class="p">,</span> <span class="n">opblk</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opblk</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">adpt_i2o_issue_params</span><span class="p">(</span><span class="n">I2O_CMD_UTIL_PARAMS_GET</span><span class="p">,</span> <span class="n">pHba</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> 
		<span class="n">opblk_va</span><span class="p">,</span> <span class="n">opblk_pa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opblk</span><span class="p">),</span>
		<span class="n">resblk_va</span><span class="p">,</span> <span class="n">resblk_pa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">buflen</span><span class="p">));</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">opblk</span><span class="p">),</span> <span class="n">opblk_va</span><span class="p">,</span> <span class="n">opblk_pa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">buflen</span><span class="p">),</span>
							<span class="n">resblk_va</span><span class="p">,</span> <span class="n">resblk_pa</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: issue params failed; Timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">buflen</span><span class="p">),</span>
							<span class="n">resblk_va</span><span class="p">,</span> <span class="n">resblk_pa</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: issue params failed; Interrupted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
			
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">resblk_va</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>  <span class="cm">/* cut off header */</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">buflen</span><span class="p">),</span>
						<span class="n">resblk_va</span><span class="p">,</span> <span class="n">resblk_pa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>	

	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*	Issue UTIL_PARAMS_GET or UTIL_PARAMS_SET</span>
<span class="cm"> *</span>
<span class="cm"> *	This function can be used for all UtilParamsGet/Set operations.</span>
<span class="cm"> *	The OperationBlock is given in opblk-buffer, </span>
<span class="cm"> *	and results are returned in resblk-buffer.</span>
<span class="cm"> *	Note that the minimum sized resblk is 8 bytes and contains</span>
<span class="cm"> *	ResultCount, ErrorInfoSize, BlockStatus and BlockSize.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_issue_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> 
		  <span class="kt">void</span> <span class="o">*</span><span class="n">opblk_va</span><span class="p">,</span>  <span class="n">dma_addr_t</span> <span class="n">opblk_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oplen</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">resblk_va</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">resblk_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reslen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span> 
	<span class="n">u32</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">resblk_va</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_status</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NINE_WORD_MSG_SIZE</span> <span class="o">|</span> <span class="n">SGL_OFFSET_5</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="n">tid</span><span class="p">;</span> 
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x54000000</span> <span class="o">|</span> <span class="n">oplen</span><span class="p">;</span>	<span class="cm">/* OperationBlock */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">opblk_pa</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD0000000</span> <span class="o">|</span> <span class="n">reslen</span><span class="p">;</span>	<span class="cm">/* ResultBlock */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">resblk_pa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wait_status</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">20</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;adpt_i2o_issue_params: post_wait failed (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resblk_va</span><span class="p">);</span>
   		<span class="k">return</span> <span class="n">wait_status</span><span class="p">;</span> 	<span class="cm">/* -DetailedStatus */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x00FF0000</span><span class="p">)</span> <span class="p">{</span> 	<span class="cm">/* BlockStatus != SUCCESS */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s - Error:</span><span class="se">\n</span><span class="s">  ErrorInfoSize = 0x%02x, &quot;</span>
			<span class="s">&quot;BlockStatus = 0x%02x, BlockSize = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">I2O_CMD_UTIL_PARAMS_SET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PARAMS_SET&quot;</span>
							 <span class="o">:</span> <span class="s">&quot;PARAMS_GET&quot;</span><span class="p">,</span>   
			<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="cm">/* -BlockStatus */</span>
	<span class="p">}</span>

	 <span class="k">return</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* bytes used in resblk */</span> 
<span class="p">}</span>


<span class="k">static</span> <span class="n">s32</span> <span class="nf">adpt_i2o_quiesce_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>

	<span class="cm">/* SysQuiesce discarded if IOP not in READY or OPERATIONAL state */</span>

	<span class="k">if</span><span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">!=</span> <span class="n">ADAPTER_STATE_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
   	   <span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">!=</span> <span class="n">ADAPTER_STATE_OPERATIONAL</span><span class="p">)){</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FOUR_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_SYS_QUIESCE</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">ADAPTER_TID</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">240</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;dpti%d: Unable to quiesce (status=%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;dpti%d: Quiesced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * Enable IOP. Allows the IOP to resume external operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_enable_hba</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Enable only allowed on READY state */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">==</span> <span class="n">ADAPTER_STATE_OPERATIONAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="o">-&gt;</span><span class="n">iop_state</span> <span class="o">!=</span> <span class="n">ADAPTER_STATE_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">FOUR_WORD_MSG_SIZE</span><span class="o">|</span><span class="n">SGL_OFFSET_0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">I2O_CMD_SYS_ENABLE</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="o">|</span><span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="n">ADAPTER_TID</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">240</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;%s: Could not enable (status=%#10x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="s">&quot;%s: Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adpt_i2o_status_get</span><span class="p">(</span><span class="n">pHba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">adpt_i2o_systab_send</span><span class="p">(</span><span class="n">adpt_hba</span><span class="o">*</span> <span class="n">pHba</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="n">u32</span> <span class="n">msg</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	 <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_MESSAGE_SIZE</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">SGL_OFFSET_6</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2O_CMD_SYS_TAB_SET</span><span class="o">&lt;&lt;</span><span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="o">|</span> <span class="n">ADAPTER_TID</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">unit</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* Host 0 IOP ID (unit + 2) */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				   <span class="cm">/* Segment 0 */</span>

	<span class="cm">/* </span>
<span class="cm">	 * Provide three SGL-elements:</span>
<span class="cm">	 * System table (SysTab), Private memory space declaration and </span>
<span class="cm">	 * Private i/o space declaration  </span>
<span class="cm">	 */</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x54000000</span> <span class="o">|</span> <span class="n">sys_tbl_len</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sys_tbl_pa</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x54000000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD4000000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span><span class="o">=</span><span class="n">adpt_i2o_post_wait</span><span class="p">(</span><span class="n">pHba</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">120</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Unable to set SysTab (status=%#10x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">PINFO</span><span class="p">(</span><span class="s">&quot;%s: SysTab set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	
 <span class="p">}</span>


<span class="cm">/*============================================================================</span>
<span class="cm"> *</span>
<span class="cm"> *============================================================================</span>
<span class="cm"> */</span>


<span class="cp">#ifdef UARTDELAY </span>

<span class="k">static</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">adpt_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">millisec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">millisec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>	<span class="cm">/* delay for one millisecond */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;dpt_i2o&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;dpt_i2o&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>		<span class="o">=</span> <span class="n">adpt_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">adpt_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">adpt_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">adpt_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">adpt_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">adpt_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">adpt_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">adpt_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">adpt_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">MAX_TO_IOP_MESSAGES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">adpt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">error</span><span class="p">;</span>
	<span class="n">adpt_hba</span>	<span class="o">*</span><span class="n">pHba</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Loading Adaptec I2O RAID: Version &quot;</span> <span class="n">DPT_I2O_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">adpt_detect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_template</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba_chain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">pDev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">adpt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adpt_hba</span>	<span class="o">*</span><span class="n">pHba</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pHba</span> <span class="o">=</span> <span class="n">hba_chain</span><span class="p">;</span> <span class="n">pHba</span><span class="p">;</span> <span class="n">pHba</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">pHba</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">adpt_release</span><span class="p">(</span><span class="n">pHba</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">adpt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">adpt_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
