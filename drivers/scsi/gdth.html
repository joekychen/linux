<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › gdth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>gdth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/************************************************************************</span>
<span class="cm"> * Linux driver for                                                     *  </span>
<span class="cm"> * ICP vortex GmbH:    GDT ISA/EISA/PCI Disk Array Controllers          *</span>
<span class="cm"> * Intel Corporation:  Storage RAID Controllers                         *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * gdth.c                                                               *</span>
<span class="cm"> * Copyright (C) 1995-06 ICP vortex GmbH, Achim Leubner                 *</span>
<span class="cm"> * Copyright (C) 2002-04 Intel Corporation                              *</span>
<span class="cm"> * Copyright (C) 2003-06 Adaptec Inc.                                   *</span>
<span class="cm"> * &lt;achim_leubner@adaptec.com&gt;                                          *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * Additions/Fixes:                                                     *</span>
<span class="cm"> * Boji Tony Kannanthanam &lt;boji.t.kannanthanam@intel.com&gt;               *</span>
<span class="cm"> * Johannes Dinner &lt;johannes_dinner@adaptec.com&gt;                        *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify *</span>
<span class="cm"> * it under the terms of the GNU General Public License as published    *</span>
<span class="cm"> * by the Free Software Foundation; either version 2 of the License,    *</span>
<span class="cm"> * or (at your option) any later version.                               *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,      *</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of       *</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the         *</span>
<span class="cm"> * GNU General Public License for more details.                         *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License    *</span>
<span class="cm"> * along with this kernel; if not, write to the Free Software           *</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.            *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> * Linux kernel 2.6.x supported						*</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> ************************************************************************/</span>

<span class="cm">/* All GDT Disk Array Controllers are fully supported by this driver.</span>
<span class="cm"> * This includes the PCI/EISA/ISA SCSI Disk Array Controllers and the</span>
<span class="cm"> * PCI Fibre Channel Disk Array Controllers. See gdth.h for a complete</span>
<span class="cm"> * list of all controller types.</span>
<span class="cm"> * </span>
<span class="cm"> * If you have one or more GDT3000/3020 EISA controllers with </span>
<span class="cm"> * controller BIOS disabled, you have to set the IRQ values with the </span>
<span class="cm"> * command line option &quot;gdth=irq1,irq2,...&quot;, where the irq1,irq2,... are</span>
<span class="cm"> * the IRQ values for the EISA controllers.</span>
<span class="cm"> * </span>
<span class="cm"> * After the optional list of IRQ values, other possible </span>
<span class="cm"> * command line options are:</span>
<span class="cm"> * disable:Y                    disable driver</span>
<span class="cm"> * disable:N                    enable driver</span>
<span class="cm"> * reserve_mode:0               reserve no drives for the raw service</span>
<span class="cm"> * reserve_mode:1               reserve all not init., removable drives</span>
<span class="cm"> * reserve_mode:2               reserve all not init. drives</span>
<span class="cm"> * reserve_list:h,b,t,l,h,b,t,l,...     reserve particular drive(s) with </span>
<span class="cm"> *                              h- controller no., b- channel no., </span>
<span class="cm"> *                              t- target ID, l- LUN</span>
<span class="cm"> * reverse_scan:Y               reverse scan order for PCI controllers         </span>
<span class="cm"> * reverse_scan:N               scan PCI controllers like BIOS</span>
<span class="cm"> * max_ids:x                    x - target ID count per channel (1..MAXID)</span>
<span class="cm"> * rescan:Y                     rescan all channels/IDs </span>
<span class="cm"> * rescan:N                     use all devices found until now</span>
<span class="cm"> * hdr_channel:x                x - number of virtual bus for host drives</span>
<span class="cm"> * shared_access:Y              disable driver reserve/release protocol to </span>
<span class="cm"> *                              access a shared resource from several nodes, </span>
<span class="cm"> *                              appropriate controller firmware required</span>
<span class="cm"> * shared_access:N              enable driver reserve/release protocol</span>
<span class="cm"> * probe_eisa_isa:Y             scan for EISA/ISA controllers</span>
<span class="cm"> * probe_eisa_isa:N             do not scan for EISA/ISA controllers</span>
<span class="cm"> * force_dma32:Y                use only 32 bit DMA mode</span>
<span class="cm"> * force_dma32:N                use 64 bit DMA mode, if supported</span>
<span class="cm"> *</span>
<span class="cm"> * The default values are: &quot;gdth=disable:N,reserve_mode:1,reverse_scan:N,</span>
<span class="cm"> *                          max_ids:127,rescan:N,hdr_channel:0,</span>
<span class="cm"> *                          shared_access:Y,probe_eisa_isa:N,force_dma32:N&quot;.</span>
<span class="cm"> * Here is another example: &quot;gdth=reserve_list:0,1,2,0,0,1,3,0,rescan:Y&quot;.</span>
<span class="cm"> * </span>
<span class="cm"> * When loading the gdth driver as a module, the same options are available. </span>
<span class="cm"> * You can set the IRQs with &quot;IRQ=...&quot;. However, the syntax to specify the</span>
<span class="cm"> * options changes slightly. You must replace all &#39;,&#39; between options </span>
<span class="cm"> * with &#39; &#39; and all &#39;:&#39; with &#39;=&#39; and you must use </span>
<span class="cm"> * &#39;1&#39; in place of &#39;Y&#39; and &#39;0&#39; in place of &#39;N&#39;.</span>
<span class="cm"> * </span>
<span class="cm"> * Default: &quot;modprobe gdth disable=0 reserve_mode=1 reverse_scan=0</span>
<span class="cm"> *           max_ids=127 rescan=0 hdr_channel=0 shared_access=0</span>
<span class="cm"> *           probe_eisa_isa=0 force_dma32=0&quot;</span>
<span class="cm"> * The other example: &quot;modprobe gdth reserve_list=0,1,2,0,0,1,3,0 rescan=1&quot;.</span>
<span class="cm"> */</span>

<span class="cm">/* The meaning of the Scsi_Pointer members in this driver is as follows:</span>
<span class="cm"> * ptr:                     Chaining</span>
<span class="cm"> * this_residual:           unused</span>
<span class="cm"> * buffer:                  unused</span>
<span class="cm"> * dma_handle:              unused</span>
<span class="cm"> * buffers_residual:        unused</span>
<span class="cm"> * Status:                  unused</span>
<span class="cm"> * Message:                 unused</span>
<span class="cm"> * have_data_in:            unused</span>
<span class="cm"> * sent_command:            unused</span>
<span class="cm"> * phase:                   unused</span>
<span class="cm"> */</span>


<span class="cm">/* interrupt coalescing */</span>
<span class="cm">/* #define INT_COAL */</span>

<span class="cm">/* statistics */</span>
<span class="cp">#define GDTH_STATISTICS</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#ifdef GDTH_RTC</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;gdth.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">gdth_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_eval_mapping</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cyls</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">heads</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">secs</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">gdth_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">__gdth_interrupt</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
                                    <span class="kt">int</span> <span class="n">gdth_from_wait</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">pIndex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_sync_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">service</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
                                                               <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_async_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_log_event</span><span class="p">(</span><span class="n">gdth_evt_data</span> <span class="o">*</span><span class="n">dvr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_putq</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">priority</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_next</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_fill_raw_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_special_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">);</span>
<span class="k">static</span> <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">gdth_store_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u16</span> <span class="n">source</span><span class="p">,</span>
                                      <span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gdth_evt_data</span> <span class="o">*</span><span class="n">evt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_read_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">,</span> <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">estr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_readapp_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u8</span> <span class="n">application</span><span class="p">,</span> 
                               <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">estr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_clear_events</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
                                    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u16</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_internal_cache_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hdrive</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_enable_int</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_wait</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span><span class="n">u32</span> <span class="n">time</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u8</span> <span class="n">service</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span>
                                             <span class="n">u32</span> <span class="n">p1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p2</span><span class="p">,</span><span class="n">u64</span> <span class="n">p3</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_search_drives</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_analyse_hdrive</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hdrive</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gdth_ctr_name</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">gdth_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_flush</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__gdth_queuecommand</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_GDTH</span>
<span class="k">static</span> <span class="n">u8</span>   <span class="n">DebugState</span> <span class="o">=</span> <span class="n">DEBUG_GDTH</span><span class="p">;</span>

<span class="cp">#ifdef __SERIAL__</span>
<span class="cp">#define MAX_SERBUF 160</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ser_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ser_puts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ser_putc</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ser_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">strbuf</span><span class="p">[</span><span class="n">MAX_SERBUF</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="cp">#ifdef __COM2__</span>
<span class="cp">#define COM_BASE 0x2f8</span>
<span class="cp">#else</span>
<span class="cp">#define COM_BASE 0x3f8</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ser_init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">port</span><span class="o">=</span><span class="n">COM_BASE</span><span class="p">;</span>

    <span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="cm">/* 19200 Baud, if 9600: outb(12,port) */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">    ser_putc(&#39;I&#39;);</span>
<span class="cm">    ser_putc(&#39; &#39;);</span>
<span class="cm">    */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ser_puts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="n">ser_init</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span><span class="o">=</span><span class="n">str</span><span class="p">;</span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span><span class="o">++</span><span class="n">ptr</span><span class="p">)</span>
        <span class="n">ser_putc</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ser_putc</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">port</span><span class="o">=</span><span class="n">COM_BASE</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="mh">0x0a</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ser_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">fmt</span><span class="p">);</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span><span class="n">fmt</span><span class="p">,</span><span class="n">args</span><span class="p">);</span>
    <span class="n">ser_puts</span><span class="p">(</span><span class="n">strbuf</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TRACE(a)    {if (DebugState==1) {ser_printk a;}}</span>
<span class="cp">#define TRACE2(a)   {if (DebugState==1 || DebugState==2) {ser_printk a;}}</span>
<span class="cp">#define TRACE3(a)   {if (DebugState!=0) {ser_printk a;}}</span>

<span class="cp">#else </span><span class="cm">/* !__SERIAL__ */</span><span class="cp"></span>
<span class="cp">#define TRACE(a)    {if (DebugState==1) {printk a;}}</span>
<span class="cp">#define TRACE2(a)   {if (DebugState==1 || DebugState==2) {printk a;}}</span>
<span class="cp">#define TRACE3(a)   {if (DebugState!=0) {printk a;}}</span>
<span class="cp">#endif</span>

<span class="cp">#else </span><span class="cm">/* !DEBUG */</span><span class="cp"></span>
<span class="cp">#define TRACE(a)</span>
<span class="cp">#define TRACE2(a)</span>
<span class="cp">#define TRACE3(a)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">max_rq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_sg</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INT_COAL</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">max_int_coal</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">act_ints</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">act_ios</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">act_stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">act_rq</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">gdth_timer</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define PTR2USHORT(a)   (u16)(unsigned long)(a)</span>
<span class="cp">#define GDTOFFSOF(a,b)  (size_t)&amp;(((a*)0)-&gt;b)</span>
<span class="cp">#define INDEX_OK(i,t)   ((i)&lt;ARRAY_SIZE(t))</span>

<span class="cp">#define BUS_L2P(a,b)    ((b)&gt;(a)-&gt;virt_bus ? (b-1):(b))</span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="n">u8</span>   <span class="n">gdth_drq_tab</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">};</span>            <span class="cm">/* DRQ table */</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_EISA) || defined(CONFIG_ISA)</span>
<span class="k">static</span> <span class="n">u8</span>   <span class="n">gdth_irq_tab</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>    <span class="cm">/* IRQ table */</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">u8</span>   <span class="n">gdth_polling</span><span class="p">;</span>                           <span class="cm">/* polling if TRUE */</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">gdth_ctr_count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                    <span class="cm">/* controller count */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">gdth_instances</span><span class="p">);</span>                       <span class="cm">/* controller list */</span>
<span class="k">static</span> <span class="n">u8</span>   <span class="n">gdth_write_through</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>             <span class="cm">/* write through */</span>
<span class="k">static</span> <span class="n">gdth_evt_str</span> <span class="n">ebuffer</span><span class="p">[</span><span class="n">MAX_EVENTS</span><span class="p">];</span>                <span class="cm">/* event buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">elastidx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eoldidx</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">major</span><span class="p">;</span>

<span class="cp">#define DIN     1                               </span><span class="cm">/* IN data direction */</span><span class="cp"></span>
<span class="cp">#define DOU     2                               </span><span class="cm">/* OUT data direction */</span><span class="cp"></span>
<span class="cp">#define DNO     DIN                             </span><span class="cm">/* no data transfer */</span><span class="cp"></span>
<span class="cp">#define DUN     DIN                             </span><span class="cm">/* unknown data direction */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">gdth_direction_tab</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span>
    <span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span>
    <span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span>
    <span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span>
    <span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DNO</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DIN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DOU</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span>
    <span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span><span class="p">,</span><span class="n">DUN</span>
<span class="p">};</span>

<span class="cm">/* LILO and modprobe/insmod parameters */</span>
<span class="cm">/* IRQ list for GDT3000/3020 EISA controllers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">MAXHA</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> 
<span class="p">{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
<span class="cm">/* disable driver flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* reserve flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reserve_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                  
<span class="cm">/* reserve list */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">MAX_RES_ARGS</span><span class="p">]</span> <span class="o">=</span> 
<span class="p">{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
<span class="cm">/* scan order for PCI controllers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reverse_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* virtual channel for the host drives */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdr_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* max. IDs per channel */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_ids</span> <span class="o">=</span> <span class="n">MAXID</span><span class="p">;</span>
<span class="cm">/* rescan all IDs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rescan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* shared access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">shared_access</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* enable support for EISA and ISA controllers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probe_eisa_isa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* 64 bit DMA mode, support for drives &gt; 2 TB, if force_dma32 = 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">force_dma32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* parameters for modprobe/insmod */</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reserve_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">reserve_list</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reverse_scan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hdr_channel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_ids</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rescan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">shared_access</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">probe_eisa_isa</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_dma32</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Achim Leubner&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* ioctl interface */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gdth_fops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">unlocked_ioctl</span>   <span class="o">=</span> <span class="n">gdth_unlocked_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">gdth_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gdth_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#include &quot;gdth_proc.h&quot;</span>
<span class="cp">#include &quot;gdth_proc.c&quot;</span>

<span class="k">static</span> <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="nf">gdth_find_ha</span><span class="p">(</span><span class="kt">int</span> <span class="n">hanum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hanum</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ha</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="nf">gdth_get_cmndinfo</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmndinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmndinfo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">));</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_put_cmndinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">milliseconds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">mdelay</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_scsi_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">internal_command</span> <span class="o">=</span> <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>

	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_scsi_done()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">gdth_put_cmndinfo</span><span class="p">(</span><span class="n">cmndinfo</span><span class="p">);</span>
	<span class="n">scp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">((</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scp</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__gdth_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">gdtcmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">,</span>
                   <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
    <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="n">cmndinfo</span><span class="p">;</span>
    <span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

    <span class="n">scp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scp</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmndinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmndinfo</span><span class="p">));</span>

    <span class="cm">/* use request field to save the ptr. to completion struct. */</span>
    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">IOCTL_PRI</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="p">.</span><span class="n">internal_cmd_str</span> <span class="o">=</span> <span class="n">gdtcmd</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="p">.</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;__gdth_execute() cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="n">__gdth_queuecommand</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmndinfo</span><span class="p">);</span>

    <span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

    <span class="n">rval</span> <span class="o">=</span> <span class="n">cmndinfo</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">cmndinfo</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gdth_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">gdtcmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">,</span>
                 <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_get_host_dev</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">gdtcmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

    <span class="n">scsi_free_host_dev</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_eval_mapping</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cyls</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">heads</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">secs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">*</span><span class="n">cyls</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span><span class="n">HEADS</span><span class="o">/</span><span class="n">SECS</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cyls</span> <span class="o">&lt;=</span> <span class="n">MAXCYLS</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">heads</span> <span class="o">=</span> <span class="n">HEADS</span><span class="p">;</span>
        <span class="o">*</span><span class="n">secs</span> <span class="o">=</span> <span class="n">SECS</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                        <span class="cm">/* too high for 64*32 */</span>
        <span class="o">*</span><span class="n">cyls</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span><span class="n">MEDHEADS</span><span class="o">/</span><span class="n">MEDSECS</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cyls</span> <span class="o">&lt;=</span> <span class="n">MAXCYLS</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">heads</span> <span class="o">=</span> <span class="n">MEDHEADS</span><span class="p">;</span>
            <span class="o">*</span><span class="n">secs</span> <span class="o">=</span> <span class="n">MEDSECS</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                    <span class="cm">/* too high for 127*63 */</span>
            <span class="o">*</span><span class="n">cyls</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span><span class="n">BIGHEADS</span><span class="o">/</span><span class="n">BIGSECS</span><span class="p">;</span>
            <span class="o">*</span><span class="n">heads</span> <span class="o">=</span> <span class="n">BIGHEADS</span><span class="p">;</span>
            <span class="o">*</span><span class="n">secs</span> <span class="o">=</span> <span class="n">BIGSECS</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* controller search and initialization functions */</span>
<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_search_eisa</span><span class="p">(</span><span class="n">u16</span> <span class="n">eisa_adr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
    
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_search_eisa() adr. %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eisa_adr</span><span class="p">));</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">ID0REG</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">GDT3A_ID</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">GDT3B_ID</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* GDT3000A or GDT3000B */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EISAREG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>   
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                           <span class="cm">/* not EISA configured */</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">GDT3_ID</span><span class="p">)</span>                          <span class="cm">/* GDT3000 */</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                   
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_EISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_search_isa</span><span class="p">(</span><span class="n">u32</span> <span class="n">bios_adr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_search_isa() bios adr. %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bios_adr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">bios_adr</span><span class="o">+</span><span class="n">BIOS_ID_OFFS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
        <span class="n">iounmap</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">GDT2_ID</span><span class="p">)</span>                          <span class="cm">/* GDT2000 */</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gdth_search_vortex</span><span class="p">(</span><span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6555</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6x17RP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDTMAXRP</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDTNEWRX</span> <span class="o">||</span>
	    <span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDTNEWRX2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_pci_probe_one</span><span class="p">(</span><span class="n">gdth_pci_str</span> <span class="o">*</span><span class="n">pcistr</span><span class="p">,</span> <span class="n">gdth_ha_str</span> <span class="o">**</span><span class="n">ha_out</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdth_pci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_pci_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdth_remove_one</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>

<span class="cm">/* Vortex only makes RAID controllers.</span>
<span class="cm"> * We do not really want to specify all 550 ids here, so wildcard match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">gdthtable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VORTEX</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_SRC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_SRC_XSCALE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">gdthtable</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">gdth_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gdth&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">gdthtable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">gdth_pci_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">gdth_pci_remove_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">gdth_pci_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">gdth_remove_one</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdth_pci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base0</span><span class="p">,</span> <span class="n">base1</span><span class="p">,</span> <span class="n">base2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">gdth_pci_str</span> <span class="n">gdth_pcistr</span><span class="p">;</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    
	<span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_search_dev() cnt %d vendor %x device %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">gdth_ctr_count</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_pcistr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_pcistr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_VORTEX</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gdth_search_vortex</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdth_ctr_count</span> <span class="o">&gt;=</span> <span class="n">MAXHA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

        <span class="cm">/* GDT PCI controller found, resources are already in pdev */</span>
	<span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
        <span class="n">base0</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">base1</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">base2</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6000B</span> <span class="o">||</span>   <span class="cm">/* GDT6000/B */</span>
            <span class="n">device</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6x17RP</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* MPR */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">base0</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	    <span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">dpmem</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                  <span class="cm">/* GDT6110, GDT6120, .. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">base0</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
                <span class="o">!</span><span class="p">(</span><span class="n">base2</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">||</span>
                <span class="o">!</span><span class="p">(</span><span class="n">base1</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	    <span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">dpmem</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	    <span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">io</span>    <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Controller found at %d/%d, irq %d, dpmem 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
		<span class="n">gdth_pcistr</span><span class="p">.</span><span class="n">dpmem</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">gdth_pci_probe_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_pcistr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_init_eisa</span><span class="p">(</span><span class="n">u16</span> <span class="n">eisa_adr</span><span class="p">,</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">retries</span><span class="p">,</span><span class="n">id</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">prot_ver</span><span class="p">,</span><span class="n">eisacf</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">irq_found</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_init_eisa() adr. %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eisa_adr</span><span class="p">));</span>
    
    <span class="cm">/* disable board interrupts, deinitialize services */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDOORREG</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDENABREG</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EINTENABREG</span><span class="p">);</span>
    
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">LDOORREG</span><span class="p">);</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
    <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDOORREG</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;wait for DEINIT: retries=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">retries</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">prot_ver</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDOORREG</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">!=</span> <span class="n">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Illegal protocol version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">=</span> <span class="n">eisa_adr</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">eisa_adr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>

    <span class="cm">/* detect IRQ */</span> 
    <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">ID0REG</span><span class="p">))</span> <span class="o">==</span> <span class="n">GDT3_ID</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">OEM_ID_ICP</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_EISA</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">outl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">LDOORREG</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDOORREG</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Initialization error (get IRQ failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">MAILBOXREG</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EDOORREG</span><span class="p">);</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;GDT3000/3020: IRQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
        <span class="cm">/* check the result */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Unknown IRQ, use IRQ table from cmd line !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq_found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span> 
                     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXHA</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">10</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">11</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span> <span class="o">||</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">irq_found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">irq_found</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Can not detect controller IRQ,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Use IRQ setting from command line (IRQ = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Initialization error (unknown IRQ), Enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;the controller BIOS or use command line parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">eisacf</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">eisa_adr</span><span class="o">+</span><span class="n">EISAREG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eisacf</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>                         <span class="cm">/* level triggered */</span>
            <span class="n">eisacf</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gdth_irq_tab</span><span class="p">[</span><span class="n">eisacf</span><span class="p">];</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">OEM_ID_ICP</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_EISA</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_EISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_init_isa</span><span class="p">(</span><span class="n">u32</span> <span class="n">bios_adr</span><span class="p">,</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp2_ptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">irq_drq</span><span class="p">,</span><span class="n">prot_ver</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">retries</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_init_isa() bios adr. %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bios_adr</span><span class="p">));</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">bios_adr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt2_dpram_str</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dp2_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">memlock</span><span class="p">);</span> <span class="cm">/* switch off write protection */</span>
    <span class="cm">/* reset interface area */</span>
    <span class="n">memset_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Initialization error (DPMEM write error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* disable board interrupts, read DRQ and IRQ */</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqen</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>

    <span class="n">irq_drq</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">rq</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">irq_drq</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">irq_drq</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span> <span class="o">=</span> <span class="n">gdth_drq_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="n">irq_drq</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">rq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">irq_drq</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">irq_drq</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gdth_irq_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="cm">/* deinitialize services */</span>
    <span class="n">writel</span><span class="p">(</span><span class="n">bios_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
    <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">prot_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">!=</span> <span class="n">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Illegal protocol version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">OEM_ID_ICP</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_ISA</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span><span class="o">=</span> <span class="n">GDT2_ID</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span> <span class="o">=</span> <span class="n">bios_adr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

    <span class="cm">/* special request to controller BIOS */</span>
    <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
    <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Initialization error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdth_init_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gdth_pci_str</span> <span class="o">*</span><span class="n">pcistr</span><span class="p">,</span>
				   <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6_ptr</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">gdt6c_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6c_ptr</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6m_ptr</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">retries</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">prot_ver</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_init_pci()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">)</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">OEM_ID_INTEL</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">OEM_ID_ICP</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">);</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6000B</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* GDT6000/B */</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci() dpmem %lx irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6_dpram_str</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* check and reset interface area */</span>
        <span class="n">dp6_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Cannot access DPMEM at 0x%lx (shadowed?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                   <span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">);</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xC8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xE8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci_old() address 0x%x busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6_dpram_str</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">dp6_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Use free address at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>   
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: No free address found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">memset_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM write error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/* disable board interrupts, deinit services */</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqen</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>

        <span class="n">writel</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">prot_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">!=</span> <span class="n">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Illegal protocol version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_PCI</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
        
        <span class="cm">/* special command to controller BIOS */</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>

        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6555</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* GDT6110, ... */</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdt6c_plx_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">;</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci_new() dpmem %lx irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6c_dpram_str</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* check and reset interface area */</span>
        <span class="n">dp6c_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Cannot access DPMEM at 0x%lx (shadowed?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                   <span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">);</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xC8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xE8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci_plx() address 0x%x busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6c_dpram_str</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">dp6c_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Use free address at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>   
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: No free address found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">memset_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM write error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/* disable board interrupts, deinit services */</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">control1</span><span class="p">));</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">edoor_reg</span><span class="p">));</span>
        
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>

        <span class="n">writel</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>

        <span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">ldoor_reg</span><span class="p">));</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">prot_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">!=</span> <span class="n">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Illegal protocol version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_PCINEW</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>

        <span class="cm">/* special command to controller BIOS */</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        
        <span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">ldoor_reg</span><span class="p">));</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>

        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                            <span class="cm">/* MPR */</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci_mpr() dpmem %lx irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6m_dpram_str</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* manipulate config. space to enable DPMEM, start RP controller */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
        <span class="n">command</span> <span class="o">|=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1UL</span><span class="p">)</span>
	    <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mh">0xFEFF0001UL</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span>
			       <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
        
        <span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>

        <span class="cm">/* Ensure that it is safe to access the non HW portions of DPMEM.</span>
<span class="cm">         * Aditional check needed for Xscale based RAID controllers */</span>
        <span class="k">while</span><span class="p">(</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">sema0_reg</span><span class="p">)</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">)</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        
        <span class="cm">/* check and reset interface area */</span>
        <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Cannot access DPMEM at 0x%lx (shadowed?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                   <span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">);</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xC8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xE8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;init_pci_mpr() address 0x%x busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdt6m_dpram_str</span><span class="p">));</span> 
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DPMEM remap error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">DPMEM_MAGIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="n">DPMEM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Use free address at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>   
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: No free address found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">memset_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">));</span>
        
        <span class="cm">/* disable board interrupts, deinit services */</span>
        <span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_en_reg</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_en_reg</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_reg</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>

        <span class="n">writel</span><span class="p">(</span><span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">dpmem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">ldoor_reg</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">prot_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">!=</span> <span class="n">PROTOCOL_VERSION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Illegal protocol version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GDT_PCIMPR</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
        
        <span class="cm">/* special command to controller BIOS */</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">ldoor_reg</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>

        <span class="cm">/* read FW version to detect 64-bit DMA support */</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Cmd_Indx</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">ldoor_reg</span><span class="p">);</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xfd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Initialization error (DEINIT failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">prot_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">S_Status</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prot_ver</span> <span class="o">&lt;</span> <span class="mh">0x2b</span><span class="p">)</span>      <span class="cm">/* FW &lt; x.43: no 64-bit DMA support */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> 
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cm">/* controller protocol functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">gdth_enable_int</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp2_ptr</span><span class="p">;</span>
    <span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6_ptr</span><span class="p">;</span>
    <span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6m_ptr</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_enable_int() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">EDOORREG</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">EDENABREG</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">EINTENABREG</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp2_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqen</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp6_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqen</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">edoor_reg</span><span class="p">));</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">control1</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_reg</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_en_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">4</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_en_reg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* return IStatus if interrupt was from this card else 0 */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">gdth_get_status</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">IStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_get_status() irq %d ctr_count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">gdth_ctr_count</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span>
            <span class="n">IStatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">EDOORREG</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span>
            <span class="n">IStatus</span> <span class="o">=</span>
                <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span>
            <span class="n">IStatus</span> <span class="o">=</span>
                <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> 
            <span class="n">IStatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">edoor_reg</span><span class="p">));</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span>
            <span class="n">IStatus</span> <span class="o">=</span>
                <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_reg</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">IStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_test_busy</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="kt">int</span> <span class="n">gdtsema0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_test_busy() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span>
        <span class="n">gdtsema0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">SEMA0REG</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span>
        <span class="n">gdtsema0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Sema0</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span>
        <span class="n">gdtsema0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Sema0</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> 
        <span class="n">gdtsema0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">sema0_reg</span><span class="p">));</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span>
        <span class="n">gdtsema0</span> <span class="o">=</span> 
            <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">sema0_reg</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">gdtsema0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_get_cmd_index</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_get_cmd_index() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">==</span> <span class="n">UNUSED_CMND</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">service</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">CommandIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_set_sema0</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_set_sema0() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">SEMA0REG</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Sema0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Sema0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> <span class="p">{</span> 
        <span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">sema0_reg</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">sema0_reg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_copy_command</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmd_ptr</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6m_ptr</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">gdt6c_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6c_ptr</span><span class="p">;</span>
    <span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6_ptr</span><span class="p">;</span>
    <span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp2_ptr</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">cp_count</span><span class="p">,</span><span class="n">dp_offset</span><span class="p">,</span><span class="n">cmd_no</span><span class="p">;</span>
    
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_copy_command() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

    <span class="n">cp_count</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
    <span class="n">dp_offset</span><span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span><span class="p">;</span>
    <span class="n">cmd_no</span>   <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">;</span>
    <span class="n">cmd_ptr</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>

    <span class="o">++</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="p">;</span>                                                      
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>                                 <span class="cm">/* no DPMEM, no copy */</span>

    <span class="cm">/* set cpcount dword aligned */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cp_count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">cp_count</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">cp_count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">+=</span> <span class="n">cp_count</span><span class="p">;</span>
    
    <span class="cm">/* set offset and service, copy command to DPMEM */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp2_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">dp_offset</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">serv_id</span><span class="p">);</span>
        <span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">gdt_dpr_cmd</span><span class="p">[</span><span class="n">dp_offset</span><span class="p">],</span><span class="n">cmd_ptr</span><span class="p">,</span><span class="n">cp_count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp6_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">dp_offset</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">serv_id</span><span class="p">);</span>
        <span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">gdt_dpr_cmd</span><span class="p">[</span><span class="n">dp_offset</span><span class="p">],</span><span class="n">cmd_ptr</span><span class="p">,</span><span class="n">cp_count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp6c_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">dp_offset</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">serv_id</span><span class="p">);</span>
        <span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6c_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">gdt_dpr_cmd</span><span class="p">[</span><span class="n">dp_offset</span><span class="p">],</span><span class="n">cmd_ptr</span><span class="p">,</span><span class="n">cp_count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">dp_offset</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">comm_queue</span><span class="p">[</span><span class="n">cmd_no</span><span class="p">].</span><span class="n">serv_id</span><span class="p">);</span>
        <span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">gdt_dpr_cmd</span><span class="p">[</span><span class="n">dp_offset</span><span class="p">],</span><span class="n">cmd_ptr</span><span class="p">,</span><span class="n">cp_count</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_release_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_release_event() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
    <span class="p">{</span>
        <span class="n">u32</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">!=</span> <span class="n">UNUSED_CMND</span><span class="p">)</span>
                <span class="o">++</span><span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_index</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">TRACE3</span><span class="p">((</span><span class="s">&quot;GDT: max_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="n">i</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_INIT</span><span class="p">)</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_INIT</span><span class="p">)</span>               <span class="cm">/* store DMA buffer */</span>
            <span class="n">outl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">MAILBOXREG</span><span class="p">);</span>
        <span class="n">outb</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="o">-&gt;</span><span class="n">Service</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">LDOORREG</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> <span class="p">{</span> 
        <span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">ldoor_reg</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">ldoor_reg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_wait</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">answer_found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">wait_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_wait() hanum %d index %d time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">time</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>                               <span class="cm">/* no wait required */</span>

    <span class="k">do</span> <span class="p">{</span>
	<span class="n">__gdth_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait_index</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wait_index</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">answer_found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">time</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">answer_found</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_internal_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u8</span> <span class="n">service</span><span class="p">,</span> <span class="n">u16</span> <span class="n">opcode</span><span class="p">,</span>
                                            <span class="n">u32</span> <span class="n">p1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">p3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmd_ptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span><span class="n">index</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_internal_cmd() service %d opcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">service</span><span class="p">,</span><span class="n">opcode</span><span class="p">));</span>

    <span class="n">cmd_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">cmd_ptr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">));</span>

    <span class="cm">/* make command  */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="n">INIT_RETRIES</span><span class="p">;;)</span> <span class="p">{</span>
        <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">Service</span>          <span class="o">=</span> <span class="n">service</span><span class="p">;</span>
        <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span>    <span class="o">=</span> <span class="n">INTERNAL_CMND</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;GDT: No free command index found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
        <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">OpCode</span>           <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
        <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">BoardNode</span>        <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">GDT_IOCTL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">subfunc</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">param_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">p3</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">p_param</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">p1</span><span class="p">;</span>
                    <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span>  <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">p1</span><span class="p">;</span>
                    <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">SCSIRAWSERVICE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">direction</span>  <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">bus</span>        <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">target</span>     <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">p3</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">lun</span>        <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">p3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">direction</span>  <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">bus</span>        <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">target</span>     <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">p3</span><span class="p">;</span>
                <span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">lun</span>        <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">p3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">SCREENSERVICE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">GDT_REALTIME</span><span class="p">)</span> <span class="p">{</span>
                <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
                <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">p2</span><span class="p">;</span>
                <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">p3</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span>          <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">);</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
        <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">INIT_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT: Initialization error (timeout service %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">service</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">S_BSY</span> <span class="o">||</span> <span class="o">--</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>   
    <span class="p">}</span>   
    
    <span class="k">return</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">S_OK</span> <span class="o">?</span> <span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
    

<span class="cm">/* search for devices */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdth_search_drives</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u16</span> <span class="n">cdev_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">bus_no</span><span class="p">,</span> <span class="n">drv_cnt</span><span class="p">,</span> <span class="n">drv_no</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">gdth_getch_str</span> <span class="o">*</span><span class="n">chn</span><span class="p">;</span>
    <span class="n">gdth_drlist_str</span> <span class="o">*</span><span class="n">drl</span><span class="p">;</span>
    <span class="n">gdth_iochan_str</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
    <span class="n">gdth_raw_iochan_str</span> <span class="o">*</span><span class="n">iocr</span><span class="p">;</span>
    <span class="n">gdth_arcdl_str</span> <span class="o">*</span><span class="n">alst</span><span class="p">;</span>
    <span class="n">gdth_alist_str</span> <span class="o">*</span><span class="n">alst2</span><span class="p">;</span>
    <span class="n">gdth_oem_str_ioctl</span> <span class="o">*</span><span class="n">oemstr</span><span class="p">;</span>
<span class="cp">#ifdef INT_COAL</span>
    <span class="n">gdth_perf_modes</span> <span class="o">*</span><span class="n">pmod</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef GDTH_RTC</span>
    <span class="n">u8</span> <span class="n">rtc</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#endif     </span>
   
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_search_drives() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* initialize controller services, at first: screen service */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">screen_feat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_dma32</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCREENSERVICE</span><span class="p">,</span> <span class="n">GDT_X_INIT_SCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">screen_feat</span> <span class="o">=</span> <span class="n">GDT_64BIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">force_dma32</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">S_NOFUNC</span><span class="p">))</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCREENSERVICE</span><span class="p">,</span> <span class="n">GDT_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Initialization error screen service (code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): SCREENSERVICE initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="cp">#ifdef GDTH_RTC</span>
    <span class="cm">/* read realtime clock info, send to controller */</span>
    <span class="cm">/* 1. wait for the falling edge of update flag */</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_FREQ_SELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RTC_UIP</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="n">RTC_FREQ_SELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RTC_UIP</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="cm">/* 2. read info */</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> 
            <span class="n">rtc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rtc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): RTC: %x/%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">8</span><span class="p">]));</span>
    <span class="cm">/* 3. send to controller firmware */</span>
    <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCREENSERVICE</span><span class="p">,</span> <span class="n">GDT_REALTIME</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rtc</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
<span class="cp">#endif  </span>
 
    <span class="cm">/* unfreeze all IOs */</span>
    <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_UNFREEZE_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 
    <span class="cm">/* initialize cache service */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_dma32</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_X_INIT_HOST</span><span class="p">,</span> <span class="n">LINUX_OS</span><span class="p">,</span>
                                                                         <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">=</span> <span class="n">GDT_64BIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">force_dma32</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">S_NOFUNC</span><span class="p">))</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_INIT</span><span class="p">,</span> <span class="n">LINUX_OS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Initialization error cache service (code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): CACHESERVICE initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="n">cdev_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_vers</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">;</span>

<span class="cp">#ifdef INT_COAL</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* set perf. modes */</span>
        <span class="n">pmod</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_perf_modes</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">version</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_mode</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="cm">/* enable one status buffer */</span>
        <span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_addr1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_indx1</span>    <span class="o">=</span> <span class="n">COALINDEX</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_addr2</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_u_addr2</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_indx2</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">st_buff_size</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_mode</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// disable all cmd buffers</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_addr1</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_u_addr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_indx1</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_addr2</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_u_addr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_indx2</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">cmd_buff_size</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">reserved1</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            
        <span class="n">pmod</span><span class="o">-&gt;</span><span class="n">reserved2</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">SET_PERF_MODES</span><span class="p">,</span>
                              <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_perf_modes</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Interrupt coalescing activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="cm">/* detect number of buses - try new IOCTL */</span>
    <span class="n">iocr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_raw_iochan_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
    <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span>        <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
    <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">list_entries</span>   <span class="o">=</span> <span class="n">MAXBUS</span><span class="p">;</span>
    <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_chan</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_chan</span>      <span class="o">=</span> <span class="n">MAXBUS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">list_offset</span>    <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_raw_iochan_str</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">IOCHAN_RAW_DESC</span><span class="p">,</span>
                          <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_raw_iochan_str</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;IOCHAN_RAW_DESC supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span> <span class="o">=</span> <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">chan_count</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus_no</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iocr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">proc_id</span> <span class="o">&lt;</span> <span class="n">MAXID</span><span class="p">)</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">[</span><span class="n">bus_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">iocr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">proc_id</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">[</span><span class="n">bus_no</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* old method */</span>
        <span class="n">chn</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_getch_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus_no</span> <span class="o">&lt;</span> <span class="n">MAXBUS</span><span class="p">;</span> <span class="o">++</span><span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">chn</span><span class="o">-&gt;</span><span class="n">channel_no</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                                   <span class="n">SCSI_CHAN_CNT</span> <span class="o">|</span> <span class="n">L_CTRL_PATTERN</span><span class="p">,</span>
                                   <span class="n">IO_CHANNEL</span> <span class="o">|</span> <span class="n">INVALID_CHANNEL</span><span class="p">,</span>
                                   <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_getch_str</span><span class="p">)))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Error detecting channel count (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">chn</span><span class="o">-&gt;</span><span class="n">siop_id</span> <span class="o">&lt;</span> <span class="n">MAXID</span><span class="p">)</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">[</span><span class="n">bus_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">chn</span><span class="o">-&gt;</span><span class="n">siop_id</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">[</span><span class="n">bus_no</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="p">}</span>       
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">bus_no</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives() %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">));</span>

    <span class="cm">/* read cache configuration */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">CACHE_INFO</span><span class="p">,</span>
                           <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cinfo_str</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Initialization error cache service (code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span> <span class="o">=</span> <span class="p">((</span><span class="n">gdth_cinfo_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">;</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives() cinfo: vs %x sta %d str %d dw %d b %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">.</span><span class="n">version</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">.</span><span class="n">state</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">.</span><span class="n">strategy</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">.</span><span class="n">write_back</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cpar</span><span class="p">.</span><span class="n">block_size</span><span class="p">));</span>

    <span class="cm">/* read board info and features */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">more_proc</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">BOARD_INFO</span><span class="p">,</span>
                          <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_binfo_str</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">,</span> <span class="p">(</span><span class="n">gdth_binfo_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">,</span>
               <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_binfo_str</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">BOARD_FEATURES</span><span class="p">,</span>
                              <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_bfeat_str</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;BOARD_INFO/BOARD_FEATURES supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bfeat</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">gdth_bfeat_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">more_proc</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;BOARD_INFO requires firmware &gt;= 1.10/2.08</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">.</span><span class="n">type_string</span><span class="p">,</span> <span class="n">gdth_ctr_name</span><span class="p">(</span><span class="n">ha</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Controller name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">.</span><span class="n">type_string</span><span class="p">));</span>

    <span class="cm">/* read more informations */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">more_proc</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* physical drives, channel addresses */</span>
        <span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_iochan_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
        <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span>        <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
        <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">list_entries</span>   <span class="o">=</span> <span class="n">MAXBUS</span><span class="p">;</span>
        <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_chan</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">last_chan</span>      <span class="o">=</span> <span class="n">MAXBUS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">list_offset</span>    <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_iochan_str</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">IOCHAN_DESC</span><span class="p">,</span>
                              <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_iochan_str</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus_no</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">local_no</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">local_no</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus_no</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">IO_CHANNEL</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">local_no</span> <span class="o">=</span> <span class="n">bus_no</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">bus_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus_no</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">chn</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_getch_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
            <span class="n">chn</span><span class="o">-&gt;</span><span class="n">channel_no</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">local_no</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                                  <span class="n">SCSI_CHAN_CNT</span> <span class="o">|</span> <span class="n">L_CTRL_PATTERN</span><span class="p">,</span>
                                  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">address</span> <span class="o">|</span> <span class="n">INVALID_CHANNEL</span><span class="p">,</span>
                                  <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_getch_str</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">pdev_cnt</span> <span class="o">=</span> <span class="n">chn</span><span class="o">-&gt;</span><span class="n">drive_cnt</span><span class="p">;</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Channel %d: %d phys. drives</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">bus_no</span><span class="p">,</span><span class="n">chn</span><span class="o">-&gt;</span><span class="n">drive_cnt</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">pdev_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">drl</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_drlist_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
                <span class="n">drl</span><span class="o">-&gt;</span><span class="n">sc_no</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">local_no</span><span class="p">;</span>
                <span class="n">drl</span><span class="o">-&gt;</span><span class="n">sc_cnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">pdev_cnt</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                                      <span class="n">SCSI_DR_LIST</span> <span class="o">|</span> <span class="n">L_CTRL_PATTERN</span><span class="p">,</span>
                                      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">address</span> <span class="o">|</span> <span class="n">INVALID_CHANNEL</span><span class="p">,</span>
                                      <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_drlist_str</span><span class="p">)))</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">pdev_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> 
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">id_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">drl</span><span class="o">-&gt;</span><span class="n">sc_list</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">bus_no</span><span class="p">].</span><span class="n">pdev_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* logical drives */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">CACHE_DRV_CNT</span><span class="p">,</span>
                              <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">drv_cnt</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span> <span class="n">CACHE_DRV_LIST</span><span class="p">,</span>
                                  <span class="n">INVALID_CHANNEL</span><span class="p">,</span><span class="n">drv_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">drv_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">drv_no</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">drv_no</span> <span class="o">&lt;</span> <span class="n">MAX_LDRIVES</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">drv_no</span><span class="p">].</span><span class="n">is_logdrv</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Drive %d is log. drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">drv_no</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">alst</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_arcdl_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
            <span class="n">alst</span><span class="o">-&gt;</span><span class="n">entries_avail</span> <span class="o">=</span> <span class="n">MAX_LDRIVES</span><span class="p">;</span>
            <span class="n">alst</span><span class="o">-&gt;</span><span class="n">first_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list_offset</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_arcdl_str</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                                  <span class="n">ARRAY_DRV_LIST2</span> <span class="o">|</span> <span class="n">LA_CTRL_PATTERN</span><span class="p">,</span> 
                                  <span class="n">INVALID_CHANNEL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_arcdl_str</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="p">(</span><span class="n">alst</span><span class="o">-&gt;</span><span class="n">entries_avail</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_alist_str</span><span class="p">)))</span> <span class="p">{</span> 
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">entries_init</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_arraydrv</span> <span class="o">=</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_arrayd</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_master</span> <span class="o">=</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_master</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_parity</span> <span class="o">=</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_parity</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_hotfix</span> <span class="o">=</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_hotfix</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">master_no</span> <span class="o">=</span> <span class="n">alst</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cd_handle</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                                         <span class="n">ARRAY_DRV_LIST</span> <span class="o">|</span> <span class="n">LA_CTRL_PATTERN</span><span class="p">,</span>
                                         <span class="mi">0</span><span class="p">,</span> <span class="mi">35</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_alist_str</span><span class="p">)))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">alst2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">gdth_alist_str</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_arraydrv</span> <span class="o">=</span> <span class="n">alst2</span><span class="o">-&gt;</span><span class="n">is_arrayd</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_master</span> <span class="o">=</span> <span class="n">alst2</span><span class="o">-&gt;</span><span class="n">is_master</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_parity</span> <span class="o">=</span> <span class="n">alst2</span><span class="o">-&gt;</span><span class="n">is_parity</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_hotfix</span> <span class="o">=</span> <span class="n">alst2</span><span class="o">-&gt;</span><span class="n">is_hotfix</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">master_no</span> <span class="o">=</span> <span class="n">alst2</span><span class="o">-&gt;</span><span class="n">cd_handle</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>       
                                  
    <span class="cm">/* initialize raw service */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_dma32</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_X_INIT_RAW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">=</span> <span class="n">GDT_64BIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">force_dma32</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">S_NOFUNC</span><span class="p">))</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Initialization error raw service (code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): RAWSERVICE initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

    <span class="cm">/* set/get features raw service (scatter/gather) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_SET_FEAT</span><span class="p">,</span> <span class="n">SCATTER_GATHER</span><span class="p">,</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): set features RAWSERVICE OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_GET_FEAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr(): get feat RAWSERVICE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> 

    <span class="cm">/* set/get features cache service (equal to raw service) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_SET_FEAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">SCATTER_GATHER</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): set features CACHESERVICE OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_GET_FEAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr(): get feat CACHESERV. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* reserve drives for raw service */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reserve_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_RESERVE_ALL</span><span class="p">,</span>
                          <span class="n">reserve_mode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): RESERVE_ALL code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RES_ARGS</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span> <span class="o">&amp;&amp;</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span> <span class="o">&amp;&amp;</span>
            <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MAXLUN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): reserve ha %d bus %d id %d lun %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]));</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_RESERVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> 
                                   <span class="p">(</span><span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Error raw service (RESERVE, code %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
             <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Determine OEM string using IOCTL */</span>
    <span class="n">oemstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdth_oem_str_ioctl</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">;</span>
    <span class="n">oemstr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ctl_version</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="n">oemstr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oemstr</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_IOCTL</span><span class="p">,</span>
                          <span class="n">CACHE_READ_OEM_STRING_RECORD</span><span class="p">,</span><span class="n">INVALID_CHANNEL</span><span class="p">,</span>
                          <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_oem_str_ioctl</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): CACHE_READ_OEM_STRING_RECORD OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Vendor: %s Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">oemstr</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">.</span><span class="n">oem_company_name</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">.</span><span class="n">type_string</span><span class="p">);</span>
        <span class="cm">/* Save the Host Drive inquiry data */</span>
        <span class="n">strlcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">,</span><span class="n">oemstr</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">.</span><span class="n">scsi_host_drive_inquiry_vendor_id</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Old method, based on PCI ID */</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_drives(): CACHE_READ_OEM_STRING_RECORD failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">.</span><span class="n">type_string</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">==</span> <span class="n">OEM_ID_INTEL</span><span class="p">)</span>
            <span class="n">strlcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">,</span><span class="s">&quot;Intel  &quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">));</span>
        <span class="k">else</span>
            <span class="n">strlcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">,</span><span class="s">&quot;ICP    &quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="cm">/* scanning for host drives */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cdev_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> 
        <span class="n">gdth_analyse_hdrive</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_search_drives() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_analyse_hdrive</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hdrive</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">drv_cyls</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">drv_hds</span><span class="p">,</span> <span class="n">drv_secs</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_analyse_hdrive() hanum %d drive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hdrive</span> <span class="o">&gt;=</span> <span class="n">MAX_HDRIVES</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_INFO</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">present</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
   
    <span class="cm">/* evaluate mapping (sectors per head, heads per cylinder) */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SECS32</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gdth_eval_mapping</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span><span class="p">,</span><span class="o">&amp;</span><span class="n">drv_cyls</span><span class="p">,</span><span class="o">&amp;</span><span class="n">drv_hds</span><span class="p">,</span><span class="o">&amp;</span><span class="n">drv_secs</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">drv_hds</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="n">drv_secs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="n">drv_cyls</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span> <span class="n">drv_hds</span> <span class="o">/</span> <span class="n">drv_secs</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">drv_hds</span><span class="p">;</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">secs</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">drv_secs</span><span class="p">;</span>
    <span class="cm">/* round size */</span>
    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span>  <span class="o">=</span> <span class="n">drv_cyls</span> <span class="o">*</span> <span class="n">drv_hds</span> <span class="o">*</span> <span class="n">drv_secs</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_X_INFO</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr() cdr. %d size %d hds %d scs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">hdrive</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">size</span><span class="p">,</span><span class="n">drv_hds</span><span class="p">,</span><span class="n">drv_secs</span><span class="p">));</span>

    <span class="cm">/* get informations about device */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_DEVTYPE</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr() cache drive %d devtype %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">hdrive</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">devtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* cluster info */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_CLUST_INFO</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr() cache drive %d cluster info %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">hdrive</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shared_access</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* R/W attributes */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span> <span class="n">GDT_RW_ATTRIBS</span><span class="p">,</span> <span class="n">hdrive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_search_dr() cache drive %d r/w attrib. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">hdrive</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">rw_attribs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* command queueing/sending functions */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_putq</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="k">register</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">pscp</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">nscp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_putq() priority %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">priority</span><span class="p">));</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span> <span class="o">=</span> <span class="n">scp</span><span class="p">;</span>                    <span class="cm">/* queue was empty */</span>
        <span class="n">scp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                    <span class="cm">/* queue not empty */</span>
        <span class="n">pscp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="p">;</span>
        <span class="n">nscp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="cm">/* priority: 0-highest,..,0xff-lowest */</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">nscp</span> <span class="o">&amp;&amp;</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">nscp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;=</span> <span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pscp</span> <span class="o">=</span> <span class="n">nscp</span><span class="p">;</span>
            <span class="n">nscp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="p">;</span>
        <span class="n">scp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">nscp</span><span class="o">=</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="p">;</span> <span class="n">nscp</span><span class="p">;</span> <span class="n">nscp</span><span class="o">=</span><span class="p">(</span><span class="n">Scsi_Cmnd</span><span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span>
        <span class="o">++</span><span class="n">flags</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max_rq</span> <span class="o">&lt;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">max_rq</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">TRACE3</span><span class="p">((</span><span class="s">&quot;GDT: max_rq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="n">max_rq</span><span class="p">));</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_next</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">pscp</span><span class="p">;</span>
    <span class="k">register</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">nscp</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">firsttime</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">this_cmd</span><span class="p">,</span> <span class="n">next_cmd</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmd_index</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_next() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span> 
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">firsttime</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">next_cmd</span> <span class="o">=</span> <span class="n">gdth_polling</span> <span class="o">?</span> <span class="n">FALSE</span><span class="o">:</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">cmd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">nscp</span> <span class="o">=</span> <span class="n">pscp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="p">;</span> <span class="n">nscp</span><span class="p">;</span> <span class="n">nscp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">nscp_cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nscp</span> <span class="o">!=</span> <span class="n">pscp</span> <span class="o">&amp;&amp;</span> <span class="n">nscp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span>
            <span class="n">pscp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">DEFAULT_PRI</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">)].</span><span class="n">lock</span><span class="p">)</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">lock</span><span class="p">))</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">t</span> <span class="o">=</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">firsttime</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>        <span class="cm">/* controller busy ? */</span>
                <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_next() controller %d busy !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
                    <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>   
            <span class="n">firsttime</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>           <span class="cm">/* default: cache svc. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;TEST_UNIT_READY Bus %d Id %d LUN %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                        <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">));</span>
                <span class="cm">/* TEST_UNIT_READY -&gt; set scan mode */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Scan mode: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
                         <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_SCAN_START</span><span class="p">;</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
                            <span class="o">|</span> <span class="n">SCSIRAWSERVICE</span><span class="p">;</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
                        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Scan mode: 0x%x (SCAN_START)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">));</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">&amp;=</span> <span class="mh">0x10</span><span class="p">;</span>
                        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Scan mode: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">));</span>
                    <span class="p">}</span>                   
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">SCSIRAWSERVICE</span><span class="p">;</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_SCAN_END</span><span class="p">;</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">&amp;=</span> <span class="mh">0x10</span><span class="p">;</span>
                        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Scan mode: 0x%x (SCAN_END)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">&amp;&amp;</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INQUIRY</span> <span class="o">&amp;&amp;</span>
                <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">READ_CAPACITY</span> <span class="o">&amp;&amp;</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MODE_SENSE</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> <span class="n">CLUSTER_DRIVE</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/* always GDT_CLUST_INFO! */</span>
                <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_CLUST_INFO</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">CACHESERVICE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
                    <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">next_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">SCSIRAWSERVICE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_raw_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">b</span><span class="p">))))</span>
                    <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">next_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
                <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
                <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_READY</span><span class="p">;</span>
                <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                    <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">nscp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_special_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">)))</span>
                <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">next_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">)].</span><span class="n">io_cnt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">GDTH_MAX_RAW</span> <span class="o">||</span>
                <span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_raw_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">b</span><span class="p">))))</span>
                <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="k">else</span> 
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">)].</span><span class="n">io_cnt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">MAX_HDRIVES</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">present</span> <span class="o">||</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Command 0x%x to bus %d id %d lun %d -&gt; IGNORE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">));</span>
            <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
              <span class="k">case</span> <span class="n">INQUIRY</span>:
              <span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
              <span class="k">case</span> <span class="n">READ_CAPACITY</span>:
              <span class="k">case</span> <span class="n">VERIFY</span>:
              <span class="k">case</span> <span class="n">START_STOP</span>:
              <span class="k">case</span> <span class="n">MODE_SENSE</span>:
              <span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
                <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd %x/%x/%x/%x/%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                       <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span> <span class="o">&amp;&amp;</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* return UNIT_ATTENTION */</span>
                    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;cmd 0x%x target %d: UNIT_ATTENTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">));</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNIT_ATTENTION</span><span class="p">;</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cache_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">))</span>
                    <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

              <span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
                <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd %x/%x/%x/%x/%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                       <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;Prevent r. nonremov. drive-&gt;do nothing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
                    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;Prevent/allow r. %d rem. drive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
                        <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
                
              <span class="k">case</span> <span class="n">RESERVE</span>:
              <span class="k">case</span> <span class="n">RELEASE</span>:
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;cache cmd %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RESERVE</span> <span class="o">?</span>
                        <span class="s">&quot;RESERVE&quot;</span> <span class="o">:</span> <span class="s">&quot;RELEASE&quot;</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
                    <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
                
              <span class="k">case</span> <span class="n">READ_6</span>:
              <span class="k">case</span> <span class="n">WRITE_6</span>:
              <span class="k">case</span> <span class="n">READ_10</span>:
              <span class="k">case</span> <span class="n">WRITE_10</span>:
              <span class="k">case</span> <span class="n">READ_16</span>:
              <span class="k">case</span> <span class="n">WRITE_16</span>:
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* return UNIT_ATTENTION */</span>
                    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;cmd 0x%x target %d: UNIT_ATTENTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">));</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNIT_ATTENTION</span><span class="p">;</span>
                    <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                        <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nscp</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span>
                    <span class="n">this_cmd</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

              <span class="nl">default:</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;cache cmd %x/%x/%x/%x/%x/%x unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Unknown SCSI command 0x%x to cache service !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
                    <span class="n">nscp_cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">nscp</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this_cmd</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nscp</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span> <span class="o">=</span> <span class="n">pscp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">pscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">nscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_cmd</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span> 
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_polling</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cmd_index</span><span class="p">,</span> <span class="n">POLL_TIMEOUT</span><span class="p">))</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: Command %d timed out !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">cmd_index</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gdth_copy_internal_data() - copy to/from a buffer onto a scsi_cmnd&#39;s</span>
<span class="cm"> * buffers, kmap_atomic() as needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_copy_internal_data</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
                                    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u16</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u16</span> <span class="n">cpcount</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">max_sg</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="n">u16</span> <span class="n">cpsum</span><span class="p">,</span><span class="n">cpnow</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">;</span>

    <span class="n">cpcount</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cpcount</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cpsum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">max_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
            <span class="n">cpnow</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
            <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;copy_internal() now %d sum %d count %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                          <span class="n">cpnow</span><span class="p">,</span> <span class="n">cpsum</span><span class="p">,</span> <span class="n">cpcount</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">)));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cpsum</span><span class="o">+</span><span class="n">cpnow</span> <span class="o">&gt;</span> <span class="n">cpcount</span><span class="p">)</span> 
                <span class="n">cpnow</span> <span class="o">=</span> <span class="n">cpcount</span> <span class="o">-</span> <span class="n">cpsum</span><span class="p">;</span>
            <span class="n">cpsum</span> <span class="o">+=</span> <span class="n">cpnow</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: invalid sc/gt element in gdth_copy_internal_data()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span> <span class="o">+</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">cpnow</span><span class="p">);</span>
            <span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sl</span><span class="p">));</span>
            <span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
            <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cpsum</span> <span class="o">==</span> <span class="n">cpcount</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="n">buffer</span> <span class="o">+=</span> <span class="n">cpnow</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA %d: SCSI command with no buffers but data transfer expected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
        <span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_internal_cache_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">gdth_inq_data</span> <span class="n">inq</span><span class="p">;</span>
    <span class="n">gdth_rdcap_data</span> <span class="n">rdc</span><span class="p">;</span>
    <span class="n">gdth_sense_data</span> <span class="n">sd</span><span class="p">;</span>
    <span class="n">gdth_modep_data</span> <span class="n">mpd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

    <span class="n">t</span>  <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_internal_cache_cmd() cmd 0x%x hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="p">));</span>

    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
      <span class="k">case</span> <span class="n">VERIFY</span>:
      <span class="k">case</span> <span class="n">START_STOP</span>:
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Test/Verify/Start hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">INQUIRY</span>:
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Inquiry hdrive %d devtype %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span><span class="p">));</span>
        <span class="n">inq</span><span class="p">.</span><span class="n">type_qual</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span><span class="o">&amp;</span><span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">TYPE_ROM</span><span class="o">:</span><span class="n">TYPE_DISK</span><span class="p">;</span>
        <span class="cm">/* you can here set all disks to removable, if you want to do</span>
<span class="cm">           a flush using the ALLOW_MEDIUM_REMOVAL command */</span>
        <span class="n">inq</span><span class="p">.</span><span class="n">modif_rmb</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> <span class="n">CLUSTER_DRIVE</span><span class="p">))</span>
            <span class="n">inq</span><span class="p">.</span><span class="n">modif_rmb</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
        <span class="n">inq</span><span class="p">.</span><span class="n">version</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">inq</span><span class="p">.</span><span class="n">resp_aenc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">inq</span><span class="p">.</span><span class="n">add_length</span><span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">inq</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_name</span><span class="p">);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">inq</span><span class="p">.</span><span class="n">product</span><span class="p">,</span><span class="s">&quot;Host Drive  #%02d&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">inq</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span><span class="s">&quot;   &quot;</span><span class="p">);</span>
        <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">inq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_inq_data</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Request sense hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">));</span>
        <span class="n">sd</span><span class="p">.</span><span class="n">errorcode</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
        <span class="n">sd</span><span class="p">.</span><span class="n">segno</span>     <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="n">sd</span><span class="p">.</span><span class="n">key</span>       <span class="o">=</span> <span class="n">NO_SENSE</span><span class="p">;</span>
        <span class="n">sd</span><span class="p">.</span><span class="n">info</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sd</span><span class="p">.</span><span class="n">add_length</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sense_data</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">MODE_SENSE</span>:
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Mode sense hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_modep_data</span><span class="p">));</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">hd</span><span class="p">.</span><span class="n">data_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_modep_data</span><span class="p">);</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">hd</span><span class="p">.</span><span class="n">dev_par</span>     <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">devtype</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">hd</span><span class="p">.</span><span class="n">bd_length</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpd</span><span class="p">.</span><span class="n">bd</span><span class="p">);</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">bd</span><span class="p">.</span><span class="n">block_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SECTOR_SIZE</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">bd</span><span class="p">.</span><span class="n">block_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SECTOR_SIZE</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">mpd</span><span class="p">.</span><span class="n">bd</span><span class="p">.</span><span class="n">block_length</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SECTOR_SIZE</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
        <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_modep_data</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">READ_CAPACITY</span>:
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Read capacity hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xffffffff</span><span class="p">)</span>
            <span class="n">rdc</span><span class="p">.</span><span class="n">last_block_no</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">rdc</span><span class="p">.</span><span class="n">last_block_no</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">rdc</span><span class="p">.</span><span class="n">block_length</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SECTOR_SIZE</span><span class="p">);</span>
        <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rdc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_rdcap_data</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="n">SERVICE_ACTION_IN</span>:
        <span class="k">if</span> <span class="p">((</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAI_READ_CAPACITY_16</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">gdth_rdcap16_data</span> <span class="n">rdc16</span><span class="p">;</span>

            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Read capacity (16) hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">));</span>
            <span class="n">rdc16</span><span class="p">.</span><span class="n">last_block_no</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">rdc16</span><span class="p">.</span><span class="n">block_length</span>  <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">SECTOR_SIZE</span><span class="p">);</span>
            <span class="n">gdth_copy_internal_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rdc16</span><span class="p">,</span>
                                                 <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_rdcap16_data</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
            <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="nl">default:</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Internal cache cmd 0x%x unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
    <span class="k">else</span> 
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_fill_cache_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hdrive</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="n">u32</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">blockcnt</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">no</span><span class="p">,</span> <span class="n">blockno</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd_index</span><span class="p">,</span> <span class="n">read_write</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">mode64</span><span class="p">;</span>

    <span class="n">cmdp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_fill_cache_cmd() cmd 0x%x cmdsize %d hdrive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                 <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span><span class="n">hdrive</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">==</span><span class="n">GDT_EISA</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">mode64</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="cm">/* test for READ_16, WRITE_16 if !mode64 ? ---</span>
<span class="cm">       not required, should not occur due to error return on </span>
<span class="cm">       READ_CAPACITY_16 */</span>

    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">scp</span><span class="p">;</span>
    <span class="cm">/* search free command index */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;GDT: No free command index found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* if it&#39;s the first command, set command semaphore */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

    <span class="cm">/* fill command */</span>
    <span class="n">read_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">;</span>   <span class="cm">/* special cache cmd. */</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RESERVE</span><span class="p">)</span> 
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_RESERVE_DRV</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RELEASE</span><span class="p">)</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_RELEASE_DRV</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>                   <span class="cm">/* prevent ? */</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_MOUNT</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>              <span class="cm">/* removable drive ? */</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_UNMOUNT</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_FLUSH</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span> <span class="o">||</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span> <span class="o">||</span>
               <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_12</span> <span class="o">||</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_16</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="n">read_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_write_through</span> <span class="o">||</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">hdrive</span><span class="p">].</span><span class="n">rw_attribs</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
                                   <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_WR_THROUGH</span><span class="p">)))</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_WRITE_THR</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_WRITE</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">read_write</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_READ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span> <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">hdrive</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">hdrive</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">read_write</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
            <span class="n">blockno</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">no</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
            <span class="n">blockcnt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
            <span class="n">blockno</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">no</span><span class="p">);</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
            <span class="n">blockcnt</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
            <span class="n">blockno</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x001fffffUL</span><span class="p">;</span>
            <span class="n">blockcnt</span><span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span> <span class="o">=</span> <span class="n">blockno</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockCnt</span> <span class="o">=</span> <span class="n">blockcnt</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">blockno</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockCnt</span> <span class="o">=</span> <span class="n">blockcnt</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_write</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
                <span class="n">PCI_DMA_TODEVICE</span> <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>   
            <span class="n">sgcnt</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span>
                               <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">dma_dir</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DestAddr</span><span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
<span class="cp">#ifdef GDTH_DMA_STATISTICS</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xffffffff</span><span class="p">)</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_cnt</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma32_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DestAddr</span><span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
<span class="cp">#ifdef GDTH_DMA_STATISTICS</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma32_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">max_sg</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sgcnt</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">max_sg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">TRACE3</span><span class="p">((</span><span class="s">&quot;GDT: max_sg = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">max_sg</span><span class="p">));</span>
            <span class="p">}</span>
<span class="cp">#endif</span>

        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* evaluate command size, check space */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd: addr. %x sganz %x sgptr0 %x sglen0 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DestAddr</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span><span class="p">));</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd: cmd %d blockno. %d, blockcnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockCnt</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg64_str</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd: addr. %x sganz %x sgptr0 %x sglen0 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DestAddr</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span><span class="p">));</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;cache cmd: cmd %d blockno. %d, blockcnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockCnt</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg_str</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_fill_cache() DPMEM overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">cmd_index</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* copy command */</span>
    <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cmd_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_fill_raw_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">dma_addr_t</span> <span class="n">sense_paddr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmd_index</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">mode64</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span><span class="p">;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
    <span class="n">cmdp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_fill_raw_cmd() cmd 0x%x bus %d ID %d LUN %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">==</span><span class="n">GDT_EISA</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">mode64</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">SCSIRAWSERVICE</span><span class="p">;</span>
    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">scp</span><span class="p">;</span>
    <span class="cm">/* search free command index */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;GDT: No free command index found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* if it&#39;s the first command, set command semaphore */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

    <span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="cm">/* fill command */</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span>           <span class="o">=</span> <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">;</span> <span class="cm">/* special raw cmd. */</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span>        <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;special raw cmd 0x%x param 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">,</span> <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">direction</span><span class="p">));</span>
            <span class="cm">/* evaluate command size */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">direction</span>  <span class="o">=</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;special raw cmd 0x%x param 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">,</span> <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">direction</span><span class="p">));</span>
            <span class="cm">/* evaluate command size */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">);</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
        <span class="n">sense_paddr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">page</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span>
                                   <span class="mi">16</span><span class="p">,</span><span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">sense_paddr</span>  <span class="o">=</span> <span class="n">sense_paddr</span><span class="p">;</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span>           <span class="o">=</span> <span class="n">GDT_WRITE</span><span class="p">;</span>             <span class="cm">/* always */</span>
        <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span>        <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span> 
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">reserved</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">mdisc_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">mcon_time</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">clen</span>       <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">target</span>     <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">lun</span>        <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">bus</span>        <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">priority</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdlen</span>      <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sense_len</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sense_data</span> <span class="o">=</span> <span class="n">sense_paddr</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">direction</span>  <span class="o">=</span> 
                <span class="n">gdth_direction_tab</span><span class="p">[</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">DOU</span> <span class="o">?</span> <span class="n">GDTH_DATA_OUT</span><span class="o">:</span><span class="n">GDTH_DATA_IN</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">reserved</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">mdisc_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">mcon_time</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">clen</span>       <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">target</span>     <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">lun</span>        <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">bus</span>        <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">priority</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">link_p</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdlen</span>      <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sense_len</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sense_data</span> <span class="o">=</span> <span class="n">sense_paddr</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">direction</span>  <span class="o">=</span> 
                <span class="n">gdth_direction_tab</span><span class="p">[</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">DOU</span> <span class="o">?</span> <span class="n">GDTH_DATA_OUT</span><span class="o">:</span><span class="n">GDTH_DATA_IN</span><span class="p">;</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">=</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">;</span>
            <span class="n">sgcnt</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span>
                               <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">dma_dir</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
<span class="cp">#ifdef GDTH_DMA_STATISTICS</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xffffffff</span><span class="p">)</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_cnt</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma32_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
                <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">sgcnt</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
<span class="cp">#ifdef GDTH_DMA_STATISTICS</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma32_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
                    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">max_sg</span> <span class="o">&lt;</span> <span class="n">sgcnt</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">max_sg</span> <span class="o">=</span> <span class="n">sgcnt</span><span class="p">;</span>
                <span class="n">TRACE3</span><span class="p">((</span><span class="s">&quot;GDT: max_sg = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sgcnt</span><span class="p">));</span>
            <span class="p">}</span>
<span class="cp">#endif</span>

        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode64</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;raw cmd: addr. %x sganz %x sgptr0 %x sglen0 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdata</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span><span class="p">));</span>
            <span class="cm">/* evaluate command size */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg64_str</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;raw cmd: addr. %x sganz %x sgptr0 %x sglen0 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdata</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span><span class="p">,</span>
                   <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span><span class="p">));</span>
            <span class="cm">/* evaluate command size */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg_str</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* check space */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_fill_raw() DPMEM overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">cmd_index</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* copy command */</span>
    <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cmd_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_special_cmd</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">cmd_index</span><span class="p">;</span>

    <span class="n">cmdp</span><span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_special_cmd(): &quot;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">==</span><span class="n">GDT_EISA</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="n">cmdp</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_cmd_str</span><span class="p">;</span>
    <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">scp</span><span class="p">;</span>

    <span class="cm">/* search free command index */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd_index</span><span class="o">=</span><span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;GDT: No free command index found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* if it&#39;s the first command, set command semaphore */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
       <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

    <span class="cm">/* evaluate command size, check space */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_IOCTL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;IOCTL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> 
            <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">p_param</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;cache command %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> 
                <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg64_str</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> 
                <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg_str</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">==</span> <span class="n">SCSIRAWSERVICE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;raw command %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> 
                <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg64_str</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> 
                <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_sg_str</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">+</span> <span class="n">DPMEM_COMMAND_OFFSET</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ic_all_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_special_cmd() DPMEM overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">cmd_index</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* copy command */</span>
    <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cmd_index</span><span class="p">;</span>
<span class="p">}</span>    


<span class="cm">/* Controller event handling functions */</span>
<span class="k">static</span> <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="nf">gdth_store_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u16</span> <span class="n">source</span><span class="p">,</span> 
                                      <span class="n">u16</span> <span class="n">idx</span><span class="p">,</span> <span class="n">gdth_evt_data</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

    <span class="cm">/* no GDTH_LOCK_HA() ! */</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_store_event() source %d idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>                        <span class="cm">/* no source -&gt; no event */</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_source</span> <span class="o">==</span> <span class="n">source</span> <span class="o">&amp;&amp;</span>
        <span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_idx</span> <span class="o">==</span> <span class="n">idx</span> <span class="o">&amp;&amp;</span>
        <span class="p">((</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_data</span><span class="p">.</span><span class="n">eu</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_data</span><span class="p">.</span><span class="n">event_string</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">event_string</span><span class="p">))))</span> <span class="p">{</span> 
        <span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">];</span>
        <span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">last_stamp</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
        <span class="o">++</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">same_count</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">].</span><span class="n">event_source</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* entry not free ? */</span>
            <span class="o">++</span><span class="n">elastidx</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">elastidx</span> <span class="o">==</span> <span class="n">MAX_EVENTS</span><span class="p">)</span>
                <span class="n">elastidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">elastidx</span> <span class="o">==</span> <span class="n">eoldidx</span><span class="p">)</span> <span class="p">{</span>              <span class="cm">/* reached mark ? */</span>
                <span class="o">++</span><span class="n">eoldidx</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eoldidx</span> <span class="o">==</span> <span class="n">MAX_EVENTS</span><span class="p">)</span>
                    <span class="n">eoldidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">elastidx</span><span class="p">];</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">event_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">event_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
        <span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">first_stamp</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">last_stamp</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">same_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">event_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">application</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_read_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">,</span> <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">estr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">eindex</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_read_event() handle %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eindex</span> <span class="o">=</span> <span class="n">eoldidx</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">eindex</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
    <span class="n">estr</span><span class="o">-&gt;</span><span class="n">event_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">eindex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">eindex</span> <span class="o">&gt;=</span> <span class="n">MAX_EVENTS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">eindex</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">eindex</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_source</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eindex</span> <span class="o">!=</span> <span class="n">elastidx</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">eindex</span> <span class="o">==</span> <span class="n">MAX_EVENTS</span><span class="p">)</span>
                <span class="n">eindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">eindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">estr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_evt_str</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">eindex</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_readapp_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
                               <span class="n">u8</span> <span class="n">application</span><span class="p">,</span> <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">estr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_evt_str</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">eindex</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_readapp_event() app. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">application</span><span class="p">));</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">eindex</span> <span class="o">=</span> <span class="n">eoldidx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ebuffer</span><span class="p">[</span><span class="n">eindex</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event_source</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">application</span> <span class="o">&amp;</span> <span class="n">application</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="o">-&gt;</span><span class="n">application</span> <span class="o">|=</span> <span class="n">application</span><span class="p">;</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eindex</span> <span class="o">==</span> <span class="n">elastidx</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">eindex</span> <span class="o">==</span> <span class="n">MAX_EVENTS</span><span class="p">)</span>
            <span class="n">eindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">estr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_evt_str</span><span class="p">));</span>
    <span class="k">else</span>
        <span class="n">estr</span><span class="o">-&gt;</span><span class="n">event_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_clear_events</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_clear_events()&quot;</span><span class="p">));</span>

    <span class="n">eoldidx</span> <span class="o">=</span> <span class="n">elastidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ebuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">event_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* SCSI interface functions */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">__gdth_interrupt</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
                                    <span class="kt">int</span> <span class="n">gdth_from_wait</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">pIndex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gdt6_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp6_ptr</span><span class="p">;</span>
    <span class="n">gdt2_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dp2_ptr</span><span class="p">;</span>
    <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">IStatus</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">Service</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef INT_COAL</span>
    <span class="kt">int</span> <span class="n">coalesced</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">gdth_coal_status</span> <span class="o">*</span><span class="n">pcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">act_int_coal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       
<span class="cp">#endif</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>

    <span class="cm">/* if polling and not from gdth_wait() -&gt; return */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gdth_polling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_from_wait</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="cm">/* search controller */</span>
    <span class="n">IStatus</span> <span class="o">=</span> <span class="n">gdth_get_status</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* spurious interrupt */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
    <span class="o">++</span><span class="n">act_ints</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef INT_COAL</span>
    <span class="cm">/* See if the fw is returning coalesced status */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">==</span> <span class="n">COALINDEX</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Coalesced status.  Setup the initial status </span>
<span class="cm">           buffer pointer and flags */</span>
        <span class="n">pcs</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">;</span>
        <span class="n">coalesced</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>        
        <span class="n">next</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coalesced</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* For coalesced requests all status</span>
<span class="cm">               information is found in the status buffer */</span>
            <span class="n">IStatus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pcs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* error flag */</span>
                <span class="n">IStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() error %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span>                                      <span class="cm">/* no error */</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">12</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">10</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">MAILBOXREG</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>

            <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">EDOORREG</span><span class="p">);</span>    <span class="cm">/* acknowledge interrupt */</span>
            <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bmic</span> <span class="o">+</span> <span class="n">SEMA1REG</span><span class="p">);</span>    <span class="cm">/* reset status semaphore */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dp2_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* error flag */</span>
                <span class="n">IStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() error %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span>                                      <span class="cm">/* no error */</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Service</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

            <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span> <span class="cm">/* acknowledge interrupt */</span>
            <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span><span class="cm">/* reset command index */</span>
            <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp2_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">Sema1</span><span class="p">);</span>     <span class="cm">/* reset status semaphore */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dp6_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* error flag */</span>
                <span class="n">IStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() error %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span>                                      <span class="cm">/* no error */</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Service</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

            <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqdel</span><span class="p">);</span> <span class="cm">/* acknowledge interrupt */</span>
            <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ic</span><span class="p">.</span><span class="n">Cmd_Index</span><span class="p">);</span><span class="cm">/* reset command index */</span>
            <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6_ptr</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">Sema1</span><span class="p">);</span>     <span class="cm">/* reset status semaphore */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCINEW</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* error flag */</span>
                <span class="n">IStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() error %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

            <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">edoor_reg</span><span class="p">));</span> 
            <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">PTR2USHORT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">plx</span><span class="o">-&gt;</span><span class="n">sema1_reg</span><span class="p">));</span> 
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dp6m_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>                       <span class="cm">/* error flag */</span>
                <span class="n">IStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
<span class="cp">#ifdef INT_COAL</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">coalesced</span><span class="p">)</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
                <span class="k">else</span> 
<span class="cp">#endif</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() error %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span>                                      <span class="cm">/* no error */</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="cp">#ifdef INT_COAL</span>
            <span class="cm">/* get information */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coalesced</span><span class="p">)</span> <span class="p">{</span>    
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">-&gt;</span><span class="n">info0</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">-&gt;</span><span class="n">info1</span><span class="p">;</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcs</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
            <span class="p">{</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">service</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="cm">/* event string */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">==</span> <span class="n">ASYNCINDEX</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">!=</span> <span class="n">SCREENSERVICE</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_vers</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">severity</span> <span class="o">=</span> <span class="n">readb</span>
                        <span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">severity</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">event_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span>
                            <span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">gdt6m_dpram_str</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">evt_str</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">event_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
<span class="cp">#ifdef INT_COAL</span>
            <span class="cm">/* Make sure that non coalesced interrupts get cleared</span>
<span class="cm">               before being handled by gdth_async_event/gdth_sync_event */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">coalesced</span><span class="p">)</span>
<span class="cp">#endif                          </span>
            <span class="p">{</span>
                <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_reg</span><span class="p">);</span>
                <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">sema1_reg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() unknown controller type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() index %d stat %d info %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">IStatus</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">gdth_from_wait</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">pIndex</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IStatus</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">==</span> <span class="n">ASYNCINDEX</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() async. event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">gdth_async_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="n">gdth_next</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span> 

        <span class="k">if</span> <span class="p">(</span><span class="n">IStatus</span> <span class="o">==</span> <span class="n">SPEZINDEX</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Service unknown or not initialized !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">ionode</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">;</span>
            <span class="n">gdth_store_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ES_DRIVER</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">scp</span>     <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">IStatus</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">cmnd</span><span class="p">;</span>
        <span class="n">Service</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">IStatus</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">service</span><span class="p">;</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">IStatus</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scp</span> <span class="o">==</span> <span class="n">UNUSED_CMND</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() index to unused command (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">IStatus</span><span class="p">));</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">ionode</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">IStatus</span><span class="p">;</span>
            <span class="n">gdth_store_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ES_DRIVER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scp</span> <span class="o">==</span> <span class="n">INTERNAL_CMND</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() answer to internal command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_interrupt() sync. status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">gdth_sync_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">Service</span><span class="p">,</span><span class="n">IStatus</span><span class="p">,</span><span class="n">scp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_polling</span><span class="p">)</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gdth_putq</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gdth_scsi_done</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
        <span class="p">}</span>

<span class="cp">#ifdef INT_COAL</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coalesced</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* go to the next status in the status buffer */</span>
            <span class="o">++</span><span class="n">pcs</span><span class="p">;</span>
<span class="cp">#ifdef GDTH_STATISTICS</span>
            <span class="o">++</span><span class="n">act_int_coal</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">act_int_coal</span> <span class="o">&gt;</span> <span class="n">max_int_coal</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">max_int_coal</span> <span class="o">=</span> <span class="n">act_int_coal</span><span class="p">;</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT: max_int_coal = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="n">max_int_coal</span><span class="p">);</span>
            <span class="p">}</span>
<span class="cp">#endif      </span>
            <span class="cm">/* see if there is another status */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pcs</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>    
                <span class="cm">/* Stop the coalesce loop */</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="p">);</span>

    <span class="cm">/* coalescing only for new GDT_PCIMPR controllers available */</span>      
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span> <span class="o">&amp;&amp;</span> <span class="n">coalesced</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">edoor_reg</span><span class="p">);</span>
        <span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dp6m_ptr</span><span class="o">-&gt;</span><span class="n">i960r</span><span class="p">.</span><span class="n">sema1_reg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="n">gdth_next</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">gdth_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__gdth_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_sync_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">service</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
                                                              <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_msg_str</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

    <span class="n">cmdp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_sync_event() serv %d status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">service</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">SCREENSERVICE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">msg</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">;</span>
        <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;len: %d, answer: %d, ext: %d, alen: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_answer</span><span class="p">,</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_ext</span><span class="p">,</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_alen</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&gt;</span> <span class="n">MSGLEN</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">MSGLEN</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_answer</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_ext</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_text</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_text</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_ext</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_answer</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
                <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span>       <span class="o">=</span> <span class="n">SCREENSERVICE</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">SCREEN_CMND</span><span class="p">;</span>
            <span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span>        <span class="o">=</span> <span class="n">GDT_READ</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span>     <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">reserved</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_handle</span><span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_handle</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span><span class="p">)</span> 
                <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_answer</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_alen</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* default answers (getchar() not possible) */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_alen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_alen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_alen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_text</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_ext</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_answer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
                <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span>       <span class="o">=</span> <span class="n">SCREENSERVICE</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">SCREEN_CMND</span><span class="p">;</span>
            <span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span>        <span class="o">=</span> <span class="n">GDT_WRITE</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span>     <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">reserved</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_handle</span><span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_handle</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span><span class="p">)</span> 
                <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">)].</span><span class="n">io_cnt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* cache or raw service */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_BSY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Controller busy -&gt; retry !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_MOUNT</span><span class="p">)</span>
                <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_CLUST_INFO</span><span class="p">;</span>
            <span class="cm">/* retry */</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scp</span><span class="p">))</span>
            <span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">scp</span><span class="p">),</span>
                         <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">dma_dir</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">sense_paddr</span><span class="p">)</span>
            <span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">sense_paddr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
                                                           <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_sync_event(): special cmd 0x%x OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">));</span>
                <span class="cm">/* special commands GDT_CLUST_INFO/GDT_MOUNT ? */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_CLUST_INFO</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> 
                        <span class="n">CLUSTER_MOUNTED</span><span class="p">))</span> <span class="p">{</span>
                        <span class="cm">/* NOT MOUNTED -&gt; MOUNT */</span>
                        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_MOUNT</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> 
                            <span class="n">CLUSTER_RESERVED</span><span class="p">)</span> <span class="p">{</span>
                            <span class="cm">/* cluster drive RESERVED (on the other node) */</span>
                            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>      <span class="cm">/* reservation conflict */</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_MOUNT</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">|=</span> <span class="n">CLUSTER_MOUNTED</span><span class="p">;</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_UNMOUNT</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLUSTER_MOUNTED</span><span class="p">;</span>
                        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">media_changed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="p">}</span> 
                    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="cm">/* retry */</span>
                <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">HIGH_PRI</span><span class="p">;</span>
                <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* RESERVE/RELEASE ? */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RESERVE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">|=</span> <span class="n">CLUSTER_RESERVED</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RELEASE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLUSTER_RESERVED</span><span class="p">;</span>
                <span class="p">}</span>           
                <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_sync_event(): special cmd 0x%x error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_SCAN_START</span> <span class="o">||</span>
                    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_SCAN_END</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="cm">/* retry */</span>
                    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">HIGH_PRI</span><span class="p">;</span>
                    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
                <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
                <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_READY</span><span class="p">;</span>
                <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_CACHE_UNKNOWN</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> 
                     <span class="n">CLUSTER_RESERVE_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CLUSTER_RESERVE_STATE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* bus reset -&gt; force GDT_CLUST_INFO */</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLUSTER_RESERVED</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">S_CACHE_RESERV</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">RESERVATION_CONFLICT</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_READY</span><span class="p">;</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">);</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">ionode</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">status</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">info</span>    <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">hostdrive</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mh">0x8000</span><span class="p">)</span>
                        <span class="n">gdth_store_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ES_SYNC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">);</span>
                    <span class="k">else</span>
                        <span class="n">gdth_store_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ES_SYNC</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* sense buffer filled from controller firmware (DMA) */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">S_RAW_SCSI</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&gt;=</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="p">)</span>
            <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span><span class="o">++</span><span class="p">;</span>
        <span class="k">else</span> 
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">async_cache_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 0*/</span>  <span class="s">&quot;</span><span class="se">\011\000\002\002\002\004\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, service %u, async. status %u/%lu unknown&quot;</span><span class="p">,</span>
<span class="cm">/* 1*/</span>  <span class="s">&quot;</span><span class="se">\011\000\002\002\002\004\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, service %u, async. status %u/%lu unknown&quot;</span><span class="p">,</span>
<span class="cm">/* 2*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %lu not ready&quot;</span><span class="p">,</span>
<span class="cm">/* 3*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %lu: REASSIGN not successful and/or data error on reassigned blocks. Drive may crash in the future and should be replaced&quot;</span><span class="p">,</span>
<span class="cm">/* 4*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, mirror update on Host Drive %lu failed&quot;</span><span class="p">,</span>
<span class="cm">/* 5*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %lu failed&quot;</span><span class="p">,</span>
<span class="cm">/* 6*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %lu: REASSIGN not successful and/or data error on reassigned blocks. Drive may crash in the future and should be replaced&quot;</span><span class="p">,</span>
<span class="cm">/* 7*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %lu write protected&quot;</span><span class="p">,</span>
<span class="cm">/* 8*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, media changed in Host Drive %lu&quot;</span><span class="p">,</span>
<span class="cm">/* 9*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %lu is offline&quot;</span><span class="p">,</span>
<span class="cm">/*10*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, media change of Mirror Drive %lu&quot;</span><span class="p">,</span>
<span class="cm">/*11*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %lu is write protected&quot;</span><span class="p">,</span>
<span class="cm">/*12*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, general error on Host Drive %lu. Please check the devices of this drive!&quot;</span><span class="p">,</span>
<span class="cm">/*13*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\006\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: Cache Drive %u failed&quot;</span><span class="p">,</span>
<span class="cm">/*14*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: FAIL state entered&quot;</span><span class="p">,</span>
<span class="cm">/*15*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: error&quot;</span><span class="p">,</span>
<span class="cm">/*16*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\006\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: failed drive replaced by Cache Drive %u&quot;</span><span class="p">,</span>
<span class="cm">/*17*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity build failed&quot;</span><span class="p">,</span>
<span class="cm">/*18*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive rebuild failed&quot;</span><span class="p">,</span>
<span class="cm">/*19*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Test of Hot Fix %u failed&quot;</span><span class="p">,</span>
<span class="cm">/*20*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive build finished successfully&quot;</span><span class="p">,</span>
<span class="cm">/*21*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive rebuild finished successfully&quot;</span><span class="p">,</span>
<span class="cm">/*22*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\006\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: Hot Fix %u activated&quot;</span><span class="p">,</span>
<span class="cm">/*23*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %u: processing of i/o aborted due to serious drive error&quot;</span><span class="p">,</span>
<span class="cm">/*24*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, mirror update on Cache Drive %u completed&quot;</span><span class="p">,</span>
<span class="cm">/*25*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, mirror update on Cache Drive %lu failed&quot;</span><span class="p">,</span>
<span class="cm">/*26*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive rebuild started&quot;</span><span class="p">,</span>
<span class="cm">/*27*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\012\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u: SHELF OK detected&quot;</span><span class="p">,</span>
<span class="cm">/*28*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\012\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u: SHELF not OK detected&quot;</span><span class="p">,</span>
<span class="cm">/*29*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: Auto Hot Plug started&quot;</span><span class="p">,</span>
<span class="cm">/*30*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: new disk detected&quot;</span><span class="p">,</span>
<span class="cm">/*31*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: old disk detected&quot;</span><span class="p">,</span>
<span class="cm">/*32*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: plugging an active disk is invalid&quot;</span><span class="p">,</span>
<span class="cm">/*33*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: invalid device detected&quot;</span><span class="p">,</span>
<span class="cm">/*34*/</span>  <span class="s">&quot;</span><span class="se">\011\000\002\012\001\013\001\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: insufficient disk capacity (%lu MB required)&quot;</span><span class="p">,</span>
<span class="cm">/*35*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: disk write protected&quot;</span><span class="p">,</span>
<span class="cm">/*36*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: disk not available&quot;</span><span class="p">,</span>
<span class="cm">/*37*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u: swap detected (%lu)&quot;</span><span class="p">,</span>
<span class="cm">/*38*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: Auto Hot Plug finished successfully&quot;</span><span class="p">,</span>
<span class="cm">/*39*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: Auto Hot Plug aborted due to user Hot Plug&quot;</span><span class="p">,</span>
<span class="cm">/*40*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: Auto Hot Plug aborted&quot;</span><span class="p">,</span>
<span class="cm">/*41*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Fault bus %u, ID %u: Auto Hot Plug for Hot Fix started&quot;</span><span class="p">,</span>
<span class="cm">/*42*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive build started&quot;</span><span class="p">,</span>
<span class="cm">/*43*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, DRAM parity error detected&quot;</span><span class="p">,</span>
<span class="cm">/*44*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %u: update started&quot;</span><span class="p">,</span>
<span class="cm">/*45*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\006\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %u: Hot Fix %u activated&quot;</span><span class="p">,</span>
<span class="cm">/*46*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: no matching Pool Hot Fix Drive available&quot;</span><span class="p">,</span>
<span class="cm">/*47*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: Pool Hot Fix Drive available&quot;</span><span class="p">,</span>
<span class="cm">/*48*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %u: no matching Pool Hot Fix Drive available&quot;</span><span class="p">,</span>
<span class="cm">/*49*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %u: Pool Hot Fix Drive available&quot;</span><span class="p">,</span>
<span class="cm">/*50*/</span>  <span class="s">&quot;</span><span class="se">\007\000\002\012\001\013\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, SCSI bus %u, ID %u: IGNORE_WIDE_RESIDUE message received&quot;</span><span class="p">,</span>
<span class="cm">/*51*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: expand started&quot;</span><span class="p">,</span>
<span class="cm">/*52*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: expand finished successfully&quot;</span><span class="p">,</span>
<span class="cm">/*53*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: expand failed&quot;</span><span class="p">,</span>
<span class="cm">/*54*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, CPU temperature critical&quot;</span><span class="p">,</span>
<span class="cm">/*55*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, CPU temperature OK&quot;</span><span class="p">,</span>
<span class="cm">/*56*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\004</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host drive %lu created&quot;</span><span class="p">,</span>
<span class="cm">/*57*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: expand restarted&quot;</span><span class="p">,</span>
<span class="cm">/*58*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: expand stopped&quot;</span><span class="p">,</span>
<span class="cm">/*59*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\010\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Mirror Drive %u: drive build quited&quot;</span><span class="p">,</span>
<span class="cm">/*60*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity build quited&quot;</span><span class="p">,</span>
<span class="cm">/*61*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: drive rebuild quited&quot;</span><span class="p">,</span>
<span class="cm">/*62*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity verify started&quot;</span><span class="p">,</span>
<span class="cm">/*63*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity verify done&quot;</span><span class="p">,</span>
<span class="cm">/*64*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity verify failed&quot;</span><span class="p">,</span>
<span class="cm">/*65*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity error detected&quot;</span><span class="p">,</span>
<span class="cm">/*66*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Array Drive %u: parity verify quited&quot;</span><span class="p">,</span>
<span class="cm">/*67*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %u reserved&quot;</span><span class="p">,</span>
<span class="cm">/*68*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %u mounted and released&quot;</span><span class="p">,</span>
<span class="cm">/*69*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host Drive %u released&quot;</span><span class="p">,</span>
<span class="cm">/*70*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, DRAM error detected and corrected with ECC&quot;</span><span class="p">,</span>
<span class="cm">/*71*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Uncorrectable DRAM error detected with ECC&quot;</span><span class="p">,</span>
<span class="cm">/*72*/</span>  <span class="s">&quot;</span><span class="se">\011\000\002\012\001\013\001\014\001</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, SCSI bus %u, ID %u, LUN %u: reassigning block&quot;</span><span class="p">,</span>
<span class="cm">/*73*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host drive %u resetted locally&quot;</span><span class="p">,</span>
<span class="cm">/*74*/</span>  <span class="s">&quot;</span><span class="se">\005\000\002\006\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, Host drive %u resetted remotely&quot;</span><span class="p">,</span>
<span class="cm">/*75*/</span>  <span class="s">&quot;</span><span class="se">\003\000\002</span><span class="s">&quot;</span>
        <span class="s">&quot;GDT HA %u, async. status 75 unknown&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_async_event</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmdp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmd_index</span><span class="p">;</span>

    <span class="n">cmdp</span><span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">;</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_async_event() ha %d serv %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">==</span> <span class="n">SCREENSERVICE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">MSG_REQUEST</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
                <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">Service</span>       <span class="o">=</span> <span class="n">SCREENSERVICE</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">RequestBuffer</span> <span class="o">=</span> <span class="n">SCREEN_CMND</span><span class="p">;</span>
            <span class="n">cmd_index</span> <span class="o">=</span> <span class="n">gdth_get_cmd_index</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">gdth_set_sema0</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">OpCode</span>        <span class="o">=</span> <span class="n">GDT_READ</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">BoardNode</span>     <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">reserved</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_handle</span><span class="o">=</span> <span class="n">MSG_INV_HANDLE</span><span class="p">;</span>
            <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_offs_dpmem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">GDTOFFSOF</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">,</span><span class="n">u</span><span class="p">.</span><span class="n">screen</span><span class="p">.</span><span class="n">su</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">msg_addr</span><span class="p">)</span> 
                <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">gdth_copy_command</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;[EISA slot %d] &quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span><span class="p">);</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;[DPMEM 0x%4X] &quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span><span class="p">);</span>
            <span class="k">else</span> 
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;[PCI %d/%d] &quot;</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">));</span>
            <span class="n">gdth_release_event</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCIMPR</span> <span class="o">&amp;&amp;</span> 
            <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_vers</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
            <span class="cm">/* severity and event_string already set! */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span>   <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">info</span>    <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
            <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">scsi_coord</span>  <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">info2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gdth_store_event</span><span class="p">(</span> <span class="n">ha</span><span class="p">,</span> <span class="n">ES_ASYNC</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span> <span class="p">);</span>
        <span class="n">gdth_log_event</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dvr</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>
    
        <span class="cm">/* new host drive from expand? */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_async_event(): new host drive %d created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
            <span class="cm">/* gdth_analyse_hdrive(hanum, (u16)ha-&gt;info); */</span>
        <span class="p">}</span>   
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_log_event</span><span class="p">(</span><span class="n">gdth_evt_data</span> <span class="o">*</span><span class="n">dvr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_stackframe</span> <span class="n">stack</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_log_event()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Adapter %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">event_string</span><span class="p">);</span> 
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;Adapter %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">event_string</span><span class="p">);</span> 
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span> <span class="o">&amp;&amp;</span> 
        <span class="n">INDEX_OK</span><span class="p">(</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">async_cache_tab</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;GDT: Async. event cache service, event no.: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="n">async_cache_tab</span><span class="p">[</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span><span class="p">];</span>
        
        <span class="cm">/* i: parameter to push, j: stack element to fill */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">case</span> <span class="mi">4</span>:
                <span class="n">stack</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">stream</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="mi">2</span>:
                <span class="n">stack</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">stream</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="k">case</span> <span class="mi">1</span>:
                <span class="n">stack</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">stream</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
                <span class="k">break</span><span class="p">;</span>
              <span class="nl">default:</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">stack</span><span class="p">);</span> 
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="o">&amp;</span><span class="n">f</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">stack</span><span class="p">);</span> 
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT HA %u, Unknown async. event service %d event no. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">service</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">&quot;GDT HA %u, Unknown async. event service %d event no. %d&quot;</span><span class="p">,</span>
                    <span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">ionode</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">service</span><span class="p">,</span><span class="n">dvr</span><span class="o">-&gt;</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">gdth_timer_running</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">nscp</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">)))</span> <span class="p">{</span>
	    <span class="n">gdth_timer_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ha</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">gdth_ha_str</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">act_stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">!=</span> <span class="n">UNUSED_CMND</span><span class="p">)</span>
            <span class="o">++</span><span class="n">act_stats</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">act_rq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nscp</span><span class="o">=</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span><span class="p">;</span> <span class="n">nscp</span><span class="p">;</span> <span class="n">nscp</span><span class="o">=</span><span class="p">(</span><span class="n">Scsi_Cmnd</span><span class="o">*</span><span class="p">)</span><span class="n">nscp</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span>
        <span class="o">++</span><span class="n">act_rq</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_to(): ints %d, ios %d, act_stats %d, act_rq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">act_ints</span><span class="p">,</span> <span class="n">act_ios</span><span class="p">,</span> <span class="n">act_stats</span><span class="p">,</span> <span class="n">act_rq</span><span class="p">));</span>
    <span class="n">act_ints</span> <span class="o">=</span> <span class="n">act_ios</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">gdth_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_timer</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_timer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdth_timer_running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gdth_timer_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_detect(): Initializing timer !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">gdth_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">gdth_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">gdth_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">gdth_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_timer</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gdth_timer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">internal_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">argc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cur_str</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;internal_setup() str %s ints[0] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
            <span class="n">str</span> <span class="o">?</span> <span class="n">str</span><span class="o">:</span><span class="s">&quot;NULL&quot;</span><span class="p">,</span> <span class="n">ints</span> <span class="o">?</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">));</span>

    <span class="cm">/* read irq[] from ints[] */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">argc</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">MAXHA</span><span class="p">)</span>
                <span class="n">argc</span> <span class="o">=</span> <span class="n">MAXHA</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* analyse string */</span>
    <span class="n">argv</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">argv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_str</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*++</span><span class="n">cur_str</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;Y&#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cur_str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;disable:&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">disable</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;reserve_mode:&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
            <span class="n">reserve_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;reverse_scan:&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
            <span class="n">reverse_scan</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;hdr_channel:&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
            <span class="n">hdr_channel</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;max_ids:&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">max_ids</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;rescan:&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">rescan</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;shared_access:&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="n">shared_access</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;probe_eisa_isa:&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
            <span class="n">probe_eisa_isa</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="s">&quot;reserve_list:&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">reserve_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RES_ARGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cur_str</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur_str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur_str</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">*++</span><span class="n">cur_str</span><span class="p">))</span> <span class="p">{</span>
                    <span class="o">--</span><span class="n">cur_str</span><span class="p">;</span>          
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">reserve_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> 
                    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cur_str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur_str</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="o">++</span><span class="n">cur_str</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">argv</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)))</span>
            <span class="o">++</span><span class="n">argv</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">option_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="n">MAXHA</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;option_setup() str %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span> <span class="o">?</span> <span class="n">str</span><span class="o">:</span><span class="s">&quot;NULL&quot;</span><span class="p">));</span> 

    <span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXHA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ints</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">cur</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">internal_setup</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gdth_ctr_name</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_ctr_name()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="n">GDT3_ID</span>:
            <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT3000/3020&quot;</span><span class="p">);</span>
          <span class="k">case</span> <span class="n">GDT3A_ID</span>:
            <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT3000A/3020A/3050A&quot;</span><span class="p">);</span>
          <span class="k">case</span> <span class="n">GDT3B_ID</span>:
            <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT3000B/3010A&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT2000/2020&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_PCI</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT60x0</span>:
            <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT6000/6020/6050&quot;</span><span class="p">);</span>
          <span class="k">case</span> <span class="n">PCI_DEVICE_ID_VORTEX_GDT6000B</span>:
            <span class="k">return</span><span class="p">(</span><span class="s">&quot;GDT6000B/6010&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="cm">/* new controllers (GDT_PCINEW, GDT_PCIMPR, ..) use board_info IOCTL! */</span>

    <span class="k">return</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gdth_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_info()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">binfo</span><span class="p">.</span><span class="n">type_string</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="nf">gdth_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_cmnd_priv</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">BLK_EH_NOT_HANDLED</span><span class="p">;</span>

	<span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;%s() cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t really honor the command timeout, but we try to</span>
<span class="cm">	 * honor 6 times of the actual command timeout! So reset the</span>
<span class="cm">	 * timer if this is less than 6th timeout on this command!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">timeout_count</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">BLK_EH_RESET_TIMER</span><span class="p">;</span>

	<span class="cm">/* Reset the timeout if it is locked IO */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">b</span><span class="p">)].</span><span class="n">lock</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;%s(): locked IO, reset timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">BLK_EH_RESET_TIMER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_eh_bus_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">b</span><span class="p">;</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_eh_bus_reset()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

    <span class="cm">/* clear command tab */</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cmnd</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SPECIAL_SCP</span><span class="p">(</span><span class="n">cmnd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* host drives */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
                    <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CACHESERVICE</span><span class="p">,</span>
                                      <span class="n">GDT_CLUST_RESET</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLUSTER_RESERVED</span><span class="p">;</span>
                <span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* raw devices */</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXID</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">)].</span><span class="n">io_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">gdth_test_busy</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
            <span class="n">gdth_delay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">gdth_internal_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">SCSIRAWSERVICE</span><span class="p">,</span> <span class="n">GDT_RESET_BUS</span><span class="p">,</span>
                          <span class="n">BUS_L2P</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span><span class="n">sector_t</span> <span class="n">cap</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">capacity</span><span class="p">;</span>

    <span class="n">sd</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
    <span class="n">capacity</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_bios_param() ha %d bus %d target %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">heads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* raw device or host drive without mapping information */</span>
        <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;Evaluate mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="n">gdth_eval_mapping</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">heads</span><span class="p">;</span>
        <span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">secs</span><span class="p">;</span>
        <span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">/</span> <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_bios_param(): %d heads, %d secs, %d cyls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span><span class="p">;</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_queuecommand() cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

    <span class="n">cmndinfo</span> <span class="o">=</span> <span class="n">gdth_get_cmndinfo</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cmndinfo</span><span class="p">);</span>

    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">timeout_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">DEFAULT_PRI</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">__gdth_queuecommand</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="n">cmndinfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">gdth_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__gdth_queuecommand</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">gdth_cmndinfo</span> <span class="o">*</span><span class="n">cmndinfo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">scp</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmndinfo</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">wait_for_completion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
    <span class="o">++</span><span class="n">act_ios</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="n">gdth_putq</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scp</span><span class="p">,</span> <span class="n">cmndinfo</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
    <span class="n">gdth_next</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_mutex</span><span class="p">);</span>
    <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_get_host_dev</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_mutex</span><span class="p">);</span>

    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_close()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_event</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_event</span> <span class="n">evt</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_event</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">ionode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">erase</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_source</span> <span class="o">==</span> <span class="n">ES_TEST</span><span class="p">)</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">test</span><span class="p">);</span> 
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_source</span> <span class="o">==</span> <span class="n">ES_DRIVER</span><span class="p">)</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span> 
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_source</span> <span class="o">==</span> <span class="n">ES_SYNC</span><span class="p">)</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">sync</span><span class="p">);</span> 
        <span class="k">else</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">size</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">.</span><span class="n">eu</span><span class="p">.</span><span class="n">async</span><span class="p">);</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">gdth_store_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_source</span><span class="p">,</span> <span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_idx</span><span class="p">,</span>
                         <span class="o">&amp;</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event_data</span><span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">erase</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gdth_clear_events</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">erase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">evt</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">gdth_read_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">evt</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">gdth_readapp_event</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">evt</span><span class="p">.</span><span class="n">erase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>     
    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_event</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_lockdrv</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_lockdrv</span> <span class="n">ldrv</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ldrv</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_lockdrv</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">ldrv</span><span class="p">.</span><span class="n">ionode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ldrv</span><span class="p">.</span><span class="n">drive_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">ldrv</span><span class="p">.</span><span class="n">drives</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_HDRIVES</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">present</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ldrv</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="n">gdth_wait_completion</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="n">gdth_next</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_resetdrv</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_reset</span> <span class="n">res</span><span class="p">;</span>
    <span class="n">gdth_cmd_str</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_reset</span><span class="p">))</span> <span class="o">||</span>
        <span class="n">res</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">MAX_HDRIVES</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ionode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">res</span><span class="p">.</span><span class="n">number</span><span class="p">].</span><span class="n">present</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">));</span>
    <span class="n">cmd</span><span class="p">.</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
    <span class="n">cmd</span><span class="p">.</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_CLUST_RESET</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">cmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>

    <span class="n">rval</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
    <span class="n">res</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_reset</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_general</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_general</span> <span class="n">gen</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">paddr</span><span class="p">;</span> 
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gen</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_general</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">ionode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span> <span class="o">=</span> <span class="n">gdth_ioctl_alloc</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span>
                                     <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">)))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">arg</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_general</span><span class="p">),</span>  
                           <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">OpCode</span> <span class="o">==</span> <span class="n">GDT_IOCTL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ioctl</span><span class="p">.</span><span class="n">p_param</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">Service</span> <span class="o">==</span> <span class="n">CACHESERVICE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* copy elements from 32-bit IOCTL structure */</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockCnt</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockCnt</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span><span class="p">;</span>
                <span class="cm">/* addresses */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">SCATTER_GATHER</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DestAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DestAddr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">SCATTER_GATHER</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DestAddr</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DestAddr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">Service</span> <span class="o">==</span> <span class="n">SCSIRAWSERVICE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* copy elements from 32-bit IOCTL structure */</span>
                <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sense_len</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">bus</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">lun</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">clen</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">clen</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdlen</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdlen</span><span class="p">;</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">direction</span><span class="p">;</span>
                <span class="cm">/* addresses */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">SCATTER_GATHER</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw64</span><span class="p">.</span><span class="n">sense_data</span> <span class="o">=</span> <span class="n">paddr</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">SCATTER_GATHER</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sdata</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
                    <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sg_ranz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sense_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paddr</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">rval</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gen</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_general</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> 
                     <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span> <span class="o">+</span> <span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span> 
    <span class="p">}</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen</span><span class="p">,</span> 
        <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_general</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gdth_ioctl_free</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">gen</span><span class="p">.</span><span class="n">data_len</span><span class="o">+</span><span class="n">gen</span><span class="p">.</span><span class="n">sense_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_hdrlist</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_rescan</span> <span class="o">*</span><span class="n">rsc</span><span class="p">;</span>
    <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">cluster_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">rsc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsc</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">free_fail</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_rescan</span><span class="p">))</span> <span class="o">||</span>
        <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">rsc</span><span class="o">-&gt;</span><span class="n">ionode</span><span class="p">))))</span> <span class="p">{</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">free_fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">));</span>
   
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> 
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> 
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span><span class="p">;</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">&amp;</span> <span class="n">CLUSTER_DRIVE</span><span class="p">)</span> <span class="p">{</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_CLUST_INFO</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
                <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cluster_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">S_OK</span><span class="p">)</span>
                <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> <span class="n">cluster_type</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> 

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">rsc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_rescan</span><span class="p">)))</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_fail:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">rsc</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioc_rescan</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ioctl_rescan</span> <span class="o">*</span><span class="n">rsc</span><span class="p">;</span>
    <span class="n">gdth_cmd_str</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">hdr_cnt</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">info</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cyls</span><span class="p">,</span> <span class="n">hds</span><span class="p">,</span> <span class="n">secs</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span> 

    <span class="n">rsc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">rsc</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">free_fail</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_rescan</span><span class="p">))</span> <span class="o">||</span>
        <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">rsc</span><span class="o">-&gt;</span><span class="n">ionode</span><span class="p">))))</span> <span class="p">{</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">free_fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rsc</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* old method: re-init. cache service */</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_X_INIT_HOST</span><span class="p">;</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">LINUX_OS</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_INIT</span><span class="p">;</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">LINUX_OS</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">hdr_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_OK</span> <span class="o">?</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">info</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_no</span><span class="p">;</span>
        <span class="n">hdr_cnt</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdr_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_INFO</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">else</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span><span class="p">;</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">S_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">present</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">present</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
            <span class="cm">/* evaluate mapping */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SECS32</span><span class="p">;</span>
            <span class="n">gdth_eval_mapping</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cyls</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hds</span><span class="p">,</span><span class="o">&amp;</span><span class="n">secs</span><span class="p">);</span> 
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">heads</span> <span class="o">=</span> <span class="n">hds</span><span class="p">;</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">secs</span> <span class="o">=</span> <span class="n">secs</span><span class="p">;</span>
            <span class="cm">/* round size */</span>
            <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">cyls</span> <span class="o">*</span> <span class="n">hds</span> <span class="o">*</span> <span class="n">secs</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">S_OK</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span> 
        
        <span class="cm">/* extended info, if GDT_64BIT, for drives &gt; 2 TB */</span>
        <span class="cm">/* but we need ha-&gt;info2, not yet stored in scp-&gt;SCp */</span>

        <span class="cm">/* devtype, cluster info, R/W attribs */</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_DEVTYPE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_OK</span> <span class="o">?</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">info</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_CLUST_INFO</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> 
            <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_OK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shared_access</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">info</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">rsc</span><span class="o">-&gt;</span><span class="n">hdr_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cluster_type</span><span class="p">;</span>

        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
        <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_RW_ATTRIBS</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> 
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rw_attribs</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">S_OK</span> <span class="o">?</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">info</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">rsc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_rescan</span><span class="p">)))</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_fail:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">rsc</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span> 
    <span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">scp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">cmnd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>   
    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">cmnd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
    
    <span class="n">TRACE</span><span class="p">((</span><span class="s">&quot;gdth_ioctl() cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>
 
    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">GDTIOCTL_CTRCNT</span>:
      <span class="p">{</span> 
        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">gdth_ctr_count</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_DRVERS</span>:
      <span class="p">{</span> 
        <span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDTH_VERSION</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">GDTH_SUBVERSION</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">case</span> <span class="n">GDTIOCTL_OSVERS</span>:
      <span class="p">{</span> 
        <span class="n">gdth_ioctl_osvers</span> <span class="n">osv</span><span class="p">;</span> 

        <span class="n">osv</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">LINUX_VERSION_CODE</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">osv</span><span class="p">.</span><span class="n">subversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">LINUX_VERSION_CODE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="n">osv</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">LINUX_VERSION_CODE</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_osvers</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_CTRTYPE</span>:
      <span class="p">{</span> 
        <span class="n">gdth_ioctl_ctrtype</span> <span class="n">ctrt</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrt</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_ctrtype</span><span class="p">))</span> <span class="o">||</span>
            <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">ctrt</span><span class="p">.</span><span class="n">ionode</span><span class="p">))))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_ISA</span> <span class="o">||</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GDT_EISA</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ctrt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">GDT_PCIMPR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ctrt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">ctrt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> 
                    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span> <span class="o">==</span> <span class="n">OEM_ID_INTEL</span> <span class="o">?</span> <span class="mh">0xfd</span> <span class="o">:</span> <span class="mh">0xfe</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span> <span class="o">&gt;=</span> <span class="mh">0x300</span><span class="p">)</span>
                    <span class="n">ctrt</span><span class="p">.</span><span class="n">ext_type</span> <span class="o">=</span> <span class="mh">0x6000</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
                <span class="k">else</span> 
                    <span class="n">ctrt</span><span class="p">.</span><span class="n">ext_type</span> <span class="o">=</span> <span class="mh">0x6000</span> <span class="o">|</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">stype</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ctrt</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
            <span class="n">ctrt</span><span class="p">.</span><span class="n">sub_device_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ctrt</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">brd_phys</span><span class="p">;</span>
        <span class="n">ctrt</span><span class="p">.</span><span class="n">oem_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">oem_id</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_ctrtype</span><span class="p">)))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
        
      <span class="k">case</span> <span class="n">GDTIOCTL_GENERAL</span>:
        <span class="k">return</span> <span class="n">ioc_general</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_EVENT</span>:
        <span class="k">return</span> <span class="n">ioc_event</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_LOCKDRV</span>:
        <span class="k">return</span> <span class="n">ioc_lockdrv</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_LOCKCHN</span>:
      <span class="p">{</span>
        <span class="n">gdth_ioctl_lockchn</span> <span class="n">lchn</span><span class="p">;</span>
        <span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchn</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_lockchn</span><span class="p">))</span> <span class="o">||</span>
            <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">lchn</span><span class="p">.</span><span class="n">ionode</span><span class="p">))))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">lchn</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lchn</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">gdth_wait_completion</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">gdth_next</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> 
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_RESCAN</span>:
        <span class="k">return</span> <span class="n">ioc_rescan</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_HDRLIST</span>:
        <span class="k">return</span> <span class="n">ioc_hdrlist</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">);</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_RESET_BUS</span>:
      <span class="p">{</span>
        <span class="n">gdth_ioctl_reset</span> <span class="n">res</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_reset</span><span class="p">))</span> <span class="o">||</span>
            <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">ha</span> <span class="o">=</span> <span class="n">gdth_find_ha</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">ionode</span><span class="p">))))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="n">scp</span>  <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scp</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
        <span class="n">scp</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
        <span class="n">scp</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">gdth_eh_bus_reset</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
        <span class="n">res</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">SUCCESS</span> <span class="o">?</span> <span class="n">S_OK</span> <span class="o">:</span> <span class="n">S_GENERR</span><span class="p">);</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ioctl_reset</span><span class="p">)))</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">case</span> <span class="n">GDTIOCTL_RESET_DRV</span>:
        <span class="k">return</span> <span class="n">ioc_resetdrv</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">);</span>

      <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">gdth_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gdth_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* flush routine */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_flush</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>             <span class="n">i</span><span class="p">;</span>
    <span class="n">gdth_cmd_str</span>    <span class="n">gdtcmd</span><span class="p">;</span>
    <span class="kt">char</span>            <span class="n">cmnd</span><span class="p">[</span><span class="n">MAX_COMMAND_SIZE</span><span class="p">];</span>   
    <span class="n">memset</span><span class="p">(</span><span class="n">cmnd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>

    <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_flush() hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gdtcmd</span><span class="p">.</span><span class="n">BoardNode</span> <span class="o">=</span> <span class="n">LOCALBOARD</span><span class="p">;</span>
            <span class="n">gdtcmd</span><span class="p">.</span><span class="n">Service</span> <span class="o">=</span> <span class="n">CACHESERVICE</span><span class="p">;</span>
            <span class="n">gdtcmd</span><span class="p">.</span><span class="n">OpCode</span> <span class="o">=</span> <span class="n">GDT_FLUSH</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="p">{</span> 
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">BlockNo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache64</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">DeviceNo</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">BlockNo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">gdtcmd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">sg_canz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_flush(): flush ha %d drive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

            <span class="n">gdth_execute</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdtcmd</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* configure lun */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">skip_ms_page_3f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">skip_ms_page_8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">gdth_template</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span>                   <span class="o">=</span> <span class="s">&quot;GDT SCSI Disk Array Controller&quot;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">info</span>                   <span class="o">=</span> <span class="n">gdth_info</span><span class="p">,</span> 
        <span class="p">.</span><span class="n">queuecommand</span>           <span class="o">=</span> <span class="n">gdth_queuecommand</span><span class="p">,</span>
        <span class="p">.</span><span class="n">eh_bus_reset_handler</span>   <span class="o">=</span> <span class="n">gdth_eh_bus_reset</span><span class="p">,</span>
        <span class="p">.</span><span class="n">slave_configure</span>        <span class="o">=</span> <span class="n">gdth_slave_configure</span><span class="p">,</span>
        <span class="p">.</span><span class="n">bios_param</span>             <span class="o">=</span> <span class="n">gdth_bios_param</span><span class="p">,</span>
        <span class="p">.</span><span class="n">proc_info</span>              <span class="o">=</span> <span class="n">gdth_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_timed_out</span>		<span class="o">=</span> <span class="n">gdth_timed_out</span><span class="p">,</span>
        <span class="p">.</span><span class="n">proc_name</span>              <span class="o">=</span> <span class="s">&quot;gdth&quot;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">can_queue</span>              <span class="o">=</span> <span class="n">GDTH_MAXCMDS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">this_id</span>                <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sg_tablesize</span>           <span class="o">=</span> <span class="n">GDTH_MAXSG</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cmd_per_lun</span>            <span class="o">=</span> <span class="n">GDTH_MAXC_P_L</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unchecked_isa_dma</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">use_clustering</span>         <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_isa_probe_one</span><span class="p">(</span><span class="n">u32</span> <span class="n">isa_bios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shp</span><span class="p">;</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">scratch_dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_search_isa</span><span class="p">(</span><span class="n">isa_bios</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">shp</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ha_str</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_init_isa</span><span class="p">(</span><span class="n">isa_bios</span><span class="p">,</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>

	<span class="cm">/* controller found and initialized */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Configuring GDT-ISA HA at BIOS 0x%05X IRQ %u DRQ %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">isa_bios</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">gdth_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;gdth&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Unable to allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span><span class="p">,</span> <span class="s">&quot;gdth&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Unable to allocate DMA channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span><span class="p">,</span><span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span><span class="p">);</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">drq</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span> <span class="o">=</span> <span class="n">gdth_ctr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shp</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmdext</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_dec_counters</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pscratch</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

<span class="cp">#ifdef INT_COAL</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pmsg</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_busy</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max_ids</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">max_ids</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="n">rescan</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_search_drives</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-ISA: Error during device scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdr_channel</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">)</span>
		<span class="n">hdr_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">=</span> <span class="n">hdr_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">screen_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
		<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_id</span>      <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_lun</span>     <span class="o">=</span> <span class="n">MAXLUN</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">);</span>
	<span class="n">gdth_enable_int</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">);</span>
	<span class="n">gdth_timer_init</span><span class="p">();</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_coal_stat:</span>
<span class="cp">#ifdef INT_COAL</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span><span class="p">);</span>
 <span class="nl">out_free_pmsg:</span>
<span class="cp">#endif</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">);</span>
 <span class="nl">out_free_pscratch:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span><span class="p">);</span>
 <span class="nl">out_dec_counters:</span>
	<span class="n">gdth_ctr_count</span><span class="o">--</span><span class="p">;</span>
 <span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
 <span class="nl">out_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_eisa_probe_one</span><span class="p">(</span><span class="n">u16</span> <span class="n">eisa_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shp</span><span class="p">;</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">scratch_dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_search_eisa</span><span class="p">(</span><span class="n">eisa_slot</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">shp</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ha_str</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_init_eisa</span><span class="p">(</span><span class="n">eisa_slot</span><span class="p">,</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>

	<span class="cm">/* controller found and initialized */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Configuring GDT-EISA HA at Slot %d IRQ %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">eisa_slot</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">gdth_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;gdth&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Unable to allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span> <span class="o">=</span> <span class="n">gdth_ctr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shp</span><span class="p">;</span>

	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;EISA detect Bus 0: hanum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">));</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmdext</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pscratch</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

<span class="cp">#ifdef INT_COAL</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pmsg</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_busy</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max_ids</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">max_ids</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="n">rescan</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_search_drives</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-EISA: Error during device scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_ccb_phys</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdr_channel</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">)</span>
		<span class="n">hdr_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">=</span> <span class="n">hdr_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">screen_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span>
		<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_id</span>      <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_lun</span>     <span class="o">=</span> <span class="n">MAXLUN</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">);</span>
	<span class="n">gdth_enable_int</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_ccb_phys</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">);</span>
	<span class="n">gdth_timer_init</span><span class="p">();</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_ccb_phys:</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">),</span>
			<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
 <span class="nl">out_free_coal_stat:</span>
<span class="cp">#ifdef INT_COAL</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span><span class="p">);</span>
 <span class="nl">out_free_pmsg:</span>
<span class="cp">#endif</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">);</span>
 <span class="nl">out_free_pscratch:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span><span class="p">);</span>
 <span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">gdth_ctr_count</span><span class="o">--</span><span class="p">;</span>
 <span class="nl">out_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_EISA */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdth_pci_probe_one</span><span class="p">(</span><span class="n">gdth_pci_str</span> <span class="o">*</span><span class="n">pcistr</span><span class="p">,</span>
			     <span class="n">gdth_ha_str</span> <span class="o">**</span><span class="n">ha_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shp</span><span class="p">;</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">scratch_dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pcistr</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ha_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">shp</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_ha_str</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_init_pci</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcistr</span><span class="p">,</span> <span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>

	<span class="cm">/* controller found and initialized */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Configuring GDT-PCI HA at %d/%d IRQ %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">gdth_interrupt</span><span class="p">,</span>
				<span class="n">IRQF_DISABLED</span><span class="o">|</span><span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;gdth&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI: Unable to allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span> <span class="o">=</span> <span class="n">gdth_ctr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shp</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmdext</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pscratch</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>

<span class="cp">#ifdef INT_COAL</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">scratch_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_pmsg</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span> <span class="o">=</span> <span class="n">scratch_dma_handle</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_busy</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mh">0x200</span> <span class="o">?</span> <span class="n">MAXID</span> <span class="o">:</span> <span class="n">MAX_HDRIVES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_ids</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">max_ids</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span> <span class="o">=</span> <span class="n">max_ids</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GDTH_MAXCMDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">cmd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">UNUSED_CMND</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="n">rescan</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdth_search_drives</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI %d: Error during device scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr_channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdr_channel</span> <span class="o">&gt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">)</span>
		<span class="n">hdr_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">virt_bus</span> <span class="o">=</span> <span class="n">hdr_channel</span><span class="p">;</span>

	<span class="cm">/* 64-bit DMA only supported from FW &gt;= x.43 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">cache_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">raw_feat</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">screen_feat</span> <span class="o">&amp;</span> <span class="n">GDT_64BIT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dma64_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GDT-PCI %d: &quot;</span>
				<span class="s">&quot;Unable to set 32-bit DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-PCI %d: 64-bit DMA enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;GDT-PCI %d: &quot;</span>
				<span class="s">&quot;Unable to set 64/32-bit DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hanum</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_id</span>      <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">tid_cnt</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_lun</span>     <span class="o">=</span> <span class="n">MAXLUN</span><span class="p">;</span>
	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_cnt</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">smp_lock</span><span class="p">);</span>
	<span class="n">gdth_enable_int</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_coal_stat</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">gdth_timer_init</span><span class="p">();</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ha_out</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_coal_stat:</span>
<span class="cp">#ifdef INT_COAL</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAXOFFSETS</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span><span class="p">);</span>
 <span class="nl">out_free_pmsg:</span>
<span class="cp">#endif</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">);</span>
 <span class="nl">out_free_pscratch:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span><span class="p">);</span>
 <span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="n">gdth_ctr_count</span><span class="o">--</span><span class="p">;</span>
 <span class="nl">out_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdth_remove_one</span><span class="p">(</span><span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_remove_one()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>

	<span class="n">gdth_flush</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_free_host_dev</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">ha</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ISA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">dma_channel</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef INT_COAL</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_coal_status</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">MAXOFFSETS</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">coal_stat_phys</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GDTH_SCRATCH</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pscratch</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">scratch_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_msg_str</span><span class="p">),</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pmsg</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">msg_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ccb_phys</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">gdth_cmd_str</span><span class="p">),</span><span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdth_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_halt() event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">event</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_RESTART</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_HALT</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_POWER_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">gdth_flush</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">gdth_notifier</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">gdth_halt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdth_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA: Controller driver disabled from&quot;</span>
                       <span class="s">&quot; command line !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDT-HA: Storage RAID Controller Driver. Version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">GDTH_VERSION_STR</span><span class="p">);</span>

	<span class="cm">/* initializations */</span>
	<span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">gdth_clear_events</span><span class="p">();</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_timer</span><span class="p">);</span>

	<span class="cm">/* As default we do not probe for EISA or ISA controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe_eisa_isa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* scanning for controllers, at first: ISA controller */</span>
<span class="cp">#ifdef CONFIG_ISA</span>
		<span class="n">u32</span> <span class="n">isa_bios</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">isa_bios</span> <span class="o">=</span> <span class="mh">0xc8000UL</span><span class="p">;</span> <span class="n">isa_bios</span> <span class="o">&lt;=</span> <span class="mh">0xd8000UL</span><span class="p">;</span>
		                <span class="n">isa_bios</span> <span class="o">+=</span> <span class="mh">0x8000UL</span><span class="p">)</span>
			<span class="n">gdth_isa_probe_one</span><span class="p">(</span><span class="n">isa_bios</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EISA</span>
		<span class="p">{</span>
			<span class="n">u16</span> <span class="n">eisa_slot</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">eisa_slot</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">eisa_slot</span> <span class="o">&lt;=</span> <span class="mh">0x8000</span><span class="p">;</span>
			                         <span class="n">eisa_slot</span> <span class="o">+=</span> <span class="mh">0x1000</span><span class="p">)</span>
				<span class="n">gdth_eisa_probe_one</span><span class="p">(</span><span class="n">eisa_slot</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* scanning for PCI controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_pci_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">gdth_remove_one</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

	<span class="n">TRACE2</span><span class="p">((</span><span class="s">&quot;gdth_detect() %d controller detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gdth_ctr_count</span><span class="p">));</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;gdth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_fops</span><span class="p">);</span>
	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_notifier</span><span class="p">);</span>
	<span class="n">gdth_polling</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">gdth_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdth_ha_str</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="s">&quot;gdth&quot;</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_notifier</span><span class="p">);</span>

<span class="cp">#ifdef GDTH_STATISTICS</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_timer</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdth_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdth_instances</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">gdth_remove_one</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">gdth_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">gdth_exit</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;gdth=&quot;</span><span class="p">,</span> <span class="n">option_setup</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
