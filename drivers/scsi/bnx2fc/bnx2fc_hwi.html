<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bnx2fc › bnx2fc_hwi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bnx2fc_hwi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2fc_hwi.c: Broadcom NetXtreme II Linux FCoE offload driver.</span>
<span class="cm"> * This file contains the code that low level functions that interact</span>
<span class="cm"> * with 57712 FCoE firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 - 2011 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Bhanu Prakash Gollapudi (bprakash@broadcom.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bnx2fc.h&quot;</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span><span class="p">,</span> <span class="n">bnx2fc_percpu</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_fastpath_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">new_cqe_kcqe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_process_ofld_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">ofld_kcqe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_process_enable_conn_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">ofld_kcqe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_init_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_process_conn_destroy_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">destroy_kcqe</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">bnx2fc_send_stat_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_stat</span> <span class="n">stat_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat_req</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_stat</span><span class="p">));</span>
	<span class="n">stat_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_STAT</span><span class="p">;</span>
	<span class="n">stat_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">stat_req</span><span class="p">.</span><span class="n">stat_params_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buf_dma</span><span class="p">;</span>
	<span class="n">stat_req</span><span class="p">.</span><span class="n">stat_params_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buf_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">stat_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_send_fw_fcoe_init_msg - initiates initial handshake with FCoE f/w</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Send down FCoE firmware init KWQEs which initiates the initial handshake</span>
<span class="cm"> *	with the f/w.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_send_fw_fcoe_init_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_init1</span> <span class="n">fcoe_init1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_init2</span> <span class="n">fcoe_init2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_init3</span> <span class="n">fcoe_init3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hba-&gt;cnic NULL during fcoe fw init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill init1 KWQE */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcoe_init1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_init1</span><span class="p">));</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_INIT1</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span>
					<span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_TASKS</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">sq_num_wqes</span> <span class="o">=</span> <span class="n">BNX2FC_SQ_WQES_MAX</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">rq_num_wqes</span> <span class="o">=</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">rq_buffer_log_size</span> <span class="o">=</span> <span class="n">BNX2FC_RQ_BUF_LOG_SZ</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">cq_num_wqes</span> <span class="o">=</span> <span class="n">BNX2FC_CQ_WQES_MAX</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">dummy_buffer_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">dummy_buffer_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">task_list_pbl_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_dma</span><span class="p">;</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">task_list_pbl_addr_hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">BNX2FC_MINI_JUMBO_MTU</span><span class="p">;</span>

	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_KWQE_INIT1_LOG_PAGE_SIZE_SHIFT</span><span class="p">);</span>

	<span class="n">fcoe_init1</span><span class="p">.</span><span class="n">num_sessions_log</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS_LOG</span><span class="p">;</span>

	<span class="cm">/* fill init2 KWQE */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcoe_init2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_init2</span><span class="p">));</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_INIT2</span><span class="p">;</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span>
					<span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hsi_major_version</span> <span class="o">=</span> <span class="n">FCOE_HSI_MAJOR_VERSION</span><span class="p">;</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hsi_minor_version</span> <span class="o">=</span> <span class="n">FCOE_HSI_MINOR_VERSION</span><span class="p">;</span>


	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hash_tbl_pbl_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl_dma</span><span class="p">;</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">hash_tbl_pbl_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
					   <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">t2_hash_tbl_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_dma</span><span class="p">;</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">t2_hash_tbl_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
					  <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">t2_ptr_hash_tbl_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr_dma</span><span class="p">;</span>
	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">t2_ptr_hash_tbl_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">fcoe_init2</span><span class="p">.</span><span class="n">free_list_count</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span><span class="p">;</span>

	<span class="cm">/* fill init3 KWQE */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcoe_init3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_init3</span><span class="p">));</span>
	<span class="n">fcoe_init3</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_INIT3</span><span class="p">;</span>
	<span class="n">fcoe_init3</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span>
					<span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>
	<span class="n">fcoe_init3</span><span class="p">.</span><span class="n">error_bit_map_lo</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">fcoe_init3</span><span class="p">.</span><span class="n">error_bit_map_hi</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">fcoe_init3</span><span class="p">.</span><span class="n">perf_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcoe_init1</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcoe_init2</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcoe_init3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">bnx2fc_send_fw_fcoe_destroy_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_destroy</span> <span class="n">fcoe_destroy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* fill destroy KWQE */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcoe_destroy</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_destroy</span><span class="p">));</span>
	<span class="n">fcoe_destroy</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_DESTROY</span><span class="p">;</span>
	<span class="n">fcoe_destroy</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span>
					<span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fcoe_destroy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_send_session_ofld_req - initiates FCoE Session offload process</span>
<span class="cm"> *</span>
<span class="cm"> * @port:		port structure pointer</span>
<span class="cm"> * @tgt:		bnx2fc_rport structure pointer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_send_session_ofld_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload1</span> <span class="n">ofld_req1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload2</span> <span class="n">ofld_req2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload3</span> <span class="n">ofld_req3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload4</span> <span class="n">ofld_req4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">conn_id</span><span class="p">;</span>

	<span class="cm">/* Initialize offload request 1 structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofld_req1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload1</span><span class="p">));</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_OFFLOAD_CONN1</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>


	<span class="n">conn_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">fcoe_conn_id</span> <span class="o">=</span> <span class="n">conn_id</span><span class="p">;</span>


	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_dma</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">sq_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">rq_pbl_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_pbl_dma</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">rq_pbl_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_pbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">rq_first_pbe_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_dma</span><span class="p">;</span>
	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">rq_first_pbe_addr_hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req1</span><span class="p">.</span><span class="n">rq_prod</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="cm">/* Initialize offload request 2 structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofld_req2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload2</span><span class="p">));</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_OFFLOAD_CONN2</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">tx_max_fc_pay_len</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span><span class="p">;</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_dma</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">cq_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">xferq_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">xferq_dma</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">xferq_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">xferq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">conn_db_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">conn_db_dma</span><span class="p">;</span>
	<span class="n">ofld_req2</span><span class="p">.</span><span class="n">conn_db_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">conn_db_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Initialize offload request 3 structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofld_req3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload3</span><span class="p">));</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_OFFLOAD_CONN3</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_KWQE_CONN_OFFLOAD3_VLAN_ID_SHIFT</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_CONN_OFFLOAD3_PRIORITY_SHIFT</span><span class="p">;</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;ofld_req: port_id = 0, link down?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store s_id of the initiator for further reference. This will</span>
<span class="cm">	 * be used during disable/destroy during linkdown processing as</span>
<span class="cm">	 * when the lport is reset, the port_id also is reset to 0</span>
<span class="cm">	 */</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">tx_total_conc_seqs</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">max_seq</span><span class="p">;</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">tx_max_conc_seqs_c3</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">max_seq</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">rx_max_fc_pay_len</span>  <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">;</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">rx_total_conc_seqs</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_SEQS</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">rx_max_conc_seqs_c3</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_SEQS</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">rx_open_seqs_exch_c3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">confq_first_pbe_addr_lo</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">confq_dma</span><span class="p">;</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">confq_first_pbe_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">confq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* set mul_n_port_ids supported flag to 0, until it is supported */</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	ofld_req3.flags |= (((lport-&gt;send_sp_features &amp; FC_SP_FT_MNA) ? 1:0) &lt;&lt;</span>
<span class="cm">			    FCOE_KWQE_CONN_OFFLOAD3_B_MUL_N_PORT_IDS_SHIFT);</span>
<span class="cm">	*/</span>
	<span class="cm">/* Info from PLOGI response */</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_EDTR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			     <span class="n">FCOE_KWQE_CONN_OFFLOAD3_B_E_D_TOV_RES_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_SEQC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			     <span class="n">FCOE_KWQE_CONN_OFFLOAD3_B_CONT_INCR_SEQ_CNT_SHIFT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Info from PRLI response, this info is used for sequence level error</span>
<span class="cm">	 * recovery support</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				    <span class="n">FCOE_KWQE_CONN_OFFLOAD3_B_CONF_REQ_SHIFT</span><span class="p">;</span>
		<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FC_RP_FLAGS_REC_SUPPORTED</span><span class="p">)</span>
				    <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				    <span class="n">FCOE_KWQE_CONN_OFFLOAD3_B_REC_VALID_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* vlan flag */</span>
	<span class="n">ofld_req3</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_enabled</span> <span class="o">&lt;&lt;</span>
			    <span class="n">FCOE_KWQE_CONN_OFFLOAD3_B_VLAN_FLAG_SHIFT</span><span class="p">);</span>

	<span class="cm">/* C2_VALID and ACK flags are not set as they are not suppported */</span>


	<span class="cm">/* Initialize offload request 4 structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ofld_req4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_offload4</span><span class="p">));</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_OFFLOAD_CONN4</span><span class="p">;</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">e_d_tov_timer_val</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>


	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
							<span class="cm">/* local mac */</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
							<span class="cm">/* fcf mac */</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">lcq_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">lcq_dma</span><span class="p">;</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">lcq_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">lcq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">confq_pbl_base_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">confq_pbl_dma</span><span class="p">;</span>
	<span class="n">ofld_req4</span><span class="p">.</span><span class="n">confq_pbl_base_addr_hi</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">confq_pbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req1</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req2</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req3</span><span class="p">;</span>
	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ofld_req4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_send_session_enable_req - initiates FCoE Session enablement</span>
<span class="cm"> *</span>
<span class="cm"> * @port:		port structure pointer</span>
<span class="cm"> * @tgt:		bnx2fc_rport structure pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_send_session_enable_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_enable_disable</span> <span class="n">enbl_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enbl_req</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_enable_disable</span><span class="p">));</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_ENABLE_CONN</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
							<span class="cm">/* local mac */</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">!=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;WARN: enable_req port_id = 0x%x,&quot;</span>
				<span class="s">&quot;sid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
		<span class="n">port_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_KWQE_CONN_ENABLE_DISABLE_VLAN_ID_SHIFT</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_CONN_ENABLE_DISABLE_PRIORITY_SHIFT</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">vlan_flag</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_enabled</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">enbl_req</span><span class="p">.</span><span class="n">conn_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">enbl_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_send_session_disable_req - initiates FCoE Session disable</span>
<span class="cm"> *</span>
<span class="cm"> * @port:		port structure pointer</span>
<span class="cm"> * @tgt:		bnx2fc_rport structure pointer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_send_session_disable_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_enable_disable</span> <span class="n">disable_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disable_req</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_enable_disable</span><span class="p">));</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_DISABLE_CONN</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">src_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_lo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">dst_mac_addr_hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">s_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>


	<span class="n">port_id</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">d_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">conn_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_KWQE_CONN_ENABLE_DISABLE_VLAN_ID_SHIFT</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">vlan_tag</span> <span class="o">|=</span>
			<span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_CONN_ENABLE_DISABLE_PRIORITY_SHIFT</span><span class="p">;</span>
	<span class="n">disable_req</span><span class="p">.</span><span class="n">vlan_flag</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_enabled</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">disable_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_send_session_destroy_req - initiates FCoE Session destroy</span>
<span class="cm"> *</span>
<span class="cm"> * @port:		port structure pointer</span>
<span class="cm"> * @tgt:		bnx2fc_rport structure pointer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_send_session_destroy_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_kwqe_conn_destroy</span> <span class="n">destroy_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_kwqes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">destroy_req</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kwqe_conn_destroy</span><span class="p">));</span>
	<span class="n">destroy_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">FCOE_KWQE_OPCODE_DESTROY_CONN</span><span class="p">;</span>
	<span class="n">destroy_req</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">FCOE_KWQE_LAYER_CODE</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_KWQE_HEADER_LAYER_CODE_SHIFT</span><span class="p">);</span>

	<span class="n">destroy_req</span><span class="p">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">destroy_req</span><span class="p">.</span><span class="n">conn_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>

	<span class="n">kwqe_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kwqe</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">destroy_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">&amp;&amp;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">submit_kwqes</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">kwqe_arr</span><span class="p">,</span> <span class="n">num_kwqes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_valid_lport</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_lport</span> <span class="o">*</span><span class="n">blport</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">blport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blport</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">==</span> <span class="n">lport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_unsol_els_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_unsol_els</span> <span class="o">*</span><span class="n">unsol_els</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">unsol_els</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2fc_unsol_els</span><span class="p">,</span> <span class="n">unsol_els_work</span><span class="p">);</span>
	<span class="n">lport</span> <span class="o">=</span> <span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_lport</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">lport</span><span class="p">))</span>
		<span class="n">fc_exch_recv</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">unsol_els</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_process_l2_frame_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">l2_oxid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_unsol_els</span> <span class="o">*</span><span class="n">unsol_els</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>


	<span class="n">unsol_els</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">unsol_els</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unsol_els</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Unable to allocate unsol_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;l2_frame_compl l2_oxid = 0x%x, frame_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">l2_oxid</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">);</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">frame_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;fc_frame_alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">unsol_els</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="cm">/* Copy FC Frame header and payload into the frame */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l2_oxid</span> <span class="o">!=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">)</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">l2_oxid</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_TEST</span><span class="p">)</span> <span class="o">||</span>	<span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_ESTC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_FAN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_CSU</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * No need to reply for these</span>
<span class="cm">				 * ELS requests</span>
<span class="cm">				 */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;dropping ELS 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">unsol_els</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">fcoe_fc_crc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">fc_frame_init</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">fr_dev</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
		<span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_SOF_I3</span><span class="p">;</span>
		<span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_EOF_T</span><span class="p">;</span>
		<span class="n">fr_crc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">crc</span><span class="p">);</span>
		<span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
		<span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
		<span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">unsol_els_work</span><span class="p">,</span> <span class="n">bnx2fc_unsol_els_work</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">bnx2fc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unsol_els</span><span class="o">-&gt;</span><span class="n">unsol_els_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;fh_r_ctl = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">unsol_els</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_process_unsol_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">num_rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_err_report_entry</span> <span class="o">*</span><span class="n">err_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rq_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">buf1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">io_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="o">*</span><span class="n">task_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">task_idx</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">err_warn_bit_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_warn</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>


	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Entered UNSOL COMPLETION wqe = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wqe</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wqe</span> <span class="o">&amp;</span> <span class="n">FCOE_UNSOLICITED_CQE_SUBTYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FCOE_UNSOLICITED_FRAME_CQE_TYPE</span>:
		<span class="n">frame_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">wqe</span> <span class="o">&amp;</span> <span class="n">FCOE_UNSOLICITED_CQE_PKT_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			     <span class="n">FCOE_UNSOLICITED_CQE_PKT_LEN_SHIFT</span><span class="p">;</span>

		<span class="n">num_rq</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">+</span> <span class="n">BNX2FC_RQ_BUF_SZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BNX2FC_RQ_BUF_SZ</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="n">rq_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bnx2fc_get_next_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">rq_data</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf1</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">num_rq</span> <span class="o">*</span> <span class="n">BNX2FC_RQ_BUF_SZ</span><span class="p">),</span>
					      <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Memory alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rq</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
				<span class="n">rq_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">bnx2fc_get_next_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">BNX2FC_RQ_BUF_SZ</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="n">rq_data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">buf1</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bnx2fc_process_l2_frame_compl</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span>
					      <span class="n">FC_XID_UNKNOWN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">rq_data</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="n">bnx2fc_return_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FCOE_ERROR_DETECTION_CQE_TYPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * In case of error reporting CQE a single RQ entry</span>
<span class="cm">		 * is consumed.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="n">num_rq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span> <span class="o">*</span><span class="p">)</span>
			     <span class="n">bnx2fc_get_next_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xid</span> <span class="o">=</span> <span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">fc_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">;</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Unsol Error Frame OX_ID = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;err_warn_bitmap = %08x:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_hi</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_lo</span><span class="p">);</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;buf_offsets - tx = 0x%x, rx = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">tx_buf_off</span><span class="p">,</span> <span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx_buf_off</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span> <span class="o">&gt;</span> <span class="n">BNX2FC_MAX_XID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;xid(0x%x) out of FW range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">xid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">task_idx</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">/</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">%</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
		<span class="n">task_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">task_idx</span><span class="p">];</span>
		<span class="n">task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">task_page</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

		<span class="n">io_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">xid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_req</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">BNX2FC_SCSI_CMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;err_warn: Not a SCSI cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_IO_CLEANUP</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">req_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;unsol_err: cleanup in &quot;</span>
					    <span class="s">&quot;progress.. ignore unsol err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err_warn_bit_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_lo</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_NUM_ERR_BITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_warn_bit_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err_warn</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If ABTS is already in progress, and FW error is</span>
<span class="cm">		 * received after that, do not cancel the timeout_work</span>
<span class="cm">		 * and let the error recovery continue by explicitly</span>
<span class="cm">		 * logging out the target, when the ABTS eventually</span>
<span class="cm">		 * times out.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_ISSUE_ABTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">req_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;err_warn: io_req (0x%x) already &quot;</span>
					    <span class="s">&quot;in ABTS processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;err = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_warn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip_rec</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err_warn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_REC_TOV_TIMER_EXPIRATION</span>:
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_DATA_OOO_RO</span>:
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_COMMON_INCORRECT_SEQ_CNT</span>:
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_DATA_SOFI3_SEQ_ACTIVE_SET</span>:
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_FCP_RSP_OPENED_SEQ</span>:
		<span class="k">case</span> <span class="n">FCOE_ERROR_CODE_DATA_SOFN_SEQ_ACTIVE_RESET</span>:
			<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;REC TOV popped for xid - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">xid</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">err_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">err_entry</span><span class="p">,</span> <span class="n">err_entry</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_SRR_SENT</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">req_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_rec</span><span class="p">(</span><span class="n">io_req</span><span class="p">);</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">skip_rec</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;SRR in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_err_rqe</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">skip_rec:</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_ISSUE_ABTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">req_flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Cancel the timeout_work, as we received IO</span>
<span class="cm">		 * completion with FW error.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">timeout_work</span><span class="p">))</span>
			<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">bnx2fc_cmd_release</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_initiate_abts</span><span class="p">(</span><span class="n">io_req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;err_warn: initiate_abts &quot;</span>
				<span class="s">&quot;failed xid = 0x%x. issue cleanup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
			<span class="n">bnx2fc_initiate_cleanup</span><span class="p">(</span><span class="n">io_req</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">ret_err_rqe:</span>
		<span class="n">bnx2fc_return_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FCOE_WARNING_DETECTION_CQE_TYPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 *In case of warning reporting CQE a single RQ entry</span>
<span class="cm">		 * is consumes.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="n">num_rq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span> <span class="o">*</span><span class="p">)</span>
			     <span class="n">bnx2fc_get_next_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">xid</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">fc_hdr</span><span class="p">.</span><span class="n">ox_id</span><span class="p">);</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Unsol Warning Frame OX_ID = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;err_warn_bitmap = %08x:%08x&quot;</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_hi</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_lo</span><span class="p">);</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;buf_offsets - tx = 0x%x, rx = 0x%x&quot;</span><span class="p">,</span>
			<span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">tx_buf_off</span><span class="p">,</span> <span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx_buf_off</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xid</span> <span class="o">&gt;</span> <span class="n">BNX2FC_MAX_XID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;xid(0x%x) out of FW range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_warn_rqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err_warn_bit_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">err_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">err_warn_bitmap_lo</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_NUM_ERR_BITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_warn_bit_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err_warn</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;warn = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_warn</span><span class="p">);</span>

		<span class="n">task_idx</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">/</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">%</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
		<span class="n">task_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="p">)</span>
			     <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">task_idx</span><span class="p">];</span>
		<span class="n">task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">task_page</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">io_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">xid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_req</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ret_warn_rqe</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">BNX2FC_SCSI_CMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;err_warn: Not a SCSI cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ret_warn_rqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">err_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">err_entry</span><span class="p">,</span> <span class="n">err_entry</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_err_report_entry</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err_warn</span> <span class="o">==</span> <span class="n">FCOE_ERROR_CODE_REC_TOV_TIMER_EXPIRATION</span><span class="p">)</span>
			<span class="cm">/* REC_TOV is not a warning code */</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Unsolicited warning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">ret_warn_rqe:</span>
		<span class="n">bnx2fc_return_rqe</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unsol Compl: Invalid CQE Subtype</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_process_cq_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">io_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">task_idx</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xid</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">cmd_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_rq</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
	<span class="n">xid</span> <span class="o">=</span> <span class="n">wqe</span> <span class="o">&amp;</span> <span class="n">FCOE_PEND_WQ_CQE_TASK_ID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xid</span> <span class="o">&gt;=</span> <span class="n">BNX2FC_MAX_TASKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR:xid out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">task_idx</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">/</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">%</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
	<span class="n">task_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">task_idx</span><span class="p">];</span>
	<span class="n">task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">task_page</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

	<span class="n">num_rq</span> <span class="o">=</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span>
		   <span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_NUM_RQ_WQE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		   <span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_NUM_RQ_WQE_SHIFT</span><span class="p">);</span>

	<span class="n">io_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">xid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR? cq_compl - io_req is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Timestamp IO completion time */</span>
	<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">;</span>

	<span class="n">rx_state</span> <span class="o">=</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span>
		    <span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_RX_STATE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_RX_STATE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Process other IO completion types */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2FC_SCSI_CMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span> <span class="n">FCOE_TASK_RX_STATE_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2fc_process_scsi_cmd_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span> <span class="n">FCOE_TASK_RX_STATE_ABTS_COMPLETED</span><span class="p">)</span>
			<span class="n">bnx2fc_process_abts_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span>
			 <span class="n">FCOE_TASK_RX_STATE_EXCHANGE_CLEANUP_COMPLETED</span><span class="p">)</span>
			<span class="n">bnx2fc_process_cleanup_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid rx state - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rx_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2FC_TASK_MGMT_CMD</span>:
		<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;Processing TM complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2fc_process_tm_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2FC_ABTS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * ABTS request received by firmware. ABTS response</span>
<span class="cm">		 * will be delivered to the task belonging to the IO</span>
<span class="cm">		 * that was aborted</span>
<span class="cm">		 */</span>
		<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;cq_compl- ABTS sent out by fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">bnx2fc_cmd_release</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2FC_ELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span> <span class="n">FCOE_TASK_RX_STATE_COMPLETED</span><span class="p">)</span>
			<span class="n">bnx2fc_process_els_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span> <span class="n">FCOE_TASK_RX_STATE_ABTS_COMPLETED</span><span class="p">)</span>
			<span class="n">bnx2fc_process_abts_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_state</span> <span class="o">==</span>
			 <span class="n">FCOE_TASK_RX_STATE_EXCHANGE_CLEANUP_COMPLETED</span><span class="p">)</span>
			<span class="n">bnx2fc_process_cleanup_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">num_rq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid rx state =  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rx_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2FC_CLEANUP</span>:
		<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;cq_compl- cleanup resp rcvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">bnx2fc_cmd_release</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2FC_SEQ_CLEANUP</span>:
		<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;cq_compl(0x%x) - seq cleanup resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
		<span class="n">bnx2fc_process_seq_cleanup_compl</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">rx_state</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">bnx2fc_cmd_release</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid cmd_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">tgt_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_arm_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b577xx_fcoe_rx_doorbell</span> <span class="o">*</span><span class="n">rx_db</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rx_db</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rx_db</span><span class="o">-&gt;</span><span class="n">doorbell_cq_cons</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span> <span class="o">|</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_curr_toggle_bit</span> <span class="o">&lt;&lt;</span>
			<span class="n">FCOE_CQE_TOGGLE_BIT_SHIFT</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_db</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctx_base</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">bnx2fc_work</span> <span class="o">*</span><span class="nf">bnx2fc_alloc_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="n">work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">tgt</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">wqe</span> <span class="o">=</span> <span class="n">wqe</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">work</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2fc_process_new_cqes</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_cqe</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cq_cons</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_free_sqes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_cqes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wqe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * cq_lock is a low contention lock used to protect</span>
<span class="cm">	 * the CQ data structure from being freed up during</span>
<span class="cm">	 * the upload operation</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;process_new_cqes: cq is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">cq_cons</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span><span class="p">;</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">[</span><span class="n">cq_cons</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">wqe</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FCOE_CQE_TOGGLE_BIT</span><span class="p">)</span> <span class="o">==</span>
	       <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_curr_toggle_bit</span> <span class="o">&lt;&lt;</span>
	       <span class="n">FCOE_CQE_TOGGLE_BIT_SHIFT</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* new entry on the cq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wqe</span> <span class="o">&amp;</span> <span class="n">FCOE_CQE_CQE_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unsolicited event notification */</span>
			<span class="n">bnx2fc_process_unsol_compl</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">wqe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Pending work request completion */</span>
			<span class="k">struct</span> <span class="n">bnx2fc_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span> <span class="o">*</span><span class="n">fps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">wqe</span> <span class="o">%</span> <span class="n">num_possible_cpus</span><span class="p">();</span>

			<span class="n">fps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2fc_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">iothread</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

			<span class="n">work</span> <span class="o">=</span> <span class="n">bnx2fc_alloc_work</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">wqe</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="p">)</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
<span class="nl">unlock:</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>

			<span class="cm">/* Pending work request completion */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">iothread</span> <span class="o">&amp;&amp;</span> <span class="n">work</span><span class="p">)</span>
				<span class="n">wake_up_process</span><span class="p">(</span><span class="n">fps</span><span class="o">-&gt;</span><span class="n">iothread</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bnx2fc_process_cq_compl</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">wqe</span><span class="p">);</span>
			<span class="n">num_free_sqes</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cqe</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num_cqes</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span> <span class="o">==</span> <span class="n">BNX2FC_CQ_WQES_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cqe</span> <span class="o">=</span> <span class="n">cq</span><span class="p">;</span>
			<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_curr_toggle_bit</span> <span class="o">=</span>
				<span class="mi">1</span> <span class="o">-</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_curr_toggle_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_cqes</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Arm CQ only if doorbell is mapped */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctx_base</span><span class="p">)</span>
			<span class="n">bnx2fc_arm_cq</span><span class="p">(</span><span class="n">tgt</span><span class="p">);</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">num_free_sqes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">free_sqes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">cq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_fastpath_notification - process global event queue (KCQ)</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:		adapter structure pointer</span>
<span class="cm"> * @new_cqe_kcqe:	pointer to newly DMA&#39;d KCQ entry</span>
<span class="cm"> *</span>
<span class="cm"> * Fast path event notification handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_fastpath_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">new_cqe_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">conn_id</span> <span class="o">=</span> <span class="n">new_cqe_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">conn_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;conn_id 0x%x not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conn_id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2fc_process_new_cqes</span><span class="p">(</span><span class="n">tgt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_process_ofld_cmpl - process FCoE session offload completion</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @ofld_kcqe:	connection offload kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handle session offload completion, enable the session if offload is</span>
<span class="cm"> * successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_process_ofld_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">ofld_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span>		<span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span>		<span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span>		<span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">conn_id</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">context_id</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">rc</span><span class="p">;</span>

	<span class="n">conn_id</span> <span class="o">=</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">context_id</span> <span class="o">=</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_context_id</span><span class="p">;</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">conn_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="n">PFX</span> <span class="s">&quot;ERROR:ofld_cmpl: No pending ofld req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Entered ofld compl - context_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_context_id</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR:ofld_cmpl: HBA mis-match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ofld_cmpl_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * cnic has allocated a context_id for this session; use this</span>
<span class="cm">	 * while enabling the session.</span>
<span class="cm">	 */</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">context_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span>
				<span class="n">FCOE_KCQE_COMPLETION_STATUS_CTX_ALLOC_FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to allocate FCoE context &quot;</span>
				<span class="s">&quot;resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_CTX_ALLOC_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">ofld_cmpl_err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* now enable the session */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_session_enable_req</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tgt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;enable session failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">ofld_cmpl_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">ofld_cmpl_err:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_OFLD_REQ_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_process_enable_conn_cmpl - process FCoE session enable completion</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @ofld_kcqe:	connection offload kcqe pointer</span>
<span class="cm"> *</span>
<span class="cm"> * handle session enable completion, mark the rport as ready</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_process_enable_conn_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">ofld_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span>		<span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span>		<span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">conn_id</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">context_id</span><span class="p">;</span>

	<span class="n">context_id</span> <span class="o">=</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_context_id</span><span class="p">;</span>
	<span class="n">conn_id</span> <span class="o">=</span> <span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">conn_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR:enbl_cmpl: No pending ofld req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Enable compl - context_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_context_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * context_id should be the same for this target during offload</span>
<span class="cm">	 * and enable</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">!=</span> <span class="n">context_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;context id mis-match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc-enbl_cmpl: HBA mis-match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enbl_cmpl_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofld_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enbl_cmpl_err</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* enable successful - rport ready for issuing IOs */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_OFFLOADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_OFLD_REQ_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">enbl_cmpl_err:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_OFLD_REQ_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ofld_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_process_conn_disable_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">disable_kcqe</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">bnx2fc_rport</span>		<span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">conn_id</span><span class="p">;</span>

	<span class="n">conn_id</span> <span class="o">=</span> <span class="n">disable_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">conn_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR: disable_cmpl: No disable req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">PFX</span> <span class="s">&quot;disable_cmpl: conn_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conn_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Disable failed with cmpl status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">disable_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable successful */</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;disable successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_OFFLOADED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_UPLD_REQ_COMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">upld_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_process_conn_destroy_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">destroy_kcqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span>		<span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">conn_id</span><span class="p">;</span>

	<span class="n">conn_id</span> <span class="o">=</span> <span class="n">destroy_kcqe</span><span class="o">-&gt;</span><span class="n">fcoe_conn_id</span><span class="p">;</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">conn_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;destroy_cmpl: No destroy req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;destroy_cmpl: conn_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conn_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">destroy_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Destroy conn failed, cmpl status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">destroy_kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* destroy successful */</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;upload successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DESTROYED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_UPLD_REQ_COMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">upld_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_init_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FCOE_KCQE_COMPLETION_STATUS_INVALID_OPCODE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;init_failure due to invalid opcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FCOE_KCQE_COMPLETION_STATUS_CTX_ALLOC_FAILURE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;init failed due to ctx alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FCOE_KCQE_COMPLETION_STATUS_NIC_ERROR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;init_failure due to NIC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FCOE_KCQE_COMPLETION_STATUS_ERROR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;init failure due to compl status err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FCOE_KCQE_COMPLETION_STATUS_WRONG_HSI_VERSION</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;init failure due to HSI mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unknown Error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_indicae_kcqe - process KCQE</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	adapter structure pointer</span>
<span class="cm"> * @kcqe:	kcqe pointer</span>
<span class="cm"> * @num_cqe:	Number of completion queue elements</span>
<span class="cm"> *</span>
<span class="cm"> * Generic KCQ event handler</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2fc_indicate_kcqe</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kcqe</span> <span class="o">*</span><span class="n">kcq</span><span class="p">[],</span>
					<span class="n">u32</span> <span class="n">num_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="n">kcqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kcqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_kcqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">kcq</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_CQ_EVENT_NOTIFICATION</span>:
			<span class="n">bnx2fc_fastpath_notification</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">kcqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_OFFLOAD_CONN</span>:
			<span class="n">bnx2fc_process_ofld_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">kcqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_ENABLE_CONN</span>:
			<span class="n">bnx2fc_process_enable_conn_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">kcqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_INIT_FUNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">!=</span>
					<span class="n">FCOE_KCQE_COMPLETION_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bnx2fc_init_failure</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span>
						<span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
				<span class="n">bnx2fc_get_link_state</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;[%.2x]: FCOE_INIT passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_DESTROY_FUNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">!=</span>
					<span class="n">FCOE_KCQE_COMPLETION_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;DESTROY failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;DESTROY success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DESTROY_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_wait</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_DISABLE_CONN</span>:
			<span class="n">bnx2fc_process_conn_disable_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">kcqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_DESTROY_CONN</span>:
			<span class="n">bnx2fc_process_conn_destroy_cmpl</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">kcqe</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_STAT_FUNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">!=</span>
			    <span class="n">FCOE_KCQE_COMPLETION_STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;STAT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stat_req_done</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FCOE_KCQE_OPCODE_FCOE_ERROR</span>:
			<span class="cm">/* fall thru */</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unknown opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">kcqe</span><span class="o">-&gt;</span><span class="n">op_code</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_add_2_sq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">xid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_sqe</span> <span class="o">*</span><span class="n">sqe</span><span class="p">;</span>

	<span class="n">sqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">[</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_prod_idx</span><span class="p">];</span>

	<span class="cm">/* Fill SQ WQE */</span>
	<span class="n">sqe</span><span class="o">-&gt;</span><span class="n">wqe</span> <span class="o">=</span> <span class="n">xid</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_SQE_TASK_ID_SHIFT</span><span class="p">;</span>
	<span class="n">sqe</span><span class="o">-&gt;</span><span class="n">wqe</span> <span class="o">|=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_curr_toggle_bit</span> <span class="o">&lt;&lt;</span> <span class="n">FCOE_SQE_TOGGLE_BIT_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Advance SQ Prod Idx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_prod_idx</span> <span class="o">==</span> <span class="n">BNX2FC_SQ_WQES_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_curr_toggle_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_curr_toggle_bit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_ring_doorbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b577xx_doorbell_set_prod</span> <span class="o">*</span><span class="n">sq_db</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_db</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">sq_db</span><span class="o">-&gt;</span><span class="n">prod</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_prod_idx</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">sq_curr_toggle_bit</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">sq_db</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctx_base</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2fc_map_doorbell</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_off</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">reg_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="n">reg_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">BNX2X_DOORBELL_PCI_BAR</span><span class="p">);</span>
	<span class="n">reg_off</span> <span class="o">=</span> <span class="n">BNX2FC_5771X_DB_PAGE_SIZE</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">context_id</span> <span class="o">&amp;</span> <span class="mh">0x1FFFF</span><span class="p">)</span> <span class="o">+</span> <span class="n">DPM_TRIGER_TYPE</span><span class="p">;</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctx_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">reg_off</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">ctx_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">bnx2fc_get_next_rqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num_items</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_cons_idx</span> <span class="o">*</span> <span class="n">BNX2FC_RQ_BUF_SZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_cons_idx</span> <span class="o">+</span> <span class="n">num_items</span> <span class="o">&gt;</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_cons_idx</span> <span class="o">+=</span> <span class="n">num_items</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_cons_idx</span> <span class="o">&gt;=</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">)</span>
		<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_cons_idx</span> <span class="o">-=</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_return_rqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num_items</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* return the rq buffer */</span>
	<span class="n">u32</span> <span class="n">next_prod_idx</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_prod_idx</span> <span class="o">+</span> <span class="n">num_items</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">next_prod_idx</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">==</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wrap around RQ */</span>
		<span class="n">next_prod_idx</span> <span class="o">+=</span> <span class="mh">0x8000</span> <span class="o">-</span> <span class="n">BNX2FC_RQ_WQES_MAX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_prod_idx</span> <span class="o">=</span> <span class="n">next_prod_idx</span><span class="p">;</span>
	<span class="n">tgt</span><span class="o">-&gt;</span><span class="n">conn_db</span><span class="o">-&gt;</span><span class="n">rq_prod</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rq_prod_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_init_seq_cleanup_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">seq_clnp_req</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">orig_io_req</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc_cmd</span> <span class="o">=</span> <span class="n">orig_io_req</span><span class="o">-&gt;</span><span class="n">sc_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">seq_clnp_req</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_bd_ctx</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">orig_io_req</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">orig_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ext_mul_sges_ctx</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_SEQUENCE_CLEANUP</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_task_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">orig_xid</span> <span class="o">=</span> <span class="n">orig_io_req</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phys_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">orig_io_req</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bd_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_task_idx</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">orig_task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">orig_task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_READ</span><span class="p">;</span>

	<span class="cm">/* Tx flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span>
				<span class="n">FCOE_TASK_TX_STATE_SEQUENCE_CLEANUP</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TX_STATE_SHIFT</span><span class="p">;</span>
	<span class="cm">/* init flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">task_type</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TASK_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="n">FCOE_TASK_CLASS_TYPE_3</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CLASS_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">context_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">context_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">cleanup</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">cleaned_task_id</span> <span class="o">=</span> <span class="n">orig_xid</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">cleanup</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">rolled_tx_seq_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">cleanup</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">rolled_tx_data_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">bd_count</span> <span class="o">=</span> <span class="n">orig_io_req</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_valid</span><span class="p">;</span>

	<span class="cm">/* obtain the appropriate bd entry from relative offset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phys_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_bd_ctx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig_task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span>
				<span class="n">bd_count</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_off</span> <span class="o">=</span>
				<span class="n">offset</span><span class="p">;</span> <span class="cm">/* adjusted offset */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">orig_task_idx</span> <span class="o">=</span> <span class="n">orig_xid</span> <span class="o">/</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">orig_xid</span> <span class="o">%</span> <span class="n">BNX2FC_TASKS_PER_PAGE</span><span class="p">;</span>

		<span class="n">task_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="p">)</span>
			     <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">orig_task_idx</span><span class="p">];</span>
		<span class="n">orig_task</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">task_page</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

		<span class="cm">/* Multiple SGEs were used for this IO */</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">read_info</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span> <span class="n">bd_count</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_off</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="cm">/*adjusted offset */</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">rx_seq_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_rx_seq_ctx</span><span class="p">));</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">rx_seq_ctx</span><span class="p">.</span><span class="n">low_exp_ro</span> <span class="o">=</span> <span class="n">orig_offset</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">rx_seq_ctx</span><span class="p">.</span><span class="n">high_exp_ro</span> <span class="o">=</span> <span class="n">orig_offset</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">bnx2fc_init_cleanup_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">io_req</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">orig_xid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_EXCHANGE_CLEANUP</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span><span class="p">));</span>

	<span class="cm">/* Tx Write Rx Read */</span>
	<span class="cm">/* init flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">task_type</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TASK_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="n">FCOE_TASK_CLASS_TYPE_3</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CLASS_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_TAPE</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_DISK</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">cleanup</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">cleaned_task_id</span> <span class="o">=</span> <span class="n">orig_xid</span><span class="p">;</span>

	<span class="cm">/* Tx flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span>
				<span class="n">FCOE_TASK_TX_STATE_EXCHANGE_CLEANUP</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TX_STATE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Rx Read Tx Write */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">context_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_EXP_FIRST_FRAME_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_init_mp_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">io_req</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_mp_req</span> <span class="o">*</span><span class="n">mp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">mp_req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ext_mul_sges_ctx</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">task_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">temp_hdr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">context_id</span><span class="p">;</span>


	<span class="cm">/* Obtain task_type */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">BNX2FC_TASK_MGMT_CMD</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">BNX2FC_ELS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_MIDPATH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">BNX2FC_ABTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_ABTS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span><span class="p">));</span>

	<span class="cm">/* Setup the task from io_req for easy reference */</span>
	<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>

	<span class="n">BNX2FC_IO_DBG</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="s">&quot;Init MP task for cmd_type = %d task_type = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">,</span> <span class="n">task_type</span><span class="p">);</span>

	<span class="cm">/* Tx only */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_MIDPATH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_UNSOLICITED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mp_req</span><span class="o">-&gt;</span><span class="n">mp_req_bd_dma</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">mp_req</span><span class="o">-&gt;</span><span class="n">mp_req_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tx Write Rx Read */</span>
	<span class="cm">/* init flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">task_type</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TASK_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_TAPE</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_DISK</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="n">FCOE_TASK_CLASS_TYPE_3</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CLASS_TYPE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* tx flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">FCOE_TASK_TX_STATE_INIT</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TX_STATE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Rx Write Tx Read */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">data_2_trns</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">data_xfer_len</span><span class="p">;</span>

	<span class="cm">/* rx flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_EXP_FIRST_FRAME_SHIFT</span><span class="p">;</span>

	<span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">context_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT</span><span class="p">;</span>

	<span class="n">fc_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mp_req</span><span class="o">-&gt;</span><span class="n">req_fc_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_MIDPATH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_hdr</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
		<span class="n">fc_hdr</span><span class="o">-&gt;</span><span class="n">fh_rx_id</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_UNSOLICITED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_hdr</span><span class="o">-&gt;</span><span class="n">fh_rx_id</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">io_req</span><span class="o">-&gt;</span><span class="n">xid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fill FC Header into middle path buffer */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">tx_frame</span><span class="p">.</span><span class="n">fc_hdr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">,</span> <span class="n">fc_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">temp_hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* Rx Only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_MIDPATH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">read_info</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">;</span>

		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mp_req</span><span class="o">-&gt;</span><span class="n">mp_resp_bd_dma</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">mp_req</span><span class="o">-&gt;</span><span class="n">mp_resp_bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_init_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_cmd</span> <span class="o">*</span><span class="n">io_req</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">task_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc_cmd</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">sc_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_bdt</span> <span class="o">*</span><span class="n">bd_tbl</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_cached_sge_ctx</span> <span class="o">*</span><span class="n">cached_sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ext_mul_sges_ctx</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_type</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fcp_cmnd</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp_fcp_cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">context_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bd_count</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_task_ctx_entry</span><span class="p">));</span>

	<span class="cm">/* Setup the task from io_req for easy reference */</span>
	<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">task_type</span> <span class="o">=</span> <span class="n">FCOE_TASK_TYPE_READ</span><span class="p">;</span>

	<span class="cm">/* Tx only */</span>
	<span class="n">bd_count</span> <span class="o">=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_valid</span><span class="p">;</span>
	<span class="n">cached_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">read_info</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">cached_sge</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">FCOE_TASK_TYPE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fcoe_bd_ctx</span> <span class="o">*</span><span class="n">fcoe_bd_tbl</span> <span class="o">=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">;</span>

			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">cached_sge</span><span class="p">.</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
					<span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_lo</span><span class="p">;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">cached_sge</span><span class="p">.</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
					<span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_hi</span><span class="p">;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">cached_sge</span><span class="p">.</span><span class="n">cur_buf_rem</span> <span class="o">=</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_rem</span> <span class="o">=</span>
					<span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">;</span>

			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span><span class="p">;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_only</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span>
					<span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_valid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*Tx Write Rx Read */</span>
	<span class="cm">/* Init state to NORMAL */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="n">task_type</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TASK_TYPE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_TAPE</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
		<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">rec_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">io_req</span><span class="o">-&gt;</span><span class="n">rec_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span>
				<span class="n">FCOE_TASK_DEV_TYPE_DISK</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="n">FCOE_TASK_CLASS_TYPE_3</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CLASS_TYPE_SHIFT</span><span class="p">;</span>
	<span class="cm">/* tx flags */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">FCOE_TASK_TX_STATE_NORMAL</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_TX_STATE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Set initial seq counter */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">tx_seq</span><span class="p">.</span><span class="n">ctx</span><span class="p">.</span><span class="n">seq_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill FCP_CMND IU */</span>
	<span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">fcp_cmd</span><span class="p">.</span><span class="n">opaque</span><span class="p">;</span>
	<span class="n">bnx2fc_build_fcp_cmnd</span><span class="p">(</span><span class="n">io_req</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcp_cmnd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp_fcp_cmnd</span><span class="p">);</span>

	<span class="cm">/* swap fcp_cmnd */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcp_cmnd</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fcp_cmnd</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">tmp_fcp_cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">fcp_cmnd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Rx Write Tx Read */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">data_2_trns</span> <span class="o">=</span> <span class="n">io_req</span><span class="o">-&gt;</span><span class="n">data_xfer_len</span><span class="p">;</span>

	<span class="n">context_id</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="n">context_id</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT</span><span class="p">;</span>

	<span class="cm">/* rx flags */</span>
	<span class="cm">/* Set state to &quot;waiting for the first packet&quot; */</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_RX_WR_TX_RD_VAR_EXP_FIRST_FRAME_SHIFT</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_txrd</span><span class="p">.</span><span class="n">var_ctx</span><span class="p">.</span><span class="n">rx_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* Rx Only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_type</span> <span class="o">!=</span> <span class="n">FCOE_TASK_TYPE_READ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">rxwr_only</span><span class="p">.</span><span class="n">union_ctx</span><span class="p">.</span><span class="n">read_info</span><span class="p">.</span><span class="n">sgl_ctx</span><span class="p">.</span><span class="n">sgl</span><span class="p">;</span>
	<span class="n">bd_count</span> <span class="o">=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_valid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">struct</span> <span class="n">fcoe_bd_ctx</span> <span class="o">*</span><span class="n">fcoe_bd_tbl</span> <span class="o">=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">;</span>

			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_lo</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_hi</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_rem</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fcoe_bd_ctx</span> <span class="o">*</span><span class="n">fcoe_bd_tbl</span> <span class="o">=</span> <span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl</span><span class="p">;</span>

			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_lo</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_hi</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">cur_buf_rem</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">;</span>

			<span class="n">fcoe_bd_tbl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">second_buf_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
						 <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_lo</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">second_buf_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
						<span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_addr_hi</span><span class="p">;</span>
			<span class="n">cached_sge</span><span class="o">-&gt;</span><span class="n">second_buf_rem</span> <span class="o">=</span> <span class="n">fcoe_bd_tbl</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">txwr_rxrd</span><span class="p">.</span><span class="n">const_ctx</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
				<span class="n">FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span><span class="p">;</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span> <span class="n">bd_count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">cur_sge_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">bd_tbl</span><span class="o">-&gt;</span><span class="n">bd_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">mul_sgl</span><span class="p">.</span><span class="n">sgl_size</span> <span class="o">=</span> <span class="n">bd_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_setup_task_ctx - allocate and map task context</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * allocate memory for task context, and associated BD table to be used</span>
<span class="cm"> * by firmware</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_setup_task_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regpair</span> <span class="o">*</span><span class="n">task_ctx_bdt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate task context bd table. A page size of bd table</span>
<span class="cm">	 * can map 256 buffers. Each buffer contains 32 task context</span>
<span class="cm">	 * entries. Hence the limit with one page is 8192 task context</span>
<span class="cm">	 * entries.</span>
<span class="cm">	 */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">PAGE_SIZE</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_dma</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to allocate task context BDT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate task_ctx which is an array of pointers pointing to</span>
<span class="cm">	 * a page containing 32 task contexts</span>
<span class="cm">	 */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">BNX2FC_TASK_CTX_ARR_SZ</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to allocate task context array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate task_ctx_dma which is an array of dma addresses</span>
<span class="cm">	 */</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">BNX2FC_TASK_CTX_ARR_SZ</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to alloc context mapping array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task_ctx_bdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">regpair</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_TASK_CTX_ARR_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">PAGE_SIZE</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to alloc task context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">task_ctx_bdt</span><span class="o">-&gt;</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">task_ctx_bdt</span><span class="o">-&gt;</span><span class="n">lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">task_ctx_bdt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_TASK_CTX_ARR_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_dma</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_free_task_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_bd_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_TASK_CTX_ARR_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">task_ctx_dma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_free_hash_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">segment_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash_table_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pbl</span><span class="p">;</span>

	<span class="n">segment_count</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segment_count</span><span class="p">;</span>
	<span class="n">hash_table_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span> <span class="n">BNX2FC_MAX_ROWS_IN_HASH_TBL</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hash_table_entry</span><span class="p">);</span>

	<span class="n">pbl</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segment_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_address</span><span class="p">;</span>

		<span class="n">dma_address</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pbl</span><span class="p">);</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
		<span class="n">dma_address</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pbl</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">dma_address</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_allocate_hash_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hash_table_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">segment_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">segment_array_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_segment_array_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_segment_array</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pbl</span><span class="p">;</span>

	<span class="n">hash_table_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span> <span class="n">BNX2FC_MAX_ROWS_IN_HASH_TBL</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hash_table_entry</span><span class="p">);</span>

	<span class="n">segment_count</span> <span class="o">=</span> <span class="n">hash_table_size</span> <span class="o">+</span> <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">segment_count</span> <span class="o">/=</span> <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segment_count</span> <span class="o">=</span> <span class="n">segment_count</span><span class="p">;</span>

	<span class="n">segment_array_size</span> <span class="o">=</span> <span class="n">segment_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">segment_array_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hash table pointers alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_segment_array_size</span> <span class="o">=</span> <span class="n">segment_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dma_segment_array</span><span class="p">);</span>
	<span class="n">dma_segment_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dma_segment_array_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_segment_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hash table pointers (dma) alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segment_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dma_segment_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hash segment alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span><span class="p">,</span>
						    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						    <span class="n">dma_segment_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dma_segment_array</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_segments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">BNX2FC_HASH_TBL_CHUNK_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">PAGE_SIZE</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl_dma</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hash table pbl alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dma_segment_array</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">pbl</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segment_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">paddr</span> <span class="o">=</span> <span class="n">dma_segment_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">pbl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pbl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pbl</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hash_tbl_pbl</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">pbl</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">pbl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lo</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">hi</span><span class="p">;</span>
		<span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbl</span><span class="p">;</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="o">*</span><span class="n">pbl</span><span class="p">;</span>
		<span class="o">++</span><span class="n">pbl</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dma_segment_array</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_setup_fw_resc - Allocate and map hash table and dummy buffer</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	Pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_setup_fw_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_allocate_hash_table</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">regpair</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr_dma</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to allocate t2 hash table ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">);</span>

	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_t2_hash_table_entry</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_dma</span><span class="p">,</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to allocate t2 hash table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_NUM_MAX_SESS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_dma</span> <span class="o">+</span>
			 <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_t2_hash_table_entry</span><span class="p">));</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to alloc MP Dummy Buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">PAGE_SIZE</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buf_dma</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to alloc Stats Buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mem_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buf_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buf_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">dummy_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">regpair</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="n">BNX2FC_NUM_MAX_SESS</span> <span class="o">*</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_t2_hash_table_entry</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span>
				    <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span><span class="p">,</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl_dma</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">t2_hash_tbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2fc_free_hash_table</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
