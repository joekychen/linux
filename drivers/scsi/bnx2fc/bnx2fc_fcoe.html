<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › bnx2fc › bnx2fc_fcoe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bnx2fc_fcoe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2fc_fcoe.c: Broadcom NetXtreme II Linux FCoE offload driver.</span>
<span class="cm"> * This file contains the code that interacts with libfc, libfcoe,</span>
<span class="cm"> * cnic modules to create FCoE instances, send/receive non-offloaded</span>
<span class="cm"> * FIP/FCoE packets, listen to link events etc.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 - 2011 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Bhanu Prakash Gollapudi (bprakash@broadcom.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bnx2fc.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">adapter_list</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">if_list</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">adapter_count</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span><span class="p">,</span> <span class="n">bnx2fc_percpu</span><span class="p">);</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;bnx2fc&quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	BNX2FC_VERSION</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;Apr 24, 2012&quot;</span>


<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
		<span class="s">&quot;Broadcom NetXtreme II FCoE Driver &quot;</span> <span class="n">DRV_MODULE_NAME</span> \
		<span class="s">&quot; v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Bhanu Prakash Gollapudi &lt;bprakash@broadcom.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom NetXtreme II BCM57710 FCoE Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>

<span class="cp">#define BNX2FC_MAX_QUEUE_DEPTH	256</span>
<span class="cp">#define BNX2FC_MIN_QUEUE_DEPTH	32</span>
<span class="cp">#define FCOE_WORD_TO_BYTE  4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span>	<span class="o">*</span><span class="n">bnx2fc_transport_template</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span>	<span class="o">*</span><span class="n">bnx2fc_vport_xport_template</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">bnx2fc_wq</span><span class="p">;</span>

<span class="cm">/* bnx2fc structure needs only one instance of the fcoe_percpu_s structure.</span>
<span class="cm"> * Here the io threads are per cpu but the l2 thread is just one</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="n">bnx2fc_global</span><span class="p">;</span>
<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">bnx2fc_global_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cnic_ulp_ops</span> <span class="n">bnx2fc_cnic_cb</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">libfc_function_template</span> <span class="n">bnx2fc_libfc_fcn_templ</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">bnx2fc_shost_template</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bnx2fc_transport_function</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fcoe_sysfs_function_template</span> <span class="n">bnx2fc_fcoe_sysfs_templ</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bnx2fc_vport_xport_function</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fip_state</span> <span class="n">fip_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__bnx2fc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_start_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_shost_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_lport_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_em_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_bind_adapter_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_unbind_adapter_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_bind_pcidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_unbind_pcidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">bnx2fc_if_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npiv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_destroy_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">bnx2fc_hba_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">phys_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">bnx2fc_interface_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>
							<span class="o">*</span><span class="n">phys_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">bnx2fc_interface_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">bnx2fc_find_hba_for_cnic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_fw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_fw_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_port_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">bnx2fc_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">bnx2fc_mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bnx2fc_debug_level</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug_logging</span><span class="p">,</span> <span class="n">bnx2fc_debug_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2fc_cpu_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nfb</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">);</span>
<span class="cm">/* notification function for CPU hotplug events */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">bnx2fc_cpu_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">bnx2fc_cpu_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">bnx2fc_netdev</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="p">)</span><span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_get_lesb() - Fill the FCoE Link Error Status Block</span>
<span class="cm"> * @lport: the local port</span>
<span class="cm"> * @fc_lesb: the link error status block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_get_lesb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fc_els_lesb</span> <span class="o">*</span><span class="n">fc_lesb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">bnx2fc_netdev</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">__fcoe_get_lesb</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_lesb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_ctlr_get_lesb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_priv</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">bnx2fc_netdev</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_fc_els_lesb</span> <span class="o">*</span><span class="n">fcoe_lesb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_lesb</span> <span class="n">fc_lesb</span><span class="p">;</span>

	<span class="n">__fcoe_get_lesb</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc_lesb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">fcoe_lesb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fc_els_lesb</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">fc_lesb</span><span class="p">);</span>

	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_link_fail</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_link_fail</span><span class="p">);</span>
	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_vlink_fail</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_vlink_fail</span><span class="p">);</span>
	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_miss_fka</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_miss_fka</span><span class="p">);</span>
	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_symb_err</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_symb_err</span><span class="p">);</span>
	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_err_block</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_err_block</span><span class="p">);</span>
	<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lesb</span><span class="p">.</span><span class="n">lesb_fcs_error</span> <span class="o">=</span>
		<span class="n">ntohl</span><span class="p">(</span><span class="n">fcoe_lesb</span><span class="o">-&gt;</span><span class="n">lesb_fcs_error</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_fcf_get_vlan_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fcf_device</span> <span class="o">*</span><span class="n">fcf_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span> <span class="o">=</span>
		<span class="n">fcoe_fcf_dev_to_ctlr_dev</span><span class="p">(</span><span class="n">fcf_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_priv</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">fcoe</span> <span class="o">=</span> <span class="n">fcoe_ctlr_priv</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>

	<span class="n">fcf_dev</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">fcoe</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_clean_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="o">*</span><span class="n">bg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rcv_info</span> <span class="o">*</span><span class="n">fr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="n">bg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2fc_global</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span> <span class="n">skb</span> <span class="o">!=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">list</span><span class="p">;</span>
	     <span class="n">skb</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">fr</span> <span class="o">=</span> <span class="n">fcoe_dev_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fr</span><span class="o">-&gt;</span><span class="n">fr_dev</span> <span class="o">==</span> <span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2fc_get_paged_crc_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_global_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fcoe_get_paged_crc_eof</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2fc_global</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_global_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_abort_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This function is no-op for bnx2fc, but we do</span>
<span class="cm">	 * not want to leave it as NULL either, as libfc</span>
<span class="cm">	 * can call the default function which is</span>
<span class="cm">	 * fc_fcp_abort_io.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2FC_NUM_MAX_SESS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tgt</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cleanup IOs belonging to requested vport */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
				<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;flush/cleanup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2fc_flush_active_ios</span><span class="p">(</span><span class="n">tgt</span><span class="p">);</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_xmit_l2_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="n">tgt</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">-&gt;</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Xmit L2 frame rport = 0x%x, oxid = 0x%x, &quot;</span>
			<span class="s">&quot;r_ctl = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span><span class="p">),</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ELS_ADISC</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_adisc</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_LOGO</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_logo</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_RLS</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_rls</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span>  <span class="n">FC_TYPE_BLS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_BA_ABTS</span><span class="p">))</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;ABTS frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">BNX2FC_TGT_DBG</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="s">&quot;Send L2 frame type 0x%x &quot;</span>
				<span class="s">&quot;rctl 0x%x thru non-offload path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_xmit - bnx2fc&#39;s FCoE frame transmit function</span>
<span class="cm"> *</span>
<span class="cm"> * @lport:	the associated local port</span>
<span class="cm"> * @fp:	the fc_frame to be transmitted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethhdr</span>		<span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_crc_eof</span>	<span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>		<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span>	<span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span>	<span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span>        <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span>	<span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_hdr</span>		<span class="o">*</span><span class="n">hp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_rport</span>	<span class="o">*</span><span class="n">tgt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_dev_stats</span>	<span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">sof</span><span class="p">,</span> <span class="n">eof</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">crc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">hlen</span><span class="p">,</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">elen</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">wlen</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="p">)</span><span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">fp_skb</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;bnx2fc_xmit link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FCF not selected yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_els_send</span><span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sof</span> <span class="o">=</span> <span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">eof</span> <span class="o">=</span> <span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Snoop the frame header to check if the frame is for</span>
<span class="cm">	 * an offloaded session</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * tgt_ofld_list access is synchronized using</span>
<span class="cm">	 * both hba mutex and hba lock. Atleast hba mutex or</span>
<span class="cm">	 * hba lock needs to be held for read access.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">tgt</span> <span class="o">=</span> <span class="n">bnx2fc_tgt_lookup</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_SESSION_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tgt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* This frame is for offloaded session */</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;xmit: Frame is for offloaded session &quot;</span>
				<span class="s">&quot;port_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">));</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_xmit_l2_frame</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">elen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">);</span>
	<span class="n">hlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">);</span>
	<span class="n">tlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">);</span>
	<span class="n">wlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">tlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crc</span><span class="p">))</span> <span class="o">/</span> <span class="n">FCOE_WORD_TO_BYTE</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">fcoe_fc_crc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* copy port crc and eof to the skb buff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_get_paged_crc_eof</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlen</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span> <span class="o">+</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">));</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">fcoe_eof</span> <span class="o">=</span> <span class="n">eof</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">fcoe_crc32</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">crc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* adjust skb network/transport offsets to match mac/fcoe/port */</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">elen</span> <span class="o">+</span> <span class="n">hlen</span><span class="p">);</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* fill up mac and fcoe headers */</span>
	<span class="n">eh</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">map_dest</span><span class="p">)</span>
		<span class="n">fc_fcoe_set_mac</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* insert GW address */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">!=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">eh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FC_FCOE_VER</span><span class="p">)</span>
		<span class="n">FC_FCOE_ENCAPS_VER</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">FC_FCOE_VER</span><span class="p">);</span>
	<span class="n">hp</span><span class="o">-&gt;</span><span class="n">fcoe_sof</span> <span class="o">=</span> <span class="n">sof</span><span class="p">;</span>

	<span class="cm">/* fcoe lso, mss is in max_payload which is non-zero for FCP data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">seq_offload</span> <span class="o">&amp;&amp;</span> <span class="n">fr_max_payload</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">=</span> <span class="n">SKB_GSO_FCOE</span><span class="p">;</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">=</span> <span class="n">fr_max_payload</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*update tx stats */</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span> <span class="n">get_cpu</span><span class="p">());</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">TxFrames</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">TxWords</span> <span class="o">+=</span> <span class="n">wlen</span><span class="p">;</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="cm">/* send down to lld */</span>
	<span class="n">fr_dev</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcoe_pending_queue</span><span class="p">.</span><span class="n">qlen</span><span class="p">)</span>
		<span class="n">fcoe_check_wait_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fcoe_start_io</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">fcoe_check_wait_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_rcv - This is bnx2fc&#39;s receive function called by NET_RX_SOFTIRQ</span>
<span class="cm"> *</span>
<span class="cm"> * @skb:	the receive socket buffer</span>
<span class="cm"> * @dev:	associated net device</span>
<span class="cm"> * @ptype:	context</span>
<span class="cm"> * @olddev:	last device</span>
<span class="cm"> *</span>
<span class="cm"> * This function receives the packet and builds FC frame and passes it up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">ptype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">olddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rcv_info</span> <span class="o">*</span><span class="n">fr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="o">*</span><span class="n">bg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oxid</span><span class="p">;</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2fc_interface</span><span class="p">,</span>
				 <span class="n">fcoe_packet_type</span><span class="p">);</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_rcv: lport is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_rcv: Wrong FC type frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for minimum frame length, and make sure required FCoE</span>
<span class="cm">	 * and FC headers are pulled into the linear data area.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">FCOE_MIN_FRAME</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">FCOE_HEADER_LEN</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">));</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">oxid</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span><span class="p">);</span>

	<span class="n">fr</span> <span class="o">=</span> <span class="n">fcoe_dev_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fr</span><span class="o">-&gt;</span><span class="n">fr_dev</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>

	<span class="n">bg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2fc_global</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">qlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">bg</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_l2_rcv_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="o">*</span><span class="n">bg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">bnx2fc_recv_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_recv_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rcv_info</span> <span class="o">*</span><span class="n">fr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_dev_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_crc_eof</span> <span class="n">crc_eof</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vn_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dest_mac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>

	<span class="n">fr</span> <span class="o">=</span> <span class="n">fcoe_dev_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">lport</span> <span class="o">=</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">fr_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Invalid lport struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mac</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">;</span>
	<span class="n">dest_mac</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">;</span>

	<span class="cm">/* Pull the header */</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">));</span>
	<span class="n">fr_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span> <span class="n">get_cpu</span><span class="p">());</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxFrames</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxWords</span> <span class="o">+=</span> <span class="n">fr_len</span> <span class="o">/</span> <span class="n">FCOE_WORD_TO_BYTE</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">fc_frame_init</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fr_dev</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">fcoe_sof</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_copy_bits</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">fr_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc_eof</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crc_eof</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">crc_eof</span><span class="p">.</span><span class="n">fcoe_eof</span><span class="p">;</span>
	<span class="n">fr_crc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">crc_eof</span><span class="p">.</span><span class="n">fcoe_crc32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pskb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">fr_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">vn_port</span> <span class="o">=</span> <span class="n">fc_vport_id_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vn_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">dest_mac</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;fpma mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">put_cpu</span><span class="p">();</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_DD_SOL_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_FCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drop FCP data. We dont this in L2 path */</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ELS_LOGO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_FID_FLOGI</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* drop non-FIP LOGO */</span>
				<span class="n">put_cpu</span><span class="p">();</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_BA_ABTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Drop incoming ABTS */</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fr_crc</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">!=</span>
			<span class="o">~</span><span class="n">crc32</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fr_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">InvalidCRCCount</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;dropping frame with &quot;</span>
			       <span class="s">&quot;CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">InvalidCRCCount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_cpu</span><span class="p">();</span>
	<span class="n">fc_exch_recv</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_percpu_io_thread - thread per cpu for ios</span>
<span class="cm"> *</span>
<span class="cm"> * @arg:	ptr to bnx2fc_percpu_info structure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2fc_percpu_io_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work_list</span><span class="p">);</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>

			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">bnx2fc_process_cq_compl</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="nf">bnx2fc_get_host_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">bnx2fc_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_statistics_params</span> <span class="o">*</span><span class="n">fw_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_statistics_params</span> <span class="o">*</span><span class="p">)</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stats_buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_stats</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bnx2fc_stats</span> <span class="o">=</span> <span class="n">fc_get_host_stats</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stat_req_done</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_send_stat_req</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">bnx2fc_stats</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">stat_req_done</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FW stat req timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bnx2fc_stats</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span> <span class="o">+=</span> <span class="n">fw_stats</span><span class="o">-&gt;</span><span class="n">rx_stat2</span><span class="p">.</span><span class="n">fc_crc_cnt</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">fw_stats</span><span class="o">-&gt;</span><span class="n">tx_stat</span><span class="p">.</span><span class="n">fcoe_tx_pkt_cnt</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">tx_words</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fw_stats</span><span class="o">-&gt;</span><span class="n">tx_stat</span><span class="p">.</span><span class="n">fcoe_tx_byte_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">+=</span> <span class="n">fw_stats</span><span class="o">-&gt;</span><span class="n">rx_stat0</span><span class="p">.</span><span class="n">fcoe_rx_pkt_cnt</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">rx_words</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fw_stats</span><span class="o">-&gt;</span><span class="n">rx_stat0</span><span class="p">.</span><span class="n">fcoe_rx_byte_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">dumped_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">lip_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">nos_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">loss_of_sync_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">loss_of_signal_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2fc_stats</span><span class="o">-&gt;</span><span class="n">prim_seq_protocol_err_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2fc_stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_shost_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_CMD_LEN</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_LUN</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_FCP_TGT</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">bnx2fc_vport_xport_template</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">bnx2fc_transport_template</span><span class="p">;</span>

	<span class="cm">/* Add the new host to SCSI-ml */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error on scsi_add_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
		<span class="n">fc_host_max_npiv_vports</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">USHRT_MAX</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="s">&quot;%s v%s over %s&quot;</span><span class="p">,</span>
		<span class="n">BNX2FC_NAME</span><span class="p">,</span> <span class="n">BNX2FC_VERSION</span><span class="p">,</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_link_speed_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">ecmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__ethtool_get_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">FC_PORTSPEED_1GBIT</span> <span class="o">|</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">))</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">)</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_2500</span>:
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_2GBIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_10000</span>:
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_link_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_get_link_state - get network link state</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:	adapter instance pointer</span>
<span class="cm"> *</span>
<span class="cm"> * updates adapter structure flag based on netdev state</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2fc_get_link_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__LINK_STATE_NOCARRIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_net_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">wwnn</span><span class="p">,</span> <span class="n">wwpn</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="cm">/* require support for get_pauseparam ethtool op. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span><span class="o">-&gt;</span><span class="n">get_pauseparam</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_set_mfs</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">BNX2FC_MFS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">fcoe_pending_queue</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">fcoe_pending_queue_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">fcoe_queue_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lport</span><span class="p">);</span>

	<span class="n">bnx2fc_link_speed_update</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_get_wwn</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wwnn</span><span class="p">,</span> <span class="n">NETDEV_FCOE_WWNN</span><span class="p">))</span>
			<span class="n">wwnn</span> <span class="o">=</span> <span class="n">fcoe_wwn_from_mac</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span>
						 <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;WWNN = 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wwnn</span><span class="p">);</span>
		<span class="n">fc_set_wwnn</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">wwnn</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_get_wwn</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wwpn</span><span class="p">,</span> <span class="n">NETDEV_FCOE_WWPN</span><span class="p">))</span>
			<span class="n">wwpn</span> <span class="o">=</span> <span class="n">fcoe_wwn_from_mac</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span>
						 <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;WWPN = 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wwpn</span><span class="p">);</span>
		<span class="n">fc_set_wwpn</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">wwpn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_destroy_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ERROR:bnx2fc_destroy_timer - &quot;</span>
	       <span class="s">&quot;Destroy compl not received!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DESTROY_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_indicate_netevent - Generic netdev event handler</span>
<span class="cm"> *</span>
<span class="cm"> * @context:	adapter structure pointer</span>
<span class="cm"> * @event:	event type</span>
<span class="cm"> * @vlan_id:	vlan id - associated vlan id with this event</span>
<span class="cm"> *</span>
<span class="cm"> * Handles NETDEV_UP, NETDEV_DOWN, NETDEV_GOING_DOWN,NETDEV_CHANGE and</span>
<span class="cm"> * NETDEV_CHANGE_MTU events. Handle NETDEV_UNREGISTER only for vlans.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_indicate_netevent</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_for_upload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_possible</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">NETDEV_UNREGISTER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;indicate_netevent: &quot;</span>\
					<span class="s">&quot;hba is not UP!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">link_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_GOING_DOWN</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">link_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_CHANGE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NETDEV_UNREGISTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vlan_id</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">==</span> <span class="n">hba</span> <span class="o">&amp;&amp;</span>
			    <span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">==</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">))</span>
				<span class="n">__bnx2fc_destroy</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unkonwn netevent %ld&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">!=</span> <span class="n">hba</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;netevent handler - event=%s %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

		<span class="n">bnx2fc_link_speed_update</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">link_possible</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bnx2fc_link_ok</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Reset max recv frame size to default */</span>
			<span class="n">fc_set_mfs</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">BNX2FC_MFS</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * ctlr link up will only be handled during</span>
<span class="cm">			 * enable to avoid sending discovery solicitation</span>
<span class="cm">			 * on a stale vlan</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
				<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_link_down</span><span class="p">(</span><span class="n">ctlr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
				<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
							<span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
			<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
			<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span>
				    <span class="n">get_cpu</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">LinkFailureCount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">put_cpu</span><span class="p">();</span>
			<span class="n">fcoe_clean_pending_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="n">wait_for_upload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_upload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">);</span>
		<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;indicate_netevent &quot;</span>
				<span class="s">&quot;num_ofld_sess = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ofld_sess</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">wait_for_link_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ofld_sess</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;wakeup - num_ofld_sess = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ofld_sess</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">wait_for_link_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_libfc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Set the function pointers set by bnx2fc driver */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2fc_libfc_fcn_templ</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">libfc_function_template</span><span class="p">));</span>
	<span class="n">fc_elsct_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_exch_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_rport_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_disc_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_em_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_xid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_cpu_ids</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">max_xid</span> <span class="o">=</span> <span class="n">FCOE_XIDS_PER_CPU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_xid</span> <span class="o">=</span> <span class="n">FCOE_MAX_XID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc_exch_mgr_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_CLASS_3</span><span class="p">,</span> <span class="n">FCOE_MIN_XID</span><span class="p">,</span>
				<span class="n">max_xid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;em_config:fc_exch_mgr_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_lport_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">qfull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_RETRY_CNT</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">max_rport_retry_count</span> <span class="o">=</span> <span class="n">BNX2FC_MAX_RPORT_RETRY_CNT</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCP_SPPF_INIT_FCN</span> <span class="o">|</span> <span class="n">FCP_SPPF_RD_XRDY_DIS</span> <span class="o">|</span>
				<span class="n">FCP_SPPF_RETRY</span> <span class="o">|</span> <span class="n">FCP_SPPF_CONF_COMPL</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">does_npiv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">rnid_gen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_rnid_gen</span><span class="p">));</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">rnid_gen</span><span class="p">.</span><span class="n">rnid_atype</span> <span class="o">=</span> <span class="n">BNX2FC_RNID_HBA</span><span class="p">;</span>

	<span class="cm">/* alloc stats structure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc_lport_init_stats</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Finish fc_lport configuration */</span>
	<span class="n">fc_lport_config</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_fip_recv - handle a received FIP frame.</span>
<span class="cm"> *</span>
<span class="cm"> * @skb: the received skb</span>
<span class="cm"> * @dev: associated &amp;net_device</span>
<span class="cm"> * @ptype: the &amp;packet_type structure which was used to register this handler.</span>
<span class="cm"> * @orig_dev: original receive &amp;net_device, in case @ dev is a bond.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 for success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_fip_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">packet_type</span> <span class="o">*</span><span class="n">ptype</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2fc_interface</span><span class="p">,</span>
				 <span class="n">fip_packet_type</span><span class="p">);</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_recv</span><span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_update_src_mac - Update Ethernet MAC filters.</span>
<span class="cm"> *</span>
<span class="cm"> * @fip: FCoE controller.</span>
<span class="cm"> * @old: Unicast MAC address to delete if the MAC is non-zero.</span>
<span class="cm"> * @new: Unicast MAC address to add.</span>
<span class="cm"> *</span>
<span class="cm"> * Remove any previously-set unicast MAC filter.</span>
<span class="cm"> * Add secondary FCoE MAC address filter for our OUI.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_update_src_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_get_src_mac - return the ethernet source address for an lport</span>
<span class="cm"> *</span>
<span class="cm"> * @lport: libfc port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">bnx2fc_get_src_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="p">)</span><span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">data_src_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_fip_send - send an Ethernet-encapsulated FIP frame.</span>
<span class="cm"> *</span>
<span class="cm"> * @fip: FCoE controller.</span>
<span class="cm"> * @skb: FIP Packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_fip_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bnx2fc_from_ctlr</span><span class="p">(</span><span class="n">fip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">vport_to_shost</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">n_port</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">n_port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vn_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">fcoe_validate_vport_create</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_wwn_to_str</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Failed to create vport, &quot;</span>
		       <span class="s">&quot;WWPN (0x%s) already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;vn ports cannot be created on&quot;</span>
			<span class="s">&quot;this interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">vn_port</span> <span class="o">=</span> <span class="n">bnx2fc_if_create</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vn_port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_vport_create (%s) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vn_port</span><span class="o">-&gt;</span><span class="n">boot_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">fc_lport_init</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
		<span class="n">fc_fabric_login</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
		<span class="n">fc_vport_setlink</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_free_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_lport</span> <span class="o">*</span><span class="n">blport</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">blport</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blport</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">==</span> <span class="n">lport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">blport</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_vport_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">vport_to_shost</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">n_port</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vn_port</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">v_port</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n_port</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">v_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_port</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v_port</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">==</span> <span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n_port</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vn_port</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n_port</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">bnx2fc_free_vport</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">bnx2fc_port_shutdown</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">bnx2fc_interface_put</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">bnx2fc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">destroy_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_vport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
		<span class="n">fc_fabric_logoff</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">boot_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">fc_fabric_login</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="n">fc_vport_setlink</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_interface_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">physdev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sel_san_mac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup Source MAC Address */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_dev_addr</span><span class="p">(</span><span class="n">physdev</span><span class="p">,</span> <span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;net_config: ha-&gt;type = %d, fip_mac = &quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%2x:%2x:%2x:%2x:%2x:%2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NETDEV_HW_ADDR_T_SAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">sel_san_mac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Found SAN MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sel_san_mac</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fip_packet_type</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">bnx2fc_fip_recv</span><span class="p">;</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fip_packet_type</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fip_packet_type</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">fip_packet_type</span><span class="p">);</span>

	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fcoe_packet_type</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">bnx2fc_rcv</span><span class="p">;</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fcoe_packet_type</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_FCOE</span><span class="p">);</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">fcoe_packet_type</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">dev_add_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">fcoe_packet_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_attach_transport</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2fc_transport_template</span> <span class="o">=</span>
		<span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_transport_function</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_transport_template</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Failed to attach FC transport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2fc_vport_xport_template</span> <span class="o">=</span>
		<span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_vport_xport_function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_vport_xport_template</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
		       <span class="s">&quot;Failed to attach FC transport for vport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">bnx2fc_transport_template</span><span class="p">);</span>
		<span class="n">bnx2fc_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_release_transport</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">bnx2fc_transport_template</span><span class="p">);</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">bnx2fc_vport_xport_template</span><span class="p">);</span>
	<span class="n">bnx2fc_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bnx2fc_vport_xport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_interface_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2fc_interface</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Interface is being released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">ctlr_dev</span> <span class="o">=</span> <span class="n">fcoe_ctlr_to_ctlr_dev</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* tear-down FIP controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2FC_CTLR_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">if_flags</span><span class="p">))</span>
		<span class="n">fcoe_ctlr_destroy</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>

	<span class="n">fcoe_ctlr_device_delete</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>

	<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bnx2fc_interface_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bnx2fc_interface_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">bnx2fc_interface_release</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_hba_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Free the command manager */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2fc_cmd_mgr_free</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="p">);</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">);</span>
	<span class="n">bnx2fc_unbind_pcidev</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_hba_create - create a new bnx2fc hba</span>
<span class="cm"> *</span>
<span class="cm"> * @cnic:	pointer to cnic device</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new FCoE hba on the given device.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="nf">bnx2fc_hba_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hba</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to allocate hba structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_mutex</span><span class="p">);</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">=</span> <span class="n">cnic</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_bind_pcidev</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;create_adapter:  bind error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bind_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">next_conn_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">BNX2FC_NUM_MAX_SESS</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to allocate tgt offload list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">tgtofld_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ofld_sess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span> <span class="o">=</span> <span class="n">bnx2fc_cmd_mgr_alloc</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">BNX2FC_MIN_XID</span><span class="p">,</span>
						<span class="n">BNX2FC_MAX_XID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cmd_mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;em_config:bnx2fc_cmd_mgr_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cmgr_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_wait</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hba</span><span class="p">;</span>

<span class="nl">cmgr_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">tgt_ofld_list</span><span class="p">);</span>
<span class="nl">tgtofld_err:</span>
	<span class="n">bnx2fc_unbind_pcidev</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="nl">bind_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="nf">bnx2fc_interface_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">fip_state</span> <span class="n">fip_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">interface</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span><span class="p">));</span>
	<span class="n">ctlr_dev</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2fc_fcoe_sysfs_templ</span><span class="p">,</span>
					 <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Unable to allocate interface structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_priv</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>
	<span class="n">interface</span> <span class="o">=</span> <span class="n">fcoe_ctlr_priv</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="n">dev_hold</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* Initialize FIP */</span>
	<span class="n">fcoe_ctlr_init</span><span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">fip_mode</span><span class="p">);</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="n">bnx2fc_fip_send</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">update_mac</span> <span class="o">=</span> <span class="n">bnx2fc_update_src_mac</span><span class="p">;</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">get_src_addr</span> <span class="o">=</span> <span class="n">bnx2fc_get_src_mac</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_CTLR_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">if_flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_interface_setup</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">interface</span><span class="p">;</span>

	<span class="n">fcoe_ctlr_destroy</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="n">dev_put</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_device_delete</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_if_create - Create FCoE instance on a given interface</span>
<span class="cm"> *</span>
<span class="cm"> * @interface:	FCoE interface to create a local port on</span>
<span class="cm"> * @parent:	Device pointer to be the parent in sysfs for the SCSI host</span>
<span class="cm"> * @npiv:	Indicates if the port is vport or not</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a fc_lport instance and a Scsi_Host instance and configure them.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:	Allocated fc_lport or an error pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="nf">bnx2fc_if_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">npiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span>        <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span>		<span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="o">*</span><span class="n">n_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span>	<span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_vport</span>		<span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">dev_to_vport</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_lport</span>	<span class="o">*</span><span class="n">blport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span>	<span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">blport</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_lport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="s">&quot;Unable to alloc blport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate Scsi_Host structure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npiv</span><span class="p">)</span>
		<span class="n">lport</span> <span class="o">=</span> <span class="n">libfc_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_shost_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">lport</span> <span class="o">=</span> <span class="n">libfc_vport_create</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;could not allocate scsi host structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_blport</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">destroy_work</span><span class="p">,</span> <span class="n">bnx2fc_destroy_work</span><span class="p">);</span>

	<span class="cm">/* Configure fcoe_port */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_lport_config</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">lp_config_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npiv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Setting vport names, 0x%llX 0x%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
		<span class="n">fc_set_wwnn</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">);</span>
		<span class="n">fc_set_wwpn</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Configure netdev and networking properties of the lport */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_net_config</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error on bnx2fc_net_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">lp_config_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_shost_config</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Couldnt configure shost for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">lp_config_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the libfc library */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_libfc_config</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Couldnt configure libfc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">shost_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* Allocate exchange manager */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npiv</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_em_config</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">shost</span> <span class="o">=</span> <span class="n">vport_to_shost</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">n_port</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_exch_mgr_list_clone</span><span class="p">(</span><span class="n">n_port</span><span class="p">,</span> <span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Error on bnx2fc_em_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">shost_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2fc_interface_get</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>
	<span class="n">blport</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blport</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lport</span><span class="p">;</span>

<span class="nl">shost_err:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="nl">lp_config_err:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="nl">free_blport:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blport</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_net_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Dont listen for Ethernet packets anymore */</span>
	<span class="n">__dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">fcoe_packet_type</span><span class="p">);</span>
	<span class="n">__dev_remove_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">fip_packet_type</span><span class="p">);</span>
	<span class="n">synchronize_net</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_interface_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">;</span>

	<span class="cm">/* Stop the transmit retry timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Free existing transmit skbs */</span>
	<span class="n">fcoe_clean_pending_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">bnx2fc_net_cleanup</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">bnx2fc_free_vport</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_if_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Free queued packets for the receive thread */</span>
	<span class="n">bnx2fc_clean_rx_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="cm">/* Detach from scsi-ml */</span>
	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that only the physical lport will have the exchange manager.</span>
<span class="cm">	 * for vports, this function is NOP</span>
<span class="cm">	 */</span>
	<span class="n">fc_exch_mgr_free</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="cm">/* Free memory used by statistical counters */</span>
	<span class="n">fc_lport_free_stats</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="cm">/* Release Scsi_Host */</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__bnx2fc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lport_priv</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">bnx2fc_interface_cleanup</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">bnx2fc_stop</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">bnx2fc_interface_put</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">bnx2fc_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">destroy_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_destroy - Destroy a bnx2fc FCoE interface</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer: The name of the Ethernet interface to be destroyed</span>
<span class="cm"> * @kp:     The associated kernel parameter</span>
<span class="cm"> *</span>
<span class="cm"> * Called from sysfs.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 for success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">timer_work_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">bnx2fc_interface_lookup</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_destroy: interface or lport not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timer_work_queue</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">timer_work_queue</span><span class="p">;</span>
	<span class="n">__bnx2fc_destroy</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">timer_work_queue</span><span class="p">);</span>

<span class="nl">netdev_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_destroy_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_port</span><span class="p">,</span> <span class="n">destroy_work</span><span class="p">);</span>
	<span class="n">lport</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>

	<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered bnx2fc_destroy_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bnx2fc_if_destroy</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_unbind_adapter_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2fc_free_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="n">bnx2fc_free_task_ctx</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_bind_adapter_devices - binds bnx2fc adapter with the associated</span>
<span class="cm"> *			pci structure</span>
<span class="cm"> *</span>
<span class="cm"> * @hba:		Adapter instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_bind_adapter_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_setup_task_ctx</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mem_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_setup_fw_resc</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mem_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">mem_err:</span>
	<span class="n">bnx2fc_unbind_adapter_devices</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_bind_pcidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;cnic is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cnic</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">;</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">cnic</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">)</span>
		<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_unbind_pcidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">)</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * bnx2fc_ulp_start - cnic callback to initialize &amp; start adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:	transport handle pointing to adapter struture</span>
<span class="cm"> *</span>
<span class="cm"> * This function maps adapter structure to pcidev structure and initiates</span>
<span class="cm"> *	firmware handshake to enable/initialize on-chip FCoE components.</span>
<span class="cm"> *	This bnx2fc - cnic interface api callback is used after following</span>
<span class="cm"> *	conditions are met -</span>
<span class="cm"> *	a) underlying network interface is up (marked by event NETDEV_UP</span>
<span class="cm"> *		from netdev</span>
<span class="cm"> *	b) bnx2fc adatper structure is registered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_ulp_start</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">bnx2fc_fw_init</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;bnx2fc started.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">==</span> <span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
			<span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
			<span class="cm">/* Kick off Fabric discovery*/</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ulp_init: start discovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span> <span class="o">=</span> <span class="n">bnx2fc_xmit</span><span class="p">;</span>
			<span class="n">bnx2fc_start_disc</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_port_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">fc_fabric_logoff</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_lport_destroy</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">bnx2fc_port_shutdown</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
					<span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">fcoe_ctlr_link_down</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
	<span class="n">fcoe_clean_pending_queue</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_fw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define BNX2FC_INIT_POLL_TIME		(1000 / HZ)</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_bind_adapter_devices</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="n">PFX</span>
			<span class="s">&quot;bnx2fc_bind_adapter_devices failed - rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_send_fw_fcoe_init_msg</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="n">PFX</span>
			<span class="s">&quot;bnx2fc_send_fw_fcoe_init_msg failed - rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unbind</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the adapter init message is complete, and adapter</span>
<span class="cm">	 * state is UP.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">BNX2FC_INIT_POLL_TIME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_start: %s failed to initialize.  &quot;</span>
				<span class="s">&quot;Ignoring...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unbind</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unbind:</span>
	<span class="n">bnx2fc_unbind_adapter_devices</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_fw_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_send_fw_fcoe_destroy_msg</span><span class="p">(</span><span class="n">hba</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">);</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">BNX2FC_FW_TIMEOUT</span> <span class="o">+</span>
								<span class="n">jiffies</span><span class="p">;</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2fc_destroy_timer</span><span class="p">;</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hba</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">);</span>
			<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_wait</span><span class="p">,</span>
					<span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DESTROY_CMPL</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_DESTROY_CMPL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* This should never happen */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">destroy_timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bnx2fc_unbind_adapter_devices</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_ulp_stop - cnic callback to shutdown adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:	transport handle pointing to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Driver checks if adapter is already in shutdown mode, if not start</span>
<span class="cm"> *	the shutdown process.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_ulp_stop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ULP_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">==</span> <span class="n">hba</span><span class="p">)</span>
			<span class="n">bnx2fc_stop</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_ofld_sess</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_mutex</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_GOING_DOWN</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_mutex</span><span class="p">);</span>

	<span class="n">bnx2fc_fw_destroy</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_start_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* Kick off FIP/FLOGI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2FC_FLAG_FW_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Init not done yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lport</span> <span class="o">=</span> <span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;calling fc_fabric_login</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2fc_link_ok</span><span class="p">(</span><span class="n">lport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;ctlr_link_up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait for the FCF to be selected before issuing FLOGI */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="cm">/* give up after 3 secs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wait_cnt</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset max receive frame size to default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc_set_mfs</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">BNX2FC_MFS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fc_lport_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_fabric_login</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2fc_ulp_init - Initialize an adapter instance</span>
<span class="cm"> *</span>
<span class="cm"> * @dev :	cnic device handle</span>
<span class="cm"> * Called from cnic_register_driver() context to initialize all</span>
<span class="cm"> *	enumerated cnic devices. This routine allocates adapter structure</span>
<span class="cm"> *	and other device specific resources.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_ulp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* bnx2fc works only when bnx2x is loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CNIC_F_BNX2X_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fcoe_conn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc FCoE not supported on %s,&quot;</span>
				    <span class="s">&quot; flags: %lx fcoe_conn: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_fcoe_conn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2fc_hba_create</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;hba initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add HBA to the adapter list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">);</span>
	<span class="n">adapter_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2FC_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CNIC_ULP_FCOE</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;register_device failed, rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2FC_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">bnx2fc_interface_lookup</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_disable: interface or lport not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">fcoe_ctlr_link_down</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
		<span class="n">fcoe_clean_pending_queue</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">bnx2fc_interface_lookup</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_enable: interface or lport not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2fc_link_ok</span><span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_create - Create bnx2fc FCoE interface</span>
<span class="cm"> *</span>
<span class="cm"> * @buffer: The name of Ethernet interface to create on</span>
<span class="cm"> * @kp:     The associated kernel param</span>
<span class="cm"> *</span>
<span class="cm"> * Called from sysfs.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 for success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fip_state</span> <span class="n">fip_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">phys_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="n">drvinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vlan_id</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered bnx2fc_create</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip_mode</span> <span class="o">!=</span> <span class="n">FIP_MODE_FABRIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fip mode not FABRIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mod_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* obtain physical netdev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_dev_vlan_id</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Not a vlan device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* verify if the physical device is a netxtreme2 device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">&amp;&amp;</span> <span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span><span class="o">-&gt;</span><span class="n">get_drvinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drvinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="p">));</span>
		<span class="n">phys_dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span><span class="o">-&gt;</span><span class="n">get_drvinfo</span><span class="p">(</span><span class="n">phys_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drvinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">drvinfo</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;bnx2x&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;bnx2x&quot;</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Not a netxtreme2 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to obtain drv_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* obtain interface and initialize rest of the structure */</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2fc_hba_lookup</span><span class="p">(</span><span class="n">phys_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_create: hba not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_interface_lookup</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">netdev_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">bnx2fc_interface_create</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">fip_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_interface_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ifput_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctlr</span> <span class="o">=</span> <span class="n">bnx2fc_to_ctlr</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_id</span><span class="p">;</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">vlan_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">timer_work_queue</span> <span class="o">=</span>
			<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;bnx2fc_timer_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">timer_work_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;ulp_init could not create timer_wq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ifput_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lport</span> <span class="o">=</span> <span class="n">bnx2fc_if_create</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Failed to create interface (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">if_create_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add interface to if_list */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">);</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">boot_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Make this master N_port */</span>
	<span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2fc_link_ok</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_link_up</span><span class="p">(</span><span class="n">ctlr</span><span class="p">);</span>
		<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ADAPTER_STATE_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">adapter_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BNX2FC_HBA_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;create: START DISC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2fc_start_disc</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Release from kref_init in bnx2fc_interface_setup, on success</span>
<span class="cm">	 * lport should be holding a reference taken in bnx2fc_if_create</span>
<span class="cm">	 */</span>
	<span class="n">bnx2fc_interface_put</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="cm">/* put netdev that was held while calling dev_get_by_name */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">if_create_err:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">timer_work_queue</span><span class="p">);</span>
<span class="nl">ifput_err:</span>
	<span class="n">bnx2fc_net_cleanup</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">bnx2fc_interface_put</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">mod_err</span><span class="p">;</span>
<span class="nl">netdev_err:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="nl">mod_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_find_hba_for_cnic - maps cnic instance to bnx2fc hba instance</span>
<span class="cm"> *</span>
<span class="cm"> * @cnic:	Pointer to cnic device instance</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="nf">bnx2fc_find_hba_for_cnic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">cnic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>

	<span class="cm">/* Called with bnx2fc_dev_lock held */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span> <span class="o">==</span> <span class="n">cnic</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">hba</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="nf">bnx2fc_interface_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>
							<span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>

	<span class="cm">/* Called with bnx2fc_dev_lock held */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">netdev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">interface</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="nf">bnx2fc_hba_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>
						      <span class="o">*</span><span class="n">phys_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>

	<span class="cm">/* Called with bnx2fc_dev_lock held */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phys_dev</span> <span class="o">==</span> <span class="n">phys_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">hba</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;adapter_lookup: hba NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_ulp_exit - shuts down adapter instance and frees all resources</span>
<span class="cm"> *</span>
<span class="cm"> * @dev		cnic device handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_ulp_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;Entered bnx2fc_ulp_exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CNIC_F_BNX2X_CLASS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc port check: %s, flags: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">hba</span> <span class="o">=</span> <span class="n">bnx2fc_find_hba_for_cnic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;bnx2fc_ulp_exit: hba not found, dev 0%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">adapter_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="cm">/* destroy not called yet, move to quiesced list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hba</span> <span class="o">==</span> <span class="n">hba</span><span class="p">)</span>
			<span class="n">__bnx2fc_destroy</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="n">bnx2fc_ulp_stop</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="cm">/* unregister cnic device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2FC_CNIC_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">))</span>
		<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">unregister_device</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span> <span class="n">CNIC_ULP_FCOE</span><span class="p">);</span>
	<span class="n">bnx2fc_hba_destroy</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_fcoe_reset - Resets the fcoe</span>
<span class="cm"> *</span>
<span class="cm"> * @shost: shost the reset is from</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: always 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_fcoe_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2fc_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">phys_dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2fc_hba_lookup</span><span class="p">(</span><span class="n">phys_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fcoe_transport</span> <span class="n">bnx2fc_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;bnx2fc&quot;</span><span class="p">},</span>
	<span class="p">.</span><span class="n">attached</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">bnx2fc_transport</span><span class="p">.</span><span class="n">list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">bnx2fc_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">bnx2fc_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">bnx2fc_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">bnx2fc_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">bnx2fc_disable</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_percpu_thread_create - Create a receive thread for an</span>
<span class="cm"> *				 online CPU</span>
<span class="cm"> *</span>
<span class="cm"> * @cpu: cpu index for the online cpu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_percpu_thread_create</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2fc_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">bnx2fc_percpu_io_thread</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span>
				<span class="s">&quot;bnx2fc_thread/%d&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="cm">/* bind thread to the cpu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="kr">thread</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kthread_bind</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">iothread</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2fc_percpu_thread_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">BNX2FC_MISC_DBG</span><span class="p">(</span><span class="s">&quot;destroying io thread for CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* Prevent any new work from being queued for this CPU */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2fc_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
	<span class="kr">thread</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iothread</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">iothread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="cm">/* Free all work in the list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">bnx2fc_process_cq_compl</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">wqe</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_cpu_callback - Handler for CPU hotplug events</span>
<span class="cm"> *</span>
<span class="cm"> * @nfb:    The callback data block</span>
<span class="cm"> * @action: The event triggering the callback</span>
<span class="cm"> * @hcpu:   The index of the CPU that the event is for</span>
<span class="cm"> *</span>
<span class="cm"> * This creates or destroys per-CPU data for fcoe</span>
<span class="cm"> *</span>
<span class="cm"> * Returns NOTIFY_OK always.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2fc_cpu_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nfb</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
	<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;CPU %x online: Create Rx thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">bnx2fc_percpu_thread_create</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;CPU %x offline: Remove Rx thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">bnx2fc_percpu_thread_destroy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_mod_init - module init entry point</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize driver wide global data structures, and register</span>
<span class="cm"> * with cnic module</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bnx2fc_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="o">*</span><span class="n">bg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">l2_thread</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2fc_percpu_s</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="cm">/* register as a fcoe transport */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fcoe_transport_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_transport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to register an fcoe transport, check &quot;</span>
			<span class="s">&quot;if libfcoe is loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">if_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">adapter_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Attach FC transport template */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2fc_attach_transport</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">detach_ft</span><span class="p">;</span>

	<span class="n">bnx2fc_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;bnx2fc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2fc_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_bt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2fc_global</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">);</span>
	<span class="n">l2_thread</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">bnx2fc_l2_rcv_thread</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bg</span><span class="p">,</span>
				   <span class="s">&quot;bnx2fc_l2_thread&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">l2_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">l2_thread</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_wq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">l2_thread</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">l2_thread</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">bnx2fc_percpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fp_work_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2fc_percpu_thread_create</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize per CPU interrupt thread */</span>
	<span class="n">register_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_cpu_notifier</span><span class="p">);</span>

	<span class="n">cnic_register_driver</span><span class="p">(</span><span class="n">CNIC_ULP_FCOE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2fc_cnic_cb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">bnx2fc_wq</span><span class="p">);</span>
<span class="nl">release_bt:</span>
	<span class="n">bnx2fc_release_transport</span><span class="p">();</span>
<span class="nl">detach_ft:</span>
	<span class="n">fcoe_transport_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_transport</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bnx2fc_mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">to_be_deleted</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2fc_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_percpu_s</span> <span class="o">*</span><span class="n">bg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">l2_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: Since cnic calls register_driver routine rtnl_lock,</span>
<span class="cm">	 * it will have higher precedence than bnx2fc_dev_lock.</span>
<span class="cm">	 * unregister_device() cannot be called with bnx2fc_dev_lock</span>
<span class="cm">	 * held.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_be_deleted</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_list</span><span class="p">);</span>
	<span class="n">adapter_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_dev_lock</span><span class="p">);</span>

	<span class="cm">/* Unregister with cnic */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_be_deleted</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;MOD_EXIT:destroy hba = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hba</span><span class="p">);</span>
		<span class="n">bnx2fc_ulp_stop</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="cm">/* unregister cnic device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2FC_CNIC_REGISTERED</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">reg_with_cnic</span><span class="p">))</span>
			<span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="o">-&gt;</span><span class="n">unregister_device</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">cnic</span><span class="p">,</span>
							 <span class="n">CNIC_ULP_FCOE</span><span class="p">);</span>
		<span class="n">bnx2fc_hba_destroy</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cnic_unregister_driver</span><span class="p">(</span><span class="n">CNIC_ULP_FCOE</span><span class="p">);</span>

	<span class="cm">/* Destroy global thread */</span>
	<span class="n">bg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2fc_global</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">l2_thread</span> <span class="o">=</span> <span class="n">bg</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">bg</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">fcoe_rx_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l2_thread</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">l2_thread</span><span class="p">);</span>

	<span class="n">unregister_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_cpu_notifier</span><span class="p">);</span>

	<span class="cm">/* Destroy per cpu threads */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2fc_percpu_thread_destroy</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">bnx2fc_wq</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * detach from scsi transport</span>
<span class="cm">	 * must happen after all destroys are done</span>
<span class="cm">	 */</span>
	<span class="n">bnx2fc_release_transport</span><span class="p">();</span>

	<span class="cm">/* detach from fcoe transport */</span>
	<span class="n">fcoe_transport_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2fc_transport</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">bnx2fc_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bnx2fc_mod_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fcoe_sysfs_function_template</span> <span class="n">bnx2fc_fcoe_sysfs_templ</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_mode</span> <span class="o">=</span> <span class="n">fcoe_ctlr_get_fip_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_link_fail</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_vlink_fail</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_miss_fka</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_symb_err</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_err_block</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_ctlr_fcs_error</span> <span class="o">=</span> <span class="n">bnx2fc_ctlr_get_lesb</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_fcoe_fcf_selected</span> <span class="o">=</span> <span class="n">fcoe_fcf_get_selected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fcoe_fcf_vlan_id</span> <span class="o">=</span> <span class="n">bnx2fc_fcf_get_vlan_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bnx2fc_transport_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_active_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">fc_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">fc_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_libfc_priv</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">show_rport_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">fc_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">bnx2fc_get_host_stats</span><span class="p">,</span>

	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">bnx2fc_fcoe_reset</span><span class="p">,</span>

	<span class="p">.</span><span class="n">terminate_rport_io</span> <span class="o">=</span> <span class="n">fc_rport_terminate_io</span><span class="p">,</span>

	<span class="p">.</span><span class="n">vport_create</span> <span class="o">=</span> <span class="n">bnx2fc_vport_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_delete</span> <span class="o">=</span> <span class="n">bnx2fc_vport_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vport_disable</span> <span class="o">=</span> <span class="n">bnx2fc_vport_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">fc_lport_bsg_request</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">bnx2fc_vport_xport_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_active_fc4s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_speed</span> <span class="o">=</span> <span class="n">fc_get_host_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_port_state</span> <span class="o">=</span> <span class="n">fc_get_host_port_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_libfc_priv</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2fc_rport</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">show_rport_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">fc_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fc_host_stats</span> <span class="o">=</span> <span class="n">fc_get_host_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">issue_fc_host_lip</span> <span class="o">=</span> <span class="n">bnx2fc_fcoe_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">terminate_rport_io</span> <span class="o">=</span> <span class="n">fc_rport_terminate_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">fc_lport_bsg_request</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * scsi_host_template structure used while registering with SCSI-ml</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">bnx2fc_shost_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Broadcom Offload FCoE Initiator&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">bnx2fc_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">bnx2fc_eh_abort</span><span class="p">,</span>	  <span class="cm">/* abts */</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">bnx2fc_eh_device_reset</span><span class="p">,</span> <span class="cm">/* lun reset */</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">bnx2fc_eh_target_reset</span><span class="p">,</span> <span class="cm">/* tgt reset */</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">fc_eh_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">fc_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">fc_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span>	<span class="o">=</span> <span class="n">fc_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">BNX2FC_CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">BNX2FC_MAX_BDS_PER_CMD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">libfc_function_template</span> <span class="n">bnx2fc_libfc_fcn_templ</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">frame_send</span>		<span class="o">=</span> <span class="n">bnx2fc_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">elsct_send</span>		<span class="o">=</span> <span class="n">bnx2fc_elsct_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fcp_abort_io</span>		<span class="o">=</span> <span class="n">bnx2fc_abort_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fcp_cleanup</span>		<span class="o">=</span> <span class="n">bnx2fc_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_lesb</span>		<span class="o">=</span> <span class="n">bnx2fc_get_lesb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rport_event_callback</span>	<span class="o">=</span> <span class="n">bnx2fc_rport_event_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2fc_cnic_cb - global template of bnx2fc - cnic driver interface</span>
<span class="cm"> *			structure carrying callback function pointers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cnic_ulp_ops</span> <span class="n">bnx2fc_cnic_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_init</span>		<span class="o">=</span> <span class="n">bnx2fc_ulp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_exit</span>		<span class="o">=</span> <span class="n">bnx2fc_ulp_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_start</span>		<span class="o">=</span> <span class="n">bnx2fc_ulp_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cnic_stop</span>		<span class="o">=</span> <span class="n">bnx2fc_ulp_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_kcqes</span>		<span class="o">=</span> <span class="n">bnx2fc_indicate_kcqe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_netevent</span>	<span class="o">=</span> <span class="n">bnx2fc_indicate_netevent</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
