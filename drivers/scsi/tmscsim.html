<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › tmscsim.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tmscsim.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/************************************************************************</span>
<span class="cm"> *	FILE NAME : TMSCSIM.C						*</span>
<span class="cm"> *	     BY   : C.L. Huang,  ching@tekram.com.tw			*</span>
<span class="cm"> *	Description: Device Driver for Tekram DC-390(T) PCI SCSI	*</span>
<span class="cm"> *		     Bus Master Host Adapter				*</span>
<span class="cm"> * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.			*</span>
<span class="cm"> ************************************************************************</span>
<span class="cm"> * (C) Copyright: put under GNU GPL in 10/96				*</span>
<span class="cm"> *				(see Documentation/scsi/tmscsim.txt)	*</span>
<span class="cm"> ************************************************************************</span>
<span class="cm"> * $Id: tmscsim.c,v 2.60.2.30 2000/12/20 01:07:12 garloff Exp $		*</span>
<span class="cm"> *	Enhancements and bugfixes by					*</span>
<span class="cm"> *	Kurt Garloff &lt;kurt@garloff.de&gt;	&lt;garloff@suse.de&gt;		*</span>
<span class="cm"> ************************************************************************</span>
<span class="cm"> *	HISTORY:							*</span>
<span class="cm"> *									*</span>
<span class="cm"> *	REV#	DATE	NAME	DESCRIPTION				*</span>
<span class="cm"> *	1.00  96/04/24	CLH	First release				*</span>
<span class="cm"> *	1.01  96/06/12	CLH	Fixed bug of Media Change for Removable *</span>
<span class="cm"> *				Device, scan all LUN. Support Pre2.0.10 *</span>
<span class="cm"> *	1.02  96/06/18	CLH	Fixed bug of Command timeout ...	*</span>
<span class="cm"> *	1.03  96/09/25	KG	Added tmscsim_proc_info()		*</span>
<span class="cm"> *	1.04  96/10/11	CLH	Updating for support KV 2.0.x		*</span>
<span class="cm"> *	1.05  96/10/18	KG	Fixed bug in DC390_abort(null ptr deref)*</span>
<span class="cm"> *	1.06  96/10/25	KG	Fixed module support			*</span>
<span class="cm"> *	1.07  96/11/09	KG	Fixed tmscsim_proc_info()		*</span>
<span class="cm"> *	1.08  96/11/18	KG	Fixed null ptr in DC390_Disconnect()	*</span>
<span class="cm"> *	1.09  96/11/30	KG	Added register the allocated IO space	*</span>
<span class="cm"> *	1.10  96/12/05	CLH	Modified tmscsim_proc_info(), and reset *</span>
<span class="cm"> *				pending interrupt in DC390_detect()	*</span>
<span class="cm"> *	1.11  97/02/05	KG/CLH	Fixeds problem with partitions greater	*</span>
<span class="cm"> *				than 1GB				*</span>
<span class="cm"> *	1.12  98/02/15  MJ      Rewritten PCI probing			*</span>
<span class="cm"> *	1.13  98/04/08	KG	Support for non DC390, __initfunc decls,*</span>
<span class="cm"> *				changed max devs from 10 to 16		*</span>
<span class="cm"> *	1.14a 98/05/05	KG	Dynamic DCB allocation, add-single-dev	*</span>
<span class="cm"> *				for LUNs if LUN_SCAN (BIOS) not set	*</span>
<span class="cm"> *				runtime config using /proc interface	*</span>
<span class="cm"> *	1.14b 98/05/06	KG	eliminated cli (); sti (); spinlocks	*</span>
<span class="cm"> *	1.14c 98/05/07	KG	2.0.x compatibility			*</span>
<span class="cm"> *	1.20a 98/05/07	KG	changed names of funcs to be consistent *</span>
<span class="cm"> *				DC390_ (entry points), dc390_ (internal)*</span>
<span class="cm"> *				reworked locking			*</span>
<span class="cm"> *	1.20b 98/05/12	KG	bugs: version, kfree, _ctmp		*</span>
<span class="cm"> *				debug output				*</span>
<span class="cm"> *	1.20c 98/05/12	KG	bugs: kfree, parsing, EEpromDefaults	*</span>
<span class="cm"> *	1.20d 98/05/14	KG	bugs: list linkage, clear flag after  	*</span>
<span class="cm"> *				reset on startup, code cleanup		*</span>
<span class="cm"> *	1.20e 98/05/15	KG	spinlock comments, name space cleanup	*</span>
<span class="cm"> *				pLastDCB now part of ACB structure	*</span>
<span class="cm"> *				added stats, timeout for 2.1, TagQ bug	*</span>
<span class="cm"> *				RESET and INQUIRY interface commands	*</span>
<span class="cm"> *	1.20f 98/05/18	KG	spinlocks fixes, max_lun fix, free DCBs	*</span>
<span class="cm"> *				for missing LUNs, pending int		*</span>
<span class="cm"> *	1.20g 98/05/19	KG	Clean up: Avoid short			*</span>
<span class="cm"> *	1.20h 98/05/21	KG	Remove AdaptSCSIID, max_lun ...		*</span>
<span class="cm"> *	1.20i 98/05/21	KG	Aiiie: Bug with TagQMask       		*</span>
<span class="cm"> *	1.20j 98/05/24	KG	Handle STAT_BUSY, handle pACB-&gt;pLinkDCB	*</span>
<span class="cm"> *				== 0 in remove_dev and DoingSRB_Done	*</span>
<span class="cm"> *	1.20k 98/05/25	KG	DMA_INT	(experimental)	       		*</span>
<span class="cm"> *	1.20l 98/05/27	KG	remove DMA_INT; DMA_IDLE cmds added;	*</span>
<span class="cm"> *	1.20m 98/06/10	KG	glitch configurable; made some global	*</span>
<span class="cm"> *				vars part of ACB; use DC390_readX	*</span>
<span class="cm"> *	1.20n 98/06/11	KG	startup params				*</span>
<span class="cm"> *	1.20o 98/06/15	KG	added TagMaxNum to boot/module params	*</span>
<span class="cm"> *				Device Nr -&gt; Idx, TagMaxNum power of 2  *</span>
<span class="cm"> *	1.20p 98/06/17	KG	Docu updates. Reset depends on settings *</span>
<span class="cm"> *				pci_set_master added; 2.0.xx: pcibios_*	*</span>
<span class="cm"> *				used instead of MechNum things ...	*</span>
<span class="cm"> *	1.20q 98/06/23	KG	Changed defaults. Added debug code for	*</span>
<span class="cm"> *				removable media and fixed it. TagMaxNum	*</span>
<span class="cm"> *				fixed for DC390. Locking: ACB, DRV for	*</span>
<span class="cm"> *				better IRQ sharing. Spelling: Queueing	*</span>
<span class="cm"> *				Parsing and glitch_cfg changes. Display	*</span>
<span class="cm"> *				real SyncSpeed value. Made DisConn	*</span>
<span class="cm"> *				functional (!)				*</span>
<span class="cm"> *	1.20r 98/06/30	KG	Debug macros, allow disabling DsCn, set	*</span>
<span class="cm"> *				BIT4 in CtrlR4, EN_PAGE_INT, 2.0 module	*</span>
<span class="cm"> *				param -1 fixed.				*</span>
<span class="cm"> *	1.20s 98/08/20	KG	Debug info on abort(), try to check PCI,*</span>
<span class="cm"> *				phys_to_bus instead of phys_to_virt,	*</span>
<span class="cm"> *				fixed sel. process, fixed locking,	*</span>
<span class="cm"> *				added MODULE_XXX infos, changed IRQ	*</span>
<span class="cm"> *				request flags, disable DMA_INT		*</span>
<span class="cm"> *	1.20t 98/09/07	KG	TagQ report fixed; Write Erase DMA Stat;*</span>
<span class="cm"> *				initfunc -&gt; __init; better abort;	*</span>
<span class="cm"> *				Timeout for XFER_DONE &amp; BLAST_COMPLETE;	*</span>
<span class="cm"> *				Allow up to 33 commands being processed *</span>
<span class="cm"> *	2.0a  98/10/14	KG	Max Cmnds back to 17. DMA_Stat clearing *</span>
<span class="cm"> *				all flags. Clear within while() loops	*</span>
<span class="cm"> *				in DataIn_0/Out_0. Null ptr in dumpinfo	*</span>
<span class="cm"> *				for pSRB==0. Better locking during init.*</span>
<span class="cm"> *				bios_param() now respects part. table.	*</span>
<span class="cm"> *	2.0b  98/10/24	KG	Docu fixes. Timeout Msg in DMA Blast.	*</span>
<span class="cm"> *				Disallow illegal idx in INQUIRY/REMOVE	*</span>
<span class="cm"> *	2.0c  98/11/19	KG	Cleaned up detect/init for SMP boxes, 	*</span>
<span class="cm"> *				Write Erase DMA (1.20t) caused problems	*</span>
<span class="cm"> *	2.0d  98/12/25	KG	Christmas release ;-) Message handling  *</span>
<span class="cm"> *				completely reworked. Handle target ini-	*</span>
<span class="cm"> *				tiated SDTR correctly.			*</span>
<span class="cm"> *	2.0d1 99/01/25	KG	Try to handle RESTORE_PTR		*</span>
<span class="cm"> *	2.0d2 99/02/08	KG	Check for failure of kmalloc, correct 	*</span>
<span class="cm"> *				inclusion of scsicam.h, DelayReset	*</span>
<span class="cm"> *	2.0d3 99/05/31	KG	DRIVER_OK -&gt; DID_OK, DID_NO_CONNECT,	*</span>
<span class="cm"> *				detect Target mode and warn.		*</span>
<span class="cm"> *				pcmd-&gt;result handling cleaned up.	*</span>
<span class="cm"> *	2.0d4 99/06/01	KG	Cleaned selection process. Found bug	*</span>
<span class="cm"> *				which prevented more than 16 tags. Now:	*</span>
<span class="cm"> *				24. SDTR cleanup. Cleaner multi-LUN	*</span>
<span class="cm"> *				handling. Don&#39;t modify ControlRegs/FIFO	*</span>
<span class="cm"> *				when connected.				*</span>
<span class="cm"> *	2.0d5 99/06/01	KG	Clear DevID, Fix INQUIRY after cfg chg.	*</span>
<span class="cm"> *	2.0d6 99/06/02	KG	Added ADD special command to allow cfg.	*</span>
<span class="cm"> *				before detection. Reset SYNC_NEGO_DONE	*</span>
<span class="cm"> *				after a bus reset.			*</span>
<span class="cm"> *	2.0d7 99/06/03	KG	Fixed bugs wrt add,remove commands	*</span>
<span class="cm"> *	2.0d8 99/06/04	KG	Removed copying of cmnd into CmdBlock.	*</span>
<span class="cm"> *				Fixed Oops in _release().		*</span>
<span class="cm"> *	2.0d9 99/06/06	KG	Also tag queue INQUIRY, T_U_R, ...	*</span>
<span class="cm"> *				Allow arb. no. of Tagged Cmnds. Max 32	*</span>
<span class="cm"> *	2.0d1099/06/20	KG	TagMaxNo changes now honoured! Queueing *</span>
<span class="cm"> *				clearified (renamed ..) TagMask handling*</span>
<span class="cm"> *				cleaned.				*</span>
<span class="cm"> *	2.0d1199/06/28	KG	cmd-&gt;result now identical to 2.0d2	*</span>
<span class="cm"> *	2.0d1299/07/04	KG	Changed order of processing in IRQ	*</span>
<span class="cm"> *	2.0d1399/07/05	KG	Don&#39;t update DCB fields if removed	*</span>
<span class="cm"> *	2.0d1499/07/05	KG	remove_dev: Move kfree() to the end	*</span>
<span class="cm"> *	2.0d1599/07/12	KG	use_new_eh_code: 0, ULONG -&gt; UINT where	*</span>
<span class="cm"> *				appropriate				*</span>
<span class="cm"> *	2.0d1699/07/13	KG	Reenable StartSCSI interrupt, Retry msg	*</span>
<span class="cm"> *	2.0d1799/07/15	KG	Remove debug msg. Disable recfg. when	*</span>
<span class="cm"> *				there are queued cmnds			*</span>
<span class="cm"> *	2.0d1899/07/18	KG	Selection timeout: Don&#39;t requeue	*</span>
<span class="cm"> *	2.0d1999/07/18	KG	Abort: Only call scsi_done if dequeued	*</span>
<span class="cm"> *	2.0d2099/07/19	KG	Rst_Detect: DoingSRB_Done		*</span>
<span class="cm"> *	2.0d2199/08/15	KG	dev_id for request/free_irq, cmnd[0] for*</span>
<span class="cm"> *				RETRY, SRBdone does DID_ABORT for the 	*</span>
<span class="cm"> *				cmd passed by DC390_reset()		*</span>
<span class="cm"> *	2.0d2299/08/25	KG	dev_id fixed. can_queue: 42		*</span>
<span class="cm"> *	2.0d2399/08/25	KG	Removed some debugging code. dev_id 	*</span>
<span class="cm"> *				now is set to pACB. Use u8,u16,u32. 	*</span>
<span class="cm"> *	2.0d2499/11/14	KG	Unreg. I/O if failed IRQ alloc. Call	*</span>
<span class="cm"> * 				done () w/ DID_BAD_TARGET in case of	*</span>
<span class="cm"> *				missing DCB. We	are old EH!!		*</span>
<span class="cm"> *	2.0d2500/01/15	KG	2.3.3x compat from Andreas Schultz	*</span>
<span class="cm"> *				set unique_id. Disable RETRY message.	*</span>
<span class="cm"> *	2.0d2600/01/29	KG	Go to new EH.				*</span>
<span class="cm"> *	2.0d2700/01/31	KG	... but maintain 2.0 compat.		*</span>
<span class="cm"> *				and fix DCB freeing			*</span>
<span class="cm"> *	2.0d2800/02/14	KG	Queue statistics fixed, dump special cmd*</span>
<span class="cm"> *				Waiting_Timer for failed StartSCSI	*</span>
<span class="cm"> *				New EH: Don&#39;t return cmnds to ML on RST *</span>
<span class="cm"> *				Use old EH (don&#39;t have new EH fns yet)	*</span>
<span class="cm"> * 				Reset: Unlock, but refuse to queue	*</span>
<span class="cm"> * 				2.3 __setup function			*</span>
<span class="cm"> *	2.0e  00/05/22	KG	Return residual for 2.3			*</span>
<span class="cm"> *	2.0e1 00/05/25	KG	Compile fixes for 2.3.99		*</span>
<span class="cm"> *	2.0e2 00/05/27	KG	Jeff Garzik&#39;s pci_enable_device()	*</span>
<span class="cm"> *	2.0e3 00/09/29	KG	Some 2.4 changes. Don&#39;t try Sync Nego	*</span>
<span class="cm"> *				before INQUIRY has reported ability. 	*</span>
<span class="cm"> *				Recognise INQUIRY as scanning command.	*</span>
<span class="cm"> *	2.0e4 00/10/13	KG	Allow compilation into 2.4 kernel	*</span>
<span class="cm"> *	2.0e5 00/11/17	KG	Store Inq.flags in DCB			*</span>
<span class="cm"> *	2.0e6 00/11/22  KG	2.4 init function (Thx to O.Schumann)	*</span>
<span class="cm"> * 				2.4 PCI device table (Thx to A.Richter)	*</span>
<span class="cm"> *	2.0e7 00/11/28	KG	Allow overriding of BIOS settings	*</span>
<span class="cm"> *	2.0f  00/12/20	KG	Handle failed INQUIRYs during scan	*</span>
<span class="cm"> *	2.1a  03/11/29  GL, KG	Initial fixing for 2.6. Convert to	*</span>
<span class="cm"> *				use the current PCI-mapping API, update	*</span>
<span class="cm"> *				command-queuing.			*</span>
<span class="cm"> *	2.1b  04/04/13  GL	Fix for 64-bit platforms		*</span>
<span class="cm"> *	2.1b1 04/01/31	GL	(applied 05.04) Remove internal		*</span>
<span class="cm"> *				command-queuing.			*</span>
<span class="cm"> *	2.1b2 04/02/01	CH	(applied 05.04) Fix error-handling	*</span>
<span class="cm"> *	2.1c  04/05/23  GL	Update to use the new pci_driver API,	*</span>
<span class="cm"> *				some scsi EH updates, more cleanup.	*</span>
<span class="cm"> *	2.1d  04/05/27	GL	Moved setting of scan_devices to	*</span>
<span class="cm"> *				slave_alloc/_configure/_destroy, as	*</span>
<span class="cm"> *				suggested by CH.			*</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/* DEBUG options */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define DC390_DEBUG0</h1>

<h1>define DC390_DEBUG1</h1>

<h1>define DC390_DCBDEBUG</h1>

<h1>define DC390_PARSEDEBUG</h1>

<h1>define DC390_REMOVABLEDEBUG</h1>

<h1>define DC390_LOCKDEBUG</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define NOP do{}while(0)</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define C_NOP</span>

<span class="cm">/* Debug definitions */</span>
<span class="cp">#ifdef DC390_DEBUG0</span>
<span class="cp"># define DEBUG0(x) x</span>
<span class="cp">#else</span>
<span class="cp"># define DEBUG0(x) C_NOP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DC390_DEBUG1</span>
<span class="cp"># define DEBUG1(x) x</span>
<span class="cp">#else</span>
<span class="cp"># define DEBUG1(x) C_NOP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DC390_DCBDEBUG</span>
<span class="cp"># define DCBDEBUG(x) x</span>
<span class="cp">#else</span>
<span class="cp"># define DCBDEBUG(x) C_NOP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DC390_PARSEDEBUG</span>
<span class="cp"># define PARSEDEBUG(x) x</span>
<span class="cp">#else</span>
<span class="cp"># define PARSEDEBUG(x) C_NOP</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DC390_REMOVABLEDEBUG</span>
<span class="cp"># define REMOVABLEDEBUG(x) x</span>
<span class="cp">#else</span>
<span class="cp"># define REMOVABLEDEBUG(x) C_NOP</span>
<span class="cp">#endif</span>
<span class="cp">#define DCBDEBUG1(x) C_NOP</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>


<span class="cp">#define DC390_BANNER &quot;Tekram DC390/AM53C974&quot;</span>
<span class="cp">#define DC390_VERSION &quot;2.1d 2004-05-27&quot;</span>

<span class="cp">#define PCI_DEVICE_ID_AMD53C974 	PCI_DEVICE_ID_AMD_SCSI</span>

<span class="cp">#include &quot;tmscsim.h&quot;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_DataOut_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_DataIn_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Command_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Status_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_MsgOut_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_MsgIn_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_DataOutPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_DataInPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_CommandPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_StatusPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_MsgOutPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_MsgInPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Nop_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Nop_1</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_SetXferRate</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Disconnect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_Reselect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_SRBdone</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_ScsiRstDetect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_EnableMsgOut_Abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_dumpinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_ResetDevParam</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span>	<span class="n">dc390_laststatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">dc390_adapterCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_clustering</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_clustering</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_clustering</span><span class="p">,</span> <span class="s">&quot;If you experience problems with your devices, try setting to 1&quot;</span><span class="p">);</span>

<span class="cm">/* Startup values, to be overriden on the commandline */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tmscsim</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">tmscsim</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tmscsim</span><span class="p">,</span> <span class="s">&quot;Host SCSI ID, Speed (0=10MHz), Device Flags, Adapter Flags, Max Tags (log2(tags)-1), DelayReset (s)&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;C.L. Huang / Kurt Garloff&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SCSI host adapter driver for Tekram DC390 and other AMD53C974A based PCI SCSI adapters&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;sd,sr,sg,st&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dc390_phase0</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
       <span class="n">dc390_DataOut_0</span><span class="p">,</span>
       <span class="n">dc390_DataIn_0</span><span class="p">,</span>
       <span class="n">dc390_Command_0</span><span class="p">,</span>
       <span class="n">dc390_Status_0</span><span class="p">,</span>
       <span class="n">dc390_Nop_0</span><span class="p">,</span>
       <span class="n">dc390_Nop_0</span><span class="p">,</span>
       <span class="n">dc390_MsgOut_0</span><span class="p">,</span>
       <span class="n">dc390_MsgIn_0</span><span class="p">,</span>
       <span class="n">dc390_Nop_1</span>
       <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dc390_phase1</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
       <span class="n">dc390_DataOutPhase</span><span class="p">,</span>
       <span class="n">dc390_DataInPhase</span><span class="p">,</span>
       <span class="n">dc390_CommandPhase</span><span class="p">,</span>
       <span class="n">dc390_StatusPhase</span><span class="p">,</span>
       <span class="n">dc390_Nop_0</span><span class="p">,</span>
       <span class="n">dc390_Nop_0</span><span class="p">,</span>
       <span class="n">dc390_MsgOutPhase</span><span class="p">,</span>
       <span class="n">dc390_MsgInPhase</span><span class="p">,</span>
       <span class="n">dc390_Nop_1</span>
       <span class="p">};</span>

<span class="cp">#ifdef DC390_DEBUG1</span>
<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dc390_p0_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="s">&quot;dc390_DataOut_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_DataIn_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Command_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Status_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_MsgOut_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_MsgIn_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_1&quot;</span>
       <span class="p">};</span>
     
<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dc390_p1_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="s">&quot;dc390_DataOutPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_DataInPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_CommandPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_StatusPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_0&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_MsgOutPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_MsgInPhase&quot;</span><span class="p">,</span>
       <span class="s">&quot;dc390_Nop_1&quot;</span>
       <span class="p">};</span>
<span class="cp">#endif   </span>

<span class="k">static</span> <span class="n">u8</span>  <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">MAX_ADAPTER_NUM</span><span class="p">][</span><span class="n">EE_LEN</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u8</span>  <span class="n">dc390_clock_period1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span>  <span class="n">dc390_clock_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">100</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">};</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Functions for the management of the internal structures </span>
<span class="cm"> * (DCBs, SRBs, Queueing)</span>
<span class="cm"> *</span>
<span class="cm"> **********************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">dc390_start_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">psgl</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">;</span>

	<span class="cm">/* start new sg segment */</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">psgl</span><span class="p">);</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">psgl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kr">inline</span> <span class="nf">dc390_advance_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u32</span> <span class="n">residue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xfer</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">-</span> <span class="n">residue</span><span class="p">;</span>

	<span class="cm">/* xfer more bytes transferred */</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span> <span class="o">+=</span> <span class="n">xfer</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">+=</span> <span class="n">xfer</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="n">residue</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xfer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="n">__inline__</span> <span class="o">*</span><span class="nf">dc390_findDCB</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">!=</span> <span class="n">id</span> <span class="o">||</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">!=</span> <span class="n">lun</span><span class="p">)</span>
     <span class="p">{</span>
	<span class="n">pDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">)</span>
	     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="n">DCBDEBUG1</span><span class="p">(</span> <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DCB %p (%02x,%02x) found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	\
		      <span class="n">pDCB</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">));</span>
   <span class="k">return</span> <span class="n">pDCB</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Insert SRB oin top of free list */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">dc390_Free_insert</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Free SRB %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pFreeSRB</span><span class="p">;</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pFreeSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">dc390_Going_append</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span><span class="o">++</span><span class="p">;</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;DC390: Append SRB %p to Going</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
    <span class="cm">/* Append to the list of Going commands */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span> <span class="p">)</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingLast</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
    <span class="k">else</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>

    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingLast</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
    <span class="cm">/* No next one in sent list */</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">dc390_Going_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;DC390: Remove SRB %p from Going</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span> <span class="o">==</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">)</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
   <span class="k">else</span>
     <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">psrb</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">psrb</span> <span class="o">&amp;&amp;</span> <span class="n">psrb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">!=</span> <span class="n">pSRB</span><span class="p">)</span>
	  <span class="n">psrb</span> <span class="o">=</span> <span class="n">psrb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psrb</span><span class="p">)</span> 
	  <span class="p">{</span> <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Remove non-ex. SRB %p from Going!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
	<span class="n">psrb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span> <span class="o">==</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingLast</span><span class="p">)</span>
	  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingLast</span> <span class="o">=</span> <span class="n">psrb</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scatterlist</span><span class="o">*</span> <span class="nf">dc390_sg_build_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sg_init_one</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create pci mapping */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc390_pci_map</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span><span class="o">-&gt;</span><span class="n">pDCBACB</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">dc390_cmd_scp_t</span><span class="o">*</span> <span class="n">cmdp</span> <span class="o">=</span> <span class="p">((</span><span class="n">dc390_cmd_scp_t</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">));</span>

	<span class="cm">/* Map sense buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span>	<span class="o">=</span> <span class="n">dc390_sg_build_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Segmentx</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span>		<span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						     <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">saved_dma_handle</span>	<span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">);</span>

		<span class="cm">/* TODO: error handling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(): Mapped sense buffer %p at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">saved_dma_handle</span><span class="p">));</span>
	<span class="cm">/* Map SG list */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">pcmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>

		<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>

		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span>	<span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span>		<span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

		<span class="cm">/* TODO: error handling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(): Mapped SG %p with %d (%d) elements</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
			      <span class="n">__func__</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">pcmd</span><span class="p">),</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">pcmd</span><span class="p">)));</span>
	<span class="cm">/* Map single segment */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remove pci mapping */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dc390_pci_unmap</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span><span class="o">-&gt;</span><span class="n">pDCBACB</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">dc390_cmd_scp_t</span><span class="o">*</span> <span class="n">cmdp</span> <span class="o">=</span> <span class="p">((</span><span class="n">dc390_cmd_scp_t</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Segmentx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(): Unmapped sense buffer at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmdp</span><span class="o">-&gt;</span><span class="n">saved_dma_handle</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
		<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(): Unmapped SG at %p with %d elements</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">__func__</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">pcmd</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">pcmd</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__inline__</span>
<span class="nf">dc390_freetag</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TagNumber</span> <span class="o">!=</span> <span class="n">SCSI_NO_TAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TagMask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TagNumber</span><span class="p">);</span>   <span class="cm">/* free tag mask */</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TagNumber</span> <span class="o">=</span> <span class="n">SCSI_NO_TAG</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dc390_StartSCSI</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">disc_allowed</span><span class="p">,</span> <span class="n">try_sync_nego</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span><span class="p">)</span>
    <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Should not happen normally</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DC390: Can&#39;t select when connected! (%08x,%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span><span class="p">);</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SelConn</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">last_reset</span><span class="p">))</span>
    <span class="p">{</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: We were just reset and don&#39;t accept commands yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* KG: Moved pci mapping here */</span>
    <span class="n">dc390_pci_map</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>
    <span class="cm">/* TODO: error handling */</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Scsi_Dest_ID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Period</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Offset</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR1</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg3</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg4</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>		<span class="cm">/* Flush FIFO */</span>
    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Start SCSI command: %02x (Sync:%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
            <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span><span class="p">));</span>

    <span class="cm">/* Don&#39;t disconnect on AUTO_REQSENSE, cause it might be an</span>
<span class="cm">     * Contingent Allegiance Condition (6.6), where no tags should be used.</span>
<span class="cm">     * All other have to be allowed to disconnect to prevent Incorrect </span>
<span class="cm">     * Initiator Connection (6.8.2/6.5.2) */</span>
    <span class="cm">/* Changed KG, 99/06/06 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">))</span>
	<span class="n">disc_allowed</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">&amp;</span> <span class="n">EN_DISCONNECT_</span><span class="p">;</span>
    <span class="k">else</span>
	<span class="n">disc_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">SYNC_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdtr</span> <span class="o">&amp;&amp;</span>
	<span class="p">(((</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span> <span class="o">||</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	  <span class="o">!</span><span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">))</span> <span class="o">||</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">))</span>
      <span class="n">try_sync_nego</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">try_sync_nego</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">SEL_W_ATN</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">IDENTIFY</span><span class="p">(</span><span class="n">disc_allowed</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">));</span>
    <span class="cm">/* Change 99/05/31: Don&#39;t use tags when not disconnecting (BUSY) */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">EN_TAG_QUEUEING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">disc_allowed</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TagMask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TagNumber</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Select w/DisCn for SRB %p, block tag %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">SEL_W_ATN3</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* No TagQ */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>no_tag:</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Select w%s/DisCn for SRB %p, No TagQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">disc_allowed</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_START_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">try_sync_nego</span><span class="p">)</span>
      <span class="p">{</span> 
	<span class="n">u8</span> <span class="n">Sync_Off</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">;</span>
        <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: NEW Sync Nego code triggered (%i %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">));</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">EXTENDED_SDTR</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Sync_Off</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span> <span class="n">Sync_Off</span> <span class="o">=</span> <span class="n">SYNC_NEGO_OFFSET</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sync_Off</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>pSRB->SRBState = SRB<em>MSGOUT</em>;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">|=</span> <span class="n">DO_SYNC_NEGO</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">SEL_W_ATN_STOP</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="cm">/* Command is written in CommandPhase, if SEL_W_ATN_STOP ... */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SEL_W_ATN_STOP</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span> <span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">REQUEST_SENSE</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DC390: AutoReqSense !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	  <span class="p">}</span>
	<span class="k">else</span>	<span class="cm">/* write cmnd to bus */</span> 
	  <span class="p">{</span>
	    <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	    <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	      <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>
	  <span class="p">}</span>
      <span class="p">}</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">)</span>	\
	   <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DC390: ActiveDCB != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">)</span>	\
	   <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DC390: ActiveSRB != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD);</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Scsi_Status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INTERRUPT</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">dc390_freetag</span> <span class="p">(</span><span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Interrupt during Start SCSI (target %02i-%02i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>DC390<em>write8 (ScsiCmd, CLEAR</em>FIFO_CMD);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SelLost</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="n">SCSI_NOP1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__inline__</span>
<span class="nf">dc390_InvalidCmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_START_</span> <span class="o">|</span> <span class="n">SRB_MSGOUT</span><span class="p">))</span>
		<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">__inline__</span>
<span class="nf">DC390_Interrupt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">pACB</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_srb</span> <span class="o">*</span><span class="n">pSRB</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">sstatus</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">phase</span><span class="p">;</span>
    <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">stateV</span><span class="p">)(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">u8</span>  <span class="n">istate</span><span class="p">,</span> <span class="n">istatus</span><span class="p">;</span>

    <span class="n">sstatus</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Scsi_Status</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">sstatus</span> <span class="o">&amp;</span> <span class="n">INTERRUPT</span><span class="p">)</span> <span class="p">)</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sstatus=%02x,&quot;</span><span class="p">,</span> <span class="n">sstatus</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>DC390<em>write32 (DMA</em>ScsiBusCtrl, WRT<em>ERASE</em>DMA<em>STAT | EN</em>INT<em>ON</em>PCI<em>ABORT);
dstatus = DC390</em>read8 (DMA<em>Status);
DC390</em>write32 (DMA<em>ScsiBusCtrl, EN</em>INT<em>ON</em>PCI_ABORT);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

    <span class="n">istate</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Intern_State</span><span class="p">);</span>
    <span class="n">istatus</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">INT_Status</span><span class="p">);</span> <span class="cm">/* This clears Scsi_Status, Intern_State and INT_Status ! */</span>

    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Istatus(Res,Inv,Dis,Serv,Succ,ReS,SelA,Sel)=%02x,&quot;</span><span class="p">,</span><span class="n">istatus</span><span class="p">));</span>
    <span class="n">dc390_laststatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00ffffff</span><span class="p">;</span>
    <span class="n">dc390_laststatus</span> <span class="o">|=</span> <span class="cm">/* dstatus&lt;&lt;24 | */</span> <span class="n">sstatus</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">istate</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="n">istatus</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sstatus</span> <span class="o">&amp;</span> <span class="n">ILLEGAL_OP_ERR</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Illegal Operation detected (%08x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc390_laststatus</span><span class="p">);</span>
	<span class="n">dc390_dumpinfo</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">);</span>
    <span class="p">}</span>
	
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span>  <span class="n">INVALID_CMD</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Invalid Command detected (%08x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc390_laststatus</span><span class="p">);</span>
	<span class="n">dc390_InvalidCmd</span><span class="p">(</span> <span class="n">pACB</span> <span class="p">);</span>
	<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span>  <span class="n">SCSI_RESET</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">dc390_ScsiRstDetect</span><span class="p">(</span> <span class="n">pACB</span> <span class="p">);</span>
	<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span>  <span class="n">DISCONNECTED</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">dc390_Disconnect</span><span class="p">(</span> <span class="n">pACB</span> <span class="p">);</span>
	<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span>  <span class="n">RESELECTED</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">dc390_Reselect</span><span class="p">(</span> <span class="n">pACB</span> <span class="p">);</span>
	<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELECTED</span> <span class="o">|</span> <span class="n">SEL_ATTENTION</span><span class="p">))</span>
    <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Target mode not supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUCCESSFUL_OP</span><span class="o">|</span><span class="n">SERVICE_REQUEST</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Suc. op/ Serv. req: pActiveDCB = 0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span> <span class="p">)</span>
	  <span class="n">dc390_EnableMsgOut_Abort</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>

	<span class="n">phase</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span><span class="p">;</span>
	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: [%i]%s(0) (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">dc390_p0_str</span><span class="p">[</span><span class="n">phase</span><span class="p">],</span> <span class="n">sstatus</span><span class="p">));</span>
	<span class="n">stateV</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dc390_phase0</span><span class="p">[</span><span class="n">phase</span><span class="p">];</span>
	<span class="p">(</span> <span class="o">*</span><span class="n">stateV</span> <span class="p">)(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstatus</span> <span class="p">);</span>

	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: [%i]%s(1) (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">dc390_p1_str</span><span class="p">[</span><span class="n">phase</span><span class="p">],</span> <span class="n">sstatus</span><span class="p">));</span>
	<span class="n">stateV</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dc390_phase1</span><span class="p">[</span><span class="n">phase</span><span class="p">];</span>
	<span class="p">(</span> <span class="o">*</span><span class="n">stateV</span> <span class="p">)(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstatus</span> <span class="p">);</span>
    <span class="p">}</span>

 <span class="nl">unlock:</span>
    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">do_DC390_Interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Irq (%i) caught: &quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">));</span>
    <span class="cm">/* Locking is done in DC390_Interrupt */</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">DC390_Interrupt</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;.. IRQ returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DataOut_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span>   <span class="n">sstatus</span><span class="p">;</span>
    <span class="n">u32</span>  <span class="n">ResidCnt</span><span class="p">;</span>
    <span class="n">u8</span>   <span class="n">dstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">sstatus</span> <span class="o">=</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_XFERPAD</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARITY_ERR</span> <span class="o">|</span> <span class="n">ILLEGAL_OP_ERR</span><span class="p">)</span> <span class="p">)</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBStatus</span> <span class="o">|=</span> <span class="n">PARITY_ERROR</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="n">COUNT_2_ZERO</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>

	    <span class="cm">/* Function called from the ISR with the host_lock held and interrupts disabled */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">dstate</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">DMA_Status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DMA_XFER_DONE</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		    <span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;DC390: Deadlock in DataOut_0: DMA aborted unfinished: %06x bytes remain!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DC390_read32</span> <span class="p">(</span><span class="n">DMA_Wk_ByteCntr</span><span class="p">));</span>
	    <span class="n">dc390_laststatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff000000</span><span class="p">;</span>
	    <span class="n">dc390_laststatus</span> <span class="o">|=</span> <span class="n">dstate</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">+=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dc390_start_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
	    <span class="n">ResidCnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Current_Fifo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">));</span>

	    <span class="n">dc390_advance_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">,</span> <span class="n">ResidCnt</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">psstatus</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCSI_DATA_OUT</span><span class="p">)</span>
    <span class="p">{</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">WRITE_DIRECTION</span><span class="o">+</span><span class="n">DMA_IDLE_CMD</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="p">}</span>	    
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DataIn_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span>   <span class="n">sstatus</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">bval</span><span class="p">;</span>
    <span class="n">u32</span>  <span class="n">ResidCnt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">xferCnt</span><span class="p">;</span>

    <span class="n">sstatus</span> <span class="o">=</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_XFERPAD</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARITY_ERR</span> <span class="o">|</span> <span class="n">ILLEGAL_OP_ERR</span><span class="p">))</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBStatus</span> <span class="o">|=</span> <span class="n">PARITY_ERROR</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">sstatus</span> <span class="o">&amp;</span> <span class="n">COUNT_2_ZERO</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="kt">int</span> <span class="n">dstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>

	    <span class="cm">/* Function called from the ISR with the host_lock held and interrupts disabled */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">dstate</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">DMA_Status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DMA_XFER_DONE</span><span class="p">))</span> <span class="p">{</span>
		    <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		    <span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		    <span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;DC390: Deadlock in DataIn_0: DMA aborted unfinished: %06x bytes remain!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DC390_read32</span> <span class="p">(</span><span class="n">DMA_Wk_ByteCntr</span><span class="p">));</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;DC390: DataIn_0: DMA State: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">dc390_laststatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff000000</span><span class="p">;</span>
	    <span class="n">dc390_laststatus</span> <span class="o">|=</span> <span class="n">dstate</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">ResidCnt</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>	\
		<span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>		\
		<span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">)));</span>
	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Count_2_Zero (ResidCnt=%u,ToBeXfer=%lu),&quot;</span><span class="p">,</span> <span class="n">ResidCnt</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">));</span>

	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">READ_DIRECTION</span><span class="o">+</span><span class="n">DMA_IDLE_CMD</span><span class="p">);</span>

	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">+=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dc390_start_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>	<span class="cm">/* phase changed */</span>
	<span class="p">{</span>
	    <span class="n">residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Current_Fifo</span><span class="p">);</span>
	    <span class="k">while</span><span class="p">(</span> <span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Check for residuals,&quot;</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="p">{</span>
		    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		    <span class="p">{</span>
			<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Current_Fifo</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">)</span>
			    <span class="k">goto</span> <span class="n">din_1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="mh">0x0ff</span> <span class="p">)</span>
			<span class="p">{</span>
			    <span class="n">residual</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* ;1 residual byte */</span>
			    <span class="k">goto</span> <span class="n">din_1</span><span class="p">;</span>
			<span class="p">}</span>
		    <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		    <span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">Current_Fifo</span><span class="p">);</span>
	    <span class="p">}</span>
<span class="nl">din_1:</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">READ_DIRECTION</span><span class="o">+</span><span class="n">DMA_BLAST_CMD</span><span class="p">);</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0xa000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">DMA_Status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">BLAST_COMPLETE</span><span class="p">)</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="cm">/* It seems a DMA Blast abort isn&#39;t that bad ... */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: DMA Blast aborted unfinished!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, READ<em>DIRECTION+DMA</em>IDLE_CMD);</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">dc390_laststatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff000000</span><span class="p">;</span>
	    <span class="n">dc390_laststatus</span> <span class="o">|=</span> <span class="n">bval</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Blast: Read %i times DMA_Status %02x&quot;</span><span class="p">,</span> <span class="mh">0xa000</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">bval</span><span class="p">));</span>
	    <span class="n">ResidCnt</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">);</span>

	    <span class="n">xferCnt</span> <span class="o">=</span> <span class="n">dc390_advance_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">,</span> <span class="n">ResidCnt</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">residual</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span> <span class="o">-</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

		<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span>	    <span class="cm">/* get one residual byte */</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">scsi_kmap_atomic_sg</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">=</span> <span class="n">bval</span><span class="p">;</span>
			<span class="n">scsi_kunmap_atomic_sg</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">);</span>

		<span class="cm">/* 1 more byte read */</span>
		<span class="n">xferCnt</span> <span class="o">+=</span> <span class="n">dc390_advance_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Xfered: %lu, Total: %lu, Remaining: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xferCnt</span><span class="p">,</span>\
			   <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">psstatus</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCSI_DATA_IN</span><span class="p">)</span>
    <span class="p">{</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">READ_DIRECTION</span><span class="o">+</span><span class="n">DMA_IDLE_CMD</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Command_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Status_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>udelay (1);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">EndMessage</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span>	<span class="cm">/* get message */</span>

    <span class="o">*</span><span class="n">psstatus</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_COMPLETED</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">MSG_ACCEPTED_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_MsgOut_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_UNEXPECT_RESEL</span><span class="o">+</span><span class="n">SRB_ABORT_SENT</span><span class="p">)</span> <span class="p">)</span>
	<span class="o">*</span><span class="n">psstatus</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__inline__</span>
<span class="nf">dc390_reprog</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Period</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">);</span>
  <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Offset</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">);</span>
  <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg3</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span><span class="p">);</span>
  <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg4</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span><span class="p">);</span>
  <span class="n">dc390_SetXferRate</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef DC390_DEBUG0</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_printMsg</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">MsgBuf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">printk</span> <span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">MsgBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">MsgBuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define DC390_ENABLE_MSGOUT DC390_write8 (ScsiCmd, SET_ATN_CMD)</span>

<span class="cm">/* reject_msg */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__inline__</span>
<span class="nf">dc390_MsgIn_reject</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">DC390_ENABLE_MSGOUT</span><span class="p">;</span>
  <span class="n">DEBUG0</span> <span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Reject message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* abort command */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_EnableMsgOut_Abort</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT</span><span class="p">;</span> 
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">DC390_ENABLE_MSGOUT</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ABORT_DEV_</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span>
<span class="nf">dc390_MsgIn_QTag</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">s8</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">scsi_find_tag</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_srb</span> <span class="o">*</span><span class="p">)</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_ABORT_SENT</span><span class="p">;</span>
	  <span class="n">dc390_EnableMsgOut_Abort</span><span class="p">(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mingx0</span><span class="p">;</span>

	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
    <span class="nl">mingx0:</span>
      <span class="n">pSRB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pTmpSRB</span><span class="p">;</span>
      <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_UNEXPECT_RESEL</span><span class="p">;</span>
      <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
      <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT_TAG</span><span class="p">;</span>
      <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">DC390_ENABLE_MSGOUT</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">pSRB</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* set async transfer mode */</span>
<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">dc390_MsgIn_set_async</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">DO_SYNC_NEGO</span><span class="p">))</span> 
    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Target %i initiates Non-Sync?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DO_SYNC_NEGO</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYNC_ENABLE</span><span class="o">+</span><span class="n">SYNC_NEGO_DONE</span><span class="p">);</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>pDCB->NegoPeriod = 50; /* 200ns &lt;=> 5 MHz */</p></td><td class="code"><div class="highlight"><pre>  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">FAST_CLK</span><span class="p">;</span>	<span class="cm">/* fast clock / normal scsi */</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span><span class="p">;</span>	<span class="cm">/* glitch eater */</span>
  <span class="n">dc390_reprog</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set sync transfer mode */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_MsgIn_set_sync</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">wval</span><span class="p">,</span> <span class="n">wval1</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">oldsyncperiod</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">oldsyncoffset</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">DO_SYNC_NEGO</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Target %i initiates Sync: %ins %i ... answer ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	      <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

      <span class="cm">/* reject */</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>dc390<em>MsgIn</em>reject (pACB, pSRB);
return dc390<em>MsgIn</em>set_async (pACB, pSRB);</p></td><td class="code"><div class="highlight"><pre>      <span class="cm">/* Reply with corrected SDTR Message */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
	<span class="p">{</span> 
	  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Lower Sync Offset to 15</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Set sync nego period to %ins</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">memcpy</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
      <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="n">DC390_ENABLE_MSGOUT</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DO_SYNC_NEGO</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">|=</span> <span class="n">SYNC_ENABLE</span><span class="o">+</span><span class="n">SYNC_NEGO_DONE</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">&amp;=</span> <span class="mh">0x0f0</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">|=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

  <span class="n">wval</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">wval</span> <span class="o">=</span> <span class="n">wval</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">wval</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">wval1</span> <span class="o">=</span> <span class="n">wval</span> <span class="o">/</span> <span class="mi">25</span><span class="p">;</span>	<span class="cm">/* compute speed */</span>
  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">wval1</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wval</span><span class="p">)</span> <span class="n">wval1</span><span class="o">++</span><span class="p">;</span>
  <span class="n">bval</span> <span class="o">=</span> <span class="n">FAST_CLK</span><span class="o">+</span><span class="n">FAST_SCSI</span><span class="p">;</span>	<span class="cm">/* fast clock / fast scsi */</span>

  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>		<span class="cm">/* Glitch eater: 12ns less than normal */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span> <span class="o">!=</span> <span class="n">NS_TO_GLITCH</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">NS_TO_GLITCH</span><span class="p">(((</span><span class="n">GLITCH_TO_NS</span><span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">NS_TO_GLITCH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">wval1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">NS_TO_GLITCH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* Ultra */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">wval1</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">wval1</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* Timing computation differs by 1 from FAST_SCSI */</span>
      <span class="n">bval</span> <span class="o">=</span> <span class="n">FAST_CLK</span><span class="p">;</span>		<span class="cm">/* fast clock / normal scsi */</span>
      <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span><span class="p">;</span> 	<span class="cm">/* glitch eater */</span>
    <span class="p">}</span>

  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">bval</span><span class="p">;</span>
  <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">wval1</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">((</span><span class="n">oldsyncperiod</span> <span class="o">!=</span> <span class="n">wval1</span> <span class="o">||</span> <span class="n">oldsyncoffset</span> <span class="o">!=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">FAST_SCSI</span><span class="p">))</span> <span class="n">wval1</span><span class="o">++</span><span class="p">;</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Target %i: Sync transfer %i.%1i MHz, Offset %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> 
	      <span class="mi">40</span><span class="o">/</span><span class="n">wval1</span><span class="p">,</span> <span class="p">((</span><span class="mi">40</span><span class="o">%</span><span class="n">wval1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="n">wval1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">wval1</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
    <span class="p">}</span>
  
  <span class="n">dc390_reprog</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* handle RESTORE_PTR */</span>
<span class="cm">/* This doesn&#39;t look very healthy... to-be-fixed */</span>
<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">dc390_restore_ptr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">psgl</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">pcmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">saved</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
	<span class="n">psgl</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>dc390<em>pci</em>sync(pSRB);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">psgl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Saved_Ptr</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">psgl</span><span class="p">);</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSegmentList</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dc390_start_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">saved</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Saved_Ptr</span> <span class="o">-</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">-=</span> <span class="n">saved</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span> <span class="o">+=</span> <span class="n">saved</span><span class="p">;</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Pointer restored. Segment %i, Total %li, Bus %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Saved_Ptr</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	 <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: RESTORE_PTR message for Transfer without Scatter-Gather ??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Saved_Ptr</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* According to the docs, the AM53C974 reads the message and </span>
<span class="cm"> * generates a Successful Operation IRQ before asserting ACK for</span>
<span class="cm"> * the last byte (how does it know whether it&#39;s the last ?) */</span>
<span class="cm">/* The old code handled it in another way, indicating, that on</span>
<span class="cm"> * every message byte an IRQ is generated and every byte has to</span>
<span class="cm"> * be manually ACKed. Hmmm ?  (KG, 98/11/28) */</span>
<span class="cm">/* The old implementation was correct. Sigh! */</span>

<span class="cm">/* Check if the message is complete */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">__inline__</span>
<span class="nf">dc390_MsgIn_complete</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">msgbuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgbuf</span> <span class="o">==</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">msgbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgbuf</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">msgbuf</span> <span class="o">&lt;=</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="c1">// two byte messages</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* read and eval received messages */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_MsgIn_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>   <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>

    <span class="cm">/* Read the msg */</span>

    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">MsgLen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>pSRB->SRBState = 0;</p></td><td class="code"><div class="highlight"><pre>    <span class="cm">/* Msg complete ? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dc390_MsgIn_complete</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">MsgLen</span><span class="p">))</span>
      <span class="p">{</span>
	<span class="n">DEBUG0</span> <span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: MsgIn:&quot;</span><span class="p">);</span> <span class="n">dc390_printMsg</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">MsgLen</span><span class="p">));</span>
	<span class="cm">/* Now eval the msg */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
	  <span class="p">{</span>
	  <span class="k">case</span> <span class="n">DISCONNECT</span>: 
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_DISCONNECT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	    
	  <span class="k">case</span> <span class="n">SIMPLE_QUEUE_TAG</span>:
	  <span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
	  <span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
	    <span class="n">pSRB</span> <span class="o">=</span> <span class="n">dc390_MsgIn_QTag</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	    <span class="k">break</span><span class="p">;</span>
	    
	  <span class="k">case</span> <span class="n">MESSAGE_REJECT</span>: 
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">RESET_ATN_CMD</span><span class="p">);</span>
	    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* 200ns &lt;=&gt; 5 MHz */</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">DO_SYNC_NEGO</span><span class="p">)</span>
	      <span class="n">dc390_MsgIn_set_async</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	    
	  <span class="k">case</span> <span class="n">EXTENDED_MESSAGE</span>:
	    <span class="cm">/* reject every extended msg but SDTR */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EXTENDED_SDTR</span><span class="p">)</span>
	      <span class="n">dc390_MsgIn_reject</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="k">else</span>
	      <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgInBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		  <span class="n">dc390_MsgIn_set_async</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
		<span class="k">else</span>
		  <span class="n">dc390_MsgIn_set_sync</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	      <span class="p">}</span>
	    </pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>nothing has to be done</p></td><td class="code"><div class="highlight"><pre>	  <span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>: <span class="k">break</span><span class="p">;</span>
	    </pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>SAVE POINTER may be ignored as we have the struct dc390_srb* associated with the
scsi command. Thanks, Gerard, for pointing it out.</p></td><td class="code"><div class="highlight"><pre>	  <span class="k">case</span> <span class="n">SAVE_POINTERS</span>: 
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">Saved_Ptr</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>The device might want to restart transfer with a RESTORE</p></td><td class="code"><div class="highlight"><pre>	  <span class="k">case</span> <span class="n">RESTORE_POINTERS</span>:
	    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: RESTORE POINTER message received ... try to handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	    <span class="n">dc390_restore_ptr</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>reject unknown messages</p></td><td class="code"><div class="highlight"><pre>	  <span class="nl">default:</span> <span class="n">dc390_MsgIn_reject</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	  <span class="p">}</span>
	
	<span class="cm">/* Clear counter and MsgIn state */</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_MSGIN</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">MsgLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="o">*</span><span class="n">psstatus</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">MSG_ACCEPTED_CMD</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DataIO_Comm</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ioDir</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">lval</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>   <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pTmpSRB</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (%02i-%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (DCB 0!)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Try to recover - some broken disks react badly to tagged INQUIRY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">&amp;&amp;</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="o">&amp;&amp;</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
		<span class="n">dc390_EnableMsgOut_Abort</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="p">)</span>
			<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">|=</span> <span class="n">ABORT_DEV</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">&lt;</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">DMA_IDLE_CMD</span> <span class="o">|</span> <span class="n">ioDir</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">dc390_start_segment</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>

	    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; DC390: Next SG segment.&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">lval</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">;</span>
	<span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; DC390: Start transfer: %li bytes (address %08lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lval</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span><span class="p">));</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">lval</span><span class="p">);</span>
	<span class="n">lval</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">lval</span><span class="p">);</span>
	<span class="n">lval</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_High</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">lval</span><span class="p">);</span>

	<span class="n">DC390_write32</span> <span class="p">(</span><span class="n">DMA_XferCnt</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">);</span>
	<span class="n">DC390_write32</span> <span class="p">(</span><span class="n">DMA_XferAddr</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD | ioDir);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>

	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">DMA_COMMAND</span><span class="o">+</span><span class="n">INFO_XFER_CMD</span><span class="p">);</span>

	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">DMA_START_CMD</span> <span class="o">|</span> <span class="n">ioDir</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>DEBUG1(DC390<em>write32 (DMA</em>ScsiBusCtrl, WRT<em>ERASE</em>DMA<em>STAT | EN</em>INT<em>ON</em>PCI<em>ABORT));
DEBUG1(printk (KERN</em>DEBUG "DC390: DMA<em>Status: %02x\n", DC390</em>read8 (DMA<em>Status)));
DEBUG1(DC390</em>write32 (DMA<em>ScsiBusCtrl, EN</em>INT<em>ON</em>PCI_ABORT));</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>
    <span class="k">else</span>    <span class="cm">/* xfer pad */</span>
    <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGcount</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="n">H_OVER_UNDER_RUN</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBStatus</span> <span class="o">|=</span> <span class="n">OVER_RUN</span><span class="p">;</span>
	    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot; DC390: Overrun -&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot; Clear transfer pad </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtcReg_High</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">|=</span> <span class="n">SRB_XFERPAD</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">DMA_COMMAND</span><span class="o">+</span><span class="n">XFER_PAD_BYTE</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">	DC390_write8 (DMA_Cmd, DMA_IDLE_CMD | ioDir);</span>
<span class="cm">	DC390_write8 (DMA_Cmd, DMA_START_CMD | ioDir);</span>
<span class="cm">*/</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DataOutPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dc390_DataIO_Comm</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">WRITE_DIRECTION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DataInPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dc390_DataIO_Comm</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">READ_DIRECTION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_CommandPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>   <span class="n">pDCB</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
    <span class="n">u8</span>     <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">RESET_ATN_CMD</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">REQUEST_SENSE</span><span class="p">);</span>
	<span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DC390: AutoReqSense (CmndPhase)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_COMMAND</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">INFO_XFER_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_StatusPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_STATUS</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">INITIATOR_CMD_CMPLTE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_MsgOutPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span>   <span class="n">bval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
    <span class="n">u8</span>     <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>    <span class="n">pDCB</span><span class="p">;</span>

    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_MSGOUT</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">cnt</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">;</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">MsgOutBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABORT</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_ABORT_SENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
	    <span class="n">bval</span> <span class="o">=</span> <span class="n">ABORT</span><span class="p">;</span>	<span class="cm">/* ??? MSG_NOP */</span>
	    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span> <span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">SYNC_ENABLE</span> <span class="p">)</span>
		    <span class="k">goto</span>  <span class="n">mop1</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">INFO_XFER_CMD</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
<span class="nl">mop1:</span>
        <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: OLD Sync Nego code triggered! (%i %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">);</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/*    ;length of extended msg */</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">EXTENDED_SDTR</span><span class="p">);</span>	<span class="cm">/*    ; sync nego */</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span>
		    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">);</span>
	<span class="k">else</span>
		    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">,</span> <span class="n">SYNC_NEGO_OFFSET</span><span class="p">);</span>		    
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">|=</span> <span class="n">DO_SYNC_NEGO</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">INFO_XFER_CMD</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_MsgInPhase</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_MSGIN</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DISCONNECT</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">|=</span> <span class="n">SRB_MSGIN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">INFO_XFER_CMD</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>DC390<em>write8 (DMA</em>Cmd, DMA<em>IDLE</em>CMD);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Nop_0</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Nop_1</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">psstatus</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_SetXferRate</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span>  <span class="n">bval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>   <span class="n">ptr</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">ptr</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span>
	    <span class="n">cnt</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">DCBCnt</span><span class="p">;</span>
	    <span class="n">bval</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">==</span> <span class="n">bval</span> <span class="p">)</span>
		<span class="p">{</span>
		    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">;</span>
		    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">;</span>
		    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span><span class="p">;</span>
		    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span><span class="p">;</span>
		    <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Disconnect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_srb</span> <span class="o">*</span><span class="n">pSRB</span><span class="p">,</span> <span class="o">*</span><span class="n">psrb</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DISC,&quot;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Disconnect not-connected bus?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span>
     <span class="p">{</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ACB:%p-&gt;ActiveDCB:%p IOPort:%04x IRQ:%02x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
	       <span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">IOPortBase</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">IRQLevel</span><span class="p">));</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
	<span class="n">DC390_read8</span> <span class="p">(</span><span class="n">INT_Status</span><span class="p">);</span>	<span class="cm">/* Reset Pending INT */</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">EN_SEL_RESEL</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
     <span class="p">}</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">EN_SEL_RESEL</span><span class="p">);</span>
    <span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">;</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_UNEXPECT_RESEL</span> <span class="p">)</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_ABORT_SENT</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TagMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">psrb</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
	    <span class="n">dc390_Free_insert</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="n">pSRB</span> <span class="o">=</span> <span class="n">psrb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_START_</span><span class="o">+</span><span class="n">SRB_MSGOUT</span><span class="p">))</span> <span class="o">||</span>
	   <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_DISCONNECT</span><span class="o">+</span><span class="n">SRB_COMPLETED</span><span class="p">))</span> <span class="p">)</span>
	<span class="p">{</span>	<span class="cm">/* Selection time out */</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="n">H_SEL_TIMEOUT</span><span class="p">;</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span>  <span class="n">disc1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_COMPLETED</span><span class="p">))</span>
	<span class="p">{</span>
<span class="nl">disc1:</span>
	    <span class="n">dc390_freetag</span> <span class="p">(</span><span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_FREE</span><span class="p">;</span>
	    <span class="n">dc390_SRBdone</span><span class="p">(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">MsgLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_Reselect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span>   <span class="n">pDCB</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span>   <span class="n">pSRB</span><span class="p">;</span>
    <span class="n">u8</span>  <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RSEL,&quot;</span><span class="p">));</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span> <span class="p">)</span>
    <span class="p">{</span>	<span class="cm">/* Arbitration lost but Reselection won */</span>
	<span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: (ActiveDCB != 0: Arb. lost but resel. won)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	    <span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">pcmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">pcmd</span><span class="p">));</span>
	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_SOFT_ERROR</span><span class="p">);</span>
	    <span class="n">dc390_Going_remove</span><span class="p">(</span><span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="n">dc390_Free_insert</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
	    <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
	    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;DC390: Return SRB %p to free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* Get ID */</span>
    <span class="n">lun</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Dev %02x,&quot;</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">)))</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Reselection must select host adapter: %02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">lun</span> <span class="o">^=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">;</span> <span class="cm">/* Mask AdapterID */</span>
    <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="n">lun</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">id</span><span class="o">++</span><span class="p">;</span>
    <span class="cm">/* Get LUN */</span>
    <span class="n">lun</span> <span class="o">=</span> <span class="n">DC390_read8</span> <span class="p">(</span><span class="n">ScsiFifo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lun</span> <span class="o">&amp;</span> <span class="n">IDENTIFY_BASE</span><span class="p">))</span> <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Resel: Expect identify message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">lun</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;(%02i-%i),&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">dc390_findDCB</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Reselect from non existing device (%02i-%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
    <span class="cm">/* TagQ: We expect a message soon, so never mind the exact SRB */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">EN_TAG_QUEUEING</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pTmpSRB</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
	<span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pSRB</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pTmpSRB</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_UNEXPECT_RESEL</span><span class="p">;</span>
	    <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: Reselect without outstanding cmnd (%02i-%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	    <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span> <span class="o">=</span> <span class="n">pSRB</span><span class="p">;</span>
	    <span class="n">dc390_EnableMsgOut_Abort</span> <span class="p">(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span> <span class="p">)</span>
	    <span class="p">{</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_ABORT_SENT</span><span class="p">;</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Reselect: Abort (%02i-%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">dc390_EnableMsgOut_Abort</span><span class="p">(</span> <span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span> <span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">DEBUG1</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Resel SRB(%p): TagNum (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TagNumber</span><span class="p">));</span>
    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="n">SCSI_NOP0</span><span class="p">;</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Scsi_Dest_ID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Period</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">Sync_Offset</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR1</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg3</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg4</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span><span class="p">);</span>	<span class="cm">/* ; Glitch eater */</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">MSG_ACCEPTED_CMD</span><span class="p">);</span>	<span class="cm">/* ;to release the /ACK signal */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__inline__</span>
<span class="nf">dc390_RequestSense</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>

	<span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>

	<span class="n">REMOVABLEDEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: RequestSense(Cmd %02x, Id %02x, LUN %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
			      <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span><span class="p">));</span>

	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">|=</span> <span class="n">AUTO_REQSENSE</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SavedTotXLen</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* CHECK_CONDITION&lt;&lt;1; */</span>

	<span class="cm">/* We are called from SRBdone, original PCI mapping has been removed</span>
<span class="cm">	 * already, new one is set up from StartSCSI */</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dc390_StartSCSI</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_SRBdone</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>

    <span class="n">pcmd</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
    <span class="cm">/* KG: Moved pci_unmap here */</span>
    <span class="n">dc390_pci_unmap</span><span class="p">(</span><span class="n">pSRB</span><span class="p">);</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span><span class="p">;</span>

    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot; SRBdone (%02x,%08x), SRB %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span>
    <span class="p">{</span>	<span class="cm">/* Last command was a Request Sense */</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AUTO_REQSENSE</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>pcmd->result = MK<em>RES(DRIVER</em>SENSE,DID_OK,0,status);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span>
	    <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES_LNX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DID_BAD_TARGET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/*CHECK_CONDITION*/</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* Retry */</span>
	<span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span> <span class="cm">/* || pSRB-&gt;pcmd-&gt;cmnd[0] == START_STOP */</span><span class="p">)</span>
	    <span class="p">{</span>
		<span class="cm">/* Don&#39;t retry on TEST_UNIT_READY */</span>
		<span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES_LNX</span><span class="p">(</span><span class="n">DRIVER_SENSE</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">);</span>
		<span class="n">REMOVABLEDEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Cmd=%02x, Result=%08x, XferL=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>\
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">));</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SET_RES_DRV</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DRIVER_SENSE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>pSRB->ScsiCmdLen     = (u8) (pSRB->Segment1[0] >> 8);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">DEBUG0</span> <span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: RETRY (%02x), target %02i-%02i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_SOFT_ERROR</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">cmd_done</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">status</span> <span class="p">)</span>
    <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">dc390_RequestSense</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cmd_done</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_TASK_SET_FULL</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="n">DEBUG0</span> <span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: RETRY (%02x), target %02i-%02i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_SOFT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_BUSY</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span> <span class="o">||</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	    <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">EndMessage</span><span class="p">,</span><span class="cm">/*status*/</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>   <span class="cm">/* Another error */</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_SOFT_ERROR</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">cmd_done</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>	<span class="cm">/*  Target status == 0 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">H_OVER_UNDER_RUN</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span><span class="n">DID_OK</span><span class="p">);</span>
	    <span class="n">SET_RES_MSG</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">EndMessage</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">H_SEL_TIMEOUT</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="cm">/* Devices are removed below ... */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBStatus</span> <span class="o">&amp;</span> <span class="n">PARITY_ERROR</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>pcmd->result = MK<em>RES(0,DID</em>PARITY,pSRB->EndMessage,0);</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span><span class="n">DID_PARITY</span><span class="p">);</span>
	    <span class="n">SET_RES_MSG</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span><span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">EndMessage</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>		       <span class="cm">/* No error */</span>
	<span class="p">{</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span><span class="n">DID_OK</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

<span class="nl">cmd_done:</span>
    <span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">pcmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">pcmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">);</span>

    <span class="n">dc390_Going_remove</span> <span class="p">(</span><span class="n">pDCB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>
    <span class="cm">/* Add to free list */</span>
    <span class="n">dc390_Free_insert</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pSRB</span><span class="p">);</span>

    <span class="n">DEBUG0</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DC390: SRBdone: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Remove all SRBs from Going list and inform midlevel */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_DoingSRB_Done</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span><span class="p">,</span> <span class="o">*</span><span class="n">pdcb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dc390_srb</span> <span class="o">*</span><span class="n">psrb</span><span class="p">,</span> <span class="o">*</span><span class="n">psrb2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>

    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span>
    <span class="n">pdcb</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">pdcb</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
	<span class="n">psrb</span> <span class="o">=</span> <span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">psrb2</span> <span class="o">=</span> <span class="n">psrb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
	    <span class="n">pcmd</span> <span class="o">=</span> <span class="n">psrb</span><span class="o">-&gt;</span><span class="n">pcmd</span><span class="p">;</span>
	    <span class="n">dc390_Free_insert</span> <span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">psrb</span><span class="p">);</span>
	    <span class="n">psrb</span>  <span class="o">=</span> <span class="n">psrb2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">pGoingSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">TagMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdcb</span> <span class="o">=</span> <span class="n">pdcb</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">pdcb</span> <span class="o">!=</span> <span class="n">pDCB</span> <span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_ResetSCSIBus</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>DC390<em>write8 (ScsiCmd, RST</em>DEVICE<em>CMD);
udelay (250);
DC390</em>write8 (ScsiCmd, NOP_CMD);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">DMA_IDLE_CMD</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">RST_SCSI_BUS_CMD</span><span class="p">);</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dc390_ScsiRstDetect</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Rst_Detect: laststat = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc390_laststatus</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>DEBUG0(printk(KERN<em>INFO "RST</em>DETECT,"));</p></td><td class="code"><div class="highlight"><pre>    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">DMA_IDLE_CMD</span><span class="p">);</span>
    <span class="cm">/* Unlock before ? */</span>
    <span class="cm">/* delay half a second */</span>
    <span class="n">udelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="n">DC390_write8</span> <span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span>
		    <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">AdapterIndex</span><span class="p">][</span><span class="n">EE_DELAY</span><span class="p">];</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">&amp;</span> <span class="n">RESET_DEV</span> <span class="p">)</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">|=</span> <span class="n">RESET_DONE</span><span class="p">;</span>
    <span class="k">else</span>
    <span class="p">{</span>   <span class="cm">/* Reset was issued by sb else */</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">|=</span> <span class="n">RESET_DETECT</span><span class="p">;</span>

	<span class="n">dc390_ResetDevParam</span><span class="p">(</span> <span class="n">pACB</span> <span class="p">);</span>
	<span class="n">dc390_DoingSRB_Done</span><span class="p">(</span> <span class="n">pACB</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>dc390_RecoverSRB( pACB );</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DC390_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">&lt;=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">device_busy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">host_busy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RESET_DETECT</span><span class="o">|</span><span class="n">RESET_DONE</span><span class="o">|</span><span class="n">RESET_DEV</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">host_busy</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">pFreeSRB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">host_busy</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">Cmds</span><span class="o">++</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">pFreeSRB</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">pSRBDCB</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">pcmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">srb</span><span class="p">;</span>
    
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SGIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">MsgCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SRBStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SRBFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SRBState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SGBusAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">EndMessage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">TagNumber</span> <span class="o">=</span> <span class="n">SCSI_NO_TAG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dc390_StartSCSI</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dc390_Free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">host_busy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc390_Going_append</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">host_busy:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

 <span class="nl">device_busy:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_DEVICE_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">DC390_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dc390_dumpinfo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dc390_srb</span><span class="o">*</span> <span class="n">pSRB</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
    <span class="n">u16</span> <span class="n">pstat</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span> <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pSRB</span> <span class="o">&amp;&amp;</span> <span class="n">pDCB</span><span class="p">)</span> <span class="n">pSRB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pActiveSRB</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pSRB</span><span class="p">)</span> 
    <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: SRB: Xferred %08lx, Remain %08lx, State %08x, Phase %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">TotalXferredLen</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SGToBeXferLen</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBState</span><span class="p">,</span>
		<span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">ScsiPhase</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: AdpaterStatus: %02x, SRB Status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">AdaptStatus</span><span class="p">,</span> <span class="n">pSRB</span><span class="o">-&gt;</span><span class="n">SRBStatus</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Status of last IRQ (DMA/SC/Int/IRQ): %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc390_laststatus</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Register dump: SCSI block:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: XferCnt  Cmd Stat IntS IRQS FFIS Ctl1 Ctl2 Ctl3 Ctl4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390:  %06x   %02x   %02x   %02x&quot;</span><span class="p">,</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtcReg_Low</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtcReg_Mid</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtcReg_High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">ScsiCmd</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">Scsi_Status</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">Intern_State</span><span class="p">));</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;   %02x   %02x   %02x   %02x   %02x   %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">INT_Status</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">Current_Fifo</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">),</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg2</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg3</span><span class="p">),</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg4</span><span class="p">));</span>
    <span class="n">DC390_write32</span> <span class="p">(</span><span class="n">DMA_ScsiBusCtrl</span><span class="p">,</span> <span class="n">WRT_ERASE_DMA_STAT</span> <span class="o">|</span> <span class="n">EN_INT_ON_PCI_ABORT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DC390_read8</span><span class="p">(</span><span class="n">Current_Fifo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: FIFO:&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">DC390_read8</span><span class="p">(</span><span class="n">Current_Fifo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="n">printk</span> <span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">ScsiFifo</span><span class="p">));</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Register dump: DMA engine:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Cmd   STrCnt    SBusA    WrkBC    WrkAC Stat SBusCtrl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390:  %02x %08x %08x %08x %08x   %02x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">),</span> <span class="n">DC390_read32</span><span class="p">(</span><span class="n">DMA_XferCnt</span><span class="p">),</span> <span class="n">DC390_read32</span><span class="p">(</span><span class="n">DMA_XferAddr</span><span class="p">),</span>
	    <span class="n">DC390_read32</span><span class="p">(</span><span class="n">DMA_Wk_ByteCntr</span><span class="p">),</span> <span class="n">DC390_read32</span><span class="p">(</span><span class="n">DMA_Wk_AddrCntr</span><span class="p">),</span>
	    <span class="n">DC390_read8</span><span class="p">(</span><span class="n">DMA_Status</span><span class="p">),</span> <span class="n">DC390_read32</span><span class="p">(</span><span class="n">DMA_ScsiBusCtrl</span><span class="p">));</span>
    <span class="n">DC390_write32</span> <span class="p">(</span><span class="n">DMA_ScsiBusCtrl</span><span class="p">,</span> <span class="n">EN_INT_ON_PCI_ABORT</span><span class="p">);</span>

    <span class="n">pdev</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
    <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstat</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: Register dump: PCI Status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstat</span><span class="p">);</span>
    <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DC390: In case of driver trouble read Documentation/scsi/tmscsim.txt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">DC390_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;DC390: Abort command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* abort() is too stupid for already sent commands at the moment. </span>
<span class="cm">	 * If it&#39;s called we are in trouble anyway, so let&#39;s dump some info </span>
<span class="cm">	 * into the syslog at least. (KG, 98/08/20,99/06/20) */</span>
	<span class="n">dc390_dumpinfo</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">pDCB</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DCBFlag</span> <span class="o">|=</span> <span class="n">ABORT_DEV_</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dc390_ResetDevParam</span><span class="p">(</span> <span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span><span class="p">,</span> <span class="o">*</span><span class="n">pdcb</span><span class="p">;</span>

    <span class="n">pDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">pDCB</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">pdcb</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYNC_NEGO_DONE</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TagMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">FAST_CLK</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">&amp;=</span> <span class="n">NEGATE_REQACKDATA</span> <span class="o">|</span> <span class="n">CTRL4_RESERVED</span> <span class="o">|</span> <span class="n">NEGATE_REQACK</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span><span class="p">;</span>
	<span class="n">pDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">pdcb</span> <span class="o">!=</span> <span class="n">pDCB</span> <span class="p">);</span>
    <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RESET_DEV</span> <span class="o">|</span> <span class="n">RESET_DONE</span> <span class="o">|</span> <span class="n">RESET_DETECT</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DC390_bus_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span>    <span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="n">bval</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">)</span> <span class="o">|</span> <span class="n">DIS_INT_ON_SCSI_RST</span><span class="p">;</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>	<span class="cm">/* disable IRQ on bus reset */</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">|=</span> <span class="n">RESET_DEV</span><span class="p">;</span>
	<span class="n">dc390_ResetSCSIBus</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>

	<span class="n">dc390_ResetDevParam</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span> 
		<span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">AdapterIndex</span><span class="p">][</span><span class="n">EE_DELAY</span><span class="p">];</span>
    
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
	<span class="n">DC390_read8</span><span class="p">(</span><span class="n">INT_Status</span><span class="p">);</span>		<span class="cm">/* Reset Pending INT */</span>

	<span class="n">dc390_DoingSRB_Done</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DIS_INT_ON_SCSI_RST</span><span class="p">;</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>	<span class="cm">/* re-enable interrupt */</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dc390_slave_alloc - Called by the scsi mid layer to tell us about a new</span>
<span class="cm"> * scsi device that we need to deal with.</span>
<span class="cm"> *</span>
<span class="cm"> * @scsi_device: The new scsi device that we need to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc390_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">)</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">pDCB</span><span class="p">,</span> <span class="o">*</span><span class="n">pDCB2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">id</span> <span class="o">=</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">pDCB</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pDCB</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">DCBCnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pDCBRunRobin</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
	<span class="p">}</span>
   
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>

	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pDCBACB</span> <span class="o">=</span> <span class="n">pACB</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">TargetLUN</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some values are for all LUNs: Copy them </span>
<span class="cm">	 * In a clean way: We would have an own structure for a SCSI-ID </span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDCB2</span> <span class="o">=</span> <span class="n">dc390_findDCB</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">DevMode</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">SyncPeriod</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">SyncOffset</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span><span class="p">;</span>
      
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">CtrlR3</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">=</span> <span class="n">pDCB2</span><span class="o">-&gt;</span><span class="n">CtrlR4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">AdapterIndex</span><span class="p">;</span>
		<span class="n">PEEprom</span> <span class="n">prom</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEEprom</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">];</span>

		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">=</span> <span class="n">prom</span><span class="o">-&gt;</span><span class="n">EE_MODE1</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">NegoPeriod</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">dc390_clock_period1</span><span class="p">[</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">EE_SPEED</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR3</span> <span class="o">=</span> <span class="n">FAST_CLK</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span> <span class="o">|</span> <span class="n">CTRL4_RESERVED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">EE_MODE2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ACTIVE_NEGATION</span><span class="p">)</span>
			<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR4</span> <span class="o">|=</span> <span class="n">NEGATE_REQACKDATA</span> <span class="o">|</span> <span class="n">NEGATE_REQACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_</span><span class="p">)</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">|=</span> <span class="n">SYNC_ENABLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">SyncOffset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR1</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">&amp;</span> <span class="n">PARITY_CHK_</span><span class="p">)</span>
		<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">CtrlR1</span> <span class="o">|=</span> <span class="n">PARITY_ERR_REPO</span><span class="p">;</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">pDCB</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dc390_slave_destroy - Called by the scsi mid layer to tell us about a</span>
<span class="cm"> * device that is going away.</span>
<span class="cm"> *</span>
<span class="cm"> * @scsi_device: The scsi device that we need to remove.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dc390_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">)</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pDCB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span><span class="p">)</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span><span class="o">*</span> <span class="n">pPrevDCB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">;</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">GoingSRBCnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span> <span class="o">==</span> <span class="n">pDCB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pPrevDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span> <span class="o">!=</span> <span class="n">pDCB</span><span class="p">)</span>
			<span class="n">pPrevDCB</span> <span class="o">=</span> <span class="n">pPrevDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
		<span class="n">pPrevDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span><span class="p">)</span>
			<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLastDCB</span> <span class="o">=</span> <span class="n">pPrevDCB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span><span class="p">)</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pActiveDCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span><span class="p">)</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pLinkDCB</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pDCB</span> <span class="o">==</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pDCBRunRobin</span><span class="p">)</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pDCBRunRobin</span> <span class="o">=</span> <span class="n">pDCB</span><span class="o">-&gt;</span><span class="n">pNextDCB</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pDCB</span><span class="p">);</span> 
	
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">DCBCnt</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc390_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_dcb</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">DevMode</span> <span class="o">&amp;</span> <span class="n">TAG_QUEUEING_</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">SyncMode</span> <span class="o">|=</span> <span class="n">EN_TAG_QUEUEING</span><span class="p">;</span>
		<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">TagMaxNum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;tmscsim&quot;</span><span class="p">,</span> 
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DC390_BANNER</span> <span class="s">&quot; V&quot;</span> <span class="n">DC390_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">dc390_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">dc390_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>		<span class="o">=</span> <span class="n">dc390_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">DC390_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">DC390_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">DC390_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="cm">/* 8MiB = 16 * 1024 * 512 */</span>
<span class="p">};</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Functions for access to DC390 EEPROM</span>
<span class="cm"> * and some to emulate it</span>
<span class="cm"> *</span>
<span class="cm"> **********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_eeprom_prepare_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">carryFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">bval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">carryFlag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">bval</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bval</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>

		<span class="n">carryFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">j</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">__devinit</span> <span class="nf">dc390_eeprom_get_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wval</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bval</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">==</span> <span class="mh">0x22</span><span class="p">)</span>
			<span class="n">wval</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">wval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">EEPROM_READ</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>

		<span class="n">dc390_eeprom_prepare_read</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">++</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dc390_eeprom_get_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">160</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Override EEprom values with explicitly set values */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_eeprom_override</span><span class="p">(</span><span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Adapter Settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">ptr</span><span class="p">[</span><span class="n">EE_ADAPT_SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* Adapter ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">ptr</span><span class="p">[</span><span class="n">EE_MODE2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">ptr</span><span class="p">[</span><span class="n">EE_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>		<span class="cm">/* Reset delay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">ptr</span><span class="p">[</span><span class="n">EE_TAG_CMD_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Tagged Cmds */</span>

	<span class="cm">/* Device Settings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_ID</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">ptr</span><span class="p">[</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* EE_MODE1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">ptr</span><span class="p">[(</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* EE_Speed */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinitdata</span> <span class="n">tmscsim_def</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span>
	<span class="mi">0</span> <span class="cm">/* 10MHz */</span><span class="p">,</span>
	<span class="n">PARITY_CHK_</span> <span class="o">|</span> <span class="n">SEND_START_</span> <span class="o">|</span> <span class="n">EN_DISCONNECT_</span> <span class="o">|</span> <span class="n">SYNC_NEGO_</span> <span class="o">|</span> <span class="n">TAG_QUEUEING_</span><span class="p">,</span>
	<span class="n">MORE2_DRV</span> <span class="o">|</span> <span class="n">GREATER_1G</span> <span class="o">|</span> <span class="n">RST_SCSI_BUS</span> <span class="o">|</span> <span class="n">ACTIVE_NEGATION</span> <span class="o">|</span> <span class="n">LUN_CHECK</span><span class="p">,</span>
	<span class="mi">3</span> <span class="cm">/* 16 Tags per LUN */</span><span class="p">,</span>
	<span class="mi">1</span> <span class="cm">/* s delay after Reset */</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Copy defaults over set values where missing */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_fill_with_defaults</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tmscsim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">tmscsim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmscsim_def</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_check_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">interpd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">EEbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">EEbuf</span><span class="p">,</span> <span class="n">wval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dc390_read_eeprom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">EEbuf</span><span class="p">,</span> <span class="n">EE_ADAPT_SCSI_ID</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">EE_ADAPT_SCSI_ID</span><span class="p">],</span> 
	       <span class="o">&amp;</span><span class="n">EEbuf</span><span class="p">[</span><span class="n">REAL_EE_ADAPT_SCSI_ID</span><span class="p">],</span> <span class="n">EE_LEN</span> <span class="o">-</span> <span class="n">EE_ADAPT_SCSI_ID</span><span class="p">);</span>

	<span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">EE_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpd</span><span class="p">[</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">EE_DELAY</span><span class="p">]];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wval</span> <span class="o">+=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* no Tekram EEprom found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wval</span> <span class="o">!=</span> <span class="mh">0x1234</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390_init: No EEPROM found! Trying default settings ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * XXX(hch): bogus, because we might have tekram and</span>
<span class="cm">		 *           non-tekram hbas in a single machine.</span>
<span class="cm">		 */</span>
		<span class="n">dc390_fill_with_defaults</span><span class="p">();</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="n">dc390_clock_speed</span><span class="p">[</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Used defaults: AdaptID=%i, SpeedIdx=%i (%i.%i MHz), &quot;</span>
		       <span class="s">&quot;DevMode=0x%02x, AdaptMode=0x%02x, TaggedCmnds=%i (%i), DelayReset=%is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">speed</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">speed</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dc390_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">pACB</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dstate</span><span class="p">;</span>

	<span class="cm">/* Disable SCSI bus reset interrupt */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">DIS_INT_ON_SCSI_RST</span> <span class="o">|</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Gmode2</span> <span class="o">&amp;</span> <span class="n">RST_SCSI_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dc390_ResetSCSIBus</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span>
			<span class="n">HZ</span> <span class="o">*</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">AdapterIndex</span><span class="p">][</span><span class="n">EE_DELAY</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset Pending INT */</span>
	<span class="n">DC390_read8</span><span class="p">(</span><span class="n">INT_Status</span><span class="p">);</span>
	
	<span class="cm">/* 250ms selection timeout */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">Scsi_TimeOut</span><span class="p">,</span> <span class="n">SEL_TIMEOUT</span><span class="p">);</span>
	
	<span class="cm">/* Conversion factor = 0 , 40MHz clock */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">Clk_Factor</span><span class="p">,</span> <span class="n">CLK_FREQ_40MHZ</span><span class="p">);</span>
	
	<span class="cm">/* NOP cmd - clear command register */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">NOP_CMD</span><span class="p">);</span>
	
	<span class="cm">/* Enable Feature and SCSI-2 */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg2</span><span class="p">,</span> <span class="n">EN_FEATURE</span><span class="o">+</span><span class="n">EN_SCSI2_CMD</span><span class="p">);</span>
	
	<span class="cm">/* Fast clock */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg3</span><span class="p">,</span> <span class="n">FAST_CLK</span><span class="p">);</span>

	<span class="cm">/* Negation */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtrlReg4</span><span class="p">,</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span> <span class="o">|</span> <span class="cm">/* glitch eater */</span>
		<span class="p">(</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">EE_MODE2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ACTIVE_NEGATION</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">NEGATE_REQACKDATA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="cm">/* Clear Transfer Count High: ID */</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">CtcReg_High</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">DMA_Cmd</span><span class="p">,</span> <span class="n">DMA_IDLE_CMD</span><span class="p">);</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">ScsiCmd</span><span class="p">,</span> <span class="n">CLEAR_FIFO_CMD</span><span class="p">);</span>
	<span class="n">DC390_write32</span><span class="p">(</span><span class="n">DMA_ScsiBusCtrl</span><span class="p">,</span> <span class="n">EN_INT_ON_PCI_ABORT</span><span class="p">);</span>

	<span class="n">dstate</span> <span class="o">=</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">DMA_Status</span><span class="p">);</span>
	<span class="n">DC390_write8</span><span class="p">(</span><span class="n">DMA_Status</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dc390_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="n">pACB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_clustering</span><span class="p">)</span>
		<span class="n">driver_template</span><span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>

	<span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="p">));</span>

	<span class="n">dc390_check_eeprom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dc390_adapterCnt</span><span class="p">);</span>
	<span class="n">dc390_eeprom_override</span><span class="p">(</span><span class="n">dc390_adapterCnt</span><span class="p">);</span>

	<span class="n">io_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">dc390_adapterCnt</span><span class="p">][</span><span class="n">EE_ADAPT_SCSI_ID</span><span class="p">];</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pScsiHost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">IOPortBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">IRQLevel</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span>
	    <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">dc390_adapterCnt</span><span class="p">][</span><span class="n">EE_ADAPT_SCSI_ID</span><span class="p">])</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">dc390_adapterCnt</span><span class="p">][</span><span class="n">EE_MODE2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LUN_CHECK</span><span class="p">)</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pFreeSRB</span> <span class="o">=</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRB_array</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRBCount</span> <span class="o">=</span> <span class="n">MAX_SRB_CNT</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">AdapterIndex</span> <span class="o">=</span> <span class="n">dc390_adapterCnt</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">TagMaxNum</span> <span class="o">=</span>
		<span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">dc390_adapterCnt</span><span class="p">][</span><span class="n">EE_TAG_CMD_NUM</span><span class="p">];</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Gmode2</span> <span class="o">=</span> <span class="n">dc390_eepromBuf</span><span class="p">[</span><span class="n">dc390_adapterCnt</span><span class="p">][</span><span class="n">EE_MODE2</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRBCount</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRB_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRB_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRB_array</span><span class="p">[</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">SRBCount</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">pNextSRB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pTmpSRB</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">TmpSRB</span><span class="p">;</span>

	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">sel_timeout</span> <span class="o">=</span> <span class="n">SEL_TIMEOUT</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">glitch_cfg</span> <span class="o">=</span> <span class="n">EATER_25NS</span><span class="p">;</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">,</span> <span class="s">&quot;tmscsim&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: register IO ports error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset Pending INT */</span>
	<span class="n">DC390_read8_</span><span class="p">(</span><span class="n">INT_Status</span><span class="p">,</span> <span class="n">io_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">do_DC390_Interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;tmscsim&quot;</span><span class="p">,</span> <span class="n">pACB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DC390: register IRQ error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dc390_init_hw</span><span class="p">(</span><span class="n">pACB</span><span class="p">,</span> <span class="n">dc390_adapterCnt</span><span class="p">);</span>
	
	<span class="n">dc390_adapterCnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pACB</span><span class="p">);</span>
 <span class="nl">out_release_region:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>
 <span class="nl">out_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
 <span class="nl">out_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dc390_remove_one - Called to remove a single instance of the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * @dev: The PCI device to remove.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">dc390_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span> <span class="n">pACB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dc390_acb</span><span class="o">*</span><span class="p">)</span> <span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">pACB</span><span class="o">-&gt;</span><span class="n">ACBFlag</span> <span class="o">=</span> <span class="n">RESET_DEV</span><span class="p">;</span>
	<span class="n">bval</span> <span class="o">=</span> <span class="n">DC390_read8</span><span class="p">(</span><span class="n">CtrlReg1</span><span class="p">)</span> <span class="o">|</span> <span class="n">DIS_INT_ON_SCSI_RST</span><span class="p">;</span>
	<span class="n">DC390_write8</span> <span class="p">(</span><span class="n">CtrlReg1</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>	<span class="cm">/* disable interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pACB</span><span class="o">-&gt;</span><span class="n">Gmode2</span> <span class="o">&amp;</span> <span class="n">RST_SCSI_BUS</span><span class="p">)</span>
		<span class="n">dc390_ResetSCSIBus</span><span class="p">(</span><span class="n">pACB</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pACB</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">tmscsim_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMD53C974</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tmscsim_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">dc390_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;tmscsim&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">tmscsim_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">dc390_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dc390_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dc390_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_clustering</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: clustering now enabled by default. If you get problems load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;       with </span><span class="se">\&quot;</span><span class="s">disable_clustering=1</span><span class="se">\&quot;</span><span class="s"> and report to maintainers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARITY_CHK_</span> <span class="o">|</span> <span class="n">TAG_QUEUEING_</span><span class="p">;</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MORE2_DRV</span> <span class="o">|</span> <span class="n">GREATER_1G</span> <span class="o">|</span> <span class="n">RST_SCSI_BUS</span> <span class="o">|</span> <span class="n">ACTIVE_NEGATION</span><span class="p">;</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DC390: Using safe settings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc390_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dc390_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc390_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dc390_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dc390_module_exit</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dc390_setup</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">i</span><span class="p">,</span> <span class="n">im</span><span class="p">;</span>

	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">im</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;DC390: ignore extra params!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">im</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">im</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmscsim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/* dc390_checkparams (); */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;tmscsim=&quot;</span><span class="p">,</span> <span class="n">dc390_setup</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
