<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › mpt2sas › mpt2sas_scsih.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpt2sas_scsih.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Scsi Host Layer for MPT (Message Passing Technology) based controllers</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on drivers/scsi/mpt2sas/mpt2_scsih.c</span>
<span class="cm"> * Copyright (C) 2007-2010  LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm"> * CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm"> * LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm"> * solely responsible for determining the appropriateness of using and</span>
<span class="cm"> * distributing the Program and assumes all risks associated with its</span>
<span class="cm"> * exercise of rights under this Agreement, including but not limited to</span>
<span class="cm"> * the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm"> * programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm"> * DISCLAIMER OF LIABILITY</span>
<span class="cm"> * NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm"> * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm"> * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm"> * USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm"> * HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,</span>
<span class="cm"> * USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;linux/raid_class.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;mpt2sas_base.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MPT2SAS_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">MPT2SAS_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MPT2SAS_DRIVER_VERSION</span><span class="p">);</span>

<span class="cp">#define RAID_CHANNEL 1</span>

<span class="cm">/* forward proto&#39;s */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_scsih_expander_node_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">_firmware_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">_scsih_check_for_pending_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">_scsih_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_scsih_scan_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">);</span>

<span class="cm">/* global parameters */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mpt2sas_ioc_list</span><span class="p">);</span>

<span class="cm">/* local parameters */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">scsi_io_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ctl_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">base_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">port_enable_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">transport_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">scsih_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">config_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_ids</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_tr_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_tr_volume_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">tm_sas_control_cb_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* command line options */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">logging_level</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">logging_level</span><span class="p">,</span> <span class="s">&quot; bits for enabling additional logging info &quot;</span>
    <span class="s">&quot;(default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="n">max_sectors</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_sectors</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_sectors</span><span class="p">,</span> <span class="s">&quot;max sectors, range 64 to 32767  default=32767&quot;</span><span class="p">);</span>

<span class="cm">/* scsi-mid layer global parmeter is max_report_luns, which is 511 */</span>
<span class="cp">#define MPT2SAS_MAX_LUN (16895)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_lun</span> <span class="o">=</span> <span class="n">MPT2SAS_MAX_LUN</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="s">&quot; max lun, default=16895 &quot;</span><span class="p">);</span>

<span class="cm">/* diag_buffer_enable is bitwise</span>
<span class="cm"> * bit 0 set = TRACE</span>
<span class="cm"> * bit 1 set = SNAPSHOT</span>
<span class="cm"> * bit 2 set = EXTENDED</span>
<span class="cm"> *</span>
<span class="cm"> * Either bit can be set, or both</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">diag_buffer_enable</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">diag_buffer_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">diag_buffer_enable</span><span class="p">,</span> <span class="s">&quot; post diag buffers &quot;</span>
	<span class="s">&quot;(TRACE=1/SNAPSHOT=2/EXTENDED=4/default=0)&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * struct sense_info - common structure for obtaining sense keys</span>
<span class="cm"> * @skey: sense key</span>
<span class="cm"> * @asc: additional sense code</span>
<span class="cm"> * @ascq: additional sense code qualifier</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sense_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">skey</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">asc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ascq</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define MPT2SAS_TURN_ON_FAULT_LED (0xFFFC)</span>
<span class="cp">#define MPT2SAS_PORT_ENABLE_COMPLETE (0xFFFD)</span>
<span class="cp">#define MPT2SAS_REMOVE_UNRESPONDING_DEVICES (0xFFFF)</span>
<span class="cm">/**</span>
<span class="cm"> * struct fw_event_work - firmware event struct</span>
<span class="cm"> * @list: link list framework</span>
<span class="cm"> * @work: work object (ioc-&gt;fault_reset_work_q)</span>
<span class="cm"> * @cancel_pending_work: flag set during reset handling</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @device_handle: device handle</span>
<span class="cm"> * @VF_ID: virtual function id</span>
<span class="cm"> * @VP_ID: virtual port id</span>
<span class="cm"> * @ignore: flag meaning this event has been marked to ignore</span>
<span class="cm"> * @event: firmware event MPI2_EVENT_XXX defined in mpt2_ioc.h</span>
<span class="cm"> * @event_data: reply event data payload follows</span>
<span class="cm"> *</span>
<span class="cm"> * This object stored on ioc-&gt;fw_event_list.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> 	<span class="n">list</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">cancel_pending_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">delayed_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">device_handle</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">VF_ID</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">VP_ID</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ignore</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">event</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">event_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* raid transport support */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">raid_template</span> <span class="o">*</span><span class="n">mpt2sas_raid_template</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * struct _scsi_io_transfer - scsi io transfer</span>
<span class="cm"> * @handle: sas device handle (assigned by firmware)</span>
<span class="cm"> * @is_raid: flag set for hidden raid components</span>
<span class="cm"> * @dir: DMA_TO_DEVICE, DMA_FROM_DEVICE,</span>
<span class="cm"> * @data_length: data transfer length</span>
<span class="cm"> * @data_dma: dma pointer to data</span>
<span class="cm"> * @sense: sense data</span>
<span class="cm"> * @lun: lun number</span>
<span class="cm"> * @cdb_length: cdb length</span>
<span class="cm"> * @cdb: cdb contents</span>
<span class="cm"> * @timeout: timeout for this command</span>
<span class="cm"> * @VF_ID: virtual function id</span>
<span class="cm"> * @VP_ID: virtual port id</span>
<span class="cm"> * @valid_reply: flag set for reply message</span>
<span class="cm"> * @sense_length: sense length</span>
<span class="cm"> * @ioc_status: ioc status</span>
<span class="cm"> * @scsi_state: scsi state</span>
<span class="cm"> * @scsi_status: scsi staus</span>
<span class="cm"> * @log_info: log information</span>
<span class="cm"> * @transfer_length: data length transfer when there is a reply message</span>
<span class="cm"> *</span>
<span class="cm"> * Used for sending internal scsi commands to devices within this module.</span>
<span class="cm"> * Refer to _scsi_send_scsi_io().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">_scsi_io_transfer</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">is_raid</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">data_length</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_dma</span><span class="p">;</span>
	<span class="n">u8</span> 	<span class="n">sense</span><span class="p">[</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">lun</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">cdb_length</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">cdb</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">timeout</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">VF_ID</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">VP_ID</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">valid_reply</span><span class="p">;</span>
  <span class="cm">/* the following bits are only valid when &#39;valid_reply = 1&#39; */</span>
	<span class="n">u32</span>	<span class="n">sense_length</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">scsi_state</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">log_info</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">transfer_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The pci device ids are defined in mpi/mpi2_cnfg.h.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">scsih_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2004</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* Falcon ~ 2008*/</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2008</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* Liberator ~ 2108 */</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_1</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_2</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_3</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* Meteor ~ 2116 */</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2116_1</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2116_2</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* Thunderbolt ~ 2208 */</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_1</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_2</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_3</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_4</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_5</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2208_6</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* Mustang ~ 2308 */</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2308_1</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2308_2</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2308_3</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="cm">/* SSS6200 */</span>
	<span class="p">{</span> <span class="n">MPI2_MFGPAGE_VENDORID_LSI</span><span class="p">,</span> <span class="n">MPI2_MFGPAGE_DEVID_SSS6200</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">scsih_pci_table</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_set_debug_level - global setting of ioc-&gt;logging_level.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The logging levels are defined in mpt2sas_debug.h.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_set_debug_level</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_set_int</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;setting logging_level(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">logging_level</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">logging_level</span><span class="p">,</span> <span class="n">_scsih_set_debug_level</span><span class="p">,</span> <span class="n">param_get_int</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">logging_level</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_srch_boot_sas_address - search based on sas_address</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * @boot_device: boot device object from bios page 2</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when there&#39;s a match, 0 means no match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">_scsih_srch_boot_sas_address</span><span class="p">(</span><span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span>
    <span class="n">Mpi2BootDeviceSasWwid_t</span> <span class="o">*</span><span class="n">boot_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">boot_device</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">))</span> <span class="o">?</span>  <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_srch_boot_device_name - search based on device name</span>
<span class="cm"> * @device_name: device name specified in INDENTIFY fram</span>
<span class="cm"> * @boot_device: boot device object from bios page 2</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when there&#39;s a match, 0 means no match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">_scsih_srch_boot_device_name</span><span class="p">(</span><span class="n">u64</span> <span class="n">device_name</span><span class="p">,</span>
    <span class="n">Mpi2BootDeviceDeviceName_t</span> <span class="o">*</span><span class="n">boot_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">device_name</span> <span class="o">==</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">boot_device</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_srch_boot_encl_slot - search based on enclosure_logical_id/slot</span>
<span class="cm"> * @enclosure_logical_id: enclosure logical id</span>
<span class="cm"> * @slot_number: slot number</span>
<span class="cm"> * @boot_device: boot device object from bios page 2</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when there&#39;s a match, 0 means no match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">_scsih_srch_boot_encl_slot</span><span class="p">(</span><span class="n">u64</span> <span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">slot_number</span><span class="p">,</span>
    <span class="n">Mpi2BootDeviceEnclosureSlot_t</span> <span class="o">*</span><span class="n">boot_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">enclosure_logical_id</span> <span class="o">==</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">boot_device</span><span class="o">-&gt;</span>
	    <span class="n">EnclosureLogicalID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">slot_number</span> <span class="o">==</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">boot_device</span><span class="o">-&gt;</span>
	    <span class="n">SlotNumber</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_is_boot_device - search for matching boot device.</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * @device_name: device name specified in INDENTIFY fram</span>
<span class="cm"> * @enclosure_logical_id: enclosure logical id</span>
<span class="cm"> * @slot_number: slot number</span>
<span class="cm"> * @form: specifies boot device form</span>
<span class="cm"> * @boot_device: boot device object from bios page 2</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when there&#39;s a match, 0 means no match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_is_boot_device</span><span class="p">(</span><span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">u64</span> <span class="n">device_name</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">form</span><span class="p">,</span>
    <span class="n">Mpi2BiosPage2BootDevice_t</span> <span class="o">*</span><span class="n">boot_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_BIOSPAGE2_FORM_SAS_WWID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_address</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">_scsih_srch_boot_sas_address</span><span class="p">(</span>
		    <span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">boot_device</span><span class="o">-&gt;</span><span class="n">SasWwid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_BIOSPAGE2_FORM_ENCLOSURE_SLOT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enclosure_logical_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">_scsih_srch_boot_encl_slot</span><span class="p">(</span>
		    <span class="n">enclosure_logical_id</span><span class="p">,</span>
		    <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">boot_device</span><span class="o">-&gt;</span><span class="n">EnclosureSlot</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_BIOSPAGE2_FORM_DEVICE_NAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_name</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">_scsih_srch_boot_device_name</span><span class="p">(</span>
		    <span class="n">device_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">boot_device</span><span class="o">-&gt;</span><span class="n">DeviceName</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_BIOSPAGE2_FORM_NO_DEVICE_SPECIFIED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_get_sas_address - set the sas_address for given device handle</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, non-zero when failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_get_sas_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span>
    <span class="n">u64</span> <span class="o">*</span><span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">sas_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&lt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we hit this becuase the given parent handle doesn&#39;t exist */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="cm">/* else error case */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;handle(0x%04x), ioc_status(0x%04x), &quot;</span>
	    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span>
	     <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_determine_boot_device - determine boot device.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @device: either sas_device or raid_device object</span>
<span class="cm"> * @is_raid: [flag] 1 = raid object, 0 = sas object</span>
<span class="cm"> *</span>
<span class="cm"> * Determines whether this device should be first reported device to</span>
<span class="cm"> * to scsi-ml or sas transport, this purpose is for persistent boot device.</span>
<span class="cm"> * There are primary, alternate, and current entries in bios page 2. The order</span>
<span class="cm"> * priority is primary, alternate, then current.  This routine saves</span>
<span class="cm"> * the corresponding device object and is_raid flag in the ioc object.</span>
<span class="cm"> * The saved data to be used later in _scsih_probe_boot_devices().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_determine_boot_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_raid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">device_name</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">enclosure_logical_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">slot</span><span class="p">;</span>

	 <span class="cm">/* only process this function when driver loads */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	 <span class="cm">/* no Bios, return immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg3</span><span class="p">.</span><span class="n">BiosVersion</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_raid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">device_name</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">;</span>
		<span class="n">enclosure_logical_id</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">;</span>
		<span class="n">device_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">enclosure_logical_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_is_boot_device</span><span class="p">(</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span>
		    <span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">ReqBootDeviceForm</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">RequestedBootDevice</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
			   <span class="s">&quot;%s: req_boot_device(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">is_raid</span> <span class="o">=</span> <span class="n">is_raid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_is_boot_device</span><span class="p">(</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span>
		    <span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">ReqAltBootDeviceForm</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">RequestedAltBootDevice</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
			   <span class="s">&quot;%s: req_alt_boot_device(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">is_raid</span> <span class="o">=</span> <span class="n">is_raid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_is_boot_device</span><span class="p">(</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span>
		    <span class="n">enclosure_logical_id</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">CurrentBootDeviceForm</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">CurrentBootDevice</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
			   <span class="s">&quot;%s: current_boot_device(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">is_raid</span> <span class="o">=</span> <span class="n">is_raid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_sas_device_find_by_sas_address - sas device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for sas_device based on sas_address, then return sas_device</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span>
<span class="nf">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sas_device</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_init_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sas_device</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_find_by_handle - sas device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: sas device handle (assigned by firmware)</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for sas_device based on sas_address, then return sas_device</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span>
<span class="nf">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sas_device</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_init_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sas_device</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_remove - remove sas_device from list.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_device: the sas_device object</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_device_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Removing object and freeing associated memory from the ioc-&gt;sas_device_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_device</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_add - insert sas_device to the list.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_device: the sas_device object</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_device_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Adding new object to the ioc-&gt;sas_device_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: handle&quot;</span>
	    <span class="s">&quot;(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_transport_port_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	     <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_scsih_sas_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* When asyn scanning is enabled, its not possible to remove</span>
<span class="cm">		 * devices while scanning is turned on due to an oops in</span>
<span class="cm">		 * scsi_sysfs_add_sdev()-&gt;add_device()-&gt;sysfs_addrm_start()</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
			<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">);</span>
		<span class="n">_scsih_sas_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_init_add - insert sas_device to the list.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_device: the sas_device object</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_device_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Adding new object at driver load time to the ioc-&gt;sas_device_init_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_device_init_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: handle&quot;</span>
	    <span class="s">&quot;(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_init_list</span><span class="p">);</span>
	<span class="n">_scsih_determine_boot_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_raid_device_find_by_id - raid device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @id: sas device target id</span>
<span class="cm"> * @channel: sas device channel</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;raid_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for raid_device based on target id, then return raid_device</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span>
<span class="nf">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">raid_device</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_raid_device_find_by_handle - raid device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: sas device handle (assigned by firmware)</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;raid_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for raid_device based on handle, then return raid_device</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span>
<span class="nf">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">raid_device</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_raid_device_find_by_wwid - raid device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: sas device handle (assigned by firmware)</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;raid_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for raid_device based on wwid, then return raid_device</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span>
<span class="nf">_scsih_raid_device_find_by_wwid</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">wwid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span> <span class="o">!=</span> <span class="n">wwid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">raid_device</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_raid_device_add - add raid_device object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @raid_device: raid_device object</span>
<span class="cm"> *</span>
<span class="cm"> * This is added to the raid_device_list link list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_raid_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: handle&quot;</span>
	    <span class="s">&quot;(0x%04x), wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_raid_device_remove - delete raid_device object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @raid_device: raid_device object</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_raid_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">raid_device</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_expander_find_by_handle - expander device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: expander handle (assigned by firmware)</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_device_lock</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for expander device based on handle, then returns the</span>
<span class="cm"> * sas_node object.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span>
<span class="nf">mpt2sas_scsih_expander_find_by_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">sas_expander</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_expander_find_by_sas_address - expander device search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This searches for expander device based on sas_address, then returns the</span>
<span class="cm"> * sas_node object.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span>
<span class="nf">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">sas_expander</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_expander_node_add - insert expander device to the list.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_expander: the sas_device object</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Adding new object to the ioc-&gt;sas_expander_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_expander_node_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_is_end_device - determines if device is an end device</span>
<span class="cm"> * @device_info: bitfield providing information about the device.</span>
<span class="cm"> * Context: none</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if end device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_is_end_device</span><span class="p">(</span><span class="n">u32</span> <span class="n">device_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_END_DEVICE</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_lookup_get - returns scmd entry</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the smid stored scmd pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span>
<span class="nf">_scsih_scsi_lookup_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">scmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_lookup_get_clear - returns scmd entry</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the smid stored scmd pointer.</span>
<span class="cm"> * Then will derefrence the stored scmd pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span>
<span class="nf">_scsih_scsi_lookup_get_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scmd</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">scmd</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">scmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_lookup_find_by_scmd - scmd lookup</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;scsi_lookup_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This will search for a scmd pointer in the scsi_lookup array,</span>
<span class="cm"> * returning the revelent smid.  A returned value of zero means invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">_scsih_scsi_lookup_find_by_scmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span>
    <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span> <span class="o">==</span> <span class="n">scmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">smid</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_lookup_find_by_target - search for matching channel:id</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @id: target id</span>
<span class="cm"> * @channel: channel</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;scsi_lookup_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This will search for a matching channel:id in the scsi_lookup array,</span>
<span class="cm"> * returning 1 if found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_scsi_lookup_find_by_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_lookup_find_by_lun - search for matching channel:id:lun</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @id: target id</span>
<span class="cm"> * @lun: lun number</span>
<span class="cm"> * @channel: channel</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;scsi_lookup_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This will search for a matching channel:id:lun in the scsi_lookup array,</span>
<span class="cm"> * returning 1 if found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_scsi_lookup_find_by_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_get_chain_buffer_tracker - obtain chain tracker</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: smid associated to an IO request</span>
<span class="cm"> *</span>
<span class="cm"> * Returns chain tracker(from ioc-&gt;free_chain_list)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">chain_tracker</span> <span class="o">*</span>
<span class="nf">_scsih_get_chain_buffer_tracker</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chain_tracker</span> <span class="o">*</span><span class="n">chain_req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_chain_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;chain buffers not &quot;</span>
			<span class="s">&quot;available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chain_req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_chain_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">chain_tracker</span><span class="p">,</span> <span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">chain_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chain_req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_build_scatter_gather - main sg creation routine</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @scmd: scsi command</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * Context: none.</span>
<span class="cm"> *</span>
<span class="cm"> * The main routine that builds scatter gather table from a given</span>
<span class="cm"> * scsi request sent via the .queuecommand main handler.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_build_scatter_gather</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SCSIIORequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">chain_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_scmd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sg_local</span><span class="p">,</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chain_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chain_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chain_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sges_left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sges_in_segment</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags_last_element</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags_end_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chain_tracker</span> <span class="o">*</span><span class="n">chain_req</span><span class="p">;</span>

	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>

	<span class="cm">/* init scatter gather flags */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">sgl_flags</span> <span class="o">|=</span> <span class="n">MPI2_SGE_FLAGS_HOST_TO_IOC</span><span class="p">;</span>
	<span class="n">sgl_flags_last_element</span> <span class="o">=</span> <span class="p">(</span><span class="n">sgl_flags</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span><span class="p">)</span>
	    <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">sgl_flags_end_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">sgl_flags</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span><span class="p">)</span>
	    <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>

	<span class="n">sg_scmd</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="n">sges_left</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;pci_map_sg&quot;</span>
		<span class="s">&quot; failed: request for %d bytes!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_local</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>
	<span class="n">sges_in_segment</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_main_message</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">&lt;=</span> <span class="n">sges_in_segment</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fill_in_last_segment</span><span class="p">;</span>

	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SCSIIORequest_t</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">sges_in_segment</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* fill in main message segment when there is a chain following */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sges_in_segment</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sges_in_segment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span>
			    <span class="n">sgl_flags_last_element</span> <span class="o">|</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span>
			    <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
			    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
		<span class="n">sg_scmd</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">);</span>
		<span class="n">sg_local</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="n">sges_left</span><span class="o">--</span><span class="p">;</span>
		<span class="n">sges_in_segment</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initializing the chain flags and pointers */</span>
	<span class="n">chain_flags</span> <span class="o">=</span> <span class="n">MPI2_SGE_FLAGS_CHAIN_ELEMENT</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">chain_req</span> <span class="o">=</span> <span class="n">_scsih_get_chain_buffer_tracker</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chain_req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chain</span> <span class="o">=</span> <span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">chain_buffer</span><span class="p">;</span>
	<span class="n">chain_dma</span> <span class="o">=</span> <span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">chain_buffer_dma</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sges_in_segment</span> <span class="o">=</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">&lt;=</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span><span class="p">)</span> <span class="o">?</span> <span class="n">sges_left</span> <span class="o">:</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span><span class="p">;</span>
		<span class="n">chain_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">==</span> <span class="n">sges_in_segment</span><span class="p">)</span> <span class="o">?</span>
		    <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">sges_in_segment</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">chain_length</span> <span class="o">=</span> <span class="n">sges_in_segment</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chain_offset</span> <span class="o">=</span> <span class="n">chain_offset</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MPI2_SGE_CHAIN_OFFSET_SHIFT</span><span class="p">;</span>
			<span class="n">chain_length</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span> <span class="n">chain_flags</span> <span class="o">|</span> <span class="n">chain_offset</span> <span class="o">|</span>
		    <span class="n">chain_length</span><span class="p">,</span> <span class="n">chain_dma</span><span class="p">);</span>
		<span class="n">sg_local</span> <span class="o">=</span> <span class="n">chain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chain_offset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fill_in_last_segment</span><span class="p">;</span>

		<span class="cm">/* fill in chain segments */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sges_in_segment</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sges_in_segment</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span>
				    <span class="n">sgl_flags_last_element</span> <span class="o">|</span>
				    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span>
				    <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
				    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span>
				    <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
			<span class="n">sg_scmd</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">);</span>
			<span class="n">sg_local</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
			<span class="n">sges_left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">sges_in_segment</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chain_req</span> <span class="o">=</span> <span class="n">_scsih_get_chain_buffer_tracker</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chain_req</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">chain_buffer</span><span class="p">;</span>
		<span class="n">chain_dma</span> <span class="o">=</span> <span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">chain_buffer_dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>


 <span class="nl">fill_in_last_segment:</span>

	<span class="cm">/* fill the last segment */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sges_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span> <span class="n">sgl_flags_end_buffer</span> <span class="o">|</span>
			    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">sg_local</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
			    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">),</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">));</span>
		<span class="n">sg_scmd</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg_scmd</span><span class="p">);</span>
		<span class="n">sg_local</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="n">sges_left</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_adjust_queue_depth - setting device queue depth</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @qdepth: requested queue depth</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_adjust_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_depth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">max_depth</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span>

	<span class="cm">/* limit max device queue for SATA to 32 */</span>
	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_sata</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_target_priv_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_sata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">not_sata</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	   <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
		<span class="n">max_depth</span> <span class="o">=</span> <span class="n">MPT2SAS_SATA_QUEUE_DEPTH</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

 <span class="nl">not_sata:</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="n">max_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdepth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">)</span>
		<span class="n">qdepth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">;</span>
	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">qdepth</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_change_queue_depth - setting device queue depth</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @qdepth: requested queue depth</span>
<span class="cm"> * @reason: SCSI_QDEPTH_DEFAULT/SCSI_QDEPTH_QFULL/SCSI_QDEPTH_RAMP_UP</span>
<span class="cm"> * (see include/scsi/scsi_host.h for definition)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns queue depth.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">SCSI_QDEPTH_DEFAULT</span> <span class="o">||</span> <span class="n">reason</span> <span class="o">==</span> <span class="n">SCSI_QDEPTH_RAMP_UP</span><span class="p">)</span>
		<span class="n">_scsih_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">SCSI_QDEPTH_QFULL</span><span class="p">)</span>
		<span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry_len</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;qdepth(%d), tagged(%d), &quot;</span>
		<span class="s">&quot;simple(%d), ordered(%d), scsi_level(%d), cmd_que(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_level</span><span class="p">,</span>
		<span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_change_queue_type - changing device queue tag type</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @tag_type: requested tag type</span>
<span class="cm"> *</span>
<span class="cm"> * Returns queue tag type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_type</span><span class="p">)</span>
			<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tag_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_target_alloc - target add routine</span>
<span class="cm"> * @starget: scsi target struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if ok. Any other return is assumed to be an error and</span>
<span class="cm"> * the device is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>

	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_target_priv_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MPT2SAS_INVALID_DEVICE_HANDLE</span><span class="p">;</span>

	<span class="cm">/* RAID volumes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">RAID_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">raid_device</span> <span class="o">=</span> <span class="n">raid_device</span><span class="p">;</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sas/sata devices */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	   <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">))</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_target_destroy - target destroy routine</span>
<span class="cm"> * @starget: scsi target struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>

	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_target_priv_data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">RAID_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	   <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">==</span> <span class="n">starget</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_target_priv_data</span><span class="p">);</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_slave_alloc - device add routine</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if ok. Any other return is assumed to be an error and</span>
<span class="cm"> * the device is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MPT_DEVICE_FLAGS_INIT</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span> <span class="o">=</span> <span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">))</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">RAID_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span> <span class="cm">/* raid is single lun */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_slave_destroy - device destroy routine</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">--</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		   <span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">)</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_display_sata_capabilities - sata capabilities</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_display_sata_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
	<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
	    <span class="s">&quot;atapi(%s), ncq(%s), asyn_notify(%s), smart(%s), fua(%s), &quot;</span>
	    <span class="s">&quot;sw_preserve(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_ATAPI_DEVICE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE0_FLAGS_SATA_NCQ_SUPPORTED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE0_FLAGS_SATA_ASYNCHRONOUS_NOTIFY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span>
	    <span class="s">&quot;n&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE0_FLAGS_SATA_SMART_SUPPORTED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE0_FLAGS_SATA_FUA_SUPPORTED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE0_FLAGS_SATA_SW_PRESERVE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;y&quot;</span> <span class="o">:</span> <span class="s">&quot;n&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_is_raid - return boolean indicating device is raid volume</span>
<span class="cm"> * @dev the device struct object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_is_raid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">RAID_CHANNEL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_get_resync - get raid volume resync percent complete</span>
<span class="cm"> * @dev the device struct object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_get_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="n">vol_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">volume_status_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">percent_complete</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">percent_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">percent_complete</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">percent_complete</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vol_pg0</span><span class="p">,</span>
	     <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">percent_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">volume_status_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">.</span><span class="n">VolumeStatusFlags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">volume_status_flags</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS</span><span class="p">))</span>
		<span class="n">percent_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">raid_set_resync</span><span class="p">(</span><span class="n">mpt2sas_raid_template</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">percent_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_get_state - get raid volume level</span>
<span class="cm"> * @dev the device struct object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="n">vol_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">volstate</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">raid_state</span> <span class="n">state</span> <span class="o">=</span> <span class="n">RAID_STATE_UNKNOWN</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_id</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
	    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_device</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vol_pg0</span><span class="p">,</span>
	     <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">volstate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">.</span><span class="n">VolumeStatusFlags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volstate</span> <span class="o">&amp;</span> <span class="n">MPI2_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">RAID_STATE_RESYNCING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vol_pg0</span><span class="p">.</span><span class="n">VolumeState</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_OPTIMAL</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_ONLINE</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">RAID_STATE_ACTIVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">MPI2_RAID_VOL_STATE_DEGRADED</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">RAID_STATE_DEGRADED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_FAILED</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_MISSING</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">RAID_STATE_OFFLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">raid_set_state</span><span class="p">(</span><span class="n">mpt2sas_raid_template</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_set_level - set raid level</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @volume_type: volume type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_set_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">volume_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">raid_level</span> <span class="n">level</span> <span class="o">=</span> <span class="n">RAID_LEVEL_UNKNOWN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">volume_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID0</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">RAID_LEVEL_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID10</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">RAID_LEVEL_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID1E</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">RAID_LEVEL_1E</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID1</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">RAID_LEVEL_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raid_set_level</span><span class="p">(</span><span class="n">mpt2sas_raid_template</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_get_volume_capabilities - volume capabilities</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_device: the raid_device object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, else 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_get_volume_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="o">*</span><span class="n">vol_pg0</span><span class="p">;</span>
	<span class="n">Mpi2RaidPhysDiskPage0_t</span> <span class="n">pd_pg0</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_pds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_number_pds</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">num_pds</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="n">num_pds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
		    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">num_pds</span> <span class="o">=</span> <span class="n">num_pds</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">,</span> <span class="n">PhysDisk</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_pds</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVol0PhysDisk_t</span><span class="p">));</span>
	<span class="n">vol_pg0</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol_pg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
		    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">vol_pg0</span><span class="p">,</span>
	     <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
		    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">volume_type</span> <span class="o">=</span> <span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">VolumeType</span><span class="p">;</span>

	<span class="cm">/* figure out what the underlying devices are by</span>
<span class="cm">	 * obtaining the device_info bits for the 1st device</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">pd_pg0</span><span class="p">,</span> <span class="n">MPI2_PHYSDISK_PGAD_FORM_PHYSDISKNUM</span><span class="p">,</span>
	    <span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">=</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_disable_ddio - Disable direct I/O for all the volumes</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_disable_ddio</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidVolPage1_t</span> <span class="n">vol_pg1</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">vol_pg1</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg1</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">direct_io_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_get_num_volumes - Get number of volumes in the ioc</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_get_num_volumes</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidVolPage1_t</span> <span class="n">vol_pg1</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vol_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">vol_pg1</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">vol_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg1</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vol_cnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_init_warpdrive_properties - Set properties for warpdrive direct I/O.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @raid_device: the raid_device object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_init_warpdrive_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="o">*</span><span class="n">vol_pg0</span><span class="p">;</span>
	<span class="n">Mpi2RaidPhysDiskPage0_t</span> <span class="n">pd_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_pds</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stripe_sz</span><span class="p">,</span> <span class="n">block_sz</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stripe_exp</span><span class="p">,</span> <span class="n">block_exp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dev_max_lba</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfg_pg10_hide_flag</span> <span class="o">==</span>  <span class="n">MFG_PAGE10_EXPOSE_ALL_DISKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;globally as drives are exposed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_get_num_volumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_scsih_disable_ddio</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;globally as number of drives &gt; 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_number_pds</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">num_pds</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="n">num_pds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;Failure in computing number of drives</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">,</span> <span class="n">PhysDisk</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_pds</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVol0PhysDisk_t</span><span class="p">));</span>
	<span class="n">vol_pg0</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vol_pg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;Memory allocation failure for RVPG0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">vol_pg0</span><span class="p">,</span>
	     <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;Failure in retrieving RVPG0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * WARPDRIVE:If number of physical disks in a volume exceeds the max pds</span>
<span class="cm">	 * assumed for WARPDRIVE, disable direct I/O</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_pds</span> <span class="o">&gt;</span> <span class="n">MPT_MAX_WARPDRIVE_PDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;for the drive with handle(0x%04x): num_mem=%d, &quot;</span>
		    <span class="s">&quot;max_mem_allowed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">num_pds</span><span class="p">,</span> <span class="n">MPT_MAX_WARPDRIVE_PDS</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">num_pds</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">pd_pg0</span><span class="p">,</span> <span class="n">MPI2_PHYSDISK_PGAD_FORM_PHYSDISKNUM</span><span class="p">,</span>
		    <span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MPT2SAS_INVALID_DEVICE_HANDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is &quot;</span>
			    <span class="s">&quot;disabled for the drive with handle(0x%04x) member&quot;</span>
			    <span class="s">&quot;handle retrieval failed for member number=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			    <span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Disable direct I/O if member drive lba exceeds 4 bytes */</span>
		<span class="n">dev_max_lba</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DeviceMaxLBA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_max_lba</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is &quot;</span>
			    <span class="s">&quot;disabled for the drive with handle(0x%04x) member&quot;</span>
			    <span class="s">&quot;handle (0x%04x) unsupported max lba 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">),</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev_max_lba</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">pd_handle</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assumption for WD: Direct I/O is not supported if the volume is</span>
<span class="cm">	 * not RAID0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">volume_type</span> <span class="o">!=</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;for the drive with handle(0x%04x): type=%d, &quot;</span>
		    <span class="s">&quot;s_sz=%uK, blk_size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">volume_type</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">StripeSize</span><span class="p">)</span> <span class="o">*</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stripe_sz</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">StripeSize</span><span class="p">);</span>
	<span class="n">stripe_exp</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stripe_sz</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stripe_exp</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		<span class="s">&quot;for the drive with handle(0x%04x) invalid stripe sz %uK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">StripeSize</span><span class="p">)</span> <span class="o">*</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_exponent</span> <span class="o">=</span> <span class="n">stripe_exp</span><span class="p">;</span>
	<span class="n">block_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">);</span>
	<span class="n">block_exp</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_sz</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block_exp</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is disabled &quot;</span>
		    <span class="s">&quot;for the drive with handle(0x%04x) invalid block sz %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">block_exponent</span> <span class="o">=</span> <span class="n">block_exp</span><span class="p">;</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">direct_io_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;WarpDrive : Direct IO is Enabled for the drive&quot;</span>
	    <span class="s">&quot; with handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * WARPDRIVE: Though the following fields are not used for direct IO,</span>
<span class="cm">	 * stored for future purpose:</span>
<span class="cm">	 */</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">max_lba</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">MaxLBA</span><span class="p">);</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_sz</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">StripeSize</span><span class="p">);</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">block_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vol_pg0</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">);</span>


	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_error:</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">direct_io_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">num_pds</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">pd_handle</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vol_pg0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_enable_tlr - setting TLR flags</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Enabling Transaction Layer Retries for tape devices when</span>
<span class="cm"> * vpd page 0x90 is present</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_enable_tlr</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only for TAPE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_TAPE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_CAPABILITY_TLR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sas_enable_tlr</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;TLR %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sas_is_tlr_enabled</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_slave_configure - device configure routine.</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if ok. Any other return is assumed to be an error and</span>
<span class="cm"> * the device is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qdepth</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssp_target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">volume_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">volume_wwid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qdepth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">configured_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_DEVICE_FLAGS_INIT</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="cm">/* raid volume handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
			    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_get_volume_capabilities</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
			    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * WARPDRIVE: Initialize the required data for Direct IO</span>
<span class="cm">		 */</span>
		<span class="n">_scsih_init_warpdrive_properties</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>

		<span class="cm">/* RAID Queue Depth Support</span>
<span class="cm">		 * IS volume = underlying qdepth of drive type, either</span>
<span class="cm">		 *    MPT2SAS_SAS_QUEUE_DEPTH or MPT2SAS_SATA_QUEUE_DEPTH</span>
<span class="cm">		 * IM/IME/R10 = 128 (MPT2SAS_RAID_QUEUE_DEPTH)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_SAS_QUEUE_DEPTH</span><span class="p">;</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SSP&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_SATA_QUEUE_DEPTH</span><span class="p">;</span>
			 <span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
			    <span class="n">MPI2_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SATA&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;STP&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">volume_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID0</span>:
			<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAID0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID1E</span>:
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_RAID_QUEUE_DEPTH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg10</span><span class="p">.</span><span class="n">OEMIdentifier</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg10</span><span class="p">.</span><span class="n">GenericFlags0</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">MFG10_GF0_R10_DISPLAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">num_pds</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAID10&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAID1E&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID1</span>:
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_RAID_QUEUE_DEPTH</span><span class="p">;</span>
			<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAID1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_RAID10</span>:
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_RAID_QUEUE_DEPTH</span><span class="p">;</span>
			<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAID10&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_RAID_VOL_TYPE_UNKNOWN</span>:
		<span class="nl">default:</span>
			<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_RAID_QUEUE_DEPTH</span><span class="p">;</span>
			<span class="n">r_level</span> <span class="o">=</span> <span class="s">&quot;RAIDX&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: handle(0x%04x), &quot;</span>
			    <span class="s">&quot;wwid(0x%016llx), pd_count(%d), type(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">r_level</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">,</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">num_pds</span><span class="p">,</span> <span class="n">ds</span><span class="p">);</span>
		<span class="n">_scsih_change_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">,</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">);</span>
		<span class="cm">/* raid transport support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
			<span class="n">_scsih_set_level</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">volume_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* non-raid handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_volume_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">volume_handle</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume_handle</span> <span class="o">&amp;&amp;</span> <span class="n">mpt2sas_config_get_volume_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">volume_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume_wwid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	   <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			<span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span> <span class="o">=</span> <span class="n">volume_handle</span><span class="p">;</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_wwid</span> <span class="o">=</span> <span class="n">volume_wwid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_SAS_QUEUE_DEPTH</span><span class="p">;</span>
		<span class="n">ssp_target</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SSP&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qdepth</span> <span class="o">=</span> <span class="n">MPT2SAS_SATA_QUEUE_DEPTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;STP&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SATA&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: handle(0x%04x), &quot;</span>
	    <span class="s">&quot;sas_addr(0x%016llx), phy(%d), device_name(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ds</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s: &quot;</span>
	    <span class="s">&quot;enclosure_logical_id(0x%016llx), slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssp_target</span><span class="p">)</span>
		<span class="n">_scsih_display_sata_capabilities</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>


	<span class="n">_scsih_change_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">,</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssp_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_read_port_mode_page</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">_scsih_enable_tlr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_bios_param - fetch head, sector, cylinder info for a disk</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @bdev: pointer to block device context</span>
<span class="cm"> * @capacity: device size (in 512 byte sectors)</span>
<span class="cm"> * @params: three element array to place output:</span>
<span class="cm"> *              params[0] number of heads (max 255)</span>
<span class="cm"> *              params[1] number of sectors (max 63)</span>
<span class="cm"> *              params[2] number of cylinders</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
    <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">params</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">heads</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sectors</span><span class="p">;</span>
	<span class="n">sector_t</span>	<span class="n">cylinders</span><span class="p">;</span>
	<span class="n">ulong</span> 		<span class="n">dummy</span><span class="p">;</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">dummy</span> <span class="o">=</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span> <span class="n">dummy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle extended translation size for logical drives</span>
<span class="cm">	 * &gt; 1Gb</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
		<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span> <span class="n">dummy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* return result */</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_response_code - translation of device response code</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @response_code: response code returned by the device</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_response_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">response_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_TM_COMPLETE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task management request completed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_INVALID_FRAME</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid frame&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_TM_NOT_SUPPORTED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task management request not supported&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_TM_FAILED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task management request failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_TM_SUCCEEDED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task management request succeeded&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_TM_INVALID_LUN</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid lun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xA</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;overlapped tag attempted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_RSP_IO_QUEUED_ON_IOC</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task queued, however not sent to target&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;response_code(0x%01x): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_done - tm completion routine</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> * Context: none.</span>
<span class="cm"> *</span>
<span class="cm"> * The callback handler when using scsih_issue_tm.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_tm_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">!=</span> <span class="n">smid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mpt2sas_base_flush_reply_queues</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">;</span>
	<span class="n">mpi_reply</span> <span class="o">=</span>  <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_set_tm_flag - set per target tm_busy</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * During taskmangement request, we need to freeze the device queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_scsih_set_tm_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">tm_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ignore_loginfos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_clear_tm_flag - clear per target tm_busy</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * During taskmangement request, we need to freeze the device queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_scsih_clear_tm_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">tm_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ignore_loginfos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_issue_tm - main routine for sending tm requests</span>
<span class="cm"> * @ioc: per adapter struct</span>
<span class="cm"> * @device_handle: device handle</span>
<span class="cm"> * @channel: the channel assigned by the OS</span>
<span class="cm"> * @id: the id assigned by the OS</span>
<span class="cm"> * @lun: lun number</span>
<span class="cm"> * @type: MPI2_SCSITASKMGMT_TASKTYPE__XXX (defined in mpi2_init.h)</span>
<span class="cm"> * @smid_task: smid assigned to the task</span>
<span class="cm"> * @timeout: timeout in seconds</span>
<span class="cm"> * @serial_number: the serial_number from scmd</span>
<span class="cm"> * @m_type: TM_MUTEX_ON or TM_MUTEX_OFF</span>
<span class="cm"> * Context: user</span>
<span class="cm"> *</span>
<span class="cm"> * A generic API for sending task management requests to firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The callback index is set inside `ioc-&gt;tm_cb_idx`.</span>
<span class="cm"> *</span>
<span class="cm"> * Return SUCCESS or FAILED.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">uint</span> <span class="n">channel</span><span class="p">,</span>
    <span class="n">uint</span> <span class="n">id</span><span class="p">,</span> <span class="n">uint</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid_task</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">timeout</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">serial_number</span><span class="p">,</span> <span class="k">enum</span> <span class="n">mutex_type</span> <span class="n">m_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SCSITaskManagementRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsiio_tracker</span> <span class="o">*</span><span class="n">scsi_lookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_type</span> <span class="o">==</span> <span class="n">TM_MUTEX_ON</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: tm_cmd busy!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;unexpected doorbell &quot;</span>
		    <span class="s">&quot;active!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="o">?</span> <span class="n">SUCCESS</span> <span class="o">:</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt2sas_base_fault_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_state</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="o">?</span> <span class="n">SUCCESS</span> <span class="o">:</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid_hpr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span><span class="p">)</span>
		<span class="n">scsi_lookup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid_task</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sending tm: handle(0x%04x),&quot;</span>
	    <span class="s">&quot; task_type(0x%02x), smid(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
	    <span class="n">smid_task</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementReply_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">TaskMID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">smid_task</span><span class="p">);</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>
	<span class="n">mpt2sas_scsih_set_tm_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_hi_priority</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
			    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="o">?</span> <span class="n">SUCCESS</span> <span class="o">:</span> <span class="n">FAILED</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
			<span class="n">mpt2sas_scsih_clear_tm_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;complete tm: &quot;</span>
		    <span class="s">&quot;ioc_status(0x%04x), loginfo(0x%08x), term_count(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_scsih_response_code</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span>
				<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_lookup</span><span class="o">-&gt;</span><span class="n">scmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_scsi_lookup_find_by_target</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_ABRT_TASK_SET</span>:
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_LOGICAL_UNIT_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_scsi_lookup_find_by_lun</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_QUERY_TASK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_scsih_clear_tm_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_type</span> <span class="o">==</span> <span class="n">TM_MUTEX_ON</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

 <span class="nl">err_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_type</span> <span class="o">==</span> <span class="n">TM_MUTEX_ON</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_display_info - displays info about the device</span>
<span class="cm"> * @ioc: per adapter struct</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Called by task management callback handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_tm_display_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">priv_target</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">device_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv_target</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">device_str</span> <span class="o">=</span> <span class="s">&quot;WarpDrive&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">device_str</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">;</span>

	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;%s handle(0x%04x), &quot;</span>
		    <span class="s">&quot;%s wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device_str</span><span class="p">,</span> <span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">device_str</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span>
				    <span class="s">&quot;volume handle(0x%04x), &quot;</span>
				    <span class="s">&quot;volume wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_wwid</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span>
			    <span class="s">&quot;handle(0x%04x), sas_address(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span>
			    <span class="s">&quot;enclosure_logical_id(0x%016llx), slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_abort - eh threads main abort routine</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns SUCCESS if command aborted else FAILED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;attempting task abort! &quot;</span>
	    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="n">_scsih_tm_display_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>

	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;device been deleted! &quot;</span>
		    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* search for the command */</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">_scsih_scsi_lookup_find_by_scmd</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for hidden raid components and volumes this is not supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span> <span class="o">||</span>
	    <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
	    <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
	    <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">,</span> <span class="n">TM_MUTEX_ON</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;task abort: %s scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_dev_reset - eh threads main device reset routine</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns SUCCESS if command aborted else FAILED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">;</span>

	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;attempting device reset! &quot;</span>
	    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="n">_scsih_tm_display_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>

	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;device been deleted! &quot;</span>
		    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for hidden raid components obtain the volume_handle */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		   <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
	    <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_LOGICAL_UNIT_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">TM_MUTEX_ON</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;device reset: %s scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_target_reset - eh threads main target reset routine</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns SUCCESS if command aborted else FAILED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_target_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">;</span>

	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;attempting target reset! &quot;</span>
	    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="n">_scsih_tm_display_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>

	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;target been deleted! &quot;</span>
		    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for hidden raid components obtain the volume_handle */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		   <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TM_MUTEX_ON</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;target reset: %s scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_host_reset - eh threads main host reset routine</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns SUCCESS if command aborted else FAILED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;attempting host reset! scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
	    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;host reset: %s scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span> <span class="n">scmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_fw_event_add - insert and queue up fw_event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: object describing the event</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;fw_event_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This adds the firmware event object into link list, then queues it up to</span>
<span class="cm"> * be processed from user context.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_fw_event_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span> <span class="n">_firmware_event_work</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_fw_event_free - delete fw_event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: object describing the event</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;fw_event_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * This removes firmware event object from link list, frees associated memory.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_fw_event_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span>
    <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_error_recovery_delete_devices - remove devices not responding</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_error_recovery_delete_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">MPT2SAS_REMOVE_UNRESPONDING_DEVICES</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_port_enable_complete - port enable completed (fake event)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_port_enable_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>

	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">MPT2SAS_PORT_ENABLE_COMPLETE</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_fw_event_cleanup_queue - cleanup event queue</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Walk the firmware event queue, either killing timers, or waiting</span>
<span class="cm"> * for outstanding events to complete</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_fw_event_cleanup_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span> <span class="o">||</span> <span class="n">in_interrupt</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fw_event</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">delayed_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_scsih_fw_event_free</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">cancel_pending_work</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_ublock_io_all_device - unblock every device</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * change the device state from block to running</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_ublock_io_all_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;device_running, &quot;</span>
		    <span class="s">&quot;handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
		<span class="n">scsi_internal_device_unblock</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_ublock_io_device - set the device state to SDEV_RUNNING</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * During device pull we need to appropiately set the sdev state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_ublock_io_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">==</span>
								<span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;SDEV_RUNNING: &quot;</span>
			    <span class="s">&quot;sas address(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scsi_internal_device_unblock</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_block_io_all_device - set the device state to SDEV_BLOCK</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * During device pull we need to appropiately set the sdev state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_block_io_all_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;device_blocked, &quot;</span>
		    <span class="s">&quot;handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
		<span class="n">scsi_internal_device_block</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_block_io_device - set the device state to SDEV_BLOCK</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * During device pull we need to appropiately set the sdev state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_block_io_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;SDEV_BLOCK: &quot;</span>
			    <span class="s">&quot;handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
			<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scsi_internal_device_block</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_block_io_to_children_attached_to_ex</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_expander: the sas_device object</span>
<span class="cm"> *</span>
<span class="cm"> * This routine set sdev state to SDEV_BLOCK for all devices</span>
<span class="cm"> * attached to this expander. This function called when expander is</span>
<span class="cm"> * pulled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_block_io_to_children_attached_to_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">expander_sibling</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span>
	   <span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span> <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_END_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sas_device</span> <span class="o">=</span>
			    <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			   <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span>
	   <span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span> <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">||</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">expander_sibling</span> <span class="o">=</span>
			    <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span>
			    <span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
			<span class="n">_scsih_block_io_to_children_attached_to_ex</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">expander_sibling</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_block_io_to_children_attached_directly</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: topology change event data</span>
<span class="cm"> *</span>
<span class="cm"> * This routine set sdev state to SDEV_BLOCK for all devices</span>
<span class="cm"> * direct attached during device pull.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_block_io_to_children_attached_directly</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_number</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">phy_number</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">StartPhyNum</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">reason_code</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyStatus</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_RC_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_DELAY_NOT_RESPONDING</span><span class="p">)</span>
			<span class="n">_scsih_block_io_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_tr_send - send task management request</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is to initiate the device removal handshake protocol</span>
<span class="cm"> * with controller firmware.  This function will issue target reset</span>
<span class="cm"> * using high priority request queue.  It will send a sas iounit</span>
<span class="cm"> * control request (MPI2_SAS_OP_REMOVE_DEVICE) from this completion.</span>
<span class="cm"> *</span>
<span class="cm"> * This is designed to send muliple task management request at the same</span>
<span class="cm"> * time to the fifo. If the fifo is full, we will append the request,</span>
<span class="cm"> * and process it in a future completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_tm_tr_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SCSITaskManagementRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_tr_list</span> <span class="o">*</span><span class="n">delayed_tr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host has been &quot;</span>
		    <span class="s">&quot;removed: handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host in pci &quot;</span>
		    <span class="s">&quot;error recovery: handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host is not &quot;</span>
		   <span class="s">&quot;operational: handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if PD, then return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">&amp;&amp;</span>
	     <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;setting delete flag: &quot;</span>
		<span class="s">&quot;handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
		<span class="n">_scsih_ublock_io_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">MPT2SAS_INVALID_DEVICE_HANDLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid_hpr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delayed_tr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">delayed_tr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_tr</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">);</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;DELAYED:tr:handle(0x%04x), (open)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;tr_send:handle(0x%04x), &quot;</span>
	    <span class="s">&quot;(open), smid(%d), cb(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_cb_idx</span><span class="p">));</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">;</span>
	<span class="n">mpt2sas_base_put_smid_hi_priority</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_control_complete - completion routine</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the sas iounit control completion routine.</span>
<span class="cm"> * This code is part of the code to initiate the device removal</span>
<span class="cm"> * handshake protocol with controller firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_sas_control_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span>
    <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SasIoUnitControlReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span> <span class="o">=</span>
	    <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		<span class="s">&quot;sc_complete:handle(0x%04x), (open) &quot;</span>
		<span class="s">&quot;smid(%d), ioc_status(0x%04x), loginfo(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">),</span> <span class="n">smid</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;mpi_reply not valid at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_tr_volume_send - send target reset request for volumes</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This is designed to send muliple task management request at the same</span>
<span class="cm"> * time to the fifo. If the fifo is full, we will append the request,</span>
<span class="cm"> * and process it in a future completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_tm_tr_volume_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SCSITaskManagementRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_tr_list</span> <span class="o">*</span><span class="n">delayed_tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in &quot;</span>
		   <span class="s">&quot;progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid_hpr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_volume_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delayed_tr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">delayed_tr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_tr</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_volume_list</span><span class="p">);</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;DELAYED:tr:handle(0x%04x), (open)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;tr_send:handle(0x%04x), &quot;</span>
	    <span class="s">&quot;(open), smid(%d), cb(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_volume_cb_idx</span><span class="p">));</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">;</span>
	<span class="n">mpt2sas_base_put_smid_hi_priority</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_volume_tr_complete - target reset completion</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_tm_volume_tr_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span>
    <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementRequest_t</span> <span class="o">*</span><span class="n">mpi_request_tm</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span> <span class="o">=</span>
	    <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in &quot;</span>
		   <span class="s">&quot;progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mpi_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;mpi_reply not valid at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpi_request_tm</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_request_tm</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;spurious interrupt: &quot;</span>
		    <span class="s">&quot;handle(0x%04x:0x%04x), smid(%d)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">),</span> <span class="n">smid</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
	    <span class="s">&quot;tr_complete:handle(0x%04x), (open) smid(%d), ioc_status(0x%04x), &quot;</span>
	    <span class="s">&quot;loginfo(0x%08x), completed(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">handle</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">_scsih_check_for_pending_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_tm_tr_complete -</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the target reset completion routine.</span>
<span class="cm"> * This code is part of the code to initiate the device removal</span>
<span class="cm"> * handshake protocol with controller firmware.</span>
<span class="cm"> * It will send a sas iounit control request (MPI2_SAS_OP_REMOVE_DEVICE)</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_tm_tr_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementRequest_t</span> <span class="o">*</span><span class="n">mpi_request_tm</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span> <span class="o">=</span>
	    <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="n">Mpi2SasIoUnitControlRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid_sas_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host has been &quot;</span>
		   <span class="s">&quot;removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host in pci &quot;</span>
		    <span class="s">&quot;error recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host is not &quot;</span>
		    <span class="s">&quot;operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mpi_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;mpi_reply not valid at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpi_request_tm</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_request_tm</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;spurious interrupt: &quot;</span>
		    <span class="s">&quot;handle(0x%04x:0x%04x), smid(%d)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">),</span> <span class="n">smid</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
	    <span class="s">&quot;tr_complete:handle(0x%04x), (open) smid(%d), ioc_status(0x%04x), &quot;</span>
	    <span class="s">&quot;loginfo(0x%08x), completed(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">handle</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">)));</span>

	<span class="n">smid_sas_ctrl</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_sas_control_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid_sas_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sc_send:handle(0x%04x), &quot;</span>
	    <span class="s">&quot;(open), smid(%d), cb(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">smid_sas_ctrl</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_sas_control_cb_idx</span><span class="p">));</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid_sas_ctrl</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SAS_IO_UNIT_CONTROL</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">MPI2_SAS_OP_REMOVE_DEVICE</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">mpi_request_tm</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">;</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid_sas_ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_scsih_check_for_pending_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_check_for_pending_tm - check for pending task management</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * This will check delayed target reset list, and feed the</span>
<span class="cm"> * next reqeust.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_check_for_pending_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_tr_list</span> <span class="o">*</span><span class="n">delayed_tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_volume_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">delayed_tr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_volume_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">_tr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="n">_scsih_tm_tr_volume_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">delayed_tr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">_tr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="n">_scsih_tm_tr_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_check_topo_delete_events - sanity check on topo events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: the event data payload</span>
<span class="cm"> *</span>
<span class="cm"> * This routine added to better handle cable breaker.</span>
<span class="cm"> *</span>
<span class="cm"> * This handles the case where driver receives multiple expander</span>
<span class="cm"> * add and delete events in a single shot.  When there is a delete event</span>
<span class="cm"> * the routine will void any pending add events waiting in the event queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_check_topo_delete_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>
	<span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="n">local_event_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expander_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">reason_code</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyStatus</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_RC_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_NOT_RESPONDING</span><span class="p">)</span>
			<span class="n">_scsih_tm_tr_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">expander_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpanderDevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expander_handle</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_scsih_block_io_to_children_attached_directly</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span>
	    <span class="n">MPI2_EVENT_SAS_TOPO_ES_DELAY_NOT_RESPONDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* put expander attached devices into blocking state */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">expander_handle</span><span class="p">);</span>
		<span class="n">_scsih_block_io_to_children_attached_to_ex</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevHandle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevHandle</span><span class="p">)</span>
				<span class="n">_scsih_block_io_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_RESPONDING</span><span class="p">)</span>
		<span class="n">_scsih_block_io_to_children_attached_directly</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_NOT_RESPONDING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* mark ignore flag for pending events */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fw_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span> <span class="o">||</span>
		    <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">local_event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local_event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_ES_ADDED</span> <span class="o">||</span>
		    <span class="n">local_event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_ES_RESPONDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local_event_data</span><span class="o">-&gt;</span><span class="n">ExpanderDevHandle</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">expander_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
				    <span class="s">&quot;setting ignoring flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_set_volume_delete_flag - setting volume delete flag</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * This</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_set_volume_delete_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span> <span class="o">&amp;&amp;</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">&amp;&amp;</span>
	    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_target_priv_data</span> <span class="o">=</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;setting delete flag: handle(0x%04x), &quot;</span>
		    <span class="s">&quot;wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_set_volume_handle_for_tr - set handle for target reset to volume</span>
<span class="cm"> * @handle: input handle</span>
<span class="cm"> * @a: handle for volume a</span>
<span class="cm"> * @b: handle for volume b</span>
<span class="cm"> *</span>
<span class="cm"> * IR firmware only supports two raid volumes.  The purpose of this</span>
<span class="cm"> * routine is to set the volume handle in either a or b. When the given</span>
<span class="cm"> * input handle is non-zero, or when a and b have not been set before.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_set_volume_handle_for_tr</span><span class="p">(</span><span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span> <span class="o">||</span> <span class="n">handle</span> <span class="o">==</span> <span class="o">*</span><span class="n">a</span> <span class="o">||</span> <span class="n">handle</span> <span class="o">==</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">a</span><span class="p">)</span>
		<span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">b</span><span class="p">)</span>
		<span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_check_ir_config_unhide_events - check for UNHIDE events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: the event data payload</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will send target reset to volume, followed by target</span>
<span class="cm"> * resets to the PDs. This is called when a PD has been removed, or</span>
<span class="cm"> * volume has been deleted or removed. When the target reset is sent</span>
<span class="cm"> * to volume, the PD target resets need to be queued to start upon</span>
<span class="cm"> * completion of the volume target reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_check_ir_config_unhide_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataIrConfigChangeList_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">volume_handle</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_tr_list</span> <span class="o">*</span><span class="n">delayed_tr</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Volume Resets for Deleted or Removed */</span>
	<span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ConfigElement</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">element</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
		    <span class="n">MPI2_EVENT_IR_CHANGE_RC_VOLUME_DELETED</span> <span class="o">||</span>
		    <span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
		    <span class="n">MPI2_EVENT_IR_CHANGE_RC_REMOVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">volume_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
			<span class="n">_scsih_set_volume_delete_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">volume_handle</span><span class="p">);</span>
			<span class="n">_scsih_set_volume_handle_for_tr</span><span class="p">(</span><span class="n">volume_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Volume Resets for UNHIDE events */</span>
	<span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ConfigElement</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">element</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_IR_CHANGE_FLAGS_FOREIGN_CONFIG</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_UNHIDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">volume_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
			<span class="n">_scsih_set_volume_handle_for_tr</span><span class="p">(</span><span class="n">volume_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
		<span class="n">_scsih_tm_tr_volume_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
		<span class="n">_scsih_tm_tr_volume_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="cm">/* PD target resets */</span>
	<span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ConfigElement</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">element</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_UNHIDE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>
		<span class="n">volume_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_handle</span><span class="p">)</span>
			<span class="n">_scsih_tm_tr_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">volume_handle</span> <span class="o">==</span> <span class="n">a</span> <span class="o">||</span> <span class="n">volume_handle</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">delayed_tr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">delayed_tr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">delayed_tr</span><span class="p">);</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">);</span>
			<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
			    <span class="s">&quot;DELAYED:tr:handle(0x%04x), (open)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">_scsih_tm_tr_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_check_volume_delete_events - set delete flag for volumes</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: the event data payload</span>
<span class="cm"> * Context: interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> * This will handle the case when the cable connected to entire volume is</span>
<span class="cm"> * pulled. We will take care of setting the deleted flag so normal IO will</span>
<span class="cm"> * not be sent.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_check_volume_delete_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataIrVolume_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_IR_VOLUME_RC_STATE_CHANGED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NewValue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_MISSING</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span>
	    <span class="n">MPI2_RAID_VOL_STATE_FAILED</span><span class="p">)</span>
		<span class="n">_scsih_set_volume_delete_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_flush_running_cmds - completing outstanding commands.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * The flushing out of all pending scmd commands following host reset,</span>
<span class="cm"> * where all IO is dropped to the floor.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_flush_running_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">smid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">smid</span> <span class="o">&lt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">smid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span> <span class="o">=</span> <span class="n">_scsih_scsi_lookup_get_clear</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scmd</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;completing %d cmds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_setup_eedp - setup MPI request for EEDP transfer</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * @mpi_request: pointer to the SCSI_IO reqest message frame</span>
<span class="cm"> *</span>
<span class="cm"> * Supporting protection 1 and 3.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_setup_eedp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="n">Mpi2SCSIIORequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">eedp_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prot_op</span> <span class="o">=</span> <span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prot_type</span> <span class="o">=</span> <span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prot_type</span> <span class="o">==</span> <span class="n">SCSI_PROT_DIF_TYPE0</span> <span class="o">||</span> <span class="n">prot_op</span> <span class="o">==</span> <span class="n">SCSI_PROT_NORMAL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prot_op</span> <span class="o">==</span>  <span class="n">SCSI_PROT_READ_STRIP</span><span class="p">)</span>
		<span class="n">eedp_flags</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_REMOVE_OP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prot_op</span> <span class="o">==</span>  <span class="n">SCSI_PROT_WRITE_INSERT</span><span class="p">)</span>
		<span class="n">eedp_flags</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_EEDPFLAGS_INSERT_OP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">prot_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE1</span>:
	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE2</span>:

		<span class="cm">/*</span>
<span class="cm">		* enable ref/guard checking</span>
<span class="cm">		* auto increment ref tag</span>
<span class="cm">		*/</span>
		<span class="n">eedp_flags</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_EEDPFLAGS_INC_PRI_REFTAG</span> <span class="o">|</span>
		    <span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_REFTAG</span> <span class="o">|</span>
		    <span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_GUARD</span><span class="p">;</span>
		<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">EEDP32</span><span class="p">.</span><span class="n">PrimaryReferenceTag</span> <span class="o">=</span>
		    <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">scmd</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_PROT_DIF_TYPE3</span>:

		<span class="cm">/*</span>
<span class="cm">		* enable guard checking</span>
<span class="cm">		*/</span>
		<span class="n">eedp_flags</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_EEDPFLAGS_CHECK_GUARD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">EEDPBlockSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">EEDPFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">eedp_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_eedp_error_handling - return sense code for EEDP errors</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * @ioc_status: ioc status</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_eedp_error_handling</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ioc_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ascq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_byte</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_GUARD_ERROR</span>:
		<span class="n">ascq</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_APP_TAG_ERROR</span>:
		<span class="n">ascq</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_REF_TAG_ERROR</span>:
		<span class="n">ascq</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ascq</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>
		<span class="n">host_byte</span> <span class="o">=</span> <span class="n">DID_ABORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sk</span> <span class="o">=</span> <span class="n">ABORTED_COMMAND</span><span class="p">;</span>
		<span class="n">host_byte</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_build_sense_buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">ascq</span><span class="p">);</span>
	<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="p">(</span><span class="n">host_byte</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_direct_io_get - returns direct io flag</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the smid stored scmd pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">_scsih_scsi_direct_io_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">direct_io</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_direct_io_set - sets direct io flag</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @direct_io: Zero or non-zero value to set in the direct_io flag</span>
<span class="cm"> *</span>
<span class="cm"> * Returns Nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">_scsih_scsi_direct_io_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">direct_io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">direct_io</span> <span class="o">=</span> <span class="n">direct_io</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_setup_direct_io - setup MPI request for WARPDRIVE Direct I/O</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * @raid_device: pointer to raid device data structure</span>
<span class="cm"> * @mpi_request: pointer to the SCSI_IO reqest message frame</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_setup_direct_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="n">Mpi2SCSIIORequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v_lba</span><span class="p">,</span> <span class="n">p_lba</span><span class="p">,</span> <span class="n">stripe_off</span><span class="p">,</span> <span class="n">stripe_unit</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">io_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stripe_sz</span><span class="p">,</span> <span class="n">stripe_exp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_pds</span><span class="p">,</span> <span class="o">*</span><span class="n">cdb_ptr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cdb0</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">v_llba</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try Direct I/O to RAID memeber disks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdb0</span> <span class="o">==</span> <span class="n">READ_16</span> <span class="o">||</span> <span class="n">cdb0</span> <span class="o">==</span> <span class="n">READ_10</span> <span class="o">||</span>
	    <span class="n">cdb0</span> <span class="o">==</span> <span class="n">WRITE_16</span> <span class="o">||</span> <span class="n">cdb0</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdb_ptr</span> <span class="o">=</span> <span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cdb0</span> <span class="o">&lt;</span> <span class="n">READ_16</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
			<span class="o">|</span> <span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">io_size</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">block_exponent</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdb0</span> <span class="o">&lt;</span> <span class="n">READ_16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
			<span class="cm">/* get virtual lba */</span>
			<span class="n">v_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cdb_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">v_lba</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">io_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">max_lba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stripe_sz</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_sz</span><span class="p">;</span>
				<span class="n">stripe_exp</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_exponent</span><span class="p">;</span>
				<span class="n">stripe_off</span> <span class="o">=</span> <span class="n">v_lba</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stripe_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

				<span class="cm">/* Check whether IO falls within a stripe */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">stripe_off</span> <span class="o">+</span> <span class="n">io_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">stripe_sz</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">num_pds</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">num_pds</span><span class="p">;</span>
					<span class="n">p_lba</span> <span class="o">=</span> <span class="n">v_lba</span> <span class="o">&gt;&gt;</span> <span class="n">stripe_exp</span><span class="p">;</span>
					<span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">p_lba</span> <span class="o">/</span> <span class="n">num_pds</span><span class="p">;</span>
					<span class="n">column</span> <span class="o">=</span> <span class="n">p_lba</span> <span class="o">%</span> <span class="n">num_pds</span><span class="p">;</span>
					<span class="n">p_lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">stripe_unit</span> <span class="o">&lt;&lt;</span> <span class="n">stripe_exp</span><span class="p">)</span> <span class="o">+</span>
					    <span class="n">stripe_off</span><span class="p">;</span>
					<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span>
						    <span class="n">pd_handle</span><span class="p">[</span><span class="n">column</span><span class="p">]);</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cdb_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">=</span>
						<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">p_lba</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					* WD: To indicate this I/O is directI/O</span>
<span class="cm">					*/</span>
					<span class="n">_scsih_scsi_direct_io_set</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">io_size</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">block_exponent</span><span class="p">;</span>
			<span class="cm">/* get virtual lba */</span>
			<span class="n">v_llba</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">v_llba</span> <span class="o">+</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">io_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">max_lba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stripe_sz</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_sz</span><span class="p">;</span>
				<span class="n">stripe_exp</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">stripe_exponent</span><span class="p">;</span>
				<span class="n">stripe_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">v_llba</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stripe_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

				<span class="cm">/* Check whether IO falls within a stripe */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">stripe_off</span> <span class="o">+</span> <span class="n">io_size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">stripe_sz</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">num_pds</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">num_pds</span><span class="p">;</span>
					<span class="n">p_lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">v_llba</span> <span class="o">&gt;&gt;</span> <span class="n">stripe_exp</span><span class="p">);</span>
					<span class="n">stripe_unit</span> <span class="o">=</span> <span class="n">p_lba</span> <span class="o">/</span> <span class="n">num_pds</span><span class="p">;</span>
					<span class="n">column</span> <span class="o">=</span> <span class="n">p_lba</span> <span class="o">%</span> <span class="n">num_pds</span><span class="p">;</span>
					<span class="n">p_lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">stripe_unit</span> <span class="o">&lt;&lt;</span> <span class="n">stripe_exp</span><span class="p">)</span> <span class="o">+</span>
					    <span class="n">stripe_off</span><span class="p">;</span>
					<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span>
						    <span class="n">pd_handle</span><span class="p">[</span><span class="n">column</span><span class="p">]);</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">cdb_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">=</span>
					    <span class="n">cpu_to_be64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">p_lba</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					* WD: To indicate this I/O is directI/O</span>
<span class="cm">					*/</span>
					<span class="n">_scsih_scsi_direct_io_set</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_qcmd - main scsi request entry point</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * @done: function pointer to be invoked on completion</span>
<span class="cm"> *</span>
<span class="cm"> * The callback index is set inside `ioc-&gt;scsi_io_cb_idx`.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success.  If there&#39;s a failure, return either:</span>
<span class="cm"> * SCSI_MLQUEUE_DEVICE_BUSY if the device queue is full, or</span>
<span class="cm"> * SCSI_MLQUEUE_HOST_BUSY if the entire host queue is full</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_qcmd_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="n">Mpi2SCSIIORequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mpi_control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">;</span>
	<span class="cm">/* invalid device handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">MPT2SAS_INVALID_DEVICE_HANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* host recovery or link resets sent via IOCTLs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_link_reset_in_progress</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="cm">/* device busy with task management */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">||</span> <span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">tm_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_DEVICE_BUSY</span><span class="p">;</span>
	<span class="cm">/* device has been deleted */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">mpi_control</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_CONTROL_READ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">mpi_control</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mpi_control</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_CONTROL_NODATATRANSFER</span><span class="p">;</span>

	<span class="cm">/* set tags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_DEVICE_FLAGS_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">ordered_tags</span><span class="p">)</span>
				<span class="n">mpi_control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_ORDEREDQ</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mpi_control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cm">/* MPI Revision I (UNIT = 0xA) - removed MPI2_SCSIIO_CONTROL_UNTAGGED */</span>
<span class="cm">/*			mpi_control |= MPI2_SCSIIO_CONTROL_UNTAGGED;</span>
<span class="cm"> */</span>
			<span class="n">mpi_control</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x500</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mpi_control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">;</span>
	<span class="cm">/* Make sure Device is not raid volume.</span>
<span class="cm">	 * We do not expose raid functionality to upper layer for warpdrive.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_scsih_is_raid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sas_is_tlr_enabled</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">mpi_control</span> <span class="o">|=</span> <span class="n">MPI2_SCSIIO_CONTROL_TLR_ON</span><span class="p">;</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid_scsiio</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_io_cb_idx</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSIIORequest_t</span><span class="p">));</span>
	<span class="n">_scsih_setup_eedp</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">mpi_request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">mpi_control</span> <span class="o">|=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SCSIIO_CONTROL_ADDCDBLEN_SHIFT</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
	    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
		<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mpi_control</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">IoFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="n">MPI2_SCSIIO_MSGFLAGS_SYSTEM_SENSE_ADDR</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddress</span> <span class="o">=</span>
	    <span class="n">mpt2sas_base_get_sense_buffer_dma</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGLOffset0</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SCSIIORequest_t</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGLFlags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI2_SCSIIO_SGLFLAGS_TYPE_MPI</span> <span class="o">+</span>
	    <span class="n">MPI2_SCSIIO_SGLFLAGS_SYSTEM_ADDR</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt2sas_base_build_zero_len_sge</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_build_scatter_gather</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="n">smid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span> <span class="o">&amp;&amp;</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">direct_io_enabled</span><span class="p">)</span>
		<span class="n">_scsih_setup_direct_io</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">,</span> <span class="n">mpi_request</span><span class="p">,</span>
		    <span class="n">smid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span><span class="p">))</span>
		<span class="n">mpt2sas_base_put_smid_scsi_io</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">_scsih_qcmd</span><span class="p">)</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_normalize_sense - normalize descriptor and fixed format sense data</span>
<span class="cm"> * @sense_buffer: sense data returned by target</span>
<span class="cm"> * @data: normalized skey/asc/ascq</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">_scsih_normalize_sense</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sense_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x72</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* descriptor format */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">skey</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* fixed format */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">skey</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">=</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_scsi_ioc_info - translated non-successful SCSI_IO request</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> * @mpi_reply: reply mf payload returned from firmware</span>
<span class="cm"> *</span>
<span class="cm"> * scsi_status - SCSI Status code returned from target device</span>
<span class="cm"> * scsi_state - state info associated with SCSI_IO determined by ioc</span>
<span class="cm"> * ioc_status - ioc supplied status info</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_scsi_ioc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span>
    <span class="n">Mpi2SCSIIOReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">response_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">response_bytes</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scsi_state</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIState</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scsi_status</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc_scsi_state</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tmp_string</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">log_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">priv_target</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">device_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv_target</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">device_str</span> <span class="o">=</span> <span class="s">&quot;WarpDrive&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">device_str</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log_info</span> <span class="o">==</span> <span class="mh">0x31170000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_FUNCTION</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;invalid function&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RECOVERED_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi recovered error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_INVALID_DEVHANDLE</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi invalid dev handle&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi device not there&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_OVERRUN</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi data overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi data underrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi io data error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi protocol error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_TERMINATED</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi task terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi residual mismatch&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi task mgmt failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IOC_TERMINATED</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi ioc terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_EXT_TERMINATED</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;scsi ext terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_GUARD_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;eedp guard error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_REF_TAG_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;eedp ref tag error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_APP_TAG_ERROR</span>:
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;eedp app tag error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc_ioc_state</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scsi_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_GOOD</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;good&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_CHECK_CONDITION</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;check condition&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_CONDITION_MET</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;condition met&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_BUSY</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;busy&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_INTERMEDIATE</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;intermediate&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_INTERMEDIATE_CONDMET</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;intermediate condmet&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_RESERVATION_CONFLICT</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;reservation conflict&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_COMMAND_TERMINATED</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;command terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_TASK_SET_FULL</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;task set full&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_ACA_ACTIVE</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;aca active&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SCSI_STATUS_TASK_ABORTED</span>:
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;task aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc_scsi_status</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc_scsi_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_state</span><span class="p">)</span>
		<span class="n">desc_scsi_state</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_RESPONSE_INFO_VALID</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">desc_scsi_state</span><span class="p">,</span> <span class="s">&quot;response info &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_TERMINATED</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">desc_scsi_state</span><span class="p">,</span> <span class="s">&quot;state terminated &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">desc_scsi_state</span><span class="p">,</span> <span class="s">&quot;no status &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_FAILED</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">desc_scsi_state</span><span class="p">,</span> <span class="s">&quot;autosense failed &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">desc_scsi_state</span><span class="p">,</span> <span class="s">&quot;autosense valid &quot;</span><span class="p">);</span>

	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%s wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">device_str</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">priv_target</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">sas_address(0x%016llx), &quot;</span>
			    <span class="s">&quot;phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span>
			    <span class="s">&quot;</span><span class="se">\t</span><span class="s">enclosure_logical_id(0x%016llx), slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle(0x%04x), ioc_status(%s)(0x%04x), &quot;</span>
	    <span class="s">&quot;smid(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">),</span>
	    <span class="n">desc_ioc_state</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">request_len(%d), underflow(%d), &quot;</span>
	    <span class="s">&quot;resid(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">),</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">,</span>
	    <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">scmd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">tag(%d), transfer_count(%d), &quot;</span>
	    <span class="s">&quot;sc-&gt;result(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TaskTag</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TransferCount</span><span class="p">),</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">scsi_status(%s)(0x%02x), &quot;</span>
	    <span class="s">&quot;scsi_state(%s)(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc_scsi_status</span><span class="p">,</span>
	    <span class="n">scsi_status</span><span class="p">,</span> <span class="n">desc_scsi_state</span><span class="p">,</span> <span class="n">scsi_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sense_info</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">_scsih_normalize_sense</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[sense_key,asc,ascq]: &quot;</span>
		    <span class="s">&quot;[0x%02x,0x%02x,0x%02x], count(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">skey</span><span class="p">,</span>
		    <span class="n">data</span><span class="p">.</span><span class="n">asc</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">ascq</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SenseCount</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_RESPONSE_INFO_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">response_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">);</span>
		<span class="n">response_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">response_info</span><span class="p">;</span>
		<span class="n">_scsih_response_code</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">response_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_turn_on_fault_led - illuminate Fault LED</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * Context: process</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_turn_on_fault_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SepReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SepRequest_t</span> <span class="n">mpi_request</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SCSI_ENCLOSURE_PROCESSOR</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI2_SEP_REQ_ACTION_WRITE_STATUS</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">SlotStatus</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MPI2_SEP_REQ_SLOTSTATUS_PREDICTED_FAULT</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">MPI2_SEP_REQ_FLAGS_DEVHANDLE_ADDRESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_base_scsi_enclosure_processor</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span> <span class="o">||</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;enclosure_processor: &quot;</span>
		    <span class="s">&quot;ioc_status (0x%04x), loginfo(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_send_event_to_turn_on_fault_led - fire delayed event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * Context: interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_send_event_to_turn_on_fault_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>

	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">MPT2SAS_TURN_ON_FAULT_LED</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">device_handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_smart_predicted_fault - process smart errors</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * Context: interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_smart_predicted_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="n">Mpi2EventNotificationReply_t</span> <span class="o">*</span><span class="n">event_reply</span><span class="p">;</span>
	<span class="n">Mpi2EventDataSasDeviceStatusChange_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* only handle non-raid devices */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">starget</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
	<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">((</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;predicted fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">)</span>
		<span class="n">_scsih_send_event_to_turn_on_fault_led</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="cm">/* insert into event log */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2EventNotificationReply_t</span><span class="p">,</span> <span class="n">EventData</span><span class="p">)</span> <span class="o">+</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventDataSasDeviceStatusChange_t</span><span class="p">);</span>
	<span class="n">event_reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_EVENT_NOTIFICATION</span><span class="p">;</span>
	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE</span><span class="p">);</span>
	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">=</span> <span class="n">sz</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">EventDataLength</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventDataSasDeviceStatusChange_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">event_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventDataSasDeviceStatusChange_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">;</span>
	<span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_SMART_DATA</span><span class="p">;</span>
	<span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ASC</span> <span class="o">=</span> <span class="mh">0x5D</span><span class="p">;</span>
	<span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">event_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpt2sas_ctl_add_to_event_log</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">event_reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">event_reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_io_done - scsi request callback</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Callback handler when using _scsih_qcmd.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_io_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SCSIIORequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SCSIIOReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xfer_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scsi_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">log_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">response_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="n">scmd</span> <span class="o">=</span> <span class="n">_scsih_scsi_lookup_get_clear</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span> <span class="o">||</span>
	     <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * WARPDRIVE: If direct_io is set then it is directIO,</span>
<span class="cm">	 * the failed direct I/O should be redirected to volume</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_scsi_direct_io_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">ioc_status</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_TERMINATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">scmd</span><span class="p">;</span>
		<span class="n">_scsih_scsi_direct_io_set</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">.</span><span class="n">CDB32</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
		<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">DevHandle</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">mpt2sas_base_put_smid_scsi_io</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
		    <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* turning off TLR */</span>
	<span class="n">scsi_state</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIState</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_RESPONSE_INFO_VALID</span><span class="p">)</span>
		<span class="n">response_code</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">tlr_snoop_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">tlr_snoop_check</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Make sure Device is not raid volume.</span>
<span class="cm">	 * We do not expose raid functionality to upper layer for warpdrive.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_scsih_is_raid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sdev_gendev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">sas_is_tlr_enabled</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">response_code</span> <span class="o">==</span> <span class="n">MPI2_SCSITASKMGMT_RSP_INVALID_FRAME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_disable_tlr</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;TLR disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xfer_cnt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TransferCount</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">xfer_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE</span><span class="p">)</span>
		<span class="n">log_info</span> <span class="o">=</span>  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">log_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_status</span> <span class="o">&amp;=</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_UNDERRUN</span> <span class="o">&amp;&amp;</span> <span class="n">xfer_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI2_SCSI_STATUS_BUSY</span> <span class="o">||</span>
	     <span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI2_SCSI_STATUS_RESERVATION_CONFLICT</span> <span class="o">||</span>
	     <span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI2_SCSI_STATUS_TASK_SET_FULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sense_info</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sense_data</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_sense_buffer</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">smid</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SenseCount</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">_scsih_normalize_sense</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="cm">/* failure prediction threshold exceeded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x5D</span><span class="p">)</span>
			<span class="n">_scsih_smart_predicted_fault</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_BUSY</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INSUFFICIENT_RESOURCES</span>:
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IOC_TERMINATED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TRANSPORT_DISRUPTED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_TERMINATED</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_EXT_TERMINATED</span>:
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">xfer_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&gt;</span> <span class="n">xfer_cnt</span><span class="p">))</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xfer_cnt</span> <span class="o">&lt;</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">SAM_STAT_BUSY</span><span class="p">)</span>
				<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPI2_SCSI_STATE_AUTOSENSE_FAILED</span> <span class="o">|</span>
		     <span class="n">MPI2_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">))</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_TERMINATED</span><span class="p">)</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfer_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REPORT_LUNS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">=</span> <span class="n">MPI2_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">;</span>
			<span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DRIVER_SENSE</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">;</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_OVERRUN</span>:
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RECOVERED_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span>:
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">response_code</span> <span class="o">==</span>
		    <span class="n">MPI2_SCSITASKMGMT_RSP_INVALID_FRAME</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPI2_SCSI_STATE_AUTOSENSE_FAILED</span> <span class="o">|</span>
		     <span class="n">MPI2_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">)))</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI2_SCSI_STATE_TERMINATED</span><span class="p">)</span>
			<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_GUARD_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_REF_TAG_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_APP_TAG_ERROR</span>:
		<span class="n">_scsih_eedp_error_handling</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_FUNCTION</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_SGL</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INTERNAL_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_FIELD</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_STATE</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>:
	<span class="nl">default:</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_REPLY</span><span class="p">))</span>
		<span class="n">_scsih_scsi_ioc_info</span><span class="p">(</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">scmd</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
<span class="cp">#endif</span>

 <span class="nl">out:</span>
	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_host_refresh - refreshing sas host object contents</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * Context: user</span>
<span class="cm"> *</span>
<span class="cm"> * During port enable, fw will send topology events for every device. Its</span>
<span class="cm"> * possible that the handles may change from the previous setting, so this</span>
<span class="cm"> * code keeping handles updating if changed.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_host_refresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasIOUnitPage0_t</span> <span class="o">*</span><span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">attached_handle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_rate</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
	    <span class="s">&quot;updating handles for sas_host(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">));</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage0_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span>
	    <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit0PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg0</span><span class="p">,</span> <span class="n">sz</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_rate</span> <span class="o">=</span> <span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NegotiatedLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span>
			    <span class="n">PhyData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ControllerDevHandle</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">attached_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
		    <span class="n">AttachedDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attached_handle</span> <span class="o">&amp;&amp;</span> <span class="n">link_rate</span> <span class="o">&lt;</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">)</span>
			<span class="n">link_rate</span> <span class="o">=</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">;</span>
		<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">attached_handle</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_host_add - create sas host object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Creating host side data object, stored in ioc-&gt;sas_hba</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_host_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasIOUnitPage0_t</span> <span class="o">*</span><span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2SasIOUnitPage1_t</span> <span class="o">*</span><span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2SasPhyPage0_t</span> <span class="n">phy_pg0</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2SasEnclosurePage0_t</span> <span class="n">enclosure_pg0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_missing_delay</span><span class="p">;</span>

	<span class="n">mpt2sas_config_get_number_hba_phys</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sas_iounit page 0 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage0_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit0PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg0</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sas_iounit page 1 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage1_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit1PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg1</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">io_missing_delay</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">IODeviceMissingDelay</span><span class="p">);</span>
	<span class="n">device_missing_delay</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">ReportDeviceMissingDelay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_UNIT_16</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">=</span> <span class="n">device_missing_delay</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">parent_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_sas_phy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_phy_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_pg0</span><span class="p">,</span>
		    <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span>
			    <span class="n">PhyData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ControllerDevHandle</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mpt2sas_transport_add_host_phy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		    <span class="n">phy_pg0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">parent_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">enclosure_handle</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">EnclosureHandle</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;host_add: handle(0x%04x), &quot;</span>
	    <span class="s">&quot;sas_addr(0x%016llx), phys(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">enclosure_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_enclosure_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">enclosure_pg0</span><span class="p">,</span>
		   <span class="n">MPI2_SAS_ENCLOS_PGAD_FORM_HANDLE</span><span class="p">,</span>
		   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">enclosure_handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">enclosure_logical_id</span> <span class="o">=</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">enclosure_pg0</span><span class="p">.</span><span class="n">EnclosureLogicalID</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_expander_add -  creating expander object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: expander handle</span>
<span class="cm"> *</span>
<span class="cm"> * Creating expander object, stored in ioc-&gt;sas_expander_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_expander_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2ExpanderPage0_t</span> <span class="n">expander_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ExpanderPage1_t</span> <span class="n">expander_pg1</span><span class="p">;</span>
	<span class="n">Mpi2SasEnclosurePage0_t</span> <span class="n">enclosure_pg0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parent_handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">sas_address_parent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expander_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_EXPAND_PGAD_FORM_HNDL</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle out of order topology events */</span>
	<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_address_parent</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_address_parent</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">sas_address_parent</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">_scsih_expander_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
	<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_sas_node</span><span class="p">),</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">expander_pg0</span><span class="p">.</span><span class="n">NumPhys</span><span class="p">;</span>
	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span> <span class="o">=</span> <span class="n">sas_address_parent</span><span class="p">;</span>
	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;expander_add: handle(0x%04x),&quot;</span>
	    <span class="s">&quot; parent(0x%04x), sas_addr(0x%016llx), phys(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">handle</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_sas_phy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">);</span>
	<span class="n">mpt2sas_port</span> <span class="o">=</span> <span class="n">mpt2sas_transport_port_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	    <span class="n">sas_address_parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">parent_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_expander_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">expander_pg1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_transport_add_expander_phy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">expander_pg1</span><span class="p">,</span>
		    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_enclosure_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">enclosure_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_ENCLOS_PGAD_FORM_HANDLE</span><span class="p">,</span>
		   <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span> <span class="o">=</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">enclosure_pg0</span><span class="p">.</span><span class="n">EnclosureLogicalID</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_scsih_expander_node_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="p">);</span>
	 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_fail:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">)</span>
		<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">sas_address_parent</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_done -  scsih callback handler.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Callback handler when sending internal generated message frames.</span>
<span class="cm"> * The callback index passed is `ioc-&gt;scsih_cb_idx`</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span>  <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">!=</span> <span class="n">smid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_expander_remove - removing expander object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: expander sas_address</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_expander_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="p">)</span>
		<span class="n">_scsih_expander_node_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_check_access_status - check access flags</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * @handle: sas device handle</span>
<span class="cm"> * @access_flags: errors returned during discovery of the device</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 for success, else failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_scsih_check_access_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span>
   <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">access_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">access_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_NO_ERRORS</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SATA_NEEDS_INITIALIZATION</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SATA_CAPABILITY_FAILED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;sata capability failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SATA_AFFILIATION_CONFLICT</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;sata affiliation conflict&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_ROUTE_NOT_ADDRESSABLE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;route not addressable&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SMP_ERROR_NOT_ADDRESSABLE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;smp error not addressable&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_DEVICE_BLOCKED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;device blocked&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SATA_INIT_FAILED</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_UNKNOWN</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_AFFILIATION_CONFLICT</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_DIAG</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_IDENTIFICATION</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_CHECK_POWER</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_PIO_SN</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_MDMA_SN</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_UDMA_SN</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_ZONING_VIOLATION</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_NOT_ADDRESSABLE</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE0_ASTATUS_SIF_MAX</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;sata initialization failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;discovery errors(%s): sas_address(0x%016llx), &quot;</span>
	    <span class="s">&quot;handle(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_check_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* check if this is end device */</span>
	<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_scsih_is_end_device</span><span class="p">(</span><span class="n">device_info</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;device is not present &quot;</span>
		    <span class="s">&quot;handle(0x%04x), no sas_device!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">starget</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
		<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="s">&quot;handle changed from(0x%04x)&quot;</span>
		   <span class="s">&quot; to (0x%04x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if device is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;device is not present &quot;</span>
		    <span class="s">&quot;handle(0x%04x), flags!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if there were any issues with discovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_check_access_status</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	    <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">AccessStatus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_scsih_ublock_io_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_add_device -  creating sas device object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: sas device handle</span>
<span class="cm"> * @phy_num: phy number end device attached to</span>
<span class="cm"> * @is_pd: is this hidden raid component</span>
<span class="cm"> *</span>
<span class="cm"> * Creating end device object, stored in ioc-&gt;sas_device_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2SasEnclosurePage0_t</span> <span class="n">enclosure_pg0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>

	<span class="cm">/* check if device is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;Flags = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if there were any issues with discovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_check_access_status</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	    <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">AccessStatus</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check if this is end device */</span>
	<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_scsih_is_end_device</span><span class="p">(</span><span class="n">device_info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_sas_device</span><span class="p">),</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">le16_to_cpu</span>
		<span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">EnclosureHandle</span><span class="p">);</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Slot</span><span class="p">);</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">=</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">;</span>

	<span class="cm">/* get enclosure_logical_id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_enclosure_pg0</span><span class="p">(</span>
	   <span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enclosure_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_ENCLOS_PGAD_FORM_HANDLE</span><span class="p">,</span>
	   <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span><span class="p">)))</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span> <span class="o">=</span>
		    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">enclosure_pg0</span><span class="p">.</span><span class="n">EnclosureLogicalID</span><span class="p">);</span>

	<span class="cm">/* get device name */</span>
	<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">device_name</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceName</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span><span class="p">)</span>
		<span class="n">_scsih_sas_device_init_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_scsih_sas_device_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_remove_device -  removing sas device object</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_device_delete: the sas_device object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: enter: &quot;</span>
	    <span class="s">&quot;handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">_scsih_ublock_io_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span>
		     <span class="n">MPT2SAS_INVALID_DEVICE_HANDLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span><span class="p">)</span>
		<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing handle(0x%04x), sas_addr&quot;</span>
	    <span class="s">&quot;(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: exit: &quot;</span>
	    <span class="s">&quot;handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_device_remove_by_handle - removing device object by handle</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_device_remove_by_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="n">_scsih_remove_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_device_remove_by_sas_address - removing device object by sas address</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: device sas_address</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_device_remove_by_sas_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="n">_scsih_remove_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_topology_change_event_debug - debug for topology event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: event data payload</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_topology_change_event_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_number</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">status_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_rate</span><span class="p">,</span> <span class="n">prev_link_rate</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_ADDED</span>:
		<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;add&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_NOT_RESPONDING</span>:
		<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;remove&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_RESPONDING</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">status_str</span> <span class="o">=</span>  <span class="s">&quot;responding&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_DELAY_NOT_RESPONDING</span>:
		<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;remove delay&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;unknown status&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sas topology change: (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status_str</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle(0x%04x), enclosure_handle(0x%04x) &quot;</span>
	    <span class="s">&quot;start_phy(%02d), count(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpanderDevHandle</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">EnclosureHandle</span><span class="p">),</span>
	    <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">StartPhyNum</span><span class="p">,</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">phy_number</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">StartPhyNum</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">reason_code</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyStatus</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_RC_MASK</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_ADDED</span>:
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;target add&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_NOT_RESPONDING</span>:
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;target remove&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_DELAY_NOT_RESPONDING</span>:
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;delay target remove&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_PHY_CHANGED</span>:
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;link rate change&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_NO_CHANGE</span>:
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;target responding&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status_str</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">link_rate</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">LinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">prev_link_rate</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">LinkRate</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">phy(%02d), attached_handle(0x%04x): %s:&quot;</span>
		    <span class="s">&quot; link rate: new(0x%02x), old(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_number</span><span class="p">,</span>
		    <span class="n">handle</span><span class="p">,</span> <span class="n">status_str</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">,</span> <span class="n">prev_link_rate</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_topology_change_event - handle topology changes</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_topology_change_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_number</span><span class="p">,</span> <span class="n">max_phys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_rate</span><span class="p">,</span> <span class="n">prev_link_rate</span><span class="p">;</span>
	<span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span>
		<span class="n">_scsih_sas_topology_change_event_debug</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span>
		<span class="n">_scsih_sas_host_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_scsih_sas_host_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;ignoring expander &quot;</span>
		    <span class="s">&quot;event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpanderDevHandle</span><span class="p">);</span>

	<span class="cm">/* handle expander add */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_ADDED</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_expander_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_expander</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">parent_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">max_phys</span> <span class="o">=</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent_handle</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">max_phys</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle siblings events */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;ignoring &quot;</span>
			    <span class="s">&quot;expander event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">phy_number</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">StartPhyNum</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_number</span> <span class="o">&gt;=</span> <span class="n">max_phys</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">reason_code</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyStatus</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_RC_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyStatus</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_PHYSTATUS_VACANT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reason_code</span> <span class="o">!=</span>
		    <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_NOT_RESPONDING</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">link_rate</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">LinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">prev_link_rate</span> <span class="o">=</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PHY</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">LinkRate</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reason_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_PHY_CHANGED</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">==</span> <span class="n">prev_link_rate</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">,</span> <span class="n">phy_number</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">&lt;</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">_scsih_check_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_ADDED</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">,</span> <span class="n">phy_number</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>

			<span class="n">_scsih_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">phy_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPO_RC_TARG_NOT_RESPONDING</span>:

			<span class="n">_scsih_device_remove_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* handle expander removal */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ExpStatus</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_TOPO_ES_NOT_RESPONDING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sas_expander</span><span class="p">)</span>
		<span class="n">mpt2sas_expander_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_status_change_event_debug - debug for device event</span>
<span class="cm"> * @event_data: event data payload</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_device_status_change_event_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataSasDeviceStatusChange_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reason_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_SMART_DATA</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;smart data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_UNSUPPORTED</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;unsupported device discovered&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal device reset&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_TASK_ABORT_INTERNAL</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal task abort&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_ABORT_TASK_SET_INTERNAL</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal task abort set&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_CLEAR_TASK_SET_INTERNAL</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal clear task set&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_QUERY_TASK_INTERNAL</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal query task&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_SATA_INIT_FAILURE</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;sata init failure&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_CMP_INTERNAL_DEV_RESET</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal device reset complete&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_CMP_TASK_ABORT_INTERNAL</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal task abort complete&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_ASYNC_NOTIFICATION</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;internal async notification&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_EXPANDER_REDUCED_FUNCTIONALITY</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;expander reduced functionality&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_CMP_EXPANDER_REDUCED_FUNCTIONALITY</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;expander reduced functionality complete&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;unknown reason&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;device status change: (%s)</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle(0x%04x), sas address(0x%016llx), tag(%d)&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reason_str</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">),</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">TaskTag</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_SMART_DATA</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;, ASC(0x%x), ASCQ(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ASC</span><span class="p">,</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ASCQ</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_device_status_change_event - handle device status change</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_device_status_change_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">Mpi2EventDataSasDeviceStatusChange_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span>
	    <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span>
		<span class="n">_scsih_sas_device_status_change_event_debug</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		     <span class="n">event_data</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* In MPI Revision K (0xC), the internal device reset complete was</span>
<span class="cm">	 * implemented, so avoid setting tm_busy flag for older firmware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">HeaderVersion</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span>
	    <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span> <span class="o">&amp;&amp;</span>
	   <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span>
	    <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_CMP_INTERNAL_DEV_RESET</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target_priv_data</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_priv_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
	    <span class="n">MPI2_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span><span class="p">)</span>
		<span class="n">target_priv_data</span><span class="o">-&gt;</span><span class="n">tm_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">target_priv_data</span><span class="o">-&gt;</span><span class="n">tm_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_enclosure_dev_status_change_event_debug - debug for enclosure event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: event data payload</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_enclosure_dev_status_change_event_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataSasEnclDevStatusChange_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reason_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_ENCL_RC_ADDED</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;enclosure add&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_ENCL_RC_NOT_RESPONDING</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;enclosure remove&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;unknown reason&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;enclosure status change: (%s)</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle(0x%04x), enclosure logical id(0x%016llx)&quot;</span>
	    <span class="s">&quot; number slots(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reason_str</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">EnclosureHandle</span><span class="p">),</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">EnclosureLogicalID</span><span class="p">),</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">StartSlot</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_enclosure_dev_status_change_event - handle enclosure events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_enclosure_dev_status_change_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span>
		<span class="n">_scsih_sas_enclosure_dev_status_change_event_debug</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		     <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_broadcast_primitive_event - handle broadcast events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_broadcast_primitive_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">termination_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">query_count</span><span class="p">;</span>
	<span class="n">Mpi2SCSITaskManagementReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2EventDataSasBroadcastPrimitive_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">task_abort_retries</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: enter: phy number(%d), &quot;</span>
	    <span class="s">&quot;width(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PhyNum</span><span class="p">,</span>
	     <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PortWidth</span><span class="p">));</span>

	<span class="n">_scsih_block_io_all_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
<span class="nl">broadcast_aen_retry:</span>

	<span class="cm">/* sanity checks for retrying this loop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_retries</span><span class="o">++</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_retries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: %d retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">termination_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">query_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">smid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">smid</span> <span class="o">&lt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">smid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">scmd</span> <span class="o">=</span> <span class="n">_scsih_scsi_lookup_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scmd</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device_priv_data</span> <span class="o">||</span> <span class="o">!</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		 <span class="cm">/* skip hidden raid components */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		 <span class="cm">/* skip volumes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">MPT_TARGET_FLAGS_VOLUME</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
		<span class="n">query_count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
		    <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_QUERY_TASK</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">TM_MUTEX_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;mpt2sas_scsih_issue_tm: FAILED when sending &quot;</span>
			    <span class="s">&quot;QUERY_TASK: scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">broadcast_aen_retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;query task: FAILED &quot;</span>
			    <span class="s">&quot;with IOCSTATUS(0x%04x), scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span>
			    <span class="n">scmd</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">broadcast_aen_retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* see if IO is still owned by IOC and target */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span> <span class="o">==</span>
		     <span class="n">MPI2_SCSITASKMGMT_RSP_TM_SUCCEEDED</span> <span class="o">||</span>
		     <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span> <span class="o">==</span>
		     <span class="n">MPI2_SCSITASKMGMT_RSP_IO_QUEUED_ON_IOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">task_abort_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">tm_retry:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task_abort_retries</span><span class="o">++</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
			    <span class="s">&quot;%s: ABORT_TASK: giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">));</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">broadcast_aen_retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_no_lock</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">MPI2_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
		    <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">,</span> <span class="n">TM_MUTEX_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;mpt2sas_scsih_issue_tm: ABORT_TASK: FAILED : &quot;</span>
			    <span class="s">&quot;scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">tm_retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">task_abort_retries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
			    <span class="s">&quot;mpt2sas_scsih_issue_tm: ABORT_TASK: RETRIES (%d):&quot;</span>
			    <span class="s">&quot; scmd(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">task_abort_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scmd</span><span class="p">);</span>

		<span class="n">termination_count</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: loop back due to&quot;</span>
		     <span class="s">&quot; pending AEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="k">goto</span> <span class="n">broadcast_aen_retry</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="nl">out_no_lock:</span>

	<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
	    <span class="s">&quot;%s - exit, query_count = %d termination_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">query_count</span><span class="p">,</span> <span class="n">termination_count</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="n">_scsih_ublock_io_all_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_discovery_event - handle discovery events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_discovery_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventDataSasDiscovery_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;discovery event: (%s)&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_DISC_RC_STARTED</span><span class="p">)</span> <span class="o">?</span>
		    <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;discovery_status(0x%08x)&quot;</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_DISC_RC_STARTED</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span>
		<span class="n">_scsih_sas_host_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_reprobe_lun - reprobing lun</span>
<span class="cm"> * @sdev: scsi device struct</span>
<span class="cm"> * @no_uld_attach: sdev-&gt;no_uld_attach flag setting</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_reprobe_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">no_uld_attach</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="n">no_uld_attach</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;%s raid component</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">?</span> <span class="s">&quot;hidding&quot;</span> <span class="o">:</span> <span class="s">&quot;exposing&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_device_reprobe</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_volume_add - add new volume</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @element: IR config element data</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_volume_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">wwid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mpt2sas_config_get_volume_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wwid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wwid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
		    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">wwid</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_raid_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
		    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_id</span><span class="o">++</span><span class="p">;</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">RAID_CHANNEL</span><span class="p">;</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span> <span class="o">=</span> <span class="n">wwid</span><span class="p">;</span>
	<span class="n">_scsih_raid_device_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="n">RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">_scsih_raid_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">_scsih_determine_boot_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_volume_delete - delete volume</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: volume device handle</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_volume_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing handle(0x%04x), wwid&quot;</span>
		    <span class="s">&quot;(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">raid_device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span>
		<span class="n">scsi_remove_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_pd_expose - expose pd component to /dev/sdX</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @element: IR config element data</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_pd_expose</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_wwid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* exposing raid component */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span>
		<span class="n">starget_for_each_device</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_scsih_reprobe_lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_pd_hide - hide pd component from /dev/sdX</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @element: IR config element data</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_pd_hide</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">volume_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">volume_wwid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mpt2sas_config_get_volume_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_handle</span><span class="p">)</span>
		<span class="n">mpt2sas_config_get_volume_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">volume_handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">volume_wwid</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_handle</span> <span class="o">=</span> <span class="n">volume_handle</span><span class="p">;</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">volume_wwid</span> <span class="o">=</span> <span class="n">volume_wwid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* hiding raid component */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span>
		<span class="n">starget_for_each_device</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">_scsih_reprobe_lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_pd_delete - delete pd component</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @element: IR config element data</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_pd_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>

	<span class="n">_scsih_device_remove_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_pd_add - remove pd component</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @element: IR config element data</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_pd_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parent_handle</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_address</span><span class="p">))</span>
		<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">,</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">);</span>

	<span class="n">_scsih_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_config_change_event_debug - debug for IR Config Change events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: event data payload</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_config_change_event_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataIrConfigChangeList_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">element_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reason_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">element_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ConfigElement</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;raid config change: (%s), elements(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_EVENT_IR_CHANGE_FLAGS_FOREIGN_CONFIG</span><span class="p">)</span> <span class="o">?</span>
	    <span class="s">&quot;foreign&quot;</span> <span class="o">:</span> <span class="s">&quot;native&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">element</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_ADDED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;add&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_REMOVED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;remove&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_NO_CHANGE</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;no change&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_HIDE</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;hide&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_UNHIDE</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;unhide&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_VOLUME_CREATED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;volume_created&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_VOLUME_DELETED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;volume_deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_PD_CREATED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;pd_created&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_PD_DELETED</span>:
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;pd_deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;unknown reason&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">element_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ElementFlags</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_EVENT_IR_CHANGE_EFLAGS_ELEMENT_TYPE_MASK</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">element_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_EFLAGS_VOLUME_ELEMENT</span>:
			<span class="n">element_str</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_EFLAGS_VOLPHYSDISK_ELEMENT</span>:
			<span class="n">element_str</span> <span class="o">=</span> <span class="s">&quot;phys disk&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_EFLAGS_HOTSPARE_ELEMENT</span>:
			<span class="n">element_str</span> <span class="o">=</span> <span class="s">&quot;hot spare&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">element_str</span> <span class="o">=</span> <span class="s">&quot;unknown element&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(%s:%s), vol handle(0x%04x), &quot;</span>
		    <span class="s">&quot;pd handle(0x%04x), pd num(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">element_str</span><span class="p">,</span>
		    <span class="n">reason_str</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">),</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">),</span>
		    <span class="n">element</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_config_change_event - handle ir configuration change events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_config_change_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">foreign_config</span><span class="p">;</span>
	<span class="n">Mpi2EventDataIrConfigChangeList_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">_scsih_sas_ir_config_change_event_debug</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>

<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">foreign_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_EVENT_IR_CHANGE_FLAGS_FOREIGN_CONFIG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ConfigElement</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NumElements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">element</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_VOLUME_CREATED</span>:
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_ADDED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">foreign_config</span><span class="p">)</span>
				<span class="n">_scsih_sas_volume_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_VOLUME_DELETED</span>:
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_REMOVED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">foreign_config</span><span class="p">)</span>
				<span class="n">_scsih_sas_volume_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_PD_CREATED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
				<span class="n">_scsih_sas_pd_hide</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_PD_DELETED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
				<span class="n">_scsih_sas_pd_expose</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_HIDE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
				<span class="n">_scsih_sas_pd_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_UNHIDE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
				<span class="n">_scsih_sas_pd_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_volume_event - IR volume event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_volume_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">wwid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">Mpi2EventDataIrVolume_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_IR_VOLUME_RC_STATE_CHANGED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NewValue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: handle(0x%04x), &quot;</span>
		    <span class="s">&quot;old(0x%08x), new(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">handle</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PreviousValue</span><span class="p">),</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_MISSING</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_FAILED</span>:
		<span class="n">_scsih_sas_volume_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_ONLINE</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_DEGRADED</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_OPTIMAL</span>:

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mpt2sas_config_get_volume_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wwid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wwid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_raid_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_id</span><span class="o">++</span><span class="p">;</span>
		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">RAID_CHANNEL</span><span class="p">;</span>
		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span> <span class="o">=</span> <span class="n">wwid</span><span class="p">;</span>
		<span class="n">_scsih_raid_device_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="n">RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">_scsih_raid_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_RAID_VOL_STATE_INITIALIZING</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_physical_disk_event - PD event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_physical_disk_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">Mpi2EventDataIrPhysicalDisk_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">!=</span> <span class="n">MPI2_EVENT_IR_PHYSDISK_RC_STATE_CHANGED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PhysDiskDevHandle</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">NewValue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: handle(0x%04x), &quot;</span>
		    <span class="s">&quot;old(0x%08x), new(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">handle</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PreviousValue</span><span class="p">),</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_ONLINE</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_DEGRADED</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_REBUILDING</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_OPTIMAL</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_HOT_SPARE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span>
		    <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_address</span><span class="p">))</span>
			<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			    <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">,</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">);</span>

		<span class="n">_scsih_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_OFFLINE</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_NOT_CONFIGURED</span>:
	<span class="k">case</span> <span class="n">MPI2_RAID_PD_STATE_NOT_COMPATIBLE</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_operation_status_event_debug - debug for IR op event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event_data: event data payload</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_operation_status_event_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventDataIrOperationStatus_t</span> <span class="o">*</span><span class="n">event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reason_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">RAIDOperation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_RAIDOP_RESYNC</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;resync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_RAIDOP_ONLINE_CAP_EXPANSION</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;online capacity expansion&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_RAIDOP_CONSISTENCY_CHECK</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;consistency check&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_RAIDOP_BACKGROUND_INIT</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;background init&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_RAIDOP_MAKE_DATA_CONSISTENT</span>:
		<span class="n">reason_str</span> <span class="o">=</span> <span class="s">&quot;make data consistent&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reason_str</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;raid operational status: (%s)&quot;</span>
	    <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle(0x%04x), percent complete(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reason_str</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">),</span>
	    <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PercentComplete</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_sas_ir_operation_status_event - handle RAID operation events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fw_event: The fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_sas_ir_operation_status_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventDataIrOperationStatus_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENT_WORK_TASK</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">_scsih_sas_ir_operation_status_event_debug</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		     <span class="n">event_data</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* code added for raid transport support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">RAIDOperation</span> <span class="o">==</span> <span class="n">MPI2_EVENT_IR_RAIDOP_RESYNC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">VolDevHandle</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">percent_complete</span> <span class="o">=</span>
			    <span class="n">event_data</span><span class="o">-&gt;</span><span class="n">PercentComplete</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_prep_device_scan - initialize parameters prior to device scan</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Set the deleted flag prior to device scan.  If the device is found during</span>
<span class="cm"> * the scan, then we clear the deleted flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_prep_device_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_DEVICE</span> <span class="o">*</span><span class="n">sas_device_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_device_priv_data</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device_priv_data</span> <span class="o">&amp;&amp;</span> <span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="p">)</span>
			<span class="n">sas_device_priv_data</span><span class="o">-&gt;</span><span class="n">sas_target</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_mark_responding_sas_device - mark a sas_devices as responding</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * @slot: enclosure slot id</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * Used in _scsi_remove_unresponsive_sas_devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_mark_responding_sas_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span>
    <span class="n">u16</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span> <span class="o">&amp;&amp;</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">tm_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span>
				<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span>
				    <span class="s">&quot;handle(0x%04x), sas_addr(0x%016llx), &quot;</span>
				    <span class="s">&quot;enclosure logical id(0x%016llx), &quot;</span>
				    <span class="s">&quot;slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
				    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">,</span>
				    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle changed from(0x%04x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="p">)</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_search_responding_sas_devices -</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * If not remove.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_search_responding_sas_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for end-devices: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span>
	    <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_scsih_is_end_device</span><span class="p">(</span><span class="n">device_info</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">Slot</span><span class="p">);</span>
		<span class="n">_scsih_mark_responding_sas_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		    <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for end-devices: complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_mark_responding_raid_device - mark a raid_device as responding</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @wwid: world wide identifier for raid volume</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * Used in _scsi_remove_unresponsive_raid_devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_mark_responding_raid_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">wwid</span><span class="p">,</span>
    <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span> <span class="o">==</span> <span class="n">wwid</span> <span class="o">&amp;&amp;</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span> <span class="o">&amp;&amp;</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sas_target_priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">,</span>
			    <span class="s">&quot;handle(0x%04x), wwid(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * WARPDRIVE: The handles of the PDs might have changed</span>
<span class="cm">			 * across the host reset so re-initialize the</span>
<span class="cm">			 * required data for Direct IO</span>
<span class="cm">			 */</span>
			<span class="n">_scsih_init_warpdrive_properties</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span>
				    <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">handle changed from(0x%04x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_target_priv_data</span><span class="p">)</span>
				<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_search_responding_raid_devices -</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * If not remove.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_search_responding_raid_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidVolPage1_t</span> <span class="n">volume_pg1</span><span class="p">;</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="n">volume_pg0</span><span class="p">;</span>
	<span class="n">Mpi2RaidPhysDiskPage0_t</span> <span class="n">pd_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for raid volumes: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">volume_pg1</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">volume_pg1</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">volume_pg0</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_OPTIMAL</span> <span class="o">||</span>
		    <span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_ONLINE</span> <span class="o">||</span>
		    <span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_DEGRADED</span><span class="p">)</span>
			<span class="n">_scsih_mark_responding_raid_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">volume_pg1</span><span class="p">.</span><span class="n">WWID</span><span class="p">),</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* refresh the pd_handles */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_disk_num</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles_sz</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">pd_pg0</span><span class="p">,</span> <span class="n">MPI2_PHYSDISK_PGAD_FORM_GET_NEXT_PHYSDISKNUM</span><span class="p">,</span>
		    <span class="n">phys_disk_num</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">pd_pg0</span><span class="p">.</span><span class="n">PhysDiskNum</span><span class="p">;</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for responding raid volumes: &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_mark_responding_expander - mark a expander as responding</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address</span>
<span class="cm"> * @handle:</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * Used in _scsi_remove_unresponsive_expanders.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_mark_responding_expander</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span>
     <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">expander(0x%016llx): handle changed&quot;</span>
		    <span class="s">&quot; from(0x%04x) to (0x%04x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_search_responding_expanders -</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * After host reset, find out whether devices are still responding.</span>
<span class="cm"> * If not remove.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_search_responding_expanders</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ExpanderPage0_t</span> <span class="n">expander_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for expanders: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expander_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_EXPAND_PGAD_FORM_GET_NEXT_HNDL</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">expander present: handle(0x%04x), &quot;</span>
		    <span class="s">&quot;sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">_scsih_mark_responding_expander</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;search for expanders: complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_remove_unresponding_sas_devices - removing unresponding devices</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_remove_unresponding_sas_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">*</span><span class="n">sas_device_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">,</span> <span class="o">*</span><span class="n">sas_expander_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">raid_device_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">tmp_list</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing unresponding devices: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* removing unresponding end devices */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing unresponding devices: end-devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="n">sas_device_next</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">responding</span><span class="p">)</span>
			<span class="n">mpt2sas_device_remove_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* removing unresponding volumes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing unresponding devices: &quot;</span>
		    <span class="s">&quot;volumes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="n">raid_device_next</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">responding</span><span class="p">)</span>
				<span class="n">_scsih_sas_volume_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* removing unresponding expanders */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing unresponding devices: expanders</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">,</span> <span class="n">sas_expander_next</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">responding</span><span class="p">)</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">responding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">,</span> <span class="n">sas_expander_next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">_scsih_expander_node_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing unresponding devices: complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* unblock devices */</span>
	<span class="n">_scsih_ublock_io_all_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_refresh_expander_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ExpanderPage1_t</span> <span class="n">expander_pg1</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_expander_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">expander_pg1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_pg1</span><span class="p">.</span><span class="n">AttachedDevHandle</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
		    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">NegotiatedLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scan_for_devices_after_reset - scan for devices after host reset</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_scan_for_devices_after_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ExpanderPage0_t</span> <span class="n">expander_pg0</span><span class="p">;</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2RaidVolPage1_t</span> <span class="n">volume_pg1</span><span class="p">;</span>
	<span class="n">Mpi2RaidVolPage0_t</span> <span class="n">volume_pg0</span><span class="p">;</span>
	<span class="n">Mpi2RaidPhysDiskPage0_t</span> <span class="n">pd_pg0</span><span class="p">;</span>
	<span class="n">Mpi2EventIrConfigElement_t</span> <span class="n">element</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">expander_device</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;scan devices: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">_scsih_sas_host_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* expanders */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expander_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_EXPAND_PGAD_FORM_GET_NEXT_HNDL</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">expander_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span>
		    <span class="n">ioc</span><span class="p">,</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">expander_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">expander_device</span><span class="p">)</span>
			<span class="n">_scsih_refresh_expander_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">expander_device</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">_scsih_expander_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_to_sas</span><span class="p">;</span>

	<span class="cm">/* phys disk */</span>
	<span class="n">phys_disk_num</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">pd_pg0</span><span class="p">,</span> <span class="n">MPI2_PHYSDISK_PGAD_FORM_GET_NEXT_PHYSDISKNUM</span><span class="p">,</span>
	    <span class="n">phys_disk_num</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">pd_pg0</span><span class="p">.</span><span class="n">PhysDiskNum</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pd_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">_scsih_sas_device_find_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span>
		    <span class="n">handle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">sas_address</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">handle</span><span class="p">,</span> <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">,</span>
			    <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
			<span class="n">_scsih_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* volumes */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">volume_pg1</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">volume_pg1</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">_scsih_raid_device_find_by_wwid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">volume_pg1</span><span class="p">.</span><span class="n">WWID</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_get_raid_volume_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">volume_pg0</span><span class="p">,</span> <span class="n">MPI2_RAID_VOLUME_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidVolPage0_t</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_OPTIMAL</span> <span class="o">||</span>
		    <span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_ONLINE</span> <span class="o">||</span>
		    <span class="n">volume_pg0</span><span class="p">.</span><span class="n">VolumeState</span> <span class="o">==</span> <span class="n">MPI2_RAID_VOL_STATE_DEGRADED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">element</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventIrConfigElement_t</span><span class="p">));</span>
			<span class="n">element</span><span class="p">.</span><span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">MPI2_EVENT_IR_CHANGE_RC_ADDED</span><span class="p">;</span>
			<span class="n">element</span><span class="p">.</span><span class="n">VolDevHandle</span> <span class="o">=</span> <span class="n">volume_pg1</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">;</span>
			<span class="n">_scsih_sas_volume_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">element</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">skip_to_sas:</span>

	<span class="cm">/* sas devices */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span> <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span>
	    <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_scsih_is_end_device</span><span class="p">(</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">))))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">parent_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">ParentDevHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_scsih_get_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_address</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpt2sas_transport_update_links</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			    <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">,</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">);</span>
			<span class="n">_scsih_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;scan devices: complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_reset_handler - reset callback handler (for scsih)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @reset_phase: phase</span>
<span class="cm"> *</span>
<span class="cm"> * The handler for doing any required cleanup or initialization.</span>
<span class="cm"> *</span>
<span class="cm"> * The reset phase can be MPT2_IOC_PRE_RESET, MPT2_IOC_AFTER_RESET,</span>
<span class="cm"> * MPT2_IOC_DONE_RESET</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_scsih_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_AFTER_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_AFTER_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">_scsih_fw_event_cleanup_queue</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_flush_running_cmds</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_DONE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_DONE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">_scsih_sas_host_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_prep_device_scan</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_search_responding_sas_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_search_responding_raid_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_search_responding_expanders</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_scsih_prep_device_scan</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_search_responding_sas_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_search_responding_raid_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_search_responding_expanders</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_error_recovery_delete_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _firmware_event_work - delayed task for processing firmware events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @work: equal to the fw_event_work object</span>
<span class="cm"> * Context: user.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_firmware_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">,</span> <span class="n">delayed_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* the queue is being flushed so ignore this event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">cancel_pending_work</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_scsih_fw_event_free</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT2SAS_REMOVE_UNRESPONDING_DEVICES</span>:
		<span class="k">while</span> <span class="p">(</span><span class="n">scsi_host_in_recovery</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">)</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">_scsih_remove_unresponding_sas_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_scan_for_devices_after_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_PORT_ENABLE_COMPLETE</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



		<span class="n">dewtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: complete &quot;</span>
		    <span class="s">&quot;from worker thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_TURN_ON_FAULT_LED</span>:
		<span class="n">_scsih_turn_on_fault_led</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">device_handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span>:
		<span class="n">_scsih_sas_topology_change_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
		<span class="n">_scsih_sas_device_status_change_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DISCOVERY</span>:
		<span class="n">_scsih_sas_discovery_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
		<span class="n">_scsih_sas_broadcast_primitive_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_ENCL_DEVICE_STATUS_CHANGE</span>:
		<span class="n">_scsih_sas_enclosure_dev_status_change_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CONFIGURATION_CHANGE_LIST</span>:
		<span class="n">_scsih_sas_ir_config_change_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_VOLUME</span>:
		<span class="n">_scsih_sas_ir_volume_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_PHYSICAL_DISK</span>:
		<span class="n">_scsih_sas_ir_physical_disk_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_OPERATION_STATUS</span>:
		<span class="n">_scsih_sas_ir_operation_status_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">_scsih_fw_event_free</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_scsih_event_callback - firmware event handler (called at ISR time)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> * Context: interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * This function merely adds a new work task into ioc-&gt;firmware_event_thread.</span>
<span class="cm"> * The tasks are worked from _firmware_event_work in user context.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt2sas_scsih_event_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>
	<span class="n">Mpi2EventNotificationReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>

	<span class="cm">/* events turned off due to host reset or driver unloading */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mpi_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;mpi_reply not valid at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* handle these */</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
	<span class="p">{</span>
		<span class="n">Mpi2EventDataSasBroadcastPrimitive_t</span> <span class="o">*</span><span class="n">baen_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">Mpi2EventDataSasBroadcastPrimitive_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">baen_data</span><span class="o">-&gt;</span><span class="n">Primitive</span> <span class="o">!=</span>
		    <span class="n">MPI2_EVENT_PRIMITIVE_ASYNCHRONOUS_EVENT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_pending</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span>:
		<span class="n">_scsih_check_topo_delete_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">Mpi2EventDataSasTopologyChangeList_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CONFIGURATION_CHANGE_LIST</span>:
		<span class="n">_scsih_check_ir_config_unhide_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">Mpi2EventDataIrConfigChangeList_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_VOLUME</span>:
		<span class="n">_scsih_check_volume_delete_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">Mpi2EventDataIrVolume_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_LOG_ENTRY_ADDED</span>:
	<span class="p">{</span>
		<span class="n">Mpi2EventDataLogEntryAdded_t</span> <span class="o">*</span><span class="n">log_entry</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">log_code</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">log_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2EventDataLogEntryAdded_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">;</span>
		<span class="n">log_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">LogData</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">LogEntryQualifier</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="n">MPT2_WARPDRIVE_LOGENTRY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">log_code</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPT2_WARPDRIVE_LC_SSDT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;WarpDrive Warning: &quot;</span>
			    <span class="s">&quot;IO Throttling has occurred in the WarpDrive &quot;</span>
			    <span class="s">&quot;subsystem. Check WarpDrive documentation for &quot;</span>
			    <span class="s">&quot;additional details.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2_WARPDRIVE_LC_SSDLW</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;WarpDrive Warning: &quot;</span>
			    <span class="s">&quot;Program/Erase Cycles for the WarpDrive subsystem &quot;</span>
			    <span class="s">&quot;in degraded range. Check WarpDrive documentation &quot;</span>
			    <span class="s">&quot;for additional details.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2_WARPDRIVE_LC_SSDLF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;WarpDrive Fatal Error: &quot;</span>
			    <span class="s">&quot;There are no Program/Erase Cycles for the &quot;</span>
			    <span class="s">&quot;WarpDrive subsystem. The storage device will be &quot;</span>
			    <span class="s">&quot;in read-only mode. Check WarpDrive documentation &quot;</span>
			    <span class="s">&quot;for additional details.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2_WARPDRIVE_LC_BRMF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;WarpDrive Fatal Error: &quot;</span>
			    <span class="s">&quot;The Backup Rail Monitor has failed on the &quot;</span>
			    <span class="s">&quot;WarpDrive subsystem. Check WarpDrive &quot;</span>
			    <span class="s">&quot;documentation for additional details.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_OPERATION_STATUS</span>:
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DISCOVERY</span>:
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_ENCL_DEVICE_STATUS_CHANGE</span>:
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_PHYSICAL_DISK</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* ignore the rest */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventDataLength</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">,</span>
	    <span class="n">sz</span><span class="p">);</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">VF_ID</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">VP_ID</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* shost template */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">scsih_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;Fusion MPT SAS Host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">_scsih_qcmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>			<span class="o">=</span> <span class="n">_scsih_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>			<span class="o">=</span> <span class="n">_scsih_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">_scsih_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>			<span class="o">=</span> <span class="n">_scsih_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>			<span class="o">=</span> <span class="n">_scsih_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_finished</span>			<span class="o">=</span> <span class="n">_scsih_scan_finished</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_start</span>			<span class="o">=</span> <span class="n">_scsih_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> 		<span class="o">=</span> <span class="n">_scsih_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span>		<span class="o">=</span> <span class="n">_scsih_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">_scsih_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">_scsih_dev_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span>	<span class="o">=</span> <span class="n">_scsih_target_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">_scsih_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">_scsih_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">MPT2SAS_SG_DEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="mi">32767</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">mpt2sas_host_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sdev_attrs</span>			<span class="o">=</span> <span class="n">mpt2sas_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_expander_node_remove - removing expander device from list.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_expander: the sas_device object</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Removing object and freeing associated memory from the</span>
<span class="cm"> * ioc-&gt;sas_expander_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_expander_node_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_expander</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* remove sibling ports attached to this expander */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
	   <span class="o">&amp;</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span> <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
			<span class="n">mpt2sas_device_remove_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">||</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span>
			<span class="n">mpt2sas_expander_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
	    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;expander_remove: handle&quot;</span>
	   <span class="s">&quot;(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_expander</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_expander</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_ir_shutdown - IR shutdown notification</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Sending RAID Action to alert the Integrated RAID subsystem of the IOC that</span>
<span class="cm"> * the host system is shutting down.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_ir_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RaidActionRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2RaidActionReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="cm">/* is IR firmware build loaded ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* are there any volumes ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: scsih_cmd in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2RaidActionRequest_t</span><span class="p">));</span>

	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_RAID_ACTION</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI2_RAID_ACTION_SYSTEM_SHUTDOWN_INITIATED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;IR shutdown (sending)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;IR shutdown (complete): &quot;</span>
			    <span class="s">&quot;ioc_status(0x%04x), loginfo(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">));</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_shutdown - routine call during system shutdown</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span>	<span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_cleanup_queue</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">_scsih_ir_shutdown</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mpt2sas_base_detach</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_remove - detach and remove add host</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Routine called when unloading the driver.</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">_scsih_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="o">*</span><span class="n">next_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_TARGET</span> <span class="o">*</span><span class="n">sas_target_priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span>	<span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">_scsih_fw_event_cleanup_queue</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* release all the volumes */</span>
	<span class="n">_scsih_ir_shutdown</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_target_priv_data</span> <span class="o">=</span>
			    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="n">sas_target_priv_data</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scsi_remove_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;removing handle(0x%04x), wwid&quot;</span>
		    <span class="s">&quot;(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">);</span>
		<span class="n">_scsih_raid_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free ports attached to the sas_host */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="n">next_port</span><span class="p">,</span>
	   <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_port_list</span><span class="p">,</span> <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
			<span class="n">mpt2sas_device_remove_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">||</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span>
			<span class="n">mpt2sas_expander_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free phys attached to the sas_host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">mpt2sas_base_detach</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_probe_boot_devices - reports 1st device</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * If specified in bios page 2, this routine reports the 1st</span>
<span class="cm"> * device scsi-ml or sas transport for persistent boot device</span>
<span class="cm"> * purposes.  Please refer to function _scsih_determine_boot_device()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_probe_boot_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">is_raid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address_parent</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	 <span class="cm">/* no Bios, return immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg3</span><span class="p">.</span><span class="n">BiosVersion</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is_raid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">is_raid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_boot_device</span><span class="p">.</span><span class="n">is_raid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">is_raid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_alt_boot_device</span><span class="p">.</span><span class="n">is_raid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">is_raid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">current_boot_device</span><span class="p">.</span><span class="n">is_raid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_raid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raid_device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="n">RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">_scsih_raid_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">sas_address_parent</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">;</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_transport_port_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_scsih_sas_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
				<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">,</span>
					<span class="n">sas_address_parent</span><span class="p">);</span>
			<span class="n">_scsih_sas_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_probe_raid - reporting raid volumes to scsi-ml</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Called during initial loading of the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_probe_raid</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_raid_device</span> <span class="o">*</span><span class="n">raid_device</span><span class="p">,</span> <span class="o">*</span><span class="n">raid_next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">raid_device</span><span class="p">,</span> <span class="n">raid_next</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="n">RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">raid_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">_scsih_raid_device_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">raid_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_probe_sas - reporting sas devices to sas transport</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Called during initial loading of the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_probe_sas</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* SAS Device List */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_device</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_init_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_transport_port_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sas_device</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
				<span class="n">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">,</span>
					<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address_parent</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sas_device</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_probe_devices - probing for devices</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Called during initial loading of the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_probe_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">volume_mapping_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_PROTOCOL_SCSI_INITIATOR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>  <span class="cm">/* return when IOC doesn&#39;t support initiator mode */</span>

	<span class="n">_scsih_probe_boot_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volume_mapping_flags</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_pg8</span><span class="p">.</span><span class="n">IRVolumeMappingFlags</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCPAGE8_IRFLAGS_MASK_VOLUME_MAPPING_MODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume_mapping_flags</span> <span class="o">==</span>
		    <span class="n">MPI2_IOCPAGE8_IRFLAGS_LOW_VOLUME_MAPPING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_scsih_probe_raid</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_probe_sas</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">_scsih_probe_sas</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_scsih_probe_raid</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">_scsih_probe_sas</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_scan_start - scsi lld callback for .scan_start</span>
<span class="cm"> * @shost: SCSI host pointer</span>
<span class="cm"> *</span>
<span class="cm"> * The shost has the ability to discover targets on its own instead</span>
<span class="cm"> * of scanning the entire bus.  In our implemention, we will kick off</span>
<span class="cm"> * firmware discovery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diag_buffer_enable</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">diag_buffer_enable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mpt2sas_enable_diag_buffer</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">diag_buffer_enable</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_port_enable</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_scan_finished - scsi lld callback for .scan_finished</span>
<span class="cm"> * @shost: SCSI host pointer</span>
<span class="cm"> * @time: elapsed time of the scan in jiffies</span>
<span class="cm"> *</span>
<span class="cm"> * This function will be called periodically until it returns 1 with the</span>
<span class="cm"> * scsi_host and the elapsed time of the scan in jiffies. In our implemention,</span>
<span class="cm"> * we wait for firmware discovery to complete, then return 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_scan_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">300</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: FAILED with timeout &quot;</span>
		    <span class="s">&quot;(timeout=300s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan_failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: FAILED with &quot;</span>
		    <span class="s">&quot;(ioc_status=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan_failed</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">_scsih_probe_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mpt2sas_base_start_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _scsih_probe - attach and add scsi host</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> * @id: pci device id</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scsih_driver_template</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* init local params */</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_ioc_list</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">mpt_ids</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SSS6200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfg_pg10_hide_flag</span> <span class="o">=</span> <span class="n">MFG_PAGE10_EXPOSE_ALL_DISKS</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_io_cb_idx</span> <span class="o">=</span> <span class="n">scsi_io_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cb_idx</span> <span class="o">=</span> <span class="n">tm_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cb_idx</span> <span class="o">=</span> <span class="n">ctl_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cb_idx</span> <span class="o">=</span> <span class="n">base_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cb_idx</span> <span class="o">=</span> <span class="n">port_enable_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cb_idx</span> <span class="o">=</span> <span class="n">transport_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cb_idx</span> <span class="o">=</span> <span class="n">scsih_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cb_idx</span> <span class="o">=</span> <span class="n">config_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_cb_idx</span> <span class="o">=</span> <span class="n">tm_tr_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_tr_volume_cb_idx</span> <span class="o">=</span> <span class="n">tm_tr_volume_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_sas_control_cb_idx</span> <span class="o">=</span> <span class="n">tm_sas_control_cb_idx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging_level</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_dead_ioc_flush_running_cmds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_scsih_flush_running_cmds</span><span class="p">;</span>
	<span class="cm">/* misc semaphores and spin locks */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_in_progress_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_init_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_expander_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_device_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_port_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_volume_list</span><span class="p">);</span>

	<span class="cm">/* init shost parameters */</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">max_lun</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">mpt2sas_transport_template</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;Invalid value %d passed &quot;</span>
			    <span class="s">&quot;for max_sectors, range is 64 to 8192. Assigning &quot;</span>
			    <span class="s">&quot;value of 64.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;Invalid value %d passed &quot;</span>
			    <span class="s">&quot;for max_sectors, range is 64 to 8192. Assigning &quot;</span>
			    <span class="s">&quot;default value of 32767.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">max_sectors</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">max_sectors</span> <span class="o">&amp;</span> <span class="mh">0xFFFE</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;The max_sectors value is &quot;</span>
			    <span class="s">&quot;set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_sectors</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_add_shost_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_host_set_prot</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">SHOST_DIF_TYPE1_PROTECTION</span>
	    <span class="o">|</span> <span class="n">SHOST_DIF_TYPE2_PROTECTION</span> <span class="o">|</span> <span class="n">SHOST_DIF_TYPE3_PROTECTION</span><span class="p">);</span>
	<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">);</span>

	<span class="cm">/* event thread */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_name</span><span class="p">),</span>
	    <span class="s">&quot;fw_event%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_thread_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_base_attach</span><span class="p">(</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_attach_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfg_pg10_hide_flag</span> <span class="o">==</span>  <span class="n">MFG_PAGE10_EXPOSE_ALL_DISKS</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfg_pg10_hide_flag</span> <span class="o">==</span>  <span class="n">MFG_PAGE10_HIDE_ALL_DISKS</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_scsih_get_num_volumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_drives</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_attach_fail:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">firmware_event_thread</span><span class="p">);</span>
 <span class="nl">out_thread_fail:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
 <span class="nl">out_add_shost_fail:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> * _scsih_suspend - power management suspend main entry point</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> * @state: PM state change to (usually PCI_D3)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_power_t</span> <span class="n">device_state</span><span class="p">;</span>

	<span class="n">mpt2sas_base_stop_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">device_state</span> <span class="o">=</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;pdev=0x%p, slot=%s, entering &quot;</span>
	    <span class="s">&quot;operating state [D%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span>
	    <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">device_state</span><span class="p">);</span>

	<span class="n">mpt2sas_base_free_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_resume - power management resume main entry point</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_power_t</span> <span class="n">device_state</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;pdev=0x%p, slot=%s, previous &quot;</span>
	    <span class="s">&quot;operating state [D%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span>
	    <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">device_state</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_base_map_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span> <span class="n">SOFT_RESET</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">mpt2sas_base_start_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_pci_error_detected - Called when a PCI error is detected.</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> * @state: PCI channel state</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Called when a PCI error is detected.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *      PCI_ERS_RESULT_NEED_RESET or PCI_ERS_RESULT_DISCONNECT</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">_scsih_pci_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;PCI error: detected callback, state(%d)!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_normal</span>:
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="cm">/* Fatal error, prepare for slot reset */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">mpt2sas_base_stop_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">mpt2sas_base_free_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="cm">/* Permanent error, prepare for device removal */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mpt2sas_base_stop_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">_scsih_flush_running_cmds</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_pci_slot_reset - Called when PCI slot has been reset.</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This routine is called by the pci error recovery</span>
<span class="cm"> * code after the PCI slot has been reset, just before we</span>
<span class="cm"> * should resume normal operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">_scsih_pci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;PCI error: slot reset callback!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_map_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>


	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
	    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;hard reset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;success&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_pci_resume() - resume normal ops after PCI reset</span>
<span class="cm"> * @pdev: pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Called when the error recovery driver tells us that its</span>
<span class="cm"> * OK to resume normal operation. Use completion to allow</span>
<span class="cm"> * halted scsi ops to resume.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_scsih_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;PCI error: resume callback!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mpt2sas_base_start_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_pci_mmio_enabled - Enable MMIO and dump debug registers</span>
<span class="cm"> * @pdev: pointer to PCI device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">_scsih_pci_mmio_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;PCI error: mmio enabled callback!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* TODO - dump whatever for debugging purposes */</span>

	<span class="cm">/* Request a slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">_scsih_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">_scsih_pci_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_enabled</span> <span class="o">=</span> <span class="n">_scsih_pci_mmio_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span>	<span class="n">_scsih_pci_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">_scsih_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">scsih_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">scsih_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">_scsih_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">_scsih_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">_scsih_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">_scsih_err_handler</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">_scsih_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">_scsih_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* raid transport support */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">raid_function_template</span> <span class="n">mpt2sas_raid_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cookie</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">scsih_driver_template</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_raid</span>	<span class="o">=</span> <span class="n">_scsih_is_raid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_resync</span>	<span class="o">=</span> <span class="n">_scsih_get_resync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_state</span>	<span class="o">=</span> <span class="n">_scsih_get_state</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_init - main entry point for this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">_scsih_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mpt_ids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s version %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span>
	    <span class="n">MPT2SAS_DRIVER_VERSION</span><span class="p">);</span>

	<span class="n">mpt2sas_transport_template</span> <span class="o">=</span>
	    <span class="n">sas_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_transport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/* raid transport support */</span>
	<span class="n">mpt2sas_raid_template</span> <span class="o">=</span> <span class="n">raid_class_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_raid_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_raid_template</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">mpt2sas_transport_template</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_base_initialize_callback_handler</span><span class="p">();</span>

	 <span class="cm">/* queuecommand callback hander */</span>
	<span class="n">scsi_io_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">_scsih_io_done</span><span class="p">);</span>

	<span class="cm">/* task management callback handler */</span>
	<span class="n">tm_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">_scsih_tm_done</span><span class="p">);</span>

	<span class="cm">/* base internal commands callback handler */</span>
	<span class="n">base_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">mpt2sas_base_done</span><span class="p">);</span>
	<span class="n">port_enable_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
		<span class="n">mpt2sas_port_enable_done</span><span class="p">);</span>

	<span class="cm">/* transport internal commands callback handler */</span>
	<span class="n">transport_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
	    <span class="n">mpt2sas_transport_done</span><span class="p">);</span>

	<span class="cm">/* scsih internal commands callback handler */</span>
	<span class="n">scsih_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">_scsih_done</span><span class="p">);</span>

	<span class="cm">/* configuration page API internal commands callback handler */</span>
	<span class="n">config_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
	    <span class="n">mpt2sas_config_done</span><span class="p">);</span>

	<span class="cm">/* ctl module callback handler */</span>
	<span class="n">ctl_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">mpt2sas_ctl_done</span><span class="p">);</span>

	<span class="n">tm_tr_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
	    <span class="n">_scsih_tm_tr_complete</span><span class="p">);</span>

	<span class="n">tm_tr_volume_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
	    <span class="n">_scsih_tm_volume_tr_complete</span><span class="p">);</span>

	<span class="n">tm_sas_control_cb_idx</span> <span class="o">=</span> <span class="n">mpt2sas_base_register_callback_handler</span><span class="p">(</span>
	    <span class="n">_scsih_sas_control_complete</span><span class="p">);</span>

	<span class="n">mpt2sas_ctl_init</span><span class="p">();</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scsih_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* raid transport support */</span>
		<span class="n">raid_class_release</span><span class="p">(</span><span class="n">mpt2sas_raid_template</span><span class="p">);</span>
		<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">mpt2sas_transport_template</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_exit - exit point for this driver (when it is a module).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">_scsih_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpt2sas version %s unloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">MPT2SAS_DRIVER_VERSION</span><span class="p">);</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scsih_driver</span><span class="p">);</span>

	<span class="n">mpt2sas_ctl_exit</span><span class="p">();</span>

	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">scsi_io_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">tm_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">base_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">port_enable_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">transport_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">scsih_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">config_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">ctl_cb_idx</span><span class="p">);</span>

	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">tm_tr_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">tm_tr_volume_cb_idx</span><span class="p">);</span>
	<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">tm_sas_control_cb_idx</span><span class="p">);</span>

	<span class="cm">/* raid transport support */</span>
	<span class="n">raid_class_release</span><span class="p">(</span><span class="n">mpt2sas_raid_template</span><span class="p">);</span>
	<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">mpt2sas_transport_template</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">_scsih_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">_scsih_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
