<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › mpt2sas › mpt2sas_base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpt2sas_base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is the Fusion MPT base driver providing common API layer interface</span>
<span class="cm"> * for access to MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on drivers/scsi/mpt2sas/mpt2_base.c</span>
<span class="cm"> * Copyright (C) 2007-2010  LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm"> * CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm"> * LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm"> * solely responsible for determining the appropriateness of using and</span>
<span class="cm"> * distributing the Program and assumes all risks associated with its</span>
<span class="cm"> * exercise of rights under this Agreement, including but not limited to</span>
<span class="cm"> * the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm"> * programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm"> * DISCLAIMER OF LIABILITY</span>
<span class="cm"> * NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm"> * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm"> * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm"> * USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm"> * HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,</span>
<span class="cm"> * USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>

<span class="cp">#include &quot;mpt2sas_base.h&quot;</span>

<span class="k">static</span> <span class="n">MPT_CALLBACK</span>	<span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">MPT_MAX_CALLBACKS</span><span class="p">];</span>

<span class="cp">#define FAULT_POLLING_INTERVAL 1000 </span><span class="cm">/* in milliseconds */</span><span class="cp"></span>

<span class="cp">#define MAX_HBA_QUEUE_DEPTH	30000</span>
<span class="cp">#define MAX_CHAIN_DEPTH		100000</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_queue_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_queue_depth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_queue_depth</span><span class="p">,</span> <span class="s">&quot; max controller queue depth &quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">max_sgl_entries</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_sgl_entries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_sgl_entries</span><span class="p">,</span> <span class="s">&quot; max sg entries &quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msix_disable</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msix_disable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msix_disable</span><span class="p">,</span> <span class="s">&quot; disable msix routed interrupts (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">missing_delay</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">missing_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">missing_delay</span><span class="p">,</span> <span class="s">&quot; device missing delay , io missing delay&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt2sas_fwfault_debug</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt2sas_fwfault_debug</span><span class="p">,</span> <span class="s">&quot; enable detection of firmware fault &quot;</span>
	<span class="s">&quot;and halt firmware - (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_discovery</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_discovery</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_discovery</span><span class="p">,</span> <span class="s">&quot; disable discovery &quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * _scsih_set_fwfault_debug - global setting of ioc-&gt;fwfault_debug.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_scsih_set_fwfault_debug</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_set_int</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;setting fwfault_debug(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpt2sas_fwfault_debug</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fwfault_debug</span> <span class="o">=</span> <span class="n">mpt2sas_fwfault_debug</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">mpt2sas_fwfault_debug</span><span class="p">,</span> <span class="n">_scsih_set_fwfault_debug</span><span class="p">,</span>
    <span class="n">param_get_int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_fwfault_debug</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  mpt2sas_remove_dead_ioc_func - kthread context to remove dead ioc</span>
<span class="cm"> * @arg: input argument, used to derive ioc</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if controller is removed from pci subsystem.</span>
<span class="cm"> * Return -1 for other case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt2sas_remove_dead_ioc_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
		<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">pdev</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pci_stop_and_remove_bus_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _base_fault_reset_work - workq handling ioc fault conditions</span>
<span class="cm"> * @work: input argument, used to derive ioc</span>
<span class="cm"> * Context: sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_fault_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span><span class="p">,</span> <span class="n">fault_reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rearm_timer</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">doorbell</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s : SAS host is non-operational !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call _scsih_flush_pending_cmds callback so that we flush all</span>
<span class="cm">		 * pending commands back to OS. This call is required to aovid</span>
<span class="cm">		 * deadlock at block layer. Dead IOC will fail to do diag reset,</span>
<span class="cm">		 * and this call is safe since dead ioc will never return any</span>
<span class="cm">		 * command back from HW.</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_dead_ioc_flush_running_cmds</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set remove_host flag early since kernel thread will</span>
<span class="cm">		 * take some time to execute.</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*Remove the Dead Host */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">mpt2sas_remove_dead_ioc_func</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
		    <span class="s">&quot;mpt2sas_dead_ioc_%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			<span class="s">&quot;%s: Running mpt2sas_dead_ioc thread failed !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			<span class="s">&quot;%s: Running mpt2sas_dead_ioc thread success !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span> <span class="cm">/* don&#39;t rearm timer */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;%s: hard reset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;success&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
		<span class="n">doorbell</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span>
			<span class="n">mpt2sas_base_fault_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">doorbell</span> <span class="o">&amp;</span>
			    <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="nl">rearm_timer:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span>
		    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FAULT_POLLING_INTERVAL</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_start_watchdog - start the fault_reset_work_q</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * Context: sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_start_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* initialize fault polling */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span> <span class="n">_base_fault_reset_work</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q_name</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q_name</span><span class="p">),</span> <span class="s">&quot;poll_%d_status&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span>
		    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FAULT_POLLING_INTERVAL</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_stop_watchdog - stop the fault_reset_work_q</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * Context: sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_stop_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">))</span>
			<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_fault_info - verbose translation of firmware FAULT code</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @fault_code: fault code</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_fault_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">u16</span> <span class="n">fault_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;fault_state(0x%04x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fault_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_halt_firmware - halt&#39;s mpt controller firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * For debugging timeout related issues.  Writing 0xCOFFEE00</span>
<span class="cm"> * to the doorbell register will halt controller firmware. With</span>
<span class="cm"> * the purpose to stop both driver and firmware, the enduser can</span>
<span class="cm"> * obtain a ring buffer from controller UART.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_halt_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">doorbell</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fwfault_debug</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dump_stack</span><span class="p">();</span>

	<span class="n">doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span>
		<span class="n">mpt2sas_base_fault_info</span><span class="p">(</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">doorbell</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xC0FFEE00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;Firmware is halted due to command &quot;</span>
		    <span class="s">&quot;timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;panic in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> * _base_sas_ioc_info - verbose translation of the ioc status</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpi_reply: reply mf payload returned from firmware</span>
<span class="cm"> * @request_hdr: request mf</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_sas_ioc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">,</span>
     <span class="n">MPI2RequestHeader_t</span> <span class="o">*</span><span class="n">request_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_sz</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">func_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* SCSI_IO, RAID_PASS are handled from _scsih_scsi_ioc_info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_hdr</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_SCSI_IO_REQUEST</span> <span class="o">||</span>
	    <span class="n">request_hdr</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span> <span class="o">||</span>
	    <span class="n">request_hdr</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_EVENT_NOTIFICATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  Common IOCStatus values for all replies</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_FUNCTION</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid function&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_BUSY</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;busy&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_SGL</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid sgl&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INTERNAL_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;internal error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_VPID</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid vpid&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INSUFFICIENT_RESOURCES</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;insufficient resources&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_FIELD</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid field&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_INVALID_STATE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid state&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_OP_STATE_NOT_SUPPORTED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;op state not supported&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  Config IOCStatus values</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_ACTION</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config invalid action&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_TYPE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config invalid type&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_PAGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config invalid page&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_INVALID_DATA</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config invalid data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_NO_DEFAULTS</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config no defaults&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_CONFIG_CANT_COMMIT</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;config cant commit&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  SCSI IO Reply</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RECOVERED_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_INVALID_DEVHANDLE</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_OVERRUN</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_TERMINATED</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_IOC_TERMINATED</span>:
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SCSI_EXT_TERMINATED</span>:
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  For use by SCSI Initiator and SCSI Target end-to-end data protection</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_GUARD_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;eedp guard error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_REF_TAG_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;eedp ref tag error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_EEDP_APP_TAG_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;eedp app tag error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  SCSI Target values</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_INVALID_IO_INDEX</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target invalid io index&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_ABORTED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_NO_CONN_RETRYABLE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target no conn retryable&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_NO_CONNECTION</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target no connection&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_XFER_COUNT_MISMATCH</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target xfer count mismatch&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_DATA_OFFSET_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target data offset error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_TOO_MUCH_WRITE_DATA</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target too much write data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_IU_TOO_SHORT</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target iu too short&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_ACK_NAK_TIMEOUT</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target ack nak timeout&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_TARGET_NAK_RECEIVED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;target nak received&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  Serial Attached SCSI values</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SAS_SMP_REQUEST_FAILED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;smp request failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_SAS_SMP_DATA_OVERRUN</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;smp data overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">*  Diagnostic Buffer Post / Diagnostic Release values</span>
<span class="cm">****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI2_IOCSTATUS_DIAGNOSTIC_RELEASED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;diagnostic released&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">request_hdr</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_CONFIG</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2ConfigRequest_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;config_page&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_SCSI_TASK_MGMT</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSITaskManagementRequest_t</span><span class="p">);</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;task_mgmt&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_SAS_IO_UNIT_CONTROL</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlRequest_t</span><span class="p">);</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;sas_iounit_ctl&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_SCSI_ENCLOSURE_PROCESSOR</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepRequest_t</span><span class="p">);</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;enclosure&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_IOC_INIT</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCInitRequest_t</span><span class="p">);</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;ioc_init&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_PORT_ENABLE</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortEnableRequest_t</span><span class="p">);</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;port_enable&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_FUNCTION_SMP_PASSTHROUGH</span>:
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;smp_passthru&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">frame_sz</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">func_str</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;ioc_status: %s(0x%04x), request(0x%p),&quot;</span>
	    <span class="s">&quot; (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">request_hdr</span><span class="p">,</span> <span class="n">func_str</span><span class="p">);</span>

	<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">request_hdr</span><span class="p">,</span> <span class="n">frame_sz</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_event_data - verbose translation of firmware asyn events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpi_reply: reply mf payload returned from firmware</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_event_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2EventNotificationReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_EVENTS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_LOG_DATA</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Log Data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_STATE_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Status Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_HARD_RESET_RECEIVED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Hard Reset Received&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_EVENT_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Event Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Device Status Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_OPERATION_STATUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;IR Operation Status&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_DISCOVERY</span>:
	<span class="p">{</span>
		<span class="n">Mpi2EventDataSasDiscovery_t</span> <span class="o">*</span><span class="n">event_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">Mpi2EventDataSasDiscovery_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventData</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Discovery: (%s)&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI2_EVENT_SAS_DISC_RC_STARTED</span><span class="p">)</span> <span class="o">?</span>
		    <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;discovery_status(0x%08x)&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">event_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS Broadcast Primitive&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_INIT_DEVICE_STATUS_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS Init Device Status Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_INIT_TABLE_OVERFLOW</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS Init Table Overflow&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS Topology Change List&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_SAS_ENCL_DEVICE_STATUS_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS Enclosure Device Status Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;IR Volume&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_PHYSICAL_DISK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;IR Physical Disk&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_IR_CONFIGURATION_CHANGE_LIST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;IR Configuration Change List&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_EVENT_LOG_ENTRY_ADDED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Log Entry Added&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * _base_sas_log_info - verbose translation of firmware log info</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @log_info: log info</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_sas_log_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">loginfo_type</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">loginfo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">subcode</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">code</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">originator</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">bus_type</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">dw</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">union</span> <span class="n">loginfo_type</span> <span class="n">sas_loginfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">originator_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sas_loginfo</span><span class="p">.</span><span class="n">loginfo</span> <span class="o">=</span> <span class="n">log_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="mi">3</span> <span class="cm">/*SAS*/</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* each nexus loss loginfo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">log_info</span> <span class="o">==</span> <span class="mh">0x31170000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* eat the loginfos associated with task aborts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ignore_loginfos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">log_info</span> <span class="o">==</span> <span class="mh">0x30050000</span> <span class="o">||</span> <span class="n">log_info</span> <span class="o">==</span>
	    <span class="mh">0x31140000</span> <span class="o">||</span> <span class="n">log_info</span> <span class="o">==</span> <span class="mh">0x31130000</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">originator</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">originator_str</span> <span class="o">=</span> <span class="s">&quot;IOP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">originator_str</span> <span class="o">=</span> <span class="s">&quot;PL&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span>
			<span class="n">originator_str</span> <span class="o">=</span> <span class="s">&quot;IR&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">originator_str</span> <span class="o">=</span> <span class="s">&quot;WarpDrive&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;log_info(0x%08x): originator(%s), &quot;</span>
	    <span class="s">&quot;code(0x%02x), sub_code(0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span>
	     <span class="n">originator_str</span><span class="p">,</span> <span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
	     <span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">subcode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_reply_info -</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_reply_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mpi_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;mpi_reply not valid at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_status</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_REPLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_base_sas_ioc_info</span><span class="p">(</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span>
		   <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE</span><span class="p">)</span>
		<span class="n">_base_sas_log_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_done - base internal command completion routine</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt2sas_base_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span> <span class="o">&amp;&amp;</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_EVENT_ACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_async_event - main callback handler for firmware asyn events</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_base_async_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventNotificationReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2EventAckRequest_t</span> <span class="o">*</span><span class="n">ack_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpi_reply</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">!=</span> <span class="n">MPI2_FUNCTION_EVENT_NOTIFICATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SCSI_MPT2SAS_LOGGING</span>
	<span class="n">_base_display_event_data</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">AckRequired</span> <span class="o">&amp;</span> <span class="n">MPI2_EVENT_NOTIFICATION_ACK_REQUIRED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ack_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ack_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventAckRequest_t</span><span class="p">));</span>
	<span class="n">ack_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_EVENT_ACK</span><span class="p">;</span>
	<span class="n">ack_request</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">;</span>
	<span class="n">ack_request</span><span class="o">-&gt;</span><span class="n">EventContext</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">EventContext</span><span class="p">;</span>
	<span class="n">ack_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* TODO */</span>
	<span class="n">ack_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>

 <span class="nl">out:</span>

	<span class="cm">/* scsih callback handler */</span>
	<span class="n">mpt2sas_scsih_event_callback</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="cm">/* ctl callback handler */</span>
	<span class="n">mpt2sas_ctl_event_callback</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_get_cb_idx - obtain the callback index</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Return callback index.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">_base_get_cb_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">;</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">;</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cb_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_mask_interrupts - disable interrupts</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Disabling ResetIRQ, Reply and Doorbell Interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_mask_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">him_register</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mask_interrupts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">him_register</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptMask</span><span class="p">);</span>
	<span class="n">him_register</span> <span class="o">|=</span> <span class="n">MPI2_HIM_DIM</span> <span class="o">+</span> <span class="n">MPI2_HIM_RIM</span> <span class="o">+</span> <span class="n">MPI2_HIM_RESET_IRQ_MASK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">him_register</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptMask</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptMask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_unmask_interrupts - enable interrupts</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Enabling only Reply Interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_unmask_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">him_register</span><span class="p">;</span>

	<span class="n">him_register</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptMask</span><span class="p">);</span>
	<span class="n">him_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI2_HIM_RIM</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">him_register</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptMask</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mask_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">reply_descriptor</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">high</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * _base_interrupt - MPT adapter (IOC) specific interrupt handler.</span>
<span class="cm"> * @irq: irq number (not used)</span>
<span class="cm"> * @bus_id: bus identifier cookie == pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @r: pt_regs pointer (not used)</span>
<span class="cm"> *</span>
<span class="cm"> * Return IRQ_HANDLE if processed, else IRQ_NONE.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">_base_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span> <span class="o">=</span> <span class="n">bus_id</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">reply_descriptor</span> <span class="n">rd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">completed_cmds</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request_desript_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reply</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msix_index</span> <span class="o">=</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">Mpi2ReplyDescriptorsUnion_t</span> <span class="o">*</span><span class="n">rpf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mask_interrupts</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">rpf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">[</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">];</span>
	<span class="n">request_desript_type</span> <span class="o">=</span> <span class="n">rpf</span><span class="o">-&gt;</span><span class="n">Default</span><span class="p">.</span><span class="n">ReplyFlags</span>
	     <span class="o">&amp;</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_TYPE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_desript_type</span> <span class="o">==</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">completed_cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rd</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">low</span> <span class="o">==</span> <span class="n">UINT_MAX</span> <span class="o">||</span> <span class="n">rd</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">high</span> <span class="o">==</span> <span class="n">UINT_MAX</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">Default</span><span class="p">.</span><span class="n">DescriptorTypeDependent1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_desript_type</span> <span class="o">==</span>
		    <span class="n">MPI2_RPY_DESCRIPT_FLAGS_ADDRESS_REPLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reply</span> <span class="o">=</span> <span class="n">le32_to_cpu</span>
				<span class="p">(</span><span class="n">rpf</span><span class="o">-&gt;</span><span class="n">AddressReply</span><span class="p">.</span><span class="n">ReplyFrameAddress</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_max_address</span> <span class="o">||</span>
			    <span class="n">reply</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_min_address</span><span class="p">)</span>
				<span class="n">reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request_desript_type</span> <span class="o">==</span>
		    <span class="n">MPI2_RPY_DESCRIPT_FLAGS_TARGET_COMMAND_BUFFER</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">request_desript_type</span> <span class="o">==</span>
		    <span class="n">MPI2_RPY_DESCRIPT_FLAGS_TARGETASSIST_SUCCESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">_base_get_cb_idx</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">likely</span><span class="p">(</span><span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_CALLBACKS</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">](</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
				    <span class="n">msix_index</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span>
				<span class="n">_base_display_reply_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">,</span>
				    <span class="n">msix_index</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span>
			<span class="n">_base_async_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>

		<span class="cm">/* reply free queue handling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span>
			    <span class="mi">0</span> <span class="o">:</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">[</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFreeHostIndex</span><span class="p">);</span>
		<span class="p">}</span>

 <span class="nl">next:</span>

		<span class="n">rpf</span><span class="o">-&gt;</span><span class="n">Words</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ULLONG_MAX</span><span class="p">);</span>
		<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
		    <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">request_desript_type</span> <span class="o">=</span>
		    <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">[</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">].</span>
		    <span class="n">Default</span><span class="p">.</span><span class="n">ReplyFlags</span> <span class="o">&amp;</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_TYPE_MASK</span><span class="p">;</span>
		<span class="n">completed_cmds</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_desript_type</span> <span class="o">==</span> <span class="n">MPI2_RPY_DESCRIPT_FLAGS_UNUSED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">)</span>
			<span class="n">rpf</span> <span class="o">=</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rpf</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

 <span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">completed_cmds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">[</span><span class="n">msix_index</span><span class="p">]);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">|</span> <span class="p">(</span><span class="n">msix_index</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MPI2_RPHI_MSIX_INDEX_SHIFT</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyPostHostIndex</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_is_controller_msix_enabled - is controller support muli-reply queues</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_MSI_X_INDEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_flush_reply_queues - flushing the MSIX reply queues</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * Context: ISR conext</span>
<span class="cm"> *</span>
<span class="cm"> * Called when a Task Management request has completed. We want</span>
<span class="cm"> * to flush the other reply queues so all the outstanding IO has been</span>
<span class="cm"> * completed back to OS before we process the TM completetion.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_flush_reply_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">;</span>

	<span class="cm">/* If MSIX capability is turned off</span>
<span class="cm">	 * then multi-queues are not enabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* TMs are on msix_index == 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">_base_interrupt</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">reply_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_release_callback_handler - clear interrupt callback handler</span>
<span class="cm"> * @cb_idx: callback index</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_register_callback_handler - obtain index for the interrupt callback handler</span>
<span class="cm"> * @cb_func: callback function</span>
<span class="cm"> *</span>
<span class="cm"> * Returns cb_func.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt2sas_base_register_callback_handler</span><span class="p">(</span><span class="n">MPT_CALLBACK</span> <span class="n">cb_func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_CALLBACKS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">mpt_callbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb_func</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cb_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_initialize_callback_handler - initialize the interrupt callback handler</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_initialize_callback_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_CALLBACKS</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mpt2sas_base_release_callback_handler</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_build_zero_len_sge - build zero length sg entry</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @paddr: virtual address for SGE</span>
<span class="cm"> *</span>
<span class="cm"> * Create a zero length scatter gather entry to insure the IOCs hardware has</span>
<span class="cm"> * something to use if the target device goes brain dead and tries</span>
<span class="cm"> * to send data even when none is asked for.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_build_zero_len_sge</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="n">flags_length</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_add_sg_single_32 - Place a simple 32 bit SGE at address pAddr.</span>
<span class="cm"> * @paddr: virtual address for SGE</span>
<span class="cm"> * @flags_length: SGE flags and data transfer length</span>
<span class="cm"> * @dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_add_sg_single_32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags_length</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SGESimple32_t</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">flags_length</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_32_BIT_ADDRESSING</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_SYSTEM_ADDRESS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">sgel</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags_length</span><span class="p">);</span>
	<span class="n">sgel</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _base_add_sg_single_64 - Place a simple 64 bit SGE at address pAddr.</span>
<span class="cm"> * @paddr: virtual address for SGE</span>
<span class="cm"> * @flags_length: SGE flags and data transfer length</span>
<span class="cm"> * @dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_add_sg_single_64</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags_length</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SGESimple64_t</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">flags_length</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_64_BIT_ADDRESSING</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_SYSTEM_ADDRESS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">sgel</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags_length</span><span class="p">);</span>
	<span class="n">sgel</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define convert_to_kb(x) ((x) &lt;&lt; (PAGE_SHIFT - 10))</span>

<span class="cm">/**</span>
<span class="cm"> * _base_config_dma_addressing - set dma addressing</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @pdev: PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_config_dma_addressing</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysinfo</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">required_mask</span> <span class="o">=</span>
		    <span class="n">dma_get_required_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">required_mask</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_base_add_sg_single_64</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SGESimple64_t</span><span class="p">);</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;64&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_base_add_sg_single_32</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SGESimple32_t</span><span class="p">);</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;32&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">si_meminfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s BIT PCI BUS DMA ADDRESSING SUPPORTED, &quot;</span>
	    <span class="s">&quot;total mem (%ld kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">convert_to_kb</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalram</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_check_enable_msix - checks MSIX capabable.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Check to see if card is capable of MSIX, and set number</span>
<span class="cm"> * of available msix vectors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_check_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">message_control</span><span class="p">;</span>


	<span class="n">base</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;msix not &quot;</span>
		    <span class="s">&quot;supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get msix vector count */</span>
	<span class="cm">/* NUMA_IO not supported for older controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2004</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2008</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_1</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_2</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2108_3</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2116_1</span> <span class="o">||</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2116_2</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message_control</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">message_control</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;msix is supported, &quot;</span>
	    <span class="s">&quot;vector_count(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_free_irq - free irq</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Freeing respective reply_queue from the list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">reply_q</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">reply_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_request_irq - request irq</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @index: msix index into vector table</span>
<span class="cm"> * @vector: irq vector</span>
<span class="cm"> *</span>
<span class="cm"> * Inserting respective reply_queue into the list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">reply_q</span> <span class="o">=</span>  <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter_reply_queue</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;unable to allocate memory %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter_reply_queue</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPT_NAME_LENGTH</span><span class="p">,</span> <span class="s">&quot;%s%d-msix%d&quot;</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPT_NAME_LENGTH</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">_base_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">reply_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;unable to allocate interrupt %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">reply_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_assign_reply_queues - assigning msix index for each cpu</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * The enduser would need to set the affinity via /proc/irq/#/smp_affinity</span>
<span class="cm"> *</span>
<span class="cm"> * It would nice if we could call irq_set_affinity, however it is not</span>
<span class="cm"> * an exported symbol</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_assign_reply_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu_grouping</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">grouping_mod</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table_sz</span><span class="p">);</span>
	<span class="cm">/* when there are more cpus than available msix vectors,</span>
<span class="cm">	 * then group cpus togeather on same irq</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_count</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grouping</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_count</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span><span class="p">;</span>
		<span class="n">grouping_mod</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_count</span> <span class="o">%</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">grouping_mod</span><span class="p">))</span>
			<span class="n">cpu_grouping</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">grouping_mod</span><span class="p">))</span>
			<span class="n">cpu_grouping</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="p">(</span><span class="n">grouping</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">grouping_mod</span><span class="p">))</span>
			<span class="n">cpu_grouping</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cpu_grouping</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cpu_grouping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reply_q</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">adapter_reply_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_grouping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span><span class="p">;</span>
			<span class="n">reply_q</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">adapter_reply_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&lt;</span> <span class="n">cpu_grouping</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span><span class="p">;</span>
				<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">reply_q</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">adapter_reply_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span><span class="p">;</span>
				<span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_disable_msix - disables msix</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_disable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_enable_msix - enables msix, failback to io_apic</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">try_msix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix_disable</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">msix_disable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">try_msix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_msix</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_ioapic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_base_check_enable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_ioapic</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_count</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_vector_count</span><span class="p">);</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">),</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;kcalloc &quot;</span>
		    <span class="s">&quot;failed @ at %s:%d/%s() !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">try_ioapic</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;pci_enable_msix &quot;</span>
		    <span class="s">&quot;failed (r=%d) !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_ioapic</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">_base_request_irq</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_base_free_irq</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">_base_disable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try_ioapic</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* failback to io_apic interrupt routing */</span>
 <span class="nl">try_ioapic:</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_request_irq</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_map_resources - map in controller resources (io/irq/memap)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_base_map_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">memap_sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pio_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pio_chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">chip_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span> <span class="o">=</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;pci_enable_device_mem: &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">,</span>
	    <span class="n">MPT2SAS_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;pci_request_selected_regions: &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* AER (Advanced Error Reporting) hooks */</span>
	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_base_config_dma_addressing</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_WARN_FMT</span> <span class="s">&quot;no suitable DMA mask for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">memap_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pio_sz</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pio_sz</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">pio_chip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">pio_sz</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memap_sz</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* verify memory resource is valid before using */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">chip_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span><span class="p">;</span>
				<span class="n">memap_sz</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span><span class="p">,</span> <span class="n">memap_sz</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;unable to map &quot;</span>
					    <span class="s">&quot;adapter memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_base_mask_interrupts</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_enable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msix_enable</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PCI-MSI-X enabled&quot;</span> <span class="o">:</span>
		    <span class="s">&quot;IO-APIC enabled&quot;</span><span class="p">),</span> <span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;iomem(0x%016llx), mapped(0x%p), size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">chip_phys</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">memap_sz</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;ioport(0x%016llx), size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pio_chip</span><span class="p">,</span> <span class="n">pio_sz</span><span class="p">);</span>

	<span class="cm">/* Save PCI configuration state for recovery from PCI AER/EEH errors */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_msg_frame - obtain request mf pointer</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index(smid zero is invalid)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns virt pointer to message frame.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">+</span> <span class="p">(</span><span class="n">smid</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_sense_buffer - obtain a sense buffer assigned to a mf request</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns virt pointer to sense buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">mpt2sas_base_get_sense_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">+</span> <span class="p">((</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_sense_buffer_dma - obtain a sense buffer assigned to a mf request</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns phys pointer to the low 32bit address of the sense buffer.</span>
<span class="cm"> */</span>
<span class="n">__le32</span>
<span class="nf">mpt2sas_base_get_sense_buffer_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_reply_virt_addr - obtain reply frames virt address</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @phys_addr: lower 32 physical addr of the reply</span>
<span class="cm"> *</span>
<span class="cm"> * Converts 32bit lower physical addr into a virt address.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phys_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">+</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">-</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_smid - obtain a free smid from internal queue</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @cb_idx: callback index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns smid (zero is invalid)</span>
<span class="cm"> */</span>
<span class="n">u16</span>
<span class="nf">mpt2sas_base_get_smid</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_tracker</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: smid not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">request_tracker</span><span class="p">,</span> <span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">smid</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_smid_scsiio - obtain a free smid from scsiio queue</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @cb_idx: callback index</span>
<span class="cm"> * @scmd: pointer to scsi command object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns smid (zero is invalid)</span>
<span class="cm"> */</span>
<span class="n">u16</span>
<span class="nf">mpt2sas_base_get_smid_scsiio</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsiio_tracker</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: smid not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">scsiio_tracker</span><span class="p">,</span> <span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">scmd</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">smid</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_smid_hpr - obtain a free smid from hi-priority queue</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @cb_idx: callback index</span>
<span class="cm"> *</span>
<span class="cm"> * Returns smid (zero is invalid)</span>
<span class="cm"> */</span>
<span class="n">u16</span>
<span class="nf">mpt2sas_base_get_smid_hpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_tracker</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">request_tracker</span><span class="p">,</span> <span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">smid</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">smid</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_free_smid - put smid back on free_list</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_free_smid</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chain_tracker</span> <span class="o">*</span><span class="n">chain_req</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* scsiio queue */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">chain_req</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_list</span><span class="p">,</span> <span class="n">tracker_list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain_req</span><span class="o">-&gt;</span><span class="n">tracker_list</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_chain_list</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">direct_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * See _wait_for_commands_to_complete() call with regards</span>
<span class="cm">		 * to this code.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hi-priority */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_free_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smid</span> <span class="o">&lt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* internal queue */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">smid</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_free_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_writeq - 64 bit write to MMIO</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @b: data payload</span>
<span class="cm"> * @addr: address in MMIO space</span>
<span class="cm"> * @writeq_lock: spin lock</span>
<span class="cm"> *</span>
<span class="cm"> * Glue for handling an atomic 64 bit word to MMIO. This special handling takes</span>
<span class="cm"> * care of 32 bit environment where its not quarenteed to send the entire word</span>
<span class="cm"> * in one transfer.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef writeq</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_base_writeq</span><span class="p">(</span><span class="n">__u64</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
    <span class="n">spinlock_t</span> <span class="o">*</span><span class="n">writeq_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">data_out</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">writeq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">data_out</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">data_out</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">writeq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_base_writeq</span><span class="p">(</span><span class="n">__u64</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
    <span class="n">spinlock_t</span> <span class="o">*</span><span class="n">writeq_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">_base_get_msix_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">[</span><span class="n">raw_smp_processor_id</span><span class="p">()];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_put_smid_scsi_io - send SCSI_IO request to firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_put_smid_scsi_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RequestDescriptorUnion_t</span> <span class="n">descriptor</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">;</span>


	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span> <span class="n">MPI2_REQ_DESCRIPT_FLAGS_SCSI_IO</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">MSIxIndex</span> <span class="o">=</span>  <span class="n">_base_get_msix_index</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">smid</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">DevHandle</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSIIO</span><span class="p">.</span><span class="n">LMID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_base_writeq</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestDescriptorPostLow</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_put_smid_hi_priority - send Task Management request to firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_put_smid_hi_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RequestDescriptorUnion_t</span> <span class="n">descriptor</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">;</span>

	<span class="n">descriptor</span><span class="p">.</span><span class="n">HighPriority</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
	    <span class="n">MPI2_REQ_DESCRIPT_FLAGS_HIGH_PRIORITY</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">HighPriority</span><span class="p">.</span><span class="n">MSIxIndex</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">HighPriority</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">smid</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">HighPriority</span><span class="p">.</span><span class="n">LMID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">HighPriority</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_base_writeq</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestDescriptorPostLow</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_put_smid_default - Default, primarily used for config pages</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RequestDescriptorUnion_t</span> <span class="n">descriptor</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">;</span>

	<span class="n">descriptor</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span> <span class="n">MPI2_REQ_DESCRIPT_FLAGS_DEFAULT_TYPE</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">MSIxIndex</span> <span class="o">=</span>  <span class="n">_base_get_msix_index</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">smid</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">LMID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">DescriptorTypeDependent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_base_writeq</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestDescriptorPostLow</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_put_smid_target_assist - send Target Assist/Status to firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @io_index: value used to track the IO</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_put_smid_target_assist</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span>
    <span class="n">u16</span> <span class="n">io_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2RequestDescriptorUnion_t</span> <span class="n">descriptor</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">;</span>

	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSITarget</span><span class="p">.</span><span class="n">RequestFlags</span> <span class="o">=</span>
	    <span class="n">MPI2_REQ_DESCRIPT_FLAGS_SCSI_TARGET</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSITarget</span><span class="p">.</span><span class="n">MSIxIndex</span> <span class="o">=</span>  <span class="n">_base_get_msix_index</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSITarget</span><span class="p">.</span><span class="n">SMID</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">smid</span><span class="p">);</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSITarget</span><span class="p">.</span><span class="n">LMID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">descriptor</span><span class="p">.</span><span class="n">SCSITarget</span><span class="p">.</span><span class="n">IoIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">io_index</span><span class="p">);</span>
	<span class="n">_base_writeq</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestDescriptorPostLow</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_dell_branding - Disply branding string</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_dell_branding</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">dell_branding</span><span class="p">[</span><span class="n">MPT2SAS_DELL_BRANDING_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_DELL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_6GBPS_SAS_HBA_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="n">MPT2SAS_DELL_6GBPS_SAS_HBA_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_PERC_H200_ADAPTER_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="n">MPT2SAS_DELL_PERC_H200_ADAPTER_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_PERC_H200_INTEGRATED_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_PERC_H200_INTEGRATED_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_PERC_H200_MODULAR_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_PERC_H200_MODULAR_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_PERC_H200_EMBEDDED_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_PERC_H200_EMBEDDED_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_PERC_H200_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="n">MPT2SAS_DELL_PERC_H200_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2SAS_DELL_6GBPS_SAS_SSDID</span>:
		<span class="n">strncpy</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="n">MPT2SAS_DELL_6GBPS_SAS_BRANDING</span><span class="p">,</span>
		    <span class="n">MPT2SAS_DELL_BRANDING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dell_branding</span><span class="p">,</span> <span class="s">&quot;0x%4X&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: Vendor(0x%04X), Device(0x%04X),&quot;</span>
	    <span class="s">&quot; SSVID(0x%04X), SSDID(0x%04X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dell_branding</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_intel_branding - Display branding string</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_intel_branding</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2008</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS2LL080_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS2LL080_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS2LL040_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS2LL040_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RAMSDALE_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RAMSDALE_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2308_2</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RS25GB008_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RS25GB008_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS25JB080_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS25JB080_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS25JB040_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS25JB040_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS25KB080_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS25KB080_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_INTEL_RMS25KB040_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_INTEL_RMS25KB040_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_hp_branding - Display branding string</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_hp_branding</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">!=</span> <span class="n">MPT2SAS_HP_3PAR_SSVID</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2004</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPT2SAS_HP_DAUGHTER_2_4_INTERNAL_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_HP_DAUGHTER_2_4_INTERNAL_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI2_MFGPAGE_DEVID_SAS2308_2</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPT2SAS_HP_2_4_INTERNAL_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_HP_2_4_INTERNAL_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_HP_2_4_EXTERNAL_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_HP_2_4_EXTERNAL_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_HP_1_4_INTERNAL_1_4_EXTERNAL_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_HP_1_4_INTERNAL_1_4_EXTERNAL_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPT2SAS_HP_EMBEDDED_2_4_INTERNAL_SSDID</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">MPT2SAS_HP_EMBEDDED_2_4_INTERNAL_BRANDING</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_display_ioc_capabilities - Disply IOC&#39;s capabilities.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_display_ioc_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">desc</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">iounit_pg1_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bios_version</span><span class="p">;</span>

	<span class="n">bios_version</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg3</span><span class="p">.</span><span class="n">BiosVersion</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg0</span><span class="p">.</span><span class="n">ChipName</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: FWVersion(%02d.%02d.%02d.%02d), &quot;</span>
	   <span class="s">&quot;ChipRevision(0x%02x), BiosVersion(%02d.%02d.%02d.%02d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
	   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">,</span>
	   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">bios_version</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">bios_version</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">bios_version</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="n">bios_version</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>

	<span class="n">_base_display_dell_branding</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">_base_display_intel_branding</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">_base_display_hp_branding</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Protocol=(&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_PROTOCOL_SCSI_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_PROTOCOL_SCSI_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sTarget&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;), &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Capabilities=(&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hide_ir_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_IOCFACTS_CAPABILITY_INTEGRATED_RAID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Raid&quot;</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_CAPABILITY_TLR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sTLR&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_CAPABILITY_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sMulticast&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_BIDIRECTIONAL_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sBIDI Target&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_CAPABILITY_EEDP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sEEDP&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_SNAPSHOT_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sSnapshot Buffer&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_DIAG_TRACE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDiag Trace Buffer&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_EXTENDED_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%sDiag Extended Buffer&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_TASK_SET_FULL_HANDLING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sTask Set Full&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iounit_pg1_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iounit_pg1_flags</span> <span class="o">&amp;</span> <span class="n">MPI2_IOUNITPAGE1_NATIVE_COMMAND_Q_DISABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sNCQ&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_update_missing_delay - change the missing delay timers</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @device_missing_delay: amount of time till device is reported missing</span>
<span class="cm"> * @io_missing_delay: interval IO is returned when there is a missing device</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> *</span>
<span class="cm"> * Passed on the command line, this function will modify the device missing</span>
<span class="cm"> * delay, as well as the io missing delay. This should be called at driver</span>
<span class="cm"> * load time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_update_missing_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">device_missing_delay</span><span class="p">,</span> <span class="n">u8</span> <span class="n">io_missing_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dmd</span><span class="p">,</span> <span class="n">dmd_new</span><span class="p">,</span> <span class="n">dmd_orignal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">io_missing_delay_original</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">Mpi2SasIOUnitPage1_t</span> <span class="o">*</span><span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">mpt2sas_config_get_number_hba_phys</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_phys</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage1_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit1PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg1</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* device missing delay */</span>
	<span class="n">dmd</span> <span class="o">=</span> <span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">ReportDeviceMissingDelay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmd</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_UNIT_16</span><span class="p">)</span>
		<span class="n">dmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmd</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dmd</span> <span class="o">=</span> <span class="n">dmd</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">;</span>
	<span class="n">dmd_orignal</span> <span class="o">=</span> <span class="n">dmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&gt;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&gt;</span> <span class="mh">0x7F0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7F0</span> <span class="o">:</span>
		    <span class="n">device_missing_delay</span><span class="p">;</span>
		<span class="n">dmd</span> <span class="o">=</span> <span class="n">dmd</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dmd</span> <span class="o">|=</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_UNIT_16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dmd</span> <span class="o">=</span> <span class="n">device_missing_delay</span><span class="p">;</span>
	<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">ReportDeviceMissingDelay</span> <span class="o">=</span> <span class="n">dmd</span><span class="p">;</span>

	<span class="cm">/* io missing delay */</span>
	<span class="n">io_missing_delay_original</span> <span class="o">=</span> <span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">IODeviceMissingDelay</span><span class="p">;</span>
	<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">IODeviceMissingDelay</span> <span class="o">=</span> <span class="n">io_missing_delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_config_set_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">sas_iounit_pg1</span><span class="p">,</span>
	    <span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmd</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_UNIT_16</span><span class="p">)</span>
			<span class="n">dmd_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmd</span> <span class="o">&amp;</span>
			    <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dmd_new</span> <span class="o">=</span>
		    <span class="n">dmd</span> <span class="o">&amp;</span> <span class="n">MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;device_missing_delay: old(%d), &quot;</span>
		    <span class="s">&quot;new(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dmd_orignal</span><span class="p">,</span> <span class="n">dmd_new</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;ioc_missing_delay: old(%d), &quot;</span>
		    <span class="s">&quot;new(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">io_missing_delay_original</span><span class="p">,</span>
		    <span class="n">io_missing_delay</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">=</span> <span class="n">dmd_new</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">io_missing_delay</span> <span class="o">=</span> <span class="n">io_missing_delay</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_static_config_pages - static start of day config pages</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_static_config_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iounit_pg1_flags</span><span class="p">;</span>

	<span class="n">mpt2sas_config_get_manufacturing_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="n">mpt2sas_config_get_manufacturing_pg10</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg10</span><span class="p">);</span>
	<span class="n">mpt2sas_config_get_bios_pg2</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">);</span>
	<span class="n">mpt2sas_config_get_bios_pg3</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg3</span><span class="p">);</span>
	<span class="n">mpt2sas_config_get_ioc_pg8</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_pg8</span><span class="p">);</span>
	<span class="n">mpt2sas_config_get_iounit_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg0</span><span class="p">);</span>
	<span class="n">mpt2sas_config_get_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg1</span><span class="p">);</span>
	<span class="n">_base_display_ioc_capabilities</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable task_set_full handling in iounit_pg1 when the</span>
<span class="cm">	 * facts capabilities indicate that its supported.</span>
<span class="cm">	 */</span>
	<span class="n">iounit_pg1_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCFACTS_CAPABILITY_TASK_SET_FULL_HANDLING</span><span class="p">))</span>
		<span class="n">iounit_pg1_flags</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="n">MPI2_IOUNITPAGE1_DISABLE_TASK_SET_FULL_HANDLING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iounit_pg1_flags</span> <span class="o">|=</span>
		    <span class="n">MPI2_IOUNITPAGE1_DISABLE_TASK_SET_FULL_HANDLING</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg1</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">iounit_pg1_flags</span><span class="p">);</span>
	<span class="n">mpt2sas_config_set_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iounit_pg1</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_release_memory_pools - release memory</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Free memory allocated from _base_allocate_memory_pools.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_release_memory_pools</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma_sz</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;request_pool(0x%p)&quot;</span>
		    <span class="s">&quot;: free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">)</span>
			<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">);</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sense_pool(0x%p)&quot;</span>
		    <span class="s">&quot;: free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span><span class="p">)</span>
			<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span><span class="p">);</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_pool(0x%p)&quot;</span>
		     <span class="s">&quot;: free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span><span class="p">)</span>
			<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span><span class="p">);</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_free_pool&quot;</span>
		    <span class="s">&quot;(0x%p): free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span><span class="p">)</span>
			<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span><span class="p">);</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;reply_post_free_pool(0x%p): free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;config_page(0x%p): free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span><span class="p">));</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_sz</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_pages</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer</span><span class="p">)</span>
				<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer_dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span><span class="p">)</span>
			<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span><span class="p">);</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_pages</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _base_allocate_memory_pools - allocate start of day memory pools</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 success, anything else error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_allocate_memory_pools</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt2sas_facts</span> <span class="o">*</span><span class="n">facts</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_sge_elements</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chains_needed_per_io</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span><span class="p">,</span> <span class="n">total_sz</span><span class="p">,</span> <span class="n">reply_post_free_sz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">retry_sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_request_credit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">retry_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">facts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">;</span>

	<span class="cm">/* command line tunables  for max sgl entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_sgl_entries</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_sgl_entries</span> <span class="o">&lt;</span>
		    <span class="n">MPT2SAS_SG_DEPTH</span><span class="p">)</span> <span class="o">?</span> <span class="n">max_sgl_entries</span> <span class="o">:</span>
		    <span class="n">MPT2SAS_SG_DEPTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">MPT2SAS_SG_DEPTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* command line tunables  for max controller queue depth */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">max_request_credit</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_queue_depth</span> <span class="o">&lt;</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span><span class="p">)</span>
		    <span class="o">?</span> <span class="n">max_queue_depth</span> <span class="o">:</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_request_credit</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span><span class="p">,</span>
		    <span class="n">MAX_HBA_QUEUE_DEPTH</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">=</span> <span class="n">max_request_credit</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">HighPriorityCredit</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* request frame size */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCRequestFrameSize</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* reply frame size */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyFrameSize</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

 <span class="nl">retry_allocation:</span>
	<span class="n">total_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* calculate number of sg elements left over in the 1st frame */</span>
	<span class="n">max_sge_elements</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span> <span class="o">-</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSIIORequest_t</span><span class="p">)</span> <span class="o">-</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SGEIOUnion_t</span><span class="p">))</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_main_message</span> <span class="o">=</span> <span class="n">max_sge_elements</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="cm">/* now do the same for a chain buffer */</span>
	<span class="n">max_sge_elements</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span> <span class="o">=</span> <span class="n">max_sge_elements</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_offset_value_for_main_message</span> <span class="o">=</span>
	    <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SCSIIORequest_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SGEIOUnion_t</span><span class="p">))</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  MPT2SAS_SG_DEPTH = CONFIG_FUSION_MAX_SGE</span>
<span class="cm">	 */</span>
	<span class="n">chains_needed_per_io</span> <span class="o">=</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">-</span>
	   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_main_message</span><span class="p">)</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span><span class="p">)</span>
	    <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chains_needed_per_io</span> <span class="o">&gt;</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxChainDepth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chains_needed_per_io</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxChainDepth</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_main_message</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span>
		<span class="o">*</span> <span class="n">chains_needed_per_io</span><span class="p">),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chains_needed_per_io</span> <span class="o">=</span> <span class="n">chains_needed_per_io</span><span class="p">;</span>

	<span class="cm">/* reply free queue sizing - taking into account for 64 FW events */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">+</span> <span class="mi">64</span><span class="p">;</span>

	<span class="cm">/* align the reply post queue on the next 16 count boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">+</span>
				<span class="mi">32</span> <span class="o">-</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">&gt;</span>
	    <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxReplyDescriptorPostQueueDepth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxReplyDescriptorPostQueueDepth</span> <span class="o">-</span>
		    <span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxReplyDescriptorPostQueueDepth</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)),</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">-</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;scatter gather: &quot;</span>
	    <span class="s">&quot;sge_in_main_msg(%d), sge_per_chain(%d), sge_per_io(%d), &quot;</span>
	    <span class="s">&quot;chains_per_io(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_main_message</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">max_sges_in_chain_message</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chains_needed_per_io</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">-</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span><span class="p">;</span>

	<span class="cm">/* set the scsi host can_queue depth</span>
<span class="cm">	 * with some internal commands that could be outstanding</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;scsi host: &quot;</span>
	    <span class="s">&quot;can_queue depth (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">));</span>

	<span class="cm">/* contiguous pool for request and chains, 16 byte align, one extra &quot;</span>
<span class="cm">	 * &quot;frame for smid=0</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chains_needed_per_io</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>

	<span class="cm">/* hi-priority queue */</span>
	<span class="n">sz</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>

	<span class="cm">/* internal queue */</span>
	<span class="n">sz</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma_sz</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;request pool: pci_alloc_consistent &quot;</span>
		    <span class="s">&quot;failed: hba_depth(%d), chains_per_io(%d), frame_sz(%d), &quot;</span>
		    <span class="s">&quot;total(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chains_needed_per_io</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">,</span> <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">&lt;</span> <span class="n">MPT2SAS_SAS_QUEUE_DEPTH</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">retry_sz</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">=</span> <span class="n">max_request_credit</span> <span class="o">-</span> <span class="n">retry_sz</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry_allocation</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retry_sz</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;request pool: pci_alloc_consistent &quot;</span>
		    <span class="s">&quot;succeed: hba_depth(%d), chains_per_io(%d), frame_sz(%d), &quot;</span>
		    <span class="s">&quot;total(%d kb)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chains_needed_per_io</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">,</span> <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>


	<span class="cm">/* hi-priority queue */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">+</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">+</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>

	<span class="cm">/* internal queue */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">*</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span> <span class="o">*</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">);</span>


	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;request pool(0x%p): &quot;</span>
	    <span class="s">&quot;depth(%d), frame_size(%d), pool_size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_queue_depth</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;request pool: dma(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsiio_tracker</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_pages</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsiio_tracker</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span>
	    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;scsi_lookup: get_free_pages failed, &quot;</span>
		    <span class="s">&quot;sz(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sz</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;scsiio(0x%p): &quot;</span>
	    <span class="s">&quot;depth(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span><span class="p">,</span> <span class="n">MAX_CHAIN_DEPTH</span><span class="p">);</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chain_tracker</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_pages</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">chain_tracker</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span>
	    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;chain_lookup: get_free_pages failed, &quot;</span>
		    <span class="s">&quot;sz(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sz</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;chain pool&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;chain_dma_pool: pci_pool_create &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_dma_pool</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">chain_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">chain_done:</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;chain pool depth&quot;</span>
	    <span class="s">&quot;(%d), frame_size(%d), pool_size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">,</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span> <span class="o">*</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="p">))</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>

	<span class="cm">/* initialize hi-priority queue smid&#39;s */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_tracker</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;hpr_lookup: kcalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;hi_priority(0x%p): &quot;</span>
	    <span class="s">&quot;depth(%d), start smid(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">));</span>

	<span class="cm">/* initialize internal queue smid&#39;s */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_tracker</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;internal_lookup: kcalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;internal(0x%p): &quot;</span>
	    <span class="s">&quot;depth(%d), start smid(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">,</span>
	     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">));</span>

	<span class="cm">/* sense buffers, 4 byte align */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span> <span class="o">*</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;sense pool&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;sense pool: pci_pool_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma_pool</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;sense pool: pci_pool_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
	    <span class="s">&quot;sense pool(0x%p): depth(%d), element_size(%d), pool_size&quot;</span>
	    <span class="s">&quot;(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">,</span>
	    <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sense_dma(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="cm">/* reply pool, 4 byte align */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;reply pool&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply pool: pci_pool_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_pool</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply pool: pci_pool_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_min_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma_max_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">)</span> <span class="o">+</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply pool(0x%p): depth&quot;</span>
	    <span class="s">&quot;(%d), frame_size(%d), pool_size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_dma(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="cm">/* reply free queue, 16 byte align */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;reply_free pool&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply_free pool: pci_pool_create &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma_pool</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply_free pool: pci_pool_alloc &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_free pool(0x%p): &quot;</span>
	    <span class="s">&quot;depth(%d), element_size(%d), pool_size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_free_dma&quot;</span>
	    <span class="s">&quot;(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="cm">/* reply post queue, 16 byte align */</span>
	<span class="n">reply_post_free_sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2DefaultReplyDescriptor_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">reply_post_free_sz</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">reply_post_free_sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;reply_post_free pool&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply_post_free pool: pci_pool_create &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma_pool</span> <span class="p">,</span>
	    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;reply_post_free pool: pci_pool_alloc &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply post free pool&quot;</span>
	    <span class="s">&quot;(0x%p): depth(%d), element_size(%d), pool_size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="n">sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;reply_post_free_dma = &quot;</span>
	    <span class="s">&quot;(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;config page: pci_pool_alloc &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;config page(0x%p): size&quot;</span>
	    <span class="s">&quot;(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_sz</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;config_page_dma&quot;</span>
	    <span class="s">&quot;(0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_dma</span><span class="p">));</span>
	<span class="n">total_sz</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_page_sz</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Allocated physical memory: size(%d kB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">total_sz</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Current Controller Queue Depth(%d), &quot;</span>
	    <span class="s">&quot;Max Controller Queue Depth(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Scatter Gather Elements per IO(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_get_iocstate - Get the current state of a MPT adapter.</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @cooked: Request raw or cooked IOC state</span>
<span class="cm"> *</span>
<span class="cm"> * Returns all IOC Doorbell register bits if cooked==0, else just the</span>
<span class="cm"> * Doorbell bits in MPI_IOC_STATE_MASK.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cooked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">s</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cooked</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_wait_on_iocstate - waiting on a particular ioc state</span>
<span class="cm"> * @ioc_state: controller state { READY, OPERATIONAL, or RESET }</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_wait_on_iocstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ioc_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">cntdn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_state</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span><span class="o">*</span><span class="n">timeout</span> <span class="o">:</span> <span class="mi">2000</span><span class="o">*</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">current_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">ioc_state</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">current_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_wait_for_doorbell_int - waiting for controller interrupt(generated by</span>
<span class="cm"> * a write to the doorbell)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: MPI2_HIS_IOC2SYS_DB_STATUS - set to one when IOC writes to doorbell.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cntdn</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_status</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span><span class="o">*</span><span class="n">timeout</span> <span class="o">:</span> <span class="mi">2000</span><span class="o">*</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">int_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">MPI2_HIS_IOC2SYS_DB_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
			    <span class="s">&quot;successful count(%d), timeout(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed due to timeout count(%d), &quot;</span>
	    <span class="s">&quot;int_status(%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_wait_for_doorbell_ack - waiting for controller to read the doorbell.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: MPI2_HIS_SYS2IOC_DB_STATUS - set to one when host writes to</span>
<span class="cm"> * doorbell.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_wait_for_doorbell_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cntdn</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span><span class="o">*</span><span class="n">timeout</span> <span class="o">:</span> <span class="mi">2000</span><span class="o">*</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">int_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">MPI2_HIS_SYS2IOC_DB_STATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
			    <span class="s">&quot;successful count(%d), timeout(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">MPI2_HIS_IOC2SYS_DB_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">doorbell</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mpt2sas_base_fault_info</span><span class="p">(</span><span class="n">ioc</span> <span class="p">,</span> <span class="n">doorbell</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed due to timeout count(%d), &quot;</span>
	    <span class="s">&quot;int_status(%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">int_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_wait_for_doorbell_not_used - waiting for doorbell to not be in use</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_wait_for_doorbell_not_used</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cntdn</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell_reg</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span><span class="o">*</span><span class="n">timeout</span> <span class="o">:</span> <span class="mi">2000</span><span class="o">*</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">doorbell_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">doorbell_reg</span> <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_USED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
			    <span class="s">&quot;successful count(%d), timeout(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed due to timeout count(%d), &quot;</span>
	    <span class="s">&quot;doorbell_reg(%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">doorbell_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_send_ioc_reset - send doorbell reset</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @reset_type: currently only supports: MPI2_FUNCTION_IOC_MESSAGE_UNIT_RESET</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_send_ioc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reset_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_type</span> <span class="o">!=</span> <span class="n">MPI2_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: unknown reset_type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span>
	   <span class="n">MPI2_IOCFACTS_CAPABILITY_EVENT_REPLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sending message unit reset !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">reset_type</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_DOORBELL_FUNCTION_SHIFT</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_ack</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">_base_wait_on_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_IOC_STATE_READY</span><span class="p">,</span>
	    <span class="n">timeout</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed going to ready state &quot;</span>
		    <span class="s">&quot; (ioc_state=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;message unit reset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_handshake_req_reply_wait - send request thru doorbell interface</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @request_bytes: request length</span>
<span class="cm"> * @request: pointer having request payload</span>
<span class="cm"> * @reply_bytes: reply length</span>
<span class="cm"> * @reply: pointer to reply payload</span>
<span class="cm"> * @timeout: timeout in second</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_handshake_req_reply_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_bytes</span><span class="p">,</span>
    <span class="n">u32</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply_bytes</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">reply</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">default_reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">mfp</span><span class="p">;</span>

	<span class="cm">/* make sure doorbell is not in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_USED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell is in use &quot;</span>
		    <span class="s">&quot; (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear pending doorbell interrupts from previous state changes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_HIS_IOC2SYS_DB_STATUS</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>

	<span class="cm">/* send message to ioc */</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">MPI2_FUNCTION_HANDSHAKE</span><span class="o">&lt;&lt;</span><span class="n">MPI2_DOORBELL_FUNCTION_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">request_bytes</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">MPI2_DOORBELL_ADD_DWORDS_SHIFT</span><span class="p">)),</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">NO_SLEEP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell handshake &quot;</span>
		   <span class="s">&quot;int failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_ack</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell handshake &quot;</span>
		    <span class="s">&quot;ack failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send message 32-bits at a time */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">request_bytes</span><span class="o">/</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">failed</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_ack</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell handshake &quot;</span>
		    <span class="s">&quot;sending request failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now wait for the reply */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell handshake &quot;</span>
		   <span class="s">&quot;int failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read the first two 16-bits, it gives the total length of the reply */</span>
	<span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell handshake &quot;</span>
		   <span class="s">&quot;int failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">default_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;doorbell &quot;</span>
			    <span class="s">&quot;handshake int failed (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span>  <span class="n">reply_bytes</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="cm">/* overflow case */</span>
			<span class="n">dummy</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reply</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_base_wait_for_doorbell_int</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_base_wait_for_doorbell_not_used</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;doorbell is in use &quot;</span>
		    <span class="s">&quot; (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostInterruptStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">offset:data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply_bytes</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[0x%02x]:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mfp</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_sas_iounit_control - send sas iounit control to FW</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpi_reply: the reply payload from FW</span>
<span class="cm"> * @mpi_request: the request payload sent to FW</span>
<span class="cm"> *</span>
<span class="cm"> * The SAS IO Unit Control Request message allows the host to perform low-level</span>
<span class="cm"> * operations, such as resets on the PHYs of the IO Unit, also allows the host</span>
<span class="cm"> * to obtain the IOC assigned device handles for a device if it has other</span>
<span class="cm"> * identifying information about the device, in addition allows the host to</span>
<span class="cm"> * remove IOC resources associated with the device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_base_sas_iounit_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2SasIoUnitControlReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">,</span>
    <span class="n">Mpi2SasIoUnitControlRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: base_cmd in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mpi_request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlRequest_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">==</span> <span class="n">MPI2_SAS_OP_PHY_HARD_RESET</span> <span class="o">||</span>
	    <span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">==</span> <span class="n">MPI2_SAS_OP_PHY_LINK_RESET</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_link_reset_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">==</span> <span class="n">MPI2_SAS_OP_PHY_HARD_RESET</span> <span class="o">||</span>
	    <span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">==</span> <span class="n">MPI2_SAS_OP_PHY_LINK_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_link_reset_in_progress</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_link_reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlReply_t</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlReply_t</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_scsi_enclosure_processor - sending request to sep device</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpi_reply: the reply payload from FW</span>
<span class="cm"> * @mpi_request: the request payload sent to FW</span>
<span class="cm"> *</span>
<span class="cm"> * The SCSI Enclosure Processor request message causes the IOC to</span>
<span class="cm"> * communicate with SES devices to control LED status signals.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_base_scsi_enclosure_processor</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">Mpi2SepReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">Mpi2SepRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: base_cmd in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mpi_request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepReply_t</span><span class="p">));</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepReply_t</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SepReply_t</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_get_port_facts - obtain port facts reply and save in ioc</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_get_port_facts</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2PortFactsRequest_t</span> <span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2PortFactsReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt2sas_port_facts</span> <span class="o">*</span><span class="n">pfacts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpi_reply_sz</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mpi_reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortFactsReply_t</span><span class="p">);</span>
	<span class="n">mpi_request_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortFactsRequest_t</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_PORT_FACTS</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">PortNumber</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="n">mpi_reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: handshake failed (r=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfacts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pfacts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt2sas_port_facts</span><span class="p">));</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">PortNumber</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">PortNumber</span><span class="p">;</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">VP_ID</span><span class="p">;</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">VF_ID</span><span class="p">;</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxPostedCmdBuffers</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxPostedCmdBuffers</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_get_ioc_facts - obtain ioc facts reply and save in ioc</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_get_ioc_facts</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2IOCFactsRequest_t</span> <span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2IOCFactsReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt2sas_facts</span> <span class="o">*</span><span class="n">facts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpi_reply_sz</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mpi_reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCFactsReply_t</span><span class="p">);</span>
	<span class="n">mpi_request_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCFactsRequest_t</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_IOC_FACTS</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpi_request_sz</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="n">mpi_reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: handshake failed (r=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">facts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">facts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt2sas_facts</span><span class="p">));</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgVersion</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MsgVersion</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">HeaderVersion</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">HeaderVersion</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">VP_ID</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">VF_ID</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCExceptions</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCExceptions</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxChainDepth</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">WhoInit</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">WhoInit</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">NumberOfPorts</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxMSIxVectors</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxMSIxVectors</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">RequestCredit</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxReplyDescriptorPostQueueDepth</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxReplyDescriptorPostQueueDepth</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">ProductID</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">ProductID</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCCapabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCCapabilities</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCFACTS_CAPABILITY_INTEGRATED_RAID</span><span class="p">))</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCRequestFrameSize</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCRequestFrameSize</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxInitiators</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxInitiators</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxTargets</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxTargets</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxSasExpanders</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxSasExpanders</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxEnclosures</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxEnclosures</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">ProtocolFlags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">ProtocolFlags</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">HighPriorityCredit</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">HighPriorityCredit</span><span class="p">);</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyFrameSize</span> <span class="o">=</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">ReplyFrameSize</span><span class="p">;</span>
	<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxDevHandle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">MaxDevHandle</span><span class="p">);</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;hba queue depth(%d), &quot;</span>
	    <span class="s">&quot;max chains per io(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestCredit</span><span class="p">,</span>
	    <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MaxChainDepth</span><span class="p">));</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;request frame size(%d), &quot;</span>
	    <span class="s">&quot;reply frame size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCRequestFrameSize</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyFrameSize</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_send_ioc_init - send ioc_init to firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_send_ioc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2IOCInitRequest_t</span> <span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2IOCInitReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">current_time</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCInitRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_IOC_INIT</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">WhoInit</span> <span class="o">=</span> <span class="n">MPI2_WHOINIT_HOST_DRIVER</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI2_VERSION</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">HeaderVersion</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI2_HEADER_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
		<span class="n">mpi_request</span><span class="p">.</span><span class="n">HostMSIxVectors</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">SystemRequestFrameSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_sz</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">ReplyDescriptorPostQueueDepth</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">ReplyFreeQueueDepth</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span><span class="p">);</span>

	<span class="n">mpi_request</span><span class="p">.</span><span class="n">SenseBufferAddressHigh</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">SystemReplyAddressHigh</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">SystemRequestFrameBaseAddress</span> <span class="o">=</span>
	    <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">ReplyFreeQueueAddress</span> <span class="o">=</span>
	    <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_dma</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">ReplyDescriptorPostQueueAddress</span> <span class="o">=</span>
	    <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free_dma</span><span class="p">);</span>


	<span class="cm">/* This time stamp specifies number of milliseconds</span>
<span class="cm">	 * since epoch ~ midnight January 1, 1970.</span>
<span class="cm">	 */</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_time</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">TimeStamp</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">current_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">current_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">mfp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">mfp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">offset:data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCInitRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[0x%02x]:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mfp</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCInitRequest_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2IOCInitReply_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
	    <span class="n">sleep_flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: handshake failed (r=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span> <span class="o">||</span>
	    <span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_port_enable_done - command completion routine for port enable</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt2sas_port_enable_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span> <span class="o">&amp;&amp;</span> <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI2_FUNCTION_EVENT_ACK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpt2sas_port_enable_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan_failed</span> <span class="o">=</span> <span class="n">ioc_status</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _base_send_port_enable - send port_enable(discovery stuff) to firmware</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_send_port_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2PortEnableRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2PortEnableReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sending port enable !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: internal command already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortEnableRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_PORT_ENABLE</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="mi">300</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortEnableRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed with (ioc_status=0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;port enable: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
	    <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_port_enable - initiate firmware discovery (don&#39;t wait for reply)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_port_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2PortEnableRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sending port enable !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: internal command already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2PortEnableRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_PORT_ENABLE</span><span class="p">;</span>

	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_determine_wait_on_discovery - desposition</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Decide whether to wait on discovery to complete. Used to either</span>
<span class="cm"> * locate boot device, or report volumes ahead of physical devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 for wait, 0 for don&#39;t wait</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_determine_wait_on_discovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We wait for discovery to complete if IR firmware is loaded.</span>
<span class="cm">	 * The sas topology events arrive before PD events, so we need time to</span>
<span class="cm">	 * turn on the bit in ioc-&gt;pd_handles to indicate PD</span>
<span class="cm">	 * Also, it maybe required to report Volumes ahead of physical</span>
<span class="cm">	 * devices when MPI2_IOCPAGE8_IRFLAGS_LOW_VOLUME_MAPPING is set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if no Bios, then we don&#39;t need to wait */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg3</span><span class="p">.</span><span class="n">BiosVersion</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Bios is present, then we drop down here.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there any entries in the Bios Page 2, then we wait</span>
<span class="cm">	 * for discovery to complete.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Current Boot Device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">CurrentBootDeviceForm</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_NO_DEVICE_SPECIFIED</span> <span class="o">&amp;&amp;</span>
	<span class="cm">/* Request Boot Device */</span>
	   <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">ReqBootDeviceForm</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_NO_DEVICE_SPECIFIED</span> <span class="o">&amp;&amp;</span>
	<span class="cm">/* Alternate Request Boot Device */</span>
	   <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bios_pg2</span><span class="p">.</span><span class="n">ReqAltBootDeviceForm</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MPI2_BIOSPAGE2_FORM_NO_DEVICE_SPECIFIED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _base_unmask_events - turn on notification for this event</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event: firmware event</span>
<span class="cm"> *</span>
<span class="cm"> * The mask is stored in ioc-&gt;event_masks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_unmask_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">desired_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">desired_event</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">event</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">desired_event</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">desired_event</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">desired_event</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">desired_event</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_event_notification - send event notification</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_event_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2EventNotificationRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: internal command already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventNotificationRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_EVENT_NOTIFICATION</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPI2_EVENT_NOTIFY_EVENTMASK_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">EventMasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2EventNotificationRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_validate_event_type - validating event types</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @event: firmware event</span>
<span class="cm"> *</span>
<span class="cm"> * This will turn on firmware event notification when application</span>
<span class="cm"> * ask for that event. We don&#39;t mask events that are already enabled.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_validate_event_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">event_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event_mask</span><span class="p">,</span> <span class="n">desired_event</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_update_to_fw</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">send_update_to_fw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>
	    <span class="n">MPI2_EVENT_NOTIFY_EVENTMASK_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">event_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">desired_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">event_mask</span> <span class="o">&amp;</span> <span class="n">desired_event</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">desired_event</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">desired_event</span><span class="p">;</span>
				<span class="n">send_update_to_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desired_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">desired_event</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_update_to_fw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">_base_event_notification</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_diag_reset - the &quot;big hammer&quot; start of day reset</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_diag_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">host_diagnostic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hcb_size</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;sending diag reset !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;clear interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Write magic sequence to WriteSequence register</span>
<span class="cm">		 * Loop until in diagnostic mode</span>
<span class="cm">		 */</span>
		<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;write magic &quot;</span>
		    <span class="s">&quot;sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_FLUSH_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_1ST_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_2ND_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_3RD_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_4TH_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_5TH_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_6TH_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>

		<span class="cm">/* wait 100 msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">host_diagnostic</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostDiagnostic</span><span class="p">);</span>
		<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;wrote magic &quot;</span>
		    <span class="s">&quot;sequence: count(%d), host_diagnostic(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">host_diagnostic</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">host_diagnostic</span> <span class="o">&amp;</span> <span class="n">MPI2_DIAG_DIAG_WRITE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hcb_size</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HCBSize</span><span class="p">);</span>

	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;diag reset: issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host_diagnostic</span> <span class="o">|</span> <span class="n">MPI2_DIAG_RESET_ADAPTER</span><span class="p">,</span>
	     <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostDiagnostic</span><span class="p">);</span>

	<span class="cm">/* don&#39;t access any registers for 50 milliseconds */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* 300 second max wait */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3000000</span> <span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">host_diagnostic</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostDiagnostic</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host_diagnostic</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host_diagnostic</span> <span class="o">&amp;</span> <span class="n">MPI2_DIAG_RESET_ADAPTER</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* wait 100 msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host_diagnostic</span> <span class="o">&amp;</span> <span class="n">MPI2_DIAG_HCB_MODE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;restart the adapter &quot;</span>
		    <span class="s">&quot;assuming the HCB Address points to good F/W</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">host_diagnostic</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI2_DIAG_BOOT_DEVICE_SELECT_MASK</span><span class="p">;</span>
		<span class="n">host_diagnostic</span> <span class="o">|=</span> <span class="n">MPI2_DIAG_BOOT_DEVICE_SELECT_HCDW</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">host_diagnostic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostDiagnostic</span><span class="p">);</span>

		<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;re-enable the HCDW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">hcb_size</span> <span class="o">|</span> <span class="n">MPI2_HCB_SIZE_HCB_ENABLE</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HCBSize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;restart the adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host_diagnostic</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MPI2_DIAG_HOLD_IOC_RESET</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">HostDiagnostic</span><span class="p">);</span>

	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;disable writes to the &quot;</span>
	    <span class="s">&quot;diagnostic register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MPI2_WRSEQ_FLUSH_KEY_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">);</span>

	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;Wait for FW to go to the &quot;</span>
	    <span class="s">&quot;READY state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">_base_wait_on_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_IOC_STATE_READY</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
	    <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed going to ready state &quot;</span>
		    <span class="s">&quot; (ioc_state=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;diag reset: SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;diag reset: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_make_ioc_ready - put controller in READY state</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> * @type: FORCE_BIG_HAMMER or SOFT_RESET</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_make_ioc_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">,</span>
    <span class="k">enum</span> <span class="n">reset_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: ioc_state(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_DOORBELL_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;unexpected doorbell &quot;</span>
		    <span class="s">&quot;active!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">issue_diag_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt2sas_base_fault_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_state</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_DOORBELL_DATA_MASK</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">issue_diag_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FORCE_BIG_HAMMER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">issue_diag_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_base_send_ioc_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">MPI2_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">issue_diag_reset:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">_base_diag_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_make_ioc_operational - put controller in OPERATIONAL state</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_base_make_ioc_operational</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reply_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_tr_list</span> <span class="o">*</span><span class="n">delayed_tr</span><span class="p">,</span> <span class="o">*</span><span class="n">delayed_tr_next</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hide_flag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter_reply_queue</span> <span class="o">*</span><span class="n">reply_q</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">reply_post_free</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reply_post_free_sz</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="cm">/* clean the delayed target reset list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">,</span> <span class="n">delayed_tr_next</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">,</span> <span class="n">delayed_tr_next</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">delayed_tr_volume_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delayed_tr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">delayed_tr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* initialize the scsi lookup free list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">smid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chain_list</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">direct_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* hi-priority queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_free_list</span><span class="p">);</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_smid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hi_priority_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">smid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hpr_free_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* internal queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_free_list</span><span class="p">);</span>
	<span class="n">smid</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_smid</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">smid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_free_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* chain pool */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_chain_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chain_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tracker_list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">free_chain_list</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* initialize Reply Free Queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reply_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_dma</span> <span class="p">;</span>
	    <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">reply_address</span> <span class="o">+=</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reply_address</span><span class="p">);</span>

	<span class="cm">/* initialize reply queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span>
		<span class="n">_base_assign_reply_queues</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* initialize Reply Post Free Queue */</span>
	<span class="n">reply_post_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">;</span>
	<span class="n">reply_post_free_sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2DefaultReplyDescriptor_t</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_free</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mpi2ReplyDescriptorsUnion_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">reply_post_free</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_queue_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">reply_post_free</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Words</span> <span class="o">=</span>
							<span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ULLONG_MAX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip_init_reply_post_free_queue</span><span class="p">;</span>
		<span class="n">reply_post_free</span> <span class="o">+=</span> <span class="n">reply_post_free_sz</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">skip_init_reply_post_free_queue:</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_send_ioc_init</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* initialize reply free host index */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_queue_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_free_host_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFreeHostIndex</span><span class="p">);</span>

	<span class="cm">/* initialize reply post host index */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reply_q</span><span class="o">-&gt;</span><span class="n">msix_index</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_RPHI_MSIX_INDEX_SHIFT</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyPostHostIndex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_base_is_controller_msix_enabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip_init_reply_post_host_index</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">skip_init_reply_post_host_index:</span>

	<span class="n">_base_unmask_interrupts</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_event_notification</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
		<span class="n">_base_static_config_pages</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg10</span><span class="p">.</span><span class="n">OEMIdentifier</span>
		    <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hide_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">manu_pg10</span><span class="p">.</span><span class="n">OEMSpecificFlags0</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">MFG_PAGE10_HIDE_SSDS_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hide_flag</span> <span class="o">!=</span> <span class="n">MFG_PAGE10_HIDE_SSDS_MASK</span><span class="p">)</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfg_pg10_hide_flag</span> <span class="o">=</span> <span class="n">hide_flag</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_for_discovery_to_complete</span> <span class="o">=</span>
		    <span class="n">_base_determine_wait_on_discovery</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span> <span class="cm">/* scan_start and scan_finished support */</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_send_port_enable</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_free_resources - free resources controller resources (io/irq/memap)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_free_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">_base_mask_interrupts</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">_base_make_ioc_ready</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span> <span class="n">SOFT_RESET</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">_base_free_irq</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">_base_disable_msix</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_attach - attach controller instance</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_base_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu_id</span><span class="p">,</span> <span class="n">last_cpu_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="cm">/* setup cpu_msix_table */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_count</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu_id</span><span class="p">)</span>
		<span class="n">last_cpu_id</span> <span class="o">=</span> <span class="n">cpu_id</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table_sz</span> <span class="o">=</span> <span class="n">last_cpu_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_queue_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;allocation for &quot;</span>
		    <span class="s">&quot;cpu_msix_table failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table_sz</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">resource_size_t</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;allocation &quot;</span>
				<span class="s">&quot;for cpu_msix_table failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt2sas_base_map_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">resource_size_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyPostHostIndex</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table_sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resource_size_t</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x4000</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_get_ioc_facts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_make_ioc_ready</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span> <span class="n">SOFT_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt2sas_port_facts</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">_base_get_port_facts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_allocate_memory_pools</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="cm">/* allocate memory pd handle bitmask list */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevHandle</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevHandle</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles_sz</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles_sz</span><span class="p">,</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles_sz</span><span class="p">,</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fwfault_debug</span> <span class="o">=</span> <span class="n">mpt2sas_fwfault_debug</span><span class="p">;</span>

	<span class="cm">/* base internal command bits */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>

	<span class="cm">/* port_enable command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>

	<span class="cm">/* transport internal command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* scsih internal command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* task management internal command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* config page internal command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* ctl module internal command bits */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPI2_EVENT_NOTIFY_EVENTMASK_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">event_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* here we enable the events we care about */</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_SAS_DISCOVERY</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_SAS_BROADCAST_PRIMITIVE</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_SAS_TOPOLOGY_CHANGE_LIST</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_SAS_DEVICE_STATUS_CHANGE</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_SAS_ENCL_DEVICE_STATUS_CHANGE</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_IR_CONFIGURATION_CHANGE_LIST</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_IR_VOLUME</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_IR_PHYSICAL_DISK</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_IR_OPERATION_STATUS</span><span class="p">);</span>
	<span class="n">_base_unmask_events</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI2_EVENT_LOG_ENTRY_ADDED</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_make_ioc_operational</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">missing_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">missing_delay</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">_base_update_missing_delay</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">missing_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">missing_delay</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_resources:</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mpt2sas_base_free_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">_base_release_memory_pools</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_detach - remove controller instance</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_base_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mpt2sas_base_stop_watchdog</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mpt2sas_base_free_resources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">_base_release_memory_pools</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cpu_msix_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_warpdrive</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_post_host_index</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pd_handles</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">blocking_handles</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ctl_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">tm_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsih_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _base_reset_handler - reset callback handler (for base)</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @reset_phase: phase</span>
<span class="cm"> *</span>
<span class="cm"> * The handler for doing any required cleanup or initialization.</span>
<span class="cm"> *</span>
<span class="cm"> * The reset phase can be MPT2_IOC_PRE_RESET, MPT2_IOC_AFTER_RESET,</span>
<span class="cm"> * MPT2_IOC_DONE_RESET</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_base_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpt2sas_scsih_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reset_phase</span><span class="p">);</span>
	<span class="n">mpt2sas_ctl_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reset_phase</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_AFTER_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_AFTER_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan_failed</span> <span class="o">=</span>
				    <span class="n">MPI2_IOCSTATUS_INTERNAL_ERROR</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">start_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
						<span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_RESET</span><span class="p">;</span>
			<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">smid</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">USHRT_MAX</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">config_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT2_IOC_DONE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: &quot;</span>
		    <span class="s">&quot;MPT2_IOC_DONE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _wait_for_commands_to_complete - reset controller</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> *</span>
<span class="cm"> * This function waiting(3s) for all pending commands to complete</span>
<span class="cm"> * prior to putting controller in reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_wait_for_commands_to_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_flag</span> <span class="o">!=</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI2_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* pending command count */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsiio_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cb_idx</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* wait for pending commands to complete */</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pending_io_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_base_hard_reset_handler - reset controller</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @sleep_flag: CAN_SLEEP or NO_SLEEP</span>
<span class="cm"> * @type: FORCE_BIG_HAMMER or SOFT_RESET</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_flag</span><span class="p">,</span>
    <span class="k">enum</span> <span class="n">reset_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: pci error recovery reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_fwfault_debug</span><span class="p">)</span>
		<span class="n">mpt2sas_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* TODO - What we really should be doing is pulling</span>
<span class="cm">	 * out all the code associated with NO_SLEEP; its never used.</span>
<span class="cm">	 * That is legacy code from mpt fusion driver, ported over.</span>
<span class="cm">	 * I will leave this BUG_ON here for now till its been resolved.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sleep_flag</span> <span class="o">==</span> <span class="n">NO_SLEEP</span><span class="p">);</span>

	<span class="cm">/* wait for an active reset in progress to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_in_progress_mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">_base_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT2_IOC_PRE_RESET</span><span class="p">);</span>
	<span class="n">_wait_for_commands_to_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="n">_base_mask_interrupts</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_make_ioc_ready</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">_base_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT2_IOC_AFTER_RESET</span><span class="p">);</span>

	<span class="cm">/* If this hard reset is called while port enable is active, then</span>
<span class="cm">	 * there is no reason to call make_ioc_operational</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">is_driver_loading</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_enable_failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">remove_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">_base_make_ioc_operational</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleep_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">_base_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT2_IOC_DONE_RESET</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">)));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_status</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_in_progress_mutex</span><span class="p">);</span>

 <span class="nl">out_unlocked:</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
