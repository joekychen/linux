<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › mpt2sas › mpt2sas_transport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpt2sas_transport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SAS Transport Layer for MPT (Message Passing Technology) based controllers</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on drivers/scsi/mpt2sas/mpt2_transport.c</span>
<span class="cm"> * Copyright (C) 2007-2010  LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm"> * CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm"> * LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm"> * solely responsible for determining the appropriateness of using and</span>
<span class="cm"> * distributing the Program and assumes all risks associated with its</span>
<span class="cm"> * exercise of rights under this Agreement, including but not limited to</span>
<span class="cm"> * the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm"> * programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm"> * DISCLAIMER OF LIABILITY</span>
<span class="cm"> * NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm"> * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm"> * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm"> * USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm"> * HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301,</span>
<span class="cm"> * USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_sas.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#include &quot;mpt2sas_base.h&quot;</span>
<span class="cm">/**</span>
<span class="cm"> * _transport_sas_node_find_by_sas_address - sas node search</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address of expander or sas host</span>
<span class="cm"> * Context: Calling function should acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Search for either hba phys or expander device based on handle, then returns</span>
<span class="cm"> * the sas_node object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span>
<span class="nf">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">mpt2sas_scsih_expander_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">sas_address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_convert_phy_link_rate -</span>
<span class="cm"> * @link_rate: link rate returned from mpt firmware</span>
<span class="cm"> *</span>
<span class="cm"> * Convert link_rate from mpi fusion into sas_transport form.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sas_linkrate</span>
<span class="nf">_transport_convert_phy_link_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">link_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sas_linkrate</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_3_0</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_6_0</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_PHY_DISABLED</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_PHY_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_NEGOTIATION_FAILED</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_PORT_SELECTOR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_SATA_PORT_SELECTOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_SMP_RESET_IN_PROGRESS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_PHY_RESET_IN_PROGRESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_SATA_OOB_COMPLETE</span>:
	<span class="k">case</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_UNKNOWN_LINK_RATE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_set_identify - set identify for phys and end devices</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: device handle</span>
<span class="cm"> * @identify: sas identify info</span>
<span class="cm"> *</span>
<span class="cm"> * Populates sas identify info.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_set_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sas_identify</span> <span class="o">*</span><span class="n">identify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SasDevicePage0_t</span> <span class="n">sas_device_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device_pg0</span><span class="p">,</span>
	    <span class="n">MPI2_SAS_DEVICE_PGAD_FORM_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>

		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;handle(0x%04x), ioc_status(0x%04x)&quot;</span>
		    <span class="s">&quot;</span><span class="se">\n</span><span class="s">failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span>
		     <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">identify</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify</span><span class="p">));</span>
	<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">DeviceInfo</span><span class="p">);</span>

	<span class="cm">/* sas_address */</span>
	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">SASAddress</span><span class="p">);</span>

	<span class="cm">/* phy number of the parent device this device is linked to */</span>
	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">sas_device_pg0</span><span class="p">.</span><span class="n">PhyNum</span><span class="p">;</span>

	<span class="cm">/* device_type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_MASK_DEVICE_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE_INFO_NO_DEVICE</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_PHY_UNUSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE_INFO_END_DEVICE</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_END_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE_INFO_EDGE_EXPANDER</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI2_SAS_DEVICE_INFO_FANOUT_EXPANDER</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initiator_port_protocols */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SSP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_STP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SMP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SATA_HOST</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>

	<span class="cm">/* target_port_protocols */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SMP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_done -  internal transport layer callback handler.</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @smid: system request message index</span>
<span class="cm"> * @msix_index: MSIX table index supplied by the OS</span>
<span class="cm"> * @reply: reply message frame(lower 32bit addr)</span>
<span class="cm"> *</span>
<span class="cm"> * Callback handler when sending internal generated transport cmds.</span>
<span class="cm"> * The callback index passed is `ioc-&gt;transport_cb_idx`</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 meaning mf should be freed from _base_interrupt</span>
<span class="cm"> *        0 means the mf is freed from this function.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt2sas_transport_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">smid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msix_index</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI2DefaultReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>

	<span class="n">mpi_reply</span> <span class="o">=</span>  <span class="n">mpt2sas_base_get_reply_virt_addr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">!=</span> <span class="n">smid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span>
		    <span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* report manufacture request structure */</span>
<span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* report manufacture reply structure */</span>
<span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x41 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x01 */</span>
	<span class="n">u8</span> <span class="n">function_result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expander_change_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">sas_format</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">vendor_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_VENDOR_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">product_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_PRODUCT_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">product_rev</span><span class="p">[</span><span class="n">SAS_EXPANDER_PRODUCT_REV_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">component_vendor_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_COMPONENT_VENDOR_ID_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">component_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">component_revision_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vendor_specific</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_expander_report_manufacture - obtain SMP report_manufacture</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: expander sas address</span>
<span class="cm"> * @edev: the sas_expander_device object</span>
<span class="cm"> *</span>
<span class="cm"> * Fills in the sas_expander_device object when SMP port is created.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_expander_report_manufacture</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rep_manu_reply</span> <span class="o">*</span><span class="n">manufacture_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rep_manu_request</span> <span class="o">*</span><span class="n">manufacture_request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_out_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: transport_cmds in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: ioc is operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">);</span>
	<span class="n">data_out</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_out_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">manufacture_request</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">smp_frame_type</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SASAddress</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">));</span>
	<span class="n">psge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>

	<span class="cm">/* WRITE sgel first */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_HOST_TO_IOC</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">),</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="cm">/* incr sgel */</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="cm">/* READ sgel last */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">),</span> <span class="n">data_out_dma</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">));</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;report_manufacture - &quot;</span>
	    <span class="s">&quot;send to sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;report_manufacture - &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;report_manufacture - reply data transfer size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">manufacture_reply</span> <span class="o">=</span> <span class="n">data_out</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span>
		     <span class="n">SAS_EXPANDER_VENDOR_ID_LEN</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span>
		     <span class="n">SAS_EXPANDER_PRODUCT_ID_LEN</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_rev</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">product_rev</span><span class="p">,</span>
		     <span class="n">SAS_EXPANDER_PRODUCT_REV_LEN</span><span class="p">);</span>
		<span class="n">edev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">sas_format</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_vendor_id</span><span class="p">,</span>
			    <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_vendor_id</span><span class="p">,</span>
			     <span class="n">SAS_EXPANDER_COMPONENT_VENDOR_ID_LEN</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">;</span>
			<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_id</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_revision_id</span> <span class="o">=</span>
			    <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_revision_id</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;report_manufacture - no reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_out</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">data_out</span><span class="p">,</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_delete_port - helper function to removing a port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpt2sas_port: mpt2sas per port object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_delete_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sas_device_type</span> <span class="n">device_type</span> <span class="o">=</span>
	    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	    <span class="s">&quot;remove: sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sas_address</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">|=</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
		<span class="n">mpt2sas_device_remove_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">||</span>
	    <span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span>
		<span class="n">mpt2sas_expander_remove</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_delete_phy - helper function to removing single phy from port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpt2sas_port: mpt2sas per port object</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_delete_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	    <span class="s">&quot;remove: sas_addr(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">);</span>
	<span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">--</span><span class="p">;</span>
	<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_add_phy - helper function to adding single phy to port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpt2sas_port: mpt2sas per port object</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_add_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	    <span class="s">&quot;add: sas_addr(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">sas_address</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">);</span>
	<span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sas_port_add_phy</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_add_phy_to_an_existing_port - adding new phy to existing port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_node: sas node object (either expander or sas host)</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> * @sas_address: sas address of device/expander were phy needs to be added to</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_add_phy_to_an_existing_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">phy_srch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span>
	    <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
		    <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">phy_srch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">,</span>
		    <span class="n">port_siblings</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_srch</span> <span class="o">==</span> <span class="n">mpt2sas_phy</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">_transport_add_phy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_port</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_del_phy_from_an_existing_port - delete phy from existing port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_node: sas node object (either expander or sas host)</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_del_phy_from_an_existing_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">phy_srch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span>
	    <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">phy_srch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">,</span>
		    <span class="n">port_siblings</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_srch</span> <span class="o">!=</span> <span class="n">mpt2sas_phy</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">_transport_delete_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_port</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">_transport_delete_phy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_port</span><span class="p">,</span>
				    <span class="n">mpt2sas_phy</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_sanity_check - sanity check when adding a new port</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_node: sas node object (either expander or sas host)</span>
<span class="cm"> * @sas_address: sas address of device being added</span>
<span class="cm"> *</span>
<span class="cm"> * See the explanation above from _transport_delete_duplicate_port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_transport_sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">,</span>
     <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_belongs_to_port</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">_transport_del_phy_from_an_existing_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_node</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_port_add - insert port to the list</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @handle: handle of attached device</span>
<span class="cm"> * @sas_address: sas address of parent expander or sas host</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Adding new port object to the sas_node-&gt;sas_port_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns mpt2sas_port.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span>
<span class="nf">mpt2sas_transport_port_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">mpt2sas_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_sas_port</span><span class="p">),</span>
	    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_node</span> <span class="o">=</span> <span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: Could not find &quot;</span>
		    <span class="s">&quot;parent sas_address(0x%016llx)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_PHY_UNUSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_transport_sanity_check</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_node</span><span class="p">,</span>
	    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_siblings</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">);</span>
		<span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">sas_port_alloc_num</span><span class="p">(</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sas_port_add</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">,</span>
	    <span class="n">port_siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;add: handle(0x%04x)&quot;</span>
			    <span class="s">&quot;, sas_addr(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
		<span class="n">sas_port_add_phy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_end_device_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_expander_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">);</span>

	<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">=</span> <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sas_rphy_add</span><span class="p">(</span><span class="n">rphy</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;add: handle(0x%04x), &quot;</span>
		    <span class="s">&quot;sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">rphy</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* fill in report manufacture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
	    <span class="n">MPI2_SAS_DEVICE_INFO_EDGE_EXPANDER</span> <span class="o">||</span>
	    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
	    <span class="n">MPI2_SAS_DEVICE_INFO_FANOUT_EXPANDER</span><span class="p">)</span>
		<span class="n">_transport_expander_report_manufacture</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">rphy</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mpt2sas_port</span><span class="p">;</span>

 <span class="nl">out_fail:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">,</span>
	    <span class="n">port_siblings</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_port_remove - remove port from the list</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address of attached device</span>
<span class="cm"> * @sas_address_parent: sas address of parent expander or sas host</span>
<span class="cm"> * Context: This function will acquire ioc-&gt;sas_node_lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Removing object and freeing associated memory from the</span>
<span class="cm"> * ioc-&gt;sas_port_list.</span>
<span class="cm"> *</span>
<span class="cm"> * Return nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_transport_port_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span>
    <span class="n">u64</span> <span class="n">sas_address_parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_port</span> <span class="o">*</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="o">*</span><span class="n">next_phy</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_node</span> <span class="o">=</span> <span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_address_parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">sas_port_list</span><span class="p">,</span>
	    <span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remote_identify</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">next_phy</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">phy_list</span><span class="p">,</span> <span class="n">port_siblings</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;remove: sas_addr(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
			    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
		<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_belongs_to_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sas_port_delete</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mpt2sas_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_add_host_phy - report sas_host phy to transport</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> * @phy_pg0: sas phy page 0</span>
<span class="cm"> * @parent_dev: parent device class object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_transport_add_host_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_phy</span>
    <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">Mpi2SasPhyPage0_t</span> <span class="n">phy_pg0</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>


	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">sas_phy_alloc</span><span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">;</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_pg0</span><span class="p">.</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">)</span>
		<span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">NegotiatedLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_MASK_PHYSICAL</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">HwLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_HWRATE_MIN_RATE_MASK</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">HwLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_PRATE_MIN_RATE_MASK</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sas_phy_add</span><span class="p">(</span><span class="n">phy</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">sas_phy_free</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;add: handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">attached_handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_add_expander_phy - report expander phy to transport</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @mpt2sas_phy: mpt2sas per phy object</span>
<span class="cm"> * @expander_pg1: expander page 1</span>
<span class="cm"> * @parent_dev: parent device class object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt2sas_transport_add_expander_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_sas_phy</span>
    <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">Mpi2ExpanderPage1_t</span> <span class="n">expander_pg1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">port_siblings</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">sas_phy_alloc</span><span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">;</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_pg1</span><span class="p">.</span><span class="n">AttachedDevHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">)</span>
		<span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">NegotiatedLinkRate</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_SAS_NEG_LINK_RATE_MASK_PHYSICAL</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">HwLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_HWRATE_MIN_RATE_MASK</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">HwLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_PRATE_MIN_RATE_MASK</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
	    <span class="n">expander_pg1</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sas_phy_add</span><span class="p">(</span><span class="n">phy</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">sas_phy_free</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;add: handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">attached_handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt2sas_transport_update_links - refreshing phy link changes</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @sas_address: sas address of parent expander or sas host</span>
<span class="cm"> * @handle: attached device handle</span>
<span class="cm"> * @phy_numberv: phy number</span>
<span class="cm"> * @link_rate: new link rate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns nothing.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt2sas_transport_update_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
     <span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_number</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_node</span> <span class="o">*</span><span class="n">sas_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_sas_phy</span> <span class="o">*</span><span class="n">mpt2sas_phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_node</span> <span class="o">=</span> <span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt2sas_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sas_node</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_number</span><span class="p">];</span>
	<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">attached_handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">&gt;=</span> <span class="n">MPI2_SAS_NEG_LINK_RATE_1_5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_transport_set_identify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">);</span>
		<span class="n">_transport_add_phy_to_an_existing_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_node</span><span class="p">,</span>
		    <span class="n">mpt2sas_phy</span><span class="p">,</span> <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
		    <span class="n">sas_identify</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span>
		<span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span>
		    <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span><span class="n">link_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">logging_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_TRANSPORT</span><span class="p">))</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;refresh: parent sas_addr(0x%016llx),</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">link_rate(0x%02x), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">attached_handle(0x%04x), sas_addr(0x%016llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">,</span>
		    <span class="n">link_rate</span><span class="p">,</span> <span class="n">phy_number</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">mpt2sas_phy</span><span class="o">-&gt;</span><span class="n">remote_identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">phy_to_ioc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">rphy_to_ioc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* report phy error log structure */</span>
<span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x40 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x11 */</span>
	<span class="n">u8</span> <span class="n">allocated_response_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request_length</span><span class="p">;</span> <span class="cm">/* 02 */</span>
	<span class="n">u8</span> <span class="n">reserved_1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">phy_identifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* report phy error log reply structure */</span>
<span class="k">struct</span> <span class="n">phy_error_log_reply</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x41 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x11 */</span>
	<span class="n">u8</span> <span class="n">function_result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response_length</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">expander_change_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">phy_identifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">invalid_dword</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">running_disparity_error</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">loss_of_dword_sync</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">phy_reset_problem</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_get_expander_phy_error_log - return expander counters</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_get_expander_phy_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_error_log_request</span> <span class="o">*</span><span class="n">phy_error_log_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_error_log_reply</span> <span class="o">*</span><span class="n">phy_error_log_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_out_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: transport_cmds in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: ioc is operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_reply</span><span class="p">);</span>
	<span class="n">data_out</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_out_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">phy_error_log_request</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
	<span class="n">phy_error_log_request</span><span class="o">-&gt;</span><span class="n">smp_frame_type</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">phy_error_log_request</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">phy_error_log_request</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">phy_error_log_request</span><span class="o">-&gt;</span><span class="n">allocated_response_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy_error_log_request</span><span class="o">-&gt;</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SASAddress</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">));</span>
	<span class="n">psge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>

	<span class="cm">/* WRITE sgel first */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_HOST_TO_IOC</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">),</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="cm">/* incr sgel */</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="cm">/* READ sgel last */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_reply</span><span class="p">),</span> <span class="n">data_out_dma</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">));</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy_error_log - &quot;</span>
	    <span class="s">&quot;send to sas_addr(0x%016llx), phy(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">));</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy_error_log - &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_error_log - reply data transfer size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_reply</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">phy_error_log_reply</span> <span class="o">=</span> <span class="n">data_out</span> <span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">);</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_error_log - function_result(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_error_log_reply</span><span class="o">-&gt;</span><span class="n">function_result</span><span class="p">));</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">invalid_dword_count</span> <span class="o">=</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">phy_error_log_reply</span><span class="o">-&gt;</span><span class="n">invalid_dword</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">running_disparity_error_count</span> <span class="o">=</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">phy_error_log_reply</span><span class="o">-&gt;</span><span class="n">running_disparity_error</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">loss_of_dword_sync_count</span> <span class="o">=</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">phy_error_log_reply</span><span class="o">-&gt;</span><span class="n">loss_of_dword_sync</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_reset_problem_count</span> <span class="o">=</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">phy_error_log_reply</span><span class="o">-&gt;</span><span class="n">phy_reset_problem</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_error_log - no reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_out</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">data_out</span><span class="p">,</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_get_linkerrors - return phy counters for both hba and expanders</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_get_linkerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasPhyPage1_t</span> <span class="n">phy_pg1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_transport_get_expander_phy_error_log</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* get hba phy error logs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_phy_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_pg1</span><span class="p">,</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span> <span class="o">||</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy(%d), ioc_status&quot;</span>
		    <span class="s">&quot;(0x%04x), loginfo(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">));</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">invalid_dword_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_pg1</span><span class="p">.</span><span class="n">InvalidDwordCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">running_disparity_error_count</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_pg1</span><span class="p">.</span><span class="n">RunningDisparityErrorCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">loss_of_dword_sync_count</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_pg1</span><span class="p">.</span><span class="n">LossDwordSynchCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_reset_problem_count</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_pg1</span><span class="p">.</span><span class="n">PhyResetProblemCount</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_get_enclosure_identifier -</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Obtain the enclosure logical id for an expander.</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_get_enclosure_identifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">identifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">rphy_to_ioc</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">identifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_get_bay_identifier -</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the slot id for a device that resides inside an enclosure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_get_bay_identifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">rphy_to_ioc</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_sas_device</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sas_device</span> <span class="o">=</span> <span class="n">mpt2sas_scsih_sas_device_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* phy control request structure */</span>
<span class="k">struct</span> <span class="n">phy_control_request</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x40 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x91 */</span>
	<span class="n">u8</span> <span class="n">allocated_response_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request_length</span><span class="p">;</span> <span class="cm">/* 0x09 */</span>
	<span class="n">u16</span> <span class="n">expander_change_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">phy_identifier</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_operation</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_2</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">attached_device_name</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">programmed_min_physical_link_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">programmed_max_physical_link_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved_3</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* phy control reply structure */</span>
<span class="k">struct</span> <span class="n">phy_control_reply</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x41 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x11 */</span>
	<span class="n">u8</span> <span class="n">function_result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SMP_PHY_CONTROL_LINK_RESET	(0x01)</span>
<span class="cp">#define SMP_PHY_CONTROL_HARD_RESET	(0x02)</span>
<span class="cp">#define SMP_PHY_CONTROL_DISABLE		(0x03)</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_expander_phy_control - expander phy control</span>
<span class="cm"> * @ioc: per adapter object</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_expander_phy_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Mpi2SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_control_request</span> <span class="o">*</span><span class="n">phy_control_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_control_reply</span> <span class="o">*</span><span class="n">phy_control_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_out_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: transport_cmds in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: ioc is operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_request</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_reply</span><span class="p">);</span>
	<span class="n">data_out</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_out_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span>
		    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mpt2sas_base_free_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">phy_control_request</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">smp_frame_type</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">allocated_response_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">phy_operation</span> <span class="o">=</span> <span class="n">phy_operation</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">programmed_min_physical_link_rate</span> <span class="o">=</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">phy_control_request</span><span class="o">-&gt;</span><span class="n">programmed_max_physical_link_rate</span> <span class="o">=</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SASAddress</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_error_log_request</span><span class="p">));</span>
	<span class="n">psge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>

	<span class="cm">/* WRITE sgel first */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_HOST_TO_IOC</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_request</span><span class="p">),</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="cm">/* incr sgel */</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="cm">/* READ sgel last */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_reply</span><span class="p">),</span> <span class="n">data_out_dma</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_request</span><span class="p">));</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy_control - &quot;</span>
	    <span class="s">&quot;send to sas_addr(0x%016llx), phy(%d), opcode(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	    <span class="n">phy_operation</span><span class="p">));</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy_control - &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_control - reply data transfer size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_reply</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">phy_control_reply</span> <span class="o">=</span> <span class="n">data_out</span> <span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_control_request</span><span class="p">);</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_control - function_result(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_control_reply</span><span class="o">-&gt;</span><span class="n">function_result</span><span class="p">));</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;phy_control - no reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_out</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">data_out</span><span class="p">,</span> <span class="n">data_out_dma</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_phy_reset -</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> * @hard_reset:</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hard_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">Mpi2SasIoUnitControlReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">Mpi2SasIoUnitControlRequest_t</span> <span class="n">mpi_request</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle expander phys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_transport_expander_phy_control</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">hard_reset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">SMP_PHY_CONTROL_HARD_RESET</span> <span class="o">:</span>
		    <span class="n">SMP_PHY_CONTROL_LINK_RESET</span><span class="p">);</span>

	<span class="cm">/* handle hba phys */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIoUnitControlReply_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SAS_IO_UNIT_CONTROL</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">hard_reset</span> <span class="o">?</span>
	    <span class="n">MPI2_SAS_OP_PHY_HARD_RESET</span> <span class="o">:</span> <span class="n">MPI2_SAS_OP_PHY_LINK_RESET</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="p">.</span><span class="n">PhyNum</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_base_sas_iounit_control</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span> <span class="o">||</span> <span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;phy(%d), ioc_status&quot;</span>
		    <span class="s">&quot;(0x%04x), loginfo(0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_phy_enable - enable/disable phys</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> * @enable: enable phy when true</span>
<span class="cm"> *</span>
<span class="cm"> * Only support sas_host direct attached phys.</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_phy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">Mpi2SasIOUnitPage1_t</span> <span class="o">*</span><span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2SasIOUnitPage0_t</span> <span class="o">*</span><span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">discovery_active</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* handle expander phys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_transport_expander_phy_control</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">SMP_PHY_CONTROL_LINK_RESET</span> <span class="o">:</span>
		    <span class="n">SMP_PHY_CONTROL_DISABLE</span><span class="p">);</span>

	<span class="cm">/* handle hba phys */</span>

	<span class="cm">/* read sas_iounit page 0 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage0_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit0PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg0</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg0</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unable to enable/disable phys when when discovery is active */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">discovery_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PortFlags</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SASIOUNIT0_PORTFLAGS_DISCOVERY_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;discovery is active on &quot;</span>
			    <span class="s">&quot;port = %d, phy = %d: unable to enable/disable &quot;</span>
			    <span class="s">&quot;phys, try again later!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Port</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">discovery_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">discovery_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read sas_iounit page 1 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage1_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit1PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg1</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* copy Port/PortFlags/PhyFlags from page 0 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Port</span> <span class="o">=</span>
		    <span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Port</span><span class="p">;</span>
		<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PortFlags</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PortFlags</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SASIOUNIT0_PORTFLAGS_AUTO_PORT_CONFIG</span><span class="p">);</span>
		<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyFlags</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhyFlags</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">MPI2_SASIOUNIT0_PHYFLAGS_ZONING_ENABLED</span> <span class="o">+</span>
		    <span class="n">MPI2_SASIOUNIT0_PHYFLAGS_PHY_DISABLED</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">PhyFlags</span>
		    <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI2_SASIOUNIT1_PHYFLAGS_PHY_DISABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">PhyFlags</span>
		    <span class="o">|=</span> <span class="n">MPI2_SASIOUNIT1_PHYFLAGS_PHY_DISABLE</span><span class="p">;</span>

	<span class="n">mpt2sas_config_set_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">sas_iounit_pg1</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

	<span class="cm">/* link reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">_transport_phy_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _transport_phy_speed - set phy min/max link rates</span>
<span class="cm"> * @phy: The sas phy object</span>
<span class="cm"> * @rates: rates defined in sas_phy_linkrates</span>
<span class="cm"> *</span>
<span class="cm"> * Only support sas_host direct attached phys.</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_phy_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_phy_linkrates</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">Mpi2SasIOUnitPage1_t</span> <span class="o">*</span><span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Mpi2SasPhyPage0_t</span> <span class="n">phy_pg0</span><span class="p">;</span>
	<span class="n">Mpi2ConfigReply_t</span> <span class="n">mpi_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_transport_sas_node_find_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_node_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">&lt;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">&gt;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span><span class="p">)</span>
		<span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span><span class="p">;</span>

	<span class="cm">/* handle expander phys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">_transport_expander_phy_control</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		    <span class="n">SMP_PHY_CONTROL_LINK_RESET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* handle hba phys */</span>

	<span class="cm">/* sas_iounit page 1 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">Mpi2SasIOUnitPage1_t</span><span class="p">,</span> <span class="n">PhyData</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SasIOUnit1PhyData_t</span><span class="p">));</span>
	<span class="n">sas_iounit_pg1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_iounit_pg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt2sas_config_get_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span>
	    <span class="n">sas_iounit_pg1</span><span class="p">,</span> <span class="n">sz</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MPI2_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">!=</span> <span class="n">MPI2_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">MaxMinLinkRate</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sas_iounit_pg1</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">MaxMinLinkRate</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">rates</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt2sas_config_set_sas_iounit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="n">sas_iounit_pg1</span><span class="p">,</span>
	    <span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* link reset */</span>
	<span class="n">_transport_phy_reset</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* read phy page 0, then update the rates in the sas transport phy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpt2sas_config_get_phy_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_pg0</span><span class="p">,</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
		    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&amp;</span> <span class="n">MPI2_SAS_PRATE_MIN_RATE_MASK</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
		    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">ProgrammedLinkRate</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">_transport_convert_phy_link_rate</span><span class="p">(</span>
		    <span class="n">phy_pg0</span><span class="p">.</span><span class="n">NegotiatedLinkRate</span> <span class="o">&amp;</span>
		    <span class="n">MPI2_SAS_NEG_LINK_RATE_MASK_PHYSICAL</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sas_iounit_pg1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * _transport_smp_handler - transport portal for smp passthru</span>
<span class="cm"> * @shost: shost object</span>
<span class="cm"> * @rphy: sas transport rphy object</span>
<span class="cm"> * @req:</span>
<span class="cm"> *</span>
<span class="cm"> * This used primarily for smp_utils.</span>
<span class="cm"> * Example:</span>
<span class="cm"> *           smp_rep_general /sys/class/bsg/expander-5:0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_transport_smp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">MPT2SAS_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">Mpi2SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">mpi_request</span><span class="p">;</span>
	<span class="n">Mpi2SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">mpi_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">smid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sgl_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pci_dma_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pci_dma_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pci_addr_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pci_addr_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wait_state_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: the smp response space is &quot;</span>
		    <span class="s">&quot;missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">shost_recovery</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_error_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: transport_cmds in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_PENDING</span><span class="p">;</span>

	<span class="cm">/* Check if the request is split across multiple segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Allocate memory and copy the request */</span>
		<span class="n">pci_addr_out</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		    <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pci_dma_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_addr_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s(): PCI Addr out = NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pci_addr_out</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			    <span class="n">page_address</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span>
			    <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr_out</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span>
		    <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_addr_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s(): DMA Addr out = NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_pci</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the response needs to be populated across</span>
<span class="cm">	 * multiple segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_addr_in</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">pci_dma_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_addr_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s(): PCI Addr in = NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr_in</span> <span class="o">=</span>  <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span>
		    <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_addr_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s(): DMA Addr in = NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wait_state_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI2_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span>
			    <span class="s">&quot;%s: failed due to ioc not operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_iocstate</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: waiting for &quot;</span>
		    <span class="s">&quot;operational state(count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">wait_state_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_state_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s: ioc is operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">smid</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_smid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cb_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s: failed obtaining a smid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span> <span class="o">=</span> <span class="n">mpt2sas_base_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">smid</span> <span class="o">=</span> <span class="n">smid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">));</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI2_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VF_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">VP_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SASAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">rphy</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">:</span>
	    <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_hba</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">psge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_request</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>

	<span class="cm">/* WRITE sgel first */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_HOST_TO_IOC</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="n">pci_dma_out</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dma_addr_out</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* incr sgel */</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sge_size</span><span class="p">;</span>

	<span class="cm">/* READ sgel last */</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI2_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span> <span class="n">MPI2_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
	    <span class="n">MPI2_SGE_FLAGS_END_OF_LIST</span><span class="p">);</span>
	<span class="n">sgl_flags</span> <span class="o">=</span> <span class="n">sgl_flags</span> <span class="o">&lt;&lt;</span> <span class="n">MPI2_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">pci_dma_in</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">base_add_sg_single</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgl_flags</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dma_addr_in</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s - &quot;</span>
	    <span class="s">&quot;sending smp request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mpt2sas_base_put_smid_default</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">smid</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_ERR_FMT</span> <span class="s">&quot;%s : timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">_debug_dump_mf</span><span class="p">(</span><span class="n">mpi_request</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">Mpi2SmpPassthroughRequest_t</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_RESET</span><span class="p">))</span>
			<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">issue_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span> <span class="s">&quot;%s - &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT2_CMD_REPLY_VALID</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mpi_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;%s - reply data transfer size(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)));</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">mpi_reply</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpi_reply</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpi_reply</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">-=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">);</span>
		<span class="cm">/* check if the resp needs to be copied from the allocated</span>
<span class="cm">		 * pci mem */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">bytes_to_copy</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mpi_reply</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">);</span>
			<span class="n">bio_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes_to_copy</span> <span class="o">&lt;=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span>
					    <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">pci_addr_in</span> <span class="o">+</span>
					    <span class="n">offset</span><span class="p">,</span> <span class="n">bytes_to_copy</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">page_address</span><span class="p">(</span><span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span>
					    <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">,</span> <span class="n">pci_addr_in</span> <span class="o">+</span>
					    <span class="n">offset</span><span class="p">,</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">);</span>
					<span class="n">bytes_to_copy</span> <span class="o">-=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="n">bvec</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dtransportprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MPT2SAS_INFO_FMT</span>
		    <span class="s">&quot;%s - no reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">issue_host_reset:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt2sas_base_hard_reset_handler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">,</span>
		    <span class="n">FORCE_BIG_HAMMER</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_addr_out</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_addr_in</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span>
		    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

 <span class="nl">free_pci:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_addr_out</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">pci_addr_out</span><span class="p">,</span>
		    <span class="n">pci_dma_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_addr_in</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="n">pci_addr_in</span><span class="p">,</span>
		    <span class="n">pci_dma_in</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MPT2_CMD_NOT_USED</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">transport_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sas_function_template</span> <span class="n">mpt2sas_transport_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_linkerrors</span>		<span class="o">=</span> <span class="n">_transport_get_linkerrors</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_enclosure_identifier</span> <span class="o">=</span> <span class="n">_transport_get_enclosure_identifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bay_identifier</span>	<span class="o">=</span> <span class="n">_transport_get_bay_identifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_reset</span>		<span class="o">=</span> <span class="n">_transport_phy_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_enable</span>		<span class="o">=</span> <span class="n">_transport_phy_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phy_speed</span>		<span class="o">=</span> <span class="n">_transport_phy_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smp_handler</span>		<span class="o">=</span> <span class="n">_transport_smp_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">mpt2sas_transport_template</span><span class="p">;</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
